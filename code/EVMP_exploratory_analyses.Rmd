---
title: "EVMP Data Analysis 2018"
author: ""
date: ""
output: 
  html_document: 
    theme: flatly
    toc: yes
---


```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = TRUE, warning = FALSE)
opts_knit$set(root.dir=normalizePath('../')) # this is required if Rmd is nested below the project directory
opts_chunk$set(fig.path = "../output/figures/") # corrected path and added dev. Needed to specify a subdirectory for figs

# see discussion here: https://stackoverflow.com/questions/24585254/working-with-knitr-using-subdirectories

```


**Updated: `r format(Sys.time(), '%Y %B %d')`**

## Introduction

This document provides a basic exploration of EVMP files provided by RMNP in September, 2018.

Analyses aim to characterize basic data structure and identify potential issues such as:

* Inconsistently named/typed factors    
* Missing values
* Data values outside of expected range or showing unusual patterns

In addition, data are cleaned in preparation for further analyses.

```{r,echo=FALSE}
# library(here)
# here()
# install.packages("bindrcpp")
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(fs))
suppressPackageStartupMessages(library(sf))
# library(raster)
suppressPackageStartupMessages(library(janitor))
suppressPackageStartupMessages(library(readxl))
# library(glue)
suppressPackageStartupMessages(library(mapview))
# library(ggmap)
# library(ggrepel)
suppressPackageStartupMessages(library(viridis))
# library(ggExtra)
suppressPackageStartupMessages(library(ggstance))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(DT))
# library(kableExtra)
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(skimr)) ## some useful functions
suppressPackageStartupMessages(library(dataMaid))
# library(ggmap)

```

# Data Exploration, and Wrangling

## Import and overview   

__List of files provided by RMNP (9/20/2018):__

```{r}
# list of files 
# fs::dir_ls(recursive = TRUE) 

file.listing <- dir_info(recursive = TRUE) %>%
  filter(type == "file", permissions == "u+r", size > "10KB") %>%
  arrange(desc(size)) %>%
  select(path, permissions, size, modification_time)

datatable(file.listing)

```


```{r}

# xls_example <- readxl_example("datasets.xls")
# excel_sheets(xls_example)


# willow.off <- read_xlsx("data/EVMP_data/provisional_data_20180920/Willow Offtake Data 2009-2018.xlsx")
# read_excel(willow.off, sheet = "chickwts")
# excel_sheets(willow.off)
# 
# asp.bl <- read_excel("data/EVMP_data/provisional_data_20180920/Aspen_Baseline_2013_2018_5_Year_Msmts_Including_Burn_Data.xlsx") 
# 
# excel_sheets(asp.bl)

```


### Aspen Baseline 2013-2018

**Data import**  

Tally of Live Aspen Stems per Plot >2.5 m in Height (DBH=diameter at breast height [1.4 m])		

Tally of Live Aspen Stems per Plot <2.5 m in Height				


Tally of Dead Aspen Stems per Plot >2.5 m in Height (DBH=diameter at breast height [1.4 m])

Cleaned data to make readable as csv

Site Type: AC=core, ANC=non-core, AK=Kawuneechee Valley


```{r}

a2 <- read_xlsx("./data/EVMP_data/provisional_data_20180920/AspenBaselne2013-2018/Aspen_Baseline_Burn_Data_20181002.xlsx", sheet = 2) %>% 
  mutate_if(.predicate = is.numeric,.funs = as.character())
  
  
# a cleaned version of 'Aspen_Baseline_2013_2018_5_Year_Msmts_Including_Burn_Data.xlsx'


a3 <- read_xlsx("./data/EVMP_data/provisional_data_20180920/AspenBaselne2013-2018/Aspen_Baseline_Burn_Data_20181002.xlsx", sheet = 3) %>% 
  mutate_if(.predicate = is.numeric,.funs = as.character())

a4 <- read_xlsx("./data/EVMP_data/provisional_data_20180920/AspenBaselne2013-2018/Aspen_Baseline_Burn_Data_20181002.xlsx", sheet = 4) %>% 
  mutate(SiteNumber = as.character(SiteNumber)) %>% 
  mutate_if(.predicate = is.numeric,.funs = as.character())

a5 <- read_xlsx("./data/EVMP_data/provisional_data_20180920/AspenBaselne2013-2018/Aspen_Baseline_Burn_Data_20181002.xlsx", sheet = 5) %>% 
  mutate(SiteNumber = as.character(SiteNumber)) %>% 
  mutate_if(.predicate = is.numeric,.funs = as.character())

a6 <- read_xlsx("./data/EVMP_data/provisional_data_20180920/AspenBaselne2013-2018/Aspen_Baseline_Burn_Data_20181002.xlsx", sheet = 6)%>% 
  mutate(SiteNumber = as.character(SiteNumber)) %>% 
  mutate_if(.predicate = is.numeric,.funs = as.character())


a7 <- read_xlsx("./data/EVMP_data/provisional_data_20180920/AspenBaselne2013-2018/Aspen_Baseline_Burn_Data_20181002.xlsx", sheet = 7) %>% 
  mutate(SiteNumber = as.character(SiteNumber)) %>% 
  mutate_if(.predicate = is.numeric,.funs = as.character())

a8 <- read_xlsx("./data/EVMP_data/provisional_data_20180920/AspenBaselne2013-2018/Aspen_Baseline_Burn_Data_20181002.xlsx", sheet = 8) %>% 
  mutate(SiteNumber = as.character(SiteNumber)) %>% 
  mutate_if(.predicate = is.numeric,.funs = as.character())

a9 <- read_xlsx("./data/EVMP_data/provisional_data_20180920/AspenBaselne2013-2018/Aspen_Baseline_Burn_Data_20181002.xlsx", sheet = 9) %>% 
  mutate(SiteNumber = as.character(SiteNumber)) %>% 
  mutate_if(.predicate = is.numeric,.funs = as.character())

a10 <- read_xlsx("./data/EVMP_data/provisional_data_20180920/AspenBaselne2013-2018/Aspen_Baseline_Burn_Data_20181002.xlsx", sheet = 10) %>% 
  mutate(SiteNumber = as.character(SiteNumber)) %>% 
  mutate_if(.predicate = is.numeric,.funs = as.character())

a11 <- read_xlsx("./data/EVMP_data/provisional_data_20180920/AspenBaselne2013-2018/Aspen_Baseline_Burn_Data_20181002.xlsx", sheet = 11) %>% 
  mutate(SiteNumber = as.character(SiteNumber)) %>% 
  mutate_if(.predicate = is.numeric,.funs = as.character())

a12.bl <- read_xlsx("./data/EVMP_data/provisional_data_20180920/AspenBaselne2013-2018/Aspen_Baseline_Burn_Data_20181002.xlsx", sheet = 12)

a13.bl.l <- read_xlsx("./data/EVMP_data/provisional_data_20180920/AspenBaselne2013-2018/Aspen_Baseline_Burn_Data_20181002.xlsx", sheet = 12)

a14.master <- read_xlsx("./data/EVMP_data/provisional_data_20180920/AspenBaselne2013-2018/Aspen_Baseline_Burn_Data_20181002.xlsx", sheet = 14)



```


```{r}
# combine
a.list <- list(a2,a3,a4,a5, a6, a7, a8, a9)

asp.merge <- map_df(a.list, bind_rows) %>% 
  clean_names()
# clean the names

```


### Tidy data some more

```{r}
asp.merge %>% 
  names() %>% 
  as.tibble() %>%
  rename(variable = value)  %>% 
  datatable(rownames = FALSE)
  
  
  
```

```{r}

asp.merge %>% 
  names() %>% 
  as.tibble() %>%
  rename(variable = value) 
  
## create tidy object of just the tall Aspen Stems per Plot >2.5 m in Height (DBH=diameter at breast height [1.4 m])
asp.tall <- asp.merge %>% 
  select(-contains("hei")) %>% 
  gather(key = var, val = val, -c(live_dead,yr, site_id, site_number, site_type)) %>% 
  mutate(HeightClass = "Tall") 


```

** tidy formatted data -- Tall aspen (> 2.5 m)
```{r}

# asp.tall %>% 
#   datatable()

```


** tidy formatted data -- Short aspen (< 2.5 m)
```{r}

## create tidy object of just the tall Aspen Stems per Plot >2.5 m in Height (DBH=diameter at breast height [1.4 m])
asp.short <- asp.merge %>% 
  select(-contains("dbh")) %>%
  select(-contains("cm_2")) %>%
  glimpse() %>% 
  gather(key = var, val = val, -c(live_dead,yr, site_id, site_number, site_type)) %>% 
  mutate(HeightClass = "Short") 

# asp.short %>% 
#   datatable()

asp.tidy.full <- bind_rows(asp.tall,asp.short) %>% 
  mutate(yr = as.factor(yr))

asp.tidy.full %>% 
  datatable()

# asp.tidy.full %>% 
#   group_by(var,yr) %>% 
#   summarise(mean.val = mean(val, na.rm = TRUE), sd.val = sd(val, na.rm = TRUE)) %>% 
#   filter(mean.val >0) %>% 
#   spread(data = var,value = mean.val)


```




```{r, fig.height=12, eval= FALSE}
### some plots 

# asp.tidy.full %>% 
#   ggplot(aes(x = yr, y = val)) +
#   geom_boxplot(aes(fill = live_dead)) +
#   facet_grid(HeightClass ~ var, scales = 'free')


asp.tidy.full %>%
  filter(HeightClass == "Tall") %>% 
  # names() %>% as.tibble() %>%  
  # distinct(value)
  filter(!is.na(yr)) %>% 
  filter(site_type == 'AC') %>% 
  # filter() %>% 
  mutate(yr = as.numeric(yr)) %>%
  group_by(site_number, var, yr, live_dead) %>% 
  summarise(mean.val = mean(val,na.rm = TRUE), sd.val = sd(val,na.rm = TRUE)) %>% 
  ggplot(aes(x = yr, y = mean.val)) +
  geom_line(aes(color = live_dead)) +
  facet_wrap(~var, scales = 'free')


asp.tidy.full %>%
  filter(HeightClass == "Tall") %>% 
  # names() %>% as.tibble() %>%  
  # distinct(value)
  filter(!is.na(yr)) %>% 
  group_by(site_number, var, yr, live_dead) %>% 
  summarise(mean.val = mean(val,na.rm = TRUE), sd.val = sd(val,na.rm = TRUE)) %>% 
  ggplot(aes(x = var, y = mean.val)) +
  
  geom_point(aes(color = live_dead)) +
  facet_grid(var ~ yr, scales = 'free')

asp.tidy.full %>%
  filter(HeightClass == "Tall") %>% 
  filter(!is.na(yr)) %>% 
  ggplot(aes(x = yr, y = val)) +
  geom_boxplot(aes(fill = live_dead)) +
  facet_grid(site_type ~ yr, scales = 'free')

```



#### Quality checks

**Missing data**  


### Willow Offtake 2009-2018 

**Data import** 

#### Quality checks

**Missing data**  


### Willow Cumulative 2013-2018

**Data import** 

#### Quality checks

**Missing data**


### Upland Line Intercept 2007-2018

**Data import** 

#### Quality checks

**Missing data**

# Translation of Past Analyses from SAS 


### Aspen Baseline 2013-2018


```{r}



```


### Willow Offtake 2009-2018

Rewrite the SAS program used to analyze willow height data as found in table 9 of Zeigenfuss and Johnson (2015)--Least squares means of average and maximum willow height and percent willow cover on burned sites compared to unburned sites using the macroplot method at EVMP willow monitoring sites in Rocky Mountain National Park, Colorado. 

**Steps:** 

1. Read in data from a file contaning the baseline data from willow macroplots  
2. Calculate canopy area for each plot and assigns the baseline year (2008) to these data 
3. Sort data down to willow and non-willow species groups and calculates mean for the variables "average height" and "maximum ht" for each group.

**See: **  

>willow shrub cover macro table 8.sas  
>willow shrub height table 8.sas  
>willow shrub cover macro table 9.txt    
>willow shrub height table 9.txt  


### Willow Cumulative 2013-2018


### Upland Line Intercept 2007-2018

Rewrite the SAS program used to create figs. 3,4,5, and 7 of Zeigenfuss and Johnson (2015)--Distribution of aspen tree (height greater than 2.5 meters) stem diameters in monitoring sites. 

**Steps:** 
1. Read in data from a file with tallies of live aspen stems by dbh size class  
2. Read in a file with information for each aspen monitoring site  
3. Merge these two files, remove saplings 
4. Reclass trees into groups of small (2-10 cm dbh), medium (10-20 cm dbh) and large (20+ dbh) trees.


**See: **  

>aspen sapling table 4.sas  
>aspen sapling table 5.sas  


## Recreation of Figures from Past Publications  

**Key publications:**  

_Zeigenfuss, L. C., and T. L. Johnson. 2015. Monitoring of Vegetation Response to Elk Population and Habitat Management in Rocky Mountain National Park, 2008–14. Report 2015-1216, U.S. Geological Survey, Reston, VA._
[Link](http://pubs.er.usgs.gov/publication/ofr20151216)

# Plots as in LZ 2015





