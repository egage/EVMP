---
title: "Appendix A. EVMP Data Processing"
author: ""
date: ""
output: 
  html_document: 
    theme: journal
    toc: yes
    toc_depth: 2
    code_folding: hide
    fig_caption: yes
editor_options: 
  markdown: 
    wrap: 72
bibliography: references.bib
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.align = 'center', cache = FALSE)
opts_knit$set(root.dir=normalizePath('../')) # required if Rmd is nested below the project directory
opts_chunk$set(fig.path = "../output/figures/")

set.seed(1234)
```

*Repository:*\
<https://github.com/egage/EVMP>

```{r, echo=FALSE}

suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(fs))
suppressPackageStartupMessages(library(sf))
suppressPackageStartupMessages(library(janitor))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(mapview))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(skimr)) 
suppressPackageStartupMessages(library(dataMaid))
library(lubridate)
library(bayestestR)
library(gt)
library(gtsummary)
library(labelled)
library(summarytools)
library(ggrepel)
library(ggtext)
library(patchwork)

mapviewOptions(fgb = FALSE)
```

```{r, echo=FALSE}
# custom gradients
dbhclass.gradient5 <- c("#26185F", "#0095AF", "#9ADCBB", "#FCFFDD", "grey50")

colfunc1<-colorRampPalette(c("#26185F","#0095AF","#9ADCBB", "#FCFFDD"))
colfunc2<-colorRampPalette(c("#0095AF","#9ADCBB", "#FCFFDD"))
colfunc3<-colorRampPalette(c("#0095AF","#9ADCBB"))
colfunc3_RdBu <- colorRampPalette(c("#EF8A62", "#FDDBC7", "#D1E5F0", "#67A9CF"))


# plot(rep(1,50),col=(colfunc1(50)), pch=19,cex=2)

pal.5a <- colfunc1(5) #%>% 
  # toString()
pal.7a <- colfunc1(7)

# toString(pal.5a)
# colfunc<-colorRampPalette(c("red","yellow","springgreen","royalblue"))
# plot(rep(1,50),col=(colfunc(50)), pch=19,cex=2)

# scrap
# df <- data.frame(
#   x = runif(100),
#   y = runif(100),
#   z1 = rnorm(100),
#   z2 = abs(rnorm(100))
# )
# 
# df_na <- data.frame(
#   value = seq(1, 20),
#   x = runif(20),
#   y = runif(20),
#   z1 = c(rep(NA, 10), rnorm(10))
# )
# 
# ggplot(df, aes(x, y)) +
#   geom_point(aes(colour = z1)) +
#   scale_colour_gradientn(colours = terrain.colors(10))
# 
# ggplot(df, aes(x, y)) +
#   geom_point(aes(colour = z1)) +
#   scale_colour_gradientn(colours = colfunc1(5))

```


```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE}
# Plotting themes
theme_smFacet <- theme_minimal() + theme(strip.text.x = element_text(size = 7))
theme_smFacet2 <- theme_minimal() + theme(strip.text.x = element_text(size = 6))

# Functions
# Data import functions
read_sheets <- function(file){
  xlsx_file <- file
  xlsx_file %>%
    excel_sheets() %>%
    set_names() %>%
    map_df(read_excel, path = xlsx_file, .id = 'sheet_name', trim_ws = TRUE, skip = 1, col_types = "text", range = "A2:DW700") %>% 
    mutate(file_name = file) %>% 
    select(file_name, sheet_name, everything())
}

## read xlsx then csv cache
read_then_csv <- function(sheet, path) {
  pathbase <- path %>%
    basename() %>%
    tools::file_path_sans_ext()
  path %>%
    read_excel(sheet = sheet) %>% 
    write_csv(paste0(pathbase, "-", sheet, ".csv"))
}

## plotting functions
ggTile_yr_season_site2 <- function(df){
  df %>%
  group_by(yr, season, site2) %>%
  summarise(n= n()) %>%
  ggplot(aes(yr, site2)) +
  geom_tile(aes(fill = n), color = 'grey80', alpha=0.85) +
  # scale_fill_gradientn(colors = c("#0095AF","#0095AF","#9ADCBB", "#FCFFDD")) +
  scale_fill_gradientn(values = c("#0095AF", "#FCFFDD")) +
  # viridis::scale_fill_viridis(option = "B") +
  facet_wrap(~season) +
  theme(axis.text.x = element_text(angle = 55, hjust = 1, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  facet_wrap(~season)}


ggTile_yr_season_site <- function(df){
  df %>%
  group_by(yr, season, site) %>%
  summarise(n= n()) %>%
  ggplot(aes(yr, site)) +
  geom_tile(aes(fill = n), color = 'grey80', alpha=0.85) +
  scale_fill_gradientn(values = c("#0095AF", "#FCFFDD")) +
  # viridis::scale_fill_viridis(option = "D") +
  theme(axis.text.x = element_text(angle = 55, hjust = 1, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  facet_wrap(~season)} 

```


# Introduction

This document contains code for combining, cleaning, and exploring raw
Elk Vegetation Management Plan (EVMP) data collected through the 2018
sampling season. The code and results are provided as a supplement to
the NPS NRR Report "Monitoring of Vegetation Response to Elk Population
and Habitat Management in Rocky Mountain National Park - Analysis of Elk
Vegetation Management Plan monitoring Data: 2008--2018". For information
on sampling and the broader analysis and interpretation of the results,
refer to this report, past analyses, and the original EVMP monitoring
plan @zeigenfuss2015 \@zeigenfuss2011.

```{r, eval=FALSE, echo=FALSE}
# Create a cache of workbook tabs as CSV files
## cache csv. This creates a csv cache of each tab in the workbook.

read_then_csv <- function(sheet, path) {
  pathbase <- path %>%
    basename() %>%
    tools::file_path_sans_ext()
  path %>%
    read_excel(sheet = sheet) %>% 
    write_csv(paste0(pathbase, "-", sheet, ".csv"))
}

path %>%
  excel_sheets() %>%
  set_names() %>% 
  map(read_then_csv, path = path)

```

```{r}
##### READ IN CSV FILES EXPORTED FROM EXCEL TABS 
## all the csv names and paths as list column

csv.all <- tibble(ffname = fs::dir_ls("data/EVMP_data/csv",glob = "*.csv"))

## purrr to read csv into list column
csv.all.lc <- csv.all %>% 
  mutate(data = map(ffname,read_csv))

```

```{r}
#### maps
### The following code extracts out the most recent 'site info' file, creates a sf object for plotting and further spatial analysis. Note this is different than below where a different file ('VEG_SITES_MSTR_DATABASE.xlsx') provided by the park is interrogated. Here, it's the 'site info' tab within the spreadsheet

# site info
sinfo <- csv.all.lc %>%
  filter(str_detect(ffname, "z2018 Site Info.csv"))

sinfo.df <- sinfo %>% 
  pluck(2) %>% 
  pluck(1)

#### Fix inconsistent labeling of some SITE_ID values
sinfo.df <- sinfo.df %>% 
  mutate(SITE_ID = case_when(SITE_ID == "WC1" ~ "WC01",
                       SITE_ID == "WC2" ~ "WC02",
                       SITE_ID == "WC3" ~ "WC03", 
                       SITE_ID == "WC4" ~ "WC04", 
                       SITE_ID == "WC4" ~ "WC04",
                       SITE_ID == "WC5" ~ "WC05",
                       SITE_ID == "WC6" ~ "WC06", 
                       SITE_ID == "WC7" ~ "WC07", 
                       SITE_ID == "WC8" ~ "WC08",
                       SITE_ID == "WC9" ~ "WC09",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC2" ~ "WNC02",
                       SITE_ID == "WNC3" ~ "WNC03", 
                       SITE_ID == "WNC4" ~ "WNC04", 
                       SITE_ID == "WNC4" ~ "WNC04",
                       SITE_ID == "WNC5" ~ "WNC05",
                       SITE_ID == "WNC6" ~ "WNC06", 
                       SITE_ID == "WNC7" ~ "WNC07", 
                       SITE_ID == "WNC8" ~ "WNC08",
                       SITE_ID == "WNC9" ~ "WNC09",
                       SITE_ID == "WK1" ~ "WK01",
                       SITE_ID == "WK2" ~ "WK02",
                       SITE_ID == "WK3" ~ "WK03", 
                       SITE_ID == "WK4" ~ "WK04", 
                       SITE_ID == "WK5" ~ "WK05",
                       SITE_ID == "WK6" ~ "WK06", 
                       SITE_ID == "WK7" ~ "WK07", 
                       SITE_ID == "WK8" ~ "WK08",
                       SITE_ID == "WK9" ~ "WK09",
                       TRUE ~ as.character(SITE_ID))
  )

```

```{r site_info_import}
# define path to the veg site master file
path.si <- ("data/EVMP_data/VEG_SITES_MSTR_DATABASE.xlsx")

#### Read in the worksheets and create list of df
# each tab is a df in the list object
si.d <- path.si %>% 
  excel_sheets() %>% 
  set_names() %>%
  map(read_excel, path = path.si) # 

## this retrieved ALL of the tabs. Subset the list to get to the desired tabs

site.info.willow <- si.d$'WILLOW SITES MASTER'
site.info.aspen <- si.d$'ASPEN SITES MASTER'
site.info.upland <- si.d$'UPLAND SITES MASTER'
## note: each of the tabs call the UTM coordinate columns something different. For simplicity, I changed them to be consistent in the source file

# and the active master tab. 
site.info.active <- si.d$'ACTIVE VEG SITE LOCATION MASTER'

## they don't have the same column names. The following vector is a subset in common
# csel <- c("SITE_ID","UTM_E_NAD83","UTM_N_NAD83","FENCED","VALLEY","UTM_N_NAD83","BURNED")
csel <- c("SITE_ID","UTM_E_NAD83","UTM_N_NAD83","FENCED","BURNED","REMOVED")

site.info.willow <- select(site.info.willow,csel) %>% # all_of(csel)
  mutate(pType = "willow")
site.info.aspen <- select(site.info.aspen,csel) %>% 
  mutate(pType = "aspen")
site.info.upland <- select(site.info.upland,csel) %>% 
  mutate(pType = "upland")

## remove the "-R" from site id. 
site.info.willow <- site.info.willow %>% 
  mutate(SITE_ID = str_remove(SITE_ID,"-R"))

## combine the aspen, willow, and upland plots
site.info.all <- rbind(site.info.willow, site.info.aspen, site.info.upland)

# join in the range type from site.info.active tab
rtype <- site.info.active %>% 
  dplyr::select(SITE_ID, WILDERNESS, RANGE_TYPE)

## join in the info
site.info.all <- left_join(site.info.all, rtype, by = "SITE_ID")

#### Change the NA range types fields
site.info.all <- site.info.all %>%
  # distinct(RANGE_TYPE)
  mutate(RANGE_TYPE = case_when(grepl("WC", SITE_ID) ~ "core winter range",
                          grepl("WNC", SITE_ID) ~ "non-core winter range",
                          grepl("AC", SITE_ID) ~ "core winter range",
                          grepl("ANC", SITE_ID) ~ "non-core winter range",
                          grepl("UNC", SITE_ID) ~ "non-core winter range",
                          grepl("UC", SITE_ID) ~ "core winter range",
                          grepl("K", SITE_ID) ~ "Kawuneeche Valley"
                          )
         ) 
```

```{r gtbl_sites}
####################### Clean #########################
#### Remove records with "NA" for coordinates or ones with
#### Any non-NA for the "REMOVE" field 
## I discovered further down that WK03-R was retained as it is NA for the 'REMOVED' attribute.
## I'm manually removing
site.info.clean <- site.info.all %>%
  dplyr::na_if(.,"NA") %>%  # replacing all the text NA with real NA
  filter(!is.na(UTM_E_NAD83)) %>% # only keeping points with coordinates
  filter(!is.na(UTM_N_NAD83)) %>% 
  filter(is.na(REMOVED)) %>%
  filter(SITE_ID != "WK03-R")

site.info.clean <- site.info.clean %>% 
  mutate(FENCED = case_when(is.na(FENCED) ~ "N", 
                            TRUE ~ as.character(FENCED)))
```

```{r}
## lookup of removed plots
lu.removed.plot <- site.info.all %>%
  filter(!is.na(REMOVED)) %>% 
  distinct(SITE_ID) %>% 
  rename(sid = SITE_ID) %>% 
  mutate(SITE_ID = str_remove(sid,"-R")) %>% 
  distinct(SITE_ID)

```


```{r}
## read in the file with the manually attributed valley type field (this was not fully attributed in the provided data)
## Data attributed visually in ArcGIS.  
vt <- st_read("./data/EVMP_derived/site_info_all_sf.shp", quiet = TRUE)
vt <- vt %>% 
  rename(SITE_ID = SITE_) %>% 
  rename(VALLEY = VALLE) %>% 
  as_tibble() %>% 
  select(SITE_ID, VALLEY)

site.info.clean <- left_join(site.info.clean, vt, by = "SITE_ID")

## recode some of the valley ids
site.info.clean <- site.info.clean %>% 
  mutate(VALLEY = recode(VALLEY, 
                         'FRE' = "HSP")) %>% 
  mutate(VALLEY = recode(VALLEY, 
                         'LHP' = "HSP")) 

## add more valley info from a lookup table
valley_lu <- read_csv("./data/EVMP_derived/VALLEY_lu.csv")

## join in the valley info
site.info.clean <- left_join(site.info.clean, valley_lu, by = "VALLEY") 

# Eliminate all the vague burned categories, collapsing them to a binary burned/not-burned category
site.info.clean <- 
  site.info.clean %>% 
  mutate(BURNED = case_when(BURNED == "Unburned" ~ "Unburned",
                            BURNED == "N Y" ~ "Unburned",
                            BURNED == "Completely" ~ "Burned",
                            BURNED == "Moderately" ~ "Burned",
                            BURNED == "Moderately to Completely" ~ "Burned",
                            BURNED == "Y" ~ "Burned",
                            BURNED == "N" ~ "Unburned",
                            BURNED == "Not burned" ~ "Unburned",
                            is.na(BURNED) ~ "Unburned",
                            TRUE ~ BURNED)
         ) %>% 
  mutate(FENCED = case_when(FENCED == "Y_but_fence_down_since_2013" ~ "Unfenced",
                             FENCED == "Y" ~ "Fenced",
                             FENCED == "N" ~ "Unfenced"))

## note: all "NA" for burned are assumed to be unburned and recoded as such

###
## WK03 missing VALLEY attribute
site.info.clean <- site.info.clean %>%
  mutate(VALLEY = case_when(SITE_ID == "WK03" ~ "KV",
                            TRUE ~ VALLEY)) %>% 
  mutate(valley_full = case_when(SITE_ID == "WK03" ~ "Kawuneeche Valley",
                            TRUE ~ valley_full))

```

```{r, eval = FALSE}
## write site info to csv
write_csv(site.info.clean, "./data/EVMP_derived/site_info_clean.csv")
```

**Site information:**

```{r}
## create some tables
site.info.clean %>%
  dplyr::select(-REMOVED) %>% 
  datatable(caption = "Valid EVMP plots")

```

```{r}
## create Site info UTM coord lu
site.id.coords <- site.info.clean %>%
  mutate_at(2:3, as.numeric) %>% 
  select(SITE_ID, UTM_E_NAD83, UTM_N_NAD83) %>% 
  filter(!is.na(UTM_N_NAD83)) 

```

```{r}
# create a table of vilid plots
gt.siteinfo <- site.info.clean %>%
  dplyr::select(-c(REMOVED,WILDERNESS,EastWest,contains("UTM"))) %>%
  gt::gt() %>%
  tab_header(title = md("**Valid EVMP plots from 'site_info' worksheet**"))

# cells_data issue after package update
# gt.siteinfo <- gt.siteinfo %>%
#   tab_style(
#     style = list(
#       cell_fill(color = "lightcyan"),
#       cell_text(weight = "bold")
#       ),
#     locations = cells_data(
#       columns = vars(FENCED),
#       rows = FENCED == "Y")
#   ) %>%
#   tab_style(
#     style = list(
#       cell_fill(color = "ivory")),
#     locations = cells_data(
#       columns = vars(FENCED),
#       rows = FENCED == "N")
#   )
# 
# ## add color for pType
# gt.siteinfo %>%
#     tab_style(
#     style = list(
#       cell_fill(color = "lightgreen"),
#       cell_text(weight = "bold")
#       ),
#     locations = cells_data(
#       columns = vars(pType),
#       rows = pType == "willow")
#   ) %>%
#   tab_style(
#     style = list(
#       cell_fill(color = "ivory2"),
#       cell_text(weight = "bold")
#     ),
#     locations = cells_data(
#       columns = vars(pType),
#       rows = pType == "aspen")
#   ) %>%
#   tab_style(
#     style = list(
#       cell_fill(color = "pink"),
#       cell_text(weight = "bold")
#       ),
#     locations = cells_data(
#       columns = vars(pType),
#       rows = pType == "upland")
#   )

```

```{r}
#### create SF from coordinates
site.info.clean.sf <- site.info.clean %>%
  mutate_at(2:3, as.numeric) %>% 
  st_as_sf(coords = c("UTM_E_NAD83", "UTM_N_NAD83"), crs = 26913)

## write the site info to shapefile
# st_write(site.info.clean.sf, "./data/EVMP_derived/site_info_clean.shp")
```

# Methods and exploratory analyses

Raw data provided by RMNP as various excel workbooks are combined and
cleaned in this code to facilitate exploratory data analyses, quality
assurance, and statistical modeling. Specific issues encountered and
addressed include:\
\* Inconsistently named/typed factors\
\* Missing values\
\* Data values outside of expected range or showing unusual patterns\
Derived data sets are produced and exported for use in statistical
analyses presented in other report appendices.

## Study area and sampling design

Excluding plots removed from the data set due to issues like the 2013
flood, their were 241 plots in total. Approximately 49% (n=118) were
willow plots, followed in abundance by aspen and upland plots:

```{r}
site.info.clean.sf %>%
  as_tibble() %>%
  filter(!is.na(VALLEY)) %>%
  tabyl(pType) %>% 
  rename('Plot type' = pType) %>% 
  gt::gt() %>% 
  fmt_percent(
    columns = vars(percent),
    decimals = 1
    ) %>% 
  tab_header(title="Plot counts across range types")

```

```{r}
site.info.clean.sf %>%
  as_tibble() %>% 
  tabyl(valley_full) %>%
  arrange(-n) %>% 
  rename('Location' = valley_full) %>%
  gt::gt() %>% 
  fmt_percent(
    columns = vars(percent),
    decimals = 1
    ) %>% 
  tab_header(title="Plot counts across locations", subtitle = "All plot types")

```

```{r}
site.info.clean.sf %>%
  as_tibble() %>% 
  filter(!is.na(VALLEY)) %>%
  tabyl(valley_full, pType) %>%
  rename('Location' = valley_full) %>%
  arrange(-willow) %>% 
  gt::gt() %>% 
  tab_header(title="Plot counts across locations", subtitle = "Separated by plot type")

```

```{r, eval=FALSE}
#### Map of fenced and unfenced areas - all plots
# Change basemap or pan and zoom.

# mapviewOptions(basemaps = c("Esri.WorldImagery"), # Esri.WorldShadedRelief "Esri.WorldImagery"
#                vector.palette = colorRampPalette(c("snow", "cornflowerblue", "grey10")),
#                na.color = "magenta",
#                layers.control.pos = "topright")

site.info.clean.sf %>%
  mapview(zcol='FENCED')

```

```{r}
site.info.clean.sf %>%
  as_tibble() %>% 
  filter(!is.na(VALLEY)) %>%
  tabyl(FENCED) %>% 
  gt::gt() %>%
  fmt_percent(
    columns = vars(percent),
    decimals = 1
    )

# Approximately 21% of plots occur in fenced locations
```


```{r, echo=FALSE, eval=FALSE}
# **Table of records with NA for "VALLEY"**

# Note that "location" and "valley" exist in different workbooks/datasets, differ in attributes, and are incompletely attributed. 

# "location" and "valley" exist in different workbooks/datasets, differ in attributes, and are incompletely attributed.

site.info.clean.sf %>% 
  filter(!is.na(VALLEY)) %>%
  datatable(caption = "Records missing VALLEY attributes.")
```

```{r, echo=FALSE, eval=FALSE}
#### Map of burned plots
site.info.clean.sf %>%
  filter(EastWest == "East") %>%
  filter(!is.na(BURNED)) %>% 
  mapview(zcol='BURNED',
          map.types = c("Esri.WorldImagery", "Esri.WorldTopoMap"))

```

```{r, echo=FALSE, eval=FALSE}
#### Map of Kawuneeche Valley EVMP sites
site.info.clean.sf %>% 
  filter(VALLEY == "KV") %>% 
  mapview::mapview(., zcol = 'pType',
                  map.types = c("Esri.WorldImagery", "Esri.WorldTopoMap"))

```

```{r}
# A total of 17 plots occur in the Kawuneeche Valley: 
site.info.clean.sf %>% 
  as_tibble() %>% 
  filter(VALLEY == "KV") %>%
  select(-c(geometry, REMOVED, EastWest, WILDERNESS, RANGE_TYPE)) %>%
  rename('Valley code' = VALLEY) %>%
  rename('Valley name' = valley_full) %>% 
  gt::gt() %>% 
  tab_header(title = "Kawuneeche Valley Plots")

```

```{r}
site.info.clean.sf %>%
  group_by(valley_full, pType) %>% 
  tally() %>% 
  ggplot(aes(reorder(valley_full, n),n)) +
  geom_pointrange(ymin=0, aes(ymax=n)) +
  geom_point(color="ivory3", size = 6) +
  geom_point(color="white", size = 4) +
  geom_text(aes(label=n), size=3) +
  theme_minimal() +
  coord_flip() +
  facet_wrap(~pType) +
  labs(x="Valley", y = "Count", title = "Count of EVMP sampling sites by location")

# ggsave("./output/figures_202107/rev_plotcnt_pTypeXvalley.png", width = 7, height = 3.75)

```

```{r}
### Counts of plots in fenced and unfenced contexts
## plot the count of plots by valley and fenced status
pl.hm1 <- site.info.clean.sf %>%
  as_tibble() %>% 
  distinct() %>% 
  filter(!is.na(FENCED)) %>%
  group_by(FENCED,valley_full, pType) %>%
  tally() %>%
  ungroup() %>% 
  ggplot(aes(FENCED, valley_full)) +
  geom_tile(aes(fill = n), color= 'white') +
  geom_text(aes(label=n), size=6, color = 'white') +
  geom_text(aes(label=n), size=6, color = 'grey', alpha=.75) +
  theme_minimal() +
  scale_fill_gradientn(colours = colfunc2(5)) +
  # scale_fill_viridis() +
  facet_wrap(~pType) +
  labs(x="Fenced", y = "", title = "Count of EVMP sampling sites")

ggsave(plot = pl.hm1, filename = "./output/figures_202107/cnt_plot_valley_x_fenced.png", width = 5, height = 4, dpi = 300)

pl.hm1
# pl.hm2

# paneled version of above
# cowplot::plot_grid(pl.hm1, pl.hm2, labels = "AUTO", ncol=1,rel_heights = c(2,1))
# ggsave(plot = cow1, filename = "./output/figures_202107/cnt_ptype_valle_x_fenced.png", width = 5, height = 4, dpi = 300)

```

```{r}
# Raw data files entered by RMNP staff from field data forms were processed using functions in in the R statistical package. Raw data were provided as 4 Excel files, with data split by year and type into various tabs. Data were consolidated and to facilitate cleaning and comparisons.     

### Data cleaning and wrangling
## base R approach
file.listing <- list.files(path = "./data/EVMP_data/TenYearReview") %>% 
  enframe() %>% 
  select(value) %>% 
  rename(fileName = value)

# create a table
file.listing %>%
  rename('Raw File Name' = fileName) %>% 
  gt() %>% 
  tab_header(title = "List of Raw Files")
```

```{r}
### Willow cumulative data baseline through 2018
#### There are two duplicate sets of files, one with a 'z' in the name, one without, but otherwise the same. In this chunk, picking one set (the zed set)
csv.all.lc <- csv.all.lc %>% 
  filter(str_detect(ffname, "z")) 

```

```{r}
######### CREATE TYPE FIELD #########
## this will make parsing variables in into groups easier  
csv.all.lc <- csv.all.lc %>% 
  mutate(file_name_abr = str_replace(string = ffname, pattern = "data/EVMP_data/csv/Willow_Cumulative_Data_Baseline_Through_2018-", replacement = ""))

## case when into type
csv.all.lc <- csv.all.lc %>% 
  dplyr::select(-ffname) %>%
  mutate(vType = case_when(grepl("Macro", file_name_abr) ~ "Macroplot",
                          grepl("site", file_name_abr, ignore.case = TRUE) ~ "Site_info",
                          grepl("Key", file_name_abr, ignore.case = TRUE) ~ "Key",
                          grepl("Line", file_name_abr, ignore.case = TRUE) ~ "Line_int"
                          )
         )

```

```{r}
## Variable names across input files 
# extract the field names from each csv
csv.all.lc <- csv.all.lc %>% 
  mutate(field_names = map(data, names)) 
  
# unnest to get at field names
# across all csv files
csv.all.lc %>% 
  unnest(field_names) %>% 
  distinct(file_name_abr,field_names) %>% 
  datatable(rownames = FALSE, caption = "Distinct field names acrosss all csv files correponding to tabs in master workbooks provided by RMNP.")

```

```{r}
#### Line intercept
csv.all.lc.li <- csv.all.lc %>% 
  filter(vType == "Line_int") 
```

```{r}
#### Select multiple columns. To combine, need the same fields to be present in each tab.

filtFunSel <- function(x){
  x %>% dplyr::select(c(DATE,
                      SITE_TYPE,
                      SITE_NUMBER,
                      SITE_ID,
                      SPECIES_CODE,
                      MAX_HEIGHT_CM,
                      BROWSED,
                      INTERCEPT_LENGTH_M,
                      GENUS))
}

### the above is used throughout below
# but now I want to grab the shrub intercept bits
filtFunSel_li <- function(x){
  x %>% dplyr::select(c(DATE,
                      SITE_TYPE,
                      SITE_NUMBER,
                      SITE_ID,
                      SPECIES_CODE,
                      SHRUB_INTERCEPT_START_M,
                      SHRUB_INTERCEPT_STOP_M,
                      MAX_HEIGHT_CM,
                      DEAD,
                      BROWSED,
                      INTERCEPT_LENGTH_M,
                      GENUS))
}

# create new list column with the selected rows as specified in the function
csv.all.lc.li <- csv.all.lc.li %>% 
  mutate(data.sel = map(.x = data, filtFunSel))

## purrr extract
csv.all.lc.li.df <- csv.all.lc.li %>% 
  pluck(1) %>%
  map(filtFunSel) %>% 
  reduce(.f = rbind)

# SITE_ID columns are NOT CONSISTENTLY NAMED
# eg WC1 and WC01

csv.all.lc.li.df <- csv.all.lc.li.df %>% 
  mutate(SITE_ID = case_when(SITE_ID == "WC1" ~ "WC01",
                       SITE_ID == "WC2" ~ "WC02",
                       SITE_ID == "WC3" ~ "WC03", 
                       SITE_ID == "WC4" ~ "WC04", 
                       SITE_ID == "WC4" ~ "WC04",
                       SITE_ID == "WC5" ~ "WC05",
                       SITE_ID == "WC6" ~ "WC06", 
                       SITE_ID == "WC7" ~ "WC07", 
                       SITE_ID == "WC8" ~ "WC08",
                       SITE_ID == "WC9" ~ "WC09",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC2" ~ "WNC02",
                       SITE_ID == "WNC3" ~ "WNC03", 
                       SITE_ID == "WNC4" ~ "WNC04", 
                       SITE_ID == "WNC4" ~ "WNC04",
                       SITE_ID == "WNC5" ~ "WNC05",
                       SITE_ID == "WNC6" ~ "WNC06", 
                       SITE_ID == "WNC7" ~ "WNC07", 
                       SITE_ID == "WNC8" ~ "WNC08",
                       SITE_ID == "WNC9" ~ "WNC09",
                       SITE_ID == "WK1" ~ "WK01",
                       SITE_ID == "WK2" ~ "WK02",
                       SITE_ID == "WK3" ~ "WK03", 
                       SITE_ID == "WK4" ~ "WK04", 
                       SITE_ID == "WK4" ~ "WK04",
                       SITE_ID == "WK5" ~ "WK05",
                       SITE_ID == "WK6" ~ "WK06", 
                       SITE_ID == "WK7" ~ "WK07", 
                       SITE_ID == "WK8" ~ "WK08",
                       SITE_ID == "WK9" ~ "WK09",
                       TRUE ~ as.character(SITE_ID))
  )


## join in additional site info from the master plot list
csv.all.lc.li.df <- left_join(csv.all.lc.li.df, site.info.clean, by = 'SITE_ID')
```

```{r}
## add fields/convert types 
csv.all.lc.li.df <- csv.all.lc.li.df %>%
  mutate(DATE = as.Date(DATE)) %>% 
  mutate(yr = as.factor(year(DATE))) %>%
  mutate(mo = month(DATE))

## convert "NA" for fencing to "Unfenced"

csv.all.lc.li.df <- csv.all.lc.li.df %>% 
  mutate(FENCED = case_when(is.na(FENCED) ~ "Unfenced",
                            TRUE ~ as.character(FENCED)))


## create timeClass field with BL including 2008 and 2009
csv.all.lc.li.df <- csv.all.lc.li.df %>% 
  mutate(timeClass = case_when(yr == 2008 ~ "BL",
                              yr == 2009 ~ "BL", 
                              TRUE ~ as.character(yr))) %>% 
  mutate(timeClass = as.factor(timeClass)) %>% 
  mutate(timeClass = fct_relevel(timeClass, "2018", "2013", "BL"))

```

```{r}
## Create a spatial lookup table for joining site info [in workbook tab].
sp.lu <- sinfo.df %>%
  dplyr::select(-c(SITE_TYPE,DATE,SITE_NUMBER, GPS_ACCURACY_M))

## make sure the 'SITE_ID' columns are consistent. This is a recurring issue.
sp.lu <- sp.lu %>% 
  mutate(SITE_ID = case_when(
    SITE_ID == "WC1" ~ "WC01",
                       SITE_ID == "WC2" ~ "WC02",
                       SITE_ID == "WC3" ~ "WC03", 
                       SITE_ID == "WC4" ~ "WC04", 
                       SITE_ID == "WC5" ~ "WC05",
                       SITE_ID == "WC6" ~ "WC06", 
                       SITE_ID == "WC7" ~ "WC07", 
                       SITE_ID == "WC8" ~ "WC08",
                       SITE_ID == "WC9" ~ "WC09",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC2" ~ "WNC02",
                       SITE_ID == "WNC3" ~ "WNC03", 
                       SITE_ID == "WNC4" ~ "WNC04", 
                       SITE_ID == "WNC4" ~ "WNC04",
                       SITE_ID == "WNC5" ~ "WNC05",
                       SITE_ID == "WNC6" ~ "WNC06", 
                       SITE_ID == "WNC7" ~ "WNC07", 
                       SITE_ID == "WNC8" ~ "WNC08",
                       SITE_ID == "WNC9" ~ "WNC09",
                       SITE_ID == "WK1" ~ "WK01",
                       SITE_ID == "WK2" ~ "WK02",
                       SITE_ID == "WK3" ~ "WK03", 
                       SITE_ID == "WK4" ~ "WK04", 
                       SITE_ID == "WK4" ~ "WK04",
                       SITE_ID == "WK5" ~ "WK05",
                       SITE_ID == "WK6" ~ "WK06", 
                       SITE_ID == "WK7" ~ "WK07", 
                       SITE_ID == "WK8" ~ "WK08",
                       SITE_ID == "WK9" ~ "WK09",
                       TRUE ~ as.character(SITE_ID))
  )

```

```{r}
#### Macroplot
csv.all.lc.mcro <- csv.all.lc %>% 
  filter(vType == "Macroplot") 
```

```{r}
## extract the macroplot data
FunSelMacro <- function(x){
  x %>% dplyr::select(c(DATE,
                      SITE_TYPE,
                      SITE_NUMBER,
                      SITE_ID,
                      SPECIES_CODE,
                      PERCENT_PLANT_IN_PLOT,
                      CANOPY_DIA_1_CM,
                      CANOPY_DIA_2_CM,
                      PLANT_HT_CM,
                      HT_TO_TALLEST_BUDSCAR_CM))
}

csv.all.lc.mcro <- csv.all.lc.mcro %>% 
  mutate(data.sel = map(.x = data, FunSelMacro))

## purrr extract
csv.all.lc.mcro.df <- csv.all.lc.mcro %>% 
  pluck(1) %>%
  map(FunSelMacro) %>% 
  reduce(.f = rbind)

# SITE_ID is not consistent.
# recode
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(SITE_ID = case_when(SITE_ID == "WC1" ~ "WC01",
                       SITE_ID == "WC2" ~ "WC02",
                       SITE_ID == "WC3" ~ "WC03", 
                       SITE_ID == "WC4" ~ "WC04", 
                       SITE_ID == "WC4" ~ "WC04",
                       SITE_ID == "WC5" ~ "WC05",
                       SITE_ID == "WC6" ~ "WC06", 
                       SITE_ID == "WC7" ~ "WC07", 
                       SITE_ID == "WC8" ~ "WC08",
                       SITE_ID == "WC9" ~ "WC09",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC2" ~ "WNC02",
                       SITE_ID == "WNC3" ~ "WNC03", 
                       SITE_ID == "WNC4" ~ "WNC04", 
                       SITE_ID == "WNC5" ~ "WNC05",
                       SITE_ID == "WNC6" ~ "WNC06", 
                       SITE_ID == "WNC7" ~ "WNC07", 
                       SITE_ID == "WNC8" ~ "WNC08",
                       SITE_ID == "WNC9" ~ "WNC09",
                       SITE_ID == "WK1" ~ "WK01",
                       SITE_ID == "WK2" ~ "WK02",
                       SITE_ID == "WK3" ~ "WK03", 
                       SITE_ID == "WK4" ~ "WK04", 
                       SITE_ID == "WK4" ~ "WK04",
                       SITE_ID == "WK5" ~ "WK05",
                       SITE_ID == "WK6" ~ "WK06", 
                       SITE_ID == "WK7" ~ "WK07", 
                       SITE_ID == "WK8" ~ "WK08",
                       SITE_ID == "WK9" ~ "WK09",
                       TRUE ~ as.character(SITE_ID))
  )

```

```{r, echo=FALSE}

# csv.all.lc.mcro.df

csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(yr = as.integer(year(DATE))) %>% 
  mutate(mo = lubridate::month(DATE))

### join in the spatial/site info
csv.all.lc.mcro.df <- left_join(csv.all.lc.mcro.df, sp.lu, by = "SITE_ID")

csv.all.lc.mcro.df %>% 
  tabyl(SITE_TYPE, yr)
```

```{r, echo=FALSE, eval=FALSE}
### macroplot
csv.all.lc.mcro <- csv.all.lc %>% 
  filter(vType == "Macroplot") 

# fields not in all of the tabs
csv.all.lc.mcro %>% 
  unnest(field_names) %>% 
  group_by(field_names) %>%
  tally() %>% 
  arrange(n) %>% 
  filter(n<6) %>% 
  datatable(rownames = FALSE, caption = "Macroplot inventory variable NOT present in every year's tab")

```

```{r, eval=TRUE}
# Macroplot processing
# use a custom function to select columns before rbinding
# note these are different field names than li that need to be matched
# this function snags only those fields in common between all of the tabs

FunSelMcro <- function(x){
  x %>% dplyr::select(c(CANOPY_DIA_1_CM, 
                        CANOPY_DIA_2_CM, 
                        DATE, 
                        GENUS, 
                        HT_TO_TALLEST_BUDSCAR_CM,
                        PERCENT_PLANT_IN_PLOT, 
                        PLANT_HT_CM, 
                        SITE_ID, 
                        SITE_NUMBER, 
                        SITE_TYPE, 
                        SPECIES_CODE))
    }


## apply function to select variables in common between all csv
csv.all.lc.mcro <- csv.all.lc.mcro %>% 
  mutate(data.sel = map(.x = data, FunSelMcro)) %>% 
  select(-field_names)

csv.all.lc.mcro <- csv.all.lc.mcro %>% 
  mutate(field_names = map(data.sel, names))

```

```{r}
## combine all using purrr:
# csv.all.lc.mcro.df <- csv.all.lc.mcro %>% 
#   pluck(4) %>% # note the specific index position
#   reduce(.f = rbind) # did this above

## add yr and month columns
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(yr = year(DATE)) %>% 
  mutate(mo = lubridate::month(DATE))

## join the site info
# csv.all.lc.mcro.df <- left_join(csv.all.lc.mcro.df, site.info.clean, by = "SITE_ID")

```

```{r}
## more cleaning...
## change case on species code (there is currently a mix of upper and lower cases)
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(SPECIES_CODE = toupper(SPECIES_CODE))

## import species code look up table
spp.lu <- read_csv("./data/EVMP_derived/species_code_lu.csv")

## Problems with 'Fenced' status. Many NA
## Presuming here that all NA are not fenced

## Reclassify 'NA' for fenced to 'N'
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(FENCED = case_when(is.na(FENCED) ~ "N", 
                            TRUE ~ as.character(FENCED))) 

```

```{r}
### !!! 
# Remove plots on the "removed" list in the site info through anti-join
# lu.removed.plot
# csv.all.lc.li.df

# remove all the removed plots identified in the site info tab if raw files
csv.all.lc.mcro.df <- anti_join(csv.all.lc.mcro.df, lu.removed.plot, by="SITE_ID")
```

```{r write_macroplot2disk, eval=FALSE}
## write this to disk
write_csv(csv.all.lc.mcro.df, "./data/EVMP_derived/macroplot_derived.csv")

```

## Willow plots: line intercept data

```{r, eval = FALSE, echo=FALSE}
# > From discussions with HA in the field, the orientation of line-intercept transects may not have had a consistent orientation from sampling interval to interval.
```

```{r}
### Counts of plots in fenced and unfenced contexts
## address missing attributes for pType
csv.all.lc.li.df <- csv.all.lc.li.df %>%
  mutate(pType = case_when(is.na(pType) ~ "willow",
                            TRUE ~ pType))

## address missing attributes for RANGE_TYPE
csv.all.lc.li.df <- csv.all.lc.li.df %>%
  mutate(RANGE_TYPE = case_when(is.na(RANGE_TYPE)  & SITE_TYPE == "WC" ~ "core winter range",
                            TRUE ~ RANGE_TYPE))

```

```{r}
## Make NA unburned; presumes NA are "unburned"
## standardize encoding of BURNED
csv.all.lc.li.df <- csv.all.lc.li.df %>%
  mutate(BURNED = case_when(is.na(BURNED) ~ "Unburned",
                            BURNED == "Not burned" ~ "Unburned",
                            TRUE ~ BURNED))

## reverse factor levels
csv.all.lc.li.df <- csv.all.lc.li.df %>%
  mutate(timeClass = forcats::fct_rev(timeClass))

## Reorder levels
csv.all.lc.li.df <- csv.all.lc.li.df %>% 
  mutate(SITE_TYPE = as_factor(SITE_TYPE)) %>% 
  mutate(SITE_TYPE = forcats::fct_relevel(SITE_TYPE, "WK", after = 2))

```

```{r}
## Address missing RANGE_TYPE attribution
csv.all.lc.li.df <- csv.all.lc.li.df %>%
  mutate(RANGE_TYPE = case_when(SITE_TYPE == "WC" ~ "core winter range",
                                TRUE ~ RANGE_TYPE)) %>% 
  distinct() %>% 
  mutate(zCond = case_when(BURNED == "Burned" & FENCED == "Unfenced" ~ "BG",
                           BURNED == "Burned" & FENCED == "Fenced" ~ "BF",
                           BURNED == "Unburned" & FENCED == "Unfenced" ~ "UG",
                           BURNED == "Unburned" & FENCED == "Fenced" ~ "UF"
                           )) %>%
  mutate(zCond2 = paste0(SITE_TYPE,"-",zCond)) ## these are the classes used in teh weighting scheme in Zeigenfuss 2015

```


```{r}
# lu.removed.plot
# csv.all.lc.li.df

# remove all the removed plots identified in the site info tab if raw files
csv.all.lc.li.df <- anti_join(csv.all.lc.li.df, lu.removed.plot, by="SITE_ID")
```


```{r write_li_to_disk, eval = FALSE}
write_csv(csv.all.lc.li.df, "./data/EVMP_derived/line_intercept_willow_cleaned.csv")
```

### Height: all shrubs

#### All shrubs, site type

```{r}
## Boxplot (no wk)
csv.all.lc.li.df %>% 
  filter(pType == "willow") %>%
  filter(SITE_TYPE != "WK") %>% 
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  ggplot(aes(timeClass, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill = FENCED), outlier.shape = NA) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,300) +
  labs(x="", y= "Height (cm)", title = "Maximum shrub height", caption = "All shrub species line intercept plots", fill="") +
  scale_fill_manual(values = c("grey90","grey50")) +
  theme_minimal() + 
  theme(legend.position = "bottom") +
  # theme(axis.text.x=element_text(angle = 45, hjust = 1)) #+
  facet_wrap(~SITE_TYPE)

ggsave("./output/figures_202107/WCWNCWK_LI_shrubHt_boxplot.png", width = 6.5, height = 4.875)

```

```{r}
#### Table of mean max height
csv.all.lc.li.df %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  group_by(timeClass, SITE_TYPE) %>%
  descr(MAX_HEIGHT_CM, stats = "common") %>% 
  summarytools::tb() %>% 
  mutate(across(c('mean','sd','pct.valid'), ~round(.,digits = 1))) %>% 
  gt() %>% 
  tab_header(title = "LI, Mean max height", subtitle = "All shrub species, all site types")

```

#### All shrubs, site type, fenced/unfenced

```{r}
#### Table of mean max height
csv.all.lc.li.df %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  group_by(timeClass, SITE_TYPE, FENCED) %>%
  descr(MAX_HEIGHT_CM, stats = "common") %>% 
  summarytools::tb() %>% 
  mutate(across(c('mean','sd','pct.valid'), ~round(.,digits = 1))) %>% 
  gt() %>% 
  tab_header(title = "LI, Mean max height", subtitle = "All shrubs, all site types, fenced/unfenced")

```

#### All shrubs, site type, fenced/unfenced, burned/unburned

```{r}
## Boxplot
csv.all.lc.li.df %>% 
  filter(pType == "willow") %>%
  filter(SITE_TYPE != "WK") %>% 
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  ggplot(aes(timeClass, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill = FENCED), outlier.shape = NA) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,300) +
  labs(x="", y= "Height (cm)", title = "Maximum shrub height", caption = "All shrub species line intercept plots", fill="") +
  scale_fill_manual(values = c("grey90","grey50")) +
  theme_minimal() + 
  theme(legend.position = "bottom") +
  # theme(axis.text.x=element_text(angle = 45, hjust = 1)) #+
  facet_wrap(BURNED~SITE_TYPE)

ggsave("./output/figures_202107/WCWNC_LI_shrubHt_FenBur_boxplot.png", width = 6.5, height = 4.875)

```

```{r}
##
# revised
# WC, WNC - All shrub species line intercept plots

plx1 <- csv.all.lc.li.df %>% 
  filter(pType == "willow") %>%
  filter(SITE_TYPE == "WC") %>% 
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  ggplot(aes(timeClass, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill = FENCED), outlier.shape = NA) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,300) +
  labs(x="", y= "Height (cm)", title = "Core Winter Range", fill="") +
  scale_fill_manual(values = c("grey90","grey50")) +
  theme_minimal() + 
  theme(legend.position = "right") +
  # theme(axis.text.x=element_text(angle = 45, hjust = 1)) #+
  facet_wrap(~BURNED)

plx2 <- csv.all.lc.li.df %>% 
  filter(pType == "willow") %>%
  filter(SITE_TYPE == "WNC") %>% 
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  ggplot(aes(timeClass, MAX_HEIGHT_CM)) +
  geom_boxplot(fill = "grey50", outlier.shape = NA) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,300) +
  labs(x="", y= "Height (cm)",  title = "Noncore Winter Range", caption = "", fill="") +
  # scale_fill_manual(values = c("grey90","grey50")) +
  theme_minimal() + 
  # theme(legend.position = "top") +
  # theme(axis.text.x=element_text(angle = 45, hjust = 1)) #+
  facet_wrap(~BURNED)

plx3 <- csv.all.lc.li.df %>% 
  filter(pType == "willow") %>%
  filter(SITE_TYPE == "WK") %>% 
  mutate(yr = as.character(yr)) %>%
  # filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  ggplot(aes(timeClass, MAX_HEIGHT_CM)) +
  geom_boxplot(fill = "grey50", outlier.shape = NA) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,300) +
  labs(x="", y= "Height (cm)", title = "Kawuneeche Valley", caption = "Maximum shrub height, all species", fill="") +
  # scale_fill_manual(values = c("grey90","grey50")) +
  theme_minimal() + 
  # theme(legend.position = "top") +
  # theme(axis.text.x=element_text(angle = 45, hjust = 1)) #+
  facet_wrap(~BURNED)


# combine
plx1 + plx2 + plx3 +
  plot_layout(widths = c(3, 1, 1)) +
  plot_annotation(tag_levels = 'A')

# ggsave("./output/figures_202107/Revised_WCWNCWK_LI_shrubHt_FenBur_boxplot.png", width = 8, height = 4.875)

```

### Height: willow species only

#### All willow species, site type

**Max shrub height in-line intercept**

```{r}
csv.wil.lc.li.df <- csv.all.lc.li.df %>% 
  filter(str_detect(SPECIES_CODE, "^SA"))
  
## Boxplot
csv.wil.lc.li.df %>% 
  filter(pType == "willow") %>%
  # filter(SITE_TYPE == "WC") %>% 
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  # mutate(yr = as.double(yr)) %>%
  ggplot(aes(timeClass, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill = FENCED), outlier.shape = NA) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,600) +
  labs(x="", y= "Height (cm)", title = "Maximum willow height", caption = "WC, All willow species line intercept plots", fill="") +
  scale_fill_manual(values = c("grey90","grey50")) +
  theme_minimal() + 
  # theme(axis.text.x=element_text(angle = 45, hjust = 1)) #+
  facet_wrap(~SITE_TYPE)

# ggsave("./output/figures_202107/WCWNCWK_LI_willHt_boxplot.png", width = 6.5, height = 4.875)

```

```{r}
#### Table of mean max height
csv.wil.lc.li.df %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  group_by(timeClass, SITE_TYPE) %>%
  descr(MAX_HEIGHT_CM, stats = "common") %>%
  summarytools::tb() %>%
  mutate(across(c('mean','sd','pct.valid'), ~round(.,digits = 1))) %>% 
  gt() %>% 
  tab_header(title = "LI, Mean max height", subtitle = "All willow species, all site types")

```

#### All willow species, site type, fenced/unfenced

```{r}
#### Table of mean max height
csv.wil.lc.li.df %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  group_by(timeClass, SITE_TYPE, FENCED) %>%
  descr(MAX_HEIGHT_CM, stats = "common") %>% 
  summarytools::tb() %>% 
  mutate(across(c('mean','sd','pct.valid'), ~round(.,digits = 1))) %>% 
  gt() %>% 
  tab_header(title = "LI, Mean max height", subtitle = "All willow, all site types, fenced/unfenced")

```

#### All willow species, site type, fenced/unfenced, burned/unburned

```{r}
## Boxplot
csv.wil.lc.li.df %>% 
  filter(pType == "willow") %>%
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  ggplot(aes(timeClass, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill = FENCED), outlier.shape = NA) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,600) +
  labs(x="", y= "Height (cm)", title = "Maximum shrub height", caption = "WC, All willow species line intercept plots", fill="") +
  scale_fill_manual(values = c("grey90","grey50")) +
  theme_minimal() + 
  # theme(axis.text.x=element_text(angle = 45, hjust = 1)) #+
  facet_wrap(BURNED~SITE_TYPE)

# ggsave("./output/figures_202107/WCWNCWK_LI_willHt_FenBur_boxplot.png", width = 6.5, height = 4.875)

```

```{r}
#### Table of mean max height
csv.wil.lc.li.df %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  group_by(timeClass, SITE_TYPE, FENCED, BURNED) %>%
  descr(MAX_HEIGHT_CM, stats = "common") %>% 
  summarytools::tb() %>% 
  mutate(across(c('mean','sd','pct.valid'), ~round(.,digits = 1))) %>% 
  gt() %>% 
  tab_header(title = "LI, Mean max height", subtitle = "All willow, all site types, fenced/unfenced, burned/unburned")

```

```{r}
# Shrub Line Intercept Datataset 
csv.wil.lc.li.df %>% 
  filter(timeClass == "BL" | timeClass == "2013" |timeClass == "2018") %>% 
  filter(!is.na(FENCED)) %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  # group_by(yr,SITE_TYPE, FENCED, SITE_ID, SPECIES_CODE) %>%
  # filter(SITE_TYPE == "WC") %>% 
  group_by(timeClass,SITE_TYPE, FENCED, SPECIES_CODE) %>%
  summarise(mean.max.ht = round(mean(MAX_HEIGHT_CM, na.rm=TRUE),0)) %>% 
  filter(FENCED != "Y_but_fence_down_since_2013") %>% 
  filter(SPECIES_CODE != "SAXX") %>% 
  ggplot(aes(timeClass, SPECIES_CODE)) +
  geom_tile(aes(fill=mean.max.ht),color = 'white') +
  # scale_fill_viridis(option = "A") +
  scale_fill_gradientn(colours = colfunc2(5)) +
  geom_text(aes(label=mean.max.ht), color = 'white', size = 3.75) +
  geom_text(aes(label=mean.max.ht), color = 'grey', size = 3.75, alpha=0.7) +
  theme_minimal() +
  labs(title = "Maximum shrub height", subtitle = "Mean of shrub height pooled by fenced status", x = "Year", y = "Species", fill = "cm") +
  facet_grid(SITE_TYPE~FENCED)

# ggsave("./output/figures_202107/WCWNCWK_maxWilHt_by_spp_lbl.png", width = 6.5, height = 6.5, dpi = 300)

```

#### Individual willow species

```{r}

pl.li.samo.density <- csv.all.lc.li.df %>%
  filter(yr !=2009 & yr != 2015 & yr !=2017) %>% 
  filter(SITE_TYPE != "WK") %>%
  filter(SPECIES_CODE == "SAMO") %>%   
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR"& SPECIES_CODE !="SAER") %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  ggplot() +
  ggridges::geom_density_ridges(aes(x = MAX_HEIGHT_CM, y =  yr), alpha = 0.45, ) +
  # viridis::scale_fill_viridis(discrete = TRUE, option = "D") +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(3)) +
  facet_wrap(~SITE_TYPE, ncol = 1) +
  labs(x = "Max height (cm)", y = "Year", title = "SAMO")

pl.li.sage.density <- csv.all.lc.li.df %>%
  filter(yr !=2009 & yr != 2015 & yr !=2017) %>% 
  filter(SITE_TYPE != "WK") %>%
  filter(SPECIES_CODE == "SAGE") %>%   
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR"& SPECIES_CODE !="SAER") %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  ggplot() +
  ggridges::geom_density_ridges(aes(x = MAX_HEIGHT_CM, y =  yr), alpha = 0.45, ) +
  # viridis::scale_fill_viridis(discrete = TRUE, option = "D") +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(3)) +
  facet_wrap(~SITE_TYPE, ncol = 1) +
  labs(x = "Max height (cm)", y = "Year", title = "SAGE")

pl.li.sapl.density <- csv.all.lc.li.df %>%
  filter(yr !=2009 & yr != 2015 & yr !=2017) %>% 
  filter(SITE_TYPE != "WK") %>%
  filter(SPECIES_CODE == "SAPL") %>%   
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR"& SPECIES_CODE !="SAER") %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  ggplot() +
  ggridges::geom_density_ridges(aes(x = MAX_HEIGHT_CM, y =  yr), alpha = 0.45, ) +
  # viridis::scale_fill_viridis(discrete = TRUE, option = "D") +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(3)) +
  facet_wrap(~SITE_TYPE, ncol = 1) +
  labs(x = "Max height (cm)", y = "Year", title = "SAPL")

pl.li.samo.density + pl.li.sage.density + pl.li.sapl.density + patchwork::plot_layout(ncol=3)


# csv.all.lc.li.df %>% 
#   tabyl(SPECIES_CODE)
```

```{r}
csv.all.lc.li.df %>%
  filter(yr !=2009 & yr != 2015 & yr !=2017) %>% 
  filter(SITE_TYPE != "WK") %>%
  filter(SPECIES_CODE == "SAMO" | SPECIES_CODE == "SAGE" | SPECIES_CODE == "SAPL" ) %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  # filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR"& SPECIES_CODE !="SAER") %>%
  # filter(str_detect(SPECIES_CODE, "^SA")) %>%
  ggplot() +
  geom_boxplot(aes(x = yr, y = MAX_HEIGHT_CM), fill = "grey90") +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,600) +
  theme_minimal() +
  facet_grid(SITE_TYPE ~ SPECIES_CODE) +
  # facet_wrap(~SITE_TYPE, ncol = 1) +
  labs(y = "Max height (cm)", x = "Year", caption = "SAMO")

```

*Line intercept summary table*

```{r}
csv.all.lc.li.df %>%
  filter(yr !=2009 & yr != 2015 & yr !=2017) %>% 
  filter(SITE_TYPE != "WK") %>%
  filter(SPECIES_CODE == "SAMO" | SPECIES_CODE == "SAGE" | SPECIES_CODE == "SAPL" ) %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>% 
  group_by(SPECIES_CODE, timeClass, FENCED) %>% 
  descr(MAX_HEIGHT_CM, stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  gt() %>% 
  tab_header(title = "li: species comparisons")

```

*Salix gereyiana*

```{r}
## another species: SAGE
csv.all.lc.li.df %>%
  filter(yr !=2009 & yr != 2015 & yr !=2017) %>%
  filter(SITE_TYPE == "WC") %>%
  filter(SPECIES_CODE == "SAGE") %>%
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR"& SPECIES_CODE !="SAER") %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  ggplot() +
  ggridges::geom_density_ridges(aes(x = MAX_HEIGHT_CM, y =  yr, fill = FENCED), alpha = 0.45, ) +
  scale_fill_manual(values = colfunc2(2)) +
  # viridis::scale_fill_viridis(discrete = TRUE, option = "D") +
  theme_minimal() +
  # facet_wrap(~SITE_TYPE, ncol = 1) +
  facet_grid(SPECIES_CODE~SITE_TYPE) +
  labs(x = "Max height (cm)", y = "Year", caption = "Line intercept data")

```

```{r, eval=FALSE, fig.height=9, fig.width=8}

### Max shrub height
csv.all.lc.li.df %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  # names() %>% 
  # group_by(yr,SITE_TYPE, SPECIES_CODE, MAX_HEIGHT_CM) %>%
  # summarise(mean.max.ht = mean(MAX_HEIGHT_CM,na.rm=TRUE)) %>% 
  ggplot(aes(yr, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill=SITE_TYPE), color = 'black') +
  scale_fill_manual(values = colfunc2(3)) +
  # scale_fill_viridis(discrete = TRUE) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,600) +
  theme_minimal() +
  labs(title = "Maximum shrub height by year, species and Site Type", x = "Year", y = "Species")+
  facet_wrap(~SPECIES_CODE, ncol = 3)

```

```{r}

csv.all.lc.li.df %>% 
  filter(!is.na(FENCED)) %>%
  filter(FENCED != "Y_but_fence_down_since_2013") %>%
  filter(yr != "2015" & yr != "2009" & yr != "" & yr != "2017") %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  filter(SITE_TYPE == "WC") %>% 
  ggplot(aes(yr, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill=FENCED), color = 'black') +
  scale_fill_manual(values=c("grey90","grey50")) +
  # scale_fill_manual(values = colfunc2(2)) +
  # scale_fill_viridis(discrete = TRUE) +
  # theme_minimal() +
  theme_minimal() +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,600) +
  labs(title = "Maximum shrub height by year, species and fencing", x = "Year", y = "Height")+
  # facet_wrap(~SPECIES_CODE, ncol = 3) %>%
  facet_grid(SPECIES_CODE~yr, scales = "free_x")

```

```{r}
#### Core winter range: fenced vs unfenced
## all willow spp  
csv.all.lc.li.df %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>% 
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(SITE_TYPE == "WC") %>% 
  ggplot(aes(yr, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill=FENCED), color = 'black', outlier.shape = NA) +
  theme_minimal() +
  ylim(0, 350) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  # scale_fill_manual(pal.5a) +
  # scale_fill_manual(values = c("ivory2","lightblue")) +
  scale_fill_manual(values = c("grey90","grey50")) +
  labs(x = "", y = "Max height (cm)", fill = "", title = "Core Winter Range Plots: All Willow Species", caption = "Line intercept data, WC")
  
ggsave("./output/figures_202107wc_all_willow_li_boxplot01.png", width = 6, height = 4.5, dpi= 300)

```


```{r, eval=TRUE}
## salix monitcola
csv.all.lc.li.df %>%
  filter(pType == "willow") %>% 
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  # filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  filter(SPECIES_CODE =="SAMO") %>% 
  filter(SITE_TYPE == "WC") %>% 
  ggplot(aes(yr, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill=FENCED), color = 'black', outlier.shape = NA) +
  theme_minimal() +
  ylim(0,320) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  scale_fill_manual(values = c("grey90","grey50")) +
  labs(x = "Year", y = "Max height (cm)", fill = "Fenced") +
  labs(x = "Year", y = "Max height (cm)", fill = "", title = "Core Winter Range Plots: SAMO only", caption = "Line intercept data")
  # labs(title = "Salix monticola maximum shrub height by year, fencing", x = "Year", y = "Species")

ggsave("./output/figures_202107/WC_willLI_SAMO_bxplt01.png", width = 6, height = 4.5, dpi= 300)

```

```{r}

## all shrub species
csv.all.lc.li.df %>%
  filter(pType == "willow") %>% 
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(SITE_TYPE == "WC") %>% 
  ggplot(aes(yr, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill=FENCED), color = 'black', outlier.shape = NA) +
  # scale_fill_viridis(discrete = TRUE) +
  # theme_minimal() +
  theme_minimal() +
  ylim(0,320) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  scale_fill_manual(values = c("grey90","grey50")) +
  # labs(x = "Year", y = "Max height (cm)", fill = "Fenced?") +
  labs(x = "Year", y = "Max height (cm)", fill = "", title = "Core Winter Range Plots: All Shrub Species", caption = "Line intercept data")

ggsave("./output/figures_202107/WC_willLI_allShrubSpp_bxplt01.png", width = 6, height = 4.5, dpi= 300)

```

```{r}
csv.all.lc.li.df %>%
  filter(pType == "willow") %>% 
  filter(SPECIES_CODE != "SAXX") %>% 
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  # filter(str_detect(SPECIES_CODE, "^SA")) %>%
  filter(FENCED == "Unfenced" | FENCED == "Fenced") %>% 
  group_by(yr, SPECIES_CODE, FENCED) %>% 
  # summarise(mean.ht = mean(MAX_HEIGHT_CM, na.rm = TRUE), sd.ht = sd(MAX_HEIGHT_CM, na.rm = TRUE)) %>%
  summarise(mean.ht = mean(MAX_HEIGHT_CM, na.rm = TRUE)) %>% 
  pivot_wider(names_from = yr, values_from = c(mean.ht)) %>% 
  gt::gt() %>% 
  fmt_number(
    columns = vars('2008','2013','2018'),
    decimals = 1,
    use_seps = FALSE
  ) %>% 
  tab_header("Mean height by shrub species")

```

```{r, echo=FALSE, eval=FALSE}

csv.all.lc.li.df %>%
  filter(pType == "willow") %>% 
  filter(SPECIES_CODE != "SAXX") %>% 
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  filter(FENCED == "Unfenced" | FENCED == "Fenced") %>% 
  group_by(yr, FENCED) %>% 
  summarise(mean.ht = mean(MAX_HEIGHT_CM, na.rm = TRUE), sd.ht = sd(MAX_HEIGHT_CM, na.rm = TRUE)) %>% 
  pivot_wider(names_from = yr, values_from = c(mean.ht,sd.ht)) %>% 
  select(contains("2008"),contains("2013"), contains("2018")) %>% 
  gt::gt() %>% 
  fmt_number(
    columns = vars("mean.ht_2008","mean.ht_2013","mean.ht_2018","sd.ht_2008","sd.ht_2013", "sd.ht_2018"),
    decimals = 1,
    use_seps = FALSE
  ) %>% 
  tab_header("Mean height (cm) by all willow species, line intercept")

```

```{r, eval=FALSE}
# Maximum Core winter range sites, maximum shrub height by species, fencing treatment, and year in line interecept dataset.**

csv.all.lc.li.df %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(FENCED == "Unfenced" | FENCED == "Fenced") %>% 
  # filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  filter(SITE_TYPE == "WC") %>% 
  group_by(SPECIES_CODE,yr,FENCED) %>% 
  dplyr::summarise(mean.max.ht = mean(MAX_HEIGHT_CM, na.rm = TRUE)) %>%
  ungroup() %>% 
  mutate(yr = as.character(yr)) %>% 
  mutate(yr = anytime::anytime(yr)) %>% 
  ggplot(aes(x = yr, y = mean.max.ht)) +
  geom_smooth(aes(color = FENCED), method = "lm", se = FALSE, alpha = .5) +
  geom_point(aes(color = FENCED)) +
  scale_shape_manual(values = c(21,24)) + 
  scale_color_manual(values = c("blue", "black")) +
  theme_minimal() +
  labs(caption = "Core winter range sites: maximum shrub height by year, fencing", x = "Year", y = "Height  (cm)", color = "") +
  facet_wrap(~SPECIES_CODE, ncol = 2)

```

```{r, eval=FALSE}
## reclass the burned NA
csv.all.lc.li.df <- csv.all.lc.li.df %>% 
  mutate(BURNED = case_when(is.na(BURNED) ~ "Unburned",
                            TRUE ~ as.character(BURNED)))

csv.all.lc.li.df %>% 
  filter(BURNED != "BURNED") %>%
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  filter(SPECIES_CODE != "SAXX") %>%
  filter(yr == 2008 | yr == 2009 | yr == 2013 | yr == 2018) %>%
  filter(FENCED == "Unfenced" | FENCED == "Fenced") %>% 
  # filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  filter(SITE_TYPE == "WC") %>%
  # distinct(SPECIES_CODE) %>% 
  mutate(yr = as.character(yr)) %>% 
  mutate(yr = anytime::anytime(yr)) %>% 
  # mutate(yr = as.integer(yr)) %>% 
  ggplot(aes(x = yr, y = MAX_HEIGHT_CM)) +
  # geom_smooth(aes(color = FENCED), se = FALSE) +
  geom_smooth(aes(color = FENCED), method = "lm", se = FALSE) +
  geom_jitter(aes(color = FENCED, shape = FENCED)) +
  scale_color_manual(values = c("blue", "black")) +
  scale_shape_manual(values = c(21,24)) +
  theme_minimal() +
  # scale_fill_manual(values = c("ivory2","lightblue")) +
  labs(title = "Core winter range sites: maximum shrub height by year, fencing", x = "Year", color = "", shape = "", y = "Height (cm)", caption = "SAMO,SAPL, SAGE, SABE,SADR,SAPE,SAER")  +
  facet_wrap(~BURNED)

ggsave("./output/figures_202107/WC_Li_burned_v_unburned.png", width = 6.5, height = 4.5, dpi=300)

```

```{r}
## Core winter range sites: maximum shrub height by year, fencing -- point plot with LM trend line

csv.all.lc.li.df %>% 
  filter(BURNED != "BURNED") %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  # filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  filter(FENCED == "Unfenced" | FENCED == "Fenced") %>% 
  filter(SPECIES_CODE != "SAXX") %>% 
  # filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  filter(SITE_TYPE == "WC") %>%
  mutate(yr = as.character(yr)) %>% 
  mutate(yr = anytime::anytime(yr)) %>% 
  ggplot(aes(x = yr, y = MAX_HEIGHT_CM)) +
  geom_smooth(aes(color = FENCED, lty = FENCED), method = "lm", se = FALSE) +
  # geom_point(aes(color = FENCED, shape = FENCED)) +
  geom_jitter(aes(color = FENCED, shape = FENCED)) +
  scale_color_manual(values = c("blue", "black")) +
  scale_shape_manual(values = c(21,24)) +
  theme_minimal() +
  labs(title = "Core winter range sites: maximum shrub height by year, fencing", x = "Year", color = "", shape = "", y = "Height (cm)", lty = "", caption = "SAMO,SAPL, SAGE, SABE,SADR,SAPE,SAER") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r, eval=TRUE}
# burned faceted
csv.all.lc.li.df %>% 
  filter(BURNED != "BURNED") %>%
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  filter(SPECIES_CODE != "SAXX") %>%
  filter(yr == 2008 | yr == 2009 | yr == 2013 | yr == 2018) %>%
  filter(FENCED == "Unfenced" | FENCED == "Fenced") %>% 
  filter(SITE_TYPE == "WC") %>%
  mutate(yr = as.character(yr)) %>% 
  mutate(yr = anytime::anytime(yr)) %>% 
  ggplot(aes(x = yr, y = MAX_HEIGHT_CM)) +
  geom_smooth(aes(color = FENCED, lty = FENCED), method = "lm", se = FALSE) +
 geom_jitter(aes(color = FENCED, shape = FENCED)) +
  scale_shape_manual(values = c(21,24)) + 
  scale_color_manual(values = c("blue", "black")) +
  theme_minimal() +
  labs(title = "Core winter range: maximum shrub height, fencing, burning", x = "Year", color = "", shape = "", lty = "", y = "Height (cm)", caption = "Pooled SAMO,SAPL, SAGE, SABE,SADR,SAPE,SAER")  +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(~BURNED)

```

## Willow plots: macroplot data

```{r}
## Data munging 
# calculate the average canopy diameter
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(CANOPY_DIAM_AVG = (CANOPY_DIA_1_CM + CANOPY_DIA_2_CM)/2) 

### canopy diameter by species
mcro.canopy.diam.sum <- csv.all.lc.mcro.df %>%
  group_by(SITE_ID, yr, SPECIES_CODE, FENCED) %>% 
  summarise(cano_diam_med = median(CANOPY_DIAM_AVG)) 
```

```{r}
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(timeClass = case_when(yr == 2008 ~ "BL",
                              yr == 2009 ~ "BL", 
                              TRUE ~ as.character(yr))) %>% 
  mutate(timeClass = as.factor(timeClass)) %>% 
  mutate(timeClass = fct_relevel(timeClass, "2018", "2013", "BL"))

```

```{r}
## cleaning the LOCATION tab
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>%
  mutate(LOCATION = case_when(is.na(LOCATION) & SITE_TYPE == "WK" ~ "Kawuneeche",
                              TRUE ~ LOCATION))%>%
  mutate(LOCATION = str_replace(LOCATION, "_", " ")) %>%
  mutate(LOCATION = str_replace(LOCATION, "_", " ")) 
```

```{r}
#**Note: WC5,6,7,8,11,33 are listed as "removed" so are eliminated**

## clean
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  filter(!SITE_ID %in% c("WC05","WC06","WC07","WC08","WC11","WC33"))

```

```{r, echo=FALSE, eval=FALSE}
csv.all.lc.mcro %>% 
  unnest(field_names) %>% 
  distinct(file_name_abr,field_names) %>% 
  datatable(rownames = FALSE, caption = "Macroplot inventory variable names.")

```

```{r}
# lu.removed.plot
# csv.all.lc.mcro.df

# remove all the removed plots
csv.all.lc.mcro.df <- anti_join(csv.all.lc.mcro.df, lu.removed.plot, by="SITE_ID")

```

### Canopy cover  
```{r, eval=TRUE}
## average the canopy
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(CANOPY_DIA_CM_avg = (CANOPY_DIA_1_CM + CANOPY_DIA_2_CM)/2)

## clean up
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(FENCED = case_when(FENCED == "Y_but_fence_down_since_2013" ~ "Unfenced",
                             FENCED == "Y" ~ "Fenced",
                             FENCED == "N" ~ "Unfenced")) 

# quick check
# csv.all.lc.mcro.df %>% tabyl(FENCED)

# lots of burned categories. Some don't make sense (e.g., "N Y"). Collapsing to Burned/Unburned

csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(BURNED = case_when(BURNED == "Unburned" ~ "Unburned",
                            BURNED == "N Y" ~ "Burned", # ??
                            BURNED == "Completely" ~ "Burned",
                            BURNED == "Moderately" ~ "Burned",
                            BURNED == "Moderately to Completely" ~ "Burned",
                            BURNED == "Y" ~ "Burned",
                            BURNED == "N" ~ "Unburned",
                            BURNED == "Not burned" ~ "Unburned",
                            is.na(BURNED) ~ "Unburned",
                            TRUE ~ BURNED)) %>% 
  mutate(DATE = ymd(DATE))

## add a species group attribute -- willow/non-willow
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>%
  mutate(spp_group = case_when(str_detect(SPECIES_CODE, "^SA") ~ "willow",
                               TRUE ~ "non-willow"))

```

```{r}
# Add condition classes from Zeigenfuss 2015 zcond lu
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>%
  mutate(zCond = case_when(BURNED == "Burned" & FENCED == "Unfenced" ~ "BG",
                           BURNED == "Burned" & FENCED == "Fenced" ~ "BF",
                           BURNED == "Unburned" & FENCED == "Unfenced" ~ "UG",
                           BURNED == "Unburned" & FENCED == "Fenced" ~ "UF"
                           )) %>%
  mutate(zCond2 = paste0(SITE_TYPE,"-",zCond)) ## these are the classes used in the weighting scheme in Zeigenfuss 2015

```

```{r, echo=TRUE, eval=FALSE}
## Key question. What to do with burned plots at baseline? They weren't burned at baseline, so should be "unburned" at that timeclass BUT if the goal is to track that cohort of plots that became burned...
## ensure that no plots are attributed as burned at baseline (fire happened in 2012)
csv.all.lc.mcro.df %>%
  filter(timeClass %in% c("BL","2013","2018")) %>%
  mutate(timeClass = fct_drop(timeClass)) %>% 
  tabyl(timeClass, BURNED) %>% 
  gt()

# moving forward treating them as the second scenario...
```

```{r}
#### Calculate cover
# prep the percent cover. As character in the raw data. Assume NA 0
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(PERCENT_PLANT_IN_PLOT = replace_na(data = PERCENT_PLANT_IN_PLOT, replace = 0)) %>% 
  mutate(PERCENT_PLANT_IN_PLOT = as.numeric(PERCENT_PLANT_IN_PLOT))

  # mutate(PERCENT_PLANT_IN_PLOT = case_when(is.na(PERCENT_PLANT_IN_PLOT) ~ 1,
  #        TRUE ~ PERCENT_PLANT_IN_PLOT)) %>% # note: opposite assumption with what to do with NA

canopy.all.spp <- csv.all.lc.mcro.df %>%
  mutate(PERCENT_PLANT_IN_PLOT = as.numeric(PERCENT_PLANT_IN_PLOT)/100) %>% 
  mutate(PERCENT_PLANT_IN_PLOT = case_when(PERCENT_PLANT_IN_PLOT == 1.45 ~ .145,
         TRUE ~ PERCENT_PLANT_IN_PLOT)) %>% # correct error in raw data
  # mutate(cano.area.m2 = PERCENT_PLANT_IN_PLOT   * (CANOPY_DIA_CM_avg/2)^2 * 3.141593 * 0.0001) %>% 
  mutate(cano.area.m2 = ((((CANOPY_DIA_1_CM/100)*(CANOPY_DIA_2_CM/100)*3.141593)/4) * PERCENT_PLANT_IN_PLOT)) # this is how LZ calculated cover in the SAS 2013 code update. Slightly different estimates than method used in previous. For consistency, using LZ formula 

## calculate sum canopy area by species
canopy.all.spp <- canopy.all.spp %>% 
  mutate(cover.plant = cano.area.m2/16 * 100) %>% 
  mutate(cover.plant = case_when(cover.plant > 100 ~ 100,
                           TRUE ~ cover.plant)) %>% 
  group_by(timeClass, SPECIES_CODE, SITE_ID, SITE_TYPE, BURNED, FENCED) %>% 
  mutate(cano.area.m2.spp.sum = sum(cano.area.m2)) %>% 
  ungroup() %>% 
  mutate(cover.spp = cano.area.m2.spp.sum/16 * 100) %>% 
  mutate(cover.spp = case_when(cover.spp > 100 ~ 100,
                           TRUE ~ cover.spp))
  
### willow cover. Summed across all willows in plot, div plot area
canopy.willow.allspp <- canopy.all.spp %>%
  filter(spp_group == "willow") %>% 
  group_by(timeClass, SITE_ID, SITE_TYPE, BURNED, FENCED) %>% 
  dplyr::summarize(cano.area.m2.will.sum = sum(cano.area.m2)) %>% 
  ungroup() %>% 
  mutate(cover.will = cano.area.m2.will.sum/16 * 100) %>% 
  mutate(cover.will = case_when(cover.will > 100 ~ 100,
                           TRUE ~ cover.will)) %>% 
  mutate(zCond = case_when(BURNED == "Burned" & FENCED == "Unfenced" ~ "BG",
                           BURNED == "Burned" & FENCED == "Fenced" ~ "BF",
                           BURNED == "Unburned" & FENCED == "Unfenced" ~ "UG",
                           BURNED == "Unburned" & FENCED == "Fenced" ~ "UF"
                           )) %>%
  mutate(zCond2 = paste0(SITE_TYPE,"-",zCond)) ## add the 'condition' classes used by Zeignfuss etal in their 2015 report

```

```{r, echo=FALSE, eval=FALSE}

## sum by species and calculate cover
# canopy.all.spp.sum <- canopy.all.spp %>%
#   group_by(timeClass, SITE_ID, SPECIES_CODE, SITE_TYPE, LOCATION, FENCED, BURNED) %>% 
#   dplyr::summarise(cano.sppsum.m2 = sum(cano.sppsum.m2)) %>% 
#   mutate(cover.spp = cano.sppsum.m2/16*100) %>% 
#   mutate(cover.spp = case_when(cover.spp > 100 ~ 100,
#                                TRUE ~ cover.spp)) %>% 
#   ungroup()

### calculate the sum and % cover for all willows combined

# canopy.all.spp %>%
#   filter(spp_group == "willow") %>% 
#   group_by(timeClass, SITE_ID, SITE_TYPE, LOCATION, FENCED, BURNED) %>% 
#   dplyr::summarise(prop.cov.sum = sum(cover.spp), prop.cov.mean = mean(cover.spp))
#   dplyr::summarise(cano.sum.m2 = sum(cano.area.m2), cano.mean.m2 = mean(cano.area.m2)) %>% 
#   mutate(cover.allwillow.mn = cano.mean.m2/16*100) %>% 
#   mutate(cover.allwillow = cano.sum.m2/16*100) %>% 
#   mutate(cover.allwillow = case_when(cover.allwillow > 100 ~ 100,
#                                TRUE ~ cover.allwillow)) %>% 
#   ungroup() %>% 
#   mutate(zCond = case_when(BURNED == "Burned" & FENCED == "Unfenced" ~ "BG",
#                            BURNED == "Burned" & FENCED == "Fenced" ~ "BF",
#                            BURNED == "Unburned" & FENCED == "Unfenced" ~ "UG",
#                            BURNED == "Unburned" & FENCED == "Fenced" ~ "UF"
#                            )) %>%
#   mutate(zCond2 = paste0(SITE_TYPE,"-",zCond)) ## add the 'condition' classes used by Zeignfuss etal in their 2015 report
  
```

```{r}

canopy.all.willow.sum <- canopy.all.spp %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  # mutate(BURNED = case_when(timeClass == "BL" ~ "Unburned",
  #                           TRUE ~ BURNED)) %>% ## Changing bl burned to unburned
  # mutate(BURNED = case_when(timeClass == "2013" & BURNED == "Burned" ~ "Burned",
  #                           timeClass == "BL" & BURNED == "Unburned" & timeClass == "2013" & BURNED == "Burned" ~ "Burned",
  #                           TRUE ~ BURNED)) %>% ## Changing bl unburned to burned
  group_by(timeClass, SITE_ID, SITE_TYPE, LOCATION, FENCED, BURNED) %>%
  dplyr::summarise(cano.sum.m2 = sum(cano.area.m2), cano.mean.m2 = mean(cano.area.m2, na.rm=TRUE)) %>%
  mutate(cover.allwillow = cano.sum.m2/16*100) %>%
  mutate(cover.allwillow = case_when(cover.allwillow > 100 ~ 100,
                               TRUE ~ cover.allwillow)) %>%
  ungroup() %>%
  mutate(zCond = case_when(BURNED == "Burned" & FENCED == "Unfenced" ~ "BG",
                           BURNED == "Burned" & FENCED == "Fenced" ~ "BF",
                           BURNED == "Unburned" & FENCED == "Unfenced" ~ "UG",
                           BURNED == "Unburned" & FENCED == "Fenced" ~ "UF"
                           )) %>%
  mutate(zCond2 = paste0(SITE_TYPE,"-",zCond)) ## add the 'condition' classes used by Zeignfuss etal in their 2015 report

```

```{r, echo=FALSE, eval=FALSE}
## quick checks before exporting
canopy.all.willow.sum %>% 
  tabyl(timeClass,zCond)

canopy.willow.allspp %>% 
  filter(timeClass == "2013") %>% 
  tabyl(zCond2)

```

```{r}
## write to csv
# canopy.all.willow.sum %>%
#   write_csv("./output/exported_data/willow_cover_20200725.csv")


# lu.removed.plot
# remove all the removed plots identified in the site info tab if raw files
canopy.all.willow.sum <- anti_join(canopy.all.willow.sum, lu.removed.plot, by="SITE_ID")

canopy.all.willow.sum %>%
  write_csv("./output/exported_data/willow_macroplot_cover_BLto2018.csv") # re-exported 6/28/21

```

```{r, echo = FALSE, eval=FALSE}
canopy.all.willow.sum.sf <- left_join(canopy.all.willow.sum, site.id.coords) %>%
  filter(!is.na(UTM_E_NAD83)) # %>% 
  # pivot_wider(values_from = cover.allwillow, names_from = timeClass, names_glue = "{.value}_{timeClass}")
  
canopy.all.willow.sum.sf <- canopy.all.willow.sum.sf %>% 
  st_as_sf(coords = c("UTM_E_NAD83", "UTM_N_NAD83"), crs = 26913) 

wide2join.cov.willow <- left_join(canopy.all.willow.sum, site.id.coords) %>%
  # filter(!is.na(UTM_E_NAD83)) %>% 
  pivot_wider(values_from = cover.allwillow, names_from = timeClass, names_glue = "{.value}_{timeClass}")

```

**Combined WC and WNC**

```{r}
####  All willow species
#### Winter range weighted average
## excluding WK, WC and WNC; non 5 yr sampling

canopy.all.willow.sum <- canopy.all.willow.sum %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  mutate(timeClass = fct_drop(timeClass))

canopy.all.willow.sum %>% 
  tabyl(timeClass)

## 
canopy.all.willow.sum %>% 
  mutate(cover.allwillow = case_when(is.na(cover.allwillow) ~ 0,
                                     TRUE ~ cover.allwillow)) %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%   
  group_by(SITE_TYPE, LOCATION, timeClass) %>% 
  summarise(n.loc.tc = n(), mean.cov = mean(cover.allwillow, na.rm = TRUE), sd.cov = sd(cover.allwillow, na.rm = TRUE)) %>%
  # summarise(n.loc.tc = n(), mean.cov = mean(cover.allwillow, na.rm = TRUE, mean.cov.mn = mean(cover.allwillow.mn, na.rm = TRUE))) %>% 
  ungroup() %>% 
  group_by(SITE_TYPE, timeClass) %>% 
  mutate(n.tc = sum(n.loc.tc)) %>% 
  ungroup()

canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  group_by(SITE_TYPE, timeClass) %>% 
  summarise(mean.will.cov = mean(cover.allwillow, na.rm = TRUE), 
            sd.will.cov  = sd(cover.allwillow, na.rm = TRUE), 
            med.will.cov = median(cover.allwillow, na.rm = TRUE)) %>% 
  mutate(across(where(is.double), round, 2)) %>% 
  gt()

canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  group_by(SITE_TYPE, timeClass) %>% 
  summarise(mean.will.cov = mean(cover.allwillow, na.rm = TRUE), sd.will.cov  = sd(cover.allwillow, na.rm = TRUE), med.will.cov = median(cover.allwillow, na.rm = TRUE), n.obs = n()) %>% 
  mutate(across(where(is.double), round, 2)) %>% 
  gt()

```


```{r}
# purrr plots
tmp1 <- canopy.all.willow.sum  %>% 
  group_nest(SITE_TYPE) %>% 
  mutate(plots = map2(.y = SITE_TYPE, .x = data, ~{ggplot(data = .x) +
                              geom_boxplot(aes(y = cover.allwillow, x = timeClass), fill="Gray80") +
                              geom_hline(aes(yintercept=31), color="red", lty="dashed") +
                              # ggtitle(paste0("Willow cover, site: ", .y)) +
                              labs(title = paste0("Site type: ", .y), x = "", y = "Willow cover (%)") +
                              theme_minimal()}))

tmp1 %>% 
  pull(plots)

```



```{r}
# purrr plots
canopy.all.willow.sum  %>% 
  group_nest(LOCATION) %>% 
  mutate(plots = map2(.y = LOCATION, .x = data, ~{ggplot(data = .x) +
                              geom_boxplot(aes(y = cover.allwillow, x = timeClass), fill="Gray80") +
                              # ggtitle(paste0("Willow cover, site: ", .y)) +
                              labs(title = paste0("Location: ", .y), x = "", y = "Willow cover (%)") +
                              theme_minimal()})) %>% 
  pull(plots)
```

```{r}
# purrr plots
tmp2 <- canopy.all.willow.sum  %>% 
  group_nest(LOCATION) %>%
  mutate(tbls = map(.x = data, .f = datatable)) %>% 
  mutate(plots = map2(.y = LOCATION, .x = data, ~{ggplot(data = .x) +
                              geom_boxplot(aes(y = cover.allwillow, x = timeClass), fill="Gray80") +
                              # ggtitle(paste0("Willow cover, site: ", .y)) +
                              geom_hline(aes(yintercept = 31), color = "red", lty = "dashed", size = 1) +
      labs(title = paste0("Location: ", .y), x = "", y = "Willow cover (%)") +
                              theme_minimal()}))
tmp2 %>% 
  pull(plots)


```

```{r, eval=FALSE}
tmp2 %>% 
  pull(tbls)

```


```{r}
wc.cov.pl1 <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  ggplot(aes(timeClass,cover.allwillow)) +
  geom_boxplot(fill = "grey60") +
  geom_hline(aes(yintercept = 31), color = "red", lty = "dashed", size = 1) +
  labs(x = "", y = "% cover", caption = "All elk range - Combined WC and WNC plots") +
  theme_minimal()

# wc.cov.pl1
# ggsave("./output/figures_202107/All_winter_range_willow_cov_boxplot.png", width = 3.75, height = 3.75)

wc.cov.pl2 <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  ggplot(aes(timeClass,cover.allwillow)) +
  geom_boxplot(aes(fill = SITE_TYPE)) +
  scale_fill_manual(values = c("grey90", "grey40")) +
  geom_hline(aes(yintercept = 31), color = "red", lty = "dashed", size = 1) +
  labs(fill = "", x = "", y = "% cover", caption = "All elk range - Combined WC and WNC plots") +
  theme_minimal()
# wc.cov.pl2
# ggsave("./output/figures_202107/All_winter_range_willow_cov_boxplot_b.png", width = 4.5, height = 3.75)

cowplot::plot_grid(wc.cov.pl1, wc.cov.pl2, labels = "AUTO",rel_widths = c(1, 2))

ggsave("./output/figures_202107/All_winter_range_willow_cov_boxplot_2panel_revised.png", width = 6.5, height = 3.75)
```

```{r}
##### summary tables for cover
# pooled across range types, fenced, burned
## Time class FENCED SITE_TYPE
summary.TC <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass) %>% 
  summarytools::descr(var = cover.allwillow,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass) %>% 
  gt() %>% 
  tab_header(title = "Willow cover - All species, range types, and fenced/burned status")

summary.TC 

```

```{r}
## Time class FENCED SITE_TYPE
summary.TC.site_type <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, SITE_TYPE) %>% 
  summarytools::descr(var = cover.allwillow,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, 'Site type' = SITE_TYPE) %>% 
  gt() %>% 
  tab_header(title = "Willow cover - All species and fenced status")

summary.TC.site_type 

# summary.TC.site_type %>% 
#   gt::gtsave(file = "./output/tables/summary_cover_all_willow_TCxSITE_Type.rtf")

```

```{r}
## Time class FENCED SITE_TYPE
summary.TC.fenced.site_type <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass,FENCED, SITE_TYPE) %>% 
  summarytools::descr(var = cover.allwillow,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, Fenced = FENCED, 'Site type' = SITE_TYPE) %>% 
  gt() %>% 
  tab_header(title = "Willow cover - All species")

summary.TC.fenced.site_type 

# summary.TC.fenced.site_type %>%
#   gt::gtsave(file = "./output/tables/summary_cover_all_willow.rtf")
  
```

```{r}
## fenced and burned, all range type
##### summary tables for cover
# pooled across range types, fenced, burned
## Time class FENCED SITE_TYPE
summary.TC.burned.fenced <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, FENCED, BURNED) %>% 
  summarytools::descr(var = cover.allwillow,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, Fenced = FENCED, Burned = BURNED, n = n.valid) %>% 
  gt() %>% 
  tab_header(title = "Willow cover - All species, range types, and fenced/burned status")

summary.TC.burned.fenced 

# summary.TC.burned.fenced %>%
#   gt::gtsave(file = "./output/tables/summary_cover_allwillow_allRT_fenced_burned.rtf")


# canopy.all.willow.sum %>% 
#   filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
#   filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
#   mutate(timeClass = fct_drop(timeClass)) %>% 
#   mutate(timeClass = fct_rev(timeClass)) %>%
#   group_by(timeClass, BURNED) %>% 
#   summarytools::descr(var = cover.allwillow,
#                       stats = "common") %>% 
#   tb() %>% 
#   mutate_if(is.numeric, round,1) %>% 
#   select(-c(variable,pct.valid)) %>% 
#   # datatable()
#   datatable(.,extensions = 'Buttons', 
#             options = list(scrollX=TRUE, lengthMenu = c(5,10,15),
#                            paging = TRUE, searching = TRUE,
#                            fixedColumns = TRUE, autoWidth = TRUE,
#                            ordering = TRUE, dom = 'tB',
#                            buttons = c('copy', 'csv')))



```

```{r}
## burned and fenced: separated by range type 
##### summary tables for cover
# pooled across range types, fenced, burned
## Time class FENCED SITE_TYPE
summary.TC.burned.fenced.rangetype <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, SITE_TYPE, FENCED, BURNED) %>% 
  summarytools::descr(var = cover.allwillow,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, Fenced = FENCED, Burned = BURNED, n = n.valid) %>% 
  gt() %>% 
  tab_header(title = "Willow cover - All species, grouped by range type, fencing and burning")

summary.TC.burned.fenced.rangetype

# summary.TC.burned.fenced %>%
#   gt::gtsave(file = "./output/tables/summary_cover_allwillow_allRT_fenced_burned.rtf")

# data table
canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, SITE_TYPE, FENCED, BURNED) %>% 
  summarytools::descr(var = cover.allwillow,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>%
  datatable()


```

```{r, eval=FALSE}
## gtsummary
canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  # mutate(timeClass = as.character(timeClass)) %>%
  select(timeClass, SITE_TYPE, FENCED, cover.allwillow) %>% 
  gtsummary::tbl_summary(
    by = timeClass,
    include = c(timeClass,cover.allwillow)) %>% 
  add_p()

canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  # mutate(timeClass = fct_rev(timeClass)) %>% 
  mutate(timeClass = as.character(timeClass)) %>%
  select(timeClass, SITE_TYPE, FENCED, cover.allwillow) %>%
  gtsummary::tbl_summary(
    by = timeClass,
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} / {N} ({p}%)"))

canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  # mutate(timeClass = fct_rev(timeClass)) %>% 
  mutate(timeClass = as.character(timeClass)) %>%
  select(timeClass, SITE_TYPE, FENCED, cover.allwillow) %>%
  gtsummary::tbl_summary(
    by = timeClass,
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} / {N} ({p}%)"))

```

```{r}
#### # check te lz weighting

## exluding WK
canopy.all.willow.sum %>% 
  mutate(cover.allwillow = case_when(is.na(cover.allwillow) ~ 0,
                                     TRUE ~ cover.allwillow)) %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%   group_by(BURNED, FENCED, timeClass) %>% 
  summarise(n.cond.tc = n(), mean.cov = mean(cover.allwillow, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(timeClass) %>% 
  mutate(n.tc = sum(n.cond.tc)) %>% 
  ungroup() %>% 
  mutate(weight = n.cond.tc/n.tc) %>% 
  mutate(mean.cov.wt = weight*mean.cov) %>% 
  datatable()

```

**WC**

```{r}
canopy.all.willow.sum %>% 
  group_by(timeClass, SITE_TYPE) %>% 
  descr(cover.allwillow) %>% 
  summarytools::tb() %>% 
  datatable(filter = "top")

## Filter to just 5 yr resample and WC
canopy.all.willow.sum %>% 
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  filter(SITE_TYPE == "WC") %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  ggplot(aes(timeClass, cover.allwillow)) +
  geom_boxplot(fill = "grey60") +
  geom_hline(aes(yintercept = 31), color = "red", lty = "dashed", size = 1) +
  facet_wrap(~FENCED) +
  labs(caption = "WC all willows combined macroplot cover", y = "% cover", x = "") +
  theme_minimal()

ggsave("./output/figures_202107/cover_wc_boxplot_TCxF_dfc.png", width = 6.25, height = 3.75, dpi =300)

## create summary table
canopy.all.willow.sum %>% 
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  filter(SITE_TYPE == "WC") %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  group_by(timeClass, SITE_TYPE, FENCED) %>% 
  summarytools::descr(cover.allwillow) %>% 
  summarytools::tb() %>%
  mutate(across(where(is.numeric),~round(.x, 1))) %>% 
  select(1,3,5:13, n.valid) %>% 
  gt()

```

```{r}
## WNC
## Filter to just 5 yr resample and WNC
canopy.all.willow.sum %>% 
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  filter(SITE_TYPE == "WNC") %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  ggplot(aes(timeClass, cover.allwillow)) +
  geom_boxplot(fill = "grey60") +
  geom_hline(aes(yintercept = 31), color = "red", lty = "dashed", size = 1) +
  # facet_wrap(~FENCED) +
  labs(caption = "WNC all willows combined macroplot cover", y = "% cover", x = "") +
  theme_minimal()

# ggsave("./output/figures_202107/cover_wnc_boxplot01_revised.png", width = 3.75, height = 3.75, dpi=300)
# ggsave("./output/figures_202107/cover_wnc_boxplot01.pdf", width = 3.75, height = 3.75)

## create summary table
canopy.all.willow.sum %>% 
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  filter(SITE_TYPE == "WNC") %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  group_by(timeClass, SITE_TYPE, FENCED) %>% 
  summarytools::descr(cover.allwillow) %>% 
  summarytools::tb() %>% 
  mutate(across(where(is.numeric),~round(.x, 1))) %>%
  select(1,3,5:13, n.valid) %>% 
  gt() %>% 
  tab_header(title = "Non-core range willow cover")

```

```{r}
# join cover for spatial export
canopy.all.willow.sum.wide <- canopy.all.willow.sum %>% 
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  clean_names() %>% 
  select(time_class, site_id, site_type, location, cover_allwillow) %>% 
  pivot_wider(names_from = time_class, names_glue = "cover{time_class}",values_from = cover_allwillow)


cov.willow.sf <- left_join(clean_names(site.info.clean.sf), canopy.all.willow.sum.wide, by = "site_id") %>%
  filter(p_type == "willow")

# cov.willow.sf %>%
#   st_write("./output/exported_data/spatial/willow_cover_20200907.shp")

```

```{r, echo=FALSE, eval=FALSE}
# **2018 cover map**
cov.willow.sf %>%
  filter(!is.na(cover2018)) %>% 
  mapview(zcol= "cover2018")
```

#### Management thresholds

**Cover thresholds: winter range, TC**

```{r}
####  All willow species
canopy.all.willow.sum %>%
  clean_names() %>% 
  filter(!is.na(cover_allwillow)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  filter(site_type != "WK") %>%
  mutate(thresh = case_when(cover_allwillow >=31 ~ "above",
                               cover_allwillow <31 ~ "below")) %>%  
  tabyl(time_class, thresh) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC - cover threshold of 31%")

```

**Cover thresholds: winter range, TC x Fenced**

```{r}
canopy.all.willow.sum %>%
  clean_names() %>% 
  filter(!is.na(cover_allwillow)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # tabyl(species_code)
  filter(site_type != "WK") %>%
  mutate(thresh = case_when(cover_allwillow >=31 ~ "above",
                               cover_allwillow <31 ~ "below")) %>%
  group_by(time_class, thresh, fenced) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = thresh, values_from = n) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC - cover threshold of 31%")
```

**Cover thresholds: winter range, TC x burned**

```{r}
canopy.all.willow.sum %>%
  clean_names() %>% 
  filter(!is.na(cover_allwillow)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # tabyl(species_code)
  filter(site_type != "WK") %>%
  mutate(thresh = case_when(cover_allwillow >=31 ~ "above",
                               cover_allwillow <31 ~ "below")) %>%
  group_by(time_class, thresh, burned) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = thresh, values_from = n) %>%
  replace_na(list(above = 0, below = 0)) %>%
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC - cover threshold of 31%")

```

**Cover thresholds: winter range, TC x fenced x burned**

```{r}
canopy.all.willow.sum %>%
  clean_names() %>% 
  filter(!is.na(cover_allwillow)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # tabyl(species_code)
  filter(site_type != "WK") %>%
  mutate(thresh = case_when(cover_allwillow >=31 ~ "above",
                               cover_allwillow <31 ~ "below")) %>%
  group_by(time_class, thresh, fenced, burned) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = thresh, values_from = n) %>% 
  replace_na(list(above = 0, below = 0)) %>%
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC - cover threshold of 31%")
```


```{r}
canopy.all.willow.sum %>%
  clean_names() %>% 
  filter(!is.na(cover_allwillow)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  mutate(time_class = fct_rev(time_class)) %>%
  filter(site_type != "WK") %>%
  mutate(thresh = case_when(cover_allwillow >=31 ~ "above",
                               cover_allwillow <31 ~ "below")) %>%
  group_by(time_class, thresh, fenced, burned) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = thresh, values_from = n) %>% 
  # replace_na(list(above = 0, below = 0)) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  ggplot(aes(x = fenced, y = burned)) +
  geom_tile(aes(fill = perc.above.thresh), color = 'grey80', alpha=0.85) +
  # scale_fill_viridis_b() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  geom_text(aes(label = round(perc.above.thresh,1)), color = "grey80", alpha = 1) +
  theme_minimal() +
  labs(x = "", y = "", fill = "% above \n threshold") +
  facet_grid(~time_class)

ggsave("./output/figures_202107/WCWNC_willow_percentPlotCovThresh_dfc.png", width = 5.5, height = 2.25)
```

```{r}
canopy.all.willow.sum %>%
  clean_names() %>% 
  filter(!is.na(cover_allwillow)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  mutate(time_class = fct_rev(time_class)) %>%
  filter(site_type != "WK") %>%
  mutate(thresh = case_when(cover_allwillow >=31 ~ "above",
                               cover_allwillow <31 ~ "below")) %>%
  group_by(time_class, site_type, thresh, fenced, burned) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = thresh, values_from = n) %>% 
  # replace_na(list(above = 0, below = 0)) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  ggplot(aes(x = fenced, y = burned)) +
  geom_tile(aes(fill = perc.above.thresh), color = 'grey80', alpha=0.85) +
  # scale_fill_viridis_b() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  geom_text(aes(label = round(perc.above.thresh,1)), color = "black", alpha = .85) +
  theme_minimal() +
  labs(x = "", y = "", fill = "% above \n threshold") +
  facet_grid(site_type~time_class)

ggsave("./output/figures_202107/WCxWNC_willow_percentPlotCovThresh_dfc.png", width = 5.5, height = 2.25)

```

#### Range-wide weighted summaries

```{r}
## add condition classes per Zeigenfuss SAS code

## code excerpt
	# group=_name_;
	# if group='nonwillo' then delete;
	# if burn='Y' and fence='N'  then cond='BG';
	# if burn='Y' and fence='Y'  then cond='BF';
	# if burn='N' and fence='N' then cond='UG';
	# if burn='N' and fence='Y'  then cond='UF';

## range wide estimates
# weights from 2013
	# if year=2013 and cond='BF' then areawt=0.085;
	# if year=2013 and cond='BG' then areawt=0.45;
	# if year=2013 and cond='UG' then areawt=0.219;
	# if year=2013 and cond='UF' then areawt=0.117;
	# if site_type='WNC' then areawt=0.129;

## I can not find in the SAS code where the areawt values are calculated; just applying those in SAS code

## table 8 Zeigenfuss 2015. timeClass x fenced x site type
lz.wt.willow.tb8 <- tribble(
  ~timeClass, ~site_typeXfenced, ~areawt, ~SITE_TYPE,
  "2013", "WC-Fenced", 0.202, "WC", 
  "2013", "WC-Unfenced", 0.669, "WC",
  "2013", "WNC-Unfenced", 0.129, "WNC",
  "2018", "WC-Fenced", 0.202, "WC", 
  "2018", "WC-Unfenced", 0.669, "WC",
  "2018", "WNC-Unfenced", 0.129, "WNC",
  # "BL", "WC-Fenced", 0.871, "WC",
  "BL", "WC-Fenced", 0.202, "WC",
  "BL", "WC-Unfenced", 0.669, "WC",
  "BL", "WNC-Unfenced", 0.129, "WNC"
)

## Summarized to WC and WNC by timeClass
lz.wt.willow.tb8_sitetype <- lz.wt.willow.tb8 %>% 
  group_by(timeClass,SITE_TYPE) %>% 
  summarise(areawt = sum(areawt)) %>% 
  ungroup()

# lz.wt.willow.tb8_sitetype %>% 
#   gt()

## table 9 in Zeigenfuss 2015. Burning, fencing, site type
# create a tibble from the area wts in the SAS code above
lz.wt.willow.tbl9 <- tribble(
  ~timeClass, ~zCond, ~areawt_lz, ~SITE_TYPE,
  "2013", "BF", 0.085, "WC", 
  "2013", "BG", 0.45, "WC",
  "2013", "UG", 0.219, "WC",
  "2013", "UF", 0.117, "WC",
  "2013", "UG", 0.129, "WNC",
  "2018", "BF", 0.085, "WC", 
  "2018", "BG", 0.45, "WC",
  "2018", "UG", 0.219, "WC",
  "2018", "UF", 0.117, "WC",
  "2018", "UG", 0.129, "WNC",
  "BL", "UG", 0.871,"WC",
  "BL", "UG", 0.129,"WNC"
)

lz.wt.willow.tbl9 <- lz.wt.willow.tbl9 %>% 
  mutate(zCond2 = paste0(SITE_TYPE,"-",zCond)) %>% 
  mutate(zCond2_tc = paste0(SITE_TYPE,"-",zCond,"-",timeClass)) %>% 
  select(zCond2_tc,areawt_lz)

lz.wt.willow.tbl9 %>%
  rename(Category=zCond2_tc, Weight = areawt_lz) %>% 
  gt() %>% 
  tab_header(title = "Area weights used in Zeigenfuss 2015 Table 9")

```

```{r, echo=FALSE, eval=FALSE}
# not clear how area wts are calculated in original SAS code
# the following is based on proportional plot count, but they don't match the weights used in Zeigenfuss 2105 SAS code, so these are not used. They're retained for reference.
## calculate the weights by time class, SITE_TYPE and zCond
wts <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE != "WK") %>% 
  group_by(timeClass, SITE_TYPE, zCond) %>% 
  summarise(n_TCxSTxZcond = n()) %>% 
  ungroup() %>%
  group_by(timeClass) %>%
  mutate(n_TC = sum(n_TCxSTxZcond)) %>%
  ungroup() %>% 
  mutate(wt = round(n_TCxSTxZcond/n_TC,3))

wts %>%
  group_by(timeClass,SITE_TYPE, zCond) %>%
  summarise(sum.wt = sum(wt)) %>% 
  ungroup() %>% 
  group_by(timeClass,SITE_TYPE) %>% 
  mutate(sum = sum(sum.wt)) %>% 
  # tabyl(timeClass, SITE_TYPE)
  gt(groupname_col = "timeClass")

## calculate the weights by time class and zCond
wts.2 <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE != "WK") %>%
  group_by(timeClass, zCond) %>% 
  summarise(n_TCxSTxZcond = n()) %>% 
  ungroup() %>%
  group_by(timeClass) %>%
  mutate(n_TC = sum(n_TCxSTxZcond)) %>%
  ungroup() %>% 
  mutate(wt = round(n_TCxSTxZcond/n_TC,3))

wts.2 %>%
  mutate(wt = wt*100) %>% 
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  gt() %>% 
  tab_header(title="Calculated weights")

wts.2 %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, wt)) +
  geom_col(aes(fill = zCond)) +
  geom_text(aes(label = wt, group = zCond),
                  position = position_stack(vjust = .5),
            color='white',
            fontface="bold") +
  scale_fill_grey() +
  theme_minimal() +
  scale_y_continuous(labels=scales::percent) +
  labs(x="", y="weight", title="Calculated Weights - Willow Plots", fill="")

# these aren't the weights in the 2015 report. Will just use the values from the 2015 report  

```

```{r}
#### Table 8 in Zeigenfuss 2015 - update for willow cover variable 
# unweighted table 8. Inludes burned sites
tbl8.cov <- canopy.all.willow.sum %>%
  # filter(BURNED == "Unburned") %>% 
  filter(SITE_TYPE != "WK") %>%
  mutate(fenceClass_tc = paste0(SITE_TYPE,"-",FENCED,"-",timeClass)) %>%
  mutate(site_typeXfenced = paste0(SITE_TYPE,"-", FENCED)) %>% 
  # mutate(fenceClass_tc = paste0(SITE_TYPE,"-",FENCED,"-",timeClass)) %>%
  group_by(timeClass, SITE_TYPE, FENCED, site_typeXfenced) %>%
  summarise(n = n(), mean.cov = mean(cover.allwillow, na.rm=TRUE), sd.cov = sd(cover.allwillow, na.rm=TRUE)) %>%
  ungroup() %>% 
  mutate(se = mean.cov/sqrt(n)) %>% 
  mutate(across(where(is.numeric),round,1)) %>%
  arrange(timeClass)

##
tbl8.cov <- left_join(tbl8.cov, lz.wt.willow.tb8) %>% 
  mutate(mean.cov.wt = areawt*mean.cov, se.cov.wt = areawt*se) 

## RANGE wide estimate tbl8.cov
tbl8.cov.rangewide <- tbl8.cov %>% 
  group_by(timeClass) %>% 
  summarise(mean.cov = sum(mean.cov.wt, na.rm=TRUE), se = sum(se.cov.wt, na.rm=TRUE)) %>%
  mutate(across(where(is.numeric),round,0)) %>% 
  mutate(mean_se = paste0(mean.cov,"(+/-",se,")")) %>% 
  mutate(site_typeXfenced = "Entire winter range (weighted avg)")

### table 8 
tbl8.cov %>% 
  mutate(mean_se = paste0(mean.cov,"(+/-",se,")")) %>% 
  bind_rows(.,tbl8.cov.rangewide) %>% 
  select(timeClass, SITE_TYPE, FENCED, site_typeXfenced, mean_se) %>% 
  pivot_wider(names_from = timeClass,
              # names_glue = "{timeClass}_test_{FENCED}",
              values_from = mean_se) %>%
  select(-c(FENCED, SITE_TYPE)) %>% 
  relocate('Winter range zone' = site_typeXfenced, "Baseline" = "BL",'2013','2018') %>% 
  gt() %>% 
  tab_header(title = "Willow cover (percent)")

```

```{r, eval=FALSE, echo=FALSE}
## want to check against plot list for removed plots
canopy.all.willow.sum %>%
  filter(SITE_TYPE != "WK") %>% 
  distinct(SITE_ID)
```

```{r}
### range wide (bottomline of table)
lz.wt.willow.tb8_sitetype

# unweighted table 9
wt.cov.rangewide <- canopy.all.willow.sum %>%
  filter(SITE_TYPE != "WK") %>%
  group_by(timeClass, SITE_TYPE) %>%
  summarise(n = n(), mean.cov = mean(cover.allwillow, na.rm=TRUE), sd.cov = sd(cover.allwillow, na.rm=TRUE)) %>%
  ungroup() %>% 
  mutate(se.cov = mean.cov/sqrt(n))

wt.cov.rangewide <- wt.cov.rangewide %>% 
  left_join(.,lz.wt.willow.tb8_sitetype) %>% 
  mutate(mean.cov.wt = areawt*mean.cov, se.cov.wt = areawt*se.cov) %>% 
  group_by(timeClass) %>% 
  summarise(mean.cov.wt = sum(mean.cov.wt),se.cov.wt = sum(se.cov.wt)) %>% 
  ungroup() %>%
  mutate(timeClass= as_factor(timeClass)) %>% 
  mutate(timeClass = fct_relevel(timeClass, "BL", before="2013")) %>% 
  arrange(timeClass)

wt.cov.rangewide %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  gt() %>% 
  tab_header(title="Entire winter range (weighted average")
# comp to bl:20(2); 2013:24(3); na in zeigenfuss 2015
```

```{r}
# unweighted table 9
wt.cov <- canopy.all.willow.sum %>%
  filter(SITE_TYPE != "WK") %>%
  mutate(zCond2_tc = paste0(SITE_TYPE,"-",zCond,"-",timeClass)) %>% 
  group_by(timeClass, SITE_TYPE, BURNED, FENCED, zCond2,zCond2_tc) %>%
  summarise(n = n(), mean.cov = mean(cover.allwillow, na.rm=TRUE), sd.cov = sd(cover.allwillow, na.rm=TRUE)) %>%
  ungroup() %>% 
  mutate(se = mean.cov/sqrt(n)) %>% 
  arrange(timeClass, zCond2)
```

```{r}
### zcond2
# join in weights from 2015 SAS code
wt.cov.zcond2 <- left_join(wt.cov, lz.wt.willow.tbl9, by="zCond2_tc") %>% 
  mutate(mean.cov.wt = areawt_lz*mean.cov, se.wt = areawt_lz*se)

## check sum of weights = 1
temp1 <- wt.cov.zcond2 %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  group_by(timeClass,SITE_TYPE) %>% 
  summarise(sum.wt.cov = sum(mean.cov.wt, na.rm=TRUE), sum.wt.wt = sum(areawt_lz, na.rm=TRUE)) %>% 
  ungroup() 

temp1

temp1 %>% 
  group_by(timeClass) %>% 
  summarise(wt.cov = sum((sum.wt.cov*sum.wt.wt)))

```

```{r, eval=FALSE}
wt.cov.zcond2 %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  select(timeClass, zCond2, mean.wt) %>% 
  pivot_wider(names_from = timeClass, values_from = c(mean.wt)) %>% 
  clean_names() %>% 
  gt()

wt.cov.zcond2 %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  select(timeClass, zCond2, mean, mean.wt) %>% 
  pivot_wider(names_from = timeClass, values_from = c(mean.wt)) %>% 
  clean_names() %>% 
  gt()

wt.cov.zcond2 %>% 
  arrange(zCond2) %>% 
  datatable()
```

```{r}
canopy.all.willow.sum %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  filter(SITE_TYPE != "WK") %>% 
  group_by(timeClass)

```

```{r}
## transform
## 
# add transform following method in Zeigenfuss
# 
canopy.all.willow.sum <- canopy.all.willow.sum %>% 
  mutate(cover.transformed = cover.allwillow/100) %>%
  mutate(cover.transformed = case_when(cover.transformed == 1 ~ 1-0.0883573,
                                       cover.transformed == 0 ~ 0.0883573,
                                       TRUE ~ cover.transformed)) %>% 
  mutate(cover.transformed = log(cover.transformed/(1-cover.transformed)))

```

### Height

#### All shrubs species

**Summary statistics: WC and WNC plots**
```{r}
# All shrub species
# Combined Winter Range combined (-WK)
ht.WCWNC.allShrub.plotsummary <- csv.all.lc.mcro.df %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(SITE_TYPE == "WC" |SITE_TYPE == "WNC") %>% 
  select(timeClass, SITE_ID, PLANT_HT_CM) %>% 
  group_by(timeClass,SITE_ID) %>% 
  summarise(PLANT_HT_CM_mean = mean(PLANT_HT_CM, na.rm=TRUE), PLANT_HT_CM_max = max(PLANT_HT_CM),PLANT_HT_CM_median = median(PLANT_HT_CM)) %>%
  ungroup()

## median
ht.WCWNC.allShrub.plotsummary %>% 
  group_by(timeClass) %>% 
  summarytools::descr(var = PLANT_HT_CM_median, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, 'Time class' = timeClass) %>%   
  gt() %>% 
  tab_header(title = "Shrub height (macroplot median, all shrub species)") %>% 
  fmt_number(
    columns = 2:11,
    decimals = 1,
    suffixing = TRUE
  ) # %>% gtsave("./output/tables/Mcplot_allshrubHT_median_WCandWNC_TC.rtf")

## macroplot mean -- all shrubs
ht.WCWNC.allShrub.plotsummary %>% 
  group_by(timeClass) %>% 
  summarytools::descr(var = PLANT_HT_CM_mean, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, 'Time class' = timeClass) %>%   
  gt() %>% 
  tab_header(title = "Shrub height (macroplot mean, all shrub species)") %>% 
  fmt_number(
    columns = 2:11,
    decimals = 1,
    suffixing = TRUE
  )  # %>% gtsave("./output/tables/Mcplot_allshrubHT_mean_WCandWNC_TC.rtf")

## macroplot max ht -- all shrubs
ht.WCWNC.allShrub.plotsummary %>% 
  group_by(timeClass) %>% 
  summarytools::descr(var = PLANT_HT_CM_max, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, 'Time class' = timeClass) %>%   
  gt() %>% 
  tab_header(title = "Shrub height (macroplot max, all shrub species)") %>% 
  fmt_number(
    columns = 2:11,
    decimals = 1,
    suffixing = TRUE
  ) #  %>% gtsave("./output/tables/Mcplot_allshrubHT_max_WCandWNC_TC.rtf")


```


```{r}
## add in fencing
# Combined Winter Range combined (-WK)
ht.WCWNC.allShrub.fence.plotsummary <- csv.all.lc.mcro.df %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(SITE_TYPE == "WC" |SITE_TYPE == "WNC") %>% 
  select(timeClass, SITE_ID, FENCED, PLANT_HT_CM) %>% 
  group_by(timeClass,SITE_ID, FENCED) %>% 
  summarise(PLANT_HT_CM_mean = mean(PLANT_HT_CM, na.rm=TRUE), PLANT_HT_CM_max = max(PLANT_HT_CM),PLANT_HT_CM_median = median(PLANT_HT_CM)) %>%
  ungroup()

```

```{r}
ht.WCWNC.allShrub.fence.plotsummary.tidy <- ht.WCWNC.allShrub.fence.plotsummary %>%
  pivot_longer(
    cols = starts_with("PLANT"),
    names_to = "htvar",
    values_to = "value"
  )

ht.WCWNC.allShrub.fence.plotsummary.tidy %>% 
  mutate(htvar = case_when(htvar == "PLANT_HT_CM_max" ~ "max",
                           htvar == "PLANT_HT_CM_mean" ~ "mean",
                           htvar == "PLANT_HT_CM_median" ~ "median"
                           )) %>% 
  # ggplot(aes(htvar, value)) +
  ggplot(aes(value)) +
  geom_density(aes(color=htvar, lty = htvar), size=1) +
  scale_colour_brewer(palette = "Dark2") +
  # geom_boxplot() +
  # facet_wrap(~FENCED) +
  facet_grid(FENCED~timeClass) +
  theme_minimal() +
  coord_flip() +
  labs(title = "Comparison of shrub height plot level metrics", subtitle="Combined WC & WNC plots, all shrub species", x = "Willow height (cm)", color="",lty = "")

# Mean Combined Winter Range (-WK): Fenced
ht.WCWNC.allShrub.fence.plotsummary %>% 
  group_by(timeClass, FENCED) %>% 
  summarytools::descr(var = PLANT_HT_CM_mean, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, 'Time class' = timeClass) %>%   
  mutate(across(where(is.numeric),round,1)) %>% 
  gt() %>% 
  tab_header(title = "Shrub height (macroplot mean, all shrub species)") #  %>% gtsave("./output/tables/Mcplot_allshrubHT_fencing_mean_WCandWNC_TC.rtf")

# Mean all winter range combined (-WK): Fenced
ht.WCWNC.allShrub.fence.plotsummary %>% 
  group_by(timeClass, FENCED) %>% 
  summarytools::descr(var = PLANT_HT_CM_max, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, 'Time class' = timeClass) %>%   
  mutate(across(where(is.numeric),round,1)) %>% 
  gt() %>% 
  tab_header(title = "Shrub height (macroplot max, all shrub species)")

```

#### All willows
```{r}
# all winter range combined (-WK)
## just willow species

## calculate the mean, max, and median willow height by plot id
## grouped by timeClass and SITE_ID
ht.WCWNC.willow.plotsummary <- csv.all.lc.mcro.df %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(SITE_TYPE == "WC" |SITE_TYPE == "WNC") %>% 
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  select(timeClass, SITE_ID, PLANT_HT_CM, SITE_TYPE,FENCED,zCond, zCond2) %>% 
  group_by(timeClass,SITE_ID,SITE_TYPE,FENCED, zCond, zCond2) %>% 
  summarise(PLANT_HT_CM_mean = mean(PLANT_HT_CM, na.rm=TRUE), PLANT_HT_CM_median = median(PLANT_HT_CM), PLANT_HT_CM_max = max(PLANT_HT_CM)) %>%
  ungroup()

```

```{r}

## summary table: mean ht
ht.WCWNC.willow.plotsummary %>% 
  group_by(timeClass) %>% 
  summarytools::descr(var = PLANT_HT_CM_mean, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, 'Time class' = timeClass) %>%   
  mutate(across(where(is.numeric),round,1)) %>% 
  gt() %>% 
  tab_header(title = "Mean plot willow height", subtitle = "All willows, WC & WNC macroplots") #%>%
  # gtsave("./output/tables/Mcplot_mean_HT_all_willow_WCandWNC_TC.rtf")


## summary table: max ht
ht.WCWNC.willow.plotsummary %>% 
  group_by(timeClass) %>% 
  summarytools::descr(var = PLANT_HT_CM_max, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, 'Time class' = timeClass) %>%   
  mutate(across(where(is.numeric),round,1)) %>% 
  gt() %>% 
  tab_header(title = "Max plot willow height", subtitle = "All willows, WC & WNC macroplots") #%>%
  #gtsave("./output/tables/Mcplot_max_HT_all_willow_WCandWNC_TC.rtf")

## summary table: median ht
ht.WCWNC.willow.plotsummary %>% 
  group_by(timeClass) %>% 
  summarytools::descr(var = PLANT_HT_CM_median, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, 'Time class' = timeClass) %>%   
  mutate(across(where(is.numeric),round,1)) %>% 
  gt() %>% 
  tab_header(title = "Median plot willow height", subtitle = "All willows, WC & WNC macroplots") #%>%
  # gtsave("./output/tables/Mcplot_median_HT_all_willow_WCandWNC_TC.rtf")
```

```{r}
## table:
ht.WCWNC.willow.plotsummary %>% 
  group_by(timeClass, FENCED) %>% 
  summarytools::descr(var = PLANT_HT_CM_mean, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, 'Time class' = timeClass) %>%   
  mutate(across(where(is.numeric),round,1)) %>% 
  gt() %>% 
  tab_header(title = "Mean plot willow height", subtitle = "All willows, WC & WNC macroplots")

```

```{r}
## table adding in location and fencing

ht.WCWNC.willow.plotsummary %>% 
  group_by(timeClass, SITE_TYPE, FENCED) %>% 
  summarytools::descr(var = PLANT_HT_CM_mean, stats = "common") %>% 
  summarytools::tb() %>% 
  rename(n = n.valid, 'Time class' = timeClass) %>%   
  mutate(across(where(is.numeric),round,1)) %>% 
  mutate(variable = paste0("plot mean")) %>% 
  clean_names() %>% 
  gt() %>%
  tab_header(title = "Mean plot willow height", subtitle = "All willows, WC & WNC macroplots") 

```

```{r}
# ht.WCWNC.willow.plotsummary
```


**Mean height by willow species**
```{r}

pl.meanht.wcwnc.tile <- csv.all.lc.mcro.df %>% 
  filter(SPECIES_CODE == "SAMO" | SPECIES_CODE == "SAGE" | SPECIES_CODE == "SAPL") %>% 
  # filter(SITE_TYPE == "WC") %>%
  filter(SITE_TYPE != "WK") %>%
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  group_by(yr,SPECIES_CODE) %>% 
  skimr::skim(PLANT_HT_CM) %>% 
  select(yr, contains("skim"),SPECIES_CODE, contains("c.m"), contains("c.s")) %>%
  select(-skim_type) %>% 
  ggplot(aes(yr, SPECIES_CODE)) +
  geom_tile(aes(fill = numeric.mean), color="grey80", alpha=0.85) +
  geom_text(aes(label = round(numeric.mean,1)), color = "black", alpha = .85) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(x = "Year", y = "Species", fill = "mean height (cm)", title = "Combined Range")

pl.meanht.wc.tile <- csv.all.lc.mcro.df %>% 
  filter(SPECIES_CODE == "SAMO" | SPECIES_CODE == "SAGE" | SPECIES_CODE == "SAPL") %>% 
  filter(SITE_TYPE == "WC") %>%
  # filter(SITE_TYPE != "WK") %>%
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  group_by(yr,SPECIES_CODE) %>% 
  skimr::skim(PLANT_HT_CM) %>% 
  select(yr, contains("skim"),SPECIES_CODE, contains("c.m"), contains("c.s")) %>%
  select(-skim_type) %>% 
  ggplot(aes(yr, SPECIES_CODE)) +
  geom_tile(aes(fill = numeric.mean), color="grey80", alpha=0.85) +
  geom_text(aes(label = round(numeric.mean,1)), color = "black", alpha = .85) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = "Year", y = "Species", fill = "mean height (cm)", title = "Core Range")


pl.meanht.wnc.tile <- csv.all.lc.mcro.df %>% 
  filter(SPECIES_CODE == "SAMO" | SPECIES_CODE == "SAGE" | SPECIES_CODE == "SAPL") %>% 
  filter(SITE_TYPE == "WNC") %>%
  # filter(SITE_TYPE != "WK") %>%
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  group_by(yr,SPECIES_CODE) %>% 
  skimr::skim(PLANT_HT_CM) %>% 
  select(yr, contains("skim"),SPECIES_CODE, contains("c.m"), contains("c.s")) %>%
  select(-skim_type) %>% 
  ggplot(aes(yr, SPECIES_CODE)) +
  geom_tile(aes(fill = numeric.mean), color="grey80", alpha=0.85) +
  geom_text(aes(label = round(numeric.mean,1)), color = "black", alpha = .85) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(x = "Year", y = "Species", fill = "mean height (cm)", title = "Noncore Range")

pl.meanht.wk.tile <- csv.all.lc.mcro.df %>% 
  filter(SPECIES_CODE == "SAMO" | SPECIES_CODE == "SAGE" | SPECIES_CODE == "SAPL") %>% 
  filter(SITE_TYPE == "WK") %>%
  # filter(SITE_TYPE != "WK") %>%
  mutate(yr = as.character(yr)) %>%
  # filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  group_by(yr,SPECIES_CODE) %>% 
  skimr::skim(PLANT_HT_CM) %>% 
  select(yr, contains("skim"),SPECIES_CODE, contains("c.m"), contains("c.s")) %>%
  select(-skim_type) %>% 
  ggplot(aes(yr, SPECIES_CODE)) +
  geom_tile(aes(fill = numeric.mean), color="grey80", alpha=0.85) +
  geom_text(aes(label = round(numeric.mean,1)), color = "black", alpha = .85) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  theme_minimal() +
  # theme(legend.position = "none") +
  labs(x = "Year", y = "Species", fill = "mean height (cm)", title = "Kawuneeche Valley")

pl.meanht.wk.tile

pl.meanht.wcwnc.tile + pl.meanht.wc.tile + pl.meanht.wnc.tile
ggsave("./output/figures_202107/willowht_macroplot+WCWNC_tile_3panel.png", width = 7.5, height = 4.75, dpi = 300)

```

```{r}
pl.meanht.wc.tile.fenced <- csv.all.lc.mcro.df %>% 
  filter(SPECIES_CODE == "SAMO" | SPECIES_CODE == "SAGE" | SPECIES_CODE == "SAPL") %>% 
  filter(SITE_TYPE == "WC") %>%
  # filter(SITE_TYPE != "WK") %>%
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  group_by(yr,SPECIES_CODE, FENCED) %>% 
  skimr::skim(PLANT_HT_CM) %>% 
  select(yr, FENCED, contains("skim"),SPECIES_CODE, contains("c.m"), contains("c.s")) %>%
  select(-skim_type) %>% 
  ggplot(aes(yr, SPECIES_CODE)) +
  geom_tile(aes(fill = numeric.mean), color="grey80", alpha=0.85) +
  geom_text(aes(label = round(numeric.mean,1)), color = "black", alpha = .85) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = "Year", y = "Species", fill = "mean height (cm)", title = "Core Range") +
  facet_wrap(~FENCED)


pl.meanht.wc.tile.fenced + pl.meanht.wnc.tile + plot_layout(widths = c(2,1))
ggsave("./output/figures_202107/willowht_macroplot_WCWNCxF_tile_2panel.png", width = 7.5, height = 4.75, dpi = 300)

```


```{r, eval=FALSE}

# lu.removed.plot
# csv.all.lc.li.df

# # remove all the removed plots identified in the site info tab if raw files
# csv.all.lc.mcro.df <- anti_join(csv.all.lc.mcro.df, lu.removed.plot, by="SITE_ID")

csv.all.lc.mcro.df %>%
  tabyl(SITE_TYPE, yr)


## write_csv
csv.all.lc.mcro.df %>%
  write_csv("./output/exported_data/willow_mcro.csv")

```

```{r}
## parse out groups of species
allshrub.mcro.all <- csv.all.lc.mcro.df %>%
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  clean_names()

nonwillowshrub.mcro.all <- csv.all.lc.mcro.df %>%
  mutate(yr = as.character(yr)) %>%
  filter(str_detect(SPECIES_CODE, "^SA",negate = TRUE)) %>% 
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  clean_names()

willow.mcro.all <- csv.all.lc.mcro.df %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  # filter(SITE_TYPE == "WC") %>%
  # filter(SITE_TYPE != "WNC") %>% 
  mutate(yr = as.character(yr)) %>%
  # mutate(yr = as.integer(yr)) %>%
  # mutate(yr = as.character(yr)) %>% 
  # filter(yr == 2013 | yr == 2018) %>%
  # filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  clean_names()

```

```{r}
#### Core winter range
allshrub.mcro.all %>% 
  filter(site_type == "WC") %>%
  # filter(SITE_TYPE != "WNC") %>% 
  ggplot(aes(time_class, plant_ht_cm)) +
  geom_boxplot(aes(fill = fenced),outlier.shape = NA) +
  scale_fill_manual(values = c("grey80", "grey40")) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  theme_minimal() +
  ylim(0,320) +
  labs(x = "", y = "Shrub height (cm)", fill = "", caption = "macro, WC only, all shrubs")

# ggsave("./output/figures_202107/WC_allshrub_ht_boxplot_dfc.png", width = 5.5, height = 3.5)

nonwillowshrub.mcro.all %>% 
  filter(site_type == "WC") %>%
  # filter(SITE_TYPE != "WNC") %>% 
  ggplot(aes(time_class, plant_ht_cm)) +
  geom_boxplot(aes(fill = fenced),outlier.shape = NA) +
  scale_fill_manual(values = c("grey80", "grey40")) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  theme_minimal() +
  ylim(0,200) +
  labs(x = "", y = "Shrub height (cm)", fill = "", caption = "WC only, allnon willow shrubs")

```


```{r}
# ### Mean ht in plots, willow species only
# join cover for spatial export
will.ht.mean <- willow.mcro.all %>% 
  mutate(time_class = forcats::fct_rev(time_class)) %>%
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  group_by(site_id, time_class) %>% 
  summarise(plant_ht_cm.mean = mean(plant_ht_cm)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = time_class, names_glue = "htmean{time_class}",values_from = plant_ht_cm.mean) %>% 
  mutate(difBL18 = htmean2018 - htmeanBL) %>% 
  mutate(difBL13 = htmean2018 - htmeanBL) %>% 
  mutate(dif1318 = htmean2018 - htmean2013)

## join
will.ht.mean.sf <- left_join(will.ht.mean, clean_names(site.info.clean.sf)) %>% 
  mutate(range_type = case_when(is.na(range_type) ~ "core winter range",
                                TRUE ~ range_type)) %>% 
  st_as_sf(sf_column_name = "geometry")

# will.ht.mean.sf %>%
#   st_write("./output/exported_data/spatial/willow_htmean_20200907.shp")

```

**Mean willow height - Baseline**
```{r, eval=TRUE}
will.ht.mean.sf %>% 
  filter(!is.na(htmeanBL)) %>%
  mutate(across(where(is.numeric), round, 2)) %>% 
  mapview(zcol = "htmeanBL")
```

**Mean willow height - 2013**
```{r, eval=TRUE}
will.ht.mean.sf %>% 
  filter(!is.na(htmean2013)) %>%
  mutate(across(where(is.numeric), round, 2)) %>% 
  mapview(zcol = "htmean2013")
```

**Mean willow height - 2018**
```{r, eval=TRUE}
will.ht.mean.sf %>% 
  filter(range_type != "Kawuneeche Valley") %>% 
  filter(!is.na(htmean2018)) %>%
  mutate(across(where(is.numeric), round, 2)) %>% 
  mapview(zcol = "htmean2018")
```

#### Individual willow species

```{r, eval=FALSE}

# levels(willow.ht.wc.wnc$time_class)

pl.li.samo.density <- willow.ht.wc.wnc %>%
  mutate(time_class = fct_drop(f = time_class, only = "2017")) %>% 
  filter(time_class == "BL" | time_class == "2018" |time_class == "2013") %>% 
  # filter(site_type != "WK") %>%
  filter(species_code == "SAMO") %>%   
  # filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  ggplot() +
  ggridges::geom_density_ridges(aes(x = plant_ht_cm, y =  time_class), alpha = 0.45) +
  # viridis::scale_fill_viridis(discrete = TRUE, option = "D") +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(3)) +
  facet_wrap(~site_type, ncol = 1) +
  labs(x = "Willow height (cm)", y = "Year", title = "SAMO")

# pl.li.samo.density

pl.li.sage.density <- willow.ht.wc.wnc %>%
  mutate(time_class = fct_drop(f = time_class, only = "2017")) %>% 
  filter(time_class == "BL" | time_class == "2018" |time_class == "2013") %>%
  filter(site_type != "WK") %>%
  filter(species_code == "SAGE") %>%   
  # filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  ggplot() +
  ggridges::geom_density_ridges(aes(x = plant_ht_cm, y =  time_class), alpha = 0.45) +
  # viridis::scale_fill_viridis(discrete = TRUE, option = "D") +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(3)) +
  facet_wrap(~site_type, ncol = 1) +
  labs(x = "Willow height (cm)", y = "Year", title = "SAGE")

pl.li.sapl.density <- willow.ht.wc.wnc %>%
  mutate(time_class = fct_drop(f = time_class, only = "2017")) %>% 
  filter(time_class == "BL" | time_class == "2018" |time_class == "2013") %>%
  filter(site_type != "WK") %>%
  filter(species_code == "SAPL") %>%   
  # filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  ggplot() +
  ggridges::geom_density_ridges(aes(x = plant_ht_cm, y =  time_class), alpha = 0.45) +
  # viridis::scale_fill_viridis(discrete = TRUE, option = "D") +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(3)) +
  facet_wrap(~site_type, ncol = 1) +
  labs(x = "Willow height (cm)", y = "Year", title = "SAPL")

pl.li.samo.density + pl.li.sage.density + pl.li.sapl.density + patchwork::plot_layout(ncol=3)

ggsave("./output/figures_202107/WCWNCWK_wilspp_density.png", width = 7.5, height = 4.75, dpi = 300)

# csv.all.lc.li.df %>% 
#   tabyl(SPECIES_CODE)
```


#### Height difference from baseline

```{r}
# WC and WNC
pl.diff1.wc <- will.ht.mean.sf %>%
  as_tibble() %>%
  # distinct(range_type)
  filter(!is.na(fenced)) %>% 
  filter(range_type == "core winter range") %>%
  ggplot(aes(fenced, difBL18)) +
  geom_boxplot(outlier.shape = NA, fill = "grey70") +
  geom_hline(yintercept=0, color = "black", size=1, alpha = 0.25) +
  ylim(-75,175) +
  theme_minimal() +
  labs(subtitle = "Core range", x = "", y = "Height difference (cm)")

pl.diff1.wnc <- will.ht.mean.sf %>%
  as_tibble() %>%
  # distinct(range_type)
  filter(!is.na(fenced)) %>% 
  filter(range_type == "non-core winter range") %>%
  ggplot(aes(fenced, difBL18)) +
  geom_boxplot(outlier.shape = NA, fill = "grey70") +
  geom_hline(yintercept=0, color = "black", size=1, alpha = 0.25) +
  ylim(-75,175) +
  theme_minimal() +
  labs(x = "", y = "Height difference (cm)", subtitle = "Non-core range",caption = "mean willow height, all willow spp, 2018-BL")

pl.diff1.wc + pl.diff1.wnc + plot_layout(widths=c(2,1))

ggsave("./output/figures_202107/revised_WC_WNC_HtMeanDiff18BL_TCxfenced_dfc.png", width = 6.5, height = 3.75, dpi = 300)

```

```{r}
## all elk range
will.ht.mean.sf %>%
  as_tibble() %>% 
  filter(!is.na(fenced)) %>% 
  filter(range_type != "Kawuneeche Valley") %>%
  # group_by(fenced, range_type) %>% 
  descr(difBL18) %>% 
  tb() %>%
  select(-c(skewness, se.skewness, kurtosis)) %>% 
  gt() %>% 
  tab_header(title = "Willow ht diff (2018-BL),WC & WNC plots") %>%
  fmt_number(
    columns = 2:11,
    decimals = 1,
    suffixing = TRUE
  )

## all elk range fenced
will.ht.mean.sf %>%
  as_tibble() %>% 
  filter(!is.na(fenced)) %>% 
  filter(range_type != "Kawuneeche Valley") %>%
  group_by(fenced) %>%
  descr(difBL18) %>% 
  tb() %>%
  select(-c(skewness, se.skewness, kurtosis)) %>% 
  gt() %>% 
  tab_header(title = "Willow ht diff (2018-BL),WC & WNC plots") %>%
  fmt_number(
    columns = 3:11,
    decimals = 1,
    suffixing = TRUE
  )


will.ht.mean.sf %>%
  as_tibble() %>% 
  filter(!is.na(fenced)) %>% 
  filter(range_type != "Kawuneeche Valley") %>%
  group_by(fenced, range_type) %>% 
  descr(difBL18) %>% 
  tb() %>%
  select(-c(skewness, se.skewness, kurtosis)) %>% 
  gt() %>% 
  tab_header(title = "Willow ht diff (2018-BL),WC & WNC plots") %>%
  fmt_number(
    columns = 4:11,
    decimals = 1,
    suffixing = TRUE
  ) # %>% 
  # gtsave("./output/tables/WillowHtDif_WCplusWNC.rtf")
```

```{r}
will.ht.mean.sf %>%
  as_tibble() %>% 
  filter(!is.na(burned)) %>% 
  filter(range_type != "Kawuneeche Valley") %>%
  ggplot(aes(burned, difBL18)) +
  geom_boxplot(outlier.shape = NA, fill = "grey70") +
  geom_hline(yintercept=0, color = "black", size=1, alpha = 0.25) +
  ylim(-75,175) +
  theme_minimal() +
  facet_grid(fenced~range_type) +
  labs(x = "", y = "Height difference (cm)", caption = "mean willow height, all willow spp, 2018-BL")

ggsave("./output/figures_202107/revised_WC_WNC_HtMeanDiff18BL_TCxburned_dfc.png", width = 5.5, height = 3.75, dpi = 300)

will.ht.mean.sf %>%
  as_tibble() %>% 
  filter(!is.na(fenced)) %>% 
  filter(range_type != "Kawuneeche Valley") %>%
  group_by(burned, range_type) %>% 
  descr(difBL18) %>% 
  tb() %>%
  select(-c(skewness, se.skewness, kurtosis)) %>% 
  gt() %>% 
  # tab_header(title = "Willow Offtake (% leader use) WC & WNC plots") %>% 
  fmt_number(
    columns = 4:11,
    decimals = 1,
    suffixing = TRUE
  )

```

```{r}
### max to spatial
will.ht.max <- willow.mcro.all %>% 
  mutate(time_class = forcats::fct_rev(time_class)) %>%
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  group_by(site_id, time_class) %>% 
  summarise(plant_ht_cm.max = max(plant_ht_cm)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = time_class, names_glue = "htmax{time_class}",values_from = plant_ht_cm.max) %>% 
  mutate(difBL18 = htmax2018 - htmaxBL) %>% 
  mutate(difBL13 = htmax2018 - htmaxBL) %>% 
  mutate(dif1318 = htmax2018 - htmax2013)

## join
will.ht.max.sf <- left_join(will.ht.max, clean_names(site.info.clean.sf)) %>% 
  st_as_sf(sf_column_name = "geometry")

will.ht.max.sf %>% 
  filter(!is.na(htmax2018)) %>% 
  mapview(zcol = "htmax2018")

# will.ht.max.sf %>%
#   st_write("./output/exported_data/spatial/willow_htmax_20200907.shp")


```

```{r}
willow.mcro.all %>%
  filter(site_type == "WC") %>%
  # filter(SITE_TYPE != "WNC") %>% 
  ggplot(aes(time_class, plant_ht_cm)) +
  geom_boxplot(aes(fill = fenced),outlier.shape = NA) +
  scale_fill_manual(values = c("grey80", "grey40")) +
  ylim(0,350) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  theme_minimal() +
  labs(x = "", y = "Willow height (cm)", fill = "", caption = "Macroplot, WC only")


# ggsave("./output/figures_202107/WC_willow_ht_boxplot_dfc.png", width = 5.5, height = 3.5)

# ggsave("./output/figures_202107/WC_allnonwillow_ht_boxplot_dfc.png", width = 5.5, height = 3.5)


```

```{r}
## two panel revised fig

pl.b.wc <- willow.mcro.all %>%
  filter(site_type == "WC") %>%
  ggplot(aes(time_class, plant_ht_cm)) +
  geom_boxplot(aes(fill = fenced),outlier.shape = NA) +
  # scale_fill_manual(values = c("grey80", "grey40")) +
  scale_fill_manual(values = colfunc2(2)) +
  ylim(0,350) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = "", y = "Willow height (cm)", fill = "", subtitle = "Core range")

pl.b.wnc <- willow.mcro.all %>%
  filter(site_type == "WNC") %>%
  ggplot(aes(time_class, plant_ht_cm)) +
  geom_boxplot(aes(fill = fenced),outlier.shape = NA) +
  # scale_fill_manual(values = c("grey80", "grey40")) +
  scale_fill_manual(values = colfunc2(2)) +
  ylim(0,350) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(x = "", y = "Willow height (cm)", fill = "", subtitle = "Non-core range")

pl.b.wnc + pl.b.wc + plot_layout(widths = c(1, 2))

ggsave("./output/figures_202107/wilht_allsp_macro_wc_wnc.png", width = 6.85, height = 3.75, dpi=300)

```


```{r}
##### WC by species
willow.mcro.all %>%
  filter(site_type != "WK") %>% 
  # filter(site_type == "WC") %>%
  # filter(SITE_TYPE != "WNC") %>% 
  ggplot(aes(site_type, plant_ht_cm)) +
  # geom_boxplot(aes(fill = fenced), outlier.shape = NA) +
  geom_boxplot(fill = "grey70", outlier.shape = NA) +
  # scale_fill_manual(values = c("grey80")) +
  ylim(0,350) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  theme_minimal() +
  labs(x = "", y = "Willow height (cm)", fill = "", caption = "Macroplot, all willow") +
  facet_wrap(~time_class)

ggsave("./output/figures_202107/WC_willow_ht_boxplot_site_type_dfc.png", width = 5.5, height = 3.5)

```

```{r}
### WNC
willow.mcro.all %>%
  # filter(site_type == "WC") %>%
  filter(site_type == "WNC") %>%
  ggplot(aes(time_class, plant_ht_cm)) +
  geom_boxplot(aes(fill = fenced), outlier.shape = NA) +
  scale_fill_manual(values = c("grey80", "grey40")) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,350) +
  theme_minimal() +
  labs(x = "", y = "Willow height (cm)", fill = "", caption = "macroplot, WNC only")

# ggsave("./output/figures_202107/WNC_willow_ht_boxplot_dfc.png", width = 5.5, height = 3.5)

```

```{r}
### WK
willow.mcro.all %>%
  filter(site_type == "WK") %>%
  # filter(site_type == "WNC") %>%
  ggplot(aes(time_class, plant_ht_cm)) +
  geom_boxplot(aes(fill = fenced)) +
  scale_fill_manual(values = c("grey80", "grey40")) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  theme_minimal() +
  labs(x = "", y = "Willow height (cm)", fill = "", caption = "WK only")

# ggsave("./output/figures_202107/WK_willow_ht_boxplot_dfc.png", width = 5.5, height = 3.5)

```

#### Management thresholds 

**Count of plots above 1.1 m**

```{r}
## thresholds
#### winter range (wc and wnc)
willow.mcro.all %>%
  filter(!is.na(plant_ht_cm)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # tabyl(species_code)
  filter(site_type != "WK") %>%
  group_by(time_class, site_id, fenced, site_type) %>% 
  summarise(ht.mean = mean(plant_ht_cm), ht.max = max(plant_ht_cm)) %>% 
  ungroup() %>% 
  mutate(thresh1p1 = case_when(ht.mean >=110 ~ "above",
                               ht.mean <110 ~ "below")) %>%  
  tabyl(time_class, thresh1p1) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC")

  
```

```{r}
### WC & WNC: fenced threholds
willow.mcro.all %>%
  filter(!is.na(plant_ht_cm)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # tabyl(species_code)
  filter(site_type != "WK") %>%
  group_by(time_class, site_id, fenced, site_type) %>% 
  summarise(ht.mean = mean(plant_ht_cm), ht.max = max(plant_ht_cm)) %>% 
  ungroup() %>% 
  mutate(thresh1p1 = case_when(ht.mean >=110 ~ "above",
  ht.mean <110 ~ "below")) %>%
                               group_by(time_class, fenced, thresh1p1) %>%
                               summarise(n = n()) %>% 
                               ungroup() %>% 
                               pivot_wider(names_from =thresh1p1, values_from = n) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC: fenced")
```

```{r}
#### Range type x fenced
willow.mcro.all %>%
  filter(!is.na(plant_ht_cm)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # filter(site_type != "WK") %>%
  group_by(time_class, site_id, fenced, site_type) %>% 
  summarise(ht.mean = mean(plant_ht_cm), ht.max = max(plant_ht_cm)) %>% 
  ungroup() %>% 
  mutate(thresh1p1 = case_when(ht.mean >=110 ~ "above",
  ht.mean <110 ~ "below")) %>%
                               group_by(time_class, site_type, fenced, thresh1p1) %>%
                               summarise(n = n()) %>% 
                               ungroup() %>% 
                               pivot_wider(names_from =thresh1p1, values_from = n) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC: fenced")


```

```{r}
#### WC & WNC: burned fenced
willow.mcro.all %>%
  filter(!is.na(plant_ht_cm)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # tabyl(species_code)
  filter(site_type != "WK") %>%
  group_by(time_class, site_id, fenced, burned) %>% 
  summarise(ht.mean = mean(plant_ht_cm), ht.max = max(plant_ht_cm)) %>% 
  ungroup() %>% 
  mutate(thresh1p1 = case_when(ht.mean >=110 ~ "above",
  ht.mean <110 ~ "below")) %>%
                               group_by(time_class, fenced, burned, thresh1p1) %>%
                               summarise(n = n()) %>% 
                               ungroup() %>% 
                               pivot_wider(names_from =thresh1p1, values_from = n) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC: fenced burned")
```

#### Range-wide summary

```{r}


## table 8 Zeigenfuss 2015. timeClass x fenced x site type
lz.wt.willow.tb8 %>% 
  gt() %>% 
  tab_header(title = "Area weights used in Zeigenfuss 2015")

lz.wt.willow.tb8_sitetype %>% 
  gt() %>% 
  tab_header(title = "Area weights used in Zeigenfuss 2015")

lz.wt.willow.tbl9 %>%
  rename(Category=zCond2_tc, Weight = areawt_lz) %>% 
  gt() %>% 
  tab_header(title = "Area weights used in Zeigenfuss 2015")

```

```{r}
ht.WCWNC.willow.plotsummary <- ht.WCWNC.willow.plotsummary %>%
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(across(where(is.numeric), round, 2))

## join in the weights
ht.WCWNC.willow.plotsummary <- ht.WCWNC.willow.plotsummary %>% 
  left_join(., lz.wt.willow.tb8_sitetype) 

# willow.mcro.all %>%
#   filter(!is.na(plant_ht_cm))

ht.WCWNC.willow.plotsummary %>% 
  left_join(.,lz.wt.willow.tb8) 

```



```{r}
#### Table 8 - mean height
ht.WCWNC.willow.plotsummary %>% 
  left_join(.,lz.wt.willow.tb8) %>% 
  tabyl(zCond2)

tbl8.ht <- ht.WCWNC.willow.plotsummary %>%
  mutate(fenceClass_tc = paste0(SITE_TYPE,"-",FENCED,"-",timeClass)) %>%
  mutate(site_typeXfenced = paste0(SITE_TYPE,"-", FENCED)) %>% 
  # mutate(fenceClass_tc = paste0(SITE_TYPE,"-",FENCED,"-",timeClass)) %>%
  group_by(timeClass, SITE_TYPE, FENCED, site_typeXfenced) %>%
  summarise(n = n(), mean.ht = mean(PLANT_HT_CM_mean, na.rm=TRUE), sd.ht = sd(PLANT_HT_CM_mean, na.rm=TRUE)) %>%
  ungroup() %>% 
  mutate(se = mean.ht/sqrt(n)) %>% 
  mutate(across(where(is.numeric),round,1)) %>%
  arrange(timeClass)


lz.wt.willow.tb8
##
tbl8.ht <- left_join(tbl8.ht, lz.wt.willow.tb8) %>% 
  mutate(mean.ht.wt = areawt*mean.ht, se.ht.wt = areawt*se) 

## RANGE wide estimate tbl8.cov
tbl8.ht.rangewide <- tbl8.ht %>% 
  group_by(timeClass) %>% 
  summarise(mean.ht = sum(mean.ht.wt, na.rm=TRUE), se = sum(se.ht.wt, na.rm=TRUE)) %>%
  mutate(across(where(is.numeric),round,0)) %>% 
  mutate(mean_se = paste0(mean.ht,"(+/-",se,")")) %>% 
  mutate(site_typeXfenced = "Entire winter range (weighted avg)")

### table 8 
tbl8.ht %>% 
  mutate(mean_se = paste0(mean.ht,"(+/-",se,")")) %>% 
  bind_rows(.,tbl8.ht.rangewide) %>% 
  select(timeClass, SITE_TYPE, FENCED, site_typeXfenced, mean_se) %>% 
  pivot_wider(names_from = timeClass,
              # names_glue = "{timeClass}_test_{FENCED}",
              values_from = mean_se) %>%
  select(-c(FENCED, SITE_TYPE)) %>% 
  relocate('Winter range zone' = site_typeXfenced, "Baseline" = "BL",'2013','2018') %>% 
  gt() %>% 
  tab_header(title = "Willow height (cm)")

```

```{r}
### range wide (bottomline of table)
lz.wt.willow.tb8_sitetype

# unweighted table 9
wt.ht.rangewide <- ht.WCWNC.willow.plotsummary %>%
  group_by(timeClass, SITE_TYPE) %>%
  summarise(n = n(), mean.ht = mean(PLANT_HT_CM_mean, na.rm=TRUE), sd.ht = sd(PLANT_HT_CM_mean, na.rm=TRUE)) %>%
  ungroup() %>% 
  mutate(se = mean.ht/sqrt(n)) %>% 
  left_join(.,lz.wt.willow.tb8_sitetype) %>% 
  mutate(mean.ht.wt = areawt*mean.ht, se.ht.wt = areawt*se) %>% 
  group_by(timeClass) %>% 
  summarise(mean.ht.wt = sum(mean.ht.wt),se.ht.wt = sum(se.ht.wt)) %>% 
  ungroup() %>%
  mutate(timeClass= as_factor(timeClass)) %>% 
  mutate(timeClass = fct_relevel(timeClass, "BL", before="2013")) %>% 
  arrange(timeClass)

wt.ht.rangewide %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  gt() %>% 
  tab_header(title="Entire winter range (weighted average")
# comp to bl:20(2); 2013:24(3); na in zeigenfuss 2015
```

```{r}
# unweighted table 9
wt.ht.mean <- ht.WCWNC.willow.plotsummary %>%
  mutate(zCond2_tc = paste0(SITE_TYPE,"-",zCond,"-",timeClass)) %>% 
  group_by(timeClass, SITE_TYPE, zCond2,zCond2_tc) %>%
  summarise(n = n(), mean.ht = mean(PLANT_HT_CM_mean, na.rm=TRUE), sd.ht = sd(PLANT_HT_CM_mean, na.rm=TRUE)) %>%
  ungroup() %>% 
  mutate(se = mean.ht/sqrt(n)) %>% 
  arrange(timeClass, zCond2)

```

```{r}
### zcond2
# join in weights from 2015 SAS code
wt.ht.zcond2 <- left_join(wt.ht.mean, lz.wt.willow.tbl9, by="zCond2_tc") %>% 
  mutate(mean.ht.wt = areawt_lz*mean.ht, se.wt = areawt_lz*se)

## check sum of weights = 1
temp1 <- wt.ht.zcond2 %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  group_by(timeClass,SITE_TYPE) %>% 
  summarise(sum.wt.ht = sum(mean.ht.wt, na.rm=TRUE), sum.wt.wt = sum(areawt_lz, na.rm=TRUE)) %>% 
  ungroup() 

temp1

temp1 %>% 
  group_by(timeClass) %>% 
  summarise(wt.ht = sum((sum.wt.ht*sum.wt.wt)))

```

```{r, eval=FALSE}
wt.ht.zcond2 %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  select(timeClass, zCond2, mean.ht.wt) %>% 
  pivot_wider(names_from = timeClass, values_from = c(mean.ht.wt)) %>% 
  clean_names() %>% 
  gt()

```


```{r}
#### Table 8 - maximum height  
ht.WCWNC.willow.plotsummary %>% 
  left_join(.,lz.wt.willow.tb8) %>% 
  tabyl(zCond2)

tbl8.ht.max <- ht.WCWNC.willow.plotsummary %>%
  mutate(fenceClass_tc = paste0(SITE_TYPE,"-",FENCED,"-",timeClass)) %>%
  mutate(site_typeXfenced = paste0(SITE_TYPE,"-", FENCED)) %>% 
  group_by(timeClass, SITE_TYPE, FENCED, site_typeXfenced) %>%
  summarise(n = n(), mean.ht = mean(PLANT_HT_CM_max, na.rm=TRUE), sd.ht = sd(PLANT_HT_CM_max, na.rm=TRUE)) %>%
  ungroup() %>% 
  mutate(se = mean.ht/sqrt(n)) %>% 
  mutate(across(where(is.numeric),round,1)) %>%
  arrange(timeClass)

##
tbl8.ht.max <- left_join(tbl8.ht.max, lz.wt.willow.tb8) %>% 
  mutate(mean.ht.wt = areawt*mean.ht, se.ht.wt = areawt*se) 

## RANGE wide estimate tbl8.cov
tbl8.ht.max.rangewide <- tbl8.ht.max %>% 
  group_by(timeClass) %>% 
  summarise(mean.ht = sum(mean.ht.wt, na.rm=TRUE), se = sum(se.ht.wt, na.rm=TRUE)) %>%
  mutate(across(where(is.numeric),round,0)) %>% 
  mutate(mean_se = paste0(mean.ht,"(+/-",se,")")) 

### table 8 
tbl8.ht.max %>% 
  mutate(mean_se = paste0(mean.ht,"(+/-",se,")")) %>% 
  bind_rows(.,tbl8.ht.max.rangewide) %>% 
  select(timeClass, SITE_TYPE, FENCED, site_typeXfenced, mean_se) %>% 
  pivot_wider(names_from = timeClass,
              # names_glue = "{timeClass}_test_{FENCED}",
              values_from = mean_se) %>%
  select(-c(FENCED, SITE_TYPE)) %>% 
  relocate('Winter range zone' = site_typeXfenced, "Baseline" = "BL",'2013','2018') %>% 
  gt() %>% 
  tab_header(title = "Maximum willow height (cm)")

```

```{r}
### range wide (bottomline of table)
lz.wt.willow.tb8_sitetype

# unweighted table 9
wt.ht.max.rangewide <- ht.WCWNC.willow.plotsummary %>%
  group_by(timeClass, SITE_TYPE) %>%
  summarise(n = n(), mean.ht = mean(PLANT_HT_CM_max, na.rm=TRUE), sd.ht = sd(PLANT_HT_CM_max, na.rm=TRUE)) %>%
  ungroup() %>% 
  mutate(se = mean.ht/sqrt(n)) %>% 
  left_join(.,lz.wt.willow.tb8_sitetype) %>% 
  mutate(mean.ht.wt = areawt*mean.ht, se.ht.wt = areawt*se) %>% 
  group_by(timeClass) %>% 
  summarise(mean.ht.wt = sum(mean.ht.wt),se.ht.wt = sum(se.ht.wt)) %>% 
  ungroup() %>%
  mutate(timeClass= as_factor(timeClass)) %>% 
  mutate(timeClass = fct_relevel(timeClass, "BL", before="2013")) %>% 
  arrange(timeClass)

wt.ht.max.rangewide %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  gt() %>% 
  tab_header(title="Entire winter range (weighted average")
# comp to bl:20(2); 2013:24(3); na in zeigenfuss 2015
```

```{r}
# unweighted table 9
wt.ht.mean <- ht.WCWNC.willow.plotsummary %>%
  mutate(zCond2_tc = paste0(SITE_TYPE,"-",zCond,"-",timeClass)) %>% 
  group_by(timeClass, SITE_TYPE, zCond2,zCond2_tc) %>%
  summarise(n = n(), mean.ht = mean(PLANT_HT_CM_mean, na.rm=TRUE), sd.ht = sd(PLANT_HT_CM_mean, na.rm=TRUE)) %>%
  ungroup() %>% 
  mutate(se = mean.ht/sqrt(n)) %>% 
  arrange(timeClass, zCond2)

```

```{r}
### zcond2
# join in weights from 2015 SAS code
wt.ht.zcond2 <- left_join(wt.ht.mean, lz.wt.willow.tbl9, by="zCond2_tc") %>% 
  mutate(mean.ht.wt = areawt_lz*mean.ht, se.wt = areawt_lz*se)

## check sum of weights = 1
temp1 <- wt.ht.zcond2 %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  group_by(timeClass,SITE_TYPE) %>% 
  summarise(sum.wt.ht = sum(mean.ht.wt, na.rm=TRUE), sum.wt.wt = sum(areawt_lz, na.rm=TRUE)) %>% 
  ungroup() 

temp1

temp1 %>% 
  group_by(timeClass) %>% 
  summarise(wt.ht = sum((sum.wt.ht*sum.wt.wt)))

```

### Offtake

**DD2**

"stem-scaled diameter difference method"

**DD2 = (b/b +u) \* (Dp - Dt)/(Db - Dt)**

b, the number of browsed shoots on the stem; u, the number of unbrowsed
shoots; Dp, shoot diameter at the point of browsing; Dt, the average
diameter of unbrowsed shoot tips; and Db, the diameter at the base of
the shoot.

```{r, echo = FALSE, eval = FALSE}
# Looking for baseline data?  	
# 	Baseline data was collected over 2 seasons: 2008 and 2009.  
# 	The baseline data is located in an Excel spreadsheet at:
# 	EVMP > Vegetation > Analysis > 5 Year Review > Baseline Data from Linda
# 	
# Where is the Kawuneeche Baseline data?	
# 	The Kawuneeche Baseline data is in a worksheet in the Baseline.xls workbook as described above.    
# 	The Kawuneeche willow plots (KW 1 thru 8) were established in August/Sept 2011, just prior to the installation of the exclosure near Timber Creek CG.
# 	
# KEY	
# SITE_TYPE (WC=Willow core, WNC= Willow noncore, WK= Willow Kawuneeche Valley)	
# COLOR_OF_STEM_MARKER (BR=brown, G=green, BL=black, Y=yellow, GR=gray, BR-N=brown notched, W=white)	
# NUMBER_BROWSED_CAG_SHOOTS (# Browsed Current Annual Growth Shoots)	
# NUMBER_UNBROWSED_CAG_SHOOTS (# Unbrowsed Current Annual Growth Shoots)	
# BROWSED_OR_UNBROWSED (Measured shoot browsed (B) or unbrowsed (U)?)	
# ADDITIONAL_SHOOT (Additional shoot 1=yes, 0=no)	
# _KEY:_	
# SITE_TYPE (WC=Willow core, WNC= Willow noncore, WK= Willow Kawuneeche Valley)	
# 	
# COLOR_OF_STEM_MARKER (BR=brown, G=green, BL=black, Y=yellow, GR=gray, BR-N=brown notched, W=white)	
# 	
# NUMBER_BROWSED_CAG_SHOOTS (# Browsed Current Annual Growth Shoots)	
# 	
# NUMBER_UNBROWSED_CAG_SHOOTS (# Unbrowsed Current Annual Growth Shoots)	
# 	
# BROWSED_OR_UNBROWSED (Measured shoot browsed (B) or unbrowsed (U)?)	
# 	
# ADDITIONAL_SHOOT (Additional shoot 1=yes, 0=no)
```

```{r}
#### Baseline
### LZ 2013 baseline
## LZ's 2013 data
# ROMO_elk_vegetation_monitoring_data_willow2013 update.xls

#### Read in the worksheets and create list of df
# each tab is a df in the list object

lz.bl13.wil.sheets <- excel_sheets(path = ("./data/EVMP_data/Baseline Data from Linda/ROMO_elk_vegetation_monitoring_data_willow2013 update.xls"))

## read in all of the tabs as 'data' in list column
lz.bl13.wil <- lz.bl13.wil.sheets %>%
  enframe() %>% 
  rename(sheet = value) %>% 
  mutate(path = ("./data/EVMP_data/Baseline Data from Linda/ROMO_elk_vegetation_monitoring_data_willow2013 update.xls")) %>% 
  mutate(data = map2(.x = path,.y = sheet,.f = read_excel,col_types = "text")) %>% 
  select(-c(name))

```

```{r, echo=FALSE, eval=FALSE}
# distinct sheets
lz.bl13.wil %>%
  distinct(sheet) %>% 
  gt() %>% 
  tab_header(title = "Distinct sheets", subtitle = "Baseline Data from Linda/ROMO_elk_vegetation_monitoring_data_willow2013 update.xls")

```

```{r}
### BL-2013 spring offtake   
lz.bl13.offt.spr <- lz.bl13.wil %>%
  filter(str_detect(sheet,pattern = "RMNP_spring")) %>% 
  unnest(cols = c(data)) %>% 
  clean_names() %>% 
  distinct()

### BL-2013 fall offtake   
lz.bl13.offt.fall <- lz.bl13.wil %>%
  filter(str_detect(sheet,pattern = "RMNP_fall")) %>% 
  unnest(cols = c(data)) %>% 
  clean_names() %>% 
  distinct()

### BL-2013: "twig 2008"   
lz.bl13.twig2008 <- lz.bl13.wil %>%
  filter(str_detect(sheet,pattern = "twig")) %>% 
  unnest(cols = c(data)) %>% 
  clean_names()

```

```{r, echo=FALSE, eval=FALSE}

### BL-2013 spring offtake   
lz.bl13.offt.spr %>% 
  head() %>% 
  gt() %>% 
  tab_header(title="BL-2013: 'twig 2008'")


### BL-2013: "twig 2008"   
lz.bl13.twig2008 %>% 
  head() %>% 
  gt() %>% 
  tab_header(title="BL-2013: 'twig 2008'")

```

```{r}
#### BL twig
### munge the baseline 2013 twig data
lz.bl13.twig2008.clean <- lz.bl13.twig2008 %>% 
  na_if(".") %>% 
  clean_names() %>% 
  mutate(across(.cols = c(shoot_length_cm,shoot_weight_g,date_of_shoot_collection, diameter_at_base_of_shoot_mm, diameter_at_tip_of_shoot_mm),.fns = as.numeric)) %>% 
  mutate(date = janitor::excel_numeric_to_date(date_of_shoot_collection)) %>% 
  mutate(yr = year(date))

### remove all records with 'na'
lz.bl13.twig2008.clean <- lz.bl13.twig2008.clean %>%
  na.omit

```
**Species-specific regressions of mass as a function of:**  
twig length  
twig length + location 
```{r}
# lz.bl13.twig2008.clean %>%  
#   visdat::vis_dat()

lz.bl13.twig2008.clean %>% 
  ggplot(aes(shoot_weight_g,shoot_length_cm)) +
  geom_point(aes(color=location)) +
  geom_smooth(aes(color = location),method = "lm", se = FALSE) +
  scale_color_viridis(discrete = TRUE, option = 'A') +
  theme_minimal() +
  labs(x = "Shoot weight (g)", y = "Shoot length (cm)", caption = "BL 2013 data lz.bl13.twig2008.clean. Pooled willow species")
```

```{r}
lz.bl13.twig2008.clean %>%
  filter(!is.na(species_code)) %>% 
  ggplot(aes(shoot_weight_g,shoot_length_cm)) +
  geom_point(aes(color=location)) +
  geom_smooth(aes(color = location),method = "lm", se = FALSE) +
  scale_color_viridis(discrete = TRUE, option = 'A') +
  theme_minimal() +
  facet_wrap(~species_code) +
  labs(x = "Shoot weight (g)", y = "Shoot length (cm)", caption = "BL 2013 data lz.bl13.twig2008.clean")
```

```{r, eval=TRUE}
## regressions
models.twigs <- tibble::tribble(
  ~model_name,    ~ formula,
  "wt~length", shoot_weight_g ~ shoot_length_cm,
  "wt~length+loc", shoot_weight_g ~ shoot_length_cm + location)

lz.bl13.twig2008.clean %>% 
  nest_by(species_code) %>% 
  left_join(models.twigs, by = character()) %>% 
  rowwise(species_code, model_name) %>% 
  mutate(model = list(lm(formula, data = data))) %>% 
  summarise(broom::glance(model)) %>% 
  gt() %>% 
  tab_header(title = "Species-specific length ~ mass")

```

```{r}
#### BL clean
lz.bl.fall <- lz.bl13.offt.fall %>%
  select(c(sheet,year_of_data_collection,
           site_type_wc_core_wnc_non_core, 
           site_number, 
           unique_site_id, 
           microplot_location, 
           species_code, 
           shoot_ratio,
           number_browsed_current_annual_growth_shoots, 
           number_unbrowsed_current_annual_growth_shoots,
           measured_shoot_browsed_b_or_unbrowsed_u,
           diameter_at_base_of_shoot_mm,
           diameter_at_tip_of_shoot_mm,
           shoot_length_cm))

## address the inconsistent year
lz.bl.fall <- lz.bl.fall %>% 
  rename(yr = year_of_data_collection) %>% 
  mutate(yr = as.integer(yr))

lz.bl.spring <- lz.bl13.offt.spr %>% 
  select(c(sheet,date,
           site_type_wc_core_wnc_non_core, 
           site_number, 
           unique_site_id, 
           microplot_location, 
           species_code, 
           shoot_ratio,
           number_browsed_current_annual_growth_shoots, 
           number_unbrowsed_current_annual_growth_shoots,
           measured_shoot_browsed_b_or_unbrowsed_u,
           diameter_at_base_of_shoot_mm,
           diameter_at_tip_of_shoot_mm,
           shoot_length_cm))


lz.bl.spring <- lz.bl.spring %>%
  mutate(date = as.numeric(date)) %>% 
  mutate(date = janitor::excel_numeric_to_date(date)) %>%
  mutate(yr = lubridate::year(date)) %>% mutate(yr = as.integer(yr))

# lz.bl.spring %>%
#   tabyl(yr)

## add season and concatenate side_id per 10yr update
lz.bl.fall <- lz.bl.fall %>% 
  mutate(season = "fall") %>% 
  mutate(site_id = as.character(glue::glue('{site_type_wc_core_wnc_non_core}-{site_number}'))) %>% 
  rename(site_type = site_type_wc_core_wnc_non_core)

### address the "." encoding
lz.bl.fall <- lz.bl.fall %>% 
  na_if(".")

lz.bl.spring <- lz.bl.spring %>% 
  mutate(season = "spring") %>% 
  mutate(site_id = as.character(glue::glue('{site_type_wc_core_wnc_non_core}-{site_number}'))) %>% 
  rename(site_type = site_type_wc_core_wnc_non_core)

### address the "." encoding
lz.bl.spring <- lz.bl.spring %>% 
  select(-date) %>% 
  na_if(".")

```

```{r}
## combine fall and spring
lz.bl.fasp <- bind_rows(lz.bl.fall, lz.bl.spring)

lz.bl.fasp <- lz.bl.fasp %>% 
  mutate(across(.cols = contains("number"),.fns = as.numeric)) %>% 
  mutate(across(.cols = contains("diam"),.fns = as.numeric)) %>%
  mutate(across(.cols = c(shoot_ratio, contains("leng")),.fns = as.numeric)) 

## clean 
lz.bl.fasp <- lz.bl.fasp %>% 
  filter(species_code != "DEAD")%>% 
  filter(species_code != "NONE")

```

```{r, eval=FALSE}
## qaqc
lz.bl.fasp %>%
  visdat::vis_dat() +
  coord_flip() +
  labs(title = "combined BL spr and fall")

## note that there is no plant ID
```

```{r}
# remove records for which browsing status is NA
lz.bl.fasp <- lz.bl.fasp %>% 
  filter(!is.na(measured_shoot_browsed_b_or_unbrowsed_u)) 

```

*Master excel file: Willow_Offtake_Data_2009_Through_2018.xlsx*

```{r, eval=TRUE, echo = FALSE}
# The following reads in the offtake data in the 10yr review files. These don't seem to be inclusive of all the data - BL seems incomplete

### Tabs in the worksheet
readxl::excel_sheets("./data/EVMP_data/TenYearReview/Willow_Offtake_Data_2009_Through_2018.xlsx") %>% 
  set_names() %>% 
  enframe() %>% select(-value) %>% 
  gt() %>% 
  tab_header(title = "Tabs in workbook")

offt.sheets <- excel_sheets(path = "data/EVMP_data/TenYearReview/Willow_Offtake_Data_2009_Through_2018.xlsx")

## read in all of the tabs as 'data' in list column
offt.raw <- offt.sheets %>%
  enframe() %>% 
  rename(sheet = value) %>% 
  mutate(path = ("./data/EVMP_data/TenYearReview/Willow_Offtake_Data_2009_Through_2018.xlsx")) %>% 
  mutate(data = map2(.x = path,.y = sheet,.f = read_excel,col_types = "text")) %>% 
  select(-c(name))
## creates a list column with the data from each sheet
 
```

```{r, eval=FALSE}
## The following was pasted in verbatim from the "DIRECTIONS" tab:

# This willow database (workbook)structure	
# 	Annual willow data collected in support of the Elk-Vegetation Management Plan (EVMP) is accumulated by year and season in this single workbook
# 	
# 	The cumulative data set for all years-to-date is contained in the most recent year's subdirectory, e.g., O:EVMP>Vegetation>Annual Records>FY10, FY11, etc.
# 	
# 	Data are collected and entered in a worksheet specific to that year and season as shown on the worksheet tabs.   
# 	
# 	Willow data in support of the Elk Vegetation Management Plan (EVMP) is collected in 2 stages each year -- A sample of unbrowsed shoots are collected   
# 	     each fall, after the growing season.  Specific measurements of browsed and unbrowsed shoots in specified plots are taken each spring
# 	     prior to the onset of growth.  Comparison of the spring measurements to the previous fall's shoot measurements allows calculation of winter offtake by
# 	    herbivores.
# 	
# Data security, disaster recovery	
# 	In addition to residing on the O:..>EVMP subdirectory as noted above, the data workbook is backed up on the hard drive (C:) of the field wildlife  
# 	     biologist's office computer after each data entry session
# 	
# 	Hard copy of spring offtake shoot measurements are held in the supervisory biologist's (T. Johnson) files (originals) and photocopies are kept in the field wildlife  
# 	    biologist's files
# 	
# 	Fall shoot measurements are conducted in the office, and entered directly into the worksheet, without hard copy
# 	
# Looking for baseline data?  	
# 	Baseline data was collected over 2 seasons: 2008 and 2009.  
# 	The baseline data is located in an Excel spreadsheet at:
# 	EVMP > Vegetation > Analysis > 5 Year Review > Baseline Data from Linda
# 	
# Where is the Kawuneeche Baseline data?	
# 	The Kawuneeche Baseline data is in a worksheet in the Baseline.xls workbook as described above.    
# 	The Kawuneeche willow plots (KW 1 thru 8) were established in August/Sept 2011, just prior to the installation of the exclosure near Timber Creek CG.
# 	
# KEY	
# 	
# SITE_TYPE (WC=Willow core, WNC= Willow noncore, WK= Willow Kawuneeche Valley)	
# 	
# COLOR_OF_STEM_MARKER (BR=brown, G=green, BL=black, Y=yellow, GR=gray, BR-N=brown notched, W=white)	
# 	
# NUMBER_BROWSED_CAG_SHOOTS (# Browsed Current Annual Growth Shoots)	
# 	
# NUMBER_UNBROWSED_CAG_SHOOTS (# Unbrowsed Current Annual Growth Shoots)	
# 	
# BROWSED_OR_UNBROWSED (Measured shoot browsed (B) or unbrowsed (U)?)	
# 	
# ADDITIONAL_SHOOT (Additional shoot 1=yes, 0=no)	

```

```{r}
## remove the "DIRECTIONS" tab and create new field for season
offt.raw <- offt.raw %>% 
  filter(str_detect(sheet,pattern = "DIRE",negate = TRUE)) %>% 
  mutate(season = case_when(str_detect(sheet,pattern = "Spring") ~ "spring",
                            str_detect(sheet,pattern = "fall") ~ "fall",
                            TRUE ~ "Oth"))

## extract the year from the sheet name
## 'twig' tabs come out as 'NA'
offt.raw <- offt.raw %>% 
  mutate(yr = as.integer(str_sub(sheet,1,4)))

```

```{r}
#### Stem diameter data
## twig data
twig.raw <- offt.raw %>%
  filter(str_detect(sheet,pattern = "twig")) %>% 
  unnest(cols = data) %>% 
  janitor::clean_names() %>% 
  mutate(date_of_collection = as.Date(as.numeric(date_of_collection), origin = "1899-12-30")) %>% 
  mutate(yr = year(date_of_collection))

## type convert
twig.raw <- twig.raw %>% 
  mutate(across(starts_with("dia"), as.numeric)) %>%
  mutate(across(starts_with("shoot"), as.numeric)) 

```

```{r}
offt.raw.spr <- offt.raw %>%
  filter(season == "spring")

# unnest
offt.raw.spr.tidy <- offt.raw.spr %>%
  unnest(cols = data) %>% 
  janitor::clean_names()

```

```{r}
## Distinct
# offt.raw.spr.tidy %>%
#   filter(dia_base_of_shoot_mm == "0") %>% View()
## Note: not other measurements for these "0" values, so should be NA

######### DEAL WITH NA #############
## Note
na_strings <- c(".", "na", "NA", "N A", "N / A", "N/A", "N/ A", "Not Available", "NOt available")
# 
offt.raw.spr.tidy <- offt.raw.spr.tidy %>%
  naniar::replace_with_na_all(condition = ~.x %in% na_strings)

```

```{r}
## type convert
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  # glimpse()
  mutate_at(.vars = c('number_browsed_cag_shoots','number_unbrowsed_cag_shoots', 'dia_base_of_shoot_mm','dia_tip_of_shoot_mm','shoot_length_cm','total_stem_count', 'shoot_ratio','calculated_count_of_shoots','additional_shoot'),.funs = as.numeric) %>% 
  mutate(site_id = case_when(site_id == "WC1" ~ "WC01",
                       site_id == "WC2" ~ "WC02",
                       site_id == "WC3" ~ "WC03", 
                       site_id == "WC4" ~ "WC04", 
                       site_id == "WC4" ~ "WC04",
                       site_id == "WC5" ~ "WC05",
                       site_id == "WC6" ~ "WC06", 
                       site_id == "WC7" ~ "WC07", 
                       site_id == "WC8" ~ "WC08",
                       site_id == "WC9" ~ "WC09",
                       site_id == "WNC1" ~ "WNC01",
                       site_id == "WNC1" ~ "WNC01",
                       site_id == "WNC2" ~ "WNC02",
                       site_id == "WNC3" ~ "WNC03", 
                       site_id == "WNC4" ~ "WNC04", 
                       site_id == "WNC4" ~ "WNC04",
                       site_id == "WNC5" ~ "WNC05",
                       site_id == "WNC6" ~ "WNC06", 
                       site_id == "WNC7" ~ "WNC07", 
                       site_id == "WNC8" ~ "WNC08",
                       site_id == "WNC9" ~ "WNC09",
                       site_id == "WK1" ~ "WK01",
                       site_id == "WK2" ~ "WK02",
                       site_id == "WK3" ~ "WK03", 
                       site_id == "WK4" ~ "WK04", 
                       site_id == "WK4" ~ "WK04",
                       site_id == "WK5" ~ "WK05",
                       site_id == "WK6" ~ "WK06", 
                       site_id == "WK7" ~ "WK07", 
                       site_id == "WK8" ~ "WK08",
                       site_id == "WK 8" ~ "WK08",
                       site_id == "WNC 32" ~ "WNC32",
                       site_id == "WK9" ~ "WK09",
                       TRUE ~ as.character(site_id))
  )

## eliminate duplicates across all variables
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  distinct()


```

```{r, eval=FALSE}
# qa
offt.raw.spr.tidy %>% 
  visdat::vis_dat()

# all the NA for plant id is in 2009; all the NA for color of stem marker in 2009
offt.raw.spr.tidy %>% 
  tabyl(plant_id_number, yr)

offt.raw.spr.tidy %>%
  tabyl(color_of_stem_marker, yr)

```

```{r}
## clean plant id
## add a plant id value from stem color (2009 only)
offt.raw.spr.tidy %>% 
  mutate(plant_id_number = case_when(color_of_stem_marker == "BL" ~ "1",
                                     color_of_stem_marker == "BR" ~ "2",
                                     color_of_stem_marker == "G" ~ "3",
                                     color_of_stem_marker == "GR" ~ "4",
                                     color_of_stem_marker == "NR" ~ "5",
                                     color_of_stem_marker == "Y" ~ "6",
                                     TRUE ~ plant_id_number)) 

```

```{r, eval=FALSE}
## these sheets are missing basal diameters
offt.raw.spr.tidy %>% 
  filter(is.na(dia_base_of_shoot_mm)) %>% 
  datatable()

```

```{r}
#### clean up site_id

offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  mutate(site_id = case_when(
    site_id == "WC 39" ~ "WC39",
    site_id == "WC 50" ~ "WC50",
    TRUE ~ site_id)) 

```

```{r, eval=FALSE}
## checking that row names are consistent across yr values
offt.raw.spr.tidy %>%
  nest_by(yr) %>% 
  rowwise(yr) %>% 
  mutate(l = length(data)) %>% 
  mutate(names = list(names(data))) %>% 
  unnest(names) %>% 
  tabyl(names, yr)

```

```{r, eval=TRUE}
### Offtake combine baseline and master
## prep BL for rbind

## rename cols in bl
lz.bl.fasp <- lz.bl.fasp %>% 
  rename(dia_base_of_shoot_mm = diameter_at_base_of_shoot_mm) %>% 
  rename(dia_tip_of_shoot_mm = diameter_at_tip_of_shoot_mm) %>% 
  rename(number_unbrowsed_cag_shoots = number_unbrowsed_current_annual_growth_shoots) %>% 
  rename(number_browsed_cag_shoots =	
number_browsed_current_annual_growth_shoots) %>%
  rename(browsed_or_unbrowsed = measured_shoot_browsed_b_or_unbrowsed_u)

offt.raw.spr.tidy <- offt.raw.spr.tidy %>%
  mutate(site_number = as.numeric(site_number))

```

```{r, eval=FALSE}
## compare
janitor::compare_df_cols(lz.bl.fasp,offt.raw.spr.tidy) %>% 
  View()


offt.raw.spr.tidy %>% 
  visdat::vis_dat()
```

```{r}
## combine the baseline observations from the separate LZ import (data apparently not in the 10yr review files)

## add columns to track things more easily
lz.bl.fasp <- lz.bl.fasp %>% 
  mutate(source = "LZBL") ## baseline

offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  mutate(source = "10yrReview")

## row bind
offt.raw.spr.tidy <- bind_rows(offt.raw.spr.tidy, lz.bl.fasp)


```

```{r}
## standardize site id
## this is done for the 10yr update-derived object, but not th LZ BL
offt.raw.spr.tidy <- offt.raw.spr.tidy %>%
  mutate(site_id = str_remove(site_id,"-")) %>% 
  mutate(site_id = case_when(site_id == "WNC1" ~ "WNC01",
  site_id == "WNC2" ~ "WNC02",
  site_id == "WNC3" ~ "WNC03",
  site_id == "WNC4" ~ "WNC04",
  site_id == "WNC5" ~ "WNC05",
  site_id == "WNC6" ~ "WNC06",
  site_id == "WNC7" ~ "WNC07",
  site_id == "WNC8" ~ "WNC08",
  site_id == "WNC9" ~ "WNC09",
  site_id == "WC1" ~ "WC01",
  site_id == "WC2" ~ "WC02",
  site_id == "WC3" ~ "WC03",
  site_id == "WC4" ~ "WC04",
  site_id == "WC5" ~ "WC05",
  site_id == "WC6" ~ "WC06",
  site_id == "WC7" ~ "WC07",
  site_id == "WC8" ~ "WC08",
  site_id == "WC9" ~ "WC09",
  TRUE ~ site_id))

##  remove "dead" and "0" species code
offt.raw.spr.tidy <- offt.raw.spr.tidy %>%
  filter(species_code != "DEAD") %>%
  filter(species_code != '0') %>% 
  mutate(species_code = toupper(.$species_code))

# reclass "SA-" to "SAXX" 
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  mutate(species_code = case_when(species_code == "SA-" ~ "SAXX",
                                  TRUE ~ species_code))

```

```{r}
# more cleaning.  Many fields are not used (mostly NA) and not used in calcs so removed here
offt.raw.spr.tidy <- offt.raw.spr.tidy %>%
  select(-c(unique_site_id, color_of_stem_marker, path, calculated_count_of_shoots, contains("number_"))) 

```

```{r}
#### Create unique stem id
## Create unique stem id
## This follows directions in appendix 7 of Zeigenfuss 2011. NOTE: there are many incomplete fields...
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  mutate(stid = paste0(site_id,"-",microplot_location,"-",plant_id_number,"-", stem_id_letter))

## adding species code to stid
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  mutate(stid.sppcode = paste0(site_id,"-",microplot_location,"-",plant_id_number,"-", stem_id_letter,"-", species_code))

# offt.raw.spr.tidy %>% 
#   select(yr, site_id, stid, stid.sppcode) %>% 
#   tabyl(site_id, yr) %>% 
#   View()

## diagnose and fix issues with b/u
 
offt.raw.spr.tidy %>% 
  tabyl(browsed_or_unbrowsed) %>% 
  # distinct(browsed_or_unbrowsed) %>% 
  gt() %>% 
  tab_header("Distinct 'browsed_unbrowsed",subtitle = "need to standardized encoding and deal with NA")

offt.raw.spr.tidy <- offt.raw.spr.tidy %>%
  mutate(browsed_or_unbrowsed = case_when(
    str_detect(browsed_or_unbrowsed,pattern = "u") ~ "U", 
    str_detect(browsed_or_unbrowsed,pattern = "b") ~ "B",              
                            TRUE ~ browsed_or_unbrowsed))

### clean: 0 browsed doesn't make sense

offt.raw.spr.tidy <- offt.raw.spr.tidy %>%
  filter(browsed_or_unbrowsed != "0") %>% 
  filter(!is.na(browsed_or_unbrowsed)) %>%
  filter(browsed_or_unbrowsed != "NA") 

```

```{r}
### Missing plant id
offt.raw.spr.tidy %>% 
  filter(is.na(plant_id_number)) %>% 
  select(sheet,  yr, plant_id_number) %>% 
  tabyl(sheet) %>% 
  gt() %>% 
  tab_header(title = "No plant id for these records in the orignal data")

## based on above, will try another stid with spp
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  mutate(stid.alt = paste0(site_id,"-",microplot_location,"-", species_code))

```

```{r, eval = FALSE}
# There is little consistency in the format of data entry between years...
## qc
offt.raw.spr.tidy %>% 
  visdat::vis_dat()

## qc tables
offt.raw.spr.tidy %>% 
  tabyl(yr, site_id) %>% 
  gt()

offt.raw.spr.tidy %>% 
  tabyl(yr, sheet) %>% 
  gt()

offt.raw.spr.tidy %>% 
  tabyl(yr, browsed_or_unbrowsed) %>% 
  gt()

offt.raw.spr.tidy %>% 
  tabyl(yr, stid) %>% 
  gt()

```

```{r, eval=FALSE}
#### Tally u and b
offt.raw.spr.tidy %>%
  tabyl(yr,season)

## limited fall data
```

```{r}
### FILTER to only spring data
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  filter(season == "spring")

```

```{r}
# distinct records across all fields
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  distinct()

#### Tally u and b
### new object
offt.cln <- offt.raw.spr.tidy %>% 
  group_by(site_id, stid, yr, browsed_or_unbrowsed) %>% 
  mutate(stem.tally = n()) %>% 
  ungroup()

## replacing NA for 'additional shoot' with 0 as this seems implied
offt.cln <- offt.cln %>% 
  mutate(additional_shoot = replace_na(additional_shoot, 0))

```

```{r}
## remove some apparent duplicates
offt.cln <- offt.cln %>%
  select(-c(sheet,source)) %>% 
  distinct()

```

```{r, eval=FALSE}
offt.cln %>% 
  View()
```

```{r}
#### Multiply the stem tally by shoot ratio
## shoot ratio has problems...

#### Address issues with 'shoot ratio'
# Missing shoot ratio. Making these '1'
# replacing '0' with '1'. Why? As multiplier with count, will be '0' if count is zero.

offt.cln <- offt.cln %>% 
  mutate(shoot_ratio = replace_na(shoot_ratio, 1)) %>% 
  mutate(shoot_ratio = case_when(
    shoot_ratio == 0 ~ 1,
    TRUE ~ shoot_ratio
  ))

## assume shoot ratio of 33 is 3; reclass
offt.cln <- offt.cln %>% 
  mutate(shoot_ratio = case_when(
    shoot_ratio == 33 ~ 3,
    TRUE ~ shoot_ratio
  ))

## clean records based on comments
offt.cln <- offt.cln %>%
  filter(comments != "Shouldn't analyze this plot with offtake - it is fenced")

## list of comments
# offt.cln %>% 
#   filter(!is.na(comments)) %>% 
#   select(sheet,site_id,yr, comments) %>% 
#   datatable()

```

```{r}
## multiply the stem tally by shoot ratio 
offt.cln <- offt.cln %>% 
  mutate(total_bu_pre_addshoot = stem.tally*shoot_ratio) %>% 
  mutate(total_bu = total_bu_pre_addshoot + additional_shoot)

```

```{r}
## join in the site info
site.info.cleannames <- site.info.clean %>% 
  clean_names()

offt.cln <- left_join(offt.cln, site.info.cleannames, by = "site_id")

##########
### Removed plots have been carried over
site.info.fenced.burned <- site.info.clean %>% 
  clean_names() %>% 
  select(site_id, fenced, burned)

offt.cln <- offt.cln %>% 
  select(-fenced, -burned)

offt.cln <- left_join(offt.cln,site.info.fenced.burned, by = "site_id")

```

```{r, eval = FALSE}

###
offt.cln %>% 
  # filter(!is.na(plant_id_number)) %>% 
  tabyl(site_id, yr) %>% 
  gt()
#######   need to find 2009! a little 2014 too have missing plant id

offt.cln %>% 
  visdat::vis_dat()
```

```{r}

## calc total number of stems (b + u)
offt.cln <- offt.cln %>% 
  group_by(stid, yr) %>% 
  mutate(tot_allstems_per_shoot = sum(total_bu)) %>%   ungroup()


#qa
# offt.cln %>%
#   slice_sample(n = 25) %>% 
#   gt()


offt.cln <- offt.cln %>% #names() 
  group_by(stid, yr) %>% 
  mutate(sum_bu_per_stem = sum(total_bu)) %>% 
  ungroup() 

## calc the % of shoots browsed per STEM (step 2a n Zeigenfuss 2011)
offt.cln <- offt.cln %>% 
  mutate(percent_bu_per_stem = total_bu/sum_bu_per_stem) %>%
  mutate(percent_bu_per_stem = round(percent_bu_per_stem,3)) 

```

```{r}
## fix species code
## eliminate "DEAD" species
offt.cln <- offt.cln %>%
  filter(species_code != "DEAD") %>%
  # filter(species_code != "0") %>% 
  mutate(species_code = case_when(
    species_code == "Sabe" ~ "SABE",
    species_code == "Sage" ~ "SAGE",
    species_code == "Samo" ~ "SAMO",
    species_code == "SA-" ~ "SAXX",
    TRUE ~ species_code
  ))

```

```{r}
# offt.cln %>% 
#   mutate(time_class = case_when(yr == 2008 ~ "BL",
#                               yr == 2009 ~ "BL", 
#                               TRUE ~ as.character(yr))) %>% 
#   mutate(time_class = as.factor(time_class)) %>%
#   tabyl(time_class)
#   mutate(time_class = fct_relevel(time_class, "2018", "2013", "BL"))

## add timeclass

### summary plots
# select just the browsed stems
offt.percbrowsed <- offt.cln %>% 
  filter(browsed_or_unbrowsed == "B") %>% 
  select(c(yr, site_type, site_id, species_code, stid, sum_bu_per_stem, percent_bu_per_stem, fenced, range_type)) %>% 
  distinct()
  

offt.percbrowsed %>% 
  group_by(yr, site_id, fenced, range_type) %>% 
  summarytools::descr(percent_bu_per_stem) %>% 
  tb() %>% 
  datatable()
  
## qc
# offt.cln %>%
#   group_by(yr,site_id, stid) %>% 
#   summarytools::descr(percent_bu_per_stem,
#                       stats = "common") %>% 
#   tb() %>% 
#   gt()

offt.cln %>% 
  # filter(site_id == "WC12" | yr == 2009) %>% 
  ggplot(aes(reorder(site_id, percent_bu_per_stem),percent_bu_per_stem)) +
  geom_col(aes(fill = browsed_or_unbrowsed)) +
  facet_wrap(~yr)
           

```

```{r}
## offtake
offt.percbrowsed %>%
  ggplot(aes(x = as_factor(yr), y = percent_bu_per_stem)) +
  geom_boxplot(fill = "ivory2", outlier.shape = NA) +
  labs(x = "Year",y = "% leader use") +
  # facet_wrap(~site_type) +
  facet_grid(fenced~site_type) +
  theme_minimal() +
  scale_y_continuous(labels=scales::percent)

offt.percbrowsed %>% 
  ggplot(aes(x = as_factor(yr), y = percent_bu_per_stem)) +
  geom_boxplot(fill = "ivory2", outlier.shape = NA) +
  labs(x = "Year",y = "% leader use") +
  facet_wrap(~site_type) +
  theme_minimal() +
  scale_y_continuous(labels=scales::percent)

offt.percbrowsed %>% 
  ggplot(aes(x = percent_bu_per_stem, y = as_factor(yr))) +
  ggridges::geom_density_ridges(rel_min_height = 0.005,panel_scaling = TRUE) +
  # scale_y_discrete(expand = c(0.01, 0)) +
  # scale_x_continuous(expand = c(0.01, 0)) +
  theme_minimal() +
  labs(x = "% leader use", y = "", caption = "all species") +
  # scale_y_continuous(labels=scales::percent) +
  facet_wrap(~site_type) +
  scale_x_continuous(labels=scales::percent,limits = c(0,1))


offt.percbrowsed %>% 
  ggplot(aes(x = percent_bu_per_stem, y = as_factor(yr))) +
  # ggridges::geom_density_ridges(rel_min_height = 0.005,panel_scaling = TRUE) +
  geom_boxplot() +
  # scale_y_discrete(expand = c(0.01, 0)) +
  # scale_x_continuous(expand = c(0.01, 0)) +
  theme_minimal() +
  labs(x = "% leader use", y = "", caption = "all species") +
  # scale_y_continuous(labels=scales::percent) +
  # facet_wrap(~site_type) +
  facet_grid(site_type~fenced) +
  scale_x_continuous(labels=scales::percent,limits = c(0,1))


# ggsave("./output/figures_202107/ggridge_percleaderuse_site_type_20200602.png", width = 8.5, height = 6, dpi = 300)

offt.percbrowsed %>%
  filter(site_type != "WK") %>% 
  ggplot(aes(y = percent_bu_per_stem)) +
  geom_histogram() +
  # theme_minimal() +
  theme_minimal() +
  labs(y = "% leader use", x = "count", caption = "all species") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # facet_grid(as_factor(yr) ~site_type)
  facet_grid(site_type ~ as_factor(yr)) +
  scale_y_continuous(labels=scales::percent,limits = c(0,1))
  # facet_wrap(~site_type, scales = "free_x") 

# ggsave("./output/figures_202107/histo_percleaderuse_wc_wnc_20200602.png", width = 9.5, height = 4.5, dpi = 300)

offt.percbrowsed %>% 
  ggplot(aes(x = percent_bu_per_stem)) +
  # geom_histogram() +
  geom_density(aes(color = as_factor(yr))) +
  facet_wrap(~site_type) +
  theme_minimal() +
  labs(x = "% leader use", y = "") +
  scale_x_continuous(labels=scales::percent,limits = c(0,1))

# WC density  
offt.percbrowsed %>% 
  filter(site_type == "WC") %>%
  ggplot(aes(x = percent_bu_per_stem)) +
  # geom_histogram() +
  geom_density(aes(color = as_factor(yr))) +
  facet_wrap(~site_type) +
  theme_minimal() +
  labs(x = "% leader use", y = "", color = "") +
  scale_x_continuous(labels=scales::percent,limits = c(0,1))

# ggsave("./output/figures_202107/desnity_percleaderuse_wc_20200602.png", width = 4.5, height = 3.75, dpi = 300)

# WNC density  
offt.percbrowsed %>% 
  filter(site_type == "WNC") %>%
  ggplot(aes(x = percent_bu_per_stem)) +
  # geom_histogram() +
  geom_density(aes(color = as_factor(yr))) +
  facet_wrap(~site_type) +
  theme_minimal() +
  labs(x = "% leader use", y = "", color = "") +
  scale_x_continuous(labels=scales::percent,limits = c(0,1))

# ggsave("./output/figures_202107/density_percleaderuse_wnc.png", width = 4.5, height = 3.75, dpi = 300)

```


```{r, eval=FALSE}
### summary by site
offt.percbrowsed.summary <- offt.percbrowsed %>% 
  group_by(yr, site_id) %>% 
  summarytools::descr(var = percent_bu_per_stem, stats = "common") %>% 
  summarytools::tb() %>% 
  mutate(across(where(is.numeric), round, 1))

# make plot based
offt.percbrowsed.summary <- offt.percbrowsed %>%
  group_by(yr, site_type) %>%
  summarytools::descr(var = percent_bu_per_stem, stats = "common") %>%
  summarytools::tb() %>%
  mutate(across(where(is.numeric), round, 1))

offt.percbrowsed.summary %>% 
  gt() %>% 
  tab_header(title = "Willow Offtake (% leader use)") 

```

```{r, eval=FALSE}

offt.percbrowsed.summary %>%
  ggplot(aes(yr, med)) +
  geom_col(fill = 'grey60') +
  facet_wrap(~site_type) +
  theme_minimal()

## percent browsed looks odd last 4 yrs
```

```{r}
#### Percent browsed
## yr x for combined WC and WNC site type

offt.percbrowsed.summary.allRange <- offt.percbrowsed %>% 
  mutate(percent_bu_per_stem = percent_bu_per_stem*100) %>%
  filter(site_type == "WC" | site_type == "WNC") %>%   group_by(yr) %>% 
  summarytools::descr(var = percent_bu_per_stem, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, Year = yr)

offt.percbrowsed.summary.allRange %>% 
  gt() %>% 
  tab_header(title = "Willow Offtake (% leader use) WC & WNC plots") %>% 
  fmt_number(
    columns = 2:11,
    decimals = 1,
    suffixing = TRUE
  ) # %>% 
  # gtsave("./output/tables/WillowPercOfft_WCplusWNC.rtf")

```

```{r}
## yr x for combined WC and WNC site type

offt.percbrowsed.summary.allRange.fen <- offt.percbrowsed %>% 
  mutate(percent_bu_per_stem = percent_bu_per_stem*100) %>%
  filter(site_type == "WC" | site_type == "WNC") %>%   group_by(yr, fenced) %>% 
  summarytools::descr(var = percent_bu_per_stem, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, Year = yr)

offt.percbrowsed.summary.allRange.fen %>% 
  gt() %>% 
  tab_header(title = "Willow Offtake (% leader use) WC & WNC plots") %>% 
  fmt_number(
    columns = 3:11,
    decimals = 1,
    suffixing = TRUE
  ) # %>% 
  # gtsave("./output/tables/WillowPercOfft_WCplusWNC.rtf")
```

```{r}
## yr x site type
offt.percbrowsed.summary <- offt.percbrowsed %>% 
  mutate(percent_bu_per_stem = percent_bu_per_stem*100) %>% 
  group_by(yr, site_type) %>% 
  summarytools::descr(var = percent_bu_per_stem, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, Year = yr, 'Site type' = site_type)

## WC and WNC
offt.percbrowsed.summary %>% 
  filter(`Site type` == "WC" | `Site type` == "WNC") %>% 
  gt() %>% 
  tab_header(title = "Willow Offtake (% leader use)") %>% 
  fmt_number(
    columns = 3:11,
    decimals = 1,
    suffixing = TRUE
  ) # %>% 
  # gtsave("./output/tables/WillowPercOfft_WC_WNC_yrxsite_type.rtf")

```

**Calculate DD1, the avg proportion of shoot consumed per stem (step 3
in Zeigenfuss 2011)**

DD1 = (Dp - Dt)/(Db -Dt)

Dp = shoot diameter at point of browsing Dt = Avg diam of of unbrowsed
stems Db = diamter at base of shoot

```{r}
## Calculate: 
## Dp = shoot diameter at point of browsing &
## Db = diamter at base of shoot
offt.cln <- offt.cln %>%
  mutate(Db = dia_base_of_shoot_mm) %>% 
  mutate(Dp = dia_tip_of_shoot_mm)

## calculate Dt - Avg diam of of unbrowsed stems  
Dt.table <- offt.cln %>% 
  filter(browsed_or_unbrowsed == "U") %>% 
  group_by(stid, yr) %>% 
  summarise(Dt = mean(Dp, na.rm = TRUE)) %>% 
  ungroup()
  
## Dtsite
Dtsite.table <- offt.cln %>% 
  filter(browsed_or_unbrowsed == "U") %>% 
  group_by(site_id, species_code, yr) %>% 
  summarise(Dtsite = mean(Dp, na.rm = TRUE)) %>% 
  ungroup()

## Dtspecies
Dtspp.table <- offt.cln %>% 
  filter(browsed_or_unbrowsed == "U") %>% 
  group_by(species_code, yr) %>% 
  summarise(Dtspp = mean(Dp, na.rm = TRUE)) %>% 
  mutate(Dtspp = case_when(
    species_code == "SALA" ~ 0.748, # setting to Dt of SAXX, since there are NaN for SALA and SAWO
    species_code == "SAWO" ~ 0.748,
    TRUE ~ Dtspp
  )) %>% 
  ungroup()

## join in the Dt values
offt.cln.br <- offt.cln %>% 
  filter(browsed_or_unbrowsed == "B") %>% 
  left_join(.,Dt.table)

## join Dtsite for BROWSED
offt.cln.br <- offt.cln %>% 
  filter(browsed_or_unbrowsed == "B") %>%
  left_join(.,Dtsite.table)

## join in Dtspp for BROWSED
offt.cln.br <- offt.cln %>% 
  filter(browsed_or_unbrowsed == "B") %>%
  left_join(.,Dtspp.table)

offt.cln.br %>%
  visdat::vis_dat(warn_large_data = FALSE)

```

```{r, eval=FALSE}
# cont below

## IF Dt is NA after sub in Dtsite (if available. Will still be Na, but fewer)
offt.cln.br <- offt.cln.br %>%
  mutate(Dtadj = case_when(
    is.na(Dt) ~ Dtsite,
    TRUE ~ Dt
    )
  )
## IF Dt is still NA after subbing in Dtsite, replace with Dtspp
offt.cln.br <- offt.cln.br %>%
  mutate(Dtadj = case_when(
    is.na(Dtadj) ~ Dtspp,
    TRUE ~ Dtadj
    )
  )

## if Dt is negative or greater than zero (part 3 in Zeigenfuss 2011). Where Dt is < Dtspp, replace with Dtspp
offt.cln.br <- offt.cln.br %>%
  mutate(Dtadj = case_when(
    Dt <= Dtspp ~ Dtspp,
    TRUE ~ Dtadj
    )
  )

## covert values >1 to 1 (can't have more than 100%) -- see Zeigenfuss
offt.cln.br <- offt.cln.br %>%
  mutate(Dtadj = case_when(
    Dtadj > 1 ~ 1,
    TRUE ~ Dtadj
    )
  )

# offt.cln.br %>% 
#   summarytools::descr(Dtadj) %>% 
#   summarytools::tb()


```

```{r, eval=FALSE}
# DD1stem >>>
### calc DD1
offt.cln.br %>% names()

offt.cln.br <- offt.cln.br %>%
  group_by(stid, yr) %>% 
  mutate(DD1 = ((Dp - Dtadj)/(Db - Dtadj))) %>% 
  ungroup()

offt.cln.br %>% 
  filter(!is.na(DD1)) %>% 
  summarytools::descr(DD1,na.rm = TRUE)

```

```{r, eval = FALSE}
## Notes for above from Ziegenfuus 2011
## There are some cases where no unbrowsed shoots were measured on an individual stem and thus an average unbrowsed tip diameter (Dt) for the stem cannot be calculated. In this case, an average unbrowsed tip diameter for all the stems of a particular species within a site is calculated (Dtsite) and then substituted for Dt. If there were no unbrowsed shoots of a species found within an individual site, then an average unbrowsed shoot tip can be calculated from all shoot measurements of that species (Dtsp) that were collected from other willow-monitoring sites measured within the same year and this average is substituted for Dt.

```

```{r, eval = FALSE}
## calc the % of shoots per site and year (step 2b in Z 2011)
offt.cln.site.allwillow <- offt.cln %>%
  group_by(site_id, species_code)
  
## calc the proporation of browsed/unbrowsed stems out of total
offt.cln <- offt.cln %>% 
  mutate(perc_bu_shoots = total_bu/tot_allstems*100)

browsed_percent <- a.stid.cnt.bu %>% 
  filter(browsed_or_unbrowsed == "B") %>% 
  dplyr::select(stid, yr, species_code, browsed_or_unbrowsed, perc_bu_shoots)

offt.cln.spr.tidy <- offt.cln.spr.tidy %>%   
  filter(is.na(shoot_ratio))
  tabyl(shoot_ratio)
  
## try some cleaning
offt.cln.spr.tidy <- offt.raw.spr.tidy %>% 
  filter(!is.na(dia_tip_of_shoot_mm))  
```

```{r, eval=FALSE}
offt.raw.spr.tidy %>% 
  names()
    
##### define function
# dd2 = function(df){
#   b = df$number_browsed_cag_stems
#   u = df$number_unbrowsed_cag_stems
#   Dp = df$
# } 
```

```{r}
# 'number_browsed_cag_shoots','number_unbrowsed_cag_shoots', 'dia_base_of_shoot_mm','dia_tip_of_shoot_mm','shoot_length_cm','total_stem_count'
```

```{r, eval = FALSE, echo=FALSE}
###### Get the names of the macroplot tabs as vector with datapasta
wo.d %>% 
  names() %>% 
  as.tibble() %>% 
  filter(str_detect(value, 'Macroplot')) # copy from clipboard and paste as vector

### Extract out just the macroplot tabs
mp.list <- purrr::map(c("z2008-09 Macroplot Baseline",
  "z2013 Macroplot Inventory",
  "z2015 Macroplot Inventory",
  "z2016 Macroplot Inventory",
  "z2017 Macroplot Inventory",
  "z2018 Macroplot Inventory"),
  ~ wo.d[.]) 

# get the names of df. Note use of the 'at_depth' argument to dial into the second level of the list
df.names <- mp.list %>% 
  at_depth(2, names) %>% 
  at_depth(2, tibble)

# df.names %>% 
#   at_depth(2,walk(.,View)) # this sort of works, but b/c of the nested lists, not useful

###### UNLIST!!!!! #####
new.pp <- unlist(df.names,recursive=FALSE)

# walk(new.pp,View) # this works! Opens a View portal for each list item 
# walk(new.pp,print) # prints each list item to console
# the takehome is there are different number of columns in each tab!
# can't combine

df.names %>% 
  at_depth(2,map_df(.,rbind))


##################
# purrr::map(c(#"2008-09 Macroplot Baseline",
#   "2013 Macroplot Inventory",
#   "2015 Macroplot Inventory",
#   "2016 Macroplot Inventory",
#   "2017 Macroplot Inventory",
#   "2018 Macroplot Inventory"),
#   ~ wo.d[.]) 

```

```{r, echo=FALSE}
# Rewrite the SAS program used to analyze willow height data as found in table 9 of Zeigenfuss and Johnson (2015)--Least squares means of average and maximum willow height and percent willow cover on burned sites compared to unburned sites using the macroplot method at EVMP willow monitoring sites in Rocky Mountain National Park, Colorado. 
# 
# **Steps:** 
# 1. Read in data from a file containing the baseline data from willow macroplots  
# 2. Calculate canopy area for each plot and assigns the baseline year (2008) to these data 
# 3. Sort data down to willow and non-willow species groups and calculates mean for the variables "average height" and "maximum ht" for each group.

```

### Beaver and Moose Presence

The following plots and tables summarize the beaver and moose presence
observation for 2018

```{r beaver18, eval=TRUE}

#### Observations of beaver presence noted in plots 
# How best to use these obserations? 
# 
# **Variable: BEAVER_PRESENCE**

sinfo.df %>%
  mutate(BEAVER_PRESENCE = recode(BEAVER_PRESENCE, 
                         "Absence_" = "Absence",
                         "Food_cache_cuttings"="Cuttings")) %>% 
  tabyl(BEAVER_PRESENCE) %>% 
  gt::gt() %>% 
  fmt_number(
    columns = vars(percent),
    decimals = 2
    )

sinfo.df %>%
  mutate(BEAVER_PRESENCE = recode(BEAVER_PRESENCE, 
                         "Absence_" = "Absence",
                         "Food_cache_cuttings"="Cuttings")) %>%
  group_by(BEAVER_PRESENCE) %>%
  tally()

bv.tally <- sinfo.df %>%
  mutate(LOCATION = case_when(is.na(LOCATION) & SITE_TYPE == "WK" ~ "Kawuneeche",
                              TRUE ~ LOCATION))%>%
  mutate(LOCATION = str_replace(LOCATION, "_", " ")) %>%
  mutate(LOCATION = str_replace(LOCATION, "_", " ")) %>% 
  mutate(BEAVER_PRESENCE = recode(BEAVER_PRESENCE, 
                         "Absence_" = "Absence",
                         "Food_cache_cuttings"="Cuttings")) %>%
  group_by(LOCATION) %>% 
  mutate(n_site = n()) %>% 
  ungroup()

bv.tally %>% 
  group_by(LOCATION, BEAVER_PRESENCE, n_site) %>%
  tally() %>% 
  ggplot(aes(x = reorder(LOCATION, n_site), y = n)) +
  geom_col(aes(fill = BEAVER_PRESENCE)) +
  coord_flip() +
  labs(x = "", y = "Number of plots", fill = "", caption = "2018 Beaver presence") +
  scale_fill_manual(values = c("ivory3", "cyan3")) +
  theme_minimal()

ggsave("./output/figures_202107/beaver_presence01.png", width = 6.25, height = 3.75, dpi=300)

  
bv.tally %>% 
  group_by(LOCATION, BEAVER_PRESENCE, n_site) %>%
  tally() %>% 
  ungroup() %>% 
  mutate(perc.cut = n/n_site*100) %>% 
  filter(BEAVER_PRESENCE == "Cuttings")

```

```{r, echo=FALSE, eval=FALSE}
#vtree status
sinfo.df %>%
  mutate(BEAVER_PRESENCE = recode(BEAVER_PRESENCE, 
                         "Absence_" = "Absence",
                         "Food_cache_cuttings"="Cuttings")) %>% 
  vtree::vtree(z = .,vars = "LOCATION BEAVER_PRESENCE")

sinfo.df %>%
  filter(LOCATION == "Moraine_Park") %>% 
  mutate(BEAVER_PRESENCE = recode(BEAVER_PRESENCE, 
                         "Absence_" = "Absence",
                         "Food_cache_cuttings"="Cuttings")) %>% 
  vtree::vtree(z = .,vars = "LOCATION FENCED BURNED")
```

```{r}
bv.mcro <- csv.all.lc.mcro.df %>% 
  mutate(BEAVER_PRESENCE = recode(BEAVER_PRESENCE, 
                         "Absence_" = "Absence",
                         "Food_cache_cuttings"="Cuttings")) 

bv.mcro %>% 
  distinct(BEAVER_PRESENCE)

bv.mcro.sum <- bv.mcro %>% 
  select(SITE_ID, timeClass,BEAVER_PRESENCE,LOCATION, SITE_TYPE) %>%
  distinct() %>% 
  group_by(timeClass,BEAVER_PRESENCE, SITE_TYPE) %>%
  tally() %>% 
  ungroup() %>% 
  pivot_wider(names_from = BEAVER_PRESENCE, values_from = n) %>%
  mutate(perc.cuttings = 100* Cuttings/(Cuttings + Absence)) %>% 
  mutate(perc.abs = 100 - perc.cuttings)

bv.mcro.sum %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  arrange(desc(SITE_TYPE,timeClass)) %>% 
  gt()
  

```

```{r}

# sinfo.df %>% 
#   distinct(MOOSE_PRESENCE)

# inconsistent encoding of MOOSE_PRESENCE 

# # A tibble: 10 x 1
#    MOOSE_PRESENCE             
#    <chr>                      
#  1 Absence_                   
#  2 Browse                     
#  3 Browse/Tracks              
#  4 Browse_tracks              
#  5 Tracks                     
#  6 Scat_beds_                 
#  7 Browse_scat_tracks         
#  8 Browse_scat                
#  9 Scat                       
# 10 Browse_scat_tracks_sighting

sinfo.df <- sinfo.df %>%
  mutate(MOOSE_PRESENCE2 = recode(MOOSE_PRESENCE, 
                         "Absence_" = "Absence",
                         "Browse_tracks"="Presence",
                         "Browse/Tracks"="Presence",
                         "Browse_scat"="Presence",
                         "Browse_scat_tracks"="Presence",
                         "Browse_scat_tracks_sighting" = "Presence",
                         "Scat_beds_" = "Presence"
                         )) %>% 
  mutate(MOOSE_PRESENCE = recode(MOOSE_PRESENCE, 
                         "Absence_" = "Absence",
                         "Browse_tracks"="Browse/tracks",
                         "Browse/Tracks"="Browse/tracks",
                         "Browse_scat"="Browse/scat",
                         "Browse_scat_tracks"="Browse/scat/tracks",
                         "Browse_scat_tracks_sighting" = "Browse/scat/tracks/sighting",
                         "Scat_beds_" = "Scat/beds"
                         )) 

sinfo.df %>% 
  tabyl(MOOSE_PRESENCE) %>%
  rename('Moose presence' = 'MOOSE_PRESENCE') %>% 
  gt::gt() %>% 
  fmt_number(
    columns = vars(percent),
    decimals = 2
    ) %>% 
  tab_header(
    title = "Moose presence in 2018"
  )

# sinfo.df %>%
#   tabyl(MOOSE_PRESENCE2) %>%
#   rename('Moose presence' = 'MOOSE_PRESENCE2') %>% 
#   gt::gt() %>% 
#   fmt_number(
#     columns = vars(percent),
#     decimals = 2
#     ) %>% 
#   tab_header(
#     title = "Moose presence in 2018"
#   )

```

```{r Moose, eval=TRUE}
#### Observations of moose presence noted in plots
# > How best to use these obserations? 
# **Variable: MOOSE_PRESENCE**


mcro.moose <- csv.all.lc.mcro.df %>% 
  mutate(moose = case_when(MOOSE_PRESENCE == "Absence_" ~ "Absent",
                           MOOSE_PRESENCE != "Absent" ~ "Present",
                           TRUE ~ MOOSE_PRESENCE))

mcro.moose.tally <- mcro.moose %>% 
  select(c(SITE_ID, moose, yr, LOCATION, BURNED, FENCED, timeClass)) %>% 
  distinct() %>% 
  group_by(timeClass, LOCATION) %>% 
  mutate(n_plots_in_loc = n()) %>% 
  ungroup() 

mcro.moose.tally <- mcro.moose.tally %>%
  filter(!is.na(LOCATION)) %>%
  group_by(timeClass, moose, LOCATION, n_plots_in_loc) %>% 
  # mutate(n_plots_in_loc_sign = n()) %>% 
  tally() %>%
  ungroup() %>%
  mutate(perc_moose = n/n_plots_in_loc * 100) 

mcro.moose.tally.n <- mcro.moose.tally %>% 
  group_by(timeClass, moose, LOCATION) %>%
  tally() %>% 
  ungroup()
```

```{r}
## moose plotting
mcro.moose.tally %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(LOCATION != "Kawuneeche") %>% 
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  ggplot(aes(x = timeClass, y = perc_moose, color="grey80")) +
  geom_col(aes(fill = moose), width = .7) +
  facet_wrap(~LOCATION, ncol = 3) +
  theme_minimal() +
  labs(x = "", y = "% plots", fill = "") +
  scale_fill_manual(values = colfunc3(2))
  # scale_fill_manual(values = c("ivory3", "cyan3"))

ggsave("./output/figures_202107/moose_presence_absence01.png", width = 6.25, height = 3.75, dpi=300)

# mcro.moose.tally %>%
#   filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
#   filter(LOCATION != "Kawuneeche") %>% 
#   filter(moose =="Present") %>% 
#   mutate(timeClass = forcats::fct_rev(timeClass))%>%
#   ggplot(aes(x = timeClass, y = perc_moose)) +
#   geom_col(aes(fill = moose), width = 0.7, color = "grey80") +
#   facet_wrap(~LOCATION, ncol = 3) +
#   theme_minimal() +
#   labs(x = "", y = "% plots", fill = "") +
#   scale_fill_manual(values = colfunc2(2)) +
#   # scale_fill_manual(values = c("ivory4", "blue")) +
#   theme(legend.position = "none") 
#   
# ggsave("./output/figures_202107/moose_presence01.png", width = 6.25, height = 3.75, dpi=300)

mcro.moose.tally %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  mutate(across(where(is.numeric), round, 1)) %>% 
  datatable()


csv.all.lc.mcro.df %>% 
  group_by(SITE_ID, MOOSE_PRESENCE, yr) %>% 
  filter(MOOSE_PRESENCE != "Absence_") %>%
  tally() %>% 
  dplyr::select(-n) %>% 
  datatable()

```

## Aspen data

**Master excel file: Aspen_Data_Baseline_through_2018.xlsx**\
The excel datafile provided by RMNP
(Aspen_Data_Baseline_Through_2018.xlsx) includes **10 tabs**.

```{r}
## **Data import** 
asp <- readxl::excel_sheets("./data/EVMP_data/TenYearReview/Aspen_Data_Baseline_Through_2018.xlsx")
path <- ("data/EVMP_data/TenYearReview/Aspen_Data_Baseline_Through_2018.xlsx")

#### Read in the worksheets and create list of df
# each tab is a df in the list object
asp.d <- path %>% 
  excel_sheets() %>% 
  set_names() %>% 
  map(read_excel, path = path, na = "NA")  

```

```{r}
######
## site info tabs. read and clean
asp.siteinfo2018 <- asp.d$'Aspen 2018 Site Info'

# standardize use of SITE_ID (i.e., plot)
asp.siteinfo2018 <- asp.siteinfo2018 %>% 
  mutate(SITE_ID = case_when(SITE_ID == "AC1" ~ "AC01",
                       SITE_ID == "AC2" ~ "AC02",
                       SITE_ID == "AC3" ~ "AC03", 
                       SITE_ID == "AC4" ~ "AC04", 
                       SITE_ID == "AC4" ~ "AC04",
                       SITE_ID == "AC5" ~ "AC05",
                       SITE_ID == "AC6" ~ "AC06", 
                       SITE_ID == "AC7" ~ "AC07", 
                       SITE_ID == "AC8" ~ "AC08",
                       SITE_ID == "AC9" ~ "AC09",
                       SITE_ID == "ANC1" ~ "ANC01",
                       SITE_ID == "ANC1" ~ "ANC01",
                       SITE_ID == "ANC2" ~ "ANC02",
                       SITE_ID == "ANC3" ~ "ANC03", 
                       SITE_ID == "ANC4" ~ "ANC04", 
                       SITE_ID == "ANC4" ~ "ANC04",
                       SITE_ID == "ANC5" ~ "ANC05",
                       SITE_ID == "ANC6" ~ "ANC06", 
                       SITE_ID == "ANC7" ~ "ANC07", 
                       SITE_ID == "ANC8" ~ "ANC08",
                       SITE_ID == "ANC9" ~ "ANC09",
                       SITE_ID == "AK1" ~ "AK01",
                       SITE_ID == "AK2" ~ "AK02",
                       SITE_ID == "AK3" ~ "AK03", 
                       SITE_ID == "AK4" ~ "AK04", 
                       SITE_ID == "AK4" ~ "AK04",
                       SITE_ID == "AK5" ~ "AK05",
                       SITE_ID == "AK6" ~ "AK06", 
                       SITE_ID == "AK7" ~ "AK07", 
                       SITE_ID == "AK8" ~ "AK08",
                       SITE_ID == "AK9" ~ "AK09",
                       TRUE ~ as.character(SITE_ID))
  )

asp.siteinfo2018 %>% 
  datatable()
  
asp.siteinfo_baseline <- asp.d$'Aspen Baseline Site Info'
asp.siteinfo_baseline <- asp.siteinfo_baseline 
# write_csv(asp.siteinfo_baseline, "./data/EVMP_derived/asp_siteinfoBaseline.csv")

```

```{r}
######
## select the tabs with tally data
asp.d.sel <- asp.d[c(3,4,5,6,8,10)] 

## combine
asp.tally.all <- bind_rows(asp.d.sel, .id = "tab") 

## fix inconsistent labels
asp.tally.all <- 
  asp.tally.all %>% 
  mutate(SITE_ID = case_when(SITE_ID == "AC1" ~ "AC01",
                       SITE_ID == "AC2" ~ "AC02",
                       SITE_ID == "AC3" ~ "AC03", 
                       SITE_ID == "AC4" ~ "AC04", 
                       SITE_ID == "AC4" ~ "AC04",
                       SITE_ID == "AC5" ~ "AC05",
                       SITE_ID == "AC6" ~ "AC06", 
                       SITE_ID == "AC7" ~ "AC07", 
                       SITE_ID == "AC8" ~ "AC08",
                       SITE_ID == "AC9" ~ "AC09",
                       SITE_ID == "ANC1" ~ "ANC01",
                       SITE_ID == "ANC1" ~ "ANC01",
                       SITE_ID == "ANC2" ~ "ANC02",
                       SITE_ID == "ANC3" ~ "ANC03", 
                       SITE_ID == "ANC4" ~ "ANC04", 
                       SITE_ID == "ANC4" ~ "ANC04",
                       SITE_ID == "ANC5" ~ "ANC05",
                       SITE_ID == "ANC6" ~ "ANC06", 
                       SITE_ID == "ANC7" ~ "ANC07", 
                       SITE_ID == "ANC8" ~ "ANC08",
                       SITE_ID == "ANC9" ~ "ANC09",
                       SITE_ID == "AK1" ~ "AK01",
                       SITE_ID == "AK2" ~ "AK02",
                       SITE_ID == "AK3" ~ "AK03", 
                       SITE_ID == "AK4" ~ "AK04", 
                       SITE_ID == "AK4" ~ "AK04",
                       SITE_ID == "AK5" ~ "AK05",
                       SITE_ID == "AK6" ~ "AK06", 
                       SITE_ID == "AK7" ~ "AK07", 
                       SITE_ID == "AK8" ~ "AK08",
                       SITE_ID == "AK9" ~ "AK09",
                       TRUE ~ as.character(SITE_ID))
  )

```

```{r, eval=FALSE}

asp.tally.all %>% 
  group_by(BURNED, FENCED) %>% 
  tally()%>% 
  gt::gt()

# aspen combined variable names
asp.tally.all %>% 
  names() %>% 
  enframe() %>% 
  gt::gt()

```

```{r, eval=FALSE}
asp.tally.all %>% 
  janitor::tabyl(tab,SITE_TYPE) %>% 
  gt::gt()
```

*Tally of records by year and core, non-core, and Kawuneeche Valley
sites*

```{r}
asp.tally.all %>% 
  janitor::tabyl(YEAR,SITE_TYPE) %>% 
  gt::gt()
```

```{r, echo=FALSE, eval=FALSE}
# _Tally of records by site type (e.g., core, non-core, and Kawuneeche Valley sites) and fenced status_
asp.tally.all %>% 
  janitor::tabyl(SITE_TYPE, FENCED) %>% 
  gt::gt()

# _Tally of records by SITE_ID and YEAR_
asp.gt1 <- asp.tally.all %>% 
  janitor::tabyl(SITE_ID, YEAR) %>% 
  gt::gt() %>% 
  tab_header(title = "Tally of records by SITE_ID and YEAR")
```

```{r}
## join in site info
asp.tally.all <- left_join(asp.tally.all, site.info.clean, by = "SITE_ID")

## make the 'NA' for the 'SITE_TYPE' field 'N' instead
asp.tally.all <- asp.tally.all %>% 
  mutate(FENCED = case_when(FENCED == "NA_" ~ "N",
                            is.na(FENCED) ~ "N",
                            FENCED == "N" ~ "Unfenced",
                            TRUE ~ as.character(FENCED))
  ) 

## tidy height and dbh classes
## tidy the dbh
asp.tally.dbh.tidy <- asp.tally.all %>%
  pivot_longer(
    cols = starts_with("DBH"),
    names_to = "DBHclass",
    values_to = "DBHval"
  )

# asp.tally.dbh.tidy <- asp.tally.dbh.tidy %>% 
#   select(-contains("HT_"))

## tidy the height
asp.tally.ht.tidy <- asp.tally.all %>%
  pivot_longer(
    cols = starts_with("HT_"),
    names_to = "HTclass",
    values_to = "HTval"
  )

# asp.tally.all

asp.tally.ht.tidy <- asp.tally.ht.tidy %>% 
  select(-contains("DBH"))
```

```{r, eval=FALSE, echo=FALSE}
testdf <- asp.tally.all %>%
  filter(startsWith(SITE_ID,"AC0"))

asp.tally.allclass %>%
  pivot_longer(
    cols = starts_with("DBH"),
    names_to = "DBHclass",
    values_to = "DBHval"
  ) %>% 
  pivot_longer(
    cols = starts_with("HT_"),
    names_to = "HTclass",
    values_to = "HTval"
  ) %>% 
  group_by(SITE_ID, YEAR) %>%
  summarise(sum_AllHt = sum(HTval),sum_DBHht = sum(DBHval))

# check whether tallies by ht = tallies by dbh
# they don't add up!

# testdf %>%
#   pivot_longer(
#     cols = starts_with("HT_"),
#     names_to = "HTclass",
#     values_to = "HTval"
#   ) %>% 
#   pivot_longer(
#     cols = starts_with("DBH"),
#     names_to = "DBHclass",
#     values_to = "DBHval"
#   ) %>% 
#   # head() %>% 
#   View()
# visdat::vis_dat(warn_large_data = FALSE)

```


```{r}

# asp.tally.all %>% 
#   visdat::vis_dat()

# asp.tally.all %>% 
#   select(tab, SITE_ID, DBH_0_2_CM) %>% 
#   arrange(-DBH_0_2_CM)

## clean up BURNED: 'NA' to 'N'
asp.tally.all <- 
  asp.tally.all %>%
  mutate(BURNED = case_when(is.na(BURNED) ~ 'Unburned',
                            TRUE ~ as.character(BURNED)))

### write table
# write_csv(asp.tally.all, "./data/EVMP_derived/asp_tally_all.csv")
```


```{r asp_dbhmod}
## mod the dbh factor levels

asp.tally.dbh.tidy <- asp.tally.dbh.tidy %>% 
  mutate(DBHclassFact = as_factor(DBHclass)) %>% 
  mutate(FENCED = case_when(FENCED == "N" ~ "Unfenced",
                            TRUE ~ FENCED))

asp.tally.dbh.tidy <- asp.tally.dbh.tidy %>% 
  mutate(timeClass = case_when(YEAR == 2006 ~ "BL",
                               YEAR == 2007 ~ "BL",
                               YEAR == 2008 ~ "BL",
                               YEAR == 2009 ~ "BL",
                               TRUE ~ as.character(YEAR))) %>%  
  mutate(timeClass = factor(timeClass, levels = c("BL", "2013","2015","2016","2017","2018")))  # set as factor, set levels

## set the dbh factor levels
# levels(asp.tally.dbh.tidy$)

## Convert stem counts to density 
## 4046.86 m2 = 1 acre conversion
## plot is 25m2
## scaler is: 161.8744   
## i.e., 1 stem/m2 = 161.8744 stems/acre

# rename stemTally for DBH class to something more sensible
asp.tally.dbh.tidy <- 
  asp.tally.dbh.tidy %>%
  rename(stemTally = DBHval) 

## Create a new field to combine the 2cm dbh bands into smaller number of classes. 
# write a table to use as look-up
# asp.tally.tidy %>% 
#   distinct(DBHclassFact) %>% 
#   write_csv('./data/EVMP_derived/DBHclassFact_lu.csv')

# read in the lu
dbh.lu <- read_csv('./data/EVMP_derived/DBHclassFact_lu.csv')

asp.tally.dbh.tidy <- left_join(asp.tally.dbh.tidy, dbh.lu, by = "DBHclassFact")

## set the factor levels for the DBH classes
asp.tally.dbh.tidy <- asp.tally.dbh.tidy %>% 
  mutate(DBHclGp01 = as_factor(DBHclGp01))

## fix issue of missing "RANGE TYPE" attributes
asp.tally.dbh.tidy <- asp.tally.dbh.tidy %>% 
  mutate(RANGE_TYPE = case_when(is.na(RANGE_TYPE) & SITE_TYPE == "AC" ~ "core winter range",
                     is.na(RANGE_TYPE) & SITE_TYPE == "ANC" ~ "non-core winter range",
                     is.na(RANGE_TYPE) & SITE_TYPE == "AK" ~ "Kawuneeche Valley",
                     TRUE ~ RANGE_TYPE))


## collapse the tallies by DBHclGp01
asp.tally.dbh.tidy <- asp.tally.dbh.tidy %>%
  group_by(SITE_ID, timeClass, SITE_TYPE, REMOVED, BURNED, FENCED, VALLEY, RANGE_TYPE, LIVE_DEAD, DBHclGp01) %>% 
  summarise(stemTally = sum(stemTally), mean.tally = mean(stemTally, na.rm = TRUE)) %>%
  ungroup() %>% 
  mutate(stemDen.ha = stemTally *400) %>% # converts stems/2m2 plot to stems/ha
  mutate(stemDen.ac = stemTally *161.8744) # converts stems/2m2 plot to stems/acre

```

```{r asp_htMod}
### ALL stem diameters
## mod the ht

asp.tally.ht.tidy <- asp.tally.ht.tidy %>% 
  mutate(timeClass = case_when(YEAR == 2006 ~ "BL",
                               YEAR == 2007 ~ "BL",
                               YEAR == 2008 ~ "BL",
                               YEAR == 2009 ~ "BL",
                               TRUE ~ as.character(YEAR))) %>% 
  mutate(timeClass = factor(timeClass, levels = c("BL", "2013","2015","2016","2017","2018")))  # set as factor, set levels

### rename the HTval to something more easily interpreted then convert to stem density/ha
asp.tally.ht.tidy <- 
  asp.tally.ht.tidy %>% 
  rename(stemTally = HTval) %>% 
  mutate(stemDen.ha = stemTally *400) %>% # converts stems/25m2 plot to stems/ha
  mutate(stemDen.ac = stemTally *161.8744) # converts stems/25m2 plot to stems/acre

# asp.tally.ht.tidy %>% 
#   datatable()
```

### Stem count by diameter

```{r asp_dbh_tileTally, fig.width=9, fig.height=9}
### Core winter range
asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "core winter range") %>% 
  filter(timeClass == "BL" | timeClass == "2013" |timeClass == "2018") %>% 
  ggplot(aes(timeClass, DBHclGp01), color="grey80", alpha = .8) +  
  geom_tile(aes(fill = FENCED), color = "grey80") +
  # geom_text(aes(label = stemTally), size = 3) +
  scale_fill_manual(values = colfunc3(2)) +
  facet_wrap(~SITE_ID, ncol=8) +
  theme_minimal() +
  labs(fill = "", x = "", y = "", title = "Aspen live stem tallies", subtitle = "Core winter range") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r, eval=TRUE}
asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>%
  filter(RANGE_TYPE == "core winter range") %>% 
  filter(timeClass == "BL" | timeClass == "2013" |timeClass == "2018") %>%
  group_by(timeClass,DBHclGp01, FENCED,VALLEY) %>%
  summarise(mean.tally = round(mean(stemTally, na.rm=TRUE),1)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = mean.tally), color = "grey80", alpha = .8) +
  # geom_text(aes(label = mean.tally), size = 3) +
  facet_grid(FENCED~VALLEY) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # scale_fill_gradient2(low="#0095AF",high="#FCFFDD") +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean tally", title = "Mean aspen live stem tallies", caption = "Core winter range plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

**Mean aspen stem count**
```{r}
## make site_type as factor, sort 
asp.tally.dbh.tidy <- asp.tally.dbh.tidy %>%
  mutate(SITE_TYPE = as_factor(SITE_TYPE)) %>% 
  mutate(SITE_TYPE = fct_relevel(SITE_TYPE, "AK", after = Inf))

asp.tally.dbh.tidy %>% 
  filter(LIVE_DEAD == 'LIVE') %>%
 filter(timeClass == "BL" | timeClass == "2013" |timeClass == "2018") %>%
  group_by(timeClass,DBHclGp01, FENCED,SITE_TYPE) %>%
  summarise(mean.tally = round(mean(stemTally, na.rm=TRUE),1)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = mean.tally), color = "grey80", alpha = .2) +
  # geom_text(aes(label = mean.tally), size = 3) +
  facet_grid(FENCED~SITE_TYPE) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean tally", title = "Mean aspen live stem tallies", caption = "all aspen plots") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
### Non-core winter range
asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>%
  filter(RANGE_TYPE == "non-core winter range") %>% 
  filter(timeClass == "BL" | timeClass == "2013" |timeClass == "2018") %>%
  group_by(timeClass,DBHclGp01, FENCED,VALLEY) %>%
  summarise(mean.tally = round(mean(stemTally, na.rm=TRUE),1)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = mean.tally), color = "grey80", alpha = .2) +
  # geom_tile(fill = "grey90", color = "grey80", alpha = .2) +
  geom_text(aes(label = mean.tally), size = 3) +
  facet_grid(FENCED~VALLEY) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean tally", title = "Mean aspen live stem tallies", caption = "Non-core winter range plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
### Kawuneeche Valley
asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>%
  filter(SITE_TYPE == "AK") %>% 
  filter(timeClass == "BL" | timeClass == "2013" |timeClass == "2018") %>%
  group_by(timeClass,DBHclGp01, FENCED,VALLEY) %>%
  summarise(mean.tally = round(mean(stemTally, na.rm=TRUE),1)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = mean.tally), color = "grey80", alpha = .2) +
  # geom_tile(fill = "grey90", color = "grey80", alpha = .2) +
  geom_text(aes(label = mean.tally), size = 3) +
  facet_grid(FENCED~VALLEY) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean tally", title = "Mean aspen live stem tallies", caption = "Kawuneeche Valley plots only") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

### Live stem density - All stem diameters
```{r, fig.height=8, fig.width=8}
### Core winter range
asp.tally.dbh.tidy %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(SITE_ID != "AC01") %>% 
  filter(SITE_ID != "AC14") %>% 
  filter(SITE_ID != "AC68") %>% 
  # mutate(SITE_ID = glue::glue('{SITE_ID}({FENCED})')) %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "core winter range") %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = stemDen.ac), color = "grey80") +
  geom_tile(aes(color = FENCED), size = 0.8, fill=NA) +
  scale_color_manual(values = c("red","grey80")) +
  # scale_fill_viridis_c() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # geom_text(aes(label = round(stemDen.ac,0)),color = "grey80", size = 2.7) +
  facet_wrap(~SITE_ID, ncol = 6) +
  theme_minimal() +
  labs(x = "", y = "", title = "Aspen live stem density - all diameters", subtitle = "Core winter range", fill = "Stems/acre", y = "DBH class", color="") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/AC_ht_stemsAc_tile_allTreeDiamters.png", width = 9.75, height = 10.5)

```

```{r}
asp.tally.dbh.tidy %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(SITE_ID != "AC01") %>% 
  filter(SITE_ID != "AC14") %>% 
  filter(SITE_ID != "AC68") %>% 
  # mutate(SITE_ID = glue::glue('{SITE_ID}({FENCED})')) %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "core winter range") %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_col(aes(fill = stemDen.ac), color = "grey80") +
  # geom_tile(aes(color = FENCED), size = 0.8, fill=NA) +
  scale_color_manual(values = c("red","grey80")) +
  # scale_fill_viridis_c() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~SITE_ID, ncol = 6) +
  theme_minimal() +
  labs(x = "", y = "", title = "Aspen live stem density - all diameters", subtitle = "Core winter range", fill = "Stems/acre", y = "DBH class", color="") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r, fig.height=8, fig.width=8}
### Core winter range
asp.tally.dbh.tidy %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(SITE_ID != "AC01") %>% 
  filter(SITE_ID != "AC14") %>% 
  filter(SITE_ID != "AC68") %>% 
  # mutate(SITE_ID = glue::glue('{SITE_ID}({FENCED})')) %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "core winter range") %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = stemDen.ac), color = "grey80") +
  geom_tile(aes(color = FENCED), size=2, fill=NA) +
  scale_color_manual(values = c("red","grey80")) +
  # scale_fill_viridis_c() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # geom_text(aes(label = round(stemDen.ac,0)),color = "grey80", size = 2.7) +
  facet_wrap(~SITE_ID, ncol = 6) +
  theme_minimal() +
  labs(x = "", y = "", title = "Aspen live stem density - all diameters", subtitle = "Core winter range", fill = "Stems/acre", y = "DBH class", color="") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/AC_ht_stemsAc_tile_allTreeDiamters.png", width = 9.75, height = 10.5)

```



```{r, eval=TRUE}
## summary table
## Time class FENCED SITE_TYPE
asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, SITE_TYPE) %>% 
  summarytools::descr(var = stemDen.ha,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, 'Site type' = SITE_TYPE) %>% 
  gt() %>% 
  tab_header(title = "Aspen stem density") #%>%  
  # gt::gtsave(file = "./output/tables/summary_asp_den_tc_sitetype.rtf")

### add fencing
asp.tally.dbh.tidy %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(LIVE_DEAD == 'LIVE') %>% 
  # filter(RANGE_TYPE == "core winter range") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, FENCED, SITE_TYPE) %>% 
  summarytools::descr(var = stemDen.ha,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, 'Site type' = SITE_TYPE) %>% 
  gt() %>% 
  tab_header(title = "Aspen stem density") #%>% 
  # gt::gtsave(file = "./output/tables/summary_asp_den_tc_sitetype_fencing.rtf")

## add burned
asp.tally.dbh.tidy %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(LIVE_DEAD == 'LIVE') %>% 
  # filter(RANGE_TYPE == "core winter range") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, BURNED, SITE_TYPE) %>% 
  summarytools::descr(var = stemDen.ha,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, 'Site type' = SITE_TYPE) %>% 
  gt() %>% 
  tab_header(title = "Aspen stem density") #%>% 
  # gt::gtsave(file = "./output/tables/summary_asp_den_tc_sitetype_burn.rtf")

## add burned
asp.tally.dbh.tidy %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(LIVE_DEAD == 'LIVE') %>% 
  # filter(RANGE_TYPE == "core winter range") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, FENCED, BURNED, SITE_TYPE) %>% 
  summarytools::descr(var = stemDen.ha,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, 'Site type' = SITE_TYPE) %>% 
  gt() %>% 
  tab_header(title = "Aspen stem density") #%>% 
  # gt::gtsave(file = "./output/tables/summary_asp_den_tc_sitetype_fenceXburn.rtf")

```

#### Burned plots

```{r}
## add just burned plots
asp.tally.dbh.tidy %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(BURNED == "Burned") %>% 
  filter(LIVE_DEAD == 'LIVE') %>%
  # filter(RANGE_TYPE == "core winter range") %>% 
  group_by(timeClass,DBHclGp01, FENCED) %>%
  summarise(mean.tally = round(mean(stemTally, na.rm=TRUE),1)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = mean.tally), color = "grey80") +
  # geom_tile(fill = "grey90", color = "grey80", alpha = .2) +
  geom_text(aes(label = mean.tally), size = 3) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~FENCED) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean tally", title = "Mean aspen count in burned plots", caption = "Plots burned in 2012, AC, live stems only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

pl.burn.count.ac.f <- asp.tally.dbh.tidy %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(BURNED == "Burned") %>% 
  filter(LIVE_DEAD == 'LIVE') %>%
  # filter(RANGE_TYPE == "core winter range") %>% 
  group_by(timeClass,DBHclGp01, FENCED) %>%
  summarise(mean.tally = round(mean(stemTally, na.rm=TRUE),1)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = mean.tally), color = "grey80") +
  # geom_tile(fill = "grey90", color = "grey80", alpha = .2) +
  # geom_text(aes(label = mean.tally), size = 3) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~FENCED) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean tally", title = "Mean aspen count in burned plots", caption = "Plots burned in 2012, AC, live stems only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

pl.burn.count.ac.f
ggsave("./output/figures_202107/AC_burned_live_only_TCxF_mean.png", width = 6, height = 3.75)



```

```{r}
## add just burned plots
asp.tally.dbh.tidy %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(BURNED == "Burned") %>% 
  filter(LIVE_DEAD == 'LIVE') %>%
  # filter(RANGE_TYPE == "core winter range") %>% 
  group_by(timeClass,DBHclGp01, FENCED) %>%
  descr(stemDen.ac, stats="common") %>%
  tb() %>% 
  mutate(across(where(is.numeric), round, 0)) %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = mean), color = "grey80") +
  # geom_tile(fill = "grey90", color = "grey80", alpha = .2) +
  geom_text(aes(label = mean), size = 3) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~FENCED) +
  theme(legend.position = "bottom") +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean density (stems/acre)", title = "Mean tree density in burned plots", caption = "Plots burned in 2012, AC, live trees only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggsave("./output/figures_202107/AC_burned_live_DBH_only_TCxF_meanDen_lbl.png", width = 6, height = 3.75)


```

```{r}
asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(BURNED == "Burned") %>% 
  filter(LIVE_DEAD == 'LIVE') %>%
  # filter(RANGE_TYPE == "core winter range") %>% 
  group_by(timeClass,shortTall, FENCED) %>%
  descr(stemDen.ac, stats="common") %>%
  tb() %>% 
  mutate(across(where(is.numeric), round, 0)) %>% 
  datatable(caption = "Burned plots")
```


```{r}
asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(BURNED == "Burned") %>% 
  filter(LIVE_DEAD == 'LIVE') %>%
  # filter(RANGE_TYPE == "core winter range") %>% 
  group_by(timeClass,shortTall, FENCED) %>%
  descr(stemDen.ac, stats="common") %>%
  tb() %>% 
  mutate(across(where(is.numeric), round, 0)) %>% 
  ggplot(aes(timeClass, mean)) + 
  geom_col(aes(fill=FENCED), position='dodge', color="grey80") +
  facet_wrap(~shortTall) +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  labs(fill="", x="", y="Stem density (stems/acre)", caption = "burned plots only") 
ggsave("./output/figures_202107/AC_burned_live_sapHt_only_TCxF_meanDen_bar.png", width = 7.5, height = 5.75)

asp.tally.ht.tidy %>%
  # filter(SITE_TYPE == "AC") %>% 
  filter(SITE_TYPE != "AK") %>%
  filter(BURNED == "Burned") %>% 
  filter(LIVE_DEAD == 'LIVE') %>%
  # filter(RANGE_TYPE == "core winter range") %>% 
  group_by(timeClass,shortTall, FENCED, SITE_TYPE) %>%
  descr(stemDen.ac, stats="common") %>%
  tb() %>% 
  mutate(across(where(is.numeric), round, 0)) %>% 
  ggplot(aes(timeClass, mean)) + 
  geom_col(aes(fill=FENCED), position='dodge', color="grey80") +
  # facet_wrap(~shortTall) +
  facet_grid(shortTall~SITE_TYPE) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  scale_fill_manual(values = colfunc3(2)) +
  labs(fill="", x="", y="Stem density (stems/acre)", title = "Short and tall sapling density in burned plots") 
ggsave("./output/figures_202107/ACANC_burned_live_sapHt_only_TCxF_meanDen_bar.png", width = 7.75, height = 6.75)

```

```{r}
asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(BURNED == "Burned") %>% 
  filter(LIVE_DEAD == 'LIVE') %>%
  # filter(RANGE_TYPE == "core winter range") %>% 
  group_by(timeClass,shortTall, FENCED) %>%
  descr(stemDen.ac, stats="common") %>%
  tb() %>% 
  mutate(across(where(is.numeric), round, 0)) %>% 
  ggplot(aes(timeClass, shortTall)) +  
  geom_tile(aes(fill = mean), color = "grey80") +
  # geom_tile(fill = "grey90", color = "grey80", alpha = .2) +
  geom_text(aes(label = mean), size = 3) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~FENCED) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean density (stems/acre)", title = "Tall and short sapling density in burned plots", caption = "Plots burned in 2012, AC, live trees only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggsave("./output/figures_202107/AC_burned_live_sapHt_only_TCxF_meanDen_lbl.png", width = 6, height = 3.75)

asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(BURNED == "Burned") %>% 
  filter(LIVE_DEAD == 'LIVE') %>%
  # filter(RANGE_TYPE == "core winter range") %>% 
  group_by(timeClass,shortTall, FENCED) %>%
  descr(stemDen.ac, stats="common") %>%
  tb() %>% 
  mutate(across(where(is.numeric), round, 0)) %>% 
  ggplot(aes(timeClass, shortTall)) +  
  geom_tile(aes(fill = mean), color = "grey80") +
  # geom_tile(fill = "grey90", color = "grey80", alpha = .2) +
  # geom_text(aes(label = mean), size = 3) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~FENCED) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean density (stems/acre)", title = "Tall and short sapling density in burned plots", caption = "Plots burned in 2012, AC, live trees only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggsave("./output/figures_202107/AC_burned_live_sapHt_only_TCxF_meanDen_nolbl.png", width = 6, height = 3.75)

```


```{r}
asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(BURNED == "Burned") %>% 
  filter(LIVE_DEAD == 'LIVE') %>%
  # filter(RANGE_TYPE == "core winter range") %>% 
  group_by(timeClass,HTclass2, FENCED) %>%
  descr(stemDen.ac, stats="common") %>%
  tb() %>% 
  mutate(across(where(is.numeric), round, 0)) %>% 
  ggplot(aes(timeClass, HTclass2)) +  
  geom_tile(aes(fill = mean), color = "grey80") +
  # geom_tile(fill = "grey90", color = "grey80", alpha = .2) +
  geom_text(aes(label = mean), size = 3) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~FENCED) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean density (stems/acre)", title = "Tall and short sapling density in burned plots", caption = "Plots burned in 2012, AC, live trees only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggsave("./output/figures_202107/AC_burned_live_sapHt2_only_TCxF_meanDen_lbl.png", width = 6, height = 3.75)

asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(BURNED == "Burned") %>% 
  filter(LIVE_DEAD == 'LIVE') %>%
  # filter(RANGE_TYPE == "core winter range") %>% 
  group_by(timeClass,HTclass2, FENCED) %>%
  descr(stemDen.ac, stats="common") %>%
  tb() %>% 
  mutate(across(where(is.numeric), round, 0)) %>% 
  ggplot(aes(timeClass, HTclass2)) +  
  geom_tile(aes(fill = mean), color = "grey80") +
  # geom_tile(fill = "grey90", color = "grey80", alpha = .2) +
  # geom_text(aes(label = mean), size = 3) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~FENCED) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean density (stems/acre)", title = "Tall and short sapling density in burned plots", caption = "Plots burned in 2012, AC, live trees only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggsave("./output/figures_202107/AC_burned_live_sapHt2_only_TCxF_meanDen_nolbl.png", width = 6, height = 3.75)

```


```{r}
pl.burn.count.ac.f <- asp.tally.dbh.tidy %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(BURNED == "Burned") %>% 
  filter(LIVE_DEAD == 'LIVE') %>%
  # filter(RANGE_TYPE == "core winter range") %>% 
  group_by(timeClass,DBHclGp01, FENCED) %>%
  summarise(mean.tally = round(mean(stemTally, na.rm=TRUE),1)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = mean.tally), color = "grey80") +
  # geom_tile(fill = "grey90", color = "grey80", alpha = .2) +
  # geom_text(aes(label = mean.tally), size = 3) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~FENCED) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean tally", title = "Mean aspen count in burned plots", caption = "Plots burned in 2012, AC, live stems only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

pl.burn.count.ac.f
ggsave("./output/figures_202107/AC_burned_live_only_TCxF_mean.png", width = 6, height = 3.75)
```


```{r}
asp.tally.dbh.tidy %>% 
  filter(LIVE_DEAD == 'LIVE') %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, FENCED, BURNED, SITE_TYPE) %>% 
  summarytools::descr(var = stemDen.ha,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, 'Site type' = SITE_TYPE) %>% 
  gt() %>% 
  tab_header(title = "Aspen stem density") #%>% 
  # gt::gtsave(file = "./output/tables/summary_asp_den_tc_sitetype_fenceXburn.rtf")

## add just burned plots, live vs dead
asp.tally.dbh.tidy %>%
  filter(BURNED == "Burned") %>% 
  # filter(LIVE_DEAD == 'LIVE') %>%
  # filter(RANGE_TYPE == "core winter range") %>% 
  group_by(timeClass,DBHclGp01, FENCED, LIVE_DEAD) %>%
  summarise(mean.tally = round(mean(stemTally, na.rm=TRUE),1)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = mean.tally), color = "grey80") +
  # geom_tile(fill = "grey90", color = "grey80", alpha = .2) +
  # geom_text(aes(label = mean.tally), size = 3) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # facet_wrap(~FENCED) +
  facet_grid(LIVE_DEAD~FENCED) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean tally", title = "Mean aspen stem tallies in burned plots", caption = "Plots burned in 2012, AC&ANC") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/asp_burned_only_TCxF_LiveXdead_meanCnt.png", width = 7, height = 5)

```



```{r, fig.width=9, fig.height=8}
asp.tally.dbh.tidy %>%
  mutate(SITE_ID = glue::glue('{SITE_ID}({FENCED})')) %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "core winter range") %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = stemDen.ac), color = "grey80", alpha = .52) +
  # scale_fill_viridis_c() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  geom_text(aes(label = round(stemDen.ac,0)),size = 2.7) +
  facet_wrap(~SITE_ID, ncol = 6) +
  theme_minimal() +
  labs(x = "", y = "", title = "Aspen live stem density", subtitle = "Core winter range", fill = "Stems/acre", y = "DBH class") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/AC_diam_stemsAc_tile_rev.png", width = 7.5, height = 7.5)
```

```{r, fig.height=6, fig.width=6}
### Non-core winter range
asp.tally.dbh.tidy %>%
  mutate(SITE_ID = glue::glue('{SITE_ID}({FENCED})')) %>% 
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "non-core winter range") %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = stemDen.ac), color = "grey80") +
  # scale_fill_viridis_c() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  geom_text(aes(label = round(stemDen.ac,0)),color = "grey80", size = 2.7) +
  facet_wrap(~SITE_ID, ncol = 4) +
  theme_minimal() +
  labs(x = "", y = "", title = "Aspen live stem density", subtitle = "Non-core winter range", fill = "Stems/acre", y = "DBH class") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/ANC_diam_stemsAc_tile_rev.png", width = 7.5, height = 5.5)

```

```{r, fig.height=3.75, fig.width=5}
#### Kawuneeche Valley
pl.hm.stemsac.ak <- asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "Kawuneeche Valley") %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = stemDen.ac), color = "grey80") +
  # scale_fill_viridis_c() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # geom_text(aes(label = round(stemDen.ac,0)),color = "grey80", size = 2.7) +
  facet_wrap(~SITE_ID, ncol = 4) +
  theme_minimal() +
  labs(x = "", y = "", title = "Aspen live stem density", subtitle = "Kawuneeche Valley", fill = "Stems/acre", y = "DBH class") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
pl.hm.stemsac.ak
ggsave("./output/figures_202107/AK_diam_stemsAc_tile_revised.png", width = 5.5, height = 3.5)

```


```{r}
pl.hm.stemsac.ac.f <- asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == "LIVE") %>% 
  filter(timeClass %in% c("BL","2013","2018")) %>%
  mutate(timeClass = fct_drop(timeClass)) %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(SITE_TYPE == "AC") %>%
  filter(FENCED == "Fenced") %>% 
  # filter(RANGE_TYPE == "Kawuneeche Valley") %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = stemDen.ac), color = "grey80") +
  # scale_fill_viridis_c() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # geom_text(aes(label = round(stemDen.ac,0)),color = "grey80", size = 2.7) +
  facet_wrap(~SITE_ID, ncol = 6) +
  theme_minimal() +
  theme(legend.position = "none") +
  # theme(legend.position = "bottom") +
  labs(x = "", y = "", title = "Core range", subtitle = "Fenced plots", fill = "Stems/acre", y = "DBH class") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

pl.hm.stemsac.ac.f

ggsave("./output/figures_202107/diam_stemsAc_tile_ac_f.png", width = 7.5, height = 5.5)

pl.hm.stemsac.ac.uf <- asp.tally.dbh.tidy %>%
  filter(is.na(REMOVED)) %>% 
  filter(LIVE_DEAD == "LIVE") %>% 
  filter(timeClass %in% c("BL","2013","2018")) %>%
  mutate(timeClass = fct_drop(timeClass)) %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(SITE_TYPE == "AC") %>%
  filter(FENCED == "Unfenced") %>% 
  # filter(RANGE_TYPE == "Kawuneeche Valley") %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = stemDen.ac), color = "grey80") +
  # scale_fill_viridis_c() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # geom_text(aes(label = round(stemDen.ac,0)),color = "grey80", size = 2.7) +
  facet_wrap(~SITE_ID, ncol = 6) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = "", y = "", subtitle = "Unfenced", fill = "Stems/acre", y = "DBH class") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

pl.hm.stemsac.ac.uf

# ggsave("./output/figures_202107/diam_stemsAc_tile_ac_uf.png", width = 7.5, height = 8.5)

```

```{r}
pl.hm.stemsac.ac.f + pl.hm.stemsac.ac.uf + plot_layout(ncol=1, heights = c(1,2.8))
ggsave("./output/figures_202107/diam_stemsAc_tile_ac_f_vs_uf.png", width = 8.75, height = 11.5, dpi=300)
```

```{r}
#### Aspen: live stem density summary table
asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  group_by(timeClass, RANGE_TYPE, FENCED) %>%
  descr() %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round,2)) %>% 
  datatable()

```

```{r}
## Calculate the percent stems in DBH/classes
dbh.perc <- asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == "LIVE") %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  group_by(SITE_ID, timeClass, DBHclGp01) %>% 
  mutate(percentTot = stemTally/sumStem)%>%
  filter(SITE_ID != "AC01") %>% # removed plots
  filter(SITE_ID != "AC12") %>%
  filter(SITE_ID != "AC14") %>%
  filter(SITE_ID != "AC41") %>% 
  filter(SITE_ID != "AC21")

```

#### Core winter range

```{r}
## prep for revised stacked order barplot 2021-02-09
dbh.perc.clean <- dbh.perc %>% 
  clean_names %>% 
  rename(dbh_class = db_hcl_gp01)

## manual sort based on the 2015 fig requested
dbh.sort.lu <- read_csv("./data/EVMP_derived/AC_dbh_sort.csv")
dbh.sort.lu <- dbh.sort.lu %>% 
  select(SITE_ID, FactorLevel_DBH_sort) %>% 
  clean_names()

dbh.joined <- left_join(dbh.perc.clean,dbh.sort.lu)  

## add "no aspen" category
dbh.joined <- dbh.joined %>% 
  filter(is.na(removed)) %>% 
  mutate(dbh_class = as.character(dbh_class)) %>% 
  mutate(dbh_class = case_when(is.nan(percent_tot) ~ "no aspen",
                                 TRUE ~ dbh_class)) %>% 
  mutate(percent_tot = case_when(is.nan(percent_tot) ~ .25,
                                 TRUE ~ percent_tot)) 
## reorder factor
dbh.joined <- dbh.joined %>% 
  mutate(dbh_class = as_factor(dbh_class)) %>% 
  mutate(dbh_class = fct_relevel(dbh_class, "10-20 cm", after=2))

```

```{r}
### revised plots 2021-02-09
# stacked sorted boxplot
## create color gradient 
# colorspace::sequential_hcl(4, "Teal")

dbhclass.gradient <- c("#26185F", "#0095AF", "#9ADCBB", "#FCFFDD", "grey50")

# ACx F  
plot.percTot.dbh.AC.F <- dbh.joined %>% 
  filter(time_class %in% c("BL","2013","2018")) %>% 
  filter(site_type == "AC" & fenced == "Fenced") %>% 
  ggplot(aes(reorder(site_id, factor_level_dbh_sort), percent_tot)) +
  geom_col(aes(fill = dbh_class), color="grey50") +
  facet_wrap(~time_class, ncol = 1) +
  scale_fill_manual(values = dbhclass.gradient) +
  # scale_fill_viridis(discrete=TRUE) +
  theme_minimal() +
  labs(y = "% of total stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", subtitle = "Fenced plots") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels=scales::percent) +
  theme(legend.position = "none")

# ACxUf
plot.percTot.dbh.AC.UF <- dbh.joined %>%
  filter(time_class %in% c("BL","2013","2018")) %>% 
  filter(site_type == "AC" & fenced == "Unfenced") %>% 
  ggplot(aes(reorder(site_id, factor_level_dbh_sort), percent_tot)) +
  geom_col(aes(fill = dbh_class), color="grey50") +
  facet_wrap(~time_class, ncol = 1) +
  scale_fill_manual(values = dbhclass.gradient) +
  theme_minimal() +
  labs(y = "", x = "", fill = "DBH class", subtitle = "Unfenced plots") +
  theme(legend.position = "bottom") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels=scales::percent) 

# library(patchwork)
plot.percTot.dbh.AC.F + plot.percTot.dbh.AC.UF +
  plot_layout(widths = c(1, 2))

ggsave("./output/figures_202107/AspPercTotXdbh_ac_FxUf.png", width = 9.75, height = 5, dpi=300)
# ggsave("./output/figures_202107/AsppercTotXdbh_ac_FxUf.pdf", width = 10, height = 5)

```

*DBH classes: Fenced plots*

```{r}
## DBH
dbh.perc.f <- asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == "LIVE") %>%
  filter(FENCED == "Fenced") %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) 

## heatmap
dbh.perc.f %>%
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(DBHclGp01, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'grey80', alpha=.8) +
  facet_grid(.~timeClass) +
  # scale_fill_viridis_c(begin = .01, end = .9, direction = -1) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  theme(legend.position = "bottom") +
  theme_minimal() +
  labs(x = "DBH class", y = "", fill = "", title = "Proportion of Live Aspen Stems by DBH Class", subtitle = "Fenced Plots only")

ggsave("./output/figures_202107/AC_Live_Fenced_Unburned_PropDBH_heatmap.png", width = 7, height = 5, dpi = 300)

dbh.perc.f %>%
  filter(SITE_ID != "AC67") %>% 
  filter(!is.nan(percentTot)) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, percentTot)) +
  # geom_col(aes(fill = DBHclGp01), color = "darkgray") +
  geom_col(aes(fill = DBHclGp01)) +
  facet_wrap(~SITE_ID, ncol = 5) +
  scale_fill_grey() +
  theme_minimal() +
  labs(y = "% total stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", caption = "Fenced plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent)

# ggsave("./output/figures_202107/AC_Live_Fenced_PropDBH_bw.png", width = 8, height = 6, dpi = 300)
```

```{r, echo=FALSE, eval=FALSE}
# _DBH classes: Fenced burned plots_
## DBH
dbh.perc2 <- asp.tally.dbh.tidy %>%
  filter(is.na(REMOVED)) %>% 
  filter(BURNED == "Burned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  filter(FENCED == "Fenced") %>%
  filter(SITE_TYPE == "AC") %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) 

dbh.perc2 %>%
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(SITE_ID, percentTot)) +
  # geom_col(aes(fill = DBHclGp01), color = "darkgray") +
  geom_col(aes(fill = DBHclGp01)) +
  facet_wrap(~timeClass, ncol = 3) +
  # scale_fill_viridis_d(option = "D") +
  scale_fill_manual(values = colfunc2(5)) +
  # theme_minimal() +
  theme_minimal() +
  labs(y = "Proportion of stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", subtitle = "Fenced and burned plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "top")
  
ggsave("./output/figures_202107/AC_Live_Fenced_Burned_PropDBH_barChart.png", width = 8, height = 6, dpi = 300)

dbh.perc2 %>%
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(timeClass, percentTot)) +
  # geom_col(aes(fill = DBHclGp01), color = "darkgray") +
  geom_col(aes(fill = DBHclGp01)) +
  facet_wrap(~SITE_ID, ncol = 3) +
  scale_fill_viridis_d(option = "D") +
  theme_minimal() +
  labs(y = "Proportion of stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", subtitle = "Fenced and burned plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent)

ggsave("./output/figures_202107/AC_Live_Fenced_Burned_PropDBH_bc.png", width = 8, height = 6, dpi = 300)

```

```{r, echo=FALSE, eval=FALSE}
## DBH - alt plot
# _DBH classes: Unfenced plots_
dbh.perc3 <- asp.tally.dbh.tidy %>%
  filter(is.na(REMOVED)) %>% 
  # filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  filter(FENCED == "Unfenced") %>%
  filter(SITE_TYPE == "AC") %>%
  filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) 

dbh.perc3 %>%
  filter(!is.nan(percentTot)) %>%
  filter(SITE_ID != "AC68" & SITE_ID != "AC09" & SITE_ID != "AC30" & SITE_ID != "AC07" & SITE_ID != "AC37" & SITE_ID != "AC39") %>% 
  ggplot(aes(timeClass, percentTot)) +
  geom_col(aes(fill = DBHclGp01)) +
  facet_wrap(~SITE_ID, ncol = 6) +
  # scale_fill_viridis_d(option = "D") +
  # scale_fill_manual(values = c("honeydew", "honeydew3", "darkolivegreen")) +
  theme_minimal() +
  labs(y = "% total stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", captioned = "Unfenced plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent) 

# ggsave("./output/figures_202107/AC_Live_unfenced_PropDBH_bc.png", width = 8, height = 6, dpi = 300)

```

#### Non-core winter range

*DBH classes: Non-fenced plots*

```{r}
## prep for revised stacked order barplot 2021-02-09
dbh.anc.ak.lu <- dbh.perc.clean %>%
  filter(site_type != "AC") %>%
  select(time_class, site_id, site_type, dbh_class, percent_tot) %>%
  pivot_wider(names_from = dbh_class, values_from = percent_tot) %>% 
  clean_names() %>% 
  arrange(time_class, site_type, desc(x2_10_cm), desc(x10_20_cm)) %>%
  rownames_to_column() 

# dbh.anc.ak.lu %>% 
#   write_csv("./data/EVMP_derived/dbh_sort_ANC_AK_lu.csv")

dbh.anc.ak.lu <- dbh.anc.ak.lu %>%
  ungroup() %>% 
  rename(sort.dbh = rowname) %>%
  filter(time_class == "BL") %>% 
  select(site_id, sort.dbh, -time_class) %>% 
  mutate(sort.dbh = as.integer(sort.dbh))

## manual sort based on the 2015 fig requested

dbh.anc.ak.joined <- left_join(dbh.perc.clean, dbh.anc.ak.lu)  

## add "no aspen" category
dbh.anc.ak.joined <- dbh.anc.ak.joined %>% 
  filter(is.na(removed)) %>% 
  mutate(dbh_class = as.character(dbh_class)) %>% 
  mutate(dbh_class = case_when(is.nan(percent_tot) ~ "no aspen",
                                 TRUE ~ dbh_class)) %>% 
  mutate(percent_tot = case_when(is.nan(percent_tot) ~ .25,
                                 TRUE ~ percent_tot)) 
## reorder factor
dbh.anc.ak.joined <- dbh.anc.ak.joined %>% 
  mutate(dbh_class = as_factor(dbh_class)) %>% 
  mutate(dbh_class = fct_relevel(dbh_class, "10-20 cm", after=2))

```

```{r}
### revised plots 2021-02-09
# stacked sorted boxplot
## create color gradient 
dbhclass.gradient <- c("#26185F", "#0095AF", "#9ADCBB", "#FCFFDD", "grey50")

# ANC  
dbh.anc.ak.joined %>% 
  filter(time_class %in% c("BL","2013","2018")) %>% 
  filter(site_type == "ANC") %>% 
  ggplot(aes(reorder(site_id, sort.dbh), percent_tot)) +
  geom_col(aes(fill = dbh_class), color="grey50") +
  facet_wrap(~time_class, ncol = 1) +
  scale_fill_manual(values = dbhclass.gradient) +
  # scale_fill_viridis(discrete=TRUE) +
  theme_minimal() +
  labs(y = "% of total stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", subtitle = "Fenced plots") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels=scales::percent) 

dbh.anc.ak.joined %>% 
  filter(time_class %in% c("BL","2013","2018")) %>% 
  filter(site_type == "ANC") %>% 
  ggplot(aes(reorder(site_id, sort.dbh), percent_tot)) +
  geom_col(aes(fill = dbh_class), color="grey50") +
  # geom_point(data = subset(., burned == "Burned"), y= 0.5) +
  # geom_point(y=0.5, aes(color = burned)) +
  facet_wrap(~time_class, ncol = 1) +
  scale_fill_manual(values = dbhclass.gradient) +
  # scale_fill_viridis(discrete=TRUE) +
  theme_minimal() +
  labs(y = "% of total stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", caption =  "ANC") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels=scales::percent) 

ggsave("./output/figures_202107/AspPercTotXdbh_anc.png", width = 7, height = 5, dpi=300)
# ggsave("./output/figures_202107/AsppercTotXdbh_anc.pdf", width = 7, height = 5)

```

```{r, echo=FALSE, eval=FALSE}
## DBH --  original. Supplanted by bar chart above 
dbh.perc.anc <- asp.tally.dbh.tidy %>%
  filter(is.na(REMOVED)) %>% 
  # filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  # filter(FENCED == "N") %>%
  filter(SITE_TYPE == "ANC") %>%
  # filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) 

## bar plot
dbh.perc.anc %>%
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(timeClass, percentTot)) +
  # geom_col(aes(fill = DBHclGp01), color = "darkgray") +
  geom_col(aes(fill = DBHclGp01)) +
  facet_wrap(~SITE_ID, ncol = 5) +
  # scale_fill_manual(values = c("honeydew2", "honeydew3", "darkolivegreen")) +
  theme_minimal() +
  labs(y = "% total stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", caption = "Non-core sites, all plots") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent) 
  
# ggsave("./output/figures_202107/ANC_Live_PropDBH_bc.png", width = 8, height = 6, dpi = 300)

```

#### Kawuneeche Valley

```{r}
### revised plots 2021-02-09
# stacked sorted boxplot
## create color gradient 
# colorspace::sequential_hcl(4, "Teal")
# colorspace::sequential_hcl(4, "Greens")
# colorspace::sequential_hcl(4, "YlGnBu")
dbhclass.gradient <- c("#26185F", "#0095AF", "#9ADCBB", "#FCFFDD", "grey50")

# ANC  
dbh.anc.ak.joined %>% 
  filter(time_class %in% c("BL","2013","2018")) %>% 
  filter(site_type == "AK") %>% 
  ggplot(aes(reorder(site_id, sort.dbh), percent_tot)) +
  geom_col(aes(fill = dbh_class), color="grey50") +
  facet_wrap(~time_class, ncol = 1) +
  scale_fill_manual(values = dbhclass.gradient) +
  # scale_fill_viridis(discrete=TRUE) +
  theme_minimal() +
  labs(y = "% of total stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", caption = "AK") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels=scales::percent) 

ggsave("./output/figures_202107/AspPercTotXdbh_ak.png", width = 5, height = 5, dpi=300)
# ggsave("./output/figures_202107/AsppercTotXdbh_ak.pdf", width = 5, height = 5)

```

```{r asp_dbh_KV, eval=FALSE, echo=FALSE}
# old version
# _DBH classes: Unfenced and unburned plots_
## DBH
dbh.perc.kv <- asp.tally.dbh.tidy %>%
  filter(is.na(REMOVED)) %>% 
  # filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  # filter(FENCED == "N") %>%
  filter(SITE_TYPE == "AK") %>%
  # filter(timeClass %in% c('BL','2013','2018')) %>%
  # filter(timeClass == "BL" | timeClass == 2013 | timeClass == 2018) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) 

## bar plot
dbh.perc.kv %>%
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(timeClass, percentTot)) +
  # geom_col(aes(fill = DBHclGp01), color = "darkgray") +
  geom_col(aes(fill = DBHclGp01)) +
  facet_wrap(~SITE_ID, ncol = 4) +
  # scale_fill_viridis_d(option = "D") +
  # theme_minimal() +
  theme_minimal() +
  labs(y = "% total stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", caption = "Kawuneeche Valley only") +
  scale_fill_manual(values = c("honeydew2", "honeydew3", "darkolivegreen")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent) 

# ggsave("./output/figures_202107/AK_Live_PropDBH_bc.png", width = 8, height = 6, dpi = 300)

```

#### Proportion of plots with regeneration above threshold

```{r}
asp.tally.dbh.tidy %>%
  filter(is.na(REMOVED)) %>% 
  filter(LIVE_DEAD == "LIVE") %>%
  group_by(SITE_ID, timeClass, FENCED, BURNED) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) %>% 
  group_by(SITE_TYPE, FENCED, BURNED) %>% 
  descr(stemDen.ac, stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>%
  select(-variable) %>% 
  gt() %>% 
  tab_header(title = "Summary stats: Live stem density/acre")

```

```{r}
asp.tally.dbh.tidy %>%
  filter(is.na(REMOVED)) %>% 
  filter(LIVE_DEAD == "LIVE") %>%
  filter(SITE_TYPE != "AK") %>%
  group_by(SITE_ID, timeClass, FENCED, BURNED) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) %>% 
  # group_by(BURNED, FENCED) %>% 
  descr(stemDen.ac, stats = "common") %>% 
  tb() %>%
  mutate(across(where(is.numeric), round, 1)) %>%
  select(-variable) %>% 
  gt() %>% 
  tab_header(title = "Summary stats: Live stem density/acre", subtitle = "Combined AC and ANC plots")
```

```{r}
asp.tally.dbh.tidy %>%
  filter(is.na(REMOVED)) %>% 
  filter(LIVE_DEAD == "LIVE") %>%
  filter(SITE_TYPE != "AK") %>%
  group_by(SITE_ID, timeClass, FENCED, BURNED) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) %>% 
  group_by(BURNED, FENCED) %>% 
  descr(stemDen.ac, stats = "common") %>% 
  tb() %>%
  mutate(across(where(is.numeric), round, 1)) %>%
  select(-variable) %>% 
  gt() %>% 
  tab_header(title = "Summary stats: Live stem density/acre", subtitle = "Combined AC and ANC plots")
  
```

### Suckering by height class

```{r}

### Add Short/Tall stem field 
asp.tally.ht.tidy <- asp.tally.ht.tidy %>%
  mutate(FENCED = case_when(FENCED == "Y" ~ "Fenced",
                            FENCED == "N" ~ "Unfenced",
                            TRUE ~ FENCED)) %>% 
  mutate(shortTall = case_when(HTclass == 'HT_0_50_CM' ~ "short",
                               HTclass == 'HT_51_100_CM' ~ "short",
                               HTclass == 'HT_101_150_CM' ~ "short",
                               HTclass == 'HT_151_200_CM' ~ "tall",
                               HTclass == 'HT_201_250_CM' ~ "tall")
         )


asp.tally.ht.tidy <- asp.tally.ht.tidy %>% 
  mutate(HTclass.lbl = case_when(HTclass == "HT_0_50_CM" ~ "0-50 cm",
                                 HTclass == "HT_51_100_CM" ~ "51-100 cm",
                                 HTclass == "HT_101_150_CM" ~ "101-150 cm",
                                 HTclass == "HT_151_200_CM" ~ "151-200 cm",
                                 HTclass == "HT_201_250_CM" ~ "201+ cm",
                                 TRUE ~ "other")) %>% 
  mutate(HTclass.lbl =as_factor(HTclass.lbl))



```

```{r}
asp.tally.ht.tidy %>%
  group_by(SITE_TYPE, HTclass.lbl, timeClass) %>% 
  descr(stemDen.ac, stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  datatable()

```

**Summary by Range Type**
```{r}
asp.tally.ht.tidy %>%
  group_by(SITE_TYPE, HTclass.lbl, timeClass) %>% 
  descr(stemDen.ac, stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  datatable(caption = "All plots", filter = "bottom")

```

**Summary by Burned and Fenced - Combined Winter Range**
```{r}
asp.tally.ht.tidy %>%
  filter(SITE_TYPE != "AK") %>% 
  group_by(SITE_TYPE, HTclass.lbl, timeClass, BURNED, FENCED) %>% 
  descr(stemDen.ac, stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  datatable(caption = "All plots", filter = "bottom")

```
**Small Trees (0-10cm DBH)**)  
```{r, fig.height=8, fig.width=8}
### Core winter range
asp.tally.dbh.tidy %>%
  filter(DBHclGp01 == "0-2 cm" | DBHclGp01 == "2-10 cm") %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(SITE_ID != "AC01") %>% 
  filter(SITE_ID != "AC14") %>% 
  filter(SITE_ID != "AC68") %>% 
  # mutate(SITE_ID = glue::glue('{SITE_ID}({FENCED})')) %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "core winter range") %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = stemDen.ac), color = "grey80") +
  geom_tile(aes(color = FENCED), size=2, fill=NA) +
  scale_color_manual(values = c("red","grey80")) +
  # scale_fill_viridis_c() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # geom_text(aes(label = round(stemDen.ac,0)),color = "grey80", size = 2.7) +
  facet_wrap(~SITE_ID, ncol = 6) +
  theme_minimal() +
  labs(x = "", y = "", subtitle = "Aspen live stem density - 0-10cm DBH", title = "Core winter range", fill = "Stems/acre", y = "DBH class", color="") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/AC_ht_stemsAc_tile_0to10cm.png", width = 7.75, height = 5.5)

```

**Small Trees (0-10cm DBH)**)  
```{r, fig.height=8, fig.width=8}
### Core winter range
asp.tally.dbh.tidy %>%
  filter(DBHclGp01 != "0-2 cm" & DBHclGp01 != "2-10 cm") %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(SITE_ID != "AC01") %>% 
  filter(SITE_ID != "AC14") %>% 
  filter(SITE_ID != "AC68") %>% 
  # mutate(SITE_ID = glue::glue('{SITE_ID}({FENCED})')) %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "core winter range") %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = stemDen.ac), color = "grey80") +
  geom_tile(aes(color = FENCED), size = 0.8, fill=NA) +
  scale_color_manual(values = c("red","grey80")) +
  # scale_fill_viridis_c() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # geom_text(aes(label = round(stemDen.ac,0)),color = "grey80", size = 2.7) +
  facet_wrap(~SITE_ID, ncol = 6) +
  theme_minimal() +
  labs(x = "", y = "", subtitle = "Aspen live stem density - 10+cm DBH", title = "Core winter range", fill = "Stems/acre", y = "DBH class", color="") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/AC_ht_stemsAc_tile_10pluscm.png", width = 7.75, height = 5.5)

```




```{r}
## join in dbh with height classes

asp.dbh2join <- asp.tally.dbh.tidy %>%
  select(c(SITE_ID, timeClass, DBHclGp01)) 

ht.dbh.class <- left_join(asp.tally.ht.tidy, asp.dbh2join) %>% 
  filter(LIVE_DEAD != "DEAD") %>% 
  select(c(SITE_TYPE, SITE_ID, timeClass, stemTally, stemDen.ac, BURNED, FENCED, RANGE_TYPE, VALLEY, DBHclGp01, HTclass, shortTall))


ht.dbh.class <- ht.dbh.class %>%
    mutate(RANGE_TYPE = case_when(grepl("AC", SITE_ID) & is.na(RANGE_TYPE) ~ "core winter range",
                            TRUE ~ RANGE_TYPE))

## factor levels
ht.dbh.class <- ht.dbh.class %>% 
  mutate(HTclass = as_factor(HTclass)) 

# levels(ht.dbh.class$HTclass.lbl)

# create a labeling field for height class
ht.dbh.class <- ht.dbh.class %>%
  mutate(HTclass.lbl = case_when(HTclass == "HT_0_50_CM" ~ "0-50 cm",
                                 HTclass == "HT_51_100_CM" ~ "51-100 cm",
                                 HTclass == "HT_101_150_CM" ~ "101-150 cm",
                                 HTclass == "HT_151_200_CM" ~ "151-200 cm",
                                 HTclass == "HT_201_250_CM" ~ "201+ cm",
                                 TRUE ~ "other")) %>% 
  mutate(HTclass.lbl =as_factor(HTclass.lbl))

```

```{r}
# All stem diameters
suckering.vtype <- ht.dbh.class %>%
  # filter(HTclass == "HT_151_200_CM" |HTclass == "HT_201_250_CM") %>%
  group_by(SITE_ID, RANGE_TYPE, FENCED, timeClass) %>% 
  summarise(stemTally.all_dbh = sum(stemTally)) %>%
  mutate(stemDen.ac = stemTally.all_dbh *161.8744) %>% # converts stems/2m2 plot to stems/acre) %>% 
  # mutate(suckering_class = case_when(stemDen.ac < 1700 ~ "Poor (<1,700 stems/acre)",
  #                                  stemDen.ac >=1700 & stemDen.ac <4500 ~ "Moderate (1,700-4,500 stems/acre)",
  #                                  stemDen.ac >=4500 ~ "High (>4500 stems/acre)")) %>% 
  mutate(stemDen.ha = stemTally.all_dbh *400) %>% 
  mutate(suckering_class = case_when(stemDen.ac < 1700 ~ "Poor",
                                   stemDen.ac >=1700 & stemDen.ac <4500 ~ "Moderate",
                                   stemDen.ac >=4500 ~ "High")) %>% 
  ungroup()

```


###Tall saplings (1.5-2.5m tall)

```{r}
### suckering classes: by range type
# the following combines the tally for stems between 1.5 and 2.5 m
suckering.vtype.tallsap <- ht.dbh.class %>%
  filter(HTclass == "HT_151_200_CM" |HTclass == "HT_201_250_CM") %>%
  group_by(SITE_ID, RANGE_TYPE, FENCED, timeClass) %>% 
  summarise(stemTally.1p5to2m = sum(stemTally)) %>%
  mutate(stemDen.ac = stemTally.1p5to2m *161.8744) %>% # converts stems/2m2 plot to stems/acre) %>% 
  # mutate(suckering_class = case_when(stemDen.ac < 1700 ~ "Poor (<1,700 stems/acre)",
  #                                  stemDen.ac >=1700 & stemDen.ac <4500 ~ "Moderate (1,700-4,500 stems/acre)",
  #                                  stemDen.ac >=4500 ~ "High (>4500 stems/acre)")) %>% 
  mutate(stemDen.ha = stemTally.1p5to2m *400) %>% 
  mutate(suckering_class = case_when(stemDen.ac < 1700 ~ "Poor",
                                   stemDen.ac >=1700 & stemDen.ac <4500 ~ "Moderate",
                                   stemDen.ac >=4500 ~ "High")) %>% 
  ungroup()

```


```{r}
pl.tallsap.wc.f <- suckering.vtype.tallsap %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(RANGE_TYPE == "core winter range") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  filter(FENCED == "Fenced") %>%
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "grey80") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  # scale_fill_grey() +
  theme(legend.position = "bottom") +
  scale_fill_manual(values = colfunc2(3)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "bottom") +
  labs(x = "", y = "Site ID", fill = "") +
  facet_wrap(~FENCED, scales = "free_y") +
  coord_flip() +
  labs(title = "Core range")

pl.tallsap.wc.uf <- suckering.vtype.tallsap %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(FENCED == "Unfenced") %>% 
  filter(RANGE_TYPE == "core winter range") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "grey80") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  # scale_fill_grey() +
  theme(legend.position = "bottom") +
  scale_fill_manual(values = colfunc2(3)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "none") +
  labs(x = "", y = "Site ID", fill = "") +
  facet_wrap(~FENCED, scales = "free_y") +
  coord_flip() +
  labs(title = "Core range")

# wnc
pl.tallsap.wnc <- suckering.vtype.tallsap %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(RANGE_TYPE == "non-core winter range") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "grey80") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  # scale_fill_grey() +
  theme(legend.position = "bottom") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = colfunc2(3)) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(x = "", y = "Site ID", fill = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # facet_wrap(~FENCED, scales = "free_y") +
  coord_flip() +
  labs(title = "Noncore range")

pl.tallsap.wc.uf / (pl.tallsap.wc.f +  pl.tallsap.wnc) + 
  # plot_layout(ncol = 1)
  plot_layout(ncol=1) +
  plot_annotation(title="Tall saplings (1.5-2.5m tall)")

ggsave("./output/figures_202107/ACANC_tallsap_1p5_2p5m_3panel.png", width = 8.25, height = 5)
```


###Short saplings
```{r}
### suckering classes: by range type
# the following combines the tally for stems between 1.5 and 2.5 m
suckering.vtype.shortsap <- ht.dbh.class %>%
  filter(HTclass != "HT_151_200_CM" & HTclass != "HT_201_250_CM") %>%
  group_by(SITE_ID, RANGE_TYPE, FENCED, timeClass) %>% 
  summarise(stemTally.1p5to2m = sum(stemTally)) %>%
  mutate(stemDen.ac = stemTally.1p5to2m *161.8744) %>% # converts stems/2m2 plot to stems/acre) %>% 
  # mutate(suckering_class = case_when(stemDen.ac < 1700 ~ "Poor (<1,700 stems/acre)",
  #                                  stemDen.ac >=1700 & stemDen.ac <4500 ~ "Moderate (1,700-4,500 stems/acre)",
  #                                  stemDen.ac >=4500 ~ "High (>4500 stems/acre)")) %>% 
  mutate(stemDen.ha = stemTally.1p5to2m *400) %>% 
  mutate(suckering_class = case_when(stemDen.ac < 1700 ~ "Poor",
                                   stemDen.ac >=1700 & stemDen.ac <4500 ~ "Moderate",
                                   stemDen.ac >=4500 ~ "High")) %>% 
  ungroup()

```

```{r}
pl.shortsap.wc.f <- suckering.vtype.shortsap %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(RANGE_TYPE == "core winter range") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  filter(FENCED == "Fenced") %>%
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "grey80") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  # scale_fill_grey() +
  theme(legend.position = "bottom") +
  scale_fill_manual(values = colfunc2(3)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "bottom") +
  labs(x = "", y = "Site ID", fill = "") +
  facet_wrap(~FENCED, scales = "free_y") +
  coord_flip() +
  labs(title = "Core range")

pl.shortsap.wc.uf <- suckering.vtype.shortsap %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(FENCED == "Unfenced") %>% 
  filter(RANGE_TYPE == "core winter range") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "grey80") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  # scale_fill_grey() +
  theme(legend.position = "bottom") +
  scale_fill_manual(values = colfunc2(3)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "none") +
  labs(x = "", y = "Site ID", fill = "") +
  facet_wrap(~FENCED, scales = "free_y") +
  coord_flip() +
  labs(title = "Core range")

# wnc
pl.shortsap.wnc <- suckering.vtype.shortsap %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(RANGE_TYPE == "non-core winter range") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "grey80") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  # scale_fill_grey() +
  theme(legend.position = "bottom") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = colfunc2(3)) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(x = "", y = "Site ID", fill = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # facet_wrap(~FENCED, scales = "free_y") +
  coord_flip() +
  labs(title = "Noncore range")

pl.shortsap.wc.uf / (pl.shortsap.wc.f +  pl.shortsap.wnc) + 
  # plot_layout(ncol = 1)
  plot_layout(ncol=1) +
  plot_annotation(title="Short saplings (<1.5m tall)")

ggsave("./output/figures_202107/ACANC_shortsap_0_1p5m_3panel.png", width = 8.25, height = 5)
```

### Trees only: core vs. non-core winter range
```{r}
### TREES ONLY: core vs. non-core winter range
## fenced and unfenced
suckering.vtype %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  # filter(suckering_class == "")
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "grey80") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  scale_fill_manual(values = colfunc2(3)) +
  # scale_fill_grey() +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = "", y = "Site ID", fill = "", caption = "Stem density 1.5-2.5 m in ht. All plots") +
  facet_wrap(~RANGE_TYPE, scales = "free_y")

# ggsave("./output/figures_202107/AC_suck_1p5to2p5m.png", width = 6.5, height = 6)


## create summary of above
suckering.vtype %>%
  # filter(!is.na(RANGE_TYPE)) %>%
  # mutate(timeClass = as.character(timeClass)) %>% 
  filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>%
  mutate(timeClass = fct_drop(timeClass)) %>%
  # group_by(RANGE_TYPE, timeClass, suckering_class) %>% 
  tabyl(timeClass, suckering_class) %>% 
  rowwise() %>%
  mutate(sum = sum(c_across(High:Poor))) %>% 
  mutate(perc.high = High/sum*100) %>%
  mutate(perc.mod = Moderate/sum*100) %>%
  mutate(perc.poor = Poor/sum*100) %>%
  mutate(across(contains("perc"),round,1)) %>% 
  gt()


suckering.vtype %>%
  mutate(timeClass = as.character(timeClass)) %>% 
  filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>%
  # mutate(timeClass = fct_drop(timeClass, only = "2018")) %>% 
  # group_by(RANGE_TYPE, timeClass, suckering_class) %>% 
  tabyl(timeClass, suckering_class) %>% 
  rowwise() %>%
  mutate(sum = sum(c_across(High:Poor))) %>% 
  mutate(perc.high = High/sum) %>%
  mutate(perc.mod = Moderate/sum) %>%
  mutate(perc.poor = Poor/sum) %>%
  pivot_longer(cols = contains("perc."),names_to = "perc_class") %>%
  mutate(perc_class = case_when(perc_class == "perc.high" ~ "High",
                                perc_class == "perc.mod" ~ "Moderate",
                                perc_class == "perc.poor" ~ "Poor")) %>% 
  mutate(timeClass = fct_relevel(timeClass, "BL")) %>% 
  ggplot(aes(timeClass, value)) +
  geom_col(aes(fill = perc_class)) +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(3)) +
  # scale_fill_grey() +
  labs(x="", y = "Percent of plots in condition class", fill = "", caption = "Suckering condition class, combined AC and ANC plots") +
  scale_y_continuous(labels=scales::percent)

ggsave("./output/figures_202107/AspPercTotXsuckeringClass_ac_anc.png", width = 5, height = 5, dpi=300)

```

```{r, echo=FALSE, eval=FALSE}
# new above
```

```{r}
### All stems: core winter range
suckering.vtype %>%
  filter(!is.na(RANGE_TYPE)) %>% 
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  arrange(-stemDen.ac) %>% 
  datatable(rownames = FALSE, caption = "stemDen.ac aspen suckering 1.5 m to 2.5 m", filter = "top")

## broken out by fenced, just for AC
asp.pl.ac <- suckering.vtype %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(RANGE_TYPE == "core winter range") %>%
  # filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "grey80") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  scale_fill_grey() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(x = "", y = "Site ID", fill = "", title = "Core winter range") +
  # labs(x = "", y = "Site ID", fill = "", caption = "Suckering: Stem density 1.5 m to 2.5 m in ht. AC plots only") +
  # facet_grid(FENCED~RANGE_TYPE)
  facet_wrap(~FENCED, scales = "free_y")

# asp.pl.ac
# ggsave("./output/figures_202107/AC_suckering_1p5to2p5m_fenced.png", width = 5.5, height = 5)

asp.pl.anc <- suckering.vtype %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(RANGE_TYPE == "non-core winter range") %>%
  # filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "grey80") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  scale_fill_grey() +
  theme_minimal() +
  # theme(legend.position = "top") +
  # labs(x = "", y = "Site ID", fill = "", caption = "Suckering: Stem density 1.5 m to 2.5 m in ht. AC plots only") +
  labs(x = "", y = "Site ID",title = "Non-core range", fill = "") +
  # facet_grid(FENCED~RANGE_TYPE)
  facet_wrap(~FENCED, scales = "free_y")

# asp.pl.anc


## combine
library(patchwork)
asp.pl.ac + asp.pl.anc + plot_layout(ncol=2,widths=c(2,1))

## save revised figure
ggsave("./output/figures_202107AC_ANC_suckering_1p5to2p5m_fenced.png", width = 7.5, height = 5)

```

```{r}
### All stems: non-core winter range
## broken out by fenced, just for AC
suckering.vtype %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(RANGE_TYPE == "non-core winter range") %>%
  # filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "grey80") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  scale_fill_grey() +
  theme_minimal() +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "", caption = "Suckering: Stem density 1.5 m to 2.5 m in ht. AC plots only") +
  # facet_grid(FENCED~RANGE_TYPE)
  facet_wrap(~FENCED, scales = "free_y")

# ggsave("./output/figures_202107/ANC_suckering_1p5to2p5m_fenced.png", width = 5.5, height = 5)
```

```{r}
### All stems: response to burning
suckering.vtype.burned.allHt <- ht.dbh.class %>%
  distinct() %>%
  # filter(HTclass == "HT_151_200_CM" |HTclass == "HT_201_250_CM") %>%
  group_by(SITE_ID, HTclass.lbl, DBHclGp01, RANGE_TYPE, FENCED, BURNED, timeClass) %>% 
  summarise(count = n(), stemTally.htclass = sum(stemTally), mean.tally = mean(stemTally, na.rm=TRUE)) %>%
  ungroup() %>% 
  mutate(stemDen.ac = stemTally.htclass *161.8744) %>% 
  mutate(stemDen.ha = round((stemTally.htclass*400),0)) # convert to ha

####### burned ha
suckering.vtype.burned.allHt %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(BURNED == "Burned") %>% 
  filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = stemDen.ha), color = "grey80") +
  # geom_tile(aes(color = FENCED, fill = stemDen.ha)) + # scale_fill_grey() +
  theme_minimal() +
  # scale_fill_viridis(trans = "log") +
  # scale_fill_viridis() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # scale_fill_gradient(low = "black", high = "grey") +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "stems/ha", caption = "Suckering: Stem density ha AC - BURNED") +
  facet_wrap(~HTclass.lbl, ncol = 5)
ggsave("./output/figures_202107/AC_suck_burned_ht_class_den_ha_bw.png", width = 7.5, height = 3.25)


# ggsave("./output/figures_202107/AC_suck_burned_ht_class_den_ha.png", width = 7.5, height = 3.25)


####### burned acre
suckering.vtype.burned.allHt %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(BURNED == "Burned") %>% 
  filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = stemDen.ac), color = "grey80") +
  # geom_tile(aes(color = FENCED, fill = stemDen.ha)) + # scale_fill_grey() +
  theme_minimal() +
  # scale_fill_viridis(trans = "log") +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # scale_fill_viridis() +
  # scale_fill_gradient(low = "black", high = "grey") +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "stems/acre", caption = "Suckering: Stem density acre AC - BURNED") +
  facet_wrap(~HTclass.lbl, ncol = 5)
  
ggsave("./output/figures_202107/AC_suck_burned_ht_class_den_acre.png", width = 7.5, height = 3.25)

## ha
# suckering.vtype.burned.allHt %>%
#   filter(!is.na(RANGE_TYPE)) %>%
#   filter(BURNED == "Burned") %>% 
#   filter(RANGE_TYPE == "core winter range" ) %>%
#   filter(timeClass %in% c("BL","2013","2018")) %>% 
#   ggplot(aes(timeClass, SITE_ID)) +
#   # geom_tile(aes(fill = stemDen.ha), color = "grey80") +
#   geom_text(aes(label = stemDen.ha),angle=45) +
#   theme_minimal() +
#   scale_fill_viridis() +
#   # theme(legend.position = "top") +
#   labs(x = "", y = "Site ID", fill = "stems/ha", caption = "Suckering: Stem density ha AC - BURNED") +
#   facet_wrap(~HTclass.lbl, scales = "free_y", ncol = 5)

####### burned acre
suckering.vtype.burned.allHt %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(BURNED == "Burned") %>% 
  filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = stemDen.ac), color = "grey80") +
  # geom_tile(aes(color = FENCED, fill = stemDen.ha)) + # scale_fill_grey() +
  theme_minimal() +
  # scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # scale_fill_gradient(low = "black", high = "grey") +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "stems/acre", caption = "Suckering: Stem density acre AC - BURNED")

ggsave("./output/figures_202107/AC_suck_burned_ht_class_den_acre.png", width = 7.5, height = 3.25)

### unburned ha
suckering.vtype.burned.allHt %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(BURNED == "Unburned") %>% 
  filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = stemDen.ha), color = "grey80") +
  # geom_tile(aes(color = FENCED, fill = stemDen.ha)) + # scale_fill_grey() +
  theme_minimal() +
  # scale_fill_viridis() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # scale_fill_gradient(low = "black", high = "grey") +
  # theme(legend.position = "bottom") +
  labs(x = "", y = "Site ID", fill = "stems/ha", caption = "Suckering: Stem density ha AC - UNBURNED") +
  facet_wrap(~HTclass.lbl, ncol = 5)

ggsave("./output/figures_202107/AC_suck_unburned_ht_class_den_ha.png", width = 7.5, height = 7.25)

### unburned acre
suckering.vtype.burned.allHt %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(BURNED == "Unburned") %>% 
  filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = stemDen.ac), color = "grey80") +
  # geom_tile(aes(color = FENCED, fill = stemDen.ha)) + # scale_fill_grey() +
  theme_minimal() +
  # scale_fill_viridis() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # scale_fill_gradient(low = "black", high = "grey") +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "stems/acre", caption = "Suckering: Stem density acre AC - UNBURNED") +
  facet_wrap(~HTclass.lbl, ncol = 5)

ggsave("./output/figures_202107/AC_suck_unburned_ht_class_den_acre.png", width = 7.5, height = 7.25)

```

```{r}
### unburned acre
suckering.vtype.burned.allHt %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(BURNED == "Unburned") %>% 
  # filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = stemDen.ac), color = "grey80") +
  # geom_tile(aes(color = FENCED, fill = stemDen.ha)) + # scale_fill_grey() +
  theme_minimal() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # scale_fill_viridis() +
  # scale_fill_gradient(low = "black", high = "grey") +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "stems/acre", caption = "Suckering: Stem density acre AC - UNBURNED") +
  facet_grid()
  # facet_wrap(~HTclass.lbl, ncol = 5)
```

```{r}
#### Tall stems (>1.5 m height)
### just the stems >1.5 m
suckering.vtype.burned <- ht.dbh.class %>%
    filter(HTclass == "HT_151_200_CM" |HTclass == "HT_201_250_CM") %>%
  group_by(SITE_ID, RANGE_TYPE, FENCED, BURNED, timeClass) %>% 
  summarise(stemTally.1p5to2m = sum(stemTally)) %>%
  mutate(stemDen.ac = stemTally.1p5to2m *161.8744) %>% # converts stems/2m2 plot to stems/acre) %>% 
  # mutate(suckering_class = case_when(stemDen.ac < 1700 ~ "Poor (<1,700 stems/acre)",
  #                                  stemDen.ac >=1700 & stemDen.ac <4500 ~ "Moderate (1,700-4,500 stems/acre)",
  #                                  stemDen.ac >=4500 ~ "High (>4500 stems/acre)")) %>% 
  mutate(suckering_class = case_when(stemDen.ac < 1700 ~ "Poor",
                                   stemDen.ac >=1700 & stemDen.ac <4500 ~ "Moderate",
                                   stemDen.ac >=4500 ~ "High")) %>% 
  ungroup()

## Burned vs unburned AC
suckering.vtype.burned %>%
  filter(!is.na(RANGE_TYPE)) %>%
  # distinct(RANGE_TYPE)
  # filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "grey80") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  scale_fill_grey() +
  # scale_fill_manual(values = colfunc2(3)) +
  theme_minimal() +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "", caption = "Suckering: Stem density 1.5-2.5 m in ht. AC") +
  facet_wrap(~BURNED, scales = "free_y")
  

# ggsave("./output/figures_202107/AC_suck_1p5to2p5m_AC_burned_bw.png", width = 4.5, height = 5.5)


#########
## Burned vs unburned ANC
suckering.vtype.burned %>%
  filter(!is.na(RANGE_TYPE)) %>%
  # distinct(RANGE_TYPE)
  # filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(RANGE_TYPE == "non-core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "grey80") +
  scale_fill_grey() +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  theme_minimal() +
  theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "", caption = "Suckering: Stem density 1.5-2.5 m in ht. ANC") +
  facet_wrap(~BURNED, scales = "free_y")

# ggsave("./output/figures_202107/suck_1p5to2p5m_ANC_burned_bw.png", width = 4.5, height = 5.5)

```

```{r}
### calculate the percent of plots in different suckering classes for all factors and site types
suck.class.summary <- suckering.vtype.burned %>%
  group_by(RANGE_TYPE, BURNED, FENCED, timeClass) %>% 
  mutate(n_denom = n()) %>% 
  ungroup() %>% 
  group_by(RANGE_TYPE, BURNED, FENCED, timeClass,suckering_class, n_denom) %>% 
  tally() %>%
  mutate(perc_in_class = (round((n/n_denom*100),1))) %>% 
  ungroup()
  
suck.class.summary %>% 
  datatable()

## AC  
suck.class.summary %>%
  filter(RANGE_TYPE == "core winter range") %>% 
  ggplot(aes(timeClass,perc_in_class)) +
  geom_col(aes(fill = suckering_class)) +
  scale_fill_grey() +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  theme_minimal() +
  # theme(legend.position = "top") +
  labs(x = "", y = "% of plots in class", fill = "", caption = "Suckering: Stem density 1.5-2.5 m in ht. AC") +
  # geom_text(aes(label = perc_in_class)) +
  facet_wrap(~BURNED, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(BURNED ~ FENCED)

# ggsave("./output/figures_202107/suck_class_AC_burned_fenced_bw.png", width = 5.5, height = 3.75)

## alt text AC
suck.class.summary %>%
  filter(RANGE_TYPE == "core winter range") %>%
  ggplot(aes(timeClass,suckering_class)) +
  # geom_tile(aes(fill = BURNED), color = "grey80") +
  # geom_col(aes(fill = suckering_class)) +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  theme_minimal() +
  # theme(legend.position = "top") +
  labs(x = "", y = "", fill = "", caption = "Suckering: Stem density 1.5-2.5 m in ht.") +
  geom_text(aes(label = perc_in_class)) +
  facet_wrap(BURNED~FENCED, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures_202107/suck_class_AC_burned_fenced_text.png", width = 5.5, height = 3.75)


## ANC  
suck.class.summary %>%
  filter(RANGE_TYPE == "non-core winter range") %>% 
  ggplot(aes(timeClass,perc_in_class)) +
  geom_col(aes(fill = suckering_class)) +
  scale_fill_grey() +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  theme_minimal() +
  # theme(legend.position = "top") +
  labs(x = "", y = "% of plots in class", fill = "", caption = "Suckering: Stem density 1.5-2.5 m in ht. ANC") +
  # geom_text(aes(label = perc_in_class)) +
  facet_wrap(~BURNED, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(BURNED ~ FENCED)

# ggsave("./output/figures_202107/suck_class_ANC_burned_fenced_bw.png", width = 5.5, height = 3.75)

## alt text ANC
suck.class.summary %>%
  filter(RANGE_TYPE == "non-core winter range") %>%
  ggplot(aes(timeClass,suckering_class)) +
  # geom_tile(aes(fill = BURNED), color = "grey80") +
  # geom_col(aes(fill = suckering_class)) +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  theme_minimal() +
  # theme(legend.position = "top") +
  labs(x = "", y = "", fill = "", caption = "Suckering: Stem density 1.5-2.5 m in ht. ANC") +
  geom_text(aes(label = perc_in_class)) +
  facet_wrap(BURNED~FENCED, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}

# prop func
prop.fun <- function(x, cnt){
  x = x/cnt
  x
}

# suckering.vtype.tabyl %>% 
#   # glimpse()
#   # mutate(n = sum(`High (>4500 stems/acre)`,`Moderate (1,700-4,500 stems/acre)`,`Poor (<1,700 stems/acre)`)) %>% 
#   # mutate_if(.predicate = is.numeric, prop.fun())
#   gt()

# suckering.vtype %>% distinct(SITE_ID)

suckering.vtype <- suckering.vtype %>% 
  mutate(RANGE_TYPE = case_when(grepl("AC", SITE_ID) & is.na(RANGE_TYPE) ~ "core winter range",
                            TRUE ~ RANGE_TYPE)) 
#### calc the percent 
percent_suckering_class <- suckering.vtype %>% 
  filter(!is.na(RANGE_TYPE)) %>% 
  mutate(timeClass = as.character(timeClass)) %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  group_by(timeClass, RANGE_TYPE, suckering_class) %>% 
  summarise(sum_class = n()) %>% 
  ungroup() %>% 
  # tally()
  group_by(timeClass, RANGE_TYPE) %>% 
  mutate(n_allTimes = sum(sum_class)) %>% 
  ungroup() %>% 
  mutate(percent_in_class = 100*(sum_class/n_allTimes)) %>% 
  mutate(percent_in_class = round(percent_in_class, 1)) %>% 
  arrange(timeClass, suckering_class)
  
percent_suckering_class %>% 
  gt()
  
```

```{r}
# fig for report
percent_suckering_class %>% 
  mutate(timeClass = as_factor(timeClass)) %>%
  mutate(timeClass = relevel(timeClass, "BL")) %>% 
  ggplot(aes(timeClass, percent_in_class)) +
  geom_col(aes(fill = suckering_class)) +
  theme_minimal() +
  # scale_fill_manual(values = c("darkgreen","lightgreen","ivory3")) +
  scale_fill_grey() +
  labs(x = "", y = "Percent of plots", fill = "")  +
  facet_wrap(~RANGE_TYPE)# teme(legend.position = "top")

# ggsave("./output/figures_202107/suckering_proportion_all_plots_ht_class_bw2.png", width = 6.75, height = 3.95)

```

```{r}
#### calc the percent 
percent_suckering_class.vtype <- suckering.vtype %>% 
  filter(!is.na(RANGE_TYPE)) %>% 
  mutate(timeClass = as.character(timeClass)) %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  group_by(timeClass, suckering_class, RANGE_TYPE) %>% 
  summarise(sum_class = n()) %>% 
  ungroup() %>% 
  group_by(timeClass, RANGE_TYPE) %>% 
  mutate(n_allTimes = sum(sum_class)) %>% 
  ungroup() %>% 
  mutate(percent_in_class = 100*sum_class/n_allTimes) %>% 
  mutate(percent_in_class = round(percent_in_class, 1))
  

percent_suckering_class.vtype %>% 
  datatable()

```

```{r}
#### Fig for report
percent_suckering_class.vtype %>% 
  mutate(timeClass = as_factor(timeClass)) %>%
  mutate(timeClass = relevel(timeClass, "BL")) %>% 
  mutate(RANGE_TYPE = as_factor(RANGE_TYPE)) %>%
  mutate(RANGE_TYPE = relevel(RANGE_TYPE, "core winter range","non-core winter range")) %>%
  ggplot(aes(timeClass, percent_in_class)) +
  geom_col(aes(fill = suckering_class)) +
  # geom_text(aes(label = percent_in_class)) +
  theme_minimal() +
  scale_fill_grey() +
  # scale_fill_manual(values = c("darkgreen","lightgreen","ivory3")) +
  labs(x = "", y = "Percent of sites", fill = "") +
  facet_wrap(~RANGE_TYPE)

# ggsave("./output/figures_202107/suckering_proportion_all_plots_ht_class_rangety_bw3.png", width = 8, height = 3.85)

```

```{r}
ht.dbh.class %>%
  group_by(RANGE_TYPE, timeClass, BURNED, FENCED, DBHclGp01, HTclass) %>% 
  descr(round.digits = 1, stats = "common") %>% 
  tb() %>% 
  datatable(filter = "bottom")

```

```{r}
### Suckering: live unburned 
ht.dbh.class.ub <- ht.dbh.class %>%
  filter(BURNED == "Unburned")

```

```{r asp_ht_clean}

## list of plot lacking a value for "RANGE_TYPE"
## on inspection, these have been dropped
## e.g., AC41 was washed away in 2013 floods (see E. Ertl 2018 notes)
## AC01 -  near Grand Lake
## None of these have data for 2018
# asp.tally.ht.tidy %>% 
#   filter(is.na(RANGE_TYPE)) %>% 
#   distinct(SITE_ID)
#   View()
# # A tibble: 5 x 1
#   SITE_ID
#   <chr>  
# 1 AC01   
# 2 AC21   
# 3 AC41   
# 4 AC12   
# 5 AC14

## CLEAN
asp.tally.ht.tidy <- asp.tally.ht.tidy %>%
  filter(!is.na(valley_full))  %>% ## drop the 4 plots
  filter(is.na(REMOVED))

### create a better 'HTclass' for plotting
asp.tally.ht.tidy <- 
  asp.tally.ht.tidy %>% 
  mutate(HTclass2 = case_when(HTclass == "HT_0_50_CM" ~ "0-50cm",
                              HTclass == "HT_51_100_CM" ~ "51-100cm",
                              HTclass == "HT_101_150_CM" ~ "101-150cm",
                              HTclass == "HT_151_200_CM" ~ "151-200cm",
                              HTclass == "HT_201_250_CM" ~ "201-250cm")
         )


# set as factor, set levels
asp.tally.ht.tidy <- 
  asp.tally.ht.tidy %>% 
  mutate(HTclass2 = factor(HTclass2, levels = c("0-50cm", "51-100cm","101-150cm","151-200cm","201-250cm")))

```

```{r, fig.width=10, fig.height=8}
## MP specific
asp.tally.ht.tidy %>%
  # group_by(VALLEY) %>% tally()
  filter(VALLEY == "MP") %>% 
  ggplot(aes(HTclass2, stemTally)) +
  geom_col(aes(fill = LIVE_DEAD)) +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  labs(x = "Height class", y = "Stem tally", fill = "", caption = "Moraine Park, all plots - Live/Dead") +
  facet_grid(SITE_ID ~ timeClass, as.table = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave(./output/figures_202107/MP_aspHt_stemTally.png, width = 6, height = 7.7, dpi = 300)

asp.tally.ht.tidy %>%
  # group_by(VALLEY) %>% tally()
  filter(FENCED == "Fenced") %>% 
  # filter(SITE_ID == "AC65") %>% 
  filter(VALLEY == "MP") %>% 
  ggplot(aes(HTclass2, stemTally)) +
  geom_col(aes(fill = LIVE_DEAD)) +
  labs(x = "Height class", y = "Stem tally", fill = "", caption = "Moraine Park, Fenced plots only - Live/Dead") +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  facet_grid(SITE_ID ~ timeClass, as.table = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/MP_aspHt_stemTally_fenced_only.png", width = 7.5, height = 4.7, dpi = 300)

## unfenced
asp.tally.ht.tidy %>%
  # group_by(VALLEY) %>% tally()
  filter(FENCED == "Unfenced") %>% 
  # filter(SITE_ID == "AC65") %>% 
  filter(VALLEY == "MP") %>% 
  ggplot(aes(HTclass2, stemTally)) +
  geom_col(aes(fill = LIVE_DEAD)) +
  labs(x = "Height class", y = "Stem tally", fill = "", caption = "Moraine Park, Unfenced plots only - Live/Dead") +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  facet_grid(SITE_ID ~ timeClass, as.table = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/MP_aspHt_stemTally_fenced_only.png", width = 6, height = 7.7, dpi = 300)

```

### AC dead trees (>2.5m)

**By Fencing and Burning**
```{r, eval=TRUE}
### AC dead stems --  by fencing
asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  filter(LIVE_DEAD == "DEAD") %>%
  group_by(FENCED, BURNED, timeClass) %>% 
  summarise(median.tally = median(stemTally, na.rm = TRUE),mean.tally = mean(stemTally, na.rm=TRUE), sum.tally = sum(stemTally), iqr.tally = IQR(stemTally, na.rm=TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, mean.tally)) +
  geom_col(aes(fill = FENCED), position = "dodge") +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  # scale_fill_grey() +
  labs(x = "", y = "Stem tally", fill = "", title = "Core winter range", caption = "AC plots - Sum of Dead Stems across all plots") 

ggsave("./output/figures_202107/AC_sum_dead.png", width = 3.75, height = 4)
```


```{r}
### AC dead stems --  by fencing
pl.bar.dead.ac <- asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  filter(LIVE_DEAD == "DEAD") %>%
  group_by(FENCED, BURNED, timeClass) %>% 
  summarise(median.tally = median(stemTally, na.rm = TRUE), sum.tally = sum(stemTally), iqr.tally = IQR(stemTally, na.rm=TRUE),mean.tally = mean(stemTally, na.rm=TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, mean.tally)) +
  geom_col(aes(fill = BURNED), position = "dodge") +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  # scale_fill_grey() +
  theme(legend.position = "none") +
  labs(x = "", y = "Stem count", fill = "", title = "Core range") +
  facet_wrap(~FENCED)

pl.bar.dead.anc <- asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "ANC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  filter(LIVE_DEAD == "DEAD") %>%
  group_by(BURNED, timeClass) %>% 
  summarise(median.tally = median(stemTally, na.rm = TRUE), sum.tally = sum(stemTally), iqr.tally = IQR(stemTally, na.rm=TRUE),mean.tally = mean(stemTally, na.rm=TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, mean.tally)) +
  geom_col(aes(fill = BURNED), position = "dodge") +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  # scale_fill_grey() +
  theme(legend.position = "bottom") +
  labs(x = "", y = "Stem count", fill = "", title = "Noncore Range") 

pl.bar.dead.ac + pl.bar.dead.anc + plot_layout(widths = c(1.75, 1))

ggsave("./output/figures_202107/AC_mean_dead_fenced_burned_combo.png", width = 6.75, height = 3.75)
```

```{r}
asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  filter(LIVE_DEAD == "DEAD") %>%
  group_by(FENCED, BURNED, timeClass) %>% 
  summarise(median.tally = median(stemTally, na.rm = TRUE), sum.tally = sum(stemTally), iqr.tally = IQR(stemTally, na.rm=TRUE),mean.tally = mean(stemTally, na.rm=TRUE),) %>% 
  ungroup() %>% 
  group_by(FENCED, BURNED, timeClass) %>%
  descr(mean.tally) %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  datatable()
```

```{r}
asp.tally.ht.tidy %>%
  filter(FENCED == "Fenced") %>% 
  filter(VALLEY == "MP") %>% 
  filter(timeClass %in% c("BL", "2013", "2018")) %>% 
  ggplot(aes(timeClass, stemTally)) +
  geom_col(aes(fill = LIVE_DEAD)) +
  facet_grid(SITE_ID ~ HTclass2, as.table = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = colfunc3(2)) +
  # scale_fill_manual(values = c("red", "blue")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "Stem count", fill = "", caption = "Moraine Park")

```

```{r}
## median by valley - AC
med.cnt.dbh.fenced.ac <- asp.tally.ht.tidy %>%
  filter(timeClass == "BL" |timeClass == "2013" |timeClass == "2018") %>% 
  filter(SITE_TYPE == "AC") %>% 
  group_by(timeClass, FENCED, VALLEY, HTclass2) %>% 
  summarise(med.tally = median(stemTally, na.rm = TRUE)) %>% 
  ungroup() 

med.cnt.dbh.fenced.ac %>% 
  pivot_wider(names_from = c(FENCED,timeClass), values_from = med.tally) %>% 
  gt()

med.cnt.dbh.fenced.ac %>%
  ggplot(aes(timeClass, HTclass2)) +
  geom_tile(aes(fill = med.tally), color = "grey80") +
  geom_text(aes(label = med.tally), color = "grey90") +
  facet_grid(VALLEY~FENCED, as.table = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_minimal() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # scale_fill_viridis() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "Height class", fill = "Stem count", caption = "AC plots only - Median stem count")

ggsave("./output/figures_202107/AC_fenced_medTally_alt.png", width = 4.75, height = 6.35, dpi = 300)

# for caption
# asp.tally.ht.tidy %>%
#   select(VALLEY, valley_full) %>% 
#   distinct() %>% 
#   mutate(txt = glue::glue("{VALLEY}: {valley_full}")) %>% 
#   select(txt) 

# c("c("HSP: Horseshoe Park", "UBM: Upper Beaver Meadows", "MP: Moraine Park", "BME: Beaver Meadows Entrance", "EV: EndoValley", "KV: Kawuneeche Valley", "HV: Hidden Valley", "DM: Deer Mountain", "RR: Roaring River", "CC: Cow Creek", "HLWP: Hollowell Park")")

asp.tally.ht.tidy %>%
  group_by(VALLEY) %>% 
  tally() %>% 
  gt()


```

```{r}
## Moraine park
asp.tally.ht.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(VALLEY == "MP") %>%
  ggplot(aes(HTclass2, timeClass)) +
  geom_tile(aes(fill = stemTally), color = "grey80") +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # scale_fill_viridis_c() +
  facet_wrap(~SITE_ID, ncol=6) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(caption = "Moraine Park plots", x = "Height class", y = "", fill = "n stems")

```


```{r}
## median by valley - ANC
med.cnt.dbh.fenced.anc <- asp.tally.ht.tidy %>%
  filter(timeClass == "BL" |timeClass == "2013" |timeClass == "2018") %>% 
  filter(SITE_TYPE == "ANC") %>% 
  group_by(timeClass, FENCED, VALLEY, HTclass2) %>% 
  summarise(med.tally = median(stemTally, na.rm = TRUE)) %>% 
  ungroup() 

med.cnt.dbh.fenced.anc %>% 
  pivot_wider(names_from = c(FENCED,timeClass), values_from = med.tally) %>% 
  gt()

med.cnt.dbh.fenced.anc %>%
  ggplot(aes(timeClass, HTclass2)) +
  geom_tile(aes(fill = med.tally), color = "grey80") +
  geom_text(aes(label = med.tally), color = "grey80") +
  # facet_grid(valley_full ~ FENCED, as.table = FALSE) +
  facet_grid(VALLEY~FENCED, as.table = FALSE) +
  # facet_grid(FENCED~VALLEY, as.table = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_minimal() +
  scale_fill_viridis() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "Height class", fill = "Stem count", caption = "ANC plots only - Median stem count")

# ggsave("./output/figures_202107/ANC_fenced_medTally_alt.png", width = 4.5, height = 7.5, dpi = 300)

#### 
# med.cnt.dbh.fenced.anc %>%
#   ggplot(aes(timeClass, HTclass2)) +
#   geom_tile(aes(fill = med.tally), color = "grey80") +
#   # facet_grid(valley_full ~ FENCED, as.table = FALSE) +
# 
#   facet_grid(FENCED~VALLEY, as.table = FALSE) +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#   theme_minimal() +
#   scale_fill_viridis() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#   # theme(legend.position = "top") +
#   labs(x = "", y = "Height class", fill = "Stem count", caption = "ANC plots only - Median stem count")

```

```{r}
med.cnt.dbh.fenced.ak <- asp.tally.ht.tidy %>%
  filter(timeClass == "BL" |timeClass == "2013" |timeClass == "2018") %>% 
  filter(SITE_TYPE == "AK") %>% 
  group_by(timeClass, FENCED, VALLEY, HTclass2) %>% 
  summarise(med.tally = median(stemTally, na.rm = TRUE)) %>% 
  ungroup() 

med.cnt.dbh.fenced.ak %>% 
  pivot_wider(names_from = c(FENCED,timeClass), values_from = med.tally) %>% 
  gt() %>% 
  tab_header(title = "median tally AK")

med.cnt.dbh.fenced.ak %>%
  ggplot(aes(timeClass, HTclass2)) +
  geom_tile(aes(fill = med.tally), color = "grey80") +
  geom_text(aes(label = med.tally), color = "grey80") +
  facet_grid(FENCED~VALLEY, as.table = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_minimal() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  # scale_fill_viridis() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "Height class", fill = "Stem count", caption = "AK plots only - Median stem count")

ggsave("./output/figures_202107/AK_fenced_medTally.png", width = 4.25, height = 3.25, dpi = 300)

```

```{r asp_tally_tileTxt, include=TRUE, fig.width=11, fig.height=8}
### Live stem tally: core winter range
### Core winter range: Aspen Stem Tallies

## tally of core winter range - LIVE
asp.tally.ht.tidy %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  mutate(SITE_ID = glue::glue('{SITE_ID}-{FENCED}')) %>% 
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "core winter range") %>%
  ggplot(aes(timeClass, HTclass2)) +
  geom_tile(aes(fill = stemTally), color = "grey80", alpha = .5) +
  geom_text(aes(label = stemTally), size = 3) +
  facet_wrap(~SITE_ID) +
  theme_minimal() +
  # scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  labs(x = "", y = "", title = "Core winter range: Aspen live stem tallies", fill = "n stems") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/asp_AC_liveTally_revised.png", width = 8.75, height = 8.5, dpi = 300)


## tally of core winter range - DEAD
# asp.tally.ht.tidy %>%
#   filter(LIVE_DEAD == 'DEAD') %>% 
#   filter(RANGE_TYPE == "core winter range") %>%
#   ggplot(aes(timeClass, HTclass2)) +
#   geom_tile(aes(fill = FENCED), color = "grey80", alpha = .2) +
#   geom_text(aes(label = stemTally), size = 3) +
#   facet_wrap(~SITE_ID) +
#   theme_minimal() +
#   labs(x = "", y = "", title = "Moraine Park: Aspen dead stem tallies") +
#   # facet_grid(SITE_ID ~ timeClass) +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ANC
## tally of NON-core winter range - LIVE
asp.tally.ht.tidy %>% # distinct(RANGE_TYPE)
  filter(LIVE_DEAD == 'LIVE') %>%
  # distinct(RANGE_TYPE)
  filter(RANGE_TYPE == "non-core winter range") %>%
  filter(SITE_ID != "ANC24") %>% 
  ggplot(aes(timeClass, HTclass2)) +
  # geom_tile(aes(fill = FENCED), color = "grey80", alpha = .2) +
  geom_tile(aes(fill = stemTally), color = "grey80") +
  # geom_text(aes(label = stemTally), size = 3) +
  # scale_fill_viridis_c() +
  # scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~SITE_ID) +
  theme_minimal() +
  labs(x = "", y = "", title = "Non-core winter range: Aspen live stem tallies", fill = "n stems") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/asp_ANC_liveTally.png", width = 7.125, height = 5.75, dpi = 300)

```

```{r}
## tally of KV - LIVE
asp.tally.ht.tidy %>% # distinct(RANGE_TYPE)
  filter(LIVE_DEAD == 'LIVE') %>%
  filter(RANGE_TYPE == "Kawuneeche Valley") %>%
  # filter(SITE_ID != "ANC24") %>% 
  ggplot(aes(timeClass, HTclass2)) +
  # geom_tile(aes(fill = FENCED), color = "grey80", alpha = .2) +
  geom_tile(aes(fill = stemTally), color = "grey80") +
  geom_text(aes(label = stemTally), size = 3) +
  # scale_fill_viridis_c() +
  # scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~SITE_ID, ncol = 4) +
  theme_minimal() +
  labs(x = "", y = "", title = "Kawuneeche Valley: Aspen live stem tallies", fill = "n stems") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/asp_KV_liveTallyx.png", width = 6.5, height = 4, dpi = 300)

```

```{r, eval=TRUE}

## tally of MP - LIVE
asp.tally.ht.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(VALLEY == "MP") %>%
  # filter(VALLEY == "EV") %>% 
  ggplot(aes(timeClass, HTclass2)) +
  geom_tile(aes(fill = FENCED), color = "grey80", alpha = .2) +
  geom_text(aes(label = stemTally), size = 3) +
  # geom_tile(aes(fill = stemTally), color = "grey80") +
  # scale_fill_viridis_c() +
  facet_wrap(~SITE_ID) +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  labs(fill="", x = "", y = "", title = "Moraine Park: Aspen live stem tallies") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/asp_MP_liveTally_dbh.png", width = 9.5, height = 7, dpi = 300)

## tally of MP - DEAD
asp.tally.ht.tidy %>%
  filter(LIVE_DEAD == 'DEAD') %>% 
  filter(VALLEY == "MP") %>%
  ggplot(aes(timeClass, HTclass2)) +
  geom_tile(aes(fill = FENCED), color = "grey80", alpha = .2) +
  geom_text(aes(label = stemTally), size = 3) +
  scale_fill_manual(values = colfunc3(2)) +
  facet_wrap(~SITE_ID) +
  theme_minimal() +
  labs(x = "", y = "", title = "Moraine Park: Aspen dead stem tallies", fill="") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/asp_MP_deadTally_dbh.png", width = 9.5, height = 7, dpi = 300)

```

```{r aspHtClass}
## calc percentage in height classes
asp.tally.ht.tidy <- asp.tally.ht.tidy %>%
  filter(is.na(REMOVED)) %>% 
  filter(LIVE_DEAD == "LIVE") %>%
  filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) #%>% 
  # mutate(percentTot = 100*round(percentTot,1)) 

ht.perc01 <- asp.tally.ht.tidy
```

```{r, fig.width=7, fig.height=10}
# Proportion of Live Aspen Stems by Height Class
## heatmap: 
f.plot1 <- ht.perc01 %>%
  filter(SITE_TYPE != "AK") %>% 
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  filter(FENCED == "Fenced") %>%
  filter(SITE_ID != "AC33") %>% 
  filter(SITE_ID != "AC67") %>% 
  filter(!is.nan(percentTot)) %>%
  # mutate(SITE_ID = glue::glue('{SITE_ID}-{FENCED}')) %>% 
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'white', alpha = .8) +
  # geom_text(aes(label = percentTot), size = 3) +
  facet_wrap(~timeClass) +
  scale_fill_gradientn(colours = c("#FCFFDD","#0095AF")) +
  # scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  theme_minimal() +
  # labs(x = "Height class", y = "", fill = "% total stems", caption = "Proportion of Live Aspen Stems by Height Class - Fenced plots only") +
  # theme(axis.title.x=element_blank(),
  #       axis.text.x=element_blank(),
  #       axis.ticks.x=element_blank()) +
  scale_x_discrete(labels = NULL, breaks = NULL) +
  labs(x = "", y = "", fill = "% total stems", title="Fenced") +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ht.perc01 %>% distinct(SITE_TYPE)

uf.plot1 <- ht.perc01 %>%
  filter(SITE_TYPE != "AK") %>%
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  filter(FENCED == "Unfenced") %>%
  filter(SITE_ID != "AC33") %>% 
  filter(SITE_ID != "AC67") %>% 
  filter(!is.nan(percentTot)) %>%
  # mutate(SITE_ID = glue::glue('{SITE_ID}-{FENCED}')) %>% 
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'white', alpha = .8) +
  # geom_text(aes(label = percentTot), size = 3) +
  facet_wrap(~timeClass) +
  scale_fill_gradientn(colours = c("#FCFFDD","#0095AF")) +
  # scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  # theme_bw() +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = "Height class", y = "", fill = "% total stems", title="Unfenced")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

combo.acanc <- f.plot1 + uf.plot1 + plot_layout(ncol = 1, heights = c(1, 3.3))
combo.acanc

# save plot
ggsave("./output/figures_202107/acanc_prop_height_raw_revised.png", width = 7.5, height = 12, dpi= 300)

```

```{r}
ht.perc01 %>%
  filter(SITE_TYPE != "AK") %>% 
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  filter(FENCED == "Fenced") %>%
  filter(SITE_ID != "AC33") %>% 
  filter(SITE_ID != "AC67") %>% 
  filter(!is.nan(percentTot)) %>%
  # mutate(SITE_ID = glue::glue('{SITE_ID}-{FENCED}')) %>% 
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'white', alpha = .8) +
  geom_text(aes(label = percentTot), size = 2.75) +
  # facet_grid(.~timeClass) +
  facet_wrap(~timeClass) +
  scale_fill_gradientn(colours = c("#FCFFDD","#0095AF")) +
  # scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  # theme_bw() +
  theme_minimal() +
  labs(x = "Height class", y = "", fill = "% total stems")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_flip()
# 
ggsave("./output/figures_202107/AC_prop_height_raw_revised.png", width = 9, height = 3.25, dpi= 300)

```

### Heatmaps - Trees, Fenced/Unfenced
```{r aspHtClass_plots}

## heatmap: fenced
ht.perc01 %>%
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  filter(FENCED == "Fenced") %>%
  filter(SITE_ID != "AC33") %>% 
  filter(SITE_ID != "AC67") %>% 
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'white', alpha = .8) +
  geom_text(aes(label = percentTot), size = 3) +
  # facet_grid(.~timeClass) +
  facet_wrap(~timeClass) +
  scale_fill_gradientn(colours = c("#FCFFDD","#0095AF")) +
  # scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  theme_minimal() +
  labs(x = "Height class", y = "", fill = "% total stems", caption = "")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures_202107/AC_Live_Fenced_heightClass_heatmap3b.png", width = 8.5, height = 4, dpi = 300)

ht.perc01 %>%
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  filter(FENCED == "Fenced") %>%
  filter(SITE_ID != "AC33") %>% 
  filter(SITE_ID != "AC67") %>% 
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'white', alpha = .8) +
  # geom_text(aes(label = percentTot), size = 3) +
  # facet_grid(.~timeClass) +
  facet_wrap(~timeClass) +
  scale_fill_gradientn(colours = c("#FCFFDD","#0095AF")) +
  # scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  theme_minimal() +
  labs(x = "Height class", y = "", fill = "% total stems", caption = "")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/AC_Live_Fenced_heightClass_heatmap3b.png", width = 8.5, height = 4, dpi = 300)




```

```{r}
## heatmap: unfenced
pl.hmap.ac.uf <- ht.perc01 %>%
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  filter(FENCED == "Unfenced") %>%
  # filter() %>% # live dead
  filter(SITE_ID != "AC07") %>% 
  filter(SITE_ID != "AC68") %>% 
  filter(!is.nan(percentTot)) %>%
  filter(SITE_TYPE == "AC") %>% 
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'grey80', alpha = 1) +
  # geom_text(aes(label = percentTot), size = 3) +
  facet_grid(.~timeClass) +
  scale_fill_gradientn(colours = c("#FCFFDD","#0095AF")) +
  # scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  theme_minimal() +
  labs(x = "Height class", y = "", fill = "% total stems", title = "Core range", subtitle = "Unfenced plots") +
  theme(legend.position = "bottom") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
pl.hmap.ac.uf
ggsave("./output/figures_202107/AC_unfenced_Live_HTclassXSiteID_heatmap_nolbl.png", width = 8.5, height = 6, dpi = 300)


ht.perc01 %>%
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  filter(FENCED == "Unfenced") %>%
  # filter() %>% # live dead
  filter(SITE_ID != "AC07") %>% 
  filter(SITE_ID != "AC68") %>% 
  filter(!is.nan(percentTot)) %>%
  filter(SITE_TYPE == "AC") %>% 
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'grey80', alpha = 1) +
  geom_text(aes(label = percentTot), size = 3) +
  facet_grid(.~timeClass) +
  scale_fill_gradientn(colours = c("#FCFFDD","#0095AF")) +
  # scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  theme_minimal() +
  labs(x = "Height class", y = "", fill = "% total stems", title = "Core range", subtitle = "Unfenced plots")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/AC_unfenced_Live_HTclassXSiteID_heatmap_lbl.png", width = 8.5, height = 10, dpi = 300)

```

```{r}
pl.hmap.ac.f <- ht.perc01 %>%
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  filter(FENCED == "Fenced") %>%
  # filter() %>% # live dead
  filter(SITE_ID != "AC07") %>% 
  filter(SITE_ID != "AC68") %>% 
  filter(!is.nan(percentTot)) %>%
  filter(SITE_TYPE == "AC") %>% 
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'grey80', alpha = 1) +
  # geom_text(aes(label = percentTot), size = 3) +
  facet_grid(.~timeClass) +
  scale_fill_gradientn(colours = c("#FCFFDD","#0095AF")) +
  # scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  theme_minimal() +
  labs(x = "Height class", y = "", fill = "% total stems", title = "Core range", subtitle = "Fenced plots")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
pl.hmap.ac.f
ggsave("./output/figures_202107//AC_fenced_Live_HTclassXSiteID_heatmap.png", width = 8.5, height = 6, dpi = 300)

ht.perc01 %>%
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  filter(FENCED == "Fenced") %>%
  # filter() %>% # live dead
  filter(SITE_ID != "AC07") %>% 
  filter(SITE_ID != "AC68") %>% 
  filter(!is.nan(percentTot)) %>%
  filter(SITE_TYPE == "AC") %>% 
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'grey80', alpha = 1) +
  geom_text(aes(label = percentTot), size = 3) +
  facet_grid(.~timeClass) +
  scale_fill_gradientn(colours = c("#FCFFDD","#0095AF")) +
  # scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  theme_minimal() +
  labs(x = "Height class", y = "", fill = "% total stems", title = "Core range", subtitle = "Fenced plots")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggsave("./output/figures_202107/AC_fenced_Live_HTclassXSiteID_heatmap_lbl.png", width = 8.5, height = 6, dpi = 300)


pl.hmap.ac.f + pl.hmap.ac.uf + plot_layout(ncol=1)
```

```{r}
## heatmap: KV
asp.tally.ht.tidy %>%
  filter(is.na(REMOVED)) %>% 
  filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
   filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) %>%
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  filter(RANGE_TYPE == "Kawuneeche Valley") %>%
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'white', alpha = .8) +
  geom_text(aes(label = percentTot), size = 3) +
  facet_grid(.~timeClass) +
  scale_fill_gradientn(colours = c("#FCFFDD","#0095AF")) +
  # scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  theme_minimal() +
  labs(x = "Height class", y = "", fill = "% total stems", title = "Proportion of Live Aspen Stems by Height Class", caption = "All plots")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_202107/KV_Live_unFenced_Unburned_heightClass_heatmap3b.png", width = 8.5, height = 6, dpi = 300)

```


```{r, echo=FALSE, eval=FALSE, fig.height=7.5, fig.height=6.5}
# original figs, replaced by chunk below
## bar chart: fenced
asp.prop.ac.f <- ht.perc01 %>%
  filter(SITE_ID != "AC33") %>% 
  filter(SITE_ID != "AC67") %>%
  filter(FENCED == "Fenced") %>% 
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(reorder(SITE_ID, percentTot), percentTot)) +
  geom_col(aes(fill = HTclass2)) +
  facet_wrap(~timeClass, ncol = 1) +
  # facet_grid(FENCED~timeClass) +
  scale_fill_grey() +
  # scale_fill_viridis_d(begin = .2, end = .95, direction = -1, option = "D") +
  # scale_fill_viridis_d(option = "D") +
  theme_minimal() +
  # theme_bw() +
  labs(y = "% of total stems", x = "", fill = "Height class", title = "Proportion of Live Aspen Stems by Height Class", subtitle = "Fenced plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent)

asp.prop.f  
# ggsave("./output/figures_202107/AC_Live_Fenced_heightClass_bd_bw.png", width = 8.5, height = 4.75, dpi = 300)
ggsave("./output/figures_202107/AC_Live_Fenced_heightClass_revised.png", width = 6.5, height = 7.5, dpi = 300)


# non-fenced
asp.prop.ac.nf <- ht.perc01 %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(SITE_ID != "AC33") %>% 
  filter(SITE_ID != "AC67") %>%
  filter(FENCED == "Unfenced") %>% 
  filter(!is.nan(percentTot)) %>%
  filter(!is.na(percentTot)) %>%  
  ggplot(aes(SITE_ID, percentTot)) +
  geom_col(aes(fill = HTclass2), color = "grey80") +
  facet_wrap(~timeClass, ncol = 1) +
  scale_fill_grey() +
  # scale_fill_manual(values = colfunc2(5)) +
  # facet_grid(FENCED~timeClass) +
  # scale_fill_viridis_d(begin = .2, end = .95, direction = -1, option = "D") +
  # scale_fill_viridis_d(option = "D") +
  theme_minimal() +
  labs(y = "% of total stems", x = "", fill = "Height class", title = "Proportion of Live Aspen Stems by Height Class", subtitle = "Unfenced plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent)

ggsave("./output/figures_202107/AC_Live_unFenced_heightClass_bc_bw.png", width = 7.5, height = 5.5, dpi = 300)

asp.prop.ac.nf

```

```{r, eval=FALSE, echo=FALSE}
## alt fig
ht.perc01 %>%
  filter(SITE_ID != "AC33") %>% 
  filter(SITE_ID != "AC67") %>%
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(SITE_ID, percentTot)) +
  geom_col(aes(fill = HTclass2)) +
  facet_grid(timeClass ~ FENCED) +
  scale_fill_manual(values = colfunc2(5)) +
  # scale_fill_viridis_d(begin = .2, end = .95, direction = -1, option = "D") +
  theme_minimal() +
  labs(y = "% of total stems", x = "", fill = "Height class", title = "Proportion of Live Aspen Stems by Height Class", subtitle = "Unfenced and unburned plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels=scales::percent)

```

### Percent of total stems in height class  
```{r}
# export fig10 here
### Revised figures for manuscript
## Generate lu for boxplot sorting on %stems in 0-50cm height class
sort.ht2join <- ht.perc01 %>%
  filter(timeClass == "BL") %>% 
  arrange(timeClass, HTclass) %>% 
  group_by(timeClass, HTclass, SITE_TYPE) %>% 
  dplyr::mutate(rank_HtClass_BL = rank(percentTot, ties.method = "first")) %>% 
  ungroup() %>% 
  filter(timeClass == "BL") %>% 
  select(SITE_TYPE, SITE_ID, HTclass, rank_HtClass_BL) %>% 
  distinct() %>% 
  arrange(SITE_TYPE, HTclass, rank_HtClass_BL, SITE_ID) %>% 
  pivot_wider(names_from = HTclass, 
              names_glue = "sort_{HTclass}",
              values_from = rank_HtClass_BL) %>% 
  arrange(SITE_TYPE, desc(sort_HT_0_50_CM), SITE_ID) %>% 
  select(2:5) %>% 
  distinct()

# AC  
plot.percTot.AC.F <- full_join(ht.perc01,sort.ht2join) %>% 
  filter(SITE_TYPE == "AC" & FENCED == "Fenced") %>% 
  ggplot(aes(reorder(SITE_ID, -sort_HT_0_50_CM), percentTot)) +
  geom_col(aes(fill = HTclass2)) +
  facet_wrap(~timeClass, ncol = 1) +
  scale_fill_manual(values = colfunc2(5)) +
  # scale_fill_viridis(discrete=TRUE) +
  theme_minimal() +
  labs(y = "% of total stems", x = "", fill = "Height class", title = "Core Range", subtitle = "Fenced plots") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels=scales::percent) +
  theme(legend.position = "none")

plot.percTot.AC.UF <- full_join(ht.perc01,sort.ht2join) %>% 
  filter(SITE_TYPE == "AC" & FENCED == "Unfenced") %>% 
  ggplot(aes(reorder(SITE_ID, -sort_HT_0_50_CM), percentTot)) +
  geom_col(aes(fill = HTclass2)) +
  facet_wrap(~timeClass, ncol = 1) +
  scale_fill_manual(values = colfunc2(5)) +
  # scale_fill_viridis(discrete=TRUE) +
  theme_minimal() +
  labs(y = "", x = "", fill = "Height class", title = "", subtitle = "Unfenced plots") +
  # labs(y = "% of total stems", x = "", fill = "Height class", title = "Proportion of Live Aspen Stems by Height Class", subtitle = "Unfenced plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  theme(legend.position = "bottom") +
  scale_y_continuous(labels=scales::percent)

# library(patchwork)
plot.ac.fence2panel <- plot.percTot.AC.F + plot.percTot.AC.UF +
  plot_layout(widths = c(1, 2))

ggsave("./output/figures_202107/AspPercTotXhtclass_ac_FxUf.png", width = 11, height = 5, dpi=300)
# ggsave("./output/figures_202107/AsppercTotXhtclass_ac_FxUf.pdf", width = 11, height = 5)

## ANC
plot.percTot.ANC <- full_join(ht.perc01,sort.ht2join) %>% 
  filter(SITE_TYPE == "ANC") %>% 
  ggplot(aes(reorder(SITE_ID, -sort_HT_0_50_CM), percentTot)) +
  geom_col(aes(fill = HTclass2)) +
  facet_wrap(~timeClass, ncol = 1) +
  scale_fill_manual(values = colfunc2(5)) + 
  # scale_fill_viridis(discrete=TRUE) +
  theme_minimal() +
  labs(y = "% of total stems", x = "", fill = "Height class", title = "Noncore Range") +
  # labs(y = "% of total stems", x = "", fill = "Height class", title = "Proportion of Live Aspen Stems by Height Class", subtitle = "Unfenced plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  theme(legend.position = "bottom") +
  scale_y_continuous(labels=scales::percent)

plot.percTot.ANC

ggsave("./output/figures_202107/AspPercTotXhtclass_anc_FxUf.png", width = 7, height = 5, dpi=300)
# ggsave("./output/figures_202107/AspPercTotXhtclass_anc_FxUf.pdf", width = 7, height = 5)


## AK
plot.percTot.AK <- full_join(ht.perc01,sort.ht2join) %>% 
  filter(SITE_TYPE == "AK") %>% 
  ggplot(aes(reorder(SITE_ID, -sort_HT_0_50_CM), percentTot)) +
  geom_col(aes(fill = HTclass2)) +
  facet_wrap(~timeClass, ncol = 1) +
  scale_fill_manual(values = colfunc2(5)) +
  # scale_fill_viridis(discrete=TRUE) +
  theme_minimal() +
  labs(y = "% of total stems", x = "", fill = "Height class", title = "Kawuneeche Valley") +
  # labs(y = "% of total stems", x = "", fill = "Height class", title = "Proportion of Live Aspen Stems by Height Class", subtitle = "Unfenced plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  theme(legend.position = "bottom") +
  scale_y_continuous(labels=scales::percent)

plot.percTot.AK

ggsave("./output/figures_202107/AspPercTotXhtclass_ak.png", width = 5, height = 5, dpi=300)
# ggsave("./output/figures_202107/AspPercTotXhtclass_ak.pdf", width = 5, height = 5)

```

```{r}
# panel plot
(plot.ac.fence2panel + theme(legend.position = "none")) + (plot.percTot.ANC + theme(legend.position = "none")) + plot.percTot.AK

# alt
plot.percTot.AC.F + plot.percTot.AC.UF + plot.percTot.ANC + plot.percTot.AK

ggsave("./output/figures_202107/AspPercTotXhtclass_panel.png", width = 8, height = 8, dpi=300)
```


### Aspen management goals

*Targets from Ziegenfuss and Johnson 2015:*

1.Progressive increase in aspen regeneration above the baseline level of
13 percent to at least 45 percent of winter range stands (presence of
stems less than 2 cm dbh reaching 1.5--2.5 m tall).

```{r}

# ht.perc01 %>%
#   group_by(RANGE_TYPE, FENCED, pType) %>% 
#   summarise(mean.stemDen.ac = mean(stemDen.ac),n = n())
  
asp.tally.dbh.tidy %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(LIVE_DEAD == "LIVE") %>%
  # filter(FENCED == "Fenced") %>%
  # filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) %>% 
  group_by(timeClass, BURNED, FENCED) %>% 
  descr(stemDen.ac) %>% 
  tb() %>% 
  gt() %>% 
  tab_header(title = "Combined Winter Range Live Tree Density: tcxburnedxfenced")

```

```{r}
## short samplings
asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(shortTall == "short") %>% 
# filter(is.na(REMOVED)) %>% 
  # filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  filter(FENCED == "Fenced") %>%
  # filter(SITE_TYPE == "AC") %>%
  # filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) %>% 
  group_by(timeClass, BURNED, FENCED) %>% 
  descr(stemDen.ac) %>% 
  tb() %>% 
  gt() %>% 
  tab_header(title = "AC live density, short saplings (<1.5m): tcxburnedxfenced")
```

```{r}
asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(shortTall == "tall") %>% 
# filter(is.na(REMOVED)) %>% 
  # filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  filter(FENCED == "Fenced") %>%
  # filter(SITE_TYPE == "AC") %>%
  # filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) %>% 
  group_by(timeClass, BURNED, FENCED) %>% 
  descr(stemDen.ac) %>% 
  tb() %>% 
  gt() %>% 
  tab_header(title = "AC live density, tall saplings (1.5-2.5m): tcxburnedxfenced")
```


```{r}
###### WRITE to disk for statistical analysis

asp.tally.dbh.tidy %>%
  write_csv("./output/exported_data/asp_dbh_perc1_20210601.csv")

asp.tally.ht.tidy %>%
  write_csv("./output/exported_data/asp_ht_perc1_20200309.csv")
  
```

\*Increase in aspen regeneration above the baseline level of 13 percent
to at least 45 percent of winter range stands (presence of stems less
than 2 cm dbh reaching 1.5--2.5 m tall).

\*Progressive shift in the distribution of stem sizes toward the desired
future condition of 75 percent small-diameter stems, 20 percent
medium-diameter stems, and 5 percent large-diameter stems.

```{r}

## identify the "in desired future condition" plots
ht.perc01 <- ht.perc01 %>%
  mutate(inDesFC = case_when(
    stemDen.ha >= 400 & HTclass2 == "151-200cm" ~ "in_dfc",
    stemDen.ha >= 400 & HTclass2 == "201-250cm" ~ "in_dfc",
    TRUE ~ "out_dfc"))

# ht.perc01 %>% 
#   View()

ht.perc01 %>%  distinct(RANGE_TYPE)

## in DFC summary
asp_inDFC_summary <- ht.perc01 %>% 
  group_by(RANGE_TYPE, FENCED, timeClass, inDesFC) %>%
  summarise(n_dfc = n()) %>% 
  ungroup() %>% 
  group_by(RANGE_TYPE, FENCED, timeClass) %>%
  mutate(n_tot = sum(n_dfc)) %>%
  ungroup() %>% 
  mutate(perc_inDFC = n_dfc/n_tot * 100) %>% 
  mutate(perc_inDFC = round(perc_inDFC, 1))

asp_inDFC_summary %>%
  filter(inDesFC == "in_dfc") %>% 
  gt() %>% 
  tab_header(title = "percent plots in DFC")

```

```{r}
asp_inDFC_summary %>%
  filter(inDesFC == "in_dfc") %>% 
  gt() %>% 
  tab_header(title = "percent plots in DFC")
```

```{r}
## in DFC summary
asp_inDFC_summary2 <- ht.perc01 %>% 
  filter(SITE_TYPE == "AC" | SITE_TYPE == "ANC") %>% 
  group_by(FENCED, timeClass, inDesFC) %>%
  summarise(n_dfc = n()) %>% 
  ungroup() %>% 
  group_by(FENCED, timeClass) %>%
  mutate(n_tot = sum(n_dfc)) %>%
  ungroup() %>% 
  mutate(perc_inDFC = n_dfc/n_tot * 100) %>% 
  mutate(perc_inDFC = round(perc_inDFC, 1))

asp_inDFC_summary2 %>%
  filter(inDesFC == "in_dfc") %>% 
  gt() %>% 
  tab_header(title = "percent plots in DFC")
```

```{r}
# asp1 <- read_excel("data/EVMP_data/TenYearReview/Aspen_Data_Baseline_through_2018.xlsx")
# View(Aspen_Data_Baseline_through_2018)

```

```{r, echo = FALSE}
# Percent of aspen monitoring sites on elk winter range and Kawuneeche Valley of Rocky Mountain National Park, Colorado, that had a recruiting sapling cohort (at least 400 stems per hectare of height between 1.5 and 2.5 meters) at baseline sampling and in 2013. Entire winter range numbers are weighted by the percent area in each location.
# 
# Tally of Live Aspen Stems per Plot >2.5 m in Height (DBH=diameter at breast height [1.4 m])		
# 
# Tally of Live Aspen Stems per Plot <2.5 m in Height				
# 
# Tally of Dead Aspen Stems per Plot >2.5 m in Height (DBH=diameter at breast height [1.4 m])
# 

```

```{r, echo=FALSE}

# Rewrite the SAS program used to create figs. 3,4,5, and 7 of Zeigenfuss and Johnson (2015)--Distribution of aspen tree (height greater than 2.5 meters) stem diameters in monitoring sites. 
# 
# **Steps:** 
# 1. Read in data from a file with tallies of live aspen stems by dbh size class  
# 2. Read in a file with information for each aspen monitoring site  
# 3. Merge these two files, remove saplings 
# 4. Reclass trees into groups of small (2-10 cm dbh), medium (10-20 cm dbh) and large (20+ dbh) trees.
# 
# 
# **See: **  
# 
# >aspen sapling table 4.sas  
# >aspen sapling table 5.sas 
```

```{r, echo=FALSE, eval=FALSE}
#
# in/out DFC 

```

### Range-wide weighted summaries

```{r, echo=FALSE, eval=FALSE}

# calculating the weighting factors

```

### Animal signs
```{r}
## distinct animal species codes
asp.siteinfo2018 %>% 
  filter(!is.na(ANIMAL_SIGN_TYPE)) %>%
  clean_names("screaming_snake") %>% 
  distinct(ANIMAL_SIGN_SPECIES) %>% 
  mutate(deer = str_detect(string = ANIMAL_SIGN_SPECIES,pattern = "D")) %>%
  mutate(elk = str_detect(string = ANIMAL_SIGN_SPECIES,pattern = "E")) %>%
  mutate(moose = str_detect(string = ANIMAL_SIGN_SPECIES,pattern = "M")) %>% 
  mutate(elk = case_when(ANIMAL_SIGN_SPECIES == "NONE" ~ FALSE,
                         TRUE ~ elk))

asp.siteinfo2018 <- asp.siteinfo2018 %>% 
  mutate(SITE_TYPE = as_factor(SITE_TYPE)) %>% 
  mutate(SITE_TYPE = fct_relevel(SITE_TYPE, "AK", after = Inf)) %>% 
  mutate(BURNED = case_when(BURNED == "Y" ~ "Burned",
                            BURNED == "N" ~ "Unburned"))

## attribute the animal type
asp.animal.sign <- asp.siteinfo2018 %>% 
  filter(!is.na(ANIMAL_SIGN_TYPE)) %>%
  clean_names("screaming_snake") %>% 
  select(c(SITE_TYPE,SITE_ID, BURNED, STAND_TYPE, BARK_SCARRING_CLASS, DATE, contains("ANIM"))) %>% 
  mutate(DATE = date(DATE)) %>% 
  mutate(yr = as.integer(year(DATE))) %>% 
  mutate(deer = str_detect(string = ANIMAL_SIGN_SPECIES,pattern = "D")) %>%
  mutate(elk = str_detect(string = ANIMAL_SIGN_SPECIES,pattern = "E")) %>%
  mutate(moose = str_detect(string = ANIMAL_SIGN_SPECIES,pattern = "M")) %>% 
  mutate(elk = case_when(ANIMAL_SIGN_SPECIES == "NONE" ~ FALSE,
                         TRUE ~ elk))

## tally and calculate the proportion of plots with sign
asp.sign.summary <- asp.animal.sign %>%
  pivot_longer(cols = c(deer, elk, moose),
               names_to = "animal",
               values_to = "present") %>% 
  group_by(yr, SITE_TYPE, animal, present) %>%
  tally() %>% 
  ungroup() %>% 
  group_by(yr, SITE_TYPE, animal) %>% 
  mutate(tot_pa = sum(n)) %>%
  ungroup() %>% 
  mutate(perc_plots = round(n/tot_pa,2)) %>% 
  mutate(present = case_when(present == TRUE ~ "present",
                             present == FALSE ~ "absent"))

```

```{r}

asp.sign.summary %>%
  # filter(SITE_TYPE== "AK") %>% 
  ggplot(aes(animal, perc_plots)) +
  geom_col(aes(fill=present)) +
  theme_minimal() +
  facet_wrap(~SITE_TYPE) +
  scale_y_continuous(labels=scales::percent) +
  # scale_fill_manual(values = c("grey20", "grey70")) +
  scale_fill_manual(values = colfunc3(2)) +
  labs(x="", y = "Percent of plots", fill = "") 
ggsave("./output/figures_202107/asp_animal_presence_2018.png", width=6, height = 5, dpi=300)

## plot - animal presence by species and site type
pl.animal.ak <- asp.sign.summary %>%
  filter(SITE_TYPE== "AK") %>% 
  ggplot(aes(animal, perc_plots)) +
  geom_col(aes(fill=present), color="grey80") +
  theme_minimal() +
  # facet_wrap(~SITE_TYPE) +
  scale_y_continuous(labels=scales::percent) +
  # scale_fill_manual(values = c("grey20", "grey70")) +
  scale_fill_manual(values = colfunc3(2)) +
  theme(legend.position = "none") +
  labs(title= "Kawuneeche Valley", x="", y = "Percent of plots", fill = "") 
# pl.animal.ak


## incorporating burned 2012
asp.sign.summary.b <- asp.animal.sign %>%
  pivot_longer(cols = c(deer, elk, moose),
               names_to = "animal",
               values_to = "present") %>% 
  group_by(yr, SITE_TYPE, BURNED, animal, present) %>%
  tally() %>% 
  ungroup() %>% 
  group_by(yr, SITE_TYPE, BURNED, animal) %>% 
  mutate(tot_pa = sum(n)) %>%
  ungroup() %>% 
  mutate(perc_plots = round(n/tot_pa,2)) %>% 
  mutate(present = case_when(present == TRUE ~ "present",
                             present == FALSE ~ "absent"))

## plot - animal presence by species and site type
pl.animal.acanc.burn <- asp.sign.summary.b %>% 
  filter(SITE_TYPE != "AK") %>% 
  ggplot(aes(animal, perc_plots)) +
  geom_col(aes(fill=present), color="grey80") +
  # geom_text(aes(label = n, group = present),
                  # position = position_stack(vjust = .5), color = "grey80") +
  theme_minimal() +
  facet_grid(BURNED~SITE_TYPE) +
  scale_y_continuous(labels=scales::percent) +
  # scale_fill_manual(values = c()) +
  scale_fill_manual(values = colfunc3(2)) +
  theme(legend.position = "bottom") +
  labs(x="", y = "Percent of plots", fill = "", title="Winter Range") 

# pl.animal.acanc.burn
# ggsave("./output/figures_202107/asp_animal_presence_2018_burned.png", width=6.5, height = 5, dpi=300)
# ggsave("./output/figures_202107/asp_animal_presence_2018_burned.pdf", width=6.5, height = 5)


pl.animal.acanc.burn + pl.animal.ak + plot_layout(widths = c(2,1))
ggsave("./output/figures_202107/asp_animal_presence_2018_3_panel_burned.png", width=6.5, height = 3.75, dpi=300)
```

```{r}
asp.sign.summary.b %>%
  select(-yr) %>% 
  arrange(SITE_TYPE, animal, present) %>% 
  filter(SITE_TYPE != "AK") %>%
  gt() %>% 
  tab_header(title = "Summary animal observations in aspen plots", subtitle = "2018 data, 2012 burned status")
```

## Upland line intercept

```{r, eval=TRUE}
## Data munging
# Data import
## all sheets
uli <- readxl::excel_sheets("data/EVMP_data/TenYearReview/Upland_Line_Intercept_2007_2013_2018.xlsx")

## 2007
b2007 <- readxl::read_excel("data/EVMP_data/TenYearReview/Upland_Line_Intercept_2007_2013_2018.xlsx",sheet = 2) %>% 
  mutate(yr = 2007)

b2013 <- readxl::read_excel("data/EVMP_data/TenYearReview/Upland_Line_Intercept_2007_2013_2018.xlsx",sheet = 3) %>% 
  mutate(yr = 2013)


b2018 <- readxl::read_excel("data/EVMP_data/TenYearReview/Upland_Line_Intercept_2007_2013_2018.xlsx",sheet = 4) %>% 
  mutate(yr = 2018) %>% 
  mutate(SHRUB_HEIGHT_CM = as.character(SHRUB_HEIGHT_CM))

# combine 07 and 13
upl.li <- bind_rows(b2007,b2013) 

## bring in the 2018
upl.li <- upl.li %>% 
  bind_rows(., b2018)

# janitor::excel_numeric_to_date()

######### DEAL WITH NA #############
na_strings <- c("NA", "N A", "N / A", "N/A", "N/ A", "Not Available", "NOt available")

upl.li <- upl.li %>%
  naniar::replace_with_na_all(condition = ~.x %in% na_strings) %>%
  mutate(DATE = as.numeric(DATE)) 

upl.li <- upl.li %>% 
  clean_names()

```

```{r}
## expand site type
upl.li <- upl.li %>% 
  mutate(site_type = case_when(site_type == "UC" ~ "core range",
                               site_type == "UNC" ~ "non-core range",
                               TRUE ~ site_type)) 


### clean
upl.li <- upl.li %>%
  mutate(site_id = case_when(site_id == "UC1" ~ "UC01",
                             site_id == "UC2" ~ "UC02",
                             site_id == "UC3" ~ "UC03",
                             site_id == "UC5" ~ "UC05",
                             site_id == "UC8" ~ "UC08",
                             site_id == "UC9" ~ "UC09",
                             site_id == "UNC2" ~ "UNC02",
                             site_id == "UNC4" ~ "UNC04",
                             site_id == "UNC5" ~ "UNC05",
                             site_id == "UNC6" ~ "UNC06",
                             site_id == "UNC8" ~ "UNC08",
                             site_id == "UNC9" ~ "UNC09",
                             TRUE ~ site_id))

upl.li %>%
  filter(str_detect(string = site_id,pattern = "UNC")) %>% 
  tabyl(site_id) 

upl.li %>%
  distinct(yr, site_id, site_type) %>% 
  tabyl(yr, site_type)

upl.li %>%
  distinct(yr, site_type, shrub_species) %>% 
  tabyl(yr, site_type, shrub_species)

upl.li <- upl.li %>% 
  mutate(shrub_height_cm = as.numeric(shrub_height_cm)) %>%
  mutate(yr = as_factor(yr)) %>% 
  mutate(shrub_species = toupper(shrub_species))

upl.li <- upl.li %>% 
  mutate(shrub_species = case_when(shrub_species == "ROSA" ~ "ROWO",
                                   TRUE ~ shrub_species))

upl.li <- upl.li %>% 
  group_by(yr, shrub_species) %>% 
  mutate(n_spp = n()) %>% 
  ungroup

```

```{r, eval=TRUE}
### Shrub cover
upl.ht.sel <- upl.li %>%
  select(
  date,
  site_id,
  site_number,
  site_type,
  shrub_species,
  shrub_height_cm,
  line_intercept_length_m,
  yr
  ) %>%
  distinct()

## calculate the cover for all shrub species pooled together

upl.allspp.cover <- upl.ht.sel %>% 
  group_by(site_id, yr, site_type) %>%
  summarise(tot_intercept_m = sum(line_intercept_length_m)) %>% 
  ungroup() %>% 
  mutate(perc_cover = tot_intercept_m/30*100) %>% 
  filter(!is.na(perc_cover)) %>% 
  filter(perc_cover > 0)

## calculate the cover for shrubd BY species
upl.spp.cover <- upl.ht.sel %>% 
  group_by(site_id, yr, site_type, shrub_species) %>%
  summarise(tot_intercept_m = sum(line_intercept_length_m)) %>% 
  ungroup() %>% 
  mutate(perc_cover = tot_intercept_m/30*100) %>% 
  filter(!is.na(perc_cover)) %>% 
  filter(perc_cover > 0)

### write to disk
# write_csv(upl.allspp.cover, path = "./output/exported_data/upland_LI_allShrubsPooled_20200814.csv")
# write_csv(upl.spp.cover, path = "./output/exported_data/upland_LI_byShrubSpp_20200814.csv")


```

```{r}
### All shrub species: site type
## boxplot
upl.cova <- upl.allspp.cover %>% 
  ggplot(aes(yr, perc_cover)) +
  geom_boxplot(fill="grey50") +
  # scale_fill_manual(values = c("ivory", "ivory4")) +
  # scale_fill_manual(values = c("grey90")) +
  theme_minimal() +
  labs(x = "", y = "% cover", fill = "", caption = "Upland cover, all shrubs spp and UC UNC sites combined")


# ggsave("./output/figures_202107/upland_species_cover_allspp_sites_combined.png", width = 4.5, height = 3.75, dpi = 300)

```

```{r}
### All shrub species: by site type
## boxplot
upl.covb <- upl.allspp.cover %>% 
  ggplot(aes(yr, perc_cover)) +
  geom_boxplot(aes(fill = site_type), position = "dodge") +
  # scale_fill_manual(values = c("ivory", "ivory4")) +
  scale_fill_manual(values = c("grey90","grey50")) +
  theme_minimal() +
  labs(x = "", y = "% cover", fill = "", caption = "Upland cover, all shrubs combined between sites")

# ggsave("./output/figures_202107/upland_species_cover_allspp.png", width = 4.5, height = 3.75, dpi = 300)

## combine plots
cowplot::plot_grid(upl.cova, upl.covb, labels = "AUTO",rel_widths = c(1, 2))

# ggsave("./output/figures_202107/upland_species_cover_allspp_2panel.png", width = 5.75, height = 3.75, dpi = 300)
```

```{r}
## summary table
upl.allspp.cover %>% 
  group_by(yr, site_type) %>%
  # filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  descr(perc_cover, stats = "common") %>% 
  summarytools::tb() %>% 
  mutate(across(c('mean','sd','min','med','max','pct.valid'), ~round(.,digits = 1))) %>% 
  gt() %>% 
  tab_header(title = "Upland LI, Cover", subtitle = "All shrub species, all site types")

upl.allspp.cover %>% 
  group_by(yr, site_type) %>%
  summarytools::descr() %>% 
  summarytools::tb() %>% 
  filter(variable == "perc_cover") %>% 
  select(yr,
         contains("me"), 
         contains("site"),
         contains("sd"),
         contains("q"))  

# upl.allspp.cover.summary %>%
#   gt()

```

```{r}

upl.spp.cover %>% 
  group_by(yr, site_type, shrub_species) %>%
  summarytools::descr() %>% 
  summarytools::tb() %>% 
  filter(variable == "perc_cover") %>% 
  datatable(filter = "top")

```

```{r}
## Height
### select upland species
upl.li %>% 
  # baseline %>%
  filter(n_spp >30) %>% 
  ggplot(aes(yr, shrub_height_cm)) +
  geom_boxplot(aes(fill = site_type)) +
  theme_minimal() +
  # scale_fill_manual(values = c("ivory1","ivory4")) +
  scale_fill_manual(values = c("grey90","grey40")) +
  facet_wrap(~shrub_species, scale = 'free_y') +
  labs(x = "", y = "Max shrub height (cm)", fill = "", caption = "Upland plots, n >30")

# ggsave("./output/figures_202107/upland_species_max_ht.png", width = 6.5, height = 4, dpi = 300)

###
# upl.li %>%
#   filter(shrub_species != "NONE" & shrub_species != "PSME" & shrub_species != "UNKN" & shrub_species != "XXXX" & shrub_species != "CEXX" & shrub_species != "JAAM" & shrub_species != "RIXX" & shrub_species != "SYOR" & shrub_species != "SHCA" & shrub_species != "PRXX" & shrub_species != "SYRO" & shrub_species != "ROSA") %>% 
#   # group_by(yr, shrub_species) %>% 
#   ggplot(aes(yr, shrub_height_cm)) +
#   geom_boxplot(aes(fill = site_type)) +
#   facet_wrap(~shrub_species, scale = "free_y")

```

## Wild Basin Comparisons


```{r}
wbasin <- read_csv("./data/wild_basin/Wild Basin willow data survey 2018.csv")

wbasin <- wbasin %>%
  janitor::clean_names()
  
wbasin.sel <- wbasin %>% 
  rename(plant_ht_cm = max_ht_cm) %>% 
  mutate(yr = 2018) %>% 
  mutate(fenced = "N") %>% 
  mutate(site_type = "WB") %>% 
  mutate(site_id = paste0("WB",point)) %>% 
  dplyr::select(c(yr, site_type, site_id, plant_ht_cm, species, fenced, location)) %>% 
  distinct()
  

```

```{r}
# exp lu
csv.all.lc.mcro.df.cln <- csv.all.lc.mcro.df %>% 
  clean_names()

willow.mcro.evmp <- csv.all.lc.mcro.df.cln %>%
  rename(species = species_code) %>% 
  dplyr::select(yr, site_type, species, site_id, plant_ht_cm, fenced, location) %>% 
  distinct()

willow.mcro.evmp18 <- willow.mcro.evmp %>% 
  filter(yr == 2018)

#### bind wb with 2018 evmp
wb.evmp18 <- bind_rows(wbasin.sel, willow.mcro.evmp18) %>% 
  distinct()

```

```{r}
### Willow height comparison among Wild Basin and EVMP plots
## compare WILLOW height

wb.evmp18 %>%
  filter(str_detect(species, "^S")) %>% 
  ggplot() +
  geom_density(aes(fill = site_type, color = site_type, lty = site_type, x = plant_ht_cm), size=1, alpha = .2) +
  theme_minimal() +
  scale_fill_manual(values = colfunc3_RdBu(4)) +
  scale_color_manual(values = colfunc3_RdBu(4)) +
  labs(x = "Willow height (cm)", y  = "Density", lty= "Site type", color = "Site type", fill = "Site type", caption = "willow height, WB + EVMP, Salix only")

ggsave("./output/figures_202107/WB_EVMP_willow_height.png", dpi = 300, width = 4.75, height = 3.75)
```

```{r}
wb.evmp18 <- wb.evmp18 %>%
  mutate(site_type.lbl = case_when(site_type == "WB" ~ "Wild Basin",
                               site_type == "WC" ~ "Core winter range",
                               site_type == "WNC" ~ "Noncore winter range",
                               site_type == "WK" ~ "Kawuneeche Valley",
                               TRUE ~ "other")) %>% 
  mutate(fenced = case_when(fenced == "N" ~ "Unfenced",
                            fenced == "Y" ~ "Fenced",
                            TRUE ~ fenced)) %>% 
  mutate(site.type.fenced = paste0(site_type.lbl,":",fenced))

# wb.evmp18 %>% distinct(site.type.fenced)
wb.evmp18.willows <- wb.evmp18 %>% 
  filter(str_detect(species, "^S"))

```

```{r}
wb.evmp18 %>%
  filter(str_detect(species, "^S")) %>% 
  ggplot(aes(x=reorder(site.type.fenced, plant_ht_cm), plant_ht_cm)) +
  geom_boxplot(aes(fill=site_type)) +
  # geom_density(aes(fill = site_type, color = site_type, lty = site_type, x = plant_ht_cm), alpha = 0.05) +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(4)) +
  scale_color_manual(values = colfunc2(4)) +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y  = "Height (cm)", lty= "Site type", color = "Site type", fill = "Site type", caption = "willow height, WB + EVMP, Salix only")

ggsave("./output/figures_202107/WB_EVMP_willow_height_boxplot.png", dpi = 300, width = 5.75, height = 4.75)

wb.evmp18 %>%
  filter(str_detect(species, "^S")) %>% 
  ggplot(aes(x=reorder(site.type.fenced, plant_ht_cm), plant_ht_cm)) +
  geom_boxplot(aes(fill=site_type)) +
  # geom_density(aes(fill = site_type, color = site_type, lty = site_type, x = plant_ht_cm), alpha = 0.05) +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(4)) +
  scale_color_manual(values = colfunc2(4)) +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y  = "Height (cm)", lty= "Site type", color = "Site type", fill = "Site type", caption = "willow height, WB + EVMP, Salix only") +
  facet_wrap(~fenced, scales = "free_x")
```

```{r}
wb.evmp18 %>%
  group_by(location.fenced, fenced) %>%
  descr(plant_ht_cm) %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  arrange(-mean) %>%
  datatable() %>%
  datatable(caption = "All willow species combined")
  
```


```{r}
wb.evmp18 %>%
  group_by(location.fenced, fenced) %>%
  descr(plant_ht_cm, species) %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  arrange(-mean) %>%
  datatable(caption = "By willow species")
```


```{r}
wb.evmp18.willows.loc <- wb.evmp18.willows %>% 
  select(-yr) %>% 
  group_by(site_id,location) %>% 
  summarytools::descr(stats = "common") %>% 
  tb() %>%
  select(c(location,mean)) %>% 
  group_by(location) %>% 
  descr(mean,stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  select(-pct.valid)

# wb.evmp18.willows.loc %>% 
#   gt() %>% 
#   gt::gtsave(filename = "./output/tables/WB_vs_EVMP_willowHt_loc.rtf")

#### range type
wb.evmp18.willows.rt <- wb.evmp18.willows %>% 
  select(-yr) %>% 
  group_by(site_id,site_type) %>% 
  summarytools::descr(stats = "common") %>% 
  tb() %>%
  select(c(site_type,mean)) %>% 
  group_by(site_type) %>% 
  descr(mean,stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  select(-pct.valid)

# wb.evmp18.willows.rt %>%
#   arrange(-mean) %>%
#   select(-variable) %>% 
#   gt() %>% 
#   gt::gtsave(filename = "./output/tables/WB_vs_EVMP_willowHt_site_type.rtf")

```


```{r}
## write the combined WB18 and winter range/KV plots
wb.evmp18.willows %>% 
  write_csv("./data/EVMP_derived/wildbasin_evmp2018.csv")

```


# Session info

R version 4.0.3 (2020-10-10)\
Platform: x86_64-w64-mingw32/x64 (64-bit)\
Running under: Windows 10 x64 (build 19041) **Updated:**
`r format(Sys.time(), '%Y %B %d')`

```{r, echo=FALSE}
# subset(data.frame(sessioninfo::package_info()), attached==TRUE, c(package, loadedversion)) %>% 
#   gt() %>% 
#   tab_header(title = "Attached packages and versions")

report::report_table(sessionInfo()) %>% 
  as_tibble() %>% 
  gt() %>% 
  tab_header(title="Package Information")

```

# Notes on raw data from E. Ertl

The following are notes from E. Ertl recorded in an describing EVMP
vegetation data collection, as recorded in 2018.

**Aspen**

-   Plots lost: AC41 (plot was washed away in the 2013 flood)

-   Plots added: AC68 to replace AC41

-   Plots that had been treated with fuels management work that has not
    been noted before: ANC5, ANC7, ANC8, ANC19 (I think?) these areas
    were thinned of most large trees opening up the canopy substantially
    and the area was also pile burned; none of the plots appeared to be
    directly in the pile burn scars but a few came very close; these
    treatments could alter data in the future (working on getting a GIS
    layer for this)

-   Formatted 2015 -- 2018 data. 2015-2017 data only consisted of burn
    plot sampling; no burn plot data collected in 2014

**Upland**

-   Plots lost: UC09 (this plot was most likely lost in the 2013 flood),
    UC14 & UC24 (plots were lost to waterline construction that occurred
    from 2015-2018)

-   Plots added: UC37, UC38, UC39 to replace the three plots that were
    lost

-   Plots have been treated by prescribed fire in the past; Prescribed
    fire occurred from 9/17 -- 10/2 of 2008; First round of data
    collected for upland sites occurred in 2007 (working on getting
    recent GIS layers to account for any other treatments)

-   Prescribed burning is planned for this coming October 2018 as well,
    which will potentially burn several upland plots in the Beaver
    Meadows area

-   Formatted 2018 shrub data

**Willow**

-   Plots lost: WK03; this plot hasn't been found since 2012 and we
    looked several times in 2018

-   Plots added: WK09 to replace WK03 (updated measurement schedule in
    the protocol), WK10 added late season after talking with Linda Z. --
    she suggested there be 4 fenced plots in the KV to make the data
    collected from this area more robust. We weren't aware of this when
    we installed WK09, so there will be nine total west side plots (4
    fenced and 5 unfenced).

-   Removed the microplot stem counts from the macroplot sampling in the
    protocol per Linda Z. early summer

-   Formatted 2015 -- 2018 cumulative willow data  2015-2017 data only
    consisted of burn plot sampling; there is no burn data for 2014  In
    2015 it appears they were only measuring willow in the macroplots,
    not all shrubs like they should have been.

-   Fixed unit and rounding issues in data. In 2016 the crew measured
    additional burned sites that are not on the burn survey list (WC32,
    WC34, WC78, WC84, and WC85). For some plots they only measured
    willow instead of measuring all shrubs. Fixed unit and rounding
    issues in data.

-   There is only west side data for 2016 and 2017; Nick B. said they
    weren't aware that west side plots were supposed to be measured
    every year back in 2014/2015. Burn survey and west side data are
    currently combined by year measured

-   Formatted 2015 -- 2018 offtake data (2014 was already added and
    analyzed in the 2013 review)  2015 offtake notes: Crew didn't
    sample WC9, WC78, WC79 (plots are in fences) and sampled extra plots
    that are not on the protocol list for offtake including WC34, WC35,
    WC52, WC54, WC56, WK6, WK7, and WK8 (none of these are in fences) 

-   2016 offtake notes: Crew didn't sample WC79 (fenced), WC85 (fenced),
    WK3 (lost), WNC30 (couldn't find plot) and sampled extra plots that
    are not on the protocol list for offtake including WC34, WC35, WC37
    (fenced), WC50 (fenced), WC57, WC69, WC70, WC71, WC76 (fenced),
    WC81, WC82, WC83, WC86 (fenced)

-   2017 offtake notes: Crew didn't sample WC76 (fenced), WC85 (fenced),
    WNC30 (couldn't find plot), WK3 (lost), WK6 (river probably too high
    to access) and no extra plots were sampled

-   2018 offtake notes: Crew didn't sample WC33 (removed 2014), WC76
    (fenced), WC77 (fenced), WK3 (lost and removed from list in 2018,
    replaced with WK9 at end of season), WK6 (river too high to access
    plot)\

-   There were discrepancies between the protocol and the willow master
    database on what sites to sample for offtake (added by C. Piper).
    Linda and I updated this schedule in the protocol for future years
    because the old schedule included plots that were no longer there
    and plots that have since been fenced.

-   Burn Surveys 2015-2019 -- spoke with Linda Z. and she doesn't think
    these need to be measured again in 2019 unless the data is showing
    something interesting.

-   Willow stake restoration sites -- have these been cross referenced
    with willow monitoring sites? Were willow stakes planted in some
    plots? I did find notes that there were willow stakes being measured
    in WC76 over the years, which would need to be analyzed separately
    I'm assuming.

**Other notes**

-   Kept all of Linda's original data for the last 5-year review under
    EVMP's "analysis" folder

-   Created new (2018) versions of data for 10-year review analysis but
    did not delete out any data from previous years where plots were
    lost this year; also kept old components in the data (i.e. willow
    shoot measurements, microplot stem counts)

-   All formatted data for 2018 can be found under
    EVMPVegetationAnalysis10 Year Review

-   Blank datasheets have been updated for 2018

-   Protocols are currently being updated for 2018 and master databases
    have been updated for 2018.

-   Added a "Fuels Treatment Post Establishment" and "Treatment Year"
    column that could be queried by type (i.e. prescribed fire,
    mechanical treatments, etc.) 

-   Created new shapefiles for all veg plots; trying to find shapefiles
    for treatment areas in the park and will put them in the
    EVMP_Veg_Data_2018 geodatabase  Located under
    EVMPVegetationGISEVMP_Veg_Data_2018.gdb OR
    ShapefilesMaster_Veg_Sites_Shp2018

-   Created new veg maps. Located under
    EVMPVegetationLogisticsMapsEVMP vegetation plot maps2018 Veg
    Site MapsPlot Maps

-   Wild Basin Willow Data -- I created a folder with all of the data
    collected at Wild Basin this fall. It is located under
    EVMPVegetationAnnual RecordsFY18Wild Basin -- Willow Data

-   Uploaded all 4 iPads with new electronic datasheets for willow and
    upland, photo points and plot diagrams from 2018, willow ID keys,
    updated protocol from 2018, and new vegetation site maps.

```{r, echo=FALSE, eval=FALSE}
# Species lists
spp.mcro <- csv.all.lc.mcro.df %>%
  distinct(SPECIES_CODE) %>% 
  rename(sppcode = SPECIES_CODE) %>% 
  mutate(spp_source = "Macroplot")

spp.upl <- upl.spp.cover %>%
  distinct(shrub_species) %>% 
  rename(sppcode = shrub_species) %>% 
  mutate(spp_source = "Upland LI")

spp.li <- csv.all.lc.li.df %>%
  distinct(SPECIES_CODE) %>% 
  rename(sppcode = SPECIES_CODE) %>% 
  mutate(spp_source = "Riparian LI")

spp.all <- bind_rows(spp.li,spp.mcro,spp.upl) %>% 
  arrange(spp_source,sppcode)
  

## from the report
spp.list1 <- read_excel(path = "./data/EVMP_derived/species_list/species_list.xlsx")

spp.list1 <- spp.list1 %>%
  mutate(Scientific = str_trim(Scientific, side = "both")) %>% 
  mutate(Common = str_trim(Common, side = "both")) %>% 
  rename(sppcode = Code)

spp.list1 %>%
  filter(!is.na(Common)) %>%
  arrange(Scientific) %>% 
  gt()
  

spp.all <- left_join(spp.all, spp.list1)

## Write
# spp.all %>% 
#   write_csv("./data/EVMP_derived/species_list/species_list_to_edit.csv")


## USDA CO list
stateDownload <- read_csv("data/EVMP_derived/species_list/stateDownload.csv") %>% 
  clean_names() %>% 
  rename(sppcode = symbol)

spp.all <- spp.all %>% 
  left_join(.,stateDownload, by = "sppcode")

```

```{r, eval=FALSE}
# Data collection and management
# Streamlining data collection and data management can facilitate easier updates to the EVMP. Strategies such as the use of tablet-based field data collection apps that incorporate data integrity checks can reduce or eliminate errors that must be corrected when compiling data. Creation and maintenance of machine-readable, non-binary files (e.g., comma-separated value) as opposed to complicated spreadsheets can aid import and analysis and is often a requirement for online data depositories. One common mistake when entering data is to rely on context such as spatial layout or color to encode information. Such information can be easily lost when reading in data into other programs for analysis. Other principles can minimize friction in analysis. For example, it is generally best to put all variables in columns and put each observation or measurement into its row. Merging cells can cause problems down the road and should be avoided. Whatever approach is used for entering data, expect some degree of data wrangling and quality assurance. 

```


# References
