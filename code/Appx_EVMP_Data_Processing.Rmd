---
title: "Appendix B. EVMP Data Processing"
author: ""
date: ""
output: 
  html_document: 
    theme: paper
    toc: yes
    toc_float: true
    toc_depth: 3
    fig_caption: yes
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.align = 'center', cache = FALSE)
opts_knit$set(root.dir=normalizePath('../')) # required if Rmd is nested below the project directory
opts_chunk$set(fig.path = "../output/figures/")

set.seed(1234)
```

**EVMP Data Processing**

_Code author:_ 
E. Gage  
mycologica@gmail.com  
https://github.com/egage

__Updated:__ `r format(Sys.time(), '%Y %B %d')`

```{r, echo=FALSE}

suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(fs))
suppressPackageStartupMessages(library(sf))
suppressPackageStartupMessages(library(janitor))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(mapview))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(ggstance))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(skimr)) 
suppressPackageStartupMessages(library(dataMaid))
library(lubridate)
library(mapview)
library(vtree)
library(bayestestR)
library(gt)
library(ggmap)
library(gt)
library(gtsummary)
library(labelled)
library(summarytools)
library(ggrepel)
library(ggtext)

```


```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}

# some themes
theme_smFacet <- theme_minimal() + theme(strip.text.x = element_text(size = 7))
theme_smFacet2 <- theme_minimal() + theme(strip.text.x = element_text(size = 6))

```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE}
# data import functions
read_sheets <- function(file){
  xlsx_file <- file
  xlsx_file %>%
    excel_sheets() %>%
    set_names() %>%
    map_df(read_excel, path = xlsx_file, .id = 'sheet_name', trim_ws = TRUE, skip = 1, col_types = "text", range = "A2:DW700") %>% 
    mutate(file_name = file) %>% 
    select(file_name, sheet_name, everything())
}

## read xlsx then csv cache
read_then_csv <- function(sheet, path) {
  pathbase <- path %>%
    basename() %>%
    tools::file_path_sans_ext()
  path %>%
    read_excel(sheet = sheet) %>% 
    write_csv(paste0(pathbase, "-", sheet, ".csv"))
}


```
  
```{r func_plotting, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}
## plotting functions
ggTile_yr_season_site2 <- function(df){
  df %>%
  group_by(yr, season, site2) %>%
  summarise(n= n()) %>%
  ggplot(aes(yr, site2)) +
  geom_tile(aes(fill = n), color = 'white') +
  viridis::scale_fill_viridis(option = "B") +
  facet_wrap(~season) +
  theme(axis.text.x = element_text(angle = 55, hjust = 1, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  facet_wrap(~season)}


ggTile_yr_season_site <- function(df){
  df %>%
  group_by(yr, season, site) %>%
  summarise(n= n()) %>%
  ggplot(aes(yr, site)) +
  geom_tile(aes(fill = n), color = 'white') +
  viridis::scale_fill_viridis(option = "D") +
  theme(axis.text.x = element_text(angle = 55, hjust = 1, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  facet_wrap(~season)} 

### Table functions
## gt field names
names.gt <- function(df){
  df %>% 
  names() %>% enframe %>% gt::gt() %>% 
    tab_header(title = "field names")
}

names.dt <- function(df){
  df %>% 
  names() %>% enframe %>% 
    DT::datatable(caption = "field names")
}

## summary funcs
mean_r1 <- function(x){
  round(mean(x, na.rm = TRUE),1)
}

sd_r1 <- function(x){
  round(sd(x, na.rm = TRUE),1)
}

range_r1 <- function(x){
  round(range(x, na.rm = TRUE),1)
}

```

```{r, eval=FALSE}
# This document provides a basic exploration of EVMP files provided by RMNP in October of 2018.  The code and analyses aim to characterize basic data structure, identify problems, and clean and reorganize as needed for plotting and modeling. Specific objectives include identifying issues such as:
# 
# * Inconsistently named/typed factors    
# * Missing values
# * Data values outside of expected range or showing unusual patterns
# Cleaned and archivable data sets will be produced to facilitate future data analysis and aid RMNP in their management goals.

```

```{r, eval=FALSE, echo=FALSE}

# Create a cache of workbook tabs as CSV files
## cache csv. This creates a csv cache of each tab in the workbook.

read_then_csv <- function(sheet, path) {
  pathbase <- path %>%
    basename() %>%
    tools::file_path_sans_ext()
  path %>%
    read_excel(sheet = sheet) %>% 
    write_csv(paste0(pathbase, "-", sheet, ".csv"))
}

path %>%
  excel_sheets() %>%
  set_names() %>% 
  map(read_then_csv, path = path)
```


```{r}
##### READ IN CSV FILES EXPORTED FROM EXCEL TABS 
## all the csv names and paths as list column

csv.all <- tibble(ffname = fs::dir_ls("data/EVMP_data/csv",glob = "*.csv"))

## purrr to read csv into list column
csv.all.lc <- csv.all %>% 
  mutate(data = map(ffname,read_csv))

```


```{r}
#### maps
### The following code extracts out the most recent 'site info' file, creates a sf object for plotting and further spatial analysis. Note this is different than below where a different file ('VEG_SITES_MSTR_DATABASE.xlsx') provided by the park is interogated. Here, it's the 'site info' tab within the spreadsheet

# site info
sinfo <- csv.all.lc %>%
  filter(str_detect(ffname, "z2018 Site Info.csv"))

sinfo.df <- sinfo %>% 
  pluck(2) %>% 
  pluck(1)

#### Fix inconsistent labeling of some SITE_ID values
sinfo.df <- sinfo.df %>% 
  mutate(SITE_ID = case_when(SITE_ID == "WC1" ~ "WC01",
                       SITE_ID == "WC2" ~ "WC02",
                       SITE_ID == "WC3" ~ "WC03", 
                       SITE_ID == "WC4" ~ "WC04", 
                       SITE_ID == "WC4" ~ "WC04",
                       SITE_ID == "WC5" ~ "WC05",
                       SITE_ID == "WC6" ~ "WC06", 
                       SITE_ID == "WC7" ~ "WC07", 
                       SITE_ID == "WC8" ~ "WC08",
                       SITE_ID == "WC9" ~ "WC09",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC2" ~ "WNC02",
                       SITE_ID == "WNC3" ~ "WNC03", 
                       SITE_ID == "WNC4" ~ "WNC04", 
                       SITE_ID == "WNC4" ~ "WNC04",
                       SITE_ID == "WNC5" ~ "WNC05",
                       SITE_ID == "WNC6" ~ "WNC06", 
                       SITE_ID == "WNC7" ~ "WNC07", 
                       SITE_ID == "WNC8" ~ "WNC08",
                       SITE_ID == "WNC9" ~ "WNC09",
                       SITE_ID == "WK1" ~ "WK01",
                       SITE_ID == "WK2" ~ "WK02",
                       SITE_ID == "WK3" ~ "WK03", 
                       SITE_ID == "WK4" ~ "WK04", 
                       SITE_ID == "WK4" ~ "WK04",
                       SITE_ID == "WK5" ~ "WK05",
                       SITE_ID == "WK6" ~ "WK06", 
                       SITE_ID == "WK7" ~ "WK07", 
                       SITE_ID == "WK8" ~ "WK08",
                       SITE_ID == "WK9" ~ "WK09",
                       TRUE ~ as.character(SITE_ID))
  )

```

```{r site_info_import}
# define path to the veg site master file
path.si <- ("data/EVMP_data/VEG_SITES_MSTR_DATABASE.xlsx")

#### Read in the worksheets and create list of df
# each tab is a df in the list object
si.d <- path.si %>% 
  excel_sheets() %>% 
  set_names() %>%
  map(read_excel, path = path.si) # 

## this retrieved ALL of the tabs. Subset the list to get to the desired tabs

site.info.willow <- si.d$'WILLOW SITES MASTER'
site.info.aspen <- si.d$'ASPEN SITES MASTER'
site.info.upland <- si.d$'UPLAND SITES MASTER'
## note: each of the tabs call the UTM coordinate columns something different. For simplicity, I changed them to be consistent in the source file

# and the active master tab. 
site.info.active <- si.d$'ACTIVE VEG SITE LOCATION MASTER'

## gets the names of the individual sheets
# site.info.willow %>% names()
# site.info.aspen %>% names()
# site.info.upland %>% names()

## they don't have the same column names. The following vector is a subset in common
# csel <- c("SITE_ID","UTM_E_NAD83","UTM_N_NAD83","FENCED","VALLEY","UTM_N_NAD83","BURNED")
csel <- c("SITE_ID","UTM_E_NAD83","UTM_N_NAD83","FENCED","BURNED","REMOVED")

site.info.willow <- select(site.info.willow,csel) %>% 
  mutate(pType = "willow")
site.info.aspen <- select(site.info.aspen,csel) %>% 
  mutate(pType = "aspen")
site.info.upland <- select(site.info.upland,csel) %>% 
  mutate(pType = "upland")

## remove the "-R" from site id. 
site.info.willow <- site.info.willow %>% 
  mutate(SITE_ID = str_remove(SITE_ID,"-R"))

## combine the aspen, willow, and upland plots
site.info.all <- rbind(site.info.willow, site.info.aspen, site.info.upland)

# join in the range type from site.info.active tab
rtype <- site.info.active %>% 
  dplyr::select(SITE_ID, WILDERNESS, RANGE_TYPE)

## join in the info
site.info.all <- left_join(site.info.all, rtype, by = "SITE_ID")

```


```{r gtbl_sites}

#### Change the NA range types fields
site.info.all <- site.info.all %>%
  # distinct(RANGE_TYPE)
  mutate(RANGE_TYPE = case_when(grepl("WC", SITE_ID) ~ "core winter range",
                          grepl("WNC", SITE_ID) ~ "non-core winter range",
                          grepl("AC", SITE_ID) ~ "core winter range",
                          grepl("ANC", SITE_ID) ~ "non-core winter range",
                          grepl("UNC", SITE_ID) ~ "non-core winter range",
                          grepl("UC", SITE_ID) ~ "core winter range",
                          grepl("K", SITE_ID) ~ "Kawuneeche Valley"
                          )
         ) 

####################### Clean #########################
#### Remove records with "NA" for coordinates or ones with
#### Any non-NA for the "REMOVE" field 

site.info.clean <- site.info.all %>%
  dplyr::na_if(.,"NA") %>%  # replacing all the text NA with real NA
  filter(!is.na(UTM_E_NAD83)) %>% # only keeping points with coordinates
  filter(!is.na(UTM_N_NAD83)) %>% 
  # filter(!is.na(REMOVED)) %>% View()
  filter(is.na(REMOVED)) %>%
  filter(SITE_ID != "WK03-R")

## I discovered further down that WK03-R was retained as it is NA for the 'REMOVED' attribute.
## I'm manually removing now, but need to clarify with NPS

# UNC61 is "NA" for fenced. Making fenced = FALSE
# reclass the FENCED == NA to FENCED == N 
# reclass the BURNED == NA to BURNED == N 

site.info.clean <- site.info.clean %>% 
  mutate(FENCED = case_when(is.na(FENCED) ~ "N", 
                            TRUE ~ as.character(FENCED)))

```


```{r}

## read in the file with the manually attributed valley type field (this was not fully filled in in the provided data)
## I attributed the empty values visually in ArcGIS.  
vt <- st_read("./data/EVMP_derived/site_info_all_sf.shp", quiet = TRUE)
vt <- vt %>% 
  rename(SITE_ID = SITE_) %>% 
  rename(VALLEY = VALLE) %>% 
  as_tibble() %>% 
  select(SITE_ID, VALLEY)

site.info.clean <- left_join(site.info.clean, vt, by = "SITE_ID")

## recode some of the valley ids
site.info.clean <- site.info.clean %>% 
  mutate(VALLEY = recode(VALLEY, 
                         'FRE' = "HSP")) %>% 
  mutate(VALLEY = recode(VALLEY, 
                         'LHP' = "HSP")) 

## add more valley info from a lookup table
valley_lu <- read_csv("./data/EVMP_derived/VALLEY_lu.csv")

## join in the valley info
site.info.clean <- left_join(site.info.clean, valley_lu, by = "VALLEY") 

# Convert all these into y and n until I get guidance from Hanem
# Eliminate all the vague burned categories, collapsing them to a binary burned/not-burned category

site.info.clean <- 
  site.info.clean %>% 
  mutate(BURNED = case_when(BURNED == "Unburned" ~ "Unburned",
                            BURNED == "N Y" ~ "Unburned",
                            BURNED == "Completely" ~ "Burned",
                            BURNED == "Moderately" ~ "Burned",
                            BURNED == "Moderately to Completely" ~ "Burned",
                            BURNED == "Y" ~ "Burned",
                            BURNED == "N" ~ "Unburned",
                            BURNED == "Not burned" ~ "Unburned",
                            is.na(BURNED) ~ "Unburned",
                            TRUE ~ BURNED)
         ) %>% 
  mutate(FENCED = case_when(FENCED == "Y_but_fence_down_since_2013" ~ "Unfenced",
                             FENCED == "Y" ~ "Fenced",
                             FENCED == "N" ~ "Unfenced"))

## note: all "NA" for burned are assumed to be unburned and recoded as such

###
## WK03 missing VALLEY attribute
site.info.clean <- site.info.clean %>%
  mutate(VALLEY = case_when(SITE_ID == "WK03" ~ "KV",
                            TRUE ~ VALLEY)) %>% 
  mutate(valley_full = case_when(SITE_ID == "WK03" ~ "Kawuneeche Valley",
                            TRUE ~ valley_full))

```

```{r, eval = FALSE}
## write site info to csv
write_csv(site.info.clean, "./data/EVMP_derived/site_info_clean.csv")
```

# DERIVED in/out - site info

```{r}
########## Read in site information
site.info.clean <- read_csv("./data/EVMP_derived/site_info_clean.csv")

```


```{r}
### Table of removed plots 
# Problem records lacking coordinates 
site.info.all %>% 
  dplyr::na_if(.,"NA") %>%  # replace all the text NA with real NA
  filter(!is.na(UTM_E_NAD83)) %>% # only keeping points with coordinates
  filter(!is.na(UTM_N_NAD83)) %>%
  filter(!is.na(REMOVED)) %>% # filter out plots notes as "removed"
  select(-WILDERNESS) %>% 
  gt::gt() %>%
  tab_header(title = md("**EVMP plots listed as 'Removed'**")) 
  # write_csv("output/tables/EVMP_plots_marked_removed.csv")
# A total of 15 plots were removed from subsequent steps. Confirm the final status of these records.
```

**Site information:**
```{r}
## create some tables
site.info.clean %>%
  dplyr::select(-REMOVED) %>% 
  datatable(caption = "Valid EVMP plots")

```

```{r}
## create Site info UTM coord lu
site.id.coords <- site.info.clean %>%
  mutate_at(2:3, as.numeric) %>% 
  select(SITE_ID, UTM_E_NAD83, UTM_N_NAD83) %>% 
  filter(!is.na(UTM_N_NAD83)) 

```


```{r}

# site.info.clean %>% 
#   write_csv("./output/tables/evmp_plots_table1.csv")

```

```{r}
# gt.siteinfo <- site.info.clean %>%
#   dplyr::select(-REMOVED) %>% 
#   datatable(caption = "Valid EVMP plots")

# gt.siteinfo <- site.info.clean %>%
#   dplyr::select(-REMOVED) %>% 
#   gt::gt() %>%
#   tab_header(title = md("**Valid EVMP plots from 'site_info' worksheet**")) 

# gt.siteinfo <- gt.siteinfo %>% 
#   tab_style(
#     style = list(
#       cell_fill(color = "lightcyan"),
#       cell_text(weight = "bold")
#       ),
#     locations = cells_data(
#       columns = vars(FENCED),
#       rows = FENCED == "Y")
#   ) %>% 
#   tab_style(
#     style = list(
#       cell_fill(color = "ivory")),
#     locations = cells_data(
#       columns = vars(FENCED),
#       rows = FENCED == "N")
#   ) 
# 
# ## add color for pType
# gt.siteinfo %>% 
#     tab_style(
#     style = list(
#       cell_fill(color = "lightgreen"),
#       cell_text(weight = "bold")
#       ),
#     locations = cells_data(
#       columns = vars(pType),
#       rows = pType == "willow")
#   ) %>% 
#   tab_style(
#     style = list(
#       cell_fill(color = "ivory2"),
#       cell_text(weight = "bold")
#     ),
#     locations = cells_data(
#       columns = vars(pType),
#       rows = pType == "aspen")
#   ) %>% 
#   tab_style(
#     style = list(
#       cell_fill(color = "pink"),
#       cell_text(weight = "bold")
#       ),
#     locations = cells_data(
#       columns = vars(pType),
#       rows = pType == "upland")
#   )

```


```{r}
#### create SF from coordinates
site.info.clean.sf <- site.info.clean %>%
  mutate_at(2:3, as.numeric) %>% 
  st_as_sf(coords = c("UTM_E_NAD83", "UTM_N_NAD83"), crs = 26913)

## write the site info to shapefile
# st_write(site.info.clean.sf, "./data/EVMP_derived/site_info_clean.shp")

```

```{r}
valley_lu <- site.info.clean.sf %>% 
  as_tibble() %>% 
  select(SITE_ID, VALLEY) %>% 
  distinct()

```


```{r, eval=FALSE}
## gt: grouped example

site.info.clean.sf %>%
  dplyr::select(-REMOVED) %>%
  group_by(pType) %>% 
  tally() %>% 
  gt::gt() 

gt.siteinfo <- site.info.clean %>%
  dplyr::select(-REMOVED) %>%
  group_by(valley_full, pType) %>% 
  tally() %>% 
  gt::gt() %>% 
  tab_header(title = md("**EVMP plots by valley location**")) 
gt.siteinfo

gt.siteinfo %>% 
  summary_rows(
    #groups = TRUE,
    columns = vars("n"),
    fns = list(TOTAL = "sum"),
    formatter = fmt_number,
    decimals = 0,
    use_seps = TRUE
  )

```


```{r, eval=FALSE, echo=FALSE}
## list column approach
## note quite working yet :)

site.info.clean.sf.nest <- site.info.clean.sf %>% 
  group_by(VALLEY) %>% 
  nest()


site.info.clean.sf.nest %>% 
  mutate(plot = map2(data, VALLEY, ~ggplot(data = .x) + theme_tufte() +
       geom_sf(aes(color =FENCED))))
       
       ggtitle(.y) +
       ylab("Year") +
       xlab("Average annual hours worked by persons engaged")))

```


```{r, eval = FALSE, echo = FALSE}
### Raw data in "Site info" tabs from RMNP 

site.info.willow %>% 
  DT::datatable()

site.info.aspen %>% 
  DT::datatable()

site.info.upland %>% 
  DT::datatable()

# site.info.all %>% 
#   skimr::skim() %>% 
#   gt::gt()

```

# Study area and sampling design

Excluding plots removed from the data set due to issues like the 2013 flood, their were 241 plots in total. Approximately 49% (n=118) were willow plots, followed in abundance by aspen and upland plots: 

```{r}
site.info.clean.sf %>%
  as_tibble() %>%
  filter(!is.na(VALLEY)) %>%
  tabyl(pType) %>% 
  rename('Plot type' = pType) %>% 
  gt::gt() %>% 
  fmt_percent(
    columns = vars(percent),
    decimals = 1
    )
```

Plots were most abundant in Moraine Park, followed by Horseshoe Park and Upper Beaver Meadows.

```{r}
site.info.clean.sf %>%
  as_tibble() %>% 
  # filter(!is.na(VALLEY)) %>%
  tabyl(valley_full) %>%
  arrange(-n) %>% 
  rename('Location' = valley_full) %>%
  gt::gt() %>% 
  fmt_percent(
    columns = vars(percent),
    decimals = 1
    )
```


```{r}
site.info.clean.sf %>%
  as_tibble() %>% 
  filter(!is.na(VALLEY)) %>%
  tabyl(valley_full, pType) %>%
  rename('Location' = valley_full) %>%
  arrange(-willow) %>% 
  gt::gt() 

```

  

```{r, eval=FALSE}
#### Map of fenced and unfenced areas - all plots
# Change basemap or pan and zoom.

# mapviewOptions(basemaps = c("Esri.WorldImagery"), # Esri.WorldShadedRelief "Esri.WorldImagery"
#                vector.palette = colorRampPalette(c("snow", "cornflowerblue", "grey10")),
#                na.color = "magenta",
#                layers.control.pos = "topright")

site.info.clean.sf %>%
  mapview(zcol='FENCED')

```


```{r}
site.info.clean.sf %>%
  as_tibble() %>% 
  filter(!is.na(VALLEY)) %>%
  tabyl(FENCED) %>% 
  gt::gt() %>%
  fmt_percent(
    columns = vars(percent),
    decimals = 1
    )

# Approximately 21% of plots occur in fenced locations
```


```{r}
site.info.clean.sf %>%
  as_tibble() %>% 
  filter(is.na(VALLEY)) %>%
  tabyl(valley_full, FENCED) %>%
  #arrange(-(Y)) %>% 
  rename('Location' = valley_full) %>%
  gt::gt() %>% 
  tab_header(title = "Fenced/non-fenced")

```


```{r, eval=FALSE}
# **Table of records with NA for "VALLEY"**

# Note that "location" and "valley" exist in different workbooks/datasets, differ in attributes, and are incompletely attributed. 

# "location" and "valley" exist in different workbooks/datasets, differ in attributes, and are incompletely attributed.

site.info.clean.sf %>% 
  filter(!is.na(VALLEY)) %>%
  datatable(caption = "Records missing VALLEY attributes.")
```


```{r, eval=FALSE}
#### Map of burned plots
site.info.clean.sf %>%
  filter(EastWest == "East") %>%
  filter(!is.na(BURNED)) %>% 
  # filter(BURNED != 'N') %>%
  # filter(BURNED != 'Unburned') %>%
  mapview(zcol='BURNED',
          map.types = c("Esri.WorldImagery", "Esri.WorldTopoMap"))

```




```{r, eval=FALSE}
#### Map of Kawuneeche Valley EVMP sites
site.info.clean.sf %>% 
  filter(VALLEY == "KV") %>% 
  mapview::mapview(., zcol = 'pType',
                  map.types = c("Esri.WorldImagery", "Esri.WorldTopoMap"))

```

A total of 17 plots occur in the Kawuneeche Valley: 
```{r}

site.info.clean.sf %>% 
  as_tibble() %>% 
  filter(VALLEY == "KV") %>%
  select(-c(geometry, REMOVED, WILDERNESS, RANGE_TYPE)) %>%
  rename('Valley code' = VALLEY) %>%
  rename('Valley name' = valley_full) %>% 
  gt::gt()

```



```{r}
### note this is still missing as na

site.info.clean.sf %>%
  group_by(valley_full) %>% 
  tally() %>% 
  # na.omit() %>%  ### NEED TO ATTRIBUTE THESE. BUT FOR TESTING....
  ggplot(aes(reorder(valley_full, n),n)) +
  # ggplot( aes(VALLEY, n, size = n, color=VALLEY)) +
  geom_point(color="white", size = 6) +
  geom_pointrange(ymin=0, aes(ymax=n)) +
   geom_point(color="ivory3", size = 10) +
  geom_text(aes(label=n), size=6) +
  # scale_x_log10() +
  theme_minimal() +
  coord_flip() +
  labs(x="Valley", y = "Count", title = "Count of EVMP sampling sites by location")
  
# ggplotly(plotly1)
```




### Plot counts by location and management subgroup


```{r}

##
pl.cnt1 <- site.info.clean.sf %>%
  group_by(pType, valley_full) %>% 
  tally() %>%
  ungroup() %>% 
  # na.omit() %>%  ### NEED TO ATTRIBUTE THESE. BUT FOR TESTING....
  ggplot(aes(reorder(valley_full, n),n)) +
  # ggplot( aes(VALLEY, n, size = n, color=VALLEY)) +
  # geom_point(color="white", size = 6) +
  geom_point(aes(color = pType), size = 6) +
  geom_pointrange(ymin=0, aes(ymax=n)) +
  geom_point(aes(color=pType), size = 8) +
  # geom_point(color="ivory3", size = 10) +
  geom_text(aes(label=n), size=4) +
  # scale_x_log10() +
  theme_minimal() +
  labs(x="", y = "Count", title = "Count of EVMP sampling sites") +
  coord_flip() +
  theme(legend.position = "bottom")

pl.cnt1
# ggsave("./output/figures/tally_plot_by_valley_type.png", width = 7, height = 5)


pl.cnt2 <- site.info.clean.sf %>%
  group_by(RANGE_TYPE) %>% 
  tally() %>% 
  ggplot(aes(reorder(RANGE_TYPE, n),n)) +
  # ggplot( aes(VALLEY, n, size = n, color=VALLEY)) +
  geom_point(color="white", size = 4) +
  geom_pointrange(ymin=0, aes(ymax=n)) +
   geom_point(color="ivory3", size = 10) +
  geom_text(aes(label=n), size=3) +
  # scale_x_log10() +
  theme_minimal() +
  # coord_flip() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  labs(x="", y = "Count", title = "")

pl.cnt2
# ggsave("./output/figures/tally_plot_by_rangeType.png", width = 7, height = 5)


pl.cnt1.cnt2 <- cowplot::plot_grid(pl.cnt1, pl.cnt2, labels = "AUTO")
# pl.cnt1.cnt2

# ggsave(plot = pl.cnt1.cnt2, filename = "./output/figures/twoPanel_valleyCnt_rangeCnt2.png", width = 8, height = 5, dpi = 300)


site.info.clean.sf %>%
  as_tibble() %>% 
  select(-geometry) %>% 
  group_by(RANGE_TYPE, pType) %>% 
  tally() %>% 
  gt()


```



```{r, eval=FALSE}
site.info.clean.sf %>%
  filter(!is.na(VALLEY)) %>%
  as_tibble() %>% 
  datatable()
## cleaned above so none...
```

### Counts of plots in fenced and unfenced contexts

```{r}

pl.hm1 <- site.info.clean.sf %>%
  filter(!is.na(FENCED)) %>%
  group_by(FENCED,valley_full) %>%
  tally() %>%
  ungroup() %>% 
  ggplot(aes(FENCED, valley_full)) +
  geom_tile(aes(fill = n), color= 'white') +
  # geom_point(color="white", size = 6) +
  geom_text(aes(label=n), size=6, color = 'white') +
  # scale_x_log10() +
  # theme_bw() +
  theme_minimal() +
  # scale_fill_gradient(low = "ivory4",high = "black") +
  scale_fill_viridis() +
  # theme_minimal() +
  # coord_flip() +
  labs(x="Fenced", y = "", title = "Count of EVMP sampling sites",subtitle = "By valley and and fenced status")

# ggsave(plot = pl.hm1, filename = "./output/figures/cnt_plot_valley_x_fenced.png", width = 5, height = 4, dpi = 300)

pl.hm2 <- site.info.clean.sf %>%
  filter(!is.na(FENCED)) %>% 
  group_by(FENCED,pType) %>% 
  tally() %>% 
  ungroup() %>%
  ggplot(aes(FENCED, pType)) +
  geom_tile(aes(fill = n), color= 'white') +
  # geom_point(color="white", size = 6) +
  geom_text(aes(label=n), size=6, color = 'white') +
  # scale_x_log10() +
  # theme_bw() +
  theme_minimal() +
  scale_fill_viridis() +
  # scale_fill_gradient(low = "ivory4",high = "black") +
  # theme_minimal() +
  # coord_flip() +
  labs(x="Fenced", y = "", title = "Count of EVMP sampling sites", subtitle = "By plot type and fenced status")

# ggsave(plot = pl.hm2, filename = "./output/figures/cnt_ptype_x_fenced.png", width = 5, height = 4, dpi = 300)
pl.hm1
pl.hm2

# cow1 <- cowplot::plot_grid(pl.hm1, pl.hm2, labels = "AUTO", ncol=1,rel_heights = c(2,1))
# cow1
# ggsave(plot = cow1, filename = "./output/figures/cnt_ptype_valle_x_fenced.png", width = 5, height = 4, dpi = 300)

```


```{r}
#### Cleaning
# data.entry(site.info.all)

```

```{r, eval = FALSE}
## scrap: creat functions to create basemaps with ggplot
library(ggmap)  # you may have to use install.packages to install it first
b <- ggmap::bbox(lnd)
(lnd.b1 <- ggmap(get_map(location = b)))  # download map data for the lnd data and plot

ggmap::bb2bbox()

```


```{r}
## nested by range type 

site.info.clean.sf.nest <- site.info.clean.sf %>% 
  filter(!is.na(RANGE_TYPE)) %>% 
  group_by(RANGE_TYPE) %>% 
  nest()

```


```{r, eval=TRUE}
##ggmap site maps. Need base maps

site.info.clean.sf.nest <- site.info.clean.sf.nest %>% 
  mutate(plot = map2(data,RANGE_TYPE, ~ggplot(data = .x) + theme_minimal() +
                       geom_sf() +
                       labs(title = .y))) 
# library(OpenStreetMap)

```

```{r, eval = FALSE}
## pring the ggmaps
mm1 <- site.info.clean.sf.nest %>% 
  pluck(3) %>% pluck(1) 
mm1

mm2 <- site.info.clean.sf.nest %>% 
  pluck(3) %>% pluck(2)
mm2

mm3 <- site.info.clean.sf.nest %>% 
  pluck(3) %>% pluck(3)
mm3

# cowplot::plot_grid(mm1,mm2,mm3,nrow = 1)
# file_names <- paste0(country_list, ".pdf")
# map2(paste0(plots$country, ".pdf"), plots$plot, ggsave)  

# ### 
# sinfo.sf %>% 
#   group_by(SITE_TYPE) %>% 
#   nest() %>% 
#   walk2(.x = data,.f = mapview)
#   mutate(plot2 = map(.$SITE_TYPE, mapview)) 
```


```{r, eval=FALSE}

site.info.clean.sf.nest <- site.info.clean.sf.nest %>% 
  mutate(plot2_MV = map(data,mapview)) 

### this prints them all out.
# site.info.clean.sf.nest %>%
#   pluck(4)
## seemingly just to console, not when knit for mapview
## BUT it does work for ggplot objects...
# site.info.clean.sf.nest %>%
#   pluck(3)

```





```{r, eval=FALSE, fig.align='center'}
# **East-side Core Winter Range (WC) map**
## map: Core Winter Range
site.info.clean.sf.nest %>% 
  pluck(2) %>% pluck(1) %>% 
  # names()
  mapview(zcol = "FENCED")

```


```{r, eval=FALSE, fig.align='center'}
# **East-side Non-core Winter Range (WC) map**
## map: KV
site.info.clean.sf.nest %>% 
  pluck(2) %>% pluck(3) %>% 
  mapview(zcol = "FENCED")

```



```{r, eval=FALSE, fig.align='center'}
# **West-side Kawuneeche Valley (WK) map**
## map: KV
site.info.clean.sf.nest %>% 
  pluck(2) %>% pluck(2) %>% 
  mapview(zcol="FENCED")

# site.info.clean.sf.nest %>% 
#   pluck(2) %>% 
#   pluck(2) %>%
#   ggplot() +
#   geom_sf(aes(color = FENCED)) +
#   theme_minimal()

```

Raw data files entered by RMNP staff from field data forms were processed using functions in in the R statistical package. Raw data were provided as 4 Excel files, with data split by year and type into various tabs. Data were consolidated and to facilitate cleaning and comparisons.      

```{r}
### Data cleaning and wrangling
# list of files, tidyverse approach: 
# file.listing <- dir_info(path = "./data/EVMP_data/TenYearReview", recurse = TRUE) %>%
#   filter(type == "file", permissions == "u+r", size > "10KB") %>%
#   arrange(desc(size)) %>%
#   View()
#   dplyr::select(path, size)

# datatable(file.listing, rownames = FALSE, caption = "List of files provided by RMNP 2018-10-10")

## base R approach
file.listing <- list.files(path = "./data/EVMP_data/TenYearReview") %>% 
  enframe() %>% 
  select(value) %>% 
  rename(fileName = value)

knitr::kable(file.listing, rownames = FALSE, row.names = FALSE, col.names = "file name", caption = "Raw files provided by RMNP staff.")

```


```{r}
### Willow cumulative data baseline through 2018
#### There are two duplicate sets of files, one with a 'z' in the name, one without, but otherwise the same. In this chunk, picking one set (the zed set)

csv.all.lc <- csv.all.lc %>% 
  filter(str_detect(ffname, "z")) 

```

```{r}
######### CREATE TYPE FIELD #########
## this will make parsing variables in into groups easier  

csv.all.lc <- csv.all.lc %>% 
  mutate(file_name_abr = str_replace(string = ffname, pattern = "data/EVMP_data/csv/Willow_Cumulative_Data_Baseline_Through_2018-", replacement = ""))

## case when into type
csv.all.lc <- csv.all.lc %>% 
  dplyr::select(-ffname) %>%
  mutate(vType = case_when(grepl("Macro", file_name_abr) ~ "Macroplot",
                          grepl("site", file_name_abr, ignore.case = TRUE) ~ "Site_info",
                          grepl("Key", file_name_abr, ignore.case = TRUE) ~ "Key",
                          grepl("Line", file_name_abr, ignore.case = TRUE) ~ "Line_int"
                          )
         )

```


```{r}
## Variable names across input files 
# extract the field names from each csv
csv.all.lc <- csv.all.lc %>% 
  mutate(field_names = map(data, names)) 
  
# unnest to get at field names
# across all csv files
csv.all.lc %>% 
  unnest(field_names) %>% 
  distinct(file_name_abr,field_names) %>% 
  datatable(rownames = FALSE, caption = "Distinct field names acrosss all csv files correponding to tabs in master workbooks provided by RMNP.")

#### Distinct field names via unnest()
# csv.all.lc %>%
#   unnest(field_names) %>%
#   distinct(ffname,field_names) %>%
#   datatable()

```

```{r}
## just line intercept

#### Line intercept
csv.all.lc.li <- csv.all.lc %>% 
  filter(vType == "Line_int") 

# Distinct variable names across all input csv files for just line intercept plot
# csv.all.lc.li %>% 
#   unnest(field_names) %>% 
#   distinct(file_name_abr,field_names) %>% 
#   # write_csv("output/temp_4_review/distinc_line_in_names.csv")
#   datatable(rownames = FALSE, caption = "Distinct variable names for line intercept files.")

```



```{r}
#### FUNCTIONS 
#### Select multiple columns. To combine, need the same fields to be present in each tab.

filtFunSel <- function(x){
  x %>% dplyr::select(c(DATE,
                      SITE_TYPE,
                      SITE_NUMBER,
                      SITE_ID,
                      SPECIES_CODE,
                      # SHRUB_INTERCEPT_START_M,
                      # SHRUB_INTERCEPT_STOP_M,
                      MAX_HEIGHT_CM,
                      #DEAD,
                      BROWSED,
                      INTERCEPT_LENGTH_M,
                      GENUS))
}


### the above is used throoughout below
# but now I woant to grab the shrub intercept bits
filtFunSel_li <- function(x){
  x %>% dplyr::select(c(DATE,
                      SITE_TYPE,
                      SITE_NUMBER,
                      SITE_ID,
                      SPECIES_CODE,
                      SHRUB_INTERCEPT_START_M,
                      SHRUB_INTERCEPT_STOP_M,
                      MAX_HEIGHT_CM,
                      DEAD,
                      BROWSED,
                      INTERCEPT_LENGTH_M,
                      GENUS))
}

# create new list column with the selected rows as specfied in the function
csv.all.lc.li <- csv.all.lc.li %>% 
  mutate(data.sel = map(.x = data, filtFunSel))

# csv.all.lc.li.cov <- csv.all.lc.li %>% 
#   mutate(data.sel = map(.x = data, filtFunSel_li))

## purrr ninja move:
csv.all.lc.li.df <- csv.all.lc.li %>% 
  pluck(1) %>%
  map(filtFunSel) %>% 
  reduce(.f = rbind)
# yay, pluck()!

## Why can't anything be simple....
# just discovered that SITE_ID columns are NOT CONSISTENTLY NAMED
# eg WC1 and WC01


csv.all.lc.li.df <- csv.all.lc.li.df %>% 
  mutate(SITE_ID = case_when(SITE_ID == "WC1" ~ "WC01",
                       SITE_ID == "WC2" ~ "WC02",
                       SITE_ID == "WC3" ~ "WC03", 
                       SITE_ID == "WC4" ~ "WC04", 
                       SITE_ID == "WC4" ~ "WC04",
                       SITE_ID == "WC5" ~ "WC05",
                       SITE_ID == "WC6" ~ "WC06", 
                       SITE_ID == "WC7" ~ "WC07", 
                       SITE_ID == "WC8" ~ "WC08",
                       SITE_ID == "WC9" ~ "WC09",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC2" ~ "WNC02",
                       SITE_ID == "WNC3" ~ "WNC03", 
                       SITE_ID == "WNC4" ~ "WNC04", 
                       SITE_ID == "WNC4" ~ "WNC04",
                       SITE_ID == "WNC5" ~ "WNC05",
                       SITE_ID == "WNC6" ~ "WNC06", 
                       SITE_ID == "WNC7" ~ "WNC07", 
                       SITE_ID == "WNC8" ~ "WNC08",
                       SITE_ID == "WNC9" ~ "WNC09",
                       SITE_ID == "WK1" ~ "WK01",
                       SITE_ID == "WK2" ~ "WK02",
                       SITE_ID == "WK3" ~ "WK03", 
                       SITE_ID == "WK4" ~ "WK04", 
                       SITE_ID == "WK4" ~ "WK04",
                       SITE_ID == "WK5" ~ "WK05",
                       SITE_ID == "WK6" ~ "WK06", 
                       SITE_ID == "WK7" ~ "WK07", 
                       SITE_ID == "WK8" ~ "WK08",
                       SITE_ID == "WK9" ~ "WK09",
                       TRUE ~ as.character(SITE_ID))
  )


## join in additional site info from the master plot list
csv.all.lc.li.df <- left_join(csv.all.lc.li.df, site.info.clean, by = 'SITE_ID')

```

```{r}
## add fields/convert types 
csv.all.lc.li.df <- csv.all.lc.li.df %>%
  mutate(DATE = as.Date(DATE)) %>% 
  mutate(yr = as.factor(year(DATE))) %>%
  mutate(mo = month(DATE))

## convert "NA" for fencing to "Unfenced". 

csv.all.lc.li.df <- csv.all.lc.li.df %>% 
  mutate(FENCED = case_when(is.na(FENCED) ~ "Unfenced",
                            TRUE ~ as.character(FENCED)))


## create timeClass field with BL including 2008 and 2009
csv.all.lc.li.df <- csv.all.lc.li.df %>% 
  mutate(timeClass = case_when(yr == 2008 ~ "BL",
                              yr == 2009 ~ "BL", 
                              TRUE ~ as.character(yr))) %>% 
  mutate(timeClass = as.factor(timeClass)) %>% 
  mutate(timeClass = fct_relevel(timeClass, "2018", "2013", "BL"))

```



```{r}

## Create a spatial lookup table for joining site info [in workbook tab].
sp.lu <- sinfo.df %>%
  dplyr::select(-c(SITE_TYPE,DATE,SITE_NUMBER, GPS_ACCURACY_M))

## make sure the 'SITE_ID' columns are consistent
sp.lu <- sp.lu %>% 
  mutate(SITE_ID = case_when(
    SITE_ID == "WC1" ~ "WC01",
                       SITE_ID == "WC2" ~ "WC02",
                       SITE_ID == "WC3" ~ "WC03", 
                       SITE_ID == "WC4" ~ "WC04", 
                       SITE_ID == "WC5" ~ "WC05",
                       SITE_ID == "WC6" ~ "WC06", 
                       SITE_ID == "WC7" ~ "WC07", 
                       SITE_ID == "WC8" ~ "WC08",
                       SITE_ID == "WC9" ~ "WC09",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC2" ~ "WNC02",
                       SITE_ID == "WNC3" ~ "WNC03", 
                       SITE_ID == "WNC4" ~ "WNC04", 
                       SITE_ID == "WNC4" ~ "WNC04",
                       SITE_ID == "WNC5" ~ "WNC05",
                       SITE_ID == "WNC6" ~ "WNC06", 
                       SITE_ID == "WNC7" ~ "WNC07", 
                       SITE_ID == "WNC8" ~ "WNC08",
                       SITE_ID == "WNC9" ~ "WNC09",
                       SITE_ID == "WK1" ~ "WK01",
                       SITE_ID == "WK2" ~ "WK02",
                       SITE_ID == "WK3" ~ "WK03", 
                       SITE_ID == "WK4" ~ "WK04", 
                       SITE_ID == "WK4" ~ "WK04",
                       SITE_ID == "WK5" ~ "WK05",
                       SITE_ID == "WK6" ~ "WK06", 
                       SITE_ID == "WK7" ~ "WK07", 
                       SITE_ID == "WK8" ~ "WK08",
                       SITE_ID == "WK9" ~ "WK09",
                       TRUE ~ as.character(SITE_ID))
  )



# csv.all.lc.li.df <- left_join(csv.all.lc.li.df, sp.lu, by= "SITE_ID")

```

```{r}

```


```{r}
#### Macroplot
csv.all.lc.mcro <- csv.all.lc %>% 
  filter(vType == "Macroplot") 

```



```{r}
FunSelMacro <- function(x){
  x %>% dplyr::select(c(DATE,
                      SITE_TYPE,
                      SITE_NUMBER,
                      SITE_ID,
                      SPECIES_CODE,
                      PERCENT_PLANT_IN_PLOT,
                      CANOPY_DIA_1_CM,
                      CANOPY_DIA_2_CM,
                      PLANT_HT_CM,
                      HT_TO_TALLEST_BUDSCAR_CM))
}


csv.all.lc.mcro <- csv.all.lc.mcro %>% 
  mutate(data.sel = map(.x = data, FunSelMacro))


## purrr ninja move:
csv.all.lc.mcro.df <- csv.all.lc.mcro %>% 
  pluck(1) %>%
  map(FunSelMacro) %>% 
  reduce(.f = rbind)

# SITE_ID is not consistent.
# recode
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(SITE_ID = case_when(SITE_ID == "WC1" ~ "WC01",
                       SITE_ID == "WC2" ~ "WC02",
                       SITE_ID == "WC3" ~ "WC03", 
                       SITE_ID == "WC4" ~ "WC04", 
                       SITE_ID == "WC4" ~ "WC04",
                       SITE_ID == "WC5" ~ "WC05",
                       SITE_ID == "WC6" ~ "WC06", 
                       SITE_ID == "WC7" ~ "WC07", 
                       SITE_ID == "WC8" ~ "WC08",
                       SITE_ID == "WC9" ~ "WC09",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC1" ~ "WNC01",
                       SITE_ID == "WNC2" ~ "WNC02",
                       SITE_ID == "WNC3" ~ "WNC03", 
                       SITE_ID == "WNC4" ~ "WNC04", 
                       SITE_ID == "WNC5" ~ "WNC05",
                       SITE_ID == "WNC6" ~ "WNC06", 
                       SITE_ID == "WNC7" ~ "WNC07", 
                       SITE_ID == "WNC8" ~ "WNC08",
                       SITE_ID == "WNC9" ~ "WNC09",
                       SITE_ID == "WK1" ~ "WK01",
                       SITE_ID == "WK2" ~ "WK02",
                       SITE_ID == "WK3" ~ "WK03", 
                       SITE_ID == "WK4" ~ "WK04", 
                       SITE_ID == "WK4" ~ "WK04",
                       SITE_ID == "WK5" ~ "WK05",
                       SITE_ID == "WK6" ~ "WK06", 
                       SITE_ID == "WK7" ~ "WK07", 
                       SITE_ID == "WK8" ~ "WK08",
                       SITE_ID == "WK9" ~ "WK09",
                       TRUE ~ as.character(SITE_ID))
  )

```

```{r, echo=FALSE}
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(yr = year(DATE)) %>% 
  mutate(mo = lubridate::month(DATE))
```

```{r, echo=FALSE}

### join in the spatial/site info
csv.all.lc.mcro.df <- left_join(csv.all.lc.mcro.df, sp.lu, by = "SITE_ID")



```


```{r, eval=FALSE}
### macroplot

csv.all.lc.mcro <- csv.all.lc %>% 
  filter(vType == "Macroplot") 

# fields not in all of the tabs
csv.all.lc.mcro %>% 
  unnest(field_names) %>% 
  group_by(field_names) %>%
  tally() %>% 
  arrange(n) %>% 
  filter(n<6) %>% 
  # distinct(file_name_abr,field_names) %>% 
  # write_csv("output/temp_4_review/macroplot_fld_names.csv")
  datatable(rownames = FALSE, caption = "Macroplot inventory variable NOT present in every year's tab")

# csv.all.lc.mcro %>% 
#   unnest(field_names) %>% 
#   group_by(field_names) %>%
#   tally() %>% 
#   arrange(n) %>% 
#   filter(n==6) %>% 
#   select(field_names) %>% 
#   datapasta::vector_paste_vertical()

csv.all.lc.mcro %>% 
  unnest(field_names) %>% 
  # tabyl(file_name_abr)
  tabyl(file_name_abr,field_names) %>% 
  # write_csv("output/temp_4_review/macroplot_fld_names.csv")
  datatable(rownames = FALSE, caption = "Macroplot inventory variable names.")

```


```{r, eval=TRUE}

# Macroplot processing
# use a custom function to select columns before rbinding
# note these are different field names than li that need to be matched
# this function snags only those fields in common between all of the tabs

FunSelMcro <- function(x){
  x %>% dplyr::select(c(CANOPY_DIA_1_CM, 
                        CANOPY_DIA_2_CM, 
                        DATE, 
                        GENUS, 
                        HT_TO_TALLEST_BUDSCAR_CM,
                        PERCENT_PLANT_IN_PLOT, 
                        PLANT_HT_CM, 
                        SITE_ID, 
                        SITE_NUMBER, 
                        SITE_TYPE, 
                        SPECIES_CODE))
    }


## apply function to select variables in common between all csv
csv.all.lc.mcro <- csv.all.lc.mcro %>% 
  mutate(data.sel = map(.x = data, FunSelMcro)) %>% 
  select(-field_names)

csv.all.lc.mcro <- csv.all.lc.mcro %>% 
  mutate(field_names = map(data.sel, names))

# csv.all.lc.mcro %>% 
#   unnest(field_names) %>% 
#   # tabyl(file_name_abr)
#   tabyl(file_name_abr,field_names) %>% 
#   # write_csv("output/temp_4_review/macroplot_fld_names.csv")
#   datatable(rownames = FALSE, caption = "Macroplot inventory variable names.")



```

```{r}
## combine all using purrr, ninja-style:
# csv.all.lc.mcro.df <- csv.all.lc.mcro %>% 
#   pluck(4) %>% # note the specific index position
#   reduce(.f = rbind) # did this above

## add yr and month columns
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(yr = year(DATE)) %>% 
  mutate(mo = lubridate::month(DATE))

## join the site info
# csv.all.lc.mcro.df <- left_join(csv.all.lc.mcro.df, site.info.clean, by = "SITE_ID")

# View(csv.all.lc.mcro.df)
```


```{r, eval=FALSE, echo=FALSE}
## species codes are a mess
# create a lookup table
csv.all.lc.mcro.df %>%
  mutate(SPECIES_CODE = toupper(SPECIES_CODE)) %>%
  distinct(SPECIES_CODE) 

```

```{r}
## more cleaning...
## change case on species code (there is currently a mix of upper and lower cases)
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(SPECIES_CODE = toupper(SPECIES_CODE))

## add in the look up table
spp.lu <- read_csv("./data/EVMP_derived/species_code_lu.csv")


## problems with 'Fenced' status. Many NA
## Presuming here that all NA are not fenced -- CONFIRM WITH NPS

## Reclassify 'NA' for fenced to 'N'
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(FENCED = case_when(is.na(FENCED) ~ "N", 
                            TRUE ~ as.character(FENCED))) 


# csv.all.lc.mcro.df %>% 
#   group_by(SITE_ID, FENCED) %>% 
#   tally()

```

```{r write_macroplot2disk, eval=FALSE}
## write this to disk
# write_csv(csv.all.lc.mcro.df, "./data/EVMP_derived/macroplot_derived.csv")
```

# Willow plots: Line intercept data

WC, WNC, and WK plots. 

```{r, eval = FALSE, echo=FALSE}
# > From discussions with HA in the field, the orientation of line-intercept transects may not have had a consistent orientation from sampling interval to interval.
```

## Data munging

```{r}
## address missing attributes for pType
csv.all.lc.li.df <- csv.all.lc.li.df %>%
  mutate(pType = case_when(is.na(pType) ~ "willow",
                            TRUE ~ pType))

## address missing attributes for RANGE_TYPE
csv.all.lc.li.df <- csv.all.lc.li.df %>%
  mutate(RANGE_TYPE = case_when(is.na(RANGE_TYPE)  & SITE_TYPE == "WC" ~ "core winter range",
                            TRUE ~ RANGE_TYPE))

```


```{r}
## Make NA unburned
## presumes NA are "unburned"
## standardize encoding of BURNED
csv.all.lc.li.df <- csv.all.lc.li.df %>%
  mutate(BURNED = case_when(is.na(BURNED) ~ "Unburned",
                            BURNED == "Not burned" ~ "Unburned",
                            TRUE ~ BURNED))

## reverse factor levels
csv.all.lc.li.df <- csv.all.lc.li.df %>%
  mutate(timeClass = forcats::fct_rev(timeClass))

## Reorder levels
csv.all.lc.li.df <- csv.all.lc.li.df %>% 
  mutate(SITE_TYPE = as_factor(SITE_TYPE)) %>% 
  mutate(SITE_TYPE = forcats::fct_relevel(SITE_TYPE, "WK", after = 2))
```

```{r}
## Address missing RANGE_TYPE attribution
csv.all.lc.li.df <- csv.all.lc.li.df %>%
  mutate(RANGE_TYPE = case_when(SITE_TYPE == "WC" ~ "core winter range",
                                TRUE ~ RANGE_TYPE)) 
```


```{r write_li_to_disk, eval = FALSE}

write_csv(csv.all.lc.li.df, "./data/EVMP_derived/data_clean_li.csv")

```

## Height: all shrubs  

### All shrubs, site type
```{r}
## Boxplot
csv.all.lc.li.df %>% 
  filter(pType == "willow") %>%
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  ggplot(aes(timeClass, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill = FENCED), outlier.shape = NA) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,300) +
  labs(x="", y= "Height (cm)", title = "Maximum shrub height", caption = "WC, All shrub species line intercept plots") +
  scale_fill_manual(values = c("grey90","grey50")) +
  theme_minimal() + 
  # theme(axis.text.x=element_text(angle = 45, hjust = 1)) #+
  facet_wrap(~SITE_TYPE)

# ggsave("./output/figures_exported/WCWNCWK_LI_shrubHt_boxplot.png", width = 6.5, height = 4.875)

```

```{r}
#### Table of mean max height
csv.all.lc.li.df %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  group_by(timeClass, SITE_TYPE) %>%
  descr(MAX_HEIGHT_CM, stats = "common") %>% 
  summarytools::tb() %>% 
  mutate(across(c('mean','sd','pct.valid'), ~round(.,digits = 1))) %>% 
  gt() %>% 
  tab_header(title = "LI, Mean max height", subtitle = "All shrub species, all site types")

```

### All shrubs, site type, fenced/unfenced

```{r}
#### Table of mean max height
csv.all.lc.li.df %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  group_by(timeClass, SITE_TYPE, FENCED) %>%
  descr(MAX_HEIGHT_CM, stats = "common") %>% 
  summarytools::tb() %>% 
  mutate(across(c('mean','sd','pct.valid'), ~round(.,digits = 1))) %>% 
  gt() %>% 
  tab_header(title = "LI, Mean max height", subtitle = "All shrubs, all site types, fenced/unfenced")

```

### All shrubs, site type, fenced/unfenced, burned/unburned

```{r}
## Boxplot
csv.all.lc.li.df %>% 
  filter(pType == "willow") %>%
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  ggplot(aes(timeClass, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill = FENCED), outlier.shape = NA) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,300) +
  labs(x="", y= "Height (cm)", title = "Maximum shrub height", caption = "WC, All shrub species line intercept plots") +
  scale_fill_manual(values = c("grey90","grey50")) +
  theme_minimal() + 
  # theme(axis.text.x=element_text(angle = 45, hjust = 1)) #+
  facet_wrap(BURNED~SITE_TYPE)

# ggsave("./output/figures_exported/WCWNCWK_LI_shrubHt_FenBur_boxplot.png", width = 6.5, height = 4.875)

```



### Height: willow species only

### All willow species, site type
**Max shrub height in-line intercept**
```{r}
csv.wil.lc.li.df <- csv.all.lc.li.df %>% 
  filter(str_detect(SPECIES_CODE, "^SA"))
  

## Boxplot
csv.wil.lc.li.df %>% 
  filter(pType == "willow") %>%
  # filter(SITE_TYPE == "WC") %>% 
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  # mutate(yr = as.double(yr)) %>%
  ggplot(aes(timeClass, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill = FENCED), outlier.shape = NA) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,600) +
  labs(x="", y= "Height (cm)", title = "Maximum willow height", caption = "WC, All willow species line intercept plots") +
  scale_fill_manual(values = c("grey90","grey50")) +
  theme_minimal() + 
  # theme(axis.text.x=element_text(angle = 45, hjust = 1)) #+
  facet_wrap(~SITE_TYPE)

# ggsave("./output/figures_exported/WCWNCWK_LI_willHt_boxplot.png", width = 6.5, height = 4.875)

```

```{r}
#### Table of mean max height
csv.wil.lc.li.df %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  group_by(timeClass, SITE_TYPE) %>%
  descr(MAX_HEIGHT_CM, stats = "common") %>%
  summarytools::tb() %>%
  mutate(across(c('mean','sd','pct.valid'), ~round(.,digits = 1))) %>% 
  gt() %>% 
  tab_header(title = "LI, Mean max height", subtitle = "All willow species, all site types")

```

### All willow species, site type, fenced/unfenced

```{r}
#### Table of mean max height
csv.wil.lc.li.df %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  group_by(timeClass, SITE_TYPE, FENCED) %>%
  descr(MAX_HEIGHT_CM, stats = "common") %>% 
  summarytools::tb() %>% 
  mutate(across(c('mean','sd','pct.valid'), ~round(.,digits = 1))) %>% 
  gt() %>% 
  tab_header(title = "LI, Mean max height", subtitle = "All willow, all site types, fenced/unfenced")

```

### All willow species, site type, fenced/unfenced, burned/unburned

```{r}
## Boxplot
csv.wil.lc.li.df %>% 
  filter(pType == "willow") %>%
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  ggplot(aes(timeClass, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill = FENCED), outlier.shape = NA) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,600) +
  labs(x="", y= "Height (cm)", title = "Maximum shrub height", caption = "WC, All willow species line intercept plots") +
  scale_fill_manual(values = c("grey90","grey50")) +
  theme_minimal() + 
  # theme(axis.text.x=element_text(angle = 45, hjust = 1)) #+
  facet_wrap(BURNED~SITE_TYPE)

# ggsave("./output/figures_exported/WCWNCWK_LI_willHt_FenBur_boxplot.png", width = 6.5, height = 4.875)

```


```{r}
#### Table of mean max height
csv.wil.lc.li.df %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  group_by(timeClass, SITE_TYPE, FENCED, BURNED) %>%
  descr(MAX_HEIGHT_CM, stats = "common") %>% 
  summarytools::tb() %>% 
  mutate(across(c('mean','sd','pct.valid'), ~round(.,digits = 1))) %>% 
  gt() %>% 
  tab_header(title = "LI, Mean max height", subtitle = "All willow, all site types, fenced/unfenced, burned/unburned")

```

```{r}
# Shrub Line Intercept Datataset 
csv.wil.lc.li.df %>% 
  filter(timeClass == "BL" | timeClass == "2013" |timeClass == "2018") %>% 
  filter(!is.na(FENCED)) %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  # group_by(yr,SITE_TYPE, FENCED, SITE_ID, SPECIES_CODE) %>%
  # filter(SITE_TYPE == "WC") %>% 
  group_by(timeClass,SITE_TYPE, FENCED, SPECIES_CODE) %>%
  summarise(mean.max.ht = round(mean(MAX_HEIGHT_CM, na.rm=TRUE),0)) %>% 
  filter(FENCED != "Y_but_fence_down_since_2013") %>% 
  filter(SPECIES_CODE != "SAXX") %>% 
  ggplot(aes(timeClass, SPECIES_CODE)) +
  geom_tile(aes(fill=mean.max.ht),color = 'white') +
  scale_fill_viridis(option = "A") +
  geom_text(aes(label=mean.max.ht), color = 'white', size = 3.75) +
  theme_minimal() +
  labs(title = "Maximum shrub height", subtitle = "Mean of shrub height pooled by fenced status", x = "Year", y = "Species", fill = "cm") +
  facet_grid(SITE_TYPE~FENCED)

# ggsave("./output/figures_exported/WCWNCWK_maxWilHt_by_spp_lbl.png", width = 6.5, height = 6.5, dpi = 300)

```

### Individual willow species
_Salix moniticola_ 
```{r}

csv.all.lc.li.df %>%
  filter(yr !=2009 & yr != 2015 & yr !=2017) %>% 
  filter(SITE_TYPE != "WK") %>%
  filter(SPECIES_CODE == "SAMO") %>%   filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR"& SPECIES_CODE !="SAER") %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  ggplot() +
  ggridges::geom_density_ridges(aes(x = MAX_HEIGHT_CM, y =  yr, fill = SITE_TYPE), alpha = 0.45, ) +
  viridis::scale_fill_viridis(discrete = TRUE, option = "D") +
  theme_minimal() +
  facet_wrap(~SITE_TYPE, ncol = 1) +
  labs(x = "Max height (cm)", y = "Year", caption = "SAMO") +
  coord_flip()

```

```{r}
csv.all.lc.li.df %>%
  filter(yr !=2009 & yr != 2015 & yr !=2017) %>% 
  filter(SITE_TYPE != "WK") %>%
  filter(SPECIES_CODE == "SAMO" | SPECIES_CODE == "SAGE" | SPECIES_CODE == "SAPL" ) %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  # filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR"& SPECIES_CODE !="SAER") %>%
  # filter(str_detect(SPECIES_CODE, "^SA")) %>%
  ggplot() +
  # geom_point(aes(x = yr, y = MAX_HEIGHT_CM)) +
  geom_boxplot(aes(x = yr, y = MAX_HEIGHT_CM)) +
  # ggridges::geom_density_ridges(aes(x = MAX_HEIGHT_CM, y =  yr, fill = SITE_TYPE), alpha = 0.45, ) +
  viridis::scale_fill_viridis(discrete = TRUE, option = "D") +
  theme_minimal() +
  facet_grid(SITE_TYPE ~ SPECIES_CODE) +
  # facet_wrap(~SITE_TYPE, ncol = 1) +
  labs(y = "Max height (cm)", x = "Year", caption = "SAMO") #+
  # coord_flip()


```

_Line intercept summary table_
```{r}
csv.all.lc.li.df %>%
  filter(yr !=2009 & yr != 2015 & yr !=2017) %>% 
  filter(SITE_TYPE != "WK") %>%
  filter(SPECIES_CODE == "SAMO" | SPECIES_CODE == "SAGE" | SPECIES_CODE == "SAPL" ) %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>% 
  group_by(SPECIES_CODE, timeClass, FENCED) %>% 
  descr(MAX_HEIGHT_CM, stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  gt() %>% 
  tab_header(title = "li: species comparisons")

```


_Salix planifolia_

```{r}
## another species: SAPL
csv.all.lc.li.df %>%
  filter(yr !=2009 & yr != 2015 & yr !=2017) %>%
  # filter(yr == 2018) %>%
  # distinct(SPECIES_CODE)
  filter(SITE_TYPE == "WC") %>%
  # filter(SITE_TYPE != "WK") %>% # leave out KW
  # filter(SPECIES_CODE == "SAPL") %>%
  filter(SPECIES_CODE == "SAMO" | SPECIES_CODE == "SAGE") %>%
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR"& SPECIES_CODE !="SAER") %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  ggplot() +
  ggridges::geom_density_ridges(aes(x = MAX_HEIGHT_CM, y =  yr, fill = FENCED), alpha = 0.45, ) +
  viridis::scale_fill_viridis(discrete = TRUE, option = "D") +
  theme_minimal() +
  # facet_wrap(~SITE_TYPE, ncol = 1) +
  facet_grid(SPECIES_CODE~SITE_TYPE) +
  labs(x = "Max height (cm)", y = "Year", caption = "Line intercept data")


```


```{r, eval=FALSE, fig.height=9, fig.width=8}

csv.all.lc.li.df %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  group_by(yr, SPECIES_CODE) %>% 
  summarise_if(is.numeric, median, na.rm = TRUE) %>% 
  ungroup() %>% 
  mutate(yr = as.character(yr)) %>% 
  mutate(yr = as.numeric(yr)) %>%
  ggplot(aes(x = yr, y = MAX_HEIGHT_CM)) +
  geom_point(aes(color = SPECIES_CODE))  +
  geom_line(aes(color = SPECIES_CODE))# +
  # geom_smooth(aes(color = SPECIES_CODE))

### Max shrub height

csv.all.lc.li.df %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  # names() %>% 
  # group_by(yr,SITE_TYPE, SPECIES_CODE, MAX_HEIGHT_CM) %>%
  # summarise(mean.max.ht = mean(MAX_HEIGHT_CM,na.rm=TRUE)) %>% 
  ggplot(aes(yr, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill=SITE_TYPE), color = 'black') +
  scale_fill_viridis(discrete = TRUE) +
  # theme_minimal() +
  theme_minimal() +
  labs(title = "Maximum shrub height by year, species and Site Type", x = "Year", y = "Species")+
  facet_wrap(~SPECIES_CODE, ncol = 3)# %>%
  # facet_grid(SPECIES_CODE~yr, scales = "free_x")

```



```{r}

csv.all.lc.li.df %>% 
  filter(!is.na(FENCED)) %>%
  filter(FENCED != "Y_but_fence_down_since_2013") %>%
  filter(yr != "2015" & yr != "2009" & yr != "" & yr != "2017") %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  filter(SITE_TYPE == "WC") %>% 
  ggplot(aes(yr, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill=FENCED), color = 'black') +
  # scale_fill_viridis(discrete = TRUE) +
  # theme_minimal() +
  theme_minimal() +
  labs(title = "Maximum shrub height by year, species and fencing", x = "Year", y = "Species")+
  # facet_wrap(~SPECIES_CODE, ncol = 3) %>%
  facet_grid(SPECIES_CODE~yr, scales = "free_x")

```

> Make assumption that "NA" for fenced is not fenced?

#### Core winter range: fenced vs unfenced
```{r}
## all willow spp  
csv.all.lc.li.df %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>% 
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  # filter(FENCED == "N" | FENCED == "Y") %>% 
  # filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  filter(SITE_TYPE == "WC") %>% 
  ggplot(aes(yr, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill=FENCED), color = 'black', outlier.shape = NA) +
  # scale_fill_viridis(discrete = TRUE) +
  # theme_minimal() +
  theme_minimal() +
  ylim(0, 350) +
  scale_fill_manual(values = c("ivory2","lightblue")) +
  labs(x = "", y = "Max height (cm)", fill = "", title = "Core Winter Range Plots: All Willow Species", caption = "Line intercept data")
  # labs(title = "Salix monticola maximum shrub height by year, fencing", x = "Year", y = "Species")

# ggsave("./output/figures/WC_all_willow_boxplot01.png", width = 6, height = 4.5, dpi= 300)

```

```{r, eval=TRUE}
## salix monitcola
csv.all.lc.li.df %>%
  filter(pType == "willow") %>% 
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(FENCED == "N" | FENCED == "Y") %>% 
  # filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  # filter(SPECIES_CODE !="SAXX") %>% 
  filter(SPECIES_CODE =="SAMO") %>% 
  # distinct(SPECIES_CODE)
  filter(SITE_TYPE == "WC") %>% 
  ggplot(aes(yr, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill=FENCED), color = 'black', outlier.shape = NA) +
  scale_fill_viridis(discrete = TRUE) +
  # theme_minimal() +
  theme_minimal() +
  ylim(0,320) +
  scale_fill_manual(values = c("ivory2","lightgreen")) +
  labs(x = "Year", y = "Max height (cm)", fill = "Fenced") +
  labs(x = "Year", y = "Max height (cm)", fill = "Fenced?", title = "Core Winter Range Plots: SAMO only", caption = "Line intercept data")
  # labs(title = "Salix monticola maximum shrub height by year, fencing", x = "Year", y = "Species")

# ggsave("./output/figures/WC_willLI_SAMO_bxplt01.png", width = 6, height = 4.5, dpi= 300)

```

```{r}

## all shrub species
csv.all.lc.li.df %>%
  filter(pType == "willow") %>% 
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  # filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(FENCED == "N" | FENCED == "Y") %>% 
  # filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  # filter(SPECIES_CODE !="SAXX") %>% 
  # filter(SPECIES_CODE =="SAMO") %>% 
  # distinct(SPECIES_CODE)
  filter(SITE_TYPE == "WC") %>% 
  ggplot(aes(yr, MAX_HEIGHT_CM)) +
  geom_boxplot(aes(fill=FENCED), color = 'black', outlier.shape = NA) +
  scale_fill_viridis(discrete = TRUE) +
  # theme_minimal() +
  theme_minimal() +
  ylim(0,320) +
  scale_fill_manual(values = c("ivory2","slategray")) +
  # labs(x = "Year", y = "Max height (cm)", fill = "Fenced?") +
  labs(x = "Year", y = "Max height (cm)", fill = "Fenced?", title = "Core Winter Range Plots: All Shrub Species", caption = "Line intercept data")
  # labs(title = "Salix monticola maximum shrub height by year, fencing", x = "Year", y = "Species")

# ggsave("./output/figures/WC_willLI_allShrubSpp_bxplt01.png", width = 6, height = 4.5, dpi= 300)

```

```{r}
csv.all.lc.li.df %>%
  filter(pType == "willow") %>% 
  filter(SPECIES_CODE != "SAXX") %>% 
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  # filter(str_detect(SPECIES_CODE, "^SA")) %>%
  filter(FENCED == "Unfenced" | FENCED == "Fenced") %>% 
  group_by(yr, SPECIES_CODE, FENCED) %>% 
  # summarise(mean.ht = mean(MAX_HEIGHT_CM, na.rm = TRUE), sd.ht = sd(MAX_HEIGHT_CM, na.rm = TRUE)) %>%
  summarise(mean.ht = mean(MAX_HEIGHT_CM, na.rm = TRUE)) %>% 
  pivot_wider(names_from = yr, values_from = c(mean.ht)) %>% 
  gt::gt() %>% 
  fmt_number(
    columns = vars('2008','2013','2018'),
    decimals = 1,
    use_seps = FALSE
  ) %>% 
  tab_header("Mean height by shrub species")

```



```{r}

csv.all.lc.li.df %>%
  filter(pType == "willow") %>% 
  filter(SPECIES_CODE != "SAXX") %>% 
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  filter(FENCED == "Unfenced" | FENCED == "Fenced") %>% 
  group_by(yr, FENCED) %>% 
  summarise(mean.ht = mean(MAX_HEIGHT_CM, na.rm = TRUE), sd.ht = sd(MAX_HEIGHT_CM, na.rm = TRUE)) %>% 
  pivot_wider(names_from = yr, values_from = c(mean.ht,sd.ht)) %>% 
  select(contains("2008"),contains("2013"), contains("2018")) %>% 
  gt::gt() %>% 
  fmt_number(
    columns = vars("mean.ht_2008","mean.ht_2013","mean.ht_2018","sd.ht_2008","sd.ht_2013", "sd.ht_2018"),
    decimals = 1,
    use_seps = FALSE
  ) %>% 
  tab_header("Mean height (cm) by all willow species, line intercept")

```


```{r, eval=FALSE}
# Maximum Core winter range sites, maximum shrub height by species, fencing treatment, and year in line interecept dataset.**

csv.all.lc.li.df %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(FENCED == "Unfenced" | FENCED == "Fenced") %>% 
  # filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  filter(SITE_TYPE == "WC") %>% 
  group_by(SPECIES_CODE,yr,FENCED) %>% 
  dplyr::summarise(mean.max.ht = mean(MAX_HEIGHT_CM, na.rm = TRUE)) %>%
  ungroup() %>% 
  mutate(yr = as.character(yr)) %>% 
  mutate(yr = anytime::anytime(yr)) %>% 
  ggplot(aes(x = yr, y = mean.max.ht)) +
  geom_smooth(aes(color = FENCED), method = "lm", se = FALSE, alpha = .5) +
  geom_point(aes(color = FENCED)) +
  scale_shape_manual(values = c(21,24)) + 
  scale_color_manual(values = c("blue", "black")) +
  theme_minimal() +
  labs(caption = "Core winter range sites: maximum shrub height by year, fencing", x = "Year", y = "Height  (cm)", color = "") +
  facet_wrap(~SPECIES_CODE, ncol = 2)

```

```{r, eval = FALSE}
# **Core winter range sites, maximum shrub height by species, fencing treatment, and year in line interecept dataset.** 

csv.all.lc.li.df %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  filter(FENCED == "Unfenced" | FENCED == "Fenced") %>% 
  filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER" | SPECIES_CODE !="ACGL" | SPECIES_CODE !="RUID") %>%
  filter(SITE_TYPE == "WC") %>%
  group_by(yr,FENCED, SPECIES_CODE) %>% 
  dplyr::summarise(mean.max.ht = mean(MAX_HEIGHT_CM, na.rm = TRUE), sd.max.ht = sd(MAX_HEIGHT_CM, na.rm=TRUE)) %>%
  ungroup() %>% 
  group_by(SPECIES_CODE) %>% 
  mutate(n.sp = n()) %>% 
  filter(n.sp > 5) %>% 
  ungroup() %>% 
  mutate(yr = as.character(yr)) %>% 
  mutate(yr = anytime::anytime(yr)) %>% 
  # mutate(yr = as.integer(yr)) %>% 
  ggplot(aes(x = yr, y = mean.max.ht)) +
  # geom_line(aes(color = FENCED)) +
  geom_smooth(aes(color = FENCED), method = "lm", se = FALSE) +
  geom_errorbar(aes(ymin = mean.max.ht - sd.max.ht, ymax = mean.max.ht + sd.max.ht, color = FENCED)) +
  geom_point(aes(color = FENCED),position="dodge") +
  theme_minimal() +
  labs(title = "Core winter range sites: maximum shrub height by year, fencing", x = "Year", y = "Height (cm)", subtitle = "Error bars represent +/- 1 SD, Trend line is a LM fit. Note scale of y axis varies between panels.") +
  facet_wrap(~SPECIES_CODE, ncol = 2, scales= 'free')

```

```{r, eval=TRUE}
## reclass the burned NA
csv.all.lc.li.df <- csv.all.lc.li.df %>% 
  mutate(BURNED = case_when(is.na(BURNED) ~ "Unburned",
                            TRUE ~ as.character(BURNED)))

csv.all.lc.li.df %>% 
  filter(BURNED != "BURNED") %>%
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  filter(SPECIES_CODE != "SAXX") %>%
  filter(yr == 2008 | yr == 2009 | yr == 2013 | yr == 2018) %>%
  filter(FENCED == "Unfenced" | FENCED == "Fenced") %>% 
  # filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  filter(SITE_TYPE == "WC") %>%
  # distinct(SPECIES_CODE) %>% 
  mutate(yr = as.character(yr)) %>% 
  mutate(yr = anytime::anytime(yr)) %>% 
  # mutate(yr = as.integer(yr)) %>% 
  ggplot(aes(x = yr, y = MAX_HEIGHT_CM)) +
  # geom_smooth(aes(color = FENCED), se = FALSE) +
  geom_smooth(aes(color = FENCED), method = "lm", se = FALSE) +
  geom_jitter(aes(color = FENCED, shape = FENCED)) +
  scale_shape_manual(values = c(21,24)) + 
  scale_color_manual(values = c("blue", "black")) +
  theme_minimal() +
  # scale_fill_manual(values = c("ivory2","lightblue")) +
  labs(title = "Core winter range sites: maximum shrub height by year, fencing", x = "Year", color = "", shape = "", y = "Height (cm)", caption = "SAMO,SAPL, SAGE, SABE,SADR,SAPE,SAER")  +
  facet_wrap(~BURNED)

# ggsave("./output/figures/WC_Li_burned_v_unburned.png", width = 6.5, height = 4.5, dpi=300)

```

```{r}
## Core winter range sites: maximum shrub height by year, fencing -- point plot with LM trend line

csv.all.lc.li.df %>% 
  filter(BURNED != "BURNED") %>% 
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  # filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  filter(FENCED == "Unfenced" | FENCED == "Fenced") %>% 
  filter(SPECIES_CODE != "SAXX") %>% 
  # filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  filter(SITE_TYPE == "WC") %>%
  mutate(yr = as.character(yr)) %>% 
  mutate(yr = anytime::anytime(yr)) %>% 
  ggplot(aes(x = yr, y = MAX_HEIGHT_CM)) +
  geom_smooth(aes(color = FENCED, lty = FENCED), method = "lm", se = FALSE) +
  # geom_point(aes(color = FENCED, shape = FENCED)) +
  geom_jitter(aes(color = FENCED, shape = FENCED)) +
  scale_color_manual(values = c("blue", "black")) +
  scale_shape_manual(values = c(21,24)) +
  theme_minimal() +
  labs(title = "Core winter range sites: maximum shrub height by year, fencing", x = "Year", color = "", shape = "", y = "Height (cm)", lty = "", caption = "SAMO,SAPL, SAGE, SABE,SADR,SAPE,SAER") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r, eval=TRUE}
# burned faceted
csv.all.lc.li.df %>% 
  filter(BURNED != "BURNED") %>%
  filter(!is.na(MAX_HEIGHT_CM)) %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  filter(SPECIES_CODE != "SAXX") %>%
  filter(yr == 2008 | yr == 2009 | yr == 2013 | yr == 2018) %>%
  filter(FENCED == "Unfenced" | FENCED == "Fenced") %>% 
  # filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SAER") %>%
  filter(SITE_TYPE == "WC") %>%
  mutate(yr = as.character(yr)) %>% 
  mutate(yr = anytime::anytime(yr)) %>% 
  # mutate(yr = as.integer(yr)) %>% 
  ggplot(aes(x = yr, y = MAX_HEIGHT_CM)) +
  # geom_smooth(aes(color = FENCED), se = FALSE) +
  geom_smooth(aes(color = FENCED, lty = FENCED), method = "lm", se = FALSE) +
  # geom_point(aes(color = FENCED, shape = FENCED)) +
  geom_jitter(aes(color = FENCED, shape = FENCED)) +
  scale_shape_manual(values = c(21,24)) + 
  scale_color_manual(values = c("blue", "black")) +
  theme_minimal() +
  labs(title = "Core winter range: maximum shrub height, fencing, burning", x = "Year", color = "", shape = "", lty = "", y = "Height (cm)", caption = "Pooled SAMO,SAPL, SAGE, SABE,SADR,SAPE,SAER")  +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(~BURNED)

```


# Willow macroplot data

## Data munging 
```{r}
# calculate the average canopy diameter
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(CANOPY_DIAM_AVG = (CANOPY_DIA_1_CM + CANOPY_DIA_2_CM)/2) 

### canopy diameter by species
mcro.canopy.diam.sum <- csv.all.lc.mcro.df %>%
  group_by(SITE_ID, yr, SPECIES_CODE, FENCED) %>% 
  summarise(cano_diam_med = median(CANOPY_DIAM_AVG)) 
```

```{r}
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(timeClass = case_when(yr == 2008 ~ "BL",
                              yr == 2009 ~ "BL", 
                              TRUE ~ as.character(yr))) %>% 
  mutate(timeClass = as.factor(timeClass)) %>% 
  mutate(timeClass = fct_relevel(timeClass, "2018", "2013", "BL"))

```

```{r}
## cleaning the LOCATION tab
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>%
  mutate(LOCATION = case_when(is.na(LOCATION) & SITE_TYPE == "WK" ~ "Kawuneeche",
                              TRUE ~ LOCATION))%>%
  mutate(LOCATION = str_replace(LOCATION, "_", " ")) %>%
  mutate(LOCATION = str_replace(LOCATION, "_", " ")) 
```


```{r}
#**Note: WC5,6,7,8,11,33 are listed as "removed" so are eliminated**

## clean
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  filter(!SITE_ID %in% c("WC05","WC06","WC07","WC08","WC11","WC33"))

```

----


```{r}

csv.all.lc.mcro %>% 
  unnest(field_names) %>% 
  distinct(file_name_abr,field_names) %>% 
  # write_csv("output/temp_4_review/macroplot_fld_names.csv")
  datatable(rownames = FALSE, caption = "Macroplot inventory variable names.")

```

## Canopy cover

```{r, eval=TRUE}
## 
# Canopy diameter measurements from macroplots. Calculated as the mean of CANOPY_DIA_1_CM + CANOPY_DIA_2_CM. 

## average the canopy
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(CANOPY_DIA_CM_avg = (CANOPY_DIA_1_CM + CANOPY_DIA_2_CM)/2)

## clean up
csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(FENCED = case_when(FENCED == "Y_but_fence_down_since_2013" ~ "Unfenced",
                             FENCED == "Y" ~ "Fenced",
                             FENCED == "N" ~ "Unfenced")) 

# quick check
# csv.all.lc.mcro.df %>% tabyl(FENCED)
# csv.all.lc.mcro.df %>% tabyl(BURNED)

csv.all.lc.mcro.df <- csv.all.lc.mcro.df %>% 
  mutate(BURNED = case_when(BURNED == "Unburned" ~ "Unburned",
                            BURNED == "N Y" ~ "Unburned",
                            BURNED == "Completely" ~ "Burned",
                            BURNED == "Moderately" ~ "Burned",
                            BURNED == "Moderately to Completely" ~ "Burned",
                            BURNED == "Y" ~ "Burned",
                            BURNED == "N" ~ "Unburned",
                            BURNED == "Not burned" ~ "Unburned",
                            is.na(BURNED) ~ "Unburned",
                            TRUE ~ BURNED))
```

```{r}
#### Calculate cover
canopy.all.spp <- csv.all.lc.mcro.df %>%
  mutate(PERCENT_PLANT_IN_PLOT = as.numeric(PERCENT_PLANT_IN_PLOT)/100) %>% 
  mutate(PERCENT_PLANT_IN_PLOT = case_when(is.na(PERCENT_PLANT_IN_PLOT) ~ 1,
         TRUE ~ PERCENT_PLANT_IN_PLOT)) %>%
  mutate(PERCENT_PLANT_IN_PLOT = case_when(PERCENT_PLANT_IN_PLOT == 1.45 ~ .145,
         TRUE ~ PERCENT_PLANT_IN_PLOT)) %>% # correct error in raw data
  # mutate(cano.area.m2 = PERCENT_PLANT_IN_PLOT   * (CANOPY_DIA_CM_avg/2)^2 * 3.141593 * 0.0001) %>% 
  mutate(cano.area.m2 = ((((CANOPY_DIA_1_CM/100)*(CANOPY_DIA_2_CM/100)*3.141593)/4) * PERCENT_PLANT_IN_PLOT)) # this is how LZ calculated cover in the SAS 2013 code update. Slightly different estimates than method used in previous. For consistency, using LZ formula 

canopy.all.spp %>% 
  tabyl(FENCED)





canopy.all.spp <- canopy.all.spp %>% 
  mutate(cover.plant = cano.area.m2/16 * 100) %>% 
  mutate(cover.plant = case_when(cover.plant > 100 ~ 100,
                           TRUE ~ cover.plant))

## sum by species and calculate cover
canopy.all.spp.sum <- canopy.all.spp %>%
  group_by(timeClass, SITE_ID, SPECIES_CODE, SITE_TYPE, LOCATION, FENCED, BURNED) %>% 
  dplyr::summarise(cano.sppsum.m2 = sum(cano.area.m2)) %>% 
  mutate(cover.spp = cano.sppsum.m2/16*100) %>% 
  mutate(cover.spp = case_when(cover.spp > 100 ~ 100,
                               TRUE ~ cover.spp)) %>% 
  ungroup()

### calculate the sum and % cover for all willows combined
canopy.all.willow.sum <- canopy.all.spp %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  group_by(timeClass, SITE_ID, SITE_TYPE, LOCATION, FENCED, BURNED) %>% 
  dplyr::summarise(cano.sum.m2 = sum(cano.area.m2), cano.mean.m2 = mean(cano.area.m2)) %>% 
  mutate(cover.allwillow.mn = cano.mean.m2/16*100) %>% 
  mutate(cover.allwillow = cano.sum.m2/16*100) %>% 
  mutate(cover.allwillow = case_when(cover.allwillow > 100 ~ 100,
                               TRUE ~ cover.allwillow)) %>% 
  ungroup()

```

```{r}
## write to csv
# canopy.all.willow.sum %>%
#   write_csv("./output/exported_data/willow_cover_20200725.csv")

```

```{r, echo = FALSE, eval=FALSE}
canopy.all.willow.sum.sf <- left_join(canopy.all.willow.sum, site.id.coords) %>%
  filter(!is.na(UTM_E_NAD83)) # %>% 
  # pivot_wider(values_from = cover.allwillow, names_from = timeClass, names_glue = "{.value}_{timeClass}")
  
canopy.all.willow.sum.sf <- canopy.all.willow.sum.sf %>% 
  st_as_sf(coords = c("UTM_E_NAD83", "UTM_N_NAD83"), crs = 26913) 

wide2join.cov.willow <- left_join(canopy.all.willow.sum, site.id.coords) %>%
  # filter(!is.na(UTM_E_NAD83)) %>% 
  pivot_wider(values_from = cover.allwillow, names_from = timeClass, names_glue = "{.value}_{timeClass}")

```

###  All willow species

**Combined WC and WNC** 

```{r}
#### Winter range weighted average
## exluding WK, WC and WNC
canopy.all.willow.sum %>% 
  mutate(cover.allwillow = case_when(is.na(cover.allwillow) ~ 0,
                                     TRUE ~ cover.allwillow)) %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%   group_by(SITE_TYPE, LOCATION, timeClass) %>% 
  summarise(n.loc.tc = n(), mean.cov = mean(cover.allwillow, na.rm = TRUE, mean.cov.mn = mean(cover.allwillow.mn, na.rm = TRUE))) %>% 
  ungroup() %>% 
  group_by(SITE_TYPE, timeClass) %>% 
  mutate(n.tc = sum(n.loc.tc)) %>% 
  ungroup()

canopy.all.willow.sum %>% 
  # filter(BURNED == "N") %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  group_by(timeClass) %>% 
  summarise(mean.will.cov = mean(cover.allwillow, na.rm = TRUE), 
            sd.will.cov  = sd(cover.allwillow, na.rm = TRUE), 
            med.will.cov = median(cover.allwillow, na.rm = TRUE), 
            mean.cov.mn = mean(cover.allwillow.mn, na.rm = TRUE)) %>% 
  gt()

canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  group_by(SITE_TYPE, timeClass) %>% 
  summarise(mean.will.cov = mean(cover.allwillow, na.rm = TRUE), sd.will.cov  = sd(cover.allwillow, na.rm = TRUE), med.will.cov = median(cover.allwillow, na.rm = TRUE), n.obs = n()) %>% 
  gt()

```

```{r}
wc.cov.pl1 <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  ggplot(aes(timeClass,cover.allwillow)) +
  geom_boxplot(fill = "grey60") +
  geom_hline(aes(yintercept = 31), color = "red", lty = "dashed", size = 1) +
  labs(x = "", y = "% cover", caption = "All elk range - Combined WC and WNC plots") +
  theme_minimal()

wc.cov.pl1
# ggsave("./output/figures_exported/All_winter_range_willow_cov_boxplot.png", width = 3.75, height = 3.75)

wc.cov.pl2 <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  ggplot(aes(timeClass,cover.allwillow)) +
  geom_boxplot(aes(fill = SITE_TYPE)) +
  scale_fill_manual(values = c("grey90", "grey40")) +
  geom_hline(aes(yintercept = 31), color = "red", lty = "dashed", size = 1) +
  labs(fill = "", x = "", y = "% cover", caption = "All elk range - Combined WC and WNC plots") +
  theme_minimal()
wc.cov.pl2
# ggsave("./output/figures_exported/All_winter_range_willow_cov_boxplot_b.png", width = 4.5, height = 3.75)

cowplot::plot_grid(wc.cov.pl1, wc.cov.pl2, labels = "AUTO",rel_widths = c(1, 2))

# ggsave("./output/figures_exported/All_winter_range_willow_cov_boxplot_2panel_revised.png", width = 6.5, height = 3.75)
```


```{r}
##### summary tables for cover
# pooled across range types, fenced, burned
## Time class FENCED SITE_TYPE
summary.TC <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass) %>% 
  summarytools::descr(var = cover.allwillow,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass) %>% 
  gt() %>% 
  tab_header(title = "Willow cover - All species, range types, and fenced/burned status")

summary.TC 

```


```{r}
## Time class FENCED SITE_TYPE
summary.TC.site_type <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, SITE_TYPE) %>% 
  summarytools::descr(var = cover.allwillow,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, 'Site type' = SITE_TYPE) %>% 
  gt() %>% 
  tab_header(title = "Willow cover - All species and fenced status")

summary.TC.site_type 

# summary.TC.site_type %>% 
#   gt::gtsave(file = "./output/tables/summary_cover_all_willow_TCxSITE_Type.rtf")

```


```{r}
## Time class FENCED SITE_TYPE
summary.TC.fenced.site_type <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass,FENCED, SITE_TYPE) %>% 
  summarytools::descr(var = cover.allwillow,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, Fenced = FENCED, 'Site type' = SITE_TYPE) %>% 
  gt() %>% 
  tab_header(title = "Willow cover - All species")

summary.TC.fenced.site_type 

# summary.TC.fenced.site_type %>%
#   gt::gtsave(file = "./output/tables/summary_cover_all_willow.rtf")
  
```

```{r}
## fenced and burned, all range type
##### summary tables for cover
# pooled across range types, fenced, burned
## Time class FENCED SITE_TYPE
summary.TC.burned.fenced <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, FENCED, BURNED) %>% 
  summarytools::descr(var = cover.allwillow,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, Fenced = FENCED, Burned = BURNED, n = n.valid) %>% 
  gt() %>% 
  tab_header(title = "Willow cover - All species, range types, and fenced/burned status")

summary.TC.burned.fenced 

# summary.TC.burned.fenced %>%
#   gt::gtsave(file = "./output/tables/summary_cover_allwillow_allRT_fenced_burned.rtf")


canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, BURNED) %>% 
  summarytools::descr(var = cover.allwillow,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  datatable()

```


```{r}
## burned and fenced: separated by range type 
##### summary tables for cover
# pooled across range types, fenced, burned
## Time class FENCED SITE_TYPE
summary.TC.burned.fenced.rangetype <- canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, SITE_TYPE, FENCED, BURNED) %>% 
  summarytools::descr(var = cover.allwillow,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, Fenced = FENCED, Burned = BURNED, n = n.valid) %>% 
  gt() %>% 
  tab_header(title = "Willow cover - All species, grouped by range type, fencing and burning")

summary.TC.burned.fenced.rangetype

# summary.TC.burned.fenced %>%
#   gt::gtsave(file = "./output/tables/summary_cover_allwillow_allRT_fenced_burned.rtf")

# data table
canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, SITE_TYPE, FENCED, BURNED) %>% 
  summarytools::descr(var = cover.allwillow,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>%
  datatable()


```


```{r, eval=FALSE}
## gtsummary
canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  # mutate(timeClass = as.character(timeClass)) %>%
  select(timeClass, SITE_TYPE, FENCED, cover.allwillow) %>% 
  gtsummary::tbl_summary(
    by = timeClass,
    include = c(timeClass,cover.allwillow)) %>% 
  add_p()

canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  # mutate(timeClass = fct_rev(timeClass)) %>% 
  mutate(timeClass = as.character(timeClass)) %>%
  select(timeClass, SITE_TYPE, FENCED, cover.allwillow) %>%
  gtsummary::tbl_summary(
    by = timeClass,
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} / {N} ({p}%)"))

canopy.all.willow.sum %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  # mutate(timeClass = fct_rev(timeClass)) %>% 
  mutate(timeClass = as.character(timeClass)) %>%
  select(timeClass, SITE_TYPE, FENCED, cover.allwillow) %>%
  gtsummary::tbl_summary(
    by = timeClass,
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} / {N} ({p}%)"))

```

```{r}
#### # check te lz weighting

## exluding WK
canopy.all.willow.sum %>% 
  mutate(cover.allwillow = case_when(is.na(cover.allwillow) ~ 0,
                                     TRUE ~ cover.allwillow)) %>% 
  filter(SITE_TYPE == "WC" | SITE_TYPE == "WNC") %>%   group_by(BURNED, FENCED, timeClass) %>% 
  summarise(n.cond.tc = n(), mean.cov = mean(cover.allwillow, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(timeClass) %>% 
  mutate(n.tc = sum(n.cond.tc)) %>% 
  ungroup() %>% 
  mutate(weight = n.cond.tc/n.tc) %>% 
  mutate(mean.cov.wt = weight*mean.cov) %>% 
  datatable()

```



**WC**
```{r}
canopy.all.willow.sum %>% 
  group_by(timeClass, SITE_TYPE) %>% 
  descr(cover.allwillow) %>% 
  summarytools::tb() %>% 
  datatable(filter = "top")

## Filter to just 5 yr resample and WC
canopy.all.willow.sum %>% 
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  filter(SITE_TYPE == "WC") %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  ggplot(aes(timeClass, cover.allwillow)) +
  geom_boxplot(fill = "grey60") +
  geom_hline(aes(yintercept = 31), color = "red", lty = "dashed", size = 1) +
  facet_wrap(~FENCED) +
  labs(caption = "WC all willows combined macroplot cover", y = "% cover", x = "") +
  theme_minimal()

ggsave("./output/figures_exported/cover_wc_boxplot_TCxF_dfc.png", width = 6.25, height = 3.75, dpi =300)

## create summary table
canopy.all.willow.sum %>% 
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  filter(SITE_TYPE == "WC") %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  group_by(timeClass, SITE_TYPE, FENCED) %>% 
  summarytools::descr(cover.allwillow) %>% 
  summarytools::tb() %>%
  mutate(across(where(is.numeric),~round(.x, 1))) %>% 
  select(1,3,5:13, n.valid) %>% 
  gt()

```

```{r}
## WNC
## Filter to just 5 yr resample and WNC
canopy.all.willow.sum %>% 
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  filter(SITE_TYPE == "WNC") %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  ggplot(aes(timeClass, cover.allwillow)) +
  geom_boxplot(fill = "grey60") +
  geom_hline(aes(yintercept = 31), color = "red", lty = "dashed", size = 1) +
  # facet_wrap(~FENCED) +
  labs(caption = "WNC all willows combined macroplot cover", y = "% cover", x = "") +
  theme_minimal()

# ggsave("./output/figures_exported/cover_wnc_boxplot01_revised.png", width = 3.75, height = 3.75, dpi=300)
# ggsave("./output/figures_exported/cover_wnc_boxplot01.pdf", width = 3.75, height = 3.75)

## create summary table
canopy.all.willow.sum %>% 
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  filter(SITE_TYPE == "WNC") %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  group_by(timeClass, SITE_TYPE, FENCED) %>% 
  summarytools::descr(cover.allwillow) %>% 
  summarytools::tb() %>% 
  mutate(across(where(is.numeric),~round(.x, 1))) %>%
  select(1,3,5:13, n.valid) %>% 
  gt() %>% 
  tab_header(title = "Non-core range willow cover")

```

```{r}
# join cover for spatial export
canopy.all.willow.sum.wide <- canopy.all.willow.sum %>% 
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  clean_names() %>% 
  select(time_class, site_id, site_type, location, cover_allwillow) %>% 
  pivot_wider(names_from = time_class, names_glue = "cover{time_class}",values_from = cover_allwillow)


cov.willow.sf <- left_join(clean_names(site.info.clean.sf), canopy.all.willow.sum.wide, by = "site_id") %>%
  filter(p_type == "willow")

# cov.willow.sf %>%
#   st_write("./output/exported_data/spatial/willow_cover_20200907.shp")

cov.willow.sf %>%
  filter(!is.na(cover2018)) %>% 
  mapview(zcol= "cover2018")

```

#### 2018 cover map
```{r}
cov.willow.sf %>%
  filter(!is.na(cover2018)) %>% 
  mapview(zcol= "cover2018")
```

#### cover thresholds

**Cover thresholds: winter range, TC**
```{r}
canopy.all.willow.sum %>%
  clean_names() %>% 
  filter(!is.na(cover_allwillow)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # tabyl(species_code)
  filter(site_type != "WK") %>%
  mutate(thresh = case_when(cover_allwillow >=31 ~ "above",
                               cover_allwillow <31 ~ "below")) %>%  
  tabyl(time_class, thresh) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC - cover threshold of 31%")

```

**Cover thresholds: winter range, TC x Fenced**
```{r}
canopy.all.willow.sum %>%
  clean_names() %>% 
  filter(!is.na(cover_allwillow)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # tabyl(species_code)
  filter(site_type != "WK") %>%
  mutate(thresh = case_when(cover_allwillow >=31 ~ "above",
                               cover_allwillow <31 ~ "below")) %>%
  group_by(time_class, thresh, fenced) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = thresh, values_from = n) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC - cover threshold of 31%")
```

**Cover thresholds: winter range, TC x burned**

```{r}
canopy.all.willow.sum %>%
  clean_names() %>% 
  filter(!is.na(cover_allwillow)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # tabyl(species_code)
  filter(site_type != "WK") %>%
  mutate(thresh = case_when(cover_allwillow >=31 ~ "above",
                               cover_allwillow <31 ~ "below")) %>%
  group_by(time_class, thresh, burned) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = thresh, values_from = n) %>%
  replace_na(list(above = 0, below = 0)) %>%
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC - cover threshold of 31%")

```


**Cover thresholds: winter range, TC x fenced x burned**

```{r}
canopy.all.willow.sum %>%
  clean_names() %>% 
  filter(!is.na(cover_allwillow)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # tabyl(species_code)
  filter(site_type != "WK") %>%
  mutate(thresh = case_when(cover_allwillow >=31 ~ "above",
                               cover_allwillow <31 ~ "below")) %>%
  group_by(time_class, thresh, fenced, burned) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = thresh, values_from = n) %>% 
  replace_na(list(above = 0, below = 0)) %>%
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC - cover threshold of 31%")
```

```{r}
canopy.all.willow.sum %>%
  clean_names() %>% 
  filter(!is.na(cover_allwillow)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  mutate(time_class = fct_rev(time_class)) %>%
  filter(site_type != "WK") %>%
  mutate(thresh = case_when(cover_allwillow >=31 ~ "above",
                               cover_allwillow <31 ~ "below")) %>%
  group_by(time_class, thresh, fenced, burned) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = thresh, values_from = n) %>% 
  # replace_na(list(above = 0, below = 0)) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  ggplot(aes(x = fenced, y = burned)) +
  geom_tile(aes(fill = perc.above.thresh), color = 'white') +
  scale_fill_viridis_b() +
  geom_text(aes(label = round(perc.above.thresh,1)), color = "white") +
  theme_minimal() +
  labs(x = "", y = "", fill = "% above \n threshold") +
  facet_grid(~time_class)

ggsave("./output/figures_exported/WCWNC_willow_percentPlotCovThresh_dfc.png", width = 5.5, height = 2.25)
```


## Height: All shrub species


```{r}
### gt desc tables
### gt summary table
# all winter range combined (-WK)
ht.WCWNC.allShrub.plotsummary <- csv.all.lc.mcro.df %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(SITE_TYPE == "WC" |SITE_TYPE == "WNC") %>% 
  # filter(str_detect(SPECIES_CODE, "^SA")) %>%
  select(timeClass, SITE_ID, PLANT_HT_CM) %>% 
  group_by(timeClass,SITE_ID) %>% 
  summarise(PLANT_HT_CM_mean = mean(PLANT_HT_CM, na.rm=TRUE), PLANT_HT_CM_max = max(PLANT_HT_CM),PLANT_HT_CM_median = median(PLANT_HT_CM)) %>%
  ungroup()
  

ht.WCWNC.allShrub.plotsummary %>% 
  group_by(timeClass) %>% 
  summarytools::descr(var = PLANT_HT_CM_median, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, 'Time class' = timeClass) %>%   
  gt() %>% 
  tab_header(title = "Willow height (median per plot, macroplot), all shrub spp") %>% 
  fmt_number(
    columns = 2:11,
    decimals = 1,
    suffixing = TRUE
  ) # %>% 
  # gtsave("./output/tables/Mcplot_allshrubHT_WCandWNC_TC.rtf")

```

```{r}
# all winter range combined (-WK)
ht.WCWNC.allShrub.fenced.plotsummary <- csv.all.lc.mcro.df %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(SITE_TYPE == "WC" |SITE_TYPE == "WNC") %>% 
  # filter(str_detect(SPECIES_CODE, "^SA")) %>%
  select(timeClass, SITE_ID, PLANT_HT_CM, FENCED) %>% 
  group_by(timeClass,SITE_ID, FENCED) %>% 
  summarise(PLANT_HT_CM_mean = mean(PLANT_HT_CM, na.rm=TRUE), PLANT_HT_CM_max = max(PLANT_HT_CM),PLANT_HT_CM_median = median(PLANT_HT_CM)) %>%
  ungroup()
  

ht.WCWNC.allShrub.fenced.plotsummary %>% 
  group_by(timeClass, FENCED) %>% 
  summarytools::descr(var = PLANT_HT_CM_median, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, 'Time class' = timeClass, Fenced = FENCED) %>%   
  gt() %>% 
  tab_header(title = "Willow height (median per plot, macroplot), all shrub spp, WC WNC") %>% 
  fmt_number(
    columns = 4:11,
    decimals = 1,
    suffixing = TRUE
  ) # %>% 
  # gtsave("./output/tables/Mcplot_allshrubHT_WCandWNC_TC_fenced.rtf")

```



```{r}
# all winter range combined (-WK): Fenced
csv.all.lc.mcro.df %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(SITE_TYPE == "WC" |SITE_TYPE == "WNC") %>% 
  # filter(str_detect(SPECIES_CODE, "^SA")) %>%
  group_by(timeClass, FENCED) %>% 
  summarytools::descr(var = PLANT_HT_CM, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid) %>%   
  gt() %>% 
  tab_header(title = "Willow height (macroplot)") %>% 
  fmt_number(
    columns = 3:11,
    decimals = 1,
    suffixing = TRUE
  ) # %>% 
  # gtsave("./output/tables/Mcplot_HT_WCandWNC_TC_fenced.rtf")
```


```{r}
### gt summary table
# all winter range combined (-WK)
## just willow species
ht.WCWNC.willow.plotsummary <- csv.all.lc.mcro.df %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(SITE_TYPE == "WC" |SITE_TYPE == "WNC") %>% 
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  select(timeClass, SITE_ID, PLANT_HT_CM) %>% 
  group_by(timeClass,SITE_ID) %>% 
  summarise(PLANT_HT_CM_mean = mean(PLANT_HT_CM, na.rm=TRUE), PLANT_HT_CM_median = median(PLANT_HT_CM), PLANT_HT_CM_max = max(PLANT_HT_CM)) %>%
  ungroup()
  

ht.WCWNC.willow.plotsummary %>% 
  group_by(timeClass) %>% 
  summarytools::descr(var = PLANT_HT_CM_median, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, 'Time class' = timeClass) %>%   
  gt() %>% 
  tab_header(title = "Willow height (all willow, macroplot)") %>% 
  fmt_number(
    columns = 2:11,
    decimals = 1,
    suffixing = TRUE
  ) # %>% 
  # gtsave("./output/tables/Mcplot_HT_all_willow_WCandWNC_TC.rtf")
```


```{r}
### gt summary table
# all winter range combined (-WK)
ht.WCWNC.willow.fenced.plotsummary <- csv.all.lc.mcro.df %>% 
  mutate(timeClass = fct_rev(timeClass)) %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(SITE_TYPE == "WC" |SITE_TYPE == "WNC") %>% 
  filter(str_detect(SPECIES_CODE, "^SA")) %>%
  select(timeClass, SITE_ID, PLANT_HT_CM, FENCED) %>% 
  group_by(timeClass,SITE_ID, FENCED) %>% 
  summarise(PLANT_HT_CM_mean = mean(PLANT_HT_CM, na.rm=TRUE), PLANT_HT_CM_max = max(PLANT_HT_CM),PLANT_HT_CM_median = median(PLANT_HT_CM, na.rm=TRUE),) %>%
  ungroup()
  

ht.WCWNC.willow.fenced.plotsummary %>% 
  group_by(timeClass, FENCED) %>% 
  summarytools::descr(var = PLANT_HT_CM_median, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, 'Time class' = timeClass) %>%   
  gt() %>% 
  tab_header(title = "Willow height (all willow, macroplot)") %>% 
  fmt_number(
    columns = 4:11,
    decimals = 1,
    suffixing = TRUE
  ) # %>% 
  # gtsave("./output/tables/Mcplot_HT_all_willow_WCandWNC_TC_FENCED_median.rtf")

```


```{r}

csv.all.lc.mcro.df %>% 
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SABO" & SPECIES_CODE !="SAER") %>%
  filter(SITE_TYPE == "WC") %>%
  # filter(SITE_TYPE != "WNC") %>% 
  mutate(yr = as.character(yr)) %>%
  # mutate(yr = as.integer(yr)) %>%
  # mutate(yr = as.character(yr)) %>% 
  # filter(yr == 2013 | yr == 2018) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  group_by(yr,SPECIES_CODE) %>% 
  skimr::skim(PLANT_HT_CM) %>% 
  # names()
  # select(-c(formatted, level)) %>% 
  select(yr, contains("skim"),SPECIES_CODE, contains("c.m"), contains("c.s")) %>%
  select(-skim_type) %>% 
  ggplot(aes(yr, SPECIES_CODE)) +
  geom_tile(aes(fill = numeric.mean)) +
  geom_text(aes(label = round(numeric.mean,1)), color = "white") +
  scale_fill_viridis() +
  theme_minimal() +
  labs(x = "Year", y = "Species", fill = "mean", title = "Mean Height - Core Range", subtitle = "Macroplot data")

```

```{r}
csv.all.lc.mcro.df %>% 
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  filter(SPECIES_CODE !="SAPE" & SPECIES_CODE !="SAWO" & SPECIES_CODE !="SAXX" & SPECIES_CODE !="SALUC" & SPECIES_CODE !="SABR" & SPECIES_CODE !="SABO" & SPECIES_CODE !="SAER") %>%
  filter(SITE_TYPE == "WC") %>%
  # filter(SITE_TYPE != "WNC") %>% 
  mutate(yr = as.character(yr)) %>%
  # mutate(yr = as.integer(yr)) %>%
  # mutate(yr = as.character(yr)) %>% 
  # filter(yr == 2013 | yr == 2018) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  group_by(yr,SPECIES_CODE, FENCED) %>% 
  skimr::skim(PLANT_HT_CM) %>% 
  # names()
  # select(-c(formatted, level)) %>% 
  select(yr, contains("skim"),SPECIES_CODE, contains("c.m"), contains("c.s"), FENCED) %>%
  select(-skim_type) %>% 
  ggplot(aes(yr, SPECIES_CODE)) +
  geom_tile(aes(fill = numeric.mean)) +
  geom_text(aes(label = round(numeric.mean,1)), color = "white") +
  scale_fill_viridis() +
  theme_minimal() +
  labs(x = "Year", y = "Species", fill = "mean", title = "Mean Height - Core Range", subtitle = "Fenced/unfenced") +
  facet_wrap(~FENCED)

```


```{r}
#### Count of Observations by Species 

csv.all.lc.mcro.df %>% 
  group_by(SPECIES_CODE) %>%
  tally() %>% 
  arrange(desc(n)) %>% 
  datatable(rownames = FALSE, caption = "Count of observations by shrub species.")

```

```{r, eval=FALSE}
csv.all.lc.mcro.df %>%
  write_csv("./output/exported_data/willow_mcro.csv")

```


```{r}
allshrub.mcro.all <- csv.all.lc.mcro.df %>%
  mutate(yr = as.character(yr)) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  clean_names()

nonwillowshrub.mcro.all <- csv.all.lc.mcro.df %>%
  mutate(yr = as.character(yr)) %>%
  filter(str_detect(SPECIES_CODE, "^SA",negate = TRUE)) %>% 
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  clean_names()

willow.mcro.all <- csv.all.lc.mcro.df %>%
  filter(str_detect(SPECIES_CODE, "^SA")) %>% 
  # filter(SITE_TYPE == "WC") %>%
  # filter(SITE_TYPE != "WNC") %>% 
  mutate(yr = as.character(yr)) %>%
  # mutate(yr = as.integer(yr)) %>%
  # mutate(yr = as.character(yr)) %>% 
  # filter(yr == 2013 | yr == 2018) %>%
  filter(yr == 2008 | yr == 2013 | yr == 2018) %>%
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  clean_names()

```

### Core winter range

```{r}
allshrub.mcro.all %>% 
  filter(site_type == "WC") %>%
  # filter(SITE_TYPE != "WNC") %>% 
  ggplot(aes(time_class, plant_ht_cm)) +
  geom_boxplot(aes(fill = fenced),outlier.shape = NA) +
  scale_fill_manual(values = c("grey80", "grey40")) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  theme_minimal() +
  ylim(0,320) +
  labs(x = "", y = "Shrub height (cm)", fill = "", caption = "macro, WC only, all shrubs")

# ggsave("./output/figures_exported/WC_allshrub_ht_boxplot_dfc.png", width = 5.5, height = 3.5)

nonwillowshrub.mcro.all %>% 
  filter(site_type == "WC") %>%
  # filter(SITE_TYPE != "WNC") %>% 
  ggplot(aes(time_class, plant_ht_cm)) +
  geom_boxplot(aes(fill = fenced),outlier.shape = NA) +
  scale_fill_manual(values = c("grey80", "grey40")) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  theme_minimal() +
  ylim(0,200) +
  labs(x = "", y = "Shrub height (cm)", fill = "", caption = "WC only, allnon willow shrubs")

```

### Mean ht in plots, willow species only

```{r}
# join cover for spatial export
will.ht.mean <- willow.mcro.all %>% 
  mutate(time_class = forcats::fct_rev(time_class)) %>%
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  group_by(site_id, time_class) %>% 
  summarise(plant_ht_cm.mean = mean(plant_ht_cm)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = time_class, names_glue = "htmean{time_class}",values_from = plant_ht_cm.mean) %>% 
  mutate(difBL18 = htmean2018 - htmeanBL) %>% 
  mutate(difBL13 = htmean2018 - htmeanBL) %>% 
  mutate(dif1318 = htmean2018 - htmean2013)

## join
will.ht.mean.sf <- left_join(will.ht.mean, clean_names(site.info.clean.sf)) %>% 
  st_as_sf(sf_column_name = "geometry")

will.ht.mean.sf %>% 
  filter(!is.na(htmean2018)) %>% 
  mapview(zcol = "htmean2018")

# will.ht.mean.sf %>%
#   st_write("./output/exported_data/spatial/willow_htmean_20200907.shp")

```

### Ht difference: 2018 to baseline

WC and WNC
```{r}
will.ht.mean.sf %>%
  as_tibble() %>% 
  filter(!is.na(fenced)) %>% 
  filter(range_type != "Kawuneeche Valley") %>%
  ggplot(aes(fenced, difBL18)) +
  geom_boxplot(outlier.shape = NA, fill = "grey70") +
  geom_hline(yintercept=0, color = "red", lty = "dashed", size=1) +
  ylim(-75,175) +
  theme_minimal() +
  facet_wrap(~range_type) +
  labs(x = "", y = "Height difference (cm)", caption = "mean willow height, all willow spp, 2018-BL")

# ggsave("./output/figures_exported/WC_WNC_HtMeanDiff18BL_TCxfenced_dfc.png", width = 5.5, height = 3.75, dpi = 300)

```

```{r}
## all elk range
will.ht.mean.sf %>%
  as_tibble() %>% 
  filter(!is.na(fenced)) %>% 
  filter(range_type != "Kawuneeche Valley") %>%
  # group_by(fenced, range_type) %>% 
  descr(difBL18) %>% 
  tb() %>%
  select(-c(skewness, se.skewness, kurtosis)) %>% 
  gt() %>% 
  tab_header(title = "Willow ht diff (2018-BL),WC & WNC plots") %>%
  fmt_number(
    columns = 2:11,
    decimals = 1,
    suffixing = TRUE
  )

## all elk range fenced
will.ht.mean.sf %>%
  as_tibble() %>% 
  filter(!is.na(fenced)) %>% 
  filter(range_type != "Kawuneeche Valley") %>%
  group_by(fenced) %>%
  descr(difBL18) %>% 
  tb() %>%
  select(-c(skewness, se.skewness, kurtosis)) %>% 
  gt() %>% 
  tab_header(title = "Willow ht diff (2018-BL),WC & WNC plots") %>%
  fmt_number(
    columns = 3:11,
    decimals = 1,
    suffixing = TRUE
  )


will.ht.mean.sf %>%
  as_tibble() %>% 
  filter(!is.na(fenced)) %>% 
  filter(range_type != "Kawuneeche Valley") %>%
  group_by(fenced, range_type) %>% 
  descr(difBL18) %>% 
  tb() %>%
  select(-c(skewness, se.skewness, kurtosis)) %>% 
  gt() %>% 
  tab_header(title = "Willow ht diff (2018-BL),WC & WNC plots") %>%
  fmt_number(
    columns = 4:11,
    decimals = 1,
    suffixing = TRUE
  ) # %>% 
  # gtsave("./output/tables/WillowHtDif_WCplusWNC.rtf")
```

```{r}
will.ht.mean.sf %>%
  as_tibble() %>% 
  filter(!is.na(burned)) %>% 
  filter(range_type != "Kawuneeche Valley") %>%
  ggplot(aes(burned, difBL18)) +
  geom_boxplot(outlier.shape = NA, fill = "grey70") +
  geom_hline(yintercept=0, color = "red", lty = "dashed", size = 1) +
  ylim(-75,175) +
  theme_minimal() +
  facet_wrap(~range_type) +
  labs(x = "", y = "Height difference (cm)", caption = "mean willow height, all willow spp, 2018-BL")

# ggsave("./output/figures_exported/WC_WNC_HtMeanDiff18BL_TCxburned_dfc.png", width = 5.5, height = 3.75, dpi = 300)

will.ht.mean.sf %>%
  as_tibble() %>% 
  filter(!is.na(fenced)) %>% 
  filter(range_type != "Kawuneeche Valley") %>%
  group_by(burned, range_type) %>% 
  descr(difBL18) %>% 
  tb() %>%
  select(-c(skewness, se.skewness, kurtosis)) %>% 
  gt() %>% 
  # tab_header(title = "Willow Offtake (% leader use) WC & WNC plots") %>% 
  fmt_number(
    columns = 4:11,
    decimals = 1,
    suffixing = TRUE
  )

```


```{r}
### max to spatial
will.ht.max <- willow.mcro.all %>% 
  mutate(time_class = forcats::fct_rev(time_class)) %>%
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  group_by(site_id, time_class) %>% 
  summarise(plant_ht_cm.max = max(plant_ht_cm)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = time_class, names_glue = "htmax{time_class}",values_from = plant_ht_cm.max) %>% 
  mutate(difBL18 = htmax2018 - htmaxBL) %>% 
  mutate(difBL13 = htmax2018 - htmaxBL) %>% 
  mutate(dif1318 = htmax2018 - htmax2013)

## join
will.ht.max.sf <- left_join(will.ht.max, clean_names(site.info.clean.sf)) %>% 
  st_as_sf(sf_column_name = "geometry")

will.ht.max.sf %>% 
  filter(!is.na(htmax2018)) %>% 
  mapview(zcol = "htmax2018")

# will.ht.max.sf %>%
#   st_write("./output/exported_data/spatial/willow_htmax_20200907.shp")


```

```{r}
willow.mcro.all %>%
  filter(site_type == "WC") %>%
  # filter(SITE_TYPE != "WNC") %>% 
  ggplot(aes(time_class, plant_ht_cm)) +
  geom_boxplot(aes(fill = fenced),outlier.shape = NA) +
  scale_fill_manual(values = c("grey80", "grey40")) +
  ylim(0,350) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  theme_minimal() +
  labs(x = "", y = "Willow height (cm)", fill = "", caption = "Macroplot, WC only")

# ggsave("./output/figures_exported/WC_willow_ht_boxplot_dfc.png", width = 5.5, height = 3.5)

# ggsave("./output/figures_exported/WC_allnonwillow_ht_boxplot_dfc.png", width = 5.5, height = 3.5)
```


```{r}
##### WC by species
willow.mcro.all %>%
  filter(site_type != "WK") %>% 
  # filter(site_type == "WC") %>%
  # filter(SITE_TYPE != "WNC") %>% 
  ggplot(aes(site_type, plant_ht_cm)) +
  # geom_boxplot(aes(fill = fenced), outlier.shape = NA) +
  geom_boxplot(fill = "grey70",outlier.shape = NA) +
  # scale_fill_manual(values = c("grey80")) +
  ylim(0,350) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  theme_minimal() +
  labs(x = "", y = "Willow height (cm)", fill = "", caption = "Macroplot, all willow") +
  facet_wrap(~time_class)

# ggsave("./output/figures_exported/WC_willow_ht_boxplot_site_type_dfc.png", width = 5.5, height = 3.5)

```

### WNC

```{r}
willow.mcro.all %>%
  # filter(site_type == "WC") %>%
  filter(site_type == "WNC") %>%
  ggplot(aes(time_class, plant_ht_cm)) +
  geom_boxplot(aes(fill = fenced), outlier.shape = NA) +
  scale_fill_manual(values = c("grey80", "grey40")) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  ylim(0,350) +
  theme_minimal() +
  labs(x = "", y = "Willow height (cm)", fill = "", caption = "macroplot, WNC only")

# ggsave("./output/figures_exported/WNC_willow_ht_boxplot_dfc.png", width = 5.5, height = 3.5)

```

### WK
```{r}
willow.mcro.all %>%
  filter(site_type == "WK") %>%
  # filter(site_type == "WNC") %>%
  ggplot(aes(time_class, plant_ht_cm)) +
  geom_boxplot(aes(fill = fenced)) +
  scale_fill_manual(values = c("grey80", "grey40")) +
  geom_hline(aes(yintercept = 110), color = "red", lty = "dashed", size = 1) +
  theme_minimal() +
  labs(x = "", y = "Willow height (cm)", fill = "", caption = "WK only")

# ggsave("./output/figures_exported/WK_willow_ht_boxplot_dfc.png", width = 5.5, height = 3.5)

```


### Thresholds: count of plots above 1.1 m

#### winter range (wc and wnc)
```{r}
## thresholds
willow.mcro.all %>%
  filter(!is.na(plant_ht_cm)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # tabyl(species_code)
  filter(site_type != "WK") %>%
  group_by(time_class, site_id, fenced, site_type) %>% 
  summarise(ht.mean = mean(plant_ht_cm), ht.max = max(plant_ht_cm)) %>% 
  ungroup() %>% 
  mutate(thresh1p1 = case_when(ht.mean >=110 ~ "above",
                               ht.mean <110 ~ "below")) %>%  
  tabyl(time_class, thresh1p1) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC")

  
```

### winter range: fenced
```{r}
willow.mcro.all %>%
  filter(!is.na(plant_ht_cm)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # tabyl(species_code)
  filter(site_type != "WK") %>%
  group_by(time_class, site_id, fenced, site_type) %>% 
  summarise(ht.mean = mean(plant_ht_cm), ht.max = max(plant_ht_cm)) %>% 
  ungroup() %>% 
  mutate(thresh1p1 = case_when(ht.mean >=110 ~ "above",
  ht.mean <110 ~ "below")) %>%
                               group_by(time_class, fenced, thresh1p1) %>%
                               summarise(n = n()) %>% 
                               ungroup() %>% 
                               pivot_wider(names_from =thresh1p1, values_from = n) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC: fenced")
```

### Range type x fenced
```{r}
willow.mcro.all %>%
  filter(!is.na(plant_ht_cm)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # filter(site_type != "WK") %>%
  group_by(time_class, site_id, fenced, site_type) %>% 
  summarise(ht.mean = mean(plant_ht_cm), ht.max = max(plant_ht_cm)) %>% 
  ungroup() %>% 
  mutate(thresh1p1 = case_when(ht.mean >=110 ~ "above",
  ht.mean <110 ~ "below")) %>%
                               group_by(time_class, site_type, fenced, thresh1p1) %>%
                               summarise(n = n()) %>% 
                               ungroup() %>% 
                               pivot_wider(names_from =thresh1p1, values_from = n) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC: fenced")


```

### winter range: burned fenced
```{r}
willow.mcro.all %>%
  filter(!is.na(plant_ht_cm)) %>% 
  filter(time_class == "BL" | time_class == "2013" |time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class)) %>% 
  # tabyl(species_code)
  filter(site_type != "WK") %>%
  group_by(time_class, site_id, fenced, burned) %>% 
  summarise(ht.mean = mean(plant_ht_cm), ht.max = max(plant_ht_cm)) %>% 
  ungroup() %>% 
  mutate(thresh1p1 = case_when(ht.mean >=110 ~ "above",
  ht.mean <110 ~ "below")) %>%
                               group_by(time_class, fenced, burned, thresh1p1) %>%
                               summarise(n = n()) %>% 
                               ungroup() %>% 
                               pivot_wider(names_from =thresh1p1, values_from = n) %>% 
  mutate(perc.above.thresh = round((above/(above + below)*100),1)) %>% 
  gt() %>% 
  tab_header(title = "WC+WNC: fenced burned")
```

## Offtake

### DD2

stem-scaled diameter difference method

__DD2 = (b/b +u) * (Dp - Dt)/(Db - Dt)__

b, the number of browsed shoots on the stem;
u, the number of unbrowsed shoots;
Dp, shoot diameter at the point of browsing;
Dt, the average diameter of unbrowsed shoot tips; and
Db, the diameter at the base of the shoot.

```{r, echo = FALSE, eval = FALSE}
# Looking for baseline data?  	
# 	Baseline data was collected over 2 seasons: 2008 and 2009.  
# 	The baseline data is located in an Excel spreadsheet at:
# 	EVMP > Vegetation > Analysis > 5 Year Review > Baseline Data from Linda
# 	
# Where is the Kawuneeche Baseline data?	
# 	The Kawuneeche Baseline data is in a worksheet in the Baseline.xls workbook as described above.    
# 	The Kawuneeche willow plots (KW 1 thru 8) were established in August/Sept 2011, just prior to the installation of the exclosure near Timber Creek CG.
# 	
# KEY	
# SITE_TYPE (WC=Willow core, WNC= Willow noncore, WK= Willow Kawuneeche Valley)	
# COLOR_OF_STEM_MARKER (BR=brown, G=green, BL=black, Y=yellow, GR=gray, BR-N=brown notched, W=white)	
# NUMBER_BROWSED_CAG_SHOOTS (# Browsed Current Annual Growth Shoots)	
# NUMBER_UNBROWSED_CAG_SHOOTS (# Unbrowsed Current Annual Growth Shoots)	
# BROWSED_OR_UNBROWSED (Measured shoot browsed (B) or unbrowsed (U)?)	
# ADDITIONAL_SHOOT (Additional shoot 1=yes, 0=no)	
# _KEY:_	
# SITE_TYPE (WC=Willow core, WNC= Willow noncore, WK= Willow Kawuneeche Valley)	
# 	
# COLOR_OF_STEM_MARKER (BR=brown, G=green, BL=black, Y=yellow, GR=gray, BR-N=brown notched, W=white)	
# 	
# NUMBER_BROWSED_CAG_SHOOTS (# Browsed Current Annual Growth Shoots)	
# 	
# NUMBER_UNBROWSED_CAG_SHOOTS (# Unbrowsed Current Annual Growth Shoots)	
# 	
# BROWSED_OR_UNBROWSED (Measured shoot browsed (B) or unbrowsed (U)?)	
# 	
# ADDITIONAL_SHOOT (Additional shoot 1=yes, 0=no)
```

### Baseline
```{r}
### LZ 2013 baseline
## LZ's 2013 data
# ROMO_elk_vegetation_monitoring_data_willow2013 update.xls

#### Read in the worksheets and create list of df
# each tab is a df in the list object

lz.bl13.wil.sheets <- excel_sheets(path = ("./data/EVMP_data/Baseline Data from Linda/ROMO_elk_vegetation_monitoring_data_willow2013 update.xls"))

## read in all of the tabs as 'data' in list column
lz.bl13.wil <- lz.bl13.wil.sheets %>%
  enframe() %>% 
  rename(sheet = value) %>% 
  mutate(path = ("./data/EVMP_data/Baseline Data from Linda/ROMO_elk_vegetation_monitoring_data_willow2013 update.xls")) %>% 
  mutate(data = map2(.x = path,.y = sheet,.f = read_excel,col_types = "text")) %>% 
  select(-c(name))

```

```{r}
lz.bl13.wil %>%
  distinct(sheet)

### BL-2013 spring offtake   
lz.bl13.offt.spr <- lz.bl13.wil %>%
  filter(str_detect(sheet,pattern = "RMNP_spring")) %>% 
  unnest(cols = c(data)) %>% 
  clean_names()

### BL-2013 fall offtake   
lz.bl13.offt.fall <- lz.bl13.wil %>%
  filter(str_detect(sheet,pattern = "RMNP_fall")) %>% 
  unnest(cols = c(data)) %>% 
  clean_names()


### BL-2013: "twig 2008"   
lz.bl13.twig2008 <- lz.bl13.wil %>%
  filter(str_detect(sheet,pattern = "twig")) %>% 
  unnest(cols = c(data)) %>% 
  clean_names()

  
```

#### BL twig
```{r}

### munge the baseline 2013 twig data
lz.bl13.twig2008.clean <- lz.bl13.twig2008 %>% 
  na_if(".") %>% 
  clean_names() %>% 
  mutate(across(.cols = c(shoot_length_cm,shoot_weight_g,date_of_shoot_collection, diameter_at_base_of_shoot_mm, diameter_at_tip_of_shoot_mm),.fns = as.numeric)) %>% 
  mutate(date = janitor::excel_numeric_to_date(date_of_shoot_collection)) %>% 
  mutate(yr = year(date))

### remove all records with 'na'
lz.bl13.twig2008.clean <- lz.bl13.twig2008.clean %>%
  na.omit

  
lz.bl13.twig2008.clean %>%  
  visdat::vis_dat()

```

```{r}
lz.bl13.twig2008.clean %>% 
  ggplot(aes(shoot_weight_g,shoot_length_cm)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_minimal() +
  labs(x = "Shoot weight (g)", y = "Shoot length (cm)", caption = "BL 2013 data lz.bl13.twig2008.clean")
```


```{r}
## regressions

models.twigs <- tibble::tribble(
  ~model_name,    ~ formula,
  "wt_length", shoot_weight_g ~ shoot_length_cm)

lz.bl13.twig2008.clean %>% 
  nest_by(species_code) %>% 
  left_join(models.twigs, by = character()) %>% 
  rowwise(species_code, model_name) %>% 
  mutate(model = list(lm(formula, data = data))) %>% 
  summarise(broom::glance(model)) %>% 
  gt() %>% 
  tab_header(title = "Species-specific length ~ mass")


# iris %>% 
#   nest_by(Species) %>% 
#   left_join(models, by = character()) %>% 
#   rowwise(Species, model_name) %>% 
#   mutate(model = list(lm(formula, data = data))) %>% 
#   summarise(broom::glance(model))

## example
# models <- tibble::tribble(
#   ~model_name,    ~ formula,
#   "length-width", Sepal.Length ~ Petal.Width + Petal.Length,
#   "interaction",  Sepal.Length ~ Petal.Width * Petal.Length
# )
# 
# iris %>% 
#   nest_by(Species) %>% 
#   left_join(models, by = character()) %>% 
#   rowwise(Species, model_name) %>% 
#   mutate(model = list(lm(formula, data = data))) %>% 
#   summarise(broom::glance(model))

```


#### BL clean
```{r}
lz.bl.fall <- lz.bl13.offt.fall %>%
  select(c(sheet,year_of_data_collection,
           site_type_wc_core_wnc_non_core, 
           site_number, 
           unique_site_id, 
           microplot_location, 
           species_code, 
           shoot_ratio,
           number_browsed_current_annual_growth_shoots, 
           number_unbrowsed_current_annual_growth_shoots,
           measured_shoot_browsed_b_or_unbrowsed_u,
           diameter_at_base_of_shoot_mm,
           diameter_at_tip_of_shoot_mm,
           shoot_length_cm))

## address the inconsistent year
lz.bl.fall <- lz.bl.fall %>% 
  rename(yr = year_of_data_collection) %>% 
  mutate(yr = as.integer(yr))

lz.bl.spring <- lz.bl13.offt.spr %>% 
  select(c(sheet,date,
           site_type_wc_core_wnc_non_core, 
           site_number, 
           unique_site_id, 
           microplot_location, 
           species_code, 
           shoot_ratio,
           number_browsed_current_annual_growth_shoots, 
           number_unbrowsed_current_annual_growth_shoots,
           measured_shoot_browsed_b_or_unbrowsed_u,
           diameter_at_base_of_shoot_mm,
           diameter_at_tip_of_shoot_mm,
           shoot_length_cm))


lz.bl.spring <- lz.bl.spring %>%
  mutate(date = as.numeric(date)) %>% 
  mutate(date = janitor::excel_numeric_to_date(date)) %>%
  mutate(yr = lubridate::year(date)) %>% mutate(yr = as.integer(yr))

# lz.bl.spring %>%
#   tabyl(yr)

## add season and concatenate side_id per 10yr update
lz.bl.fall <- lz.bl.fall %>% 
  mutate(season = "fall") %>% 
  mutate(site_id = as.character(glue::glue('{site_type_wc_core_wnc_non_core}-{site_number}'))) %>% 
  rename(site_type = site_type_wc_core_wnc_non_core)

### address the "." encoding
lz.bl.fall <- lz.bl.fall %>% 
  na_if(".")

lz.bl.spring <- lz.bl.spring %>% 
  mutate(season = "spring") %>% 
  mutate(site_id = as.character(glue::glue('{site_type_wc_core_wnc_non_core}-{site_number}'))) %>% 
  rename(site_type = site_type_wc_core_wnc_non_core)

### address the "." encoding
lz.bl.spring <- lz.bl.spring %>% 
  select(-date) %>% 
  na_if(".")


```

```{r}
## combine fall and spring
lz.bl.fasp <- bind_rows(lz.bl.fall, lz.bl.spring)

lz.bl.fasp <- lz.bl.fasp %>% 
  mutate(across(.cols = contains("number"),.fns = as.numeric)) %>% 
  mutate(across(.cols = contains("diam"),.fns = as.numeric)) %>%
  mutate(across(.cols = c(shoot_ratio, contains("leng")),.fns = as.numeric)) 

## clean 
lz.bl.fasp <- lz.bl.fasp %>% 
  filter(species_code != "DEAD")%>% 
  filter(species_code != "NONE")

```


```{r, eval=FALSE}
## qaqc
lz.bl.fasp %>%
  visdat::vis_dat() +
  coord_flip() +
  labs(title = "combined BL spr and fall")

## note that there is no plant ID
```

```{r}
# remove records for which browsing status is NA
lz.bl.fasp <- lz.bl.fasp %>% 
  filter(!is.na(measured_shoot_browsed_b_or_unbrowsed_u)) 

```


_Master excel file: Willow_Offtake_Data_2009_Through_2018.xlsx_


```{r, eval=TRUE, echo = FALSE}
# The following reads in the offtake data in the 10yr review files. These don't seem to be inclusive of all the data - BL seems incomplete

### Tabs in the worksheet
readxl::excel_sheets("./data/EVMP_data/TenYearReview/Willow_Offtake_Data_2009_Through_2018.xlsx") %>% 
  set_names() %>% 
  enframe() %>% select(-value) %>% 
  gt() %>% 
  tab_header(title = "Tabs in workbook")

offt.sheets <- excel_sheets(path = "data/EVMP_data/TenYearReview/Willow_Offtake_Data_2009_Through_2018.xlsx")

## read in all of the tabs as 'data' in list column
offt.raw <- offt.sheets %>%
  enframe() %>% 
  rename(sheet = value) %>% 
  mutate(path = ("./data/EVMP_data/TenYearReview/Willow_Offtake_Data_2009_Through_2018.xlsx")) %>% 
  mutate(data = map2(.x = path,.y = sheet,.f = read_excel,col_types = "text")) %>% 
  select(-c(name))
## creates a list column with the data from each sheet
 
```

```{r, eval=FALSE}
## The following was pasted in verbatim from the "DIRECTIONS" tab:

# This willow database (workbook)structure	
# 	Annual willow data collected in support of the Elk-Vegetation Management Plan (EVMP) is accumulated by year and season in this single workbook
# 	
# 	The cumulative data set for all years-to-date is contained in the most recent year's subdirectory, e.g., O:EVMP>Vegetation>Annual Records>FY10, FY11, etc.
# 	
# 	Data are collected and entered in a worksheet specific to that year and season as shown on the worksheet tabs.   
# 	
# 	Willow data in support of the Elk Vegetation Management Plan (EVMP) is collected in 2 stages each year -- A sample of unbrowsed shoots are collected   
# 	     each fall, after the growing season.  Specific measurements of browsed and unbrowsed shoots in specified plots are taken each spring
# 	     prior to the onset of growth.  Comparison of the spring measurements to the previous fall's shoot measurements allows calculation of winter offtake by
# 	    herbivores.
# 	
# Data security, disaster recovery	
# 	In addition to residing on the O:..>EVMP subdirectory as noted above, the data workbook is backed up on the hard drive (C:) of the field wildlife  
# 	     biologist's office computer after each data entry session
# 	
# 	Hard copy of spring offtake shoot measurements are held in the supervisory biologist's (T. Johnson) files (originals) and photocopies are kept in the field wildlife  
# 	    biologist's files
# 	
# 	Fall shoot measurements are conducted in the office, and entered directly into the worksheet, without hard copy
# 	
# Looking for baseline data?  	
# 	Baseline data was collected over 2 seasons: 2008 and 2009.  
# 	The baseline data is located in an Excel spreadsheet at:
# 	EVMP > Vegetation > Analysis > 5 Year Review > Baseline Data from Linda
# 	
# Where is the Kawuneeche Baseline data?	
# 	The Kawuneeche Baseline data is in a worksheet in the Baseline.xls workbook as described above.    
# 	The Kawuneeche willow plots (KW 1 thru 8) were established in August/Sept 2011, just prior to the installation of the exclosure near Timber Creek CG.
# 	
# KEY	
# 	
# SITE_TYPE (WC=Willow core, WNC= Willow noncore, WK= Willow Kawuneeche Valley)	
# 	
# COLOR_OF_STEM_MARKER (BR=brown, G=green, BL=black, Y=yellow, GR=gray, BR-N=brown notched, W=white)	
# 	
# NUMBER_BROWSED_CAG_SHOOTS (# Browsed Current Annual Growth Shoots)	
# 	
# NUMBER_UNBROWSED_CAG_SHOOTS (# Unbrowsed Current Annual Growth Shoots)	
# 	
# BROWSED_OR_UNBROWSED (Measured shoot browsed (B) or unbrowsed (U)?)	
# 	
# ADDITIONAL_SHOOT (Additional shoot 1=yes, 0=no)	

```


```{r}
## remove the "DIRECTIONS" tab and create new field for season
offt.raw <- offt.raw %>% 
  filter(str_detect(sheet,pattern = "DIRE",negate = TRUE)) %>% 
  mutate(season = case_when(str_detect(sheet,pattern = "Spring") ~ "spring",
                            str_detect(sheet,pattern = "fall") ~ "fall",
                            TRUE ~ "Oth"))

## extract the year from the sheet name
## 'twig' tabs come out as 'NA'
offt.raw <- offt.raw %>% 
  mutate(yr = as.integer(str_sub(sheet,1,4)))

```


```{r}
#### Stem diameter data
## twig data
twig.raw <- offt.raw %>%
  filter(str_detect(sheet,pattern = "twig")) %>% 
  unnest(cols = data) %>% 
  janitor::clean_names() %>% 
  mutate(date_of_collection = as.Date(as.numeric(date_of_collection), origin = "1899-12-30")) %>% 
  mutate(yr = year(date_of_collection))

## type convert
twig.raw <- twig.raw %>% 
  mutate(across(starts_with("dia"), as.numeric)) %>%
  mutate(across(starts_with("shoot"), as.numeric)) 

```


```{r}
offt.raw.spr <- offt.raw %>%
  filter(season == "spring")

# unnest
offt.raw.spr.tidy <- offt.raw.spr %>%
  unnest(cols = data) %>% 
  janitor::clean_names()

```


```{r}
## Distinct
# offt.raw.spr.tidy %>%
#   filter(dia_base_of_shoot_mm == "0") %>% View()
## Note: not other measurements for these "0" values, so should be NA

######### DEAL WITH NA #############
## Note
na_strings <- c(".", "na", "NA", "N A", "N / A", "N/A", "N/ A", "Not Available", "NOt available")
# 
offt.raw.spr.tidy <- offt.raw.spr.tidy %>%
  naniar::replace_with_na_all(condition = ~.x %in% na_strings)

```

```{r}
## type convert
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  # glimpse()
  mutate_at(.vars = c('number_browsed_cag_shoots','number_unbrowsed_cag_shoots', 'dia_base_of_shoot_mm','dia_tip_of_shoot_mm','shoot_length_cm','total_stem_count', 'shoot_ratio','calculated_count_of_shoots','additional_shoot'),.funs = as.numeric) %>% 
  mutate(site_id = case_when(site_id == "WC1" ~ "WC01",
                       site_id == "WC2" ~ "WC02",
                       site_id == "WC3" ~ "WC03", 
                       site_id == "WC4" ~ "WC04", 
                       site_id == "WC4" ~ "WC04",
                       site_id == "WC5" ~ "WC05",
                       site_id == "WC6" ~ "WC06", 
                       site_id == "WC7" ~ "WC07", 
                       site_id == "WC8" ~ "WC08",
                       site_id == "WC9" ~ "WC09",
                       site_id == "WNC1" ~ "WNC01",
                       site_id == "WNC1" ~ "WNC01",
                       site_id == "WNC2" ~ "WNC02",
                       site_id == "WNC3" ~ "WNC03", 
                       site_id == "WNC4" ~ "WNC04", 
                       site_id == "WNC4" ~ "WNC04",
                       site_id == "WNC5" ~ "WNC05",
                       site_id == "WNC6" ~ "WNC06", 
                       site_id == "WNC7" ~ "WNC07", 
                       site_id == "WNC8" ~ "WNC08",
                       site_id == "WNC9" ~ "WNC09",
                       site_id == "WK1" ~ "WK01",
                       site_id == "WK2" ~ "WK02",
                       site_id == "WK3" ~ "WK03", 
                       site_id == "WK4" ~ "WK04", 
                       site_id == "WK4" ~ "WK04",
                       site_id == "WK5" ~ "WK05",
                       site_id == "WK6" ~ "WK06", 
                       site_id == "WK7" ~ "WK07", 
                       site_id == "WK8" ~ "WK08",
                       site_id == "WK 8" ~ "WK08",
                       site_id == "WNC 32" ~ "WNC32",
                       site_id == "WK9" ~ "WK09",
                       TRUE ~ as.character(site_id))
  )

## eliminate duplicates across all variables
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  distinct()


```

```{r, eval=FALSE}
# qa
offt.raw.spr.tidy %>% 
  visdat::vis_dat()

# all the NA for plant id is in 2009; all the NA for color of stem marker in 2009
offt.raw.spr.tidy %>% 
  tabyl(plant_id_number, yr)

offt.raw.spr.tidy %>%
  tabyl(color_of_stem_marker, yr)

```

```{r}
## clean plant id
## add a plant id value from stem color (2009 only)
offt.raw.spr.tidy %>% 
  mutate(plant_id_number = case_when(color_of_stem_marker == "BL" ~ "1",
                                     color_of_stem_marker == "BR" ~ "2",
                                     color_of_stem_marker == "G" ~ "3",
                                     color_of_stem_marker == "GR" ~ "4",
                                     color_of_stem_marker == "NR" ~ "5",
                                     color_of_stem_marker == "Y" ~ "6",
                                     TRUE ~ plant_id_number)) 

```


```{r, eval=FALSE}
## these sheets are missing basal diameters
offt.raw.spr.tidy %>% 
  filter(is.na(dia_base_of_shoot_mm)) %>% 
  datatable()

```

```{r}
#### clean up site_id

offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  mutate(site_id = case_when(
    site_id == "WC 39" ~ "WC39",
    site_id == "WC 50" ~ "WC50",
    TRUE ~ site_id)) 

```

```{r, eval=FALSE}
## checking that row names are consistent across yr values
offt.raw.spr.tidy %>%
  nest_by(yr) %>% 
  rowwise(yr) %>% 
  mutate(l = length(data)) %>% 
  mutate(names = list(names(data))) %>% 
  unnest(names) %>% 
  tabyl(names, yr)

```


### Offtake combine baseline and master

```{r, eval=TRUE}
## prep BL for rbind

## rename cols in bl
lz.bl.fasp <- lz.bl.fasp %>% 
  rename(dia_base_of_shoot_mm = diameter_at_base_of_shoot_mm) %>% 
  rename(dia_tip_of_shoot_mm = diameter_at_tip_of_shoot_mm) %>% 
  rename(number_unbrowsed_cag_shoots = number_unbrowsed_current_annual_growth_shoots) %>% 
  rename(number_browsed_cag_shoots =	
number_browsed_current_annual_growth_shoots) %>%
  rename(browsed_or_unbrowsed = measured_shoot_browsed_b_or_unbrowsed_u)

offt.raw.spr.tidy <- offt.raw.spr.tidy %>%
  mutate(site_number = as.numeric(site_number))

```

```{r, eval=FALSE}
## compare
janitor::compare_df_cols(lz.bl.fasp,offt.raw.spr.tidy) %>% 
  View()


offt.raw.spr.tidy %>% 
  visdat::vis_dat()
```

```{r}
## combine the baseline observations from the separate LZ import (data apparently not in the 10yr review files)

## add columns to track things more easily
lz.bl.fasp <- lz.bl.fasp %>% 
  mutate(source = "LZBL") ## baseline

offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  mutate(source = "10yrReview")

## row bind
offt.raw.spr.tidy <- bind_rows(offt.raw.spr.tidy, lz.bl.fasp)


```


```{r}
## standardize site id
## this is done for the 10yr update-derived object, but not th LZ BL
offt.raw.spr.tidy <- offt.raw.spr.tidy %>%
  mutate(site_id = str_remove(site_id,"-")) %>% 
  mutate(site_id = case_when(site_id == "WNC1" ~ "WNC01",
  site_id == "WNC2" ~ "WNC02",
  site_id == "WNC3" ~ "WNC03",
  site_id == "WNC4" ~ "WNC04",
  site_id == "WNC5" ~ "WNC05",
  site_id == "WNC6" ~ "WNC06",
  site_id == "WNC7" ~ "WNC07",
  site_id == "WNC8" ~ "WNC08",
  site_id == "WNC9" ~ "WNC09",
  site_id == "WC1" ~ "WC01",
  site_id == "WC2" ~ "WC02",
  site_id == "WC3" ~ "WC03",
  site_id == "WC4" ~ "WC04",
  site_id == "WC5" ~ "WC05",
  site_id == "WC6" ~ "WC06",
  site_id == "WC7" ~ "WC07",
  site_id == "WC8" ~ "WC08",
  site_id == "WC9" ~ "WC09",
  TRUE ~ site_id))

##  remove "dead" and "0" species code
offt.raw.spr.tidy <- offt.raw.spr.tidy %>%
  filter(species_code != "DEAD") %>%
  filter(species_code != '0') %>% 
  mutate(species_code = toupper(.$species_code))

# reclass "SA-" to "SAXX" 
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  mutate(species_code = case_when(species_code == "SA-" ~ "SAXX",
                                  TRUE ~ species_code))

```

```{r}
# more cleaning.  Many fields are not used (mostly NA) and not used in calcs so removed here
offt.raw.spr.tidy <- offt.raw.spr.tidy %>%
  select(-c(unique_site_id, color_of_stem_marker, path, calculated_count_of_shoots, contains("number_"))) 

```

#### Create unique stem id
```{r}
## Create unique stem id
## This follows directions in appendix 7 of Zeigenfuss 2011. NOTE: there are many incomplete fields...
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  mutate(stid = paste0(site_id,"-",microplot_location,"-",plant_id_number,"-", stem_id_letter))

## adding species code to stid
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  mutate(stid.sppcode = paste0(site_id,"-",microplot_location,"-",plant_id_number,"-", stem_id_letter,"-", species_code))

# offt.raw.spr.tidy %>% 
#   select(yr, site_id, stid, stid.sppcode) %>% 
#   tabyl(site_id, yr) %>% 
#   View()

## diagnose and fix issues with b/u
# these are not 
offt.raw.spr.tidy %>% 
  tabyl(browsed_or_unbrowsed) %>% 
  # distinct(browsed_or_unbrowsed) %>% 
  gt() %>% 
  tab_header("Distinct 'browsed_unbrowsed",subtitle = "need to standardized encoding and deal with NA")

offt.raw.spr.tidy <- offt.raw.spr.tidy %>%
  mutate(browsed_or_unbrowsed = case_when(
    str_detect(browsed_or_unbrowsed,pattern = "u") ~ "U", 
    str_detect(browsed_or_unbrowsed,pattern = "b") ~ "B",              
                            TRUE ~ browsed_or_unbrowsed))

### clean: 0 browsed doesn't make sense

offt.raw.spr.tidy <- offt.raw.spr.tidy %>%
  filter(browsed_or_unbrowsed != "0") %>% 
  filter(!is.na(browsed_or_unbrowsed)) %>%
  filter(browsed_or_unbrowsed != "NA") 

```


```{r}
### Missing plant id
offt.raw.spr.tidy %>% 
  filter(is.na(plant_id_number)) %>% 
  select(sheet,  yr, plant_id_number) %>% 
  tabyl(sheet) %>% 
  gt() %>% 
  tab_header(title = "No plant id for these records in the orignal data")

## based on above, will try another stid with spp
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  mutate(stid.alt = paste0(site_id,"-",microplot_location,"-", species_code))

```

There is little consistency in the format of data entry between years...

```{r}
offt.raw.spr.tidy %>% 
  visdat::vis_dat() 
```

# !###

```{r, eval = FALSE}
## qc
offt.raw.spr.tidy %>% 
  visdat::vis_dat()

## qc tables
offt.raw.spr.tidy %>% 
  tabyl(yr, site_id) %>% 
  gt()
offt.raw.spr.tidy %>% 
  tabyl(yr, sheet) %>% 
  gt()

offt.raw.spr.tidy %>% 
  tabyl(yr, browsed_or_unbrowsed) %>% 
  gt()


offt.raw.spr.tidy %>% 
  tabyl(yr, stid) %>% 
  gt()

```

#### Tally u and b
```{r, eval=FALSE}
offt.raw.spr.tidy %>%
  tabyl(yr,season)

## limited fall data
```

```{r}
### FILTER to only spring data
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  filter(season == "spring")

```

```{r}
# distinct records across all fields
offt.raw.spr.tidy <- offt.raw.spr.tidy %>% 
  distinct()

#### Tally u and b
### new object
offt.cln <- offt.raw.spr.tidy %>% 
  group_by(site_id, stid, yr, browsed_or_unbrowsed) %>% 
  mutate(stem.tally = n()) %>% 
  ungroup()

## replacing NA for 'additional shoot' with 0 as this seems implied
offt.cln <- offt.cln %>% 
  mutate(additional_shoot = replace_na(additional_shoot, 0))

```

```{r}
## remove some apparent duplicates
offt.cln <- offt.cln %>%
  select(-c(sheet,source)) %>% 
  distinct()

```


```{r, eval=FALSE}
offt.cln %>% 
  View()
```


#### Multiply the stem tally by shoot ratio
```{r}
## shoot ratio has problems...

#### Address issues with 'shoot ratio'
# Missing shoot ratio. Making these '1'
# replacing '0' with '1'. Why? As multiplier with count, will be '0' if count is zero.

offt.cln <- offt.cln %>% 
  mutate(shoot_ratio = replace_na(shoot_ratio, 1)) %>% 
  mutate(shoot_ratio = case_when(
    shoot_ratio == 0 ~ 1,
    TRUE ~ shoot_ratio
  ))

## assume shoot ratio of 33 is 3; reclass
offt.cln <- offt.cln %>% 
  mutate(shoot_ratio = case_when(
    shoot_ratio == 33 ~ 3,
    TRUE ~ shoot_ratio
  ))

## clean records based on comments
offt.cln <- offt.cln %>%
  filter(comments != "Shouldn't analyze this plot with offtake - it is fenced")

## list of comments
# offt.cln %>% 
#   filter(!is.na(comments)) %>% 
#   select(sheet,site_id,yr, comments) %>% 
#   datatable()


```

#### multiply the stem tally by shoot ratio

```{r}
## multiply the stem tally by shoot ratio 
offt.cln <- offt.cln %>% 
  mutate(total_bu_pre_addshoot = stem.tally*shoot_ratio) %>% 
  mutate(total_bu = total_bu_pre_addshoot + additional_shoot)

```

```{r}
## join in the site info
site.info.cleannames <- site.info.clean %>% 
  clean_names()


offt.cln <- left_join(offt.cln, site.info.cleannames, by = "site_id")

##########
### Removed plots have been carried over
site.info.fenced.burned <- site.info.clean %>% 
  clean_names() %>% 
  select(site_id, fenced, burned)

offt.cln <- offt.cln %>% 
  select(-fenced, -burned)

offt.cln <- left_join(offt.cln,site.info.fenced.burned, by = "site_id")

```


```{r, eval = FALSE}

###
offt.cln %>% 
  # filter(!is.na(plant_id_number)) %>% 
  tabyl(site_id, yr) %>% 
  gt()
#######   need to find 2009! a little 2014 too have missing plant id

offt.cln %>% 
  visdat::vis_dat()
```

```{r}

## calc total number of stems (b + u)
offt.cln <- offt.cln %>% 
  group_by(stid, yr) %>% 
  mutate(tot_allstems_per_shoot = sum(total_bu)) %>%   ungroup()


#qa
# offt.cln %>%
#   slice_sample(n = 25) %>% 
#   gt()


offt.cln <- offt.cln %>% #names() 
  group_by(stid, yr) %>% 
  mutate(sum_bu_per_stem = sum(total_bu)) %>% 
  ungroup() 

## calc the % of shoots browsed per STEM (step 2a n Zeigenfuss 2011)
offt.cln <- offt.cln %>% 
  mutate(percent_bu_per_stem = total_bu/sum_bu_per_stem) %>%
  mutate(percent_bu_per_stem = round(percent_bu_per_stem,3)) 

```

```{r}
## fix species code
## eliminate "DEAD" species
offt.cln <- offt.cln %>%
  filter(species_code != "DEAD") %>%
  # filter(species_code != "0") %>% 
  mutate(species_code = case_when(
    species_code == "Sabe" ~ "SABE",
    species_code == "Sage" ~ "SAGE",
    species_code == "Samo" ~ "SAMO",
    species_code == "SA-" ~ "SAXX",
    TRUE ~ species_code
  ))

```

```{r}

```

```{r}
# offt.cln %>% 
#   mutate(time_class = case_when(yr == 2008 ~ "BL",
#                               yr == 2009 ~ "BL", 
#                               TRUE ~ as.character(yr))) %>% 
#   mutate(time_class = as.factor(time_class)) %>%
#   tabyl(time_class)
#   mutate(time_class = fct_relevel(time_class, "2018", "2013", "BL"))

## add timeclass

### summary plots
# select just the browsed stems
offt.percbrowsed <- offt.cln %>% 
  filter(browsed_or_unbrowsed == "B") %>% 
  select(c(yr, site_type, site_id, species_code, stid, sum_bu_per_stem, percent_bu_per_stem, fenced, range_type)) %>% 
  distinct()
  

offt.percbrowsed %>% 
  group_by(yr, site_id, fenced, range_type) %>% 
  summarytools::descr(percent_bu_per_stem) %>% 
  tb() %>% 
  datatable()
  
## qc
# offt.cln %>%
#   group_by(yr,site_id, stid) %>% 
#   summarytools::descr(percent_bu_per_stem,
#                       stats = "common") %>% 
#   tb() %>% 
#   gt()

offt.cln %>% 
  # filter(site_id == "WC12" | yr == 2009) %>% 
  ggplot(aes(reorder(site_id, percent_bu_per_stem),percent_bu_per_stem)) +
  geom_col(aes(fill = browsed_or_unbrowsed)) +
  facet_wrap(~yr)
           

```

```{r, eval=FALSE}
offt.percbrowsed %>% 
  filter(is.na(fenced)) %>% 
  View()
```


```{r}
## offtake
offt.percbrowsed %>%
  ggplot(aes(x = as_factor(yr), y = percent_bu_per_stem)) +
  geom_boxplot(fill = "ivory2", outlier.shape = NA) +
  labs(x = "Year",y = "% leader use") +
  # facet_wrap(~site_type) +
  facet_grid(fenced~site_type) +
  theme_minimal() +
  scale_y_continuous(labels=scales::percent)

offt.percbrowsed %>% 
  ggplot(aes(x = as_factor(yr), y = percent_bu_per_stem)) +
  geom_boxplot(fill = "ivory2", outlier.shape = NA) +
  labs(x = "Year",y = "% leader use") +
  facet_wrap(~site_type) +
  theme_minimal() +
  scale_y_continuous(labels=scales::percent)

offt.percbrowsed %>% 
  ggplot(aes(x = percent_bu_per_stem, y = as_factor(yr))) +
  ggridges::geom_density_ridges(rel_min_height = 0.005,panel_scaling = TRUE) +
  # scale_y_discrete(expand = c(0.01, 0)) +
  # scale_x_continuous(expand = c(0.01, 0)) +
  theme_minimal() +
  labs(x = "% leader use", y = "", caption = "all species") +
  # scale_y_continuous(labels=scales::percent) +
  facet_wrap(~site_type) +
  scale_x_continuous(labels=scales::percent,limits = c(0,1))


offt.percbrowsed %>% 
  ggplot(aes(x = percent_bu_per_stem, y = as_factor(yr))) +
  # ggridges::geom_density_ridges(rel_min_height = 0.005,panel_scaling = TRUE) +
  geom_boxplot() +
  # scale_y_discrete(expand = c(0.01, 0)) +
  # scale_x_continuous(expand = c(0.01, 0)) +
  theme_minimal() +
  labs(x = "% leader use", y = "", caption = "all species") +
  # scale_y_continuous(labels=scales::percent) +
  # facet_wrap(~site_type) +
  facet_grid(site_type~fenced) +
  scale_x_continuous(labels=scales::percent,limits = c(0,1))


# ggsave("./output/figures_exported/ggridge_percleaderuse_site_type_20200602.png", width = 8.5, height = 6, dpi = 300)

offt.percbrowsed %>%
  filter(site_type != "WK") %>% 
  ggplot(aes(y = percent_bu_per_stem)) +
  geom_histogram() +
  # theme_minimal() +
  theme_minimal() +
  labs(y = "% leader use", x = "count", caption = "all species") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # facet_grid(as_factor(yr) ~site_type)
  facet_grid(site_type ~ as_factor(yr)) +
  scale_y_continuous(labels=scales::percent,limits = c(0,1))
  # facet_wrap(~site_type, scales = "free_x") 

# ggsave("./output/figures_exported/histo_percleaderuse_wc_wnc_20200602.png", width = 9.5, height = 4.5, dpi = 300)

offt.percbrowsed %>% 
  ggplot(aes(x = percent_bu_per_stem)) +
  # geom_histogram() +
  geom_density(aes(color = as_factor(yr))) +
  facet_wrap(~site_type) +
  theme_minimal() +
  labs(x = "% leader use", y = "") +
  scale_x_continuous(labels=scales::percent,limits = c(0,1))

# WC density  
offt.percbrowsed %>% 
  filter(site_type == "WC") %>%
  ggplot(aes(x = percent_bu_per_stem)) +
  # geom_histogram() +
  geom_density(aes(color = as_factor(yr))) +
  facet_wrap(~site_type) +
  theme_minimal() +
  labs(x = "% leader use", y = "", color = "") +
  scale_x_continuous(labels=scales::percent,limits = c(0,1))

# ggsave("./output/figures_exported/desnity_percleaderuse_wc_20200602.png", width = 4.5, height = 3.75, dpi = 300)

# WNC density  
offt.percbrowsed %>% 
  filter(site_type == "WNC") %>%
  ggplot(aes(x = percent_bu_per_stem)) +
  # geom_histogram() +
  geom_density(aes(color = as_factor(yr))) +
  facet_wrap(~site_type) +
  theme_minimal() +
  labs(x = "% leader use", y = "", color = "") +
  scale_x_continuous(labels=scales::percent,limits = c(0,1))

# ggsave("./output/figures_exported/desnity_percleaderuse_wnc_20200602.png", width = 4.5, height = 3.75, dpi = 300)

```

```{r}
### summary by site
offt.percbrowsed.summary <- offt.percbrowsed %>% 
  group_by(yr, site_id) %>% 
  summarytools::descr(var = percent_bu_per_stem, round.digits = 1) %>% 
  summarytools::tb()

## make plot based
offt.percbrowsed.summary <- offt.percbrowsed %>% 
  group_by(yr, site_type) %>% 
  summarytools::descr(var = percent_bu_per_stem, round.digits = 1) %>% 
  summarytools::tb()

offt.percbrowsed.summary %>% 
  gt() %>% 
  tab_header(title = "Willow Offtake (% leader use)") %>% 
  fmt_number(
    columns = 4:18,
    decimals = 1,
    suffixing = TRUE
  )

```

## >>> percent browsed looks weird for last 4 yrs
```{r}

offt.percbrowsed.summary %>%
  ggplot(aes(yr, med)) +
  geom_col(fill = 'grey60') +
  geom_errorbar(aes(ymin = med - mad, ymax = med + mad)) +
  facet_wrap(~site_type) +
  theme_minimal()

```

### Percent browsed

```{r}
## yr x for combined WC and WNC site type

offt.percbrowsed.summary.allRange <- offt.percbrowsed %>% 
  mutate(percent_bu_per_stem = percent_bu_per_stem*100) %>%
  filter(site_type == "WC" | site_type == "WNC") %>%   group_by(yr) %>% 
  summarytools::descr(var = percent_bu_per_stem, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, Year = yr)

offt.percbrowsed.summary.allRange %>% 
  gt() %>% 
  tab_header(title = "Willow Offtake (% leader use) WC & WNC plots") %>% 
  fmt_number(
    columns = 2:11,
    decimals = 1,
    suffixing = TRUE
  ) # %>% 
  # gtsave("./output/tables/WillowPercOfft_WCplusWNC.rtf")

```

```{r}
## yr x for combined WC and WNC site type

offt.percbrowsed.summary.allRange.fen <- offt.percbrowsed %>% 
  mutate(percent_bu_per_stem = percent_bu_per_stem*100) %>%
  filter(site_type == "WC" | site_type == "WNC") %>%   group_by(yr, fenced) %>% 
  summarytools::descr(var = percent_bu_per_stem, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, Year = yr)

offt.percbrowsed.summary.allRange.fen %>% 
  gt() %>% 
  tab_header(title = "Willow Offtake (% leader use) WC & WNC plots") %>% 
  fmt_number(
    columns = 3:11,
    decimals = 1,
    suffixing = TRUE
  ) # %>% 
  # gtsave("./output/tables/WillowPercOfft_WCplusWNC.rtf")
```


```{r}
## yr x site type
offt.percbrowsed.summary <- offt.percbrowsed %>% 
  mutate(percent_bu_per_stem = percent_bu_per_stem*100) %>% 
  group_by(yr, site_type) %>% 
  summarytools::descr(var = percent_bu_per_stem, round.digits = 1) %>% 
  summarytools::tb() %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness)) %>% 
  rename(n = n.valid, Year = yr, 'Site type' = site_type)

## WC and WNC
offt.percbrowsed.summary %>% 
  filter(`Site type` == "WC" | `Site type` == "WNC") %>% 
  gt() %>% 
  tab_header(title = "Willow Offtake (% leader use)") %>% 
  fmt_number(
    columns = 3:11,
    decimals = 1,
    suffixing = TRUE
  ) # %>% 
  # gtsave("./output/tables/WillowPercOfft_WC_WNC_yrxsite_type.rtf")

```

#### Calculate DD1, the avg proportion of shoot consumed per stem (step 3 in Zeigenfuss 2011)

DD1 = (Dp - Dt)/(Db -Dt)

Dp = shoot diameter at point of browsing
Dt = Avg diam of of unbrowsed stems
Db = diamter at base of shoot


```{r}
# offt.cln %>% 
#   names()
  # visdat::vis_dat()

## Calculate: 
## Dp = shoot diameter at point of browsing &
## Db = diamter at base of shoot
offt.cln <- offt.cln %>%
  mutate(Db = dia_base_of_shoot_mm) %>% 
  mutate(Dp = dia_tip_of_shoot_mm)

## calculate Dt - Avg diam of of unbrowsed stems  
Dt.table <- offt.cln %>% 
  filter(browsed_or_unbrowsed == "U") %>% 
  group_by(stid, yr) %>% 
  summarise(Dt = mean(Dp, na.rm = TRUE)) %>% 
  ungroup()
  

## Dtsite
Dtsite.table <- offt.cln %>% 
  filter(browsed_or_unbrowsed == "U") %>% 
  group_by(site_id, species_code, yr) %>% 
  summarise(Dtsite = mean(Dp, na.rm = TRUE)) %>% 
  ungroup()

## Dtspecies
Dtspp.table <- offt.cln %>% 
  filter(browsed_or_unbrowsed == "U") %>% 
  group_by(species_code, yr) %>% 
  summarise(Dtspp = mean(Dp, na.rm = TRUE)) %>% 
  mutate(Dtspp = case_when(
    species_code == "SALA" ~ 0.748, # setting to Dt of SAXX, since there are NaN for SALA and SAWO
    species_code == "SAWO" ~ 0.748,
    TRUE ~ Dtspp
  )) %>% 
  ungroup()

## join in the Dt values
offt.cln.br <- offt.cln %>% 
  filter(browsed_or_unbrowsed == "B") %>% 
  left_join(.,Dt.table)

## join Dtsite for BROWSED
offt.cln.br <- offt.cln %>% 
  filter(browsed_or_unbrowsed == "B") %>%
  left_join(.,Dtsite.table)

## join in Dtspp for BROWSED
offt.cln.br <- offt.cln %>% 
  filter(browsed_or_unbrowsed == "B") %>%
  left_join(.,Dtspp.table)

offt.cln.br %>%
  visdat::vis_dat(warn_large_data = FALSE)
```

```{r, eval=FALSE}
## IF Dt is NA after sub in Dtsite (if available. Will still be Na, but fewer)
offt.cln.br <- offt.cln.br %>%
  mutate(Dtadj = case_when(
    is.na(Dt) ~ Dtsite,
    TRUE ~ Dt
    )
  )
## IF Dt is still NA after subbing in Dtsite, replace with Dtspp
offt.cln.br <- offt.cln.br %>%
  mutate(Dtadj = case_when(
    is.na(Dtadj) ~ Dtspp,
    TRUE ~ Dtadj
    )
  )

## if Dt is negative or greater than zero (part 3 in Zeigenfuss 2011). Where Dt is < Dtspp, replace with Dtspp
offt.cln.br <- offt.cln.br %>%
  mutate(Dtadj = case_when(
    Dt <= Dtspp ~ Dtspp,
    TRUE ~ Dtadj
    )
  )

## covert values >1 to 1 (can't have more than 100%) -- see Zeigenfuss
offt.cln.br <- offt.cln.br %>%
  mutate(Dtadj = case_when(
    Dtadj > 1 ~ 1,
    TRUE ~ Dtadj
    )
  )

# offt.cln.br %>% 
#   summarytools::descr(Dtadj) %>% 
#   summarytools::tb()


```


```{r, eval=FALSE}
# DD1stem >>>
### calc DD1
offt.cln.br %>% names()

offt.cln.br <- offt.cln.br %>%
  group_by(stid, yr) %>% 
  mutate(DD1 = ((Dp - Dtadj)/(Db - Dtadj))) %>% 
  ungroup()

offt.cln.br %>% 
  filter(!is.na(DD1)) %>% 
  summarytools::descr(DD1,na.rm = TRUE)

```

```{r, eval = FALSE}
## Notes for above from Ziegenfuus 2011
## There are some cases where no unbrowsed shoots were measured on an individual stem and thus an average unbrowsed tip diameter (Dt) for the stem cannot be calculated. In this case, an average unbrowsed tip diameter for all the stems of a particular species within a site is calculated (Dtsite) and then substituted for Dt. If there were no unbrowsed shoots of a species found within an individual site, then an average unbrowsed shoot tip can be calculated from all shoot measurements of that species (Dtsp) that were collected from other willow-monitoring sites measured within the same year and this average is substituted for Dt.

```

```{r, eval = FALSE}
## calc the % of shoots per site and year (step 2b in Z 2011)
offt.cln.site.allwillow <- offt.cln %>%
  group_by(site_id, species_code)
  


## calc the proporation of browsed/unbrowsed stems out of total
offt.cln <- offt.cln %>% 
  mutate(perc_bu_shoots = total_bu/tot_allstems*100)

browsed_percent <- a.stid.cnt.bu %>% 
  filter(browsed_or_unbrowsed == "B") %>% 
  dplyr::select(stid, yr, species_code, browsed_or_unbrowsed, perc_bu_shoots)

# browsed_percent %>% 
#   filter(!is.na(perc_bu_shoots)) %>% 
#   distinct() %>% 
#   View()

offt.cln.spr.tidy <- offt.cln.spr.tidy %>%   
  filter(is.na(shoot_ratio))
  tabyl(shoot_ratio)
  
## try some cleaning
offt.cln.spr.tidy <- offt.raw.spr.tidy %>% 
  filter(!is.na(dia_tip_of_shoot_mm))  
```


```{r}
# offt.raw.spr.tidy %>% 
#   vtree::vtree(.,"species_code yr", palette = 9)
  # vtree::vtree(.,"yr site_type", pattern = TRUE, palette = 9)
```


```{r, eval=FALSE}
offt.raw.spr.tidy %>% 
  names()
    
##### define function
# dd2 = function(df){
#   b = df$number_browsed_cag_stems
#   u = df$number_unbrowsed_cag_stems
#   Dp = df$
# } 
```



```{r}
# 'number_browsed_cag_shoots','number_unbrowsed_cag_shoots', 'dia_base_of_shoot_mm','dia_tip_of_shoot_mm','shoot_length_cm','total_stem_count'
```


```{r, eval = FALSE, echo=FALSE}
###### Get the names of the macroplot tabs as vector with datapasta
wo.d %>% 
  names() %>% 
  as.tibble() %>% 
  filter(str_detect(value, 'Macroplot')) # copy from clipboard and paste as vector

### Extract out just the macroplot tabs
mp.list <- purrr::map(c("z2008-09 Macroplot Baseline",
  "z2013 Macroplot Inventory",
  "z2015 Macroplot Inventory",
  "z2016 Macroplot Inventory",
  "z2017 Macroplot Inventory",
  "z2018 Macroplot Inventory"),
  ~ wo.d[.]) 

# get the names of df. Note use of the 'at_depth' argument to dial into the second level of the list
df.names <- mp.list %>% 
  at_depth(2, names) %>% 
  at_depth(2, tibble)

# df.names %>% 
#   at_depth(2,walk(.,View)) # this sort of works, but b/c of the nested lists, not useful

###### UNLIST!!!!! #####
new.pp <- unlist(df.names,recursive=FALSE)

# walk(new.pp,View) # this works! Opens a View portal for each list item 
# walk(new.pp,print) # prints each list item to console
# the takehome is there are different number of columns in each tab!
# can't combine

df.names %>% 
  at_depth(2,map_df(.,rbind))



##################
# purrr::map(c(#"2008-09 Macroplot Baseline",
#   "2013 Macroplot Inventory",
#   "2015 Macroplot Inventory",
#   "2016 Macroplot Inventory",
#   "2017 Macroplot Inventory",
#   "2018 Macroplot Inventory"),
#   ~ wo.d[.]) 

```



```{r, eval=FALSE}
# Create a cache of workbook tabs as CSV files
## cache csv. This creates a csv cache of each tab in the workbook. 

read_then_csv <- function(sheet, path) {
  pathbase <- path %>%
    basename() %>%
    tools::file_path_sans_ext()
  path %>%
    read_excel(sheet = sheet) %>% 
    write_csv(paste0(pathbase, "-", sheet, ".csv"))
}

path %>%
  excel_sheets() %>%
  set_names() %>% 
  map(read_then_csv, path = path)

map_df(.x = mp.list,.f = bind_rows)

mp.list2 <- mp.list %>% 
  map_if(is.numeric, as.character) 

bind_rows(mp.list, .id = "id")


za <- path %>%
  excel_sheets() %>%
  set_names() %>% 
  map_df(~ read_excel(path = path, sheet = .x), .id = "sheet")

path %>%
  excel_sheets() %>%
  set_names() %>% 
  map_df(~ read_excel(path = path, sheet = .x, range = "A2:F15"), .id = "sheet")

######
name.lineInt <- wo.d 
# %>% 
  # names() %>% 
  # as.tibble() %>% 
  # filter(str_detect(value, 'Line'))

wo.d %>%
  names() %>%
  as.tibble() %>%
  filter(str_detect(value, 'Site')) 
######

### Extract out just the line intercept
bl.list <- purrr::map(c("2008-09 Line Intercept Baseline",
  "2013 Line Intercept",
  "2015 Line Intercept",
  "2016 Line Intercept",
  "2017 Line Intercept",
  "2018 Line Intercept"),
  ~ name.lineInt[.]) 


# library(readxl)    
# read_excel_allsheets <- function(filename) {
#     sheets <- readxl::excel_sheets(filename)
#     x <-    lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
#     names(x) <- sheets
#     x
# }
# 
# mysheets <- read_excel_allsheets("data/EVMP_20181010/TenYearReview/Willow_Cumulative_Data_Baseline_Through_2018.xlsx")


b2007 <- readxl::read_excel("data/EVMP_20181010/TenYearReview/Upland_Line_Intercept_2007_2013_2018.xlsx",sheet = 2) %>% 
  mutate(yr = 2007)

b2013 <- readxl::read_excel("data/EVMP_20181010/TenYearReview/Upland_Line_Intercept_2007_2013_2018.xlsx",sheet = 3) %>% 
  mutate(yr = 2013)


b2018 <- readxl::read_excel("data/EVMP_20181010/TenYearReview/Upland_Line_Intercept_2007_2013_2018.xlsx",sheet = 4) %>% 
  mutate(yr = 2018) %>% 
  mutate(SHRUB_HEIGHT_CM = as.character(SHRUB_HEIGHT_CM))

# combine 07 and 13
baseline <- bind_rows(b2007,b2013) 

## bring in the 2018 data
baseline <- baseline %>% 
  bind_rows(., b2018)

```

```{r, echo=FALSE}

# Rewrite the SAS program used to analyze willow height data as found in table 9 of Zeigenfuss and Johnson (2015)--Least squares means of average and maximum willow height and percent willow cover on burned sites compared to unburned sites using the macroplot method at EVMP willow monitoring sites in Rocky Mountain National Park, Colorado. 
# 
# **Steps:** 
# 
# 1. Read in data from a file containing the baseline data from willow macroplots  
# 2. Calculate canopy area for each plot and assigns the baseline year (2008) to these data 
# 3. Sort data down to willow and non-willow species groups and calculates mean for the variables "average height" and "maximum ht" for each group.
# 
# 
# 
# [follow up]
# **See: **  
# 
# >willow shrub cover macro table 8.sas  
# >willow shrub height table 8.sas  
# >willow shrub cover macro table 9.txt    
# >willow shrub height table 9.txt 

```
 
```{r}



```


## Beaver and Moose Presence

The following plots and tables summarise the beaver and moose presence observation for 2018

```{r beaver18, eval=FALSE}

#### Observations of beaver presence noted in plots 
# How best to use these obserations? 
# 
# **Variable: BEAVER_PRESENCE**

sinfo.df %>%
  mutate(BEAVER_PRESENCE = recode(BEAVER_PRESENCE, 
                         "Absence_" = "Absence",
                         "Food_cache_cuttings"="Cuttings")) %>% 
  tabyl(BEAVER_PRESENCE) %>% 
  gt::gt() %>% 
  fmt_number(
    columns = vars(percent),
    decimals = 2
    )

sinfo.df %>%
  mutate(BEAVER_PRESENCE = recode(BEAVER_PRESENCE, 
                         "Absence_" = "Absence",
                         "Food_cache_cuttings"="Cuttings")) %>%
  group_by(BEAVER_PRESENCE) %>%
  tally()

bv.tally <- sinfo.df %>%
  mutate(LOCATION = case_when(is.na(LOCATION) & SITE_TYPE == "WK" ~ "Kawuneeche",
                              TRUE ~ LOCATION))%>%
  mutate(LOCATION = str_replace(LOCATION, "_", " ")) %>%
  mutate(LOCATION = str_replace(LOCATION, "_", " ")) %>% 
  mutate(BEAVER_PRESENCE = recode(BEAVER_PRESENCE, 
                         "Absence_" = "Absence",
                         "Food_cache_cuttings"="Cuttings")) %>%
  group_by(LOCATION) %>% 
  mutate(n_site = n()) %>% 
  ungroup()

bv.tally %>% 
  group_by(LOCATION, BEAVER_PRESENCE, n_site) %>%
  tally() %>% 
  ggplot(aes(x = reorder(LOCATION, n_site), y = n)) +
  geom_col(aes(fill = BEAVER_PRESENCE)) +
  coord_flip() +
  labs(x = "", y = "Number of plots", fill = "", caption = "2018 Beaver presence") +
  scale_fill_manual(values = c("ivory3", "cyan3")) +
  theme_minimal()

ggsave("./output/figures_exported/beaver_presence01.png", width = 6.25, height = 3.75, dpi=300)

  
bv.tally %>% 
  group_by(LOCATION, BEAVER_PRESENCE, n_site) %>%
  tally() %>% 
  ungroup() %>% 
  mutate(perc.cut = n/n_site*100) %>% 
  filter(BEAVER_PRESENCE == "Cuttings")

```

```{r}
#vtree status

sinfo.df %>%
  mutate(BEAVER_PRESENCE = recode(BEAVER_PRESENCE, 
                         "Absence_" = "Absence",
                         "Food_cache_cuttings"="Cuttings")) %>% 
  vtree::vtree(z = .,vars = "LOCATION BEAVER_PRESENCE")
  

```

```{r}
sinfo.df %>%
  filter(LOCATION == "Moraine_Park") %>% 
  mutate(BEAVER_PRESENCE = recode(BEAVER_PRESENCE, 
                         "Absence_" = "Absence",
                         "Food_cache_cuttings"="Cuttings")) %>% 
  vtree::vtree(z = .,vars = "LOCATION FENCED BURNED")
```

```{r}
bv.mcro <- csv.all.lc.mcro.df %>% 
  mutate(BEAVER_PRESENCE = recode(BEAVER_PRESENCE, 
                         "Absence_" = "Absence",
                         "Food_cache_cuttings"="Cuttings")) 

bv.mcro %>% 
  distinct(BEAVER_PRESENCE)

bv.mcro.sum <- bv.mcro %>% 
  select(SITE_ID, timeClass,BEAVER_PRESENCE,LOCATION, SITE_TYPE) %>%
  distinct() %>% 
  group_by(timeClass,BEAVER_PRESENCE, SITE_TYPE) %>%
  tally() %>% 
  ungroup() %>% 
  pivot_wider(names_from = BEAVER_PRESENCE, values_from = n) %>%
  mutate(perc.cuttings = 100* Cuttings/(Cuttings + Absence)) %>% 
  mutate(perc.abs = 100 - perc.cuttings)

bv.mcro.sum %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  arrange(desc(SITE_TYPE,timeClass)) %>% 
  gt()
  

```


```{r}

# sinfo.df %>% 
#   distinct(MOOSE_PRESENCE)

# inconsistent encoding of MOOSE_PRESENCE 

# # A tibble: 10 x 1
#    MOOSE_PRESENCE             
#    <chr>                      
#  1 Absence_                   
#  2 Browse                     
#  3 Browse/Tracks              
#  4 Browse_tracks              
#  5 Tracks                     
#  6 Scat_beds_                 
#  7 Browse_scat_tracks         
#  8 Browse_scat                
#  9 Scat                       
# 10 Browse_scat_tracks_sighting

sinfo.df <- sinfo.df %>%
  mutate(MOOSE_PRESENCE2 = recode(MOOSE_PRESENCE, 
                         "Absence_" = "Absence",
                         "Browse_tracks"="Presence",
                         "Browse/Tracks"="Presence",
                         "Browse_scat"="Presence",
                         "Browse_scat_tracks"="Presence",
                         "Browse_scat_tracks_sighting" = "Presence",
                         "Scat_beds_" = "Presence"
                         )) %>% 
  mutate(MOOSE_PRESENCE = recode(MOOSE_PRESENCE, 
                         "Absence_" = "Absence",
                         "Browse_tracks"="Browse/tracks",
                         "Browse/Tracks"="Browse/tracks",
                         "Browse_scat"="Browse/scat",
                         "Browse_scat_tracks"="Browse/scat/tracks",
                         "Browse_scat_tracks_sighting" = "Browse/scat/tracks/sighting",
                         "Scat_beds_" = "Scat/beds"
                         )) 

sinfo.df %>% 
  tabyl(MOOSE_PRESENCE) %>%
  rename('Moose presence' = 'MOOSE_PRESENCE') %>% 
  gt::gt() %>% 
  fmt_number(
    columns = vars(percent),
    decimals = 2
    ) %>% 
  tab_header(
    title = "Moose presence in 2018"
  )

# sinfo.df %>%
#   tabyl(MOOSE_PRESENCE2) %>%
#   rename('Moose presence' = 'MOOSE_PRESENCE2') %>% 
#   gt::gt() %>% 
#   fmt_number(
#     columns = vars(percent),
#     decimals = 2
#     ) %>% 
#   tab_header(
#     title = "Moose presence in 2018"
#   )

```


```{r Moose, eval=TRUE}
#### Observations of moose presence noted in plots
# > How best to use these obserations? 
# **Variable: MOOSE_PRESENCE**


mcro.moose <- csv.all.lc.mcro.df %>% 
  mutate(moose = case_when(MOOSE_PRESENCE == "Absence_" ~ "Absent",
                           MOOSE_PRESENCE != "Absent" ~ "Present",
                           TRUE ~ MOOSE_PRESENCE))

mcro.moose.tally <- mcro.moose %>% 
  select(c(SITE_ID, moose, yr, LOCATION, BURNED, FENCED, timeClass)) %>% 
  distinct() %>% 
  group_by(timeClass, LOCATION) %>% 
  mutate(n_plots_in_loc = n()) %>% 
  ungroup() 

mcro.moose.tally <- mcro.moose.tally %>%
  filter(!is.na(LOCATION)) %>%
  group_by(timeClass, moose, LOCATION, n_plots_in_loc) %>% 
  # mutate(n_plots_in_loc_sign = n()) %>% 
  tally() %>%
  ungroup() %>%
  mutate(perc_moose = n/n_plots_in_loc * 100) 

mcro.moose.tally.n <- mcro.moose.tally %>% 
  group_by(timeClass, moose, LOCATION) %>%
  tally() %>% 
  ungroup()
```

```{r}
## moose plotting
mcro.moose.tally %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(LOCATION != "Kawuneeche") %>% 
  mutate(timeClass = forcats::fct_rev(timeClass)) %>%
  ggplot(aes(x = timeClass, y = perc_moose)) +
  geom_col(aes(fill = moose), width = .7) +
  facet_wrap(~LOCATION, ncol = 3) +
  theme_minimal() +
  labs(x = "", y = "% plots", fill = "") +
  scale_fill_manual(values = c("ivory3", "cyan3"))

# ggsave("./output/figures_exported/moose_presence_absence01.png", width = 6.25, height = 3.75, dpi=300)

mcro.moose.tally %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(LOCATION != "Kawuneeche") %>% 
  filter(moose =="Present") %>% 
  mutate(timeClass = forcats::fct_rev(timeClass))%>%
  ggplot(aes(x = timeClass, y = perc_moose)) +
  geom_col(aes(fill = moose), width = 0.7) +
  facet_wrap(~LOCATION, ncol = 3) +
  theme_minimal() +
  labs(x = "", y = "% plots", fill = "") +
  scale_fill_manual(values = c("ivory4", "blue")) +
  theme(legend.position = "none") 
  
# ggsave("./output/figures_exported/moose_presence01.png", width = 6.25, height = 3.75, dpi=300)

mcro.moose.tally %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  datatable()


csv.all.lc.mcro.df %>% 
  group_by(SITE_ID, MOOSE_PRESENCE, yr) %>% 
  filter(MOOSE_PRESENCE != "Absence_") %>%
  tally() %>% 
  dplyr::select(-n) %>% 
  datatable()

```

```{r}

# fun.desc.post1.gt(kv.stmod_stmcnt1) %>% 
#   gt::gtsave(filename = "./output/tables/AK_kv.stmod_stmcnt1_posteriors.rtf")

```



# Aspen 

**Master excel file: Aspen_Data_Baseline_through_2018.xlsx**

The excel datafile provided by RMNP (Aspen_Data_Baseline_Through_2018.xlsx) includes **10 tabs**.

```{r}
## **Data import** 
asp <- readxl::excel_sheets("./data/EVMP_data/TenYearReview/Aspen_Data_Baseline_Through_2018.xlsx")

path <- ("data/EVMP_data/TenYearReview/Aspen_Data_Baseline_Through_2018.xlsx")

#### Read in the worksheets and create list of df
# each tab is a df in the list object
asp.d <- path %>% 
  excel_sheets() %>% 
  set_names() %>% 
  map(read_excel, path = path, na = "NA")  

# asp.d$`Aspen Baseline Stem Tallies` %>% 
#   View()

```



```{r}

### check out 'keep' and 'discard'

######
## site info tabs. read and clean
asp.siteinfo2018 <- asp.d$'Aspen 2018 Site Info'
asp.siteinfo2018 <- asp.siteinfo2018 %>% 
  filter(!is.na(DATE))
# write_csv(asp.siteinfo2018, "./data/EVMP_derived/asp_siteinfo2018.csv")

asp.siteinfo_baseline <- asp.d$'Aspen Baseline Site Info'
asp.siteinfo_baseline <- asp.siteinfo_baseline %>% 
  filter(!is.na(DATE))
# write_csv(asp.siteinfo_baseline, "./data/EVMP_derived/asp_siteinfoBaseline.csv")

######

## select the tabs with tally data
asp.d.sel <- asp.d[c(3,4,5,6,8,10)] 

## combine
asp.tally.all <- bind_rows(asp.d.sel, .id = "tab") 

## fix inconsistent labels
asp.tally.all <- 
  asp.tally.all %>% 
  mutate(SITE_ID = case_when(SITE_ID == "AC1" ~ "AC01",
                       SITE_ID == "AC2" ~ "AC02",
                       SITE_ID == "AC3" ~ "AC03", 
                       SITE_ID == "AC4" ~ "AC04", 
                       SITE_ID == "AC4" ~ "AC04",
                       SITE_ID == "AC5" ~ "AC05",
                       SITE_ID == "AC6" ~ "AC06", 
                       SITE_ID == "AC7" ~ "AC07", 
                       SITE_ID == "AC8" ~ "AC08",
                       SITE_ID == "AC9" ~ "AC09",
                       SITE_ID == "ANC1" ~ "ANC01",
                       SITE_ID == "ANC1" ~ "ANC01",
                       SITE_ID == "ANC2" ~ "ANC02",
                       SITE_ID == "ANC3" ~ "ANC03", 
                       SITE_ID == "ANC4" ~ "ANC04", 
                       SITE_ID == "ANC4" ~ "ANC04",
                       SITE_ID == "ANC5" ~ "ANC05",
                       SITE_ID == "ANC6" ~ "ANC06", 
                       SITE_ID == "ANC7" ~ "ANC07", 
                       SITE_ID == "ANC8" ~ "ANC08",
                       SITE_ID == "ANC9" ~ "ANC09",
                       SITE_ID == "AK1" ~ "AK01",
                       SITE_ID == "AK2" ~ "AK02",
                       SITE_ID == "AK3" ~ "AK03", 
                       SITE_ID == "AK4" ~ "AK04", 
                       SITE_ID == "AK4" ~ "AK04",
                       SITE_ID == "AK5" ~ "AK05",
                       SITE_ID == "AK6" ~ "AK06", 
                       SITE_ID == "AK7" ~ "AK07", 
                       SITE_ID == "AK8" ~ "AK08",
                       SITE_ID == "AK9" ~ "AK09",
                       TRUE ~ as.character(SITE_ID))
  )


## join in site info

asp.tally.all <- left_join(asp.tally.all, site.info.clean, by = "SITE_ID")

## make the 'NA' for the 'SITE_TYPE' field 'N' instead
asp.tally.all <- asp.tally.all %>% 
  mutate(FENCED = case_when(FENCED == "NA_" ~ "N",
                            is.na(FENCED) ~ "N",
                            TRUE ~ as.character(FENCED))
  ) 


## clean up BURNED: 'NA' to 'N'
asp.tally.all <- 
  asp.tally.all %>%
  mutate(BURNED = case_when(is.na(BURNED) ~ 'Unburned',
                            TRUE ~ as.character(BURNED)))

### write table
# write_csv(asp.tally.all, "./data/EVMP_derived/asp_tally_all.csv")

```


```{r, eval=FALSE}

asp.tally.all %>% 
  group_by(BURNED, FENCED) %>% 
  tally()%>% 
  gt::gt()

# aspen combined variable names
asp.tally.all %>% 
  names() %>% 
  enframe() %>% 
  gt::gt()

```


```{r, eval=FALSE}
# asp.d.sel.comb %>% 
#   janitor::tabyl(tab,SITE_TYPE) %>% 
#   flextable()
# _Tally of records by tab and core, non-core, and Kawuneeche Valley sites_

asp.tally.all %>% 
  janitor::tabyl(tab,SITE_TYPE) %>% 
  gt::gt()

```


_Tally of records by year and core, non-core, and Kawuneeche Valley sites_
```{r}
asp.tally.all %>% 
  janitor::tabyl(YEAR,SITE_TYPE) %>% 
  gt::gt()

```

_Tally of records by site type (e.g., core, non-core, and Kawuneeche Valley sites) and fenced status_
```{r}

asp.tally.all %>% 
  janitor::tabyl(SITE_TYPE, FENCED) %>% 
  gt::gt()

```

```{r}
asp.tally.all %>% 
  filter(SITE_TYPE == 'AK') %>% 
  select(SITE_ID, contains("DB")) %>% 
  gt()
```

_Tally of records by SITE_ID and YEAR_
```{r}

asp.gt1 <- asp.tally.all %>% 
  janitor::tabyl(SITE_ID, YEAR) %>% 
  gt::gt()

## tbl formatting
# asp.gt1 <- asp.gt1 %>% 
#   tab_style(
#     style = list(
#       cell_fill(color = "lightcyan"),
#       cell_text(weight = "bold")
#       ),
#     locations = cells_data(
#       columns = vars('2006', '2007'),
#       rows = SITE_ID == "2")
#   ) 
# asp.gt1

```


```{r}

## tidy the dbh
asp.tally.dbh.tidy <- asp.tally.all %>%
  pivot_longer(
    cols = starts_with("DBH"),
    names_to = "DBHclass",
    values_to = "DBHval"
  )

asp.tally.dbh.tidy <- asp.tally.dbh.tidy %>% 
  select(-contains("HT_"))


## tidy the height
asp.tally.ht.tidy <- asp.tally.all %>%
  pivot_longer(
    cols = starts_with("HT_"),
    names_to = "HTclass",
    values_to = "HTval"
  )

asp.tally.ht.tidy <- asp.tally.ht.tidy %>% 
  select(-contains("DBH"))

```


```{r asp_dbhmod}
## mod the dbh
asp.tally.dbh.tidy <- asp.tally.dbh.tidy %>% 
  mutate(DBHclassFact = as_factor(DBHclass))

asp.tally.dbh.tidy <- asp.tally.dbh.tidy %>% 
  mutate(timeClass = case_when(YEAR == 2006 ~ "BL",
                               YEAR == 2007 ~ "BL",
                               YEAR == 2008 ~ "BL",
                               YEAR == 2009 ~ "BL",
                               TRUE ~ as.character(YEAR))) %>%  
  mutate(timeClass = factor(timeClass, levels = c("BL", "2013","2015","2016","2017","2018")))  # set as factor, set levels


### reanme the HTval to something more easily interpreted 

## Convert stem counts to density 
## 4046.86 m2 = 1 acre conversion
## plot is 25m2
## scaler is: 161.8744   
## i.e., 1 stem/m2 = 161.8744 stems/acre


asp.tally.dbh.tidy <- 
  asp.tally.dbh.tidy %>% 
  rename(stemTally = DBHval) 

## Create a new field to combine the 2cm dbh bands into smaller number of classes. 
# write a table to use as look-up
# asp.tally.tidy %>% 
#   distinct(DBHclassFact) %>% 
#   write_csv('./data/EVMP_derived/DBHclassFact_lu.csv')

# read in the lu
dbh.lu <- read_csv('./data/EVMP_derived/DBHclassFact_lu.csv')

asp.tally.dbh.tidy <- left_join(asp.tally.dbh.tidy, dbh.lu, by = "DBHclassFact")

## correct misattributed FENCED
asp.tally.dbh.tidy <- asp.tally.dbh.tidy %>% 
  mutate(FENCED = case_when(FENCED == "N" ~ "Unfenced",
                            TRUE ~ FENCED))

## fix issue of missing "RANTE TYPE" attributes
asp.tally.dbh.tidy <- asp.tally.dbh.tidy %>% 
  # filter(is.na(RANGE_TYPE))
  mutate(RANGE_TYPE = case_when(is.na(RANGE_TYPE) & SITE_TYPE == "AC" ~ "core winter range",
                     is.na(RANGE_TYPE) & SITE_TYPE == "ANC" ~ "non-core winter range",
                     is.na(RANGE_TYPE) & SITE_TYPE == "AK" ~ "Kawuneeche Valley",
                     TRUE ~ RANGE_TYPE))


## collapse the tallies by DBHclGp01
asp.tally.dbh.tidy <- asp.tally.dbh.tidy %>%
  group_by(SITE_ID, timeClass, SITE_TYPE, REMOVED, BURNED, FENCED, VALLEY, RANGE_TYPE, LIVE_DEAD, DBHclGp01) %>% 
  summarise(stemTally = sum(stemTally), mean.tally = mean(stemTally, na.rm = TRUE)) %>%
  ungroup() %>% 
  mutate(stemDen.ha = stemTally *400) %>% # converts stems/2m2 plot to stems/ha
  mutate(stemDen.ac = stemTally *161.8744) # converts stems/2m2 plot to stems/acre

```

```{r}
## live stems WINTER RANGE
asp.tally.dbh.tidy %>% 
  filter(timeClass == "BL" | timeClass == "2013" |timeClass == "2018") %>% 
  filter(SITE_TYPE != "AK") %>% 
  filter(LIVE_DEAD == "LIVE") %>% 
  ggplot(aes(FENCED, stemDen.ha)) +
  geom_boxplot(aes(fill = timeClass)) +
  facet_wrap(~DBHclGp01) +
  scale_y_log10() +
  theme_minimal() 

```


```{r asp_htMod}
## mod the ht
asp.tally.ht.tidy %>% 
  distinct(YEAR)

asp.tally.ht.tidy <- asp.tally.ht.tidy %>% 
  mutate(timeClass = case_when(YEAR == 2006 ~ "BL",
                               YEAR == 2007 ~ "BL",
                               YEAR == 2008 ~ "BL",
                               YEAR == 2009 ~ "BL",
                               TRUE ~ as.character(YEAR))) %>% 
  mutate(timeClass = factor(timeClass, levels = c("BL", "2013","2015","2016","2017","2018")))  # set as factor, set levels

### rename the HTval to something more easily interpreted
### then convert to stem density/ha
asp.tally.ht.tidy <- 
  asp.tally.ht.tidy %>% 
  rename(stemTally = HTval) %>% 
  mutate(stemDen.ha = stemTally *400) %>% # converts stems/25m2 plot to stems/ha
  mutate(stemDen.ac = stemTally *161.8744) # converts stems/25m2 plot to stems/acre

```

## Stem count by diameter

### Core winter range


```{r asp_dbh_tileTally}

asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "core winter range") %>% 
  filter(timeClass == "BL" | timeClass == "2013" |timeClass == "2018") %>% 
  # filter(SITE_ID == "AC60") %>% select(-contains("UT")) %>% datatable()
  # ggplot(aes(timeClass, DBHclGp01)) +
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = FENCED), color = "white", alpha = .2) +
  geom_text(aes(label = stemTally), size = 3) +
  facet_wrap(~SITE_ID) +
  # facet_grid(FENCED~SITE_ID) +
  theme_minimal() +
  labs(x = "", y = "", title = "Aspen live stem tallies", subtitle = "Core winter range") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r, eval=TRUE}

asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>%
  filter(RANGE_TYPE == "core winter range") %>% 
  filter(timeClass == "BL" | timeClass == "2013" |timeClass == "2018") %>%
  group_by(timeClass,DBHclGp01, FENCED,VALLEY) %>%
  summarise(mean.tally = round(mean(stemTally, na.rm=TRUE),1)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = mean.tally), color = "white", alpha = .2) +
  # geom_tile(fill = "grey90", color = "white", alpha = .2) +
  geom_text(aes(label = mean.tally), size = 3) +
  facet_grid(FENCED~VALLEY) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean tally", title = "Mean aspen live stem tallies", caption = "Core winter range plots only") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

**Mean aspen stem count**

```{r}
asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>%
  # filter(RANGE_TYPE == "core winter range") %>% 
  filter(timeClass == "BL" | timeClass == "2013" |timeClass == "2018") %>%
  group_by(timeClass,DBHclGp01, FENCED,SITE_TYPE) %>%
  summarise(mean.tally = round(mean(stemTally, na.rm=TRUE),1)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = mean.tally), color = "white", alpha = .2) +
  # geom_tile(fill = "grey90", color = "white", alpha = .2) +
  geom_text(aes(label = mean.tally), size = 3) +
  facet_grid(FENCED~SITE_TYPE) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean tally", title = "Mean aspen live stem tallies", caption = "all aspen plots") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


### Non-core winter range

```{r}
asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>%
  filter(RANGE_TYPE == "non-core winter range") %>% 
  filter(timeClass == "BL" | timeClass == "2013" |timeClass == "2018") %>%
  group_by(timeClass,DBHclGp01, FENCED,VALLEY) %>%
  summarise(mean.tally = round(mean(stemTally, na.rm=TRUE),1)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = mean.tally), color = "white", alpha = .2) +
  # geom_tile(fill = "grey90", color = "white", alpha = .2) +
  geom_text(aes(label = mean.tally), size = 3) +
  facet_grid(FENCED~VALLEY) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean tally", title = "Mean aspen live stem tallies", caption = "Non-core winter range plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

### Kawuneeche Valley

```{r}
asp.tally.dbh.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>%
  filter(SITE_TYPE == "AK") %>% 
  filter(timeClass == "BL" | timeClass == "2013" |timeClass == "2018") %>%
  group_by(timeClass,DBHclGp01, FENCED,VALLEY) %>%
  summarise(mean.tally = round(mean(stemTally, na.rm=TRUE),1)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = mean.tally), color = "white", alpha = .2) +
  # geom_tile(fill = "grey90", color = "white", alpha = .2) +
  geom_text(aes(label = mean.tally), size = 3) +
  facet_grid(FENCED~VALLEY) +
  theme_minimal() +
  labs(x = "", y = "", fill = "Mean tally", title = "Mean aspen live stem tallies", caption = "Kawuneeche Valley plots only") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

## Live stem density

### Core winter range

```{r, fig.height=8, fig.width=8}
asp.tally.dbh.tidy %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(SITE_ID != "AC01") %>% 
  filter(SITE_ID != "AC14") %>% 
  filter(SITE_ID != "AC68") %>% 
  mutate(SITE_ID = glue::glue('{SITE_ID}({FENCED})')) %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "core winter range") %>% 
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = stemDen.ac), color = "white") +
  scale_fill_viridis_c() +
  geom_text(aes(label = round(stemDen.ac,0)),color = "white", size = 2.7) +
  facet_wrap(~SITE_ID, ncol = 6) +
  theme_minimal() +
  labs(x = "", y = "", title = "Aspen live stem density", subtitle = "Core winter range", fill = "Stems/acre", y = "DBH class") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures_exported/AC_ht_stemsAc_tile_revised.png", width = 9.75, height = 8.5)

```

```{r, eval=TRUE}
## summary table
## Time class FENCED SITE_TYPE

asp.tally.dbh.tidy %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(LIVE_DEAD == 'LIVE') %>% 
  # filter(RANGE_TYPE == "core winter range") %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, SITE_TYPE) %>% 
  summarytools::descr(var = stemDen.ha,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, 'Site type' = SITE_TYPE) %>% 
  gt() %>% 
  tab_header(title = "Aspen stem density") # %>% 
  # gt::gtsave(file = "./output/tables/summary_asp_den_tc_sitetype.rtf")

### add fencing
asp.tally.dbh.tidy %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(LIVE_DEAD == 'LIVE') %>% 
  # filter(RANGE_TYPE == "core winter range") %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, FENCED, SITE_TYPE) %>% 
  summarytools::descr(var = stemDen.ha,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, 'Site type' = SITE_TYPE) %>% 
  gt() %>% 
  tab_header(title = "Aspen stem density") #%>% 
  # gt::gtsave(file = "./output/tables/summary_asp_den_tc_sitetype_fencing.rtf")

## add just burning
asp.tally.dbh.tidy %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(LIVE_DEAD == 'LIVE') %>% 
  # filter(RANGE_TYPE == "core winter range") %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, BURNED, SITE_TYPE) %>% 
  summarytools::descr(var = stemDen.ha,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, 'Site type' = SITE_TYPE) %>% 
  gt() %>% 
  tab_header(title = "Aspen stem density") #%>% 
  # gt::gtsave(file = "./output/tables/summary_asp_den_tc_sitetype_burn.rtf")

## add just burning
asp.tally.dbh.tidy %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(LIVE_DEAD == 'LIVE') %>% 
  # filter(RANGE_TYPE == "core winter range") %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, FENCED, BURNED, SITE_TYPE) %>% 
  summarytools::descr(var = stemDen.ha,
                      stats = "common") %>% 
  tb() %>% 
  mutate_if(is.numeric, round,1) %>% 
  select(-c(variable,pct.valid)) %>% 
  rename("Time class" = timeClass, 'Site type' = SITE_TYPE) %>% 
  gt() %>% 
  tab_header(title = "Aspen stem density") #%>% 
  # gt::gtsave(file = "./output/tables/summary_asp_den_tc_sitetype_fenceXburn.rtf")

```


```{r}
asp.tally.dbh.tidy %>%
  mutate(SITE_ID = glue::glue('{SITE_ID}({FENCED})')) %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "core winter range") %>% 
  # filter(SITE_ID == "AC60") %>% select(-contains("UT")) %>% datatable()
  # ggplot(aes(timeClass, DBHclGp01)) +
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = stemDen.ac), color = "white", alpha = .52) +
  scale_fill_viridis_c() +
  geom_text(aes(label = round(stemDen.ac,0)),size = 2.7) +
  facet_wrap(~SITE_ID, ncol = 6) +
  # facet_grid(FENCED~SITE_ID) +
  theme_minimal() +
  labs(x = "", y = "", title = "Aspen live stem density", subtitle = "Core winter range", fill = "Stems/acre", y = "DBH class") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


### Non-core winter range

```{r, fig.height=6, fig.width=6}
asp.tally.dbh.tidy %>%
  mutate(SITE_ID = glue::glue('{SITE_ID}({FENCED})')) %>% 
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "non-core winter range") %>% 
  # filter(SITE_ID == "AC60") %>% select(-contains("UT")) %>% datatable()
  # ggplot(aes(timeClass, DBHclGp01)) +
  ggplot(aes(timeClass, DBHclGp01)) +  
  geom_tile(aes(fill = stemDen.ac), color = "white") +
  scale_fill_viridis_c() +
  geom_text(aes(label = round(stemDen.ac,0)),color = "white", size = 2.7) +
  facet_wrap(~SITE_ID, ncol = 4) +
  theme_minimal() +
  labs(x = "", y = "", title = "Aspen live stem density", subtitle = "Non-core winter range", fill = "Stems/acre", y = "DBH class") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("./output/figures_exported/ANC_diam_stemsAc_tile_rev.png", width = 7.5, height = 5.5)

```

#### Kawuneeche Valley

```{r, fig.height=3.75, fig.width=5}
asp.tally.dbh.tidy %>%
  # distinct(RANGE_TYPE)
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "Kawuneeche Valley") %>% 
  # filter(SITE_ID == "AC60") %>% select(-contains("UT")) %>% datatable()
  # ggplot(aes(timeClass, DBHclGp01)) +
  ggplot(aes(timeClass, DBHclGp01)) +  
  # geom_tile(aes(fill = stemDen.ac), color = "white") +
  geom_tile(aes(fill = stemDen.ac), color = "white") +
  scale_fill_viridis_c() +
  geom_text(aes(label = round(stemDen.ac,0)),color = "white", size = 2.7) +
  facet_wrap(~SITE_ID, ncol = 4) +
  theme_minimal() +
  labs(x = "", y = "", title = "Aspen live stem density", subtitle = "Kawuneeche Valley", fill = "Stems/acre", y = "DBH class") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures_exported/AK_diam_stemsAc_tile_revised.png", width = 5.5, height = 3.5)

```



```{r}
#### Aspen: live stem density summary table
asp.den.summary <- asp.tally.dbh.tidy %>%
  # filter(is.na(RANGE_TYPE))
  filter(LIVE_DEAD == 'LIVE') %>% 
  group_by(timeClass, RANGE_TYPE, FENCED) %>% 
  summarise(mean.den.ac = round(mean(stemDen.ac, na.rm=TRUE), 1), sd.den.ac = round(sd(stemDen.ac,na.rm=TRUE),1), median.den.ac = round(median(stemDen.ac, na.rm=TRUE),1), iqr.den.ac = round(IQR(x = stemDen.ac, type = 8, na.rm = TRUE),1), max.den.ac = round(max(stemDen.ac),1),n = n())


asp.den.summary %>% 
  datatable(filter="bottom")

```

```{r}
asp.den.summary %>% 
  pivot_wider(names_from = FENCED,
              values_from = c(median.den.ac, mean.den.ac)) %>% 
  datatable()


```

_DBH classes: Fenced plots_
```{r}
## DBH
dbh.perc.f <- asp.tally.dbh.tidy %>%
  # filter(is.na(REMOVED)) %>% 
  # filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  filter(FENCED == "Fenced") %>%
  # filter(SITE_TYPE == "AC") %>%
  # filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) 


## heatmap
dbh.perc.f %>%
  # datatable()
  # distinct(timeClass)
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(DBHclGp01, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'white') +
  facet_grid(.~timeClass) +
  scale_fill_viridis_c(begin = .01, end = .9, direction = -1) +
  theme_minimal() +
  labs(x = "DBH class", y = "", fill = "", title = "Proportion of Live Aspen Stems by DBH Class", subtitle = "Fenced and unburned plots only")

# ggsave("./output/figures/AC_Live_Fenced_Unburned_PropDBH_heatmap.png", width = 7, height = 5, dpi = 300)

dbh.perc.f %>%
  filter(SITE_ID != "AC67") %>% 
  filter(!is.nan(percentTot)) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, percentTot)) +
  # geom_col(aes(fill = DBHclGp01), color = "darkgray") +
  geom_col(aes(fill = DBHclGp01)) +
  facet_wrap(~SITE_ID, ncol = 5) +
  # scale_fill_manual(values = c("bisque1", "bisque3", "bisque4")) +
  scale_fill_manual(values = c("honeydew2", "honeydew3", "darkolivegreen")) +
  scale_fill_grey() +
  # theme_minimal() +
  theme_minimal() +
  labs(y = "% total stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", caption = "Fenced plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent)

# ggsave("./output/figures_exported/AC_Live_Fenced_PropDBH_bw.png", width = 8, height = 6, dpi = 300)


```


_DBH classes: Fenced burned plots_
```{r}
## DBH
dbh.perc2 <- asp.tally.dbh.tidy %>%
  filter(is.na(REMOVED)) %>% 
  filter(BURNED == "Burned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  filter(FENCED == "Fenced") %>%
  filter(SITE_TYPE == "AC") %>%
  # filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) 

dbh.perc2 %>%
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(SITE_ID, percentTot)) +
  # geom_col(aes(fill = DBHclGp01), color = "darkgray") +
  geom_col(aes(fill = DBHclGp01)) +
  facet_wrap(~timeClass, ncol = 3) +
  # scale_fill_viridis_d(option = "D") +
  # theme_minimal() +
  theme_minimal() +
  labs(y = "Proportion of stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", subtitle = "Fenced and burned plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "top")
  
# ggsave("./output/figures/AC_Live_Fenced_Burned_PropDBH_barChart.png", width = 8, height = 6, dpi = 300)

dbh.perc2 %>%
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(timeClass, percentTot)) +
  # geom_col(aes(fill = DBHclGp01), color = "darkgray") +
  geom_col(aes(fill = DBHclGp01)) +
  facet_wrap(~SITE_ID, ncol = 3) +
  # scale_fill_viridis_d(option = "D") +
  scale_fill_manual(values = c("honeydew2", "honeydew3", "darkolivegreen")) +
  # theme_minimal() +
  theme_minimal() +
  labs(y = "Proportion of stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", subtitle = "Fenced and burned plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent)

# ggsave("./output/figures/AC_Live_Fenced_Burned_PropDBH_bc.png", width = 8, height = 6, dpi = 300)

```


_DBH classes: Unfenced plots_
```{r}
## DBH
dbh.perc3 <- asp.tally.dbh.tidy %>%
  filter(is.na(REMOVED)) %>% 
  # filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  filter(FENCED == "Unfenced") %>%
  filter(SITE_TYPE == "AC") %>%
  filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) 

# # heatmap
# dbh.perc3 %>%
#   filter(!is.nan(percentTot)) %>%
#   ggplot(aes(DBHclGp01, SITE_ID)) +
#   geom_tile(aes(fill = percentTot), color = 'white') +
#   facet_grid(.~timeClass) +
#   scale_fill_viridis_c(begin = .01, end = .9, direction = -1) +
#   theme_minimal() +
#   labs(x = "DBH class", y = "", fill = "% total stems", title = "Proportion of Live Aspen Stems by DBH Class", subtitle = "Unfenced and unburned plots only")

# ggsave("./output/figures/Asp_unFenced_unburned_Live_AC_PropDBH_heatmap02.png", width = 7, height = 5, dpi = 300)

# dbh.perc3 %>%
#   filter(!is.nan(percentTot)) %>%
#   ggplot(aes(SITE_ID, percentTot)) +
#   geom_col(aes(fill = DBHclGp01)) +
#   facet_wrap(~timeClass, ncol = 1) +
#   # scale_fill_viridis_d(option = "D") +
#   theme_minimal() +
#   labs(y = "% total stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", subtitle = "Unfenced and unburned plots only") +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#   theme(legend.position = "top") +
#   scale_y_continuous(labels=scales::percent) 

dbh.perc3 %>%
  filter(!is.nan(percentTot)) %>%
  filter(SITE_ID != "AC68" & SITE_ID != "AC09" & SITE_ID != "AC30" & SITE_ID != "AC07" & SITE_ID != "AC37" & SITE_ID != "AC39") %>% 
  ggplot(aes(timeClass, percentTot)) +
  geom_col(aes(fill = DBHclGp01)) +
  facet_wrap(~SITE_ID, ncol = 6) +
  # scale_fill_viridis_d(option = "D") +
  scale_fill_manual(values = c("honeydew", "honeydew3", "darkolivegreen")) +
  theme_minimal() +
  labs(y = "% total stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", captioned = "Unfenced plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent) 

# ggsave("./output/figures_exported/AC_Live_unfenced_PropDBH_bc.png", width = 8, height = 6, dpi = 300)

```

### Aspen DBH: Non-core winter range

_DBH classes: Non-fenced plots_
```{r}
## DBH
dbh.perc.anc <- asp.tally.dbh.tidy %>%
  filter(is.na(REMOVED)) %>% 
  # filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  # filter(FENCED == "N") %>%
  filter(SITE_TYPE == "ANC") %>%
  # filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) 

## bar plot
dbh.perc.anc %>%
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(timeClass, percentTot)) +
  # geom_col(aes(fill = DBHclGp01), color = "darkgray") +
  geom_col(aes(fill = DBHclGp01)) +
  facet_wrap(~SITE_ID, ncol = 5) +
  scale_fill_manual(values = c("honeydew2", "honeydew3", "darkolivegreen")) +
  theme_minimal() +
  labs(y = "% total stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", caption = "Non-core sites, all plots") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent) 
  
# ggsave("./output/figures_exported/ANC_Live_PropDBH_bc.png", width = 8, height = 6, dpi = 300)

```


### Aspen DBH: Kawuneeche Valley

_DBH classes: Unfenced and unburned plots_
```{r asp_dbh_KV}
## DBH
dbh.perc.kv <- asp.tally.dbh.tidy %>%
  filter(is.na(REMOVED)) %>% 
  # filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  # filter(FENCED == "N") %>%
  filter(SITE_TYPE == "AK") %>%
  # filter(timeClass %in% c('BL','2013','2018')) %>%
  # filter(timeClass == "BL" | timeClass == 2013 | timeClass == 2018) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) 


## bar plot
dbh.perc.kv %>%
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(timeClass, percentTot)) +
  # geom_col(aes(fill = DBHclGp01), color = "darkgray") +
  geom_col(aes(fill = DBHclGp01)) +
  facet_wrap(~SITE_ID, ncol = 4) +
  # scale_fill_viridis_d(option = "D") +
  # theme_minimal() +
  theme_minimal() +
  labs(y = "% total stems", x = "", fill = "DBH class", title = "Proportion of Live Aspen Stems by DBH Class", caption = "Kawuneeche Valley only") +
  scale_fill_manual(values = c("honeydew2", "honeydew3", "darkolivegreen")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent) 

# ggsave("./output/figures_exported/AK_Live_PropDBH_bc.png", width = 8, height = 6, dpi = 300)

```

### Proportion of plots with regeneration above threshold

```{r}

asp.tally.dbh.tidy %>%
  filter(is.na(REMOVED)) %>% 
  # filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  # filter(FENCED == "N") %>%
  # filter(SITE_TYPE == "ANC") %>%
  # filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass, FENCED, BURNED) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) %>% 
  group_by(FENCED) %>% 
  descr(stemDen.ac, stats = "common") %>% 
  tb() %>% 
  gt()

  
```

```{r}
asp.tally.dbh.tidy %>%
  filter(is.na(REMOVED)) %>% 
  # filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  # filter(FENCED == "N") %>%
  filter(SITE_TYPE != "AK") %>%
  # filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass, FENCED, BURNED) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) %>% 
  group_by(BURNED, FENCED) %>% 
  descr(stemDen.ac, stats = "common") %>% 
  tb() %>% datatable()
  
```


## Suckering by height class



```{r}

### Add Short/Tall stem field 
asp.tally.ht.tidy <- asp.tally.ht.tidy %>%
  mutate(FENCED = case_when(FENCED == "Y" ~ "Fenced",
                            FENCED == "N" ~ "Unfenced",
                            TRUE ~ FENCED)) %>% 
  mutate(shortTall = case_when(HTclass == 'HT_0_50_CM' ~ "short",
                               HTclass == 'HT_51_100_CM' ~ "short",
                               HTclass == 'HT_101_150_CM' ~ "short",
                               HTclass == 'HT_151_200_CM' ~ "tall",
                               HTclass == 'HT_201_250_CM' ~ "tall")
         )


asp.tally.ht.tidy %>% 
  distinct(HTclass, shortTall) %>%
  gt()

```

```{r}
## join in dbh with height classes

asp.dbh2join <- asp.tally.dbh.tidy %>%
  select(c(SITE_ID, timeClass, DBHclGp01)) 

asp.dbh2join %>%
  glimpse()

ht.dbh.class <- left_join(asp.tally.ht.tidy, asp.dbh2join) %>% 
  filter(LIVE_DEAD != "DEAD") %>% 
  select(c(SITE_TYPE, SITE_ID, timeClass, stemTally, stemDen.ac, BURNED, FENCED, RANGE_TYPE, VALLEY, DBHclGp01, HTclass, shortTall))


ht.dbh.class <- ht.dbh.class %>%
    mutate(RANGE_TYPE = case_when(grepl("AC", SITE_ID) & is.na(RANGE_TYPE) ~ "core winter range",
                            TRUE ~ RANGE_TYPE))

ht.dbh.class <- ht.dbh.class %>%
  mutate(HTclass.lbl = case_when(HTclass == "HT_0_50_CM" ~ "0-50 cm",
                                 HTclass == "HT_51_100_CM" ~ "51-100 cm",
                                 HTclass == "HT_101_150_CM" ~ "101-150 cm",
                                 HTclass == "HT_151_200_CM" ~ "151-200 cm",
                                 HTclass == "HT_201_250_CM" ~ "201+ cm",
                                 TRUE ~ "other"))

```


**Suckering: stems 1.5 m to 2.5 m in height**

```{r}
### suckering classes: by range type
# the following combines the tally for stems between 1.5 and 2.5 m
suckering.vtype <- ht.dbh.class %>%
    filter(HTclass == "HT_151_200_CM" |HTclass == "HT_201_250_CM") %>%
  group_by(SITE_ID, RANGE_TYPE, FENCED, timeClass) %>% 
  summarise(stemTally.1p5to2m = sum(stemTally)) %>%
  mutate(stemDen.ac = stemTally.1p5to2m *161.8744) %>% # converts stems/2m2 plot to stems/acre) %>% 
  # mutate(suckering_class = case_when(stemDen.ac < 1700 ~ "Poor (<1,700 stems/acre)",
  #                                  stemDen.ac >=1700 & stemDen.ac <4500 ~ "Moderate (1,700-4,500 stems/acre)",
  #                                  stemDen.ac >=4500 ~ "High (>4500 stems/acre)")) %>% 
  mutate(stemDen.ha = stemTally.1p5to2m *400) %>% 
  mutate(suckering_class = case_when(stemDen.ac < 1700 ~ "Poor",
                                   stemDen.ac >=1700 & stemDen.ac <4500 ~ "Moderate",
                                   stemDen.ac >=4500 ~ "High")) %>% 
  ungroup()

```

### All stems: core vs. non-core winter range
# FU below
```{r}
## fenced and unfenced
suckering.vtype %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "white") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  scale_fill_grey() +
  theme_minimal() +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "", caption = "Suckering: Stem density 1.5-2.5 m in ht. All plots") +
  facet_wrap(~RANGE_TYPE, scales = "free_y")

# ggsave("./output/figures_exported/AC_suck_1p5to2p5m.png", width = 6.5, height = 6)


## creat summary of above
suckering.vtype %>%
  # filter(!is.na(RANGE_TYPE)) %>%
  # mutate(timeClass = as.character(timeClass)) %>% 
  filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>%
  mutate(timeClass = fct_drop(timeClass)) %>%
  # group_by(RANGE_TYPE, timeClass, suckering_class) %>% 
  tabyl(timeClass, suckering_class) %>% 
  rowwise() %>%
  mutate(sum = sum(c_across(High:Poor))) %>% 
  mutate(perc.high = High/sum*100) %>%
  mutate(perc.mod = Moderate/sum*100) %>%
  mutate(perc.poor = Poor/sum*100) %>% 
  gt()


suckering.vtype %>%
  # filter(!is.na(RANGE_TYPE)) %>%
  mutate(timeClass = as.character(timeClass)) %>% 
  filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>%
  # mutate(timeClass = fct_drop(timeClass, only = "2018")) %>% 
  # group_by(RANGE_TYPE, timeClass, suckering_class) %>% 
  tabyl(timeClass, suckering_class) %>% 
  rowwise() %>%
  mutate(sum = sum(c_across(High:Poor))) %>% 
  mutate(perc.high = High/sum*100) %>%
  mutate(perc.mod = Moderate/sum*100) %>%
  mutate(perc.poor = Poor/sum*100) %>%
  pivot_longer(cols = contains("perc."),names_to = "perc_class") %>% 
  mutate(timeClass = fct_relevel(timeClass, "BL")) %>% 
  ggplot(aes(timeClass, value)) +
  geom_col(aes(fill = perc_class))


# df <- tibble(id = 1:4, w = runif(4), x = runif(4), y = runif(4), z = runif(4))
# df %>%
#   rowwise() %>%
#   mutate(
#     sum = sum(c_across(w:z)),
#     sd = sd(c_across(w:z))
#  )

```

### All stems: core winter range

```{r}
suckering.vtype %>%
  filter(!is.na(RANGE_TYPE)) %>% 
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  arrange(-stemDen.ac) %>% 
  datatable(rownames = FALSE, caption = "stemDen.ac aspen suckering 1.5 m to 2.5 m", filter = "top")

## broken out by fenced, just for AC
suckering.vtype %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(RANGE_TYPE == "core winter range") %>%
  # filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "white") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  scale_fill_grey() +
  theme_minimal() +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "", caption = "Suckering: Stem density 1.5 m to 2.5 m in ht. AC plots only") +
  # facet_grid(FENCED~RANGE_TYPE)
  facet_wrap(~FENCED, scales = "free_y")

# ggsave("./output/figures_exported/AC_suckering_1p5to2p5m_fenced.png", width = 5.5, height = 5)
```

### All stems: non-core winter range

All ANC plots unfenced.
```{r}
## broken out by fenced, just for AC
suckering.vtype %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(RANGE_TYPE == "non-core winter range") %>%
  # filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "white") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  scale_fill_grey() +
  theme_minimal() +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "", caption = "Suckering: Stem density 1.5 m to 2.5 m in ht. AC plots only") +
  # facet_grid(FENCED~RANGE_TYPE)
  facet_wrap(~FENCED, scales = "free_y")

# ggsave("./output/figures_exported/ANC_suckering_1p5to2p5m_fenced.png", width = 5.5, height = 5)
```



### All stems: response to burning
```{r}

suckering.vtype.burned.allHt <- ht.dbh.class %>%
  distinct() %>%
  # filter(HTclass == "HT_151_200_CM" |HTclass == "HT_201_250_CM") %>%
  group_by(SITE_ID, HTclass.lbl, DBHclGp01, RANGE_TYPE, FENCED, BURNED, timeClass) %>% 
  summarise(count = n(), stemTally.htclass = sum(stemTally), mean.tally = mean(stemTally, na.rm=TRUE)) %>%
  ungroup() %>% 
  mutate(stemDen.ac = stemTally.htclass *161.8744) %>% 
  mutate(stemDen.ha = round((stemTally.htclass*400),0)) # convert to ha

# suckering.vtype.burned.allHt %>% 
#   View()

####### burned ha
suckering.vtype.burned.allHt %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(BURNED == "Burned") %>% 
  filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = stemDen.ha), color = "white") +
  # geom_tile(aes(color = FENCED, fill = stemDen.ha)) + # scale_fill_grey() +
  theme_minimal() +
  # scale_fill_viridis(trans = "log") +
  scale_fill_viridis() +
  # scale_fill_gradient(low = "black", high = "grey") +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "stems/ha", caption = "Suckering: Stem density ha AC - BURNED") +
  facet_wrap(~HTclass.lbl, ncol = 5)
  
# ggsave("./output/figures_exported/AC_suck_burned_ht_class_den_ha.png", width = 7.5, height = 3.25)
# ggsave("./output/figures_exported/AC_suck_burned_ht_class_den_ha_bw.png", width = 7.5, height = 3.25)

####### burned acre
suckering.vtype.burned.allHt %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(BURNED == "Burned") %>% 
  filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = stemDen.ac), color = "white") +
  # geom_tile(aes(color = FENCED, fill = stemDen.ha)) + # scale_fill_grey() +
  theme_minimal() +
  # scale_fill_viridis(trans = "log") +
  scale_fill_viridis() +
  # scale_fill_gradient(low = "black", high = "grey") +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "stems/acre", caption = "Suckering: Stem density acre AC - BURNED") +
  facet_wrap(~HTclass.lbl, ncol = 5)
  
# ggsave("./output/figures_exported/AC_suck_burned_ht_class_den_acre.png", width = 7.5, height = 3.25)

## ha
suckering.vtype.burned.allHt %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(BURNED == "Burned") %>% 
  filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  # geom_tile(aes(fill = stemDen.ha), color = "white") +
  geom_text(aes(label = stemDen.ha),angle=45) +
  theme_minimal() +
  scale_fill_viridis() +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "stems/ha", caption = "Suckering: Stem density ha AC - BURNED") +
  facet_wrap(~HTclass.lbl, scales = "free_y", ncol = 5)

####### burned acre
suckering.vtype.burned.allHt %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(BURNED == "Burned") %>% 
  filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = stemDen.ac), color = "white") +
  # geom_tile(aes(color = FENCED, fill = stemDen.ha)) + # scale_fill_grey() +
  theme_minimal() +
  # scale_fill_viridis(trans = "log") +
  scale_fill_viridis() +
  # scale_fill_gradient(low = "black", high = "grey") +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "stems/acre", caption = "Suckering: Stem density acre AC - BURNED")

# ggsave("./output/figures_exported/AC_suck_burned_ht_class_den_acre.png", width = 7.5, height = 3.25)

### unburned ha
suckering.vtype.burned.allHt %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(BURNED == "Unburned") %>% 
  filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = stemDen.ha), color = "white") +
  # geom_tile(aes(color = FENCED, fill = stemDen.ha)) + # scale_fill_grey() +
  theme_minimal() +
  scale_fill_viridis() +
  # scale_fill_gradient(low = "black", high = "grey") +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "stems/ha", caption = "Suckering: Stem density ha AC - UNBURNED") +
  facet_wrap(~HTclass.lbl, ncol = 5)

# ggsave("./output/figures_exported/AC_suck_unburned_ht_class_den_ha.png", width = 7.5, height = 7.25)

### unburned acre
suckering.vtype.burned.allHt %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(BURNED == "Unburned") %>% 
  filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = stemDen.ac), color = "white") +
  # geom_tile(aes(color = FENCED, fill = stemDen.ha)) + # scale_fill_grey() +
  theme_minimal() +
  scale_fill_viridis() +
  # scale_fill_gradient(low = "black", high = "grey") +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "stems/acre", caption = "Suckering: Stem density acre AC - UNBURNED") +
  facet_wrap(~HTclass.lbl, ncol = 5)

# ggsave("./output/figures_exported/AC_suck_unburned_ht_class_den_acre.png", width = 7.5, height = 7.25)

```

```{r}
### unburned acre
suckering.vtype.burned.allHt %>%
  filter(!is.na(RANGE_TYPE)) %>%
  filter(BURNED == "Unburned") %>% 
  # filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = stemDen.ac), color = "white") +
  # geom_tile(aes(color = FENCED, fill = stemDen.ha)) + # scale_fill_grey() +
  theme_minimal() +
  scale_fill_viridis() +
  # scale_fill_gradient(low = "black", high = "grey") +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "stems/acre", caption = "Suckering: Stem density acre AC - UNBURNED") +
  facet_grid()
  # facet_wrap(~HTclass.lbl, ncol = 5)
```


### Tall stems (>1.5 m height)

```{r}
### just the stems >1.5 m
suckering.vtype.burned <- ht.dbh.class %>%
    filter(HTclass == "HT_151_200_CM" |HTclass == "HT_201_250_CM") %>%
  group_by(SITE_ID, RANGE_TYPE, FENCED, BURNED, timeClass) %>% 
  summarise(stemTally.1p5to2m = sum(stemTally)) %>%
  mutate(stemDen.ac = stemTally.1p5to2m *161.8744) %>% # converts stems/2m2 plot to stems/acre) %>% 
  # mutate(suckering_class = case_when(stemDen.ac < 1700 ~ "Poor (<1,700 stems/acre)",
  #                                  stemDen.ac >=1700 & stemDen.ac <4500 ~ "Moderate (1,700-4,500 stems/acre)",
  #                                  stemDen.ac >=4500 ~ "High (>4500 stems/acre)")) %>% 
  mutate(suckering_class = case_when(stemDen.ac < 1700 ~ "Poor",
                                   stemDen.ac >=1700 & stemDen.ac <4500 ~ "Moderate",
                                   stemDen.ac >=4500 ~ "High")) %>% 
  ungroup()

## Burned vs unburned AC
suckering.vtype.burned %>%
  filter(!is.na(RANGE_TYPE)) %>%
  # distinct(RANGE_TYPE)
  # filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(RANGE_TYPE == "core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "white") +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  scale_fill_grey() +
  theme_minimal() +
  # theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "", caption = "Suckering: Stem density 1.5-2.5 m in ht. AC") +
  facet_wrap(~BURNED, scales = "free_y")
  

# ggsave("./output/figures_exported/AC_suck_1p5to2p5m_AC_burned_bw.png", width = 4.5, height = 5.5)


#########
## Burned vs unburned ANC
suckering.vtype.burned %>%
  filter(!is.na(RANGE_TYPE)) %>%
  # distinct(RANGE_TYPE)
  # filter(RANGE_TYPE != "Kawuneeche Valley") %>%
  filter(RANGE_TYPE == "non-core winter range" ) %>%
  filter(timeClass %in% c("BL","2013","2018")) %>% 
  ggplot(aes(timeClass, SITE_ID)) +
  geom_tile(aes(fill = suckering_class), color = "white") +
  scale_fill_grey() +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  theme_minimal() +
  theme(legend.position = "top") +
  labs(x = "", y = "Site ID", fill = "", caption = "Suckering: Stem density 1.5-2.5 m in ht. ANC") +
  facet_wrap(~BURNED, scales = "free_y")

# ggsave("./output/figures_exported/suck_1p5to2p5m_ANC_burned_bw.png", width = 4.5, height = 5.5)

```

### Percent of plot in suckering class

```{r}
### calculate the percent of plots in different suckering classes for all factors and site types
suck.class.summary <- suckering.vtype.burned %>%
  group_by(RANGE_TYPE, BURNED, FENCED, timeClass) %>% 
  mutate(n_denom = n()) %>% 
  ungroup() %>% 
  group_by(RANGE_TYPE, BURNED, FENCED, timeClass,suckering_class, n_denom) %>% 
  tally() %>%
  mutate(perc_in_class = (round((n/n_denom*100),1))) %>% 
  ungroup()
  
suck.class.summary %>% 
  datatable()

## AC  
suck.class.summary %>%
  filter(RANGE_TYPE == "core winter range") %>% 
  ggplot(aes(timeClass,perc_in_class)) +
  geom_col(aes(fill = suckering_class)) +
  scale_fill_grey() +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  theme_minimal() +
  # theme(legend.position = "top") +
  labs(x = "", y = "% of plots in class", fill = "", caption = "Suckering: Stem density 1.5-2.5 m in ht. AC") +
  # geom_text(aes(label = perc_in_class)) +
  facet_wrap(~BURNED, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(BURNED ~ FENCED)

# ggsave("./output/figures_exported/suck_class_AC_burned_fenced_bw.png", width = 5.5, height = 3.75)

## alt text AC
suck.class.summary %>%
  filter(RANGE_TYPE == "core winter range") %>%
  ggplot(aes(timeClass,suckering_class)) +
  # geom_tile(aes(fill = BURNED), color = "WHITE") +
  # geom_col(aes(fill = suckering_class)) +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  theme_minimal() +
  # theme(legend.position = "top") +
  labs(x = "", y = "", fill = "", caption = "Suckering: Stem density 1.5-2.5 m in ht.") +
  geom_text(aes(label = perc_in_class)) +
  facet_wrap(BURNED~FENCED, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures_exported/suck_class_AC_burned_fenced_text.png", width = 5.5, height = 3.75)


## ANC  
suck.class.summary %>%
  filter(RANGE_TYPE == "non-core winter range") %>% 
  ggplot(aes(timeClass,perc_in_class)) +
  geom_col(aes(fill = suckering_class)) +
  scale_fill_grey() +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  theme_minimal() +
  # theme(legend.position = "top") +
  labs(x = "", y = "% of plots in class", fill = "", caption = "Suckering: Stem density 1.5-2.5 m in ht. ANC") +
  # geom_text(aes(label = perc_in_class)) +
  facet_wrap(~BURNED, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(BURNED ~ FENCED)

# ggsave("./output/figures_exported/suck_class_ANC_burned_fenced_bw.png", width = 5.5, height = 3.75)

## alt text ANC
suck.class.summary %>%
  filter(RANGE_TYPE == "non-core winter range") %>%
  ggplot(aes(timeClass,suckering_class)) +
  # geom_tile(aes(fill = BURNED), color = "WHITE") +
  # geom_col(aes(fill = suckering_class)) +
  # scale_fill_manual(values = c("darkgreen","green","grey90")) +
  theme_minimal() +
  # theme(legend.position = "top") +
  labs(x = "", y = "", fill = "", caption = "Suckering: Stem density 1.5-2.5 m in ht. ANC") +
  geom_text(aes(label = perc_in_class)) +
  facet_wrap(BURNED~FENCED, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}

# prop func
prop.fun <- function(x, cnt){
  x = x/cnt
  x
}

# suckering.vtype.tabyl %>% 
#   # glimpse()
#   # mutate(n = sum(`High (>4500 stems/acre)`,`Moderate (1,700-4,500 stems/acre)`,`Poor (<1,700 stems/acre)`)) %>% 
#   # mutate_if(.predicate = is.numeric, prop.fun())
#   gt()

# suckering.vtype %>% distinct(SITE_ID)

suckering.vtype <- suckering.vtype %>% 
  mutate(RANGE_TYPE = case_when(grepl("AC", SITE_ID) & is.na(RANGE_TYPE) ~ "core winter range",
                            TRUE ~ RANGE_TYPE)) 
#### calc the percent 
percent_suckering_class <- suckering.vtype %>% 
  filter(!is.na(RANGE_TYPE)) %>% 
  mutate(timeClass = as.character(timeClass)) %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  group_by(timeClass, RANGE_TYPE, suckering_class) %>% 
  summarise(sum_class = n()) %>% 
  ungroup() %>% 
  # tally()
  group_by(timeClass, RANGE_TYPE) %>% 
  mutate(n_allTimes = sum(sum_class)) %>% 
  ungroup() %>% 
  mutate(percent_in_class = 100*(sum_class/n_allTimes)) %>% 
  mutate(percent_in_class = round(percent_in_class, 1)) %>% 
  arrange(timeClass, suckering_class)
  
percent_suckering_class %>% 
  gt()
  
```

```{r}
# fig for report
percent_suckering_class %>% 
  mutate(timeClass = as_factor(timeClass)) %>%
  mutate(timeClass = relevel(timeClass, "BL")) %>% 
  ggplot(aes(timeClass, percent_in_class)) +
  geom_col(aes(fill = suckering_class)) +
  theme_minimal() +
  # scale_fill_manual(values = c("darkgreen","lightgreen","ivory3")) +
  scale_fill_grey() +
  labs(x = "", y = "Percent of plots", fill = "")  +
  facet_wrap(~RANGE_TYPE)# teme(legend.position = "top")

# ggsave("./output/figures_exported/suckering_proportion_all_plots_ht_class_bw2.png", width = 6.75, height = 3.95)

```

```{r}
#### calc the percent 
percent_suckering_class.vtype <- suckering.vtype %>% 
  filter(!is.na(RANGE_TYPE)) %>% 
  mutate(timeClass = as.character(timeClass)) %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  group_by(timeClass, suckering_class, RANGE_TYPE) %>% 
  summarise(sum_class = n()) %>% 
  ungroup() %>% 
  group_by(timeClass, RANGE_TYPE) %>% 
  mutate(n_allTimes = sum(sum_class)) %>% 
  ungroup() %>% 
  mutate(percent_in_class = 100*sum_class/n_allTimes) %>% 
  mutate(percent_in_class = round(percent_in_class, 1))
  

percent_suckering_class.vtype %>% 
  datatable()

```

```{r}
#### Fig for report
percent_suckering_class.vtype %>% 
  mutate(timeClass = as_factor(timeClass)) %>%
  mutate(timeClass = relevel(timeClass, "BL")) %>% 
  mutate(RANGE_TYPE = as_factor(RANGE_TYPE)) %>%
  mutate(RANGE_TYPE = relevel(RANGE_TYPE, "core winter range","non-core winter range")) %>%
  ggplot(aes(timeClass, percent_in_class)) +
  geom_col(aes(fill = suckering_class)) +
  # geom_text(aes(label = percent_in_class)) +
  theme_minimal() +
  scale_fill_grey() +
  # scale_fill_manual(values = c("darkgreen","lightgreen","ivory3")) +
  labs(x = "", y = "Percent of sites", fill = "") +
  facet_wrap(~RANGE_TYPE)

# ggsave("./output/figures_exported/suckering_proportion_all_plots_ht_class_rangety_bw3.png", width = 8, height = 3.85)

```


```{r}
ht.dbh.class %>%
  group_by(RANGE_TYPE, timeClass, BURNED, FENCED, DBHclGp01, HTclass) %>% 
  summarise(mean.stemDen.ac = mean_r1(stemDen.ac), sd.stemDen.ac = sd_r1(stemDen.ac), n = n()) %>% 
  datatable(filter = "bottom")

```

### Suckering: live unburned 
```{r}
ht.dbh.class.ub <- ht.dbh.class %>%
  filter(BURNED == "Unburned")

```


```{r asp_ht_clean}

## list of plot lacking a value for "RANGE_TYPE"
## on inspection, these have been dropped
## e.g., AC41 was washed away in 2013 floods (see E. Ertl 2018 notes)
## AC01 -  near Grand Lake
## None of these have data for 2018
# asp.tally.ht.tidy %>% 
#   filter(is.na(RANGE_TYPE)) %>% 
#   distinct(SITE_ID)
#   View()
# # A tibble: 5 x 1
#   SITE_ID
#   <chr>  
# 1 AC01   
# 2 AC21   
# 3 AC41   
# 4 AC12   
# 5 AC14

## CLEAN
asp.tally.ht.tidy <- asp.tally.ht.tidy %>%
  filter(!is.na(valley_full))  %>% ## drop the 4 plots
  filter(is.na(REMOVED))

### create a better 'HTclass' for plotting
asp.tally.ht.tidy <- 
  asp.tally.ht.tidy %>% 
  mutate(HTclass2 = case_when(HTclass == "HT_0_50_CM" ~ "0-50cm",
                              HTclass == "HT_51_100_CM" ~ "51-100cm",
                              HTclass == "HT_101_150_CM" ~ "101-150cm",
                              HTclass == "HT_151_200_CM" ~ "151-200cm",
                              HTclass == "HT_201_250_CM" ~ "201-250cm")
         )


# set as factor, set levels
asp.tally.ht.tidy <- 
  asp.tally.ht.tidy %>% 
  mutate(HTclass2 = factor(HTclass2, levels = c("0-50cm", "51-100cm","101-150cm","151-200cm","201-250cm")))

```

```{r}
## MP specific

asp.tally.ht.tidy %>%
  # group_by(VALLEY) %>% tally()
  filter(VALLEY == "MP") %>% 
  ggplot(aes(HTclass2, stemTally)) +
  geom_col(aes(fill = LIVE_DEAD)) +
  theme_minimal() +
  labs(x = "Height class", y = "Stem tally", fill = "", caption = "Moraine Park, all plots - Live/Dead") +
  facet_grid(SITE_ID ~ timeClass, as.table = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave(./output/figures_exported/MP_aspHt_stemTally.png, width = 6, height = 7.7, dpi = 300)

asp.tally.ht.tidy %>%
  # group_by(VALLEY) %>% tally()
  filter(FENCED == "Fenced") %>% 
  # filter(SITE_ID == "AC65") %>% 
  filter(VALLEY == "MP") %>% 
  ggplot(aes(HTclass2, stemTally)) +
  geom_col(aes(fill = LIVE_DEAD)) +
  labs(x = "Height class", y = "Stem tally", fill = "", caption = "Moraine Park, Fenced plots only - Live/Dead") +
  theme_minimal() +
  facet_grid(SITE_ID ~ timeClass, as.table = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures_exported/MP_aspHt_stemTally_fenced_only.png", width = 7.5, height = 4.7, dpi = 300)

## unfenced
asp.tally.ht.tidy %>%
  # group_by(VALLEY) %>% tally()
  filter(FENCED == "Unfenced") %>% 
  # filter(SITE_ID == "AC65") %>% 
  filter(VALLEY == "MP") %>% 
  ggplot(aes(HTclass2, stemTally)) +
  geom_col(aes(fill = LIVE_DEAD)) +
  labs(x = "Height class", y = "Stem tally", fill = "", caption = "Moraine Park, Unfenced plots only - Live/Dead") +
  theme_minimal() +
  facet_grid(SITE_ID ~ timeClass, as.table = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures_exported/MP_aspHt_stemTally_fenced_only.png", width = 6, height = 7.7, dpi = 300)

```

```{r}
### AC dead stems --  by fencing
asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  filter(LIVE_DEAD == "DEAD") %>%
  group_by(FENCED, BURNED, timeClass) %>% 
  summarise(median.tally = median(stemTally),mean.tally = mean(stemTally), sum.tally = sum(stemTally), iqr.tally = IQR(stemTally)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, mean.tally)) +
  geom_col(aes(fill = FENCED), position = "dodge") +
  theme_minimal() +
  scale_fill_grey() +
  labs(x = "", y = "Stem tally", fill = "", title = "Core winter range", caption = "AC plots - Sum of Dead Stems across all plots") 


# ggsave("./output/figures_exported/AC_sum_dead.png", width = 3.75, height = 4)

```

```{r}
### AC dead stems --  by fencing
asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  filter(LIVE_DEAD == "DEAD") %>%
  group_by(FENCED, BURNED, timeClass) %>% 
  summarise(median.tally = median(stemTally), sum.tally = sum(stemTally), iqr.tally = IQR(stemTally),mean.tally = mean(stemTally),) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, mean.tally)) +
  geom_col(aes(fill = FENCED), position = "dodge") +
  theme_minimal() +
  scale_fill_grey() +
  labs(x = "", y = "Stem count", fill = "", title = "Core winter range", caption = "AC plots - mean count of dead stems across all plots") +
  facet_wrap(~BURNED)


# ggsave("./output/figures_exported/AC_mean_dead_fenced_burned.png", width = 4.75, height = 3.5)

asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  filter(LIVE_DEAD == "DEAD") %>%
  group_by(FENCED, BURNED, timeClass) %>% 
  summarise(median.tally = median(stemTally), sum.tally = sum(stemTally), iqr.tally = IQR(stemTally),mean.tally = mean(stemTally),) %>% 
  ungroup() %>% 
  group_by(FENCED, BURNED, timeClass) %>%
  descr(mean.tally) %>% 
  tb() %>% 
  datatable()



asp.tally.ht.tidy %>%
  filter(SITE_TYPE == "AC") %>%
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  filter(LIVE_DEAD == "DEAD") %>%
  group_by(FENCED, BURNED, timeClass) %>% 
  summarise(median.tally = median(stemTally), sum.tally = sum(stemTally), iqr.tally = IQR(stemTally)) %>% 
  ungroup() %>% 
  ggplot(aes(timeClass, sum.tally)) +
  geom_text(aes(label = sum.tally)) +
  theme_minimal() +
  scale_fill_grey() +
  labs(x = "", y = "Stem tally", fill = "", title = "Core winter range", caption = "AC plots - Sum of Dead Stems across all plots") +
  facet_wrap(FENCED~BURNED)

```



```{r}
asp.tally.ht.tidy %>%
  # distinct(VALLEY)
  # group_by(VALLEY) %>% tally()
  filter(FENCED == "Fenced") %>% 
  filter(VALLEY == "MP") %>% 
  ggplot(aes(timeClass, stemTally)) +
  geom_col(aes(fill = LIVE_DEAD)) +
  facet_grid(SITE_ID ~ HTclass2, as.table = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "Stem count", fill = "", caption = "Moraine Park")

```


```{r}
## median by valley - AC
med.cnt.dbh.fenced.ac <- asp.tally.ht.tidy %>%
  filter(timeClass == "BL" |timeClass == "2013" |timeClass == "2018") %>% 
  # distinct(VALLEY)
  # group_by(VALLEY) %>% tally()
  # filter(FENCED == "Fenced") %>% 
  # filter(SITE_ID == "AC65") %>% 
  # filter(VALLEY == "MP") %>%
  filter(SITE_TYPE == "AC") %>% 
  group_by(timeClass, FENCED, VALLEY, HTclass2) %>% 
  summarise(med.tally = median(stemTally)) %>% 
  ungroup() 

med.cnt.dbh.fenced.ac %>% 
  pivot_wider(names_from = c(FENCED,timeClass), values_from = med.tally) %>% 
  gt()

med.cnt.dbh.fenced.ac %>%
  ggplot(aes(timeClass, HTclass2)) +
  geom_tile(aes(fill = med.tally), color = "white") +
  # facet_grid(valley_full ~ FENCED, as.table = FALSE) +
  # geom_text(aes(label = med.tally), color = "black", fontface = "bold") +
  geom_text(aes(label = med.tally), color = "white") +
  # facet_grid(FENCED~VALLEY, as.table = FALSE) +
  facet_grid(VALLEY~FENCED, as.table = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_minimal() +
  scale_fill_viridis() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  labs(x = "", y = "Height class", fill = "Stem count", caption = "AC plots only - Median stem count")

# ggsave("./output/figures_exported/AC_fenced_medTally_alt.png", width = 7.5, height = 3.25, dpi = 300)

ggsave("./output/figures_exported/AC_fenced_medTally_alt.png", width = 4.75, height = 6.35, dpi = 300)

# for caption
# asp.tally.ht.tidy %>%
#   select(VALLEY, valley_full) %>% 
#   distinct() %>% 
#   mutate(txt = glue::glue("{VALLEY}: {valley_full}")) %>% 
#   select(txt) 

# c("c("HSP: Horseshoe Park", "UBM: Upper Beaver Meadows", "MP: Moraine Park", "BME: Beaver Meadows Entrance", "EV: EndoValley", "KV: Kawuneeche Valley", "HV: Hidden Valley", "DM: Deer Mountain", "RR: Roaring River", "CC: Cow Creek", "HLWP: Hollowell Park")")

asp.tally.ht.tidy %>%
  group_by(VALLEY) %>% tally()

## Morain park
asp.tally.ht.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(VALLEY == "MP") %>%
  # filter(VALLEY == "EV") %>% 
  ggplot(aes(HTclass2, timeClass)) +
  geom_tile(aes(fill = stemTally), color = "white") +
  scale_fill_viridis_c() +
  facet_wrap(~SITE_ID, ncol=6) +
  theme_minimal() +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(caption = "Moraine Park plots", x = "Height class", y = "", fill = "n stems")



```

```{r}
## median by valley - ANC
med.cnt.dbh.fenced.anc <- asp.tally.ht.tidy %>%
  filter(timeClass == "BL" |timeClass == "2013" |timeClass == "2018") %>% 
  # distinct(VALLEY)
  # group_by(VALLEY) %>% tally()
  # filter(FENCED == "Fenced") %>% 
  # filter(SITE_ID == "AC65") %>% 
  # filter(VALLEY == "MP") %>%
  filter(SITE_TYPE == "ANC") %>% 
  group_by(timeClass, FENCED, VALLEY, HTclass2) %>% 
  summarise(med.tally = median(stemTally)) %>% 
  ungroup() 

med.cnt.dbh.fenced.anc %>% 
  pivot_wider(names_from = c(FENCED,timeClass), values_from = med.tally) %>% 
  gt()

med.cnt.dbh.fenced.anc %>%
  ggplot(aes(timeClass, HTclass2)) +
  geom_tile(aes(fill = med.tally), color = "white") +
  geom_text(aes(label = med.tally), color = "white") +
  # facet_grid(valley_full ~ FENCED, as.table = FALSE) +
  facet_grid(VALLEY~FENCED, as.table = FALSE) +
  # facet_grid(FENCED~VALLEY, as.table = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_minimal() +
  scale_fill_viridis() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  labs(x = "", y = "Height class", fill = "Stem count", caption = "ANC plots only - Median stem count")

# ggsave("./output/figures_exported/ANC_fenced_medTally_alt.png", width = 4.5, height = 7.5, dpi = 300)

#### 
# med.cnt.dbh.fenced.anc %>%
#   ggplot(aes(timeClass, HTclass2)) +
#   geom_tile(aes(fill = med.tally), color = "white") +
#   # facet_grid(valley_full ~ FENCED, as.table = FALSE) +
# 
#   facet_grid(FENCED~VALLEY, as.table = FALSE) +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#   theme_minimal() +
#   scale_fill_viridis() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#   # theme(legend.position = "top") +
#   labs(x = "", y = "Height class", fill = "Stem count", caption = "ANC plots only - Median stem count")

```

```{r}
med.cnt.dbh.fenced.ak <- asp.tally.ht.tidy %>%
  filter(timeClass == "BL" |timeClass == "2013" |timeClass == "2018") %>% 
  # distinct(VALLEY)
  # group_by(VALLEY) %>% tally()
  # filter(FENCED == "Fenced") %>% 
  # filter(SITE_ID == "AC65") %>% 
  # filter(VALLEY == "MP") %>%
  filter(SITE_TYPE == "AK") %>% 
  group_by(timeClass, FENCED, VALLEY, HTclass2) %>% 
  summarise(med.tally = median(stemTally)) %>% 
  ungroup() 

med.cnt.dbh.fenced.ak %>% 
  pivot_wider(names_from = c(FENCED,timeClass), values_from = med.tally) %>% 
  gt() %>% 
  tab_header(title = "median tally AK")

med.cnt.dbh.fenced.ak %>%
  ggplot(aes(timeClass, HTclass2)) +
  geom_tile(aes(fill = med.tally), color = "white") +
  # facet_grid(valley_full ~ FENCED, as.table = FALSE) +
  # geom_text(aes(label = med.tally), color = "black", fontface = "bold") +
  geom_text(aes(label = med.tally), color = "white") +
  facet_grid(FENCED~VALLEY, as.table = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_minimal() +
  scale_fill_viridis() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  labs(x = "", y = "Height class", fill = "Stem count", caption = "AK plots only - Median stem count")

# ggsave("./output/figures_exported/AK_fenced_medTally.png", width = 4.25, height = 3.25, dpi = 300)

```

### Live stem tally: core winter range
```{r asp_tally_tileTxt, include=TRUE, fig.width=11, fig.height=8}
### Core winter range: Aspen Stem Tallies

## tally of core winter range - LIVE
asp.tally.ht.tidy %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  mutate(SITE_ID = glue::glue('{SITE_ID}-{FENCED}')) %>% 
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(RANGE_TYPE == "core winter range") %>%
  # filter(VALLEY == "MP") %>%
  # filter(VALLEY == "EV") %>% 
  ggplot(aes(timeClass, HTclass2)) +
  geom_tile(aes(fill = stemTally), color = "white", alpha = .2) +
  geom_text(aes(label = stemTally), size = 3) +
  # geom_tile(aes(fill = stemTally), color = "white") +
  # scale_fill_viridis_c() +
  facet_wrap(~SITE_ID) +
  # scale_fill_manual(values = c("pink", "ivory4")) +
  theme_minimal() +
  scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  # scale_fill_viridis() +
  labs(x = "", y = "", title = "Core winter range: Aspen live stem tallies", fill = "n stems") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures_exported/asp_AC_liveTally_revised.png", width = 8.75, height = 8.5, dpi = 300)


## tally of core winter range - DEAD
# asp.tally.ht.tidy %>%
#   filter(LIVE_DEAD == 'DEAD') %>% 
#   filter(RANGE_TYPE == "core winter range") %>%
#   ggplot(aes(timeClass, HTclass2)) +
#   geom_tile(aes(fill = FENCED), color = "white", alpha = .2) +
#   geom_text(aes(label = stemTally), size = 3) +
#   facet_wrap(~SITE_ID) +
#   theme_minimal() +
#   labs(x = "", y = "", title = "Moraine Park: Aspen dead stem tallies") +
#   # facet_grid(SITE_ID ~ timeClass) +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))


# ANC
## tally of NON-core winter range - LIVE
asp.tally.ht.tidy %>% # distinct(RANGE_TYPE)
  filter(LIVE_DEAD == 'LIVE') %>%
  # distinct(RANGE_TYPE)
  filter(RANGE_TYPE == "non-core winter range") %>%
  filter(SITE_ID != "ANC24") %>% 
  ggplot(aes(timeClass, HTclass2)) +
  # geom_tile(aes(fill = FENCED), color = "white", alpha = .2) +
  geom_tile(aes(fill = stemTally), color = "white") +
  geom_text(aes(label = stemTally), size = 3) +
  # scale_fill_viridis_c() +
  scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  facet_wrap(~SITE_ID) +
  theme_minimal() +
  labs(x = "", y = "", title = "Non-core winter range: Aspen live stem tallies", fill = "n stems") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures_exported/asp_ANC_liveTally.png", width = 7.125, height = 5.75, dpi = 300)


```

```{r}
## tally of KV - LIVE
asp.tally.ht.tidy %>% # distinct(RANGE_TYPE)
  filter(LIVE_DEAD == 'LIVE') %>%
  # distinct(RANGE_TYPE)
  filter(RANGE_TYPE == "Kawuneeche Valley") %>%
  # filter(SITE_ID != "ANC24") %>% 
  ggplot(aes(timeClass, HTclass2)) +
  # geom_tile(aes(fill = FENCED), color = "white", alpha = .2) +
  geom_tile(aes(fill = stemTally), color = "white") +
  geom_text(aes(label = stemTally), size = 3) +
  # scale_fill_viridis_c() +
  scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  facet_wrap(~SITE_ID, ncol = 4) +
  theme_minimal() +
  labs(x = "", y = "", title = "Kawuneeche Valley: Aspen live stem tallies", fill = "n stems") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures_exported/asp_KV_liveTallyx.png", width = 6.5, height = 4, dpi = 300)

```


```{r, eval=FALSE}

## tally of MP - LIVE
asp.tally.ht.tidy %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(VALLEY == "MP") %>%
  # filter(VALLEY == "EV") %>% 
  ggplot(aes(timeClass, HTclass2)) +
  geom_tile(aes(fill = FENCED), color = "white", alpha = .2) +
  geom_text(aes(label = stemTally), size = 3) +
  # geom_tile(aes(fill = stemTally), color = "white") +
  # scale_fill_viridis_c() +
  facet_wrap(~SITE_ID) +
  theme_minimal() +
  labs(x = "", y = "", title = "Moraine Park: Aspen live stem tallies") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures/aspen_tally_plots/asp_MP_liveTally.png", width = 9.5, height = 7, dpi = 300)


## tally of MP - DEAD
asp.tally.ht.tidy %>%
  filter(LIVE_DEAD == 'DEAD') %>% 
  filter(VALLEY == "MP") %>%
  ggplot(aes(timeClass, HTclass2)) +
  geom_tile(aes(fill = FENCED), color = "white", alpha = .2) +
  geom_text(aes(label = stemTally), size = 3) +
  facet_wrap(~SITE_ID) +
  theme_minimal() +
  labs(x = "", y = "", title = "Moraine Park: Aspen dead stem tallies") +
  # facet_grid(SITE_ID ~ timeClass) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures/aspen_tally_plots/asp_MP_deadTally.png", width = 9.5, height = 7, dpi = 300)

```



```{r aspHtClass}
## calc percentage in height classes
ht.perc01 <- asp.tally.ht.tidy %>%
  filter(is.na(REMOVED)) %>% 
  # filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  # filter(SITE_TYPE == "AC") %>%
  filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) #%>% 
  # mutate(percentTot = 100*round(percentTot,1)) 


```

```{r}
## heatmap: 
ht.perc01 %>%
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  # filter(FENCED == "Fenced") %>%
  filter(SITE_ID != "AC33") %>% 
  filter(SITE_ID != "AC67") %>% 
  filter(!is.nan(percentTot)) %>%
  mutate(SITE_ID = glue::glue('{SITE_ID}-{FENCED}')) %>% 
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'white', alpha = .8) +
  geom_text(aes(label = percentTot), size = 3) +
  # facet_grid(.~timeClass) +
  facet_wrap(~timeClass) +
  scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  # theme_bw() +
  theme_minimal() +
  labs(x = "Height class", y = "", fill = "% total stems", caption = "Proportion of Live Aspen Stems by Height Class - Fenced and unburned plots only")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
ht.perc01 %>%
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  filter(FENCED == "Fenced") %>%
  filter(SITE_ID != "AC33") %>% 
  filter(SITE_ID != "AC67") %>% 
  filter(!is.nan(percentTot)) %>%
  mutate(SITE_ID = glue::glue('{SITE_ID}-{FENCED}')) %>% 
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'white', alpha = .8) +
  geom_text(aes(label = percentTot), size = 2.75) +
  # facet_grid(.~timeClass) +
  facet_wrap(~timeClass) +
  scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  # theme_bw() +
  theme_minimal() +
  labs(x = "Height class", y = "", fill = "% total stems", caption = "Proportion of Live Aspen Stems by Height Class - Fenced and unburned plots only")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_flip()
# 
# ggsave("./output/figures_exported/AC_prop_height_raw_revised.png", width = 9, height = 3.25, dpi= 300)

```


```{r aspHtClass_plots}

## heatmap: fenced
ht.perc01 %>%
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  filter(FENCED == "Fenced") %>%
  filter(SITE_ID != "AC33") %>% 
  filter(SITE_ID != "AC67") %>% 
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'white', alpha = .8) +
  geom_text(aes(label = percentTot), size = 3) +
  # facet_grid(.~timeClass) +
  facet_wrap(~timeClass) +
  scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  # theme_bw() +
  theme_minimal() +
  labs(x = "Height class", y = "", fill = "% total stems", caption = "Proportion of Live Aspen Stems by Height Class - Fenced and unburned plots only")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures_exported/AC_Live_Fenced_BurnUnbu_heightClass_heatmap3b.png", width = 8.5, height = 4, dpi = 300)

## heatmap: unfenced
ht.perc01 %>%
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  filter(FENCED == "Unfenced") %>%
  filter(SITE_ID != "AC07") %>% 
  filter(SITE_ID != "AC68") %>% 
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'white', alpha = .8) +
  geom_text(aes(label = percentTot), size = 3) +
  facet_grid(.~timeClass) +
  scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  theme_minimal() +
  labs(x = "Height class", y = "", fill = "% total stems", title = "Proportion of Live Aspen Stems by Height Class", subtitle = "Unfenced plots only")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures_exported/AC_Live_unFenced_Unburned_heightClass_heatmap3.png", width = 8.5, height = 6, dpi = 300)

## heatmap: KV
asp.tally.ht.tidy %>%
  filter(is.na(REMOVED)) %>% 
  filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  # filter(FENCED == "Y") %>%
  # filter(SITE_TYPE == "AC") %>%
  filter(timeClass %in% c('BL','2013','2018')) %>%
  # filter(timeClass == "BL" | timeClass == 2013 | timeClass == 2018) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) %>%
  mutate(percentTot = 100*round(percentTot,1)) %>% 
  filter(RANGE_TYPE == "Kawuneeche Valley") %>%
  # filter(FENCED == "N") %>%
  # filter(SITE_ID != "AK04") %>% 
  # filter(SITE_ID != "AC68") %>% 
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(HTclass2, SITE_ID)) +
  geom_tile(aes(fill = percentTot), color = 'white', alpha = .8) +
  geom_text(aes(label = percentTot), size = 3) +
  facet_grid(.~timeClass) +
  scale_fill_viridis_c(begin = .4, end = .95, direction = -1, option = "B") +
  theme_minimal() +
  labs(x = "Height class", y = "", fill = "% total stems", title = "Proportion of Live Aspen Stems by Height Class", caption = "All plots")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave("./output/figures/aspen_tally_plots/KV_Live_unFenced_Unburned_heightClass_heatmap3b.png", width = 8.5, height = 6, dpi = 300)

```

```{r, fig.height=7.5, fig.height=6.5}
## bar chart: fenced
asp.prop.f <- ht.perc01 %>%
  filter(SITE_ID != "AC33") %>% 
  filter(SITE_ID != "AC67") %>%
  filter(FENCED == "Fenced") %>% 
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(SITE_ID, percentTot)) +
  geom_col(aes(fill = HTclass2)) +
  facet_wrap(~timeClass, ncol = 1) +
  # facet_grid(FENCED~timeClass) +
  scale_fill_grey() +
  # scale_fill_viridis_d(begin = .2, end = .95, direction = -1, option = "D") +
  # scale_fill_viridis_d(option = "D") +
  theme_minimal() +
  # theme_bw() +
  labs(y = "% of total stems", x = "", fill = "Height class", title = "Proportion of Live Aspen Stems by Height Class", subtitle = "Fenced plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent)

asp.prop.f  
# ggsave("./output/figures_exported/AC_Live_Fenced_heightClass_bd_bw.png", width = 8.5, height = 4.75, dpi = 300)
# ggsave("./output/figures_exported/AC_Live_Fenced_heightClass_revised.png", width = 6.5, height = 6.5, dpi = 300)


# non-fenced
ht.perc01 %>%
  filter(SITE_TYPE == "AC") %>% 
  filter(SITE_ID != "AC33") %>% 
  filter(SITE_ID != "AC67") %>%
  filter(FENCED == "Unfenced") %>% 
  filter(!is.nan(percentTot)) %>%
  filter(!is.na(percentTot)) %>%  
  ggplot(aes(SITE_ID, percentTot)) +
  geom_col(aes(fill = HTclass2)) +
  facet_wrap(~timeClass, ncol = 1) +
  scale_fill_grey() +
  # facet_grid(FENCED~timeClass) +
  # scale_fill_viridis_d(begin = .2, end = .95, direction = -1, option = "D") +
  # scale_fill_viridis_d(option = "D") +
  theme_minimal() +
  labs(y = "% of total stems", x = "", fill = "Height class", title = "Proportion of Live Aspen Stems by Height Class", subtitle = "Unfenced plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent)

# ggsave("./output/figures_exported/AC_Live_unFenced_heightClass_bc_bw.png", width = 7.5, height = 5.5, dpi = 300)

```

```{r, eval=FALSE, echo=FALSE}
## alt fig
ht.perc01 %>%
  filter(SITE_ID != "AC33") %>% 
  filter(SITE_ID != "AC67") %>%
  # filter(FENCED == "N") %>% 
  filter(!is.nan(percentTot)) %>%
  ggplot(aes(SITE_ID, percentTot)) +
  geom_col(aes(fill = HTclass2)) +
  facet_grid(timeClass ~ FENCED) +
  # facet_wrap(~timeClass, ncol = 1) +
  # facet_grid(FENCED~timeClass) +
  scale_fill_viridis_d(begin = .2, end = .95, direction = -1, option = "D") +
  # scale_fill_viridis_d(option = "D") +
  theme_minimal() +
  labs(y = "% of total stems", x = "", fill = "Height class", title = "Proportion of Live Aspen Stems by Height Class", subtitle = "Unfenced and unburned plots only") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # theme(legend.position = "top") +
  scale_y_continuous(labels=scales::percent)

```


## Aspen management goals

_Targets from Ziegenfuss and Johnson 2015:_

1.Progressive increase in aspen regeneration above the baseline level of 13 percent to at least 45 percent of winter range stands (presence of stems less than 2 cm dbh reaching 1.52.5 m tall).

#
```{r}

ht.perc01 %>%
  group_by(RANGE_TYPE, FENCED, pType) %>% 
  summarise(mean.stemDen.ac = mean(stemDen.ac),n = n())
  
asp.tally.dbh.tidy %>%
  # filter(is.na(REMOVED)) %>% 
  # filter(BURNED == "Unburned") %>%
  filter(LIVE_DEAD == "LIVE") %>%
  filter(FENCED == "Fenced") %>%
  # filter(SITE_TYPE == "AC") %>%
  # filter(timeClass %in% c('BL','2013','2018')) %>%
  group_by(SITE_ID, timeClass) %>%
  mutate(sumStem = sum(stemTally)) %>% 
  ungroup() %>% 
  mutate(percentTot = stemTally/sumStem) %>% 
  group_by(timeClass, BURNED, FENCED) %>% 
  descr(stemDen.ac) %>% 
  tb() %>% 
  gt() %>% 
  tab_header(title = "AC live density: tcxburnedxfenced")

```


```{r, echo=FALSE}
### Aspen repeated measures
# not run. See "EVMP aspen statistical analyses.Rmd"
## Repeated measures: Assumptions
# The repeated measures ANOVA makes the following assumptions about the data:
# 
# No significant outliers in any cell of the design. This can be checked by visualizing the data using box plot methods and by using the function identify_outliers() [rstatix package].
# Normality: the outcome (or dependent) variable should be approximately normally distributed in each cell of the design. This can be checked using the Shapiro-Wilk normality test (shapiro_test() [rstatix]) or by visual inspection using QQ plot (ggqqplot() [ggpubr package]).
# Assumption of sphericity: the variance of the differences between groups should be equal. This can be checked using the Mauchlys test of sphericity, which is automatically reported when using the R function anova_test() [rstatix package]. Read more in Chapter @ref(mauchly-s-test-of-sphericity-in-r).

# Note that, if the above assumptions are not met there are a non-parametric alternative (Friedman test) to the one-way repeated measures ANOVA.
# 
# Unfortunately, there are no non-parametric alternatives to the two-way and the three-way repeated measures ANOVA. Thus, in the situation where the assumptions are not met, you could consider running the two-way/three-way repeated measures ANOVA on the transformed and non-transformed data to see if there are any meaningful differences.
# 
# If both tests lead you to the same conclusions, you might not choose to transform the outcome variable and carry on with the two-way/three-way repeated measures ANOVA on the original data.
# 
# Its also possible to perform robust ANOVA test using the WRS2 R package.

# Compute and interpret the different repeated measures ANOVA in R.

# Check repeated measures ANOVA test assumptions

# Perform post-hoc tests, multiple pairwise comparisons between groups to identify which groups are different

```

```{r}
###### WRITE to disk for statistical analysis
# ht.perc01 %>% write_csv("./output/exported_data/asp_ht_perc1_20200309.csv")

# tthe one to use...
# asp.tally.dbh.tidy %>% 
#   write_csv("./output/exported_data/asp_ht_perc1_20200309.csv")
  
```

*Increase in aspen regeneration above the baseline level of 13 percent to at least 45 percent of winter range stands (presence of stems less than 2 cm dbh reaching 1.52.5 m tall).

*Progressive shift in the distribution of stem sizes toward the desired future condition of 75 percent small-diameter stems, 20 percent medium-diameter stems, and 5 percent large-diameter stems.

```{r}

## identify the "in desired future condition" plots
ht.perc01 <- ht.perc01 %>%
  mutate(inDesFC = case_when(
    stemDen.ha >= 400 & HTclass2 == "151-200cm" ~ "in_dfc",
    stemDen.ha >= 400 & HTclass2 == "201-250cm" ~ "in_dfc",
    TRUE ~ "out_dfc"))

# ht.perc01 %>% 
#   View()

ht.perc01 %>%  distinct(RANGE_TYPE)

## in DFC summary
asp_inDFC_summary <- ht.perc01 %>% 
  group_by(RANGE_TYPE, FENCED, timeClass, inDesFC) %>%
  summarise(n_dfc = n()) %>% 
  ungroup() %>% 
  group_by(RANGE_TYPE, FENCED, timeClass) %>%
  mutate(n_tot = sum(n_dfc)) %>%
  ungroup() %>% 
  mutate(perc_inDFC = n_dfc/n_tot * 100) %>% 
  mutate(perc_inDFC = round(perc_inDFC, 1))

asp_inDFC_summary %>%
  filter(inDesFC == "in_dfc") %>% 
  gt() %>% 
  tab_header(title = "percent plots in DFC")

```

```{r}
asp_inDFC_summary %>%
  filter(inDesFC == "in_dfc") %>% 
  gt() %>% 
  tab_header(title = "percent plots in DFC")
```

```{r}
## in DFC summary
asp_inDFC_summary2 <- ht.perc01 %>% 
  filter(SITE_TYPE == "AC" | SITE_TYPE == "ANC") %>% 
  group_by(FENCED, timeClass, inDesFC) %>%
  summarise(n_dfc = n()) %>% 
  ungroup() %>% 
  group_by(FENCED, timeClass) %>%
  mutate(n_tot = sum(n_dfc)) %>%
  ungroup() %>% 
  mutate(perc_inDFC = n_dfc/n_tot * 100) %>% 
  mutate(perc_inDFC = round(perc_inDFC, 1))

asp_inDFC_summary2 %>%
  filter(inDesFC == "in_dfc") %>% 
  gt() %>% 
  tab_header(title = "percent plots in DFC")
```

```{r}
# asp1 <- read_excel("data/EVMP_data/TenYearReview/Aspen_Data_Baseline_through_2018.xlsx")
# View(Aspen_Data_Baseline_through_2018)

```


```{r, echo = FALSE}
# Percent of aspen monitoring sites on elk winter range and Kawuneeche Valley of Rocky Mountain National Park, Colorado, that had a recruiting sapling cohort (at least 400 stems per hectare of height between 1.5 and 2.5 meters) at baseline sampling and in 2013. Entire winter range numbers are weighted by the percent area in each location.
# 
# Tally of Live Aspen Stems per Plot >2.5 m in Height (DBH=diameter at breast height [1.4 m])		
# 
# Tally of Live Aspen Stems per Plot <2.5 m in Height				
# 
# Tally of Dead Aspen Stems per Plot >2.5 m in Height (DBH=diameter at breast height [1.4 m])
# 

```




```{r, echo=FALSE}

# Rewrite the SAS program used to create figs. 3,4,5, and 7 of Zeigenfuss and Johnson (2015)--Distribution of aspen tree (height greater than 2.5 meters) stem diameters in monitoring sites. 
# 
# **Steps:** 
# 1. Read in data from a file with tallies of live aspen stems by dbh size class  
# 2. Read in a file with information for each aspen monitoring site  
# 3. Merge these two files, remove saplings 
# 4. Reclass trees into groups of small (2-10 cm dbh), medium (10-20 cm dbh) and large (20+ dbh) trees.
# 
# 
# **See: **  
# 
# >aspen sapling table 4.sas  
# >aspen sapling table 5.sas 
```


# Upland line intercept

## Data munging
**Data import** 

```{r, eval=TRUE}
## all sheets
uli <- readxl::excel_sheets("data/EVMP_data/TenYearReview/Upland_Line_Intercept_2007_2013_2018.xlsx")

## 2007
b2007 <- readxl::read_excel("data/EVMP_data/TenYearReview/Upland_Line_Intercept_2007_2013_2018.xlsx",sheet = 2) %>% 
  mutate(yr = 2007)

b2013 <- readxl::read_excel("data/EVMP_data/TenYearReview/Upland_Line_Intercept_2007_2013_2018.xlsx",sheet = 3) %>% 
  mutate(yr = 2013)


b2018 <- readxl::read_excel("data/EVMP_data/TenYearReview/Upland_Line_Intercept_2007_2013_2018.xlsx",sheet = 4) %>% 
  mutate(yr = 2018) %>% 
  mutate(SHRUB_HEIGHT_CM = as.character(SHRUB_HEIGHT_CM))

# combine 07 and 13
upl.li <- bind_rows(b2007,b2013) 

## bring in the 2018
upl.li <- upl.li %>% 
  bind_rows(., b2018)

# janitor::excel_numeric_to_date()

######### DEAL WITH NA #############
na_strings <- c("NA", "N A", "N / A", "N/A", "N/ A", "Not Available", "NOt available")

upl.li <- upl.li %>%
  naniar::replace_with_na_all(condition = ~.x %in% na_strings) %>%
  mutate(DATE = as.numeric(DATE)) 

upl.li <- upl.li %>% 
  clean_names()

```

```{r}
## expand site type
upl.li <- upl.li %>% 
  mutate(site_type = case_when(site_type == "UC" ~ "core range",
                               site_type == "UNC" ~ "non-core range",
                               TRUE ~ site_type)) 


### clean
upl.li <- upl.li %>%
  mutate(site_id = case_when(site_id == "UC1" ~ "UC01",
                             site_id == "UC2" ~ "UC02",
                             site_id == "UC3" ~ "UC03",
                             site_id == "UC5" ~ "UC05",
                             site_id == "UC8" ~ "UC08",
                             site_id == "UC9" ~ "UC09",
                             site_id == "UNC2" ~ "UNC02",
                             site_id == "UNC4" ~ "UNC04",
                             site_id == "UNC5" ~ "UNC05",
                             site_id == "UNC6" ~ "UNC06",
                             site_id == "UNC8" ~ "UNC08",
                             site_id == "UNC9" ~ "UNC09",
                             TRUE ~ site_id))

upl.li %>%
  filter(str_detect(string = site_id,pattern = "UNC")) %>% 
  tabyl(site_id) 

upl.li %>%
  distinct(yr, site_id, site_type) %>% 
  tabyl(yr, site_type)

upl.li %>%
  distinct(yr, site_type, shrub_species) %>% 
  tabyl(yr, site_type, shrub_species)

upl.li <- upl.li %>% 
  mutate(shrub_height_cm = as.numeric(shrub_height_cm)) %>%
  mutate(yr = as_factor(yr)) %>% 
  mutate(shrub_species = toupper(shrub_species))

upl.li <- upl.li %>% 
  mutate(shrub_species = case_when(shrub_species == "ROSA" ~ "ROWO",
                                   TRUE ~ shrub_species))

upl.li <- upl.li %>% 
  group_by(yr, shrub_species) %>% 
  mutate(n_spp = n()) %>% 
  ungroup

```

## Shrub cover


```{r, eval=TRUE}
upl.ht.sel <- upl.li %>%
  select(
  date,
  site_id,
  site_number,
  site_type,
  shrub_species,
  shrub_height_cm,
  line_intercept_length_m,
  yr
  ) %>%
  distinct()

## calculate the cover for all shrub species pooled together

upl.allspp.cover <- upl.ht.sel %>% 
  group_by(site_id, yr, site_type) %>%
  summarise(tot_intercept_m = sum(line_intercept_length_m)) %>% 
  ungroup() %>% 
  mutate(perc_cover = tot_intercept_m/30*100) %>% 
  filter(!is.na(perc_cover)) %>% 
  filter(perc_cover > 0)

## calculate the cover for shrubd BY species
upl.spp.cover <- upl.ht.sel %>% 
  group_by(site_id, yr, site_type, shrub_species) %>%
  summarise(tot_intercept_m = sum(line_intercept_length_m)) %>% 
  ungroup() %>% 
  mutate(perc_cover = tot_intercept_m/30*100) %>% 
  filter(!is.na(perc_cover)) %>% 
  filter(perc_cover > 0)

### write to disk
# write_csv(upl.allspp.cover, path = "./output/exported_data/upland_LI_allShrubsPooled_20200814.csv")
# write_csv(upl.spp.cover, path = "./output/exported_data/upland_LI_byShrubSpp_20200814.csv")


```

### All shrub species: site type

```{r}
## boxplot
upl.cova <- upl.allspp.cover %>% 
  ggplot(aes(yr, perc_cover)) +
  geom_boxplot(fill="grey50") +
  # scale_fill_manual(values = c("ivory", "ivory4")) +
  # scale_fill_manual(values = c("grey90")) +
  theme_minimal() +
  labs(x = "", y = "% cover", fill = "", caption = "Upland cover, all shrubs spp and UC UNC sites combined")


# ggsave("./output/figures_exported/upland_species_cover_allspp_sites_combined.png", width = 4.5, height = 3.75, dpi = 300)

```


### All shrub species: by site type

```{r}
## boxplot
upl.covb <- upl.allspp.cover %>% 
  ggplot(aes(yr, perc_cover)) +
  geom_boxplot(aes(fill = site_type), position = "dodge") +
  # scale_fill_manual(values = c("ivory", "ivory4")) +
  scale_fill_manual(values = c("grey90","grey50")) +
  theme_minimal() +
  labs(x = "", y = "% cover", fill = "", caption = "Upland cover, all shrubs combined between sites")

# ggsave("./output/figures_exported/upland_species_cover_allspp.png", width = 4.5, height = 3.75, dpi = 300)

## combine plots
cowplot::plot_grid(upl.cova, upl.covb, labels = "AUTO",rel_widths = c(1, 2))

# ggsave("./output/figures_exported/upland_species_cover_allspp_2panel.png", width = 5.75, height = 3.75, dpi = 300)
```

```{r}
## summary table
upl.allspp.cover %>% 
  group_by(yr, site_type) %>%
  # filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  descr(perc_cover, stats = "common") %>% 
  summarytools::tb() %>% 
  mutate(across(c('mean','sd','min','med','max','pct.valid'), ~round(.,digits = 1))) %>% 
  gt() %>% 
  tab_header(title = "Upland LI, Cover", subtitle = "All shrub species, all site types")

upl.allspp.cover %>% 
  group_by(yr, site_type) %>%
  summarytools::descr() %>% 
  summarytools::tb() %>% 
  filter(variable == "perc_cover") %>% 
  select(yr,
         contains("me"), 
         contains("site"),
         contains("sd"),
         contains("q"))  

# upl.allspp.cover.summary %>%
#   gt()

```


```{r}

upl.spp.cover %>% 
  group_by(yr, site_type, shrub_species) %>%
  summarytools::descr() %>% 
  summarytools::tb() %>% 
  filter(variable == "perc_cover") %>% 
  datatable(filter = "top")

```



## Height
```{r}
### select upland species
upl.li %>% 
  # baseline %>%
  filter(n_spp >30) %>% 
  ggplot(aes(yr, shrub_height_cm)) +
  geom_boxplot(aes(fill = site_type)) +
  theme_minimal() +
  # scale_fill_manual(values = c("ivory1","ivory4")) +
  scale_fill_manual(values = c("grey90","grey40")) +
  facet_wrap(~shrub_species, scale = 'free_y') +
  labs(x = "", y = "Max shrub height (cm)", fill = "", caption = "Upland plots, n >30")

# ggsave("./output/figures_exported/upland_species_max_ht.png", width = 6.5, height = 4, dpi = 300)

###
# upl.li %>%
#   filter(shrub_species != "NONE" & shrub_species != "PSME" & shrub_species != "UNKN" & shrub_species != "XXXX" & shrub_species != "CEXX" & shrub_species != "JAAM" & shrub_species != "RIXX" & shrub_species != "SYOR" & shrub_species != "SHCA" & shrub_species != "PRXX" & shrub_species != "SYRO" & shrub_species != "ROSA") %>% 
#   # group_by(yr, shrub_species) %>% 
#   ggplot(aes(yr, shrub_height_cm)) +
#   geom_boxplot(aes(fill = site_type)) +
#   facet_wrap(~shrub_species, scale = "free_y")

```

## < Upland offtake


# Wild Basin

## Comparison plot: willow height by valley, with wild basin


```{r}
wbasin <- read_csv("./data/wild_basin/Wild Basin willow data survey 2018.csv")

wbasin <- wbasin %>%
  janitor::clean_names()
  
wbasin.sel <- wbasin %>% 
  rename(plant_ht_cm = max_ht_cm) %>% 
  mutate(yr = 2018) %>% 
  mutate(fenced = "N") %>% 
  mutate(site_type = "WB") %>% 
  mutate(site_id = paste0("WB",point)) %>% 
  dplyr::select(c(yr, site_type, site_id, plant_ht_cm, species, fenced, location)) %>% 
  distinct()
  

```


```{r}
# exp lu
csv.all.lc.mcro.df.cln <- csv.all.lc.mcro.df %>% 
  clean_names()

  
willow.mcro.evmp <- csv.all.lc.mcro.df.cln %>%
  rename(species = species_code) %>% 
  dplyr::select(yr, site_type, species, site_id, plant_ht_cm, fenced, location) %>% 
  distinct()


willow.mcro.evmp18 <- willow.mcro.evmp %>% 
  filter(yr == 2018)

#### bind wb with 2018 evmp
wb.evmp18 <- bind_rows(wbasin.sel, willow.mcro.evmp18) %>% 
  distinct()

```

### Willow height comparison among Wild Basin and EVMP plots
```{r}
## compare WILLOW height

wb.evmp18 %>%
  filter(str_detect(species, "^S")) %>% 
  ggplot() +
  geom_density(aes(fill = site_type, color = site_type, lty = site_type, x = plant_ht_cm), alpha = 0.05) +
  theme_minimal() +
  labs(x = "Willow height (cm)", y  = "Density", lty= "Site type", color = "Site type", fill = "Site type", caption = "willow height, WB + EVMP, Salix only")

# ggsave("./output/figures_exported/WB_EVMP_willow_height.png", dpi = 300, width = 4.75, height = 3.75)
```

```{r}
wb.evmp18 <- wb.evmp18 %>%
  mutate(site_type = case_when(site_type == "WB" ~ "Wild Basin",
                               site_type == "WC" ~ "core winter range",
                               site_type == "WNC" ~ "non-core winter range",
                               site_type == "WK" ~ "Kawuneeche Valley",
                               TRUE ~ "other"))


wb.evmp18.willows <- wb.evmp18 %>% 
  filter(str_detect(species, "^S"))

wb.evmp18.willows.loc <- wb.evmp18.willows %>% 
  select(-yr) %>% 
  group_by(site_id,location) %>% 
  summarytools::descr(stats = "common") %>% 
  tb() %>%
  select(c(location,mean)) %>% 
  group_by(location) %>% 
  descr(mean,stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  select(-pct.valid)

# wb.evmp18.willows.loc %>% 
#   gt() %>% 
#   gt::gtsave(filename = "./output/tables/WB_vs_EVMP_willowHt_loc.rtf")

#### range type
wb.evmp18.willows.rt <- wb.evmp18.willows %>% 
  select(-yr) %>% 
  group_by(site_id,site_type) %>% 
  summarytools::descr(stats = "common") %>% 
  tb() %>%
  select(c(site_type,mean)) %>% 
  group_by(site_type) %>% 
  descr(mean,stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  select(-pct.valid)

# wb.evmp18.willows.rt %>%
#   arrange(-mean) %>%
#   select(-variable) %>% 
#   gt() %>% 
#   gt::gtsave(filename = "./output/tables/WB_vs_EVMP_willowHt_site_type.rtf")


```


```{r, cache=TRUE}
library(rstanarm)
library(emmeans)
wb_rt2stan <- wb.evmp18.willows %>% 
  select(-yr) %>% 
  group_by(site_id,site_type) %>% 
  summarytools::descr(stats = "common") %>% 
  tb() %>%
  select(c(site_type,mean))

wb_stanaov <- stan_aov(mean ~ site_type, data = wb_rt2stan, 
                  prior = R2(location = 0.25), adapt_delta = 0.999,
                  iter = 5000,
                  seed = 12345)
wb_stanaov

# report::report(wb_stanaov)

wb_stanglmer <- stan_lmer(mean ~ 1 + (1|site_type),
                   data = wb_rt2stan, prior_intercept = cauchy(),
                   iter=8000,
                   prior_covariance = decov(shape = 2, scale = 2),
                   adapt_delta = 0.999, seed = 12345)

summary(wb_stanglmer)#

describe_posterior(
  wb_stanglmer,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
  gt()

## stan aov
describe_posterior(
  wb_stanaov,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
  gt()


pp_check(wb_stanaov)

wb.emm <- emmeans::emmeans(wb_stanaov, ~ site_type)
pairs.wb <- pairs(emmeans(wb_stanaov, ~ site_type))

gg.emm.wb.ht <- plot(pairs.wb) +
  geom_vline(aes(xintercept = 0), lty = "dashed", color = "red") +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Height")

gg.emm.wb.ht

# ggsave("./output/figures_exported/gg_emm_wildbasin_ht.png", width = 4.5, height = 3.55, dpi=300)

# ggsave("./output/figures_exported/gg_emm_wildbasin_ht.pdf", width = 4.5, height = 3.55)

# report::report(wb_stanaov)

# library(rstanarm)
# post1 <- stan_aov(weightgain ~ source * type, data = weightgain, 
#                   prior = R2(location = 0.5), adapt_delta = 0.999,
#                   seed = 12345)
# post1
```

----

**References**  

Johnson, T. L., L. C. Zeigenfuss, N. Thompson, and J. A. Mack. 2016. The role of science through a century of elk and habitat management at Rocky Mountain National Park. Park Science 32(2):7072

U.S. Department of the Interior, 2007, Elk and vegetation management plan, Rocky Mountain National Park, Colorado: Washington D.C., National Park Service, unpaged, accessed online May 6, 2013 at http://www.nps.gov/romo/parkmgmt/elkveg_mgmt_plan_feis.htm.

U.S. Department of the Interior, 2008, Record of decision, Final environmental impact statement, Elk and vegetation management plan, Rocky Mountain National Park, Colorado: Washington D.C., National Park Service, 21 p., accessed online May 6, 2013 at www.nps.gov/romo/parkmgmt/upload/rod_evmp_signed_2-15-08.pdf.

Zeigenfuss, L., Johnson, T., and Wiebe, Z., 2011, Monitoring plan for vegetation responses to elk management in Rocky Mountain National Park: U.S. Geological Survey Open-File Report 20111013, 85 p.

Zeigenfuss, L.C., and T.L. Johnson, 2015, Monitoring of vegetation response to elk population and habitat management in Rocky Mountain National Park, 200814: U.S. Geological Survey Open-File Report 20151216, 44 p., http://dx.doi.org/10.3133/ofr20151216.

# Appendix 1. Data notes from E. Ertl

The following are notes from E. Ertl recorded in an describing EVMP vegetation data collection, as recorded in 2018.  

## Aspen

* Plots lost: AC41 (plot was washed away in the 2013 flood)

* Plots added: AC68 to replace AC41

* Plots that had been treated with fuels management work that has not been noted before: ANC5, ANC7, ANC8, ANC19 (I think?) these areas were thinned of most large trees opening up the canopy substantially and the area was also pile burned; none of the plots appeared to be directly in the pile burn scars but a few came very close; these treatments could alter data in the future (working on getting a GIS layer for this)

* Formatted 2015  2018 data. 2015-2017 data only consisted of burn plot sampling; no burn plot data collected in 2014

## Upland

* Plots lost: UC09 (this plot was most likely lost in the 2013 flood), UC14 & UC24 (plots were lost to waterline construction that occurred from 2015-2018)

* Plots added: UC37, UC38, UC39 to replace the three plots that were lost

* Plots have been treated by prescribed fire in the past; Prescribed fire occurred from 9/17  10/2 of 2008; First round of data collected for upland sites occurred in 2007 (working on getting recent GIS layers to account for any other treatments)

* Prescribed burning is planned for this coming October 2018 as well, which will potentially burn several upland plots in the Beaver Meadows area

* Formatted 2018 shrub data

## Willow

* Plots lost: WK03; this plot hasnt been found since 2012 and we looked several times in 2018

* Plots added: WK09 to replace WK03 (updated measurement schedule in the protocol), WK10 added late season after talking with Linda Z.  she suggested there be 4 fenced plots in the KV to make the data collected from this area more robust. We werent aware of this when we installed WK09, so there will be nine total west side plots (4 fenced and 5 unfenced).

* Removed the microplot stem counts from the macroplot sampling in the protocol per Linda Z. early summer

* Formatted 2015  2018 cumulative willow data
	2015-2017 data only consisted of burn plot sampling; there is no burn data for 2014
	In 2015 it appears they were only measuring willow in the macroplots, not all shrubs like they should have been.

* Fixed unit and rounding issues in data.	In 2016 the crew measured additional burned sites that are not on the burn survey list (WC32, WC34, WC78, WC84, and WC85). For some plots they only measured willow instead of measuring all shrubs. Fixed unit and rounding issues in data.

* There is only west side data for 2016 and 2017; Nick B. said they werent aware that west side plots were supposed to be measured every year back in 2014/2015. Burn survey and west side data are currently combined by year measured

* Formatted 2015  2018 offtake data (2014 was already added and analyzed in the 2013 review)
	2015 offtake notes: Crew didnt sample WC9, WC78, WC79 (plots are in fences) and sampled extra plots that are not on the protocol list for offtake including WC34, WC35, WC52, WC54, WC56, WK6, WK7, and WK8 (none of these are in fences)

* 2016 offtake notes: Crew didnt sample WC79 (fenced), WC85 (fenced), WK3 (lost), WNC30 (couldnt find plot) and sampled extra plots that are not on the protocol list for offtake including WC34, WC35, WC37 (fenced), WC50 (fenced), WC57, WC69, WC70, WC71, WC76 (fenced), WC81, WC82, WC83, WC86 (fenced)

*	2017 offtake notes: Crew didnt sample WC76 (fenced), WC85 (fenced), WNC30 (couldnt find plot), WK3 (lost), WK6 (river probably too high to access) and no extra plots were sampled

*	2018 offtake notes: Crew didnt sample WC33 (removed 2014), WC76 (fenced), WC77 (fenced), WK3 (lost and removed from list in 2018, replaced with WK9 at end of season), WK6 (river too high to access plot)  
* There were discrepancies between the protocol and the willow master database on what sites to sample for offtake (added by C. Piper). Linda and I updated this schedule in the protocol for future years because the old schedule included plots that were no longer there and plots that have since been fenced.

* Burn Surveys 2015-2019  spoke with Linda Z. and she doesnt think these need to be measured again in 2019 unless the data is showing something interesting.

* Willow stake restoration sites  have these been cross referenced with willow monitoring sites? Were willow stakes planted in some plots? I did find notes that there were willow stakes being measured in WC76 over the years, which would need to be analyzed separately Im assuming.

## Other notes

* Kept all of Lindas original data for the last 5-year review under EVMPs analysis folder

* Created new (2018) versions of data for 10-year review analysis but did not delete out any data from previous years where plots were lost this year; also kept old components in the data (i.e. willow shoot measurements, microplot stem counts)

* All formatted data for 2018 can be found under EVMPVegetationAnalysis10 Year Review

* Blank datasheets have been updated for 2018

* Protocols are currently being updated for 2018 and master databases have been updated for 2018. 

* Added a Fuels Treatment Post Establishment and Treatment Year column that could be queried by type (i.e. prescribed fire, mechanical treatments, etc.) 

* Created new shapefiles for all veg plots; trying to find shapefiles for treatment areas in the park and will put them in the EVMP_Veg_Data_2018 geodatabase
	Located under EVMPVegetationGISEVMP_Veg_Data_2018.gdb OR ShapefilesMaster_Veg_Sites_Shp2018

* Created new veg maps. Located under EVMPVegetationLogisticsMapsEVMP vegetation plot maps2018 Veg Site MapsPlot Maps

* Wild Basin Willow Data  I created a folder with all of the data collected at Wild Basin this fall. It is located under EVMPVegetationAnnual RecordsFY18Wild Basin  Willow Data
* Uploaded all 4 iPads with new electronic datasheets for willow and upland, photo points and plot diagrams from 2018, willow ID keys, updated protocol from 2018, and new vegetation site maps.




# Appendix 2. Species lists

```{r}

spp.mcro <- csv.all.lc.mcro.df %>%
  distinct(SPECIES_CODE) %>% 
  rename(sppcode = SPECIES_CODE) %>% 
  mutate(spp_source = "Macroplot")

spp.upl <- upl.spp.cover %>%
  distinct(shrub_species) %>% 
  rename(sppcode = shrub_species) %>% 
  mutate(spp_source = "Upland LI")

spp.li <- csv.all.lc.li.df %>%
  distinct(SPECIES_CODE) %>% 
  rename(sppcode = SPECIES_CODE) %>% 
  mutate(spp_source = "Riparian LI")

spp.all <- bind_rows(spp.li,spp.mcro,spp.upl)

spp.all <- spp.all %>% 
  arrange(spp_source,sppcode)
  

## from the report
spp.list1 <- read_excel(path = "./data/EVMP_derived/species_list/species_list.xlsx")

spp.list1 <- spp.list1 %>%
  mutate(Scientific = str_trim(Scientific, side = "both")) %>% 
  mutate(Common = str_trim(Common, side = "both")) %>% 
  rename(sppcode = Code)

spp.list1 %>%
  filter(!is.na(Common)) %>%
  arrange(Scientific) %>% 
  gt()
  

spp.all <- left_join(spp.all, spp.list1)

## Write
# spp.all %>% 
#   write_csv("./data/EVMP_derived/species_list/species_list_to_edit.csv")


## USDA CO list
stateDownload <- read_csv("data/EVMP_derived/species_list/stateDownload.csv") %>% 
  clean_names() %>% 
  rename(sppcode = symbol)

spp.all <- spp.all %>% 
  left_join(.,stateDownload, by = "sppcode")

```



