---
title: "Appendix D. EVMP Willow Statistical Analyses"
author: ""
date: ""
output: 
  html_document: 
    theme: journal
    toc: yes
    toc_depth: 2
    code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
bibliography: references.bib
---

**Willow Macroplot Statistical Analyses**

*Repository:*\
<https://github.com/egage/EVMP>

```{r setup, include=FALSE}
# Rmd setup
library(knitr)
opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.align = 'center')
opts_knit$set(root.dir=normalizePath('../')) # required if Rmd is nested below the project directory
opts_chunk$set(fig.path = "../output/figures/") 
# set seed
set.seed(1234)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}
# Read in libraries
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(janitor))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(lubridate))
library(emmeans)
library(rstanarm)
# rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
library(bayestestR)
library(gt)
library(ggridges)
library(bayesplot)
library(patchwork)
library(summarytools)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}
### Table functions
## function to describe model out
fun.desc.post1 <- function(model){
  describe_posterior(
  model,
  effects = "fixed",
  component = "all",
  ci_method = "hdi",
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
    as_tibble() %>% 
    DT::datatable(caption = "Posterior description")
}

## Functions for summarizing posterior distributions, creating tables with the gt
fun.sexit.gt <- function(model){
  bayestestR::sexit(model, ci=0.9) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric), round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Effect Existence and Significance Testing") }


# describe posterior
# fun.desc.post1.gt.rope <- function(model){
#   describe_posterior(
#   model,
#   effects = "fixed",
#   component = "all",
#   ci_method = "hdi",
#   ci=0.9,
#   test = c("p_direction", "p_significance","rope"),
#   #rope_range(c(-0.1,0.1)),
#   rope_range("default"),
#   rope_ci = 0.9,
#   centrality = "median"
# ) %>% 
#     as_tibble() %>% 
#     gt() %>% 
#     tab_header(title = "Posterior description") %>% 
#     fmt_number(
#     columns = 2:14,
#     decimals = 2,
#     suffixing = TRUE
#   )
# }

fun.desc.post1.gt.rope <- function(model){
  describe_posterior(
  model,
  effects = "fixed",
  component = "all",
  ci_method = "hdi",
  ci=0.9,
  test = c("p_direction", "p_significance","rope"),
  #rope_range(c(-0.1,0.1)),
  rope_range("default"),
  rope_ci = 0.9,
  centrality = "median") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  gt() %>% 
  tab_header(title = "Posterior description")
}
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}

#### Plotting functions
fun.contrast.plot <- function(df){
  df %>% 
  ggplot(aes(x = contrast)) +
  geom_linerange(aes(ymin = lower.HPD, ymax = upper.HPD), color = "lightblue", size = 2) +
  geom_point(aes(y = estimate), size = 2.5) +
  theme_minimal() +
  labs(caption = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Estimate") +
  coord_flip()
}

## ppcheck.plot
ppc.plot <- function(model){
  pp_check(model) +
  labs(x = "Value", y = "Density") +
  theme_minimal()
}

# session info: verbose
package_versions <- function(packages=NULL, base=FALSE, sort=FALSE) {
    #' Determine package versions.
    #' 
    #' @param packages Packages to query; if not specified (or \code{NULL}),
    #' all currently attached packages are queried.
    #' @param base If \code{TRUE}, include the base package (R version).
    #' @param sort If \code{TRUE}, sort package names alphabetically. 
    #' @return Data frame with package names and corresponding versions.
    if (is.null(packages))
        packages <- names(sessionInfo()$otherPkgs)
    if (base)
        packages <- c("base", packages)
    if (sort)
        packages <- sort(packages)
    if (!is.null(packages)) {
        tmp <- data.frame(sapply(sapply(packages, packageVersion, simplify=FALSE), as.character))
        colnames(tmp) <- "version"
        data.frame(package=rownames(tmp), version=tmp[1], row.names=NULL)
    }
}

```

```{r}
# custom gradients and palettes
dbhclass.gradient5 <- c("#26185F", "#0095AF", "#9ADCBB", "#FCFFDD", "grey50")

colfunc1<-colorRampPalette(c("#26185F","#0095AF","#9ADCBB", "#FCFFDD"))
colfunc2<-colorRampPalette(c("#0095AF","#9ADCBB", "#FCFFDD"))
colfunc3<-colorRampPalette(c("#0095AF","#9ADCBB"))
colfunc3_RdBu <- colorRampPalette(c("#EF8A62", "#FDDBC7", "#D1E5F0", "#67A9CF"))

# plot(rep(1,50),col=(colfunc1(50)), pch=19,cex=2)
# plot(rep(1,5),col=(colfunc1(5)), pch=19,cex=2)
pal.5a <- colfunc1(5)
pal.7a <- colfunc1(7)

# palette3 <- RColorBrewer::brewer.pal(6,"RdBu")
# RColorBrewer::display.brewer.pal(6,"RdBu")
```

# Introduction

This document contains code for running statistical analyses of of Elk
Vegetation Management Plan (EVMP) data collected through the 2018
sampling season. Analyses are limited to macroplot data from plots
established in riparian areas in areas of the elk winter range and
Kawuneeche Valley (i.e., "willow" plots, see Zeigenfuss et al. 2011). Analyses are provided as a supplement to the NPS NRR Report "Monitoring of
Vegetation Response to Elk Population and Habitat Management in Rocky
Mountain National Park - Analysis of Elk Vegetation Management Plan
monitoring Data: 2008--2018". For information on sampling and the
broader analysis and interpretation of the results, refer to the project
report, past analyses [@zeigenfuss2015], and the original EVMP
monitoring plan [@zeigenfuss2011].

# Methods

The code and results presented here build on derived
data produced in a separate code document focused on ingesting,
compiling, and cleaning raw data provided by RMNP staff (Appendix B). Extensive
"munging" of raw files was required, so the decision was made to
separate code used to pre-process raw data from code used for the
analyses presented here. Likewise, separate code documents were
developed for other distinct elements of the larger EVMP (e.g., aspen
and upland plots). In general, packages included in the "Tidyverse"
ecosystem of R packages were used for data transformation and
visualization [@wickham2019], although specialized packages particular
to specific tasks (e.g., the "bayesplot" plot for visualization of
Bayesian posterior distributions) were also used [@gabry2019].

Bayesian models view a model parameter $\theta$ as a [*random variable*]. In constrast, frequentist models treat model parameters as unknown *constant*. Rather than estimating an unknown constant, Bayesian modeling focuses on an unknown distribution of parameter values.

Using *Bayes' Law*, model parameters are estimated:

$$
\begin{equation} \label{eq:bayeslaw}
P(\theta | y, X) = \frac{P(y|\theta,X) \cdot P(\theta)}{P(y)} \propto P(y|\theta,X) \cdot P(\theta).
\end{equation}
$$

Where:

+ $X$: The observed data
+ $y$: The outcomes
+ $P(\theta|y,X)$: Our view of the possible value of our model parameters after seeing the data
+ $P(y|\theta,X)$: The likelihood of seeing the current outcome conditioned on the data we have and a specific parameter value
+ $P(\theta)$: Our view of the possible values of our model parameters before observing any actual data, i.e. the *prior*
+ $P(y)$: The unconditional probability of the outcome, i.e. the probability after considering all possible parameter.
The objective is to estimate the posterior density of parameter $P(\theta|y,X)$, typically described in terms of a point estimate of the expected value of posterior density (e.g., the median of the distribution) and a measure of the variance. To solve for $P(\theta|y,X)$ analytically, the data likelihood $P(y|\theta,X)$, prior $P(\theta)$, and marginal likelihood of outcome $P(y)$ are needed, but because there is usually no closed-form analystical solution, Markov chain Monte Carlo methods are used to numerically solve the posterior density by directly generating random draws of parameters.
The general steps in a Bayesian analysis followed included:
*Specify a joint distribution for the outcome(s) and all the unknowns, which proportional to a posterior distribution of the unknowns conditional on the observed data    
*Use Markov Chain Monte Carlo (MCMC) to draw from posterior distribution.    
*Evaluation of model fit and revise the model as appropriate.  

Bayesian repeated measures analyses were fit separately for combined
core and non-core winter range, core winter range (WC) and non-core
winter range plots (WNC). For willow height, models were fit using
weekly informative priors and a gamma distribution with the "stan_glmer"
function in the "rstanarm" package [@goodrich2020][@brilleman2018]. Gamma regression is commonly used when the response variable is continuous and positive.

For the simplest case a GLM for a continuous outcome is simply a linear model 
and the likelihood for one observation is a conditionally normal probability density function.  
$$\frac{1}{\sigma \sqrt{2 \pi}} e^{-\frac{1}{2} 
\left(\frac{y - \mu}{\sigma}\right)^2},$$
where $\mu = \alpha + \mathbf{x}^\top \boldsymbol{\beta}$ is a linear predictor
and $\sigma$ is the standard deviation of the error in predicting
the outcome, $y$. A linear predictor $\eta = \alpha + \mathbf{x}^\top 
\boldsymbol{\beta}$ can more generally be related to the conditional mean of the outcome via a 
link function $g$. This maps the range of values on which the 
outcome is defined. For the gamma distribution used in the modeling of willow height, 
the log link function was used. The likelihood is the product of the likelihood contributions of individual observations.

Bayesian analysis requires specifying prior distributions $f(\alpha)$ and
$f(\boldsymbol{\beta})$ for the intercept and vector of regression coefficients.
Prior distributions were represented by normal distributions with a mean zero and a small standard deviation (scale)). The joint posterior distribution for
$\alpha$ and $\boldsymbol{\beta}$ is proportional to the product of the priors 
and the $N$ likelihood contributions:

$$f\left(\boldsymbol{\beta} | \mathbf{y},\mathbf{X}\right) \propto
  f\left(\alpha\right) \times \prod_{k=1}^K f\left(\beta_k\right) \times
  \prod_{i=1}^N {f(y_i|\eta_i)},$$
  
where $\mathbf{X}$ is the matrix of predictors and $\eta$ the linear predictor, i.e., the posterior distribution that `stan_glmer` draws from using MCMC.

Willow cover data were modeled using the beta distribution as the likelihood for the data,
$$
f(y_i | a, b) = \frac{y_i^{(a-1)}(1-y_i)^{(b-1)}}{B(a,b)}
$$
where $B(\cdot)$ is the beta function. The shape parameters for the distribution
are $a$ and $b$ and enter into the model according to the following transformations,
$$
a = \mu\cdot\phi \\
b = (1-\mu)\cdot\phi
$$

If $g_1(\cdot)$ is some link function, the specification of the shape
parameters, $\mu = g_1^{-1}(\mathbf{X}\boldsymbol{\beta})$, where $\boldsymbol{X}$
is a $N\times K$ dimensional matrix of predictors, and $\boldsymbol{\beta}$, is a $K$
dimensional vector of parameters associated with each predictor. $\phi$ is a scalar parameter. With the shape parameter values included, the likelihood takes the
form:
$$
f(y_i | \mu, \phi) = \frac{y_i^{(\mu\phi-1)}(1-y_i)^{((1-\mu)\phi-1)}}{B(\mu\phi,(1-\mu)\phi)}
$$

Bayesian analysis requires specifying prior distributions $f(\boldsymbol{\beta})$ and $f(\phi)$ for the vector of regression coefficients and $\phi$. 
When modeling $\phi$ with a linear predictor a full Bayesian analysis requires
specifying the prior distributions $f(\boldsymbol{\beta})$ and $f(\boldsymbol{\gamma})$.

With a single set of explanatory variables, the posterior distribution of
$\boldsymbol{\beta}$ and $\phi$ is proportional to the product of the likelihood
contributions, the $K$ priors on the $\beta_k$ parameters, and $\phi$,
$$
f(\boldsymbol{\beta},\phi|\mathbf{y},\mathbf{X}) \propto 
\prod_{i=1}^N f(y_i | a, b) \times 
\prod_{k=1}^K f(\beta_k) \times
f(\phi)
$$

With two sets of explanatory variables, the posterior distribution of $\boldsymbol{\beta}$ and
$\boldsymbol{\gamma}$ is proportional to the product of the likelihood contribution, the $K$
priors on the $\beta_k$ parameters, and the $J$ priors on the $\gamma_j$ parameters,

$$
f(\boldsymbol{\beta},\boldsymbol{\gamma}|\mathbf{y},\mathbf{X}) \propto 
\prod_{i=1}^N f(y_i | a, b) \times 
\prod_{k=1}^K f(\beta_k) \times
\prod_{j=1}^J f(\gamma_j)
$$

```{r}
#### Data import and munging
# read in willow. These data are the output of extensive munging accomplished using code in "EVMP_munging_20210131.Rmd"

willow <- read_csv("./output/exported_data/willow_mcro.csv")

## create timeClass var
willow.ht <- willow %>% 
  filter(!is.na(PLANT_HT_CM)) %>% 
  mutate(timeClass = case_when(yr == 2008 ~ "BL",
                              yr == 2009 ~ "BL", 
                              TRUE ~ as.character(yr))) 

## chr to factor conversions
willow.ht <- willow.ht %>% 
  mutate(timeClass = as.factor(timeClass)) %>% 
  mutate(timeClass = fct_relevel(timeClass, "2018", "2013", "BL")) %>% 
  mutate(FENCED = as.factor(FENCED))


## clean names
willow.ht <- willow.ht %>% 
  janitor::clean_names()

## filter out just the willow species
willow.ht <- willow.ht %>%
  filter(str_detect(species_code, pattern = "SA"))

## filter out 0
willow.ht <- willow.ht %>% 
  filter(plant_ht_cm > 0)

## reorder the time class
willow.ht <- willow.ht %>% 
  mutate(time_class = fct_rev(time_class))

## factor reverse: fenced
willow.ht <- willow.ht %>%
  mutate(fenced = fct_rev(fenced))

```

```{r}
## create separate df for WC, WNC, combined WC & WNC, and KV


willow.ht.wc <- willow.ht %>% 
  filter(site_type == "WC") %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class))


# non core
willow.ht.nc <- willow.ht %>% 
  # distinct(site_type)
  filter(site_type == "WNC") %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class))

# combined WC and WNC
willow.ht.wc.wnc <- willow.ht %>% 
  # distinct(site_type)
  filter(site_type == "WNC" | site_type == "WC") %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class))

# kw (note: different munging workflow needed b/c of different sampling yrs)
willow.ht.wk <- willow %>%
  clean_names() %>%
  filter(str_detect(species_code, pattern = "SA")) %>% 
  filter(site_type == "WK") %>% 
  mutate(fenced = as.factor(fenced)) %>% 
  filter(plant_ht_cm > 0) %>% 
  mutate(time_class = as.factor(time_class)) %>% 
  mutate(fenced = fct_rev(fenced)) %>% 
  mutate(time_class = fct_drop(time_class))
  

```

# BASELINE ADDITION
```{r}
# Baseline data for KV were not provided in in the initial data trasnfer.
# The following reads in these missing observations.
# read in the missing KV baseline data



```


# Results

## Willow Height - Combined Winter Range Macroplot Data

**Histograms of Willow Height**

```{r}
## histogram
willow.ht.wc.wnc %>% 
  ggplot() +
  geom_histogram(aes(plant_ht_cm, fill = fenced), color = "grey50") +
  # viridis::scale_fill_viridis(discrete=TRUE) +
  scale_fill_manual(values = colfunc3(2)) +
  labs(x="Plant height (cm)", y = "Count", fill = "", caption = "Core and noncore winter range plots. Macroplot heights") +
  theme_minimal() +
  facet_wrap(~time_class) +
  coord_flip()

ggsave("./output/figures_202107/willow_height/hist_willowht_TC_wcwnc.png", dpi = 300, width = 6.75, height = 3.75)
# ggsave("./output/figures_202107/willow_height/hist_willowht_TC_wcwnc.pdf", width = 6.75, height = 3.75)

```

### Modeling and Posterior Description
```{r, cache=TRUE}
## run with gamma
wc.wnc.stmod_TCxF <- stan_glmer(plant_ht_cm ~ time_class*fenced +  (1 | site_id), data = willow.ht.wc.wnc,
                      family=Gamma(link="log"),
                      iter = 8000,
                      )
```

**Prior summary**: plant_ht_cm ~ time_class*fenced +  (1 | site_id)
```{r, echo=TRUE}
# Get the prior summary
prior_summary(wc.wnc.stmod_TCxF)
```

```{r}
#### PP check plot
ppc.plot(wc.wnc.stmod_TCxF) +
  labs(caption = "WC+WNC: willow_ht~TCxF")

ggsave("./output/figures_202107/willow_height/ppc_willowht_wcwnc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202107/willow_height/ppc_willowht_wcwnc.pdf", width = 4.75, height = 3.75)
```

```{r}
# Extract posteriors
posteriors.wc.wnc.ht <- insight::get_parameters(wc.wnc.stmod_TCxF)

## tidy
posteriors.wc.wnc.ht.tidy <- posteriors.wc.wnc.ht %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

# posteriors.wc.wnc.ht.tidy %>%
#   ggplot() +
#   geom_density(aes(fill = parameter, x = values),color="grey50", alpha = .25) +
#   # scale_fill_viridis(discrete = TRUE) +
#   scale_fill_manual(values = colfunc2(10)) +
#   # scale_color_manual(values = colfunc2(ncol(posteriors.wc.wnc.ht.tidy))) +
#   theme_minimal()

```

### Effect Description
```{r}
# use function defined above
fun.sexit.gt(wc.wnc.stmod_TCxF)

## save as RTF
fun.sexit.gt(wc.wnc.stmod_TCxF) %>%
 tab_header(title = "Combined WC and WNC", subtitle = "Willow Height Posterior Description") %>%
 gt::gtsave(filename = "./output/tables/willow_height/postdesc_willowht_TCxF_wcwnc.rtf")

```

```{r, echo=FALSE, eval=FALSE}
#### Describe posterior distributions
fun.desc.post1.gt.rope(wc.wnc.stmod_TCxF) %>% 
  tab_header(title = "Combined WC and WNC", subtitle = "Willow Height Posterior Description")

## save as RTF
fun.desc.post1.gt.rope(wc.wnc.stmod_TCxF) %>%
 tab_header(title = "Combined WC and WNC", subtitle = "Willow Height Posterior Description") %>%
  gt::gtsave(filename = "./output/tables/willow_height/postdesc_willowht_TCxF_wcwnc.rtf")
```

#### Probability of Direction
```{r}
pd.wc.wnc <- p_direction(wc.wnc.stmod_TCxF)
# Visualize the pd
plot(pd.wc.wnc) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow height, Combined Core and Non-core Winter Range") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202107/willow_height/pd_willowht_wcwnc.png", width = 6.75, height =3.75, dpi = 300)
ggsave("./output/figures_202107/willow_height/pd_willowht_wcwnc.png", width = 6.75, height =3.75)

```

#### Region of Practical Equivalence (ROPE)

```{r}
rope.wcwnc <- rope(wc.wnc.stmod_TCxF, ci=0.9)

rope.wcwnc.gt <- rope.wcwnc %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 
rope.wcwnc.gt
# rope.wcwnc.gt %>%
#   gt::gtsave(filename = "./output/tables/willow_height/rope_willowht_wcwnc.rtf")
```

### Contrasts

```{r, eval=TRUE}
# Results are given on the log (not the response) scale.
# main effects
## main effect: time class
wc.wnc.emm.tc <- emmeans(wc.wnc.stmod_TCxF, ~ time_class)
wc.wnc.pairs.timeClass <- pairs(wc.wnc.emm.tc)

plot(wc.wnc.pairs.timeClass) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Height")

## main effect: fencing
wc.wnc.emm.fenced <- emmeans(wc.wnc.stmod_TCxF, ~ fenced)
wc.wnc.pairs.fenced <- pairs(wc.wnc.emm.fenced)

# plot(wc.wnc.pairs.fenced) +
#   theme_minimal() +
#   labs(subtitle = "Point estimate displayed: median 
# HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Height")

## the above is not used b/c sig of interactions
```

```{r}
## Effect: TC x fencing
emmeans(wc.wnc.stmod_TCxF, ~ time_class | fenced) %>% 
  pairs(reverse=TRUE) 

emmeans(wc.wnc.stmod_TCxF, ~ time_class | fenced) %>% 
  pairs(reverse=TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Height")

# ggsave("./output/figures_202107/willow_height/emm_willowht_TCxF_wcwnc.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_202107/willow_height/emm_willowht_TCxF_wcwnc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(wc.wnc.stmod_TCxF, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(wc.wnc.stmod_TCxF, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

```{r}
color_scheme_set("teal")

plot.mcmcareas_ht.wcwnc <- mcmc_areas(posteriors.wc.wnc.ht,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ht.wcwnc

ggsave("./output/figures_202107/willow_height/mcmcarea_willowht_TCxF_wcwnc.png", dpi = 300, width = 6.75, height = 3.75)
# ggsave("./output/figures_202107/willow_height/mcmcarea_willowht_TCxF_wcnc.pdf", width = 6.75, height = 3.75)
```

### Effects of Burning

```{r, cache=TRUE, eval=TRUE}
#### Fenced and burned

stmod_ht.wc.wnc.TCxFxB <- stan_glmer(plant_ht_cm ~ time_class*fenced*burned + (1 | site_id), 
                      data = willow.ht.wc.wnc,
                      family=Gamma(link="log"),
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary** height ~ time_class * burned * fenced + (1 | site_id) 
```{r}
prior_summary(stmod_ht.wc.wnc.TCxFxB)
```

```{r}
pp_check(stmod_ht.wc.wnc.TCxFxB) +
  labs(x = "Value", y = "Density") +
  theme_minimal()
# 
ggsave("./output/figures_202107/wc_wnc_willowcover_ppc_TCxFxB.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202107/wc_wnc_willowcover_ppc_TCxFxB.pdf", width = 4.75, height = 3.75)

```

```{r}
# Extract posteriors
posteriors.wc.wnc.ht <- insight::get_parameters(stmod_ht.wc.wnc.TCxFxB)
```


```{r}
##
color_scheme_set("teal")
# color_scheme_set("teal")

plot.mcmcareas_cov.wcwnc <- mcmc_areas(stmod_ht.wc.wnc.TCxFxB,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans')) +
  labs(caption="mcmcarea_willowcov_TC_wcwnc.png")

plot.mcmcareas_cov.wcwnc

ggsave("./output/figures_202107/willow_cover/mcmcarea_wilwht_TCxFxB_wcwnc.png", dpi = 300, width = 6.75, height = 11.75)

```


### Effect Description
```{r}

fun.sexit.gt(stmod_ht.wc.wnc.TCxFxB$stanfit)
```

```{r}
## Effect: TC x fencing
wcwnc.emm.TCxFxB <- emmeans(stmod_ht.wc.wnc.TCxFxB, ~ time_class | fenced | burned)
# wcwnc.emm.TCxFxB <- pairs(wcwnc.emm.TCxFxB, reverse = TRUE)

wcwnc.emm.TCxFxB

emmeans(stmod_ht.wc.wnc.TCxFxB, ~ time_class | fenced | burned) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type="response") + 
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, Willow Height")

ggsave("./output/figures_202107/willow_height/emm_willowht_TCxFxB_wcwnc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(wcwnc.emm.TCxFxB, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(wcwnc.emm.TCxFxB, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")
```



## Willow Height - Core Winter Range Macroplot Data

**Histograms of Willow Height**

```{r}
willow.ht.wc %>% 
  mutate(time_class = fct_rev(time_class)) %>% 
  ggplot() +
  # geom_density(aes(plant_ht_cm, fill = fenced), color = "black") +
  geom_histogram(aes(plant_ht_cm, fill = fenced), color = "grey50") +
  # viridis::scale_fill_viridis(discrete=TRUE) +
  scale_fill_manual(values = colfunc3(2)) +
  labs(x="Plant height (cm)", y = "Count", fill = "", caption = "Core winter range plots. Macroplot heights") +
  theme_minimal() +
  facet_wrap(~time_class) +
  coord_flip()

ggsave("./output/figures_202107/willow_height/hist_willowht_TCxF_wc.png", dpi = 300, width = 6.75, height = 3.75)
# ggsave("./output/figures_202107/willow_height/hist_willowht_TCxF_wc.pdf", width = 6.75, height = 3.75)

```

### Modeling and Posterior Description

```{r, eval = FALSE, cache=TRUE}
#### null model
# Not currently run; run in past as model comparison  
# Previously run for comparisons but not otherwise reported
stmod_ht.0 <- stan_glmer(plant_ht_cm ~ 1 + (1 | site_id), data = willow.ht.wc,
                      family=Gamma(link="log"),
                      iter = 8000,
                      seed = 1234
                      )

prior_summary(stmod_ht.0)
pp_check(stmod_ht.0)

#### main factors only
## Run, but not used for reporting after model comparisons
stmod_ht1 <- stan_glmer(plant_ht_cm ~ time_class + fenced + (1 | site_id), data = willow.ht.wc,
                      family=Gamma(link="log"),
                      iter = 8000,
                      seed = 1234
                      )

prior_summary(stmod_ht1)
pp_check(stmod_ht1)

```

```{r, cache=TRUE}
#### main factors + interactions
# After model comparisons, this is the selected model reported
stmod_ht2 <- stan_glmer(plant_ht_cm ~ time_class*fenced + (1 | site_id), data = willow.ht.wc,
                      family=Gamma(link="log"),
                      iter = 8000,
                      seed = 1234
                      )

## extract posterior
posteriors.wc.ht <- insight::get_parameters(stmod_ht2)
```

**Prior summary**: plant_ht_cm ~ time_class*fenced + (1 | site_id)  
```{r}
# summary(stmod_ht2)
prior_summary(stmod_ht2)
```

```{r, echo=TRUE, eval=FALSE}
## model comparison.
## Run originally and code retained. stmod_ht2 selected
loo1 <- loo(stmod_ht1,
            k_threshold = 0.7) 
loo2 <- loo(stmod_ht2,
            k_threshold = 0.7) 
comp <- loo_compare(loo2, loo1)
print(comp, simplify = FALSE, digits = 2)
```

```{r}
### model checks
ppc.plot(stmod_ht2) +
  labs(x = "Value", y = "Density") +
  theme_minimal()
ggsave("./output/figures_202107/willow_height/ppc_willowht_wc.png", width = 4.75, height = 3.75, dpi = 300)
# ggsave("./output/figures_202107/willow_height/ppc_willowht_wc.pdf", width = 4.75, height = 3.75)

```

```{r}
# full posterior description
fun.desc.post1.gt.rope(stmod_ht2) %>% 
  tab_header(title = "Core Winter Range", subtitle = "Willow Height Posterior Description")

```

```{r}
#### PP check plot
ppc.plot(stmod_ht2) +
  labs(caption = "WC: willow_ht~TCxF")
# ggsave("./output/figures_202107/willow_height/ppc_willowht_wc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202107/willow_height/ppc_willowht_wc.pdf", width = 4.75, height = 3.75)
```

### Effect Description
```{r}
fun.sexit.gt(stmod_ht2)

## save as RTF
fun.sexit.gt(stmod_ht2) %>% 
  tab_header(title = "Core Winter Range", subtitle = "Willow Height Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_height/xpostdesc_willowht_TCxF_wc.rtf")
  
```

```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_ht2) %>% 
  tab_header(title = "Core Winter Range", subtitle = "Willow Height Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_height/postdesc_willowht_TCxF_wc.rtf")

```

#### Probability of Direction
```{r}
pd.wc <- p_direction(stmod_ht2)

# Visualize the pd
plot(pd.wc) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow height, core winter range") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202107/willow_height/pd_willowht_wc.png", width = 6.75, height =3.75, dpi = 300)
# ggsave("./output/figures_202107/willow_height/pd_willowht_wc.pdf", width = 6.75, height =3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
# Region Of Practical Equivalence (ROPE)
rope.wc <- rope(stmod_ht2, ci=0.9)

rope.wc.gt <- rope.wc %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 
rope.wc.gt
# rope.wc.gt %>%
#   gt::gtsave(filename = "./output/tables/willow_height/rope_willowht_wc.rtf")
```

### Contrasts

Results are given on the response scale.

```{r, echo=FALSE, eval=FALSE}
# main effects. Run, but interactions used below
### Contrasts - WC time class
wc.emm.tc <- emmeans(stmod_ht2, ~ time_class)
pairs.wc.tc <- pairs(emmeans(stmod_ht2, ~ time_class))

plot(pairs.wc.tc) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Height")

## main effect: fencing
wc.emm.fenced <- emmeans(stmod_ht2, ~ fenced)
wc.pairs.fenced <- pairs(wc.emm.fenced)

plot(wc.pairs.fenced) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Height")

```

```{r}
## Effect: TC x fencing
wc.emm.TCxF <- emmeans(stmod_ht2, ~ time_class | fenced)
wc.pairs.TCxF <- pairs(wc.emm.TCxF, reverse = TRUE)

emmeans(stmod_ht2, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type="response") + 
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Height")

ggsave("./output/figures_202107/willow_height/emm_willowht_TCxF_wc.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_202107/willow_height/emm_willowht_TCxF_wc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_ht2, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_ht2, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

```{r}
color_scheme_set("teal")

plot.mcmcareas_ht.wc <- mcmc_areas(posteriors.wc.ht,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ht.wc

ggsave("./output/figures_202107/willow_height/mcmcarea_willowht_TCxF_wc.png", dpi = 300, width = 6.75, height = 3.75)
ggsave("./output/figures_202107/willow_height/mcmcarea_willowht_TCxF_wc.pdf", width = 6.75, height = 3.75)
```


```{r}

bayesplot::mcmc_areas(posteriors.wc.ht,
           pars = c("time_class2013", "time_class2018", "time_class2013:fencedFenced","time_class2018:fencedFenced"),
           prob = 0.9) +
  theme_minimal() +
  labs(title = "Posterior distributions", subtitle = "with medians and 90% intervals", caption = "Willow height, WC")

ggsave("./output/figures_202107/willow_height/mcmcarea_willowht_TCxF_wc.png", dpi = 300, width = 6.75, height = 3.75)
ggsave("./output/figures_202107/willow_height/mcmcarea_willowht_TCxF_wc.pdf", width = 6.75, height = 3.75)

```

## Willow Height - Noncore Winter Range Macroplot Data

**Histograms of Willow Height**

```{r}
## histogram
willow.ht.nc %>% 
  ggplot() +
  geom_histogram(aes(plant_ht_cm, fill = fenced), color = "grey50") +
  # viridis::scale_fill_viridis(discrete=TRUE) +
  scale_fill_manual(values = colfunc3(1)) +
  labs(x="Plant height (cm)", y = "Count", fill = "", caption = "Core winter range plots. Macroplot heights") +
  theme_minimal() +
  facet_wrap(~time_class) +
  coord_flip()

ggsave("./output/figures_202107/willow_height/hist_willowht_TC_wnc.png", dpi = 300, width = 6.75, height = 3.75)
ggsave("./output/figures_202107/willow_height/hist_willowht_TC_wnc.pdf", width = 6.75, height = 3.75)

```

### Modeling and Posterior Description  
```{r, cache=TRUE}
## model
#### main factors only
## run with gamma
nc.stmod_ht1 <- stan_glmer(plant_ht_cm ~ time_class +  (1 | site_id), data = willow.ht.nc,
                       family=Gamma(link="log"),
                      iter = 8000,
                      )
posteriors.nc.ht <- insight::get_parameters(nc.stmod_ht1)
```



**Prior summary**: plant_ht_cm ~ time_class +  (1 | site_id)    
```{r}
prior_summary(nc.stmod_ht1)
```

```{r}
#### PP check plot
ppc.plot(nc.stmod_ht1) +
  labs(caption = "WNC: willow_ht~TC")
ggsave("./output/figures_202107/willow_height/ppc_willowht_wnc.png", dpi = 300, width = 4.75, height = 3.75)

```

### Effect Description  
```{r}
# use function defined above
fun.sexit.gt(nc.stmod_ht1)

## save as RTF
fun.sexit.gt(nc.stmod_ht1) %>% 
  tab_header(title = "Noncore Winter Range", subtitle = "Willow Height Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_height/xposterior_willowht_wnc.rtf")
```

```{r, echo=FALSE, eval = FALSE}
# describe posterior
fun.desc.post1.gt.rope(nc.stmod_ht1)%>% 
  tab_header(title = "Noncore Winter Range", subtitle = "Willow Height Posterior Description")

```

```{r, echo=FALSE, eval=FALSE}
# write to rtf
fun.desc.post1.gt.rope(nc.stmod_ht1) %>% 
  tab_header(title = "Noncore Winter Range", subtitle = "Willow Height Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_height/posterior_willowht_wnc.rtf")
```

```{r}
# tidy the posteriors
posteriors.nc.ht.tidy <- posteriors.nc.ht %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

#### Probability of Direction 
```{r}
# Visualize the pd
p_direction(nc.stmod_ht1) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow height, Noncore winter range") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202107/willow_height/pd_willowht_wnc.png", width = 6.75, height =3.75, dpi = 300)

```

#### Region of Practical Equivalence (ROPE)

```{r}
rope.wnc <- rope(nc.stmod_ht1, ci=0.9)

rope.wnc.gt <- rope.wnc %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.wnc.gt

rope.wnc.gt %>%
  gt::gtsave(filename = "./output/tables/willow_height/rope_willowht_wnc.rtf")

```

### Contrasts

Results are given on the the response scale.

```{r}
### Contrasts - WC time class
nc.emm <- emmeans(nc.stmod_ht1, ~ time_class)

nc.emm %>% 
  pairs(reverse = TRUE) %>% 
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Non-core Winter Range, Willow Height")

ggsave("./output/figures_202107/willow_height/emm_willowht_TC_wnc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(nc.stmod_ht1, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(nc.stmod_ht1, ~ time_class) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

```{r}
color_scheme_set("teal")
# color_scheme_set("teal")

plot.mcmcareas_ht.wnc <- mcmc_areas(posteriors.nc.ht,
           prob = 0.9) +
  ggtitle("Noncore Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ht.wnc

ggsave("./output/figures_202107/willow_height/mcmcarea_willowht_TCxF_wnc.png", dpi = 300, width = 6.75, height = 3.75)

```


```{r}
# bayesplot::mcmc_areas(posteriors.nc.ht,
#            pars = c("time_class2013","time_class2018"),
#            prob = 0.9) +
#   theme_minimal() +
#   labs(title = "Posterior distributions", subtitle = "with medians and 90% intervals", caption = "Willow height, WNC")
# 
# ggsave("./output/figures_202107/willow_height/mcmcarea_willowht_TC_wnc.png", dpi = 300, width = 6.75, height = 3.75)
# ggsave("./output/figures_202107/willow_height/mcmcarea_willowht_TC_wnc.pdf", width = 6.75, height = 3.75)

```


```{r}
# Revised plot 2/15/21
# willow height combined plot per revisions
## main effect: fencing
wc.emm.fenced <- emmeans(stmod_ht2, ~ fenced)
wc.pairs.fenced <- pairs(wc.emm.fenced)

plot(wc.pairs.fenced) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Height")


nc.emm %>% 
  pairs(reverse = TRUE) %>% 
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Non-core Winter Range, Willow Height")

ggsave("./output/figures_202107/willow_height/emm_willowht_TC_wnc.png", width = 4.5, height = 3.55) # save plot


```


## Willow Height - Kawuneeche Valley Macroplot Data

**Histograms of Willow Height**

```{r}
willow.ht.wk %>% 
  ggplot() +
  geom_histogram(aes(plant_ht_cm, fill = fenced), color = "grey50") +
  # viridis::scale_fill_viridis(discrete=TRUE) +
  scale_fill_manual(values = colfunc3(1)) +
  labs(x="Plant height (cm)", y = "Count", fill = "", caption = "KV. Macroplot heights") +
  theme_minimal() +
  facet_wrap(~time_class) +
  coord_flip() +
  theme(legend.position = "none")

ggsave("./output/figures_202107/willow_height/hist_willowht_TC_WK.png", dpi = 300, width = 6.75, height = 3.75)
```

### Modeling and Posterior Description

```{r}
willow.ht.wk %>% 
  distinct(yr)
  # glimpse()
```


```{r, cache=TRUE}
#### TC only (no fenced)
stmod_ht_wk_TC <- stan_glmer(plant_ht_cm ~ time_class + (1 | site_id), data = willow.ht.wk,
                      family=Gamma(link="log"),
                      iter = 8000,
                      seed = 1234
                      )
# # TCxF need the full data for fencing
# stmod_ht_wk_TCxF <- stan_glmer(plant_ht_cm ~ time_class * fenced + (1 | site_id), data = willow.ht.wk,
#                       family=Gamma(link="log"),
#                       iter = 8000,
#                       seed = 1234
#                       )

## extract posterior
posteriors.wk.ht <- insight::get_parameters(stmod_ht_wk_TC)
# posteriors.wk.ht.tc.f <- insight::get_parameters(stmod_ht_wk_TCxF)

```

**Prior summary**: plant_ht_cm ~ time_class + (1 | site_id)  
```{r}
## prior summary
prior_summary(stmod_ht_wk_TC)
```

```{r, echo = TRUE, eval=TRUE}
#### PP check plot
ppc.plot(stmod_ht_wk_TC) +
  labs(caption = "WK: willow_ht~TC")

ggsave("./output/figures_202107/willow_height/ppc_willowht_wk.png", dpi = 300, width = 4.75, height = 3.75)

```

### Effect Description
```{r}
# use function defined above
fun.sexit.gt(stmod_ht_wk_TC) 

fun.sexit.gt(stmod_ht_wk_TC) %>% 
  tab_header(title = "Kawuneeche Valley", subtitle = "Willow Height Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_height/xpostdesc_willowht_TC_wk.rtf") 

```

```{r, echo=FALSE, eval=FALSE}
# full posterior description
fun.desc.post1.gt.rope(stmod_ht_wk_TC) %>% 
  tab_header(title = "Kawuneeche Valley", subtitle = "Willow Height Posterior Description")

```

```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_ht_wk_TC) %>% 
  tab_header(title = "Kawuneeche Valley", subtitle = "Willow Height Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_height/postdesc_willowht_TC_wk.rtf")
```

#### Probability of Direction
```{r}
pdkv <- p_direction(stmod_ht_wk_TC)
# Visualise the pd
plot(pdkv) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow height, KV") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202107/willow_height/pd_willowht_wk.png", width = 6.75, height =3.75, dpi = 300)

```

#### Region of Practical Equivalence (ROPE)

```{r}
p.in.rope.kv <- rope(stmod_ht_wk_TC, ci=0.9)

pd.tab.kv <- p.in.rope.kv %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 
pd.tab.kv

pd.tab.kv %>%
  gt::gtsave(filename = "./output/tables/willow_height/rope_willowht_wk.rtf")

```

### Contrasts

```{r}
## contrasts
emmeans(stmod_ht_wk_TC, ~ time_class) %>% 
  pairs() %>% 
  # plot() + # on the lm predict scale
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "KV, Willow Height")

ggsave("./output/figures_202107/willow_height/emm_willowht_TC_wk.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_ht_wk_TC, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_ht_wk_TC, ~ time_class) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.
```

```{r}
color_scheme_set("teal")
# color_scheme_set("teal")

plot.mcmcareas_ht.wk <- mcmc_areas(posteriors.wk.ht,
           prob = 0.9) +
  ggtitle("Kawuneeche Valley") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ht.wk

ggsave("./output/figures_202107/willow_height/mcmcarea_willowht_TC_wk.png", dpi = 300, width = 6.75, height = 3.75)
```

## Willow Cover - Combined Winter Range Macroplot Data
```{r}
# read in data
# canopy.all.willow.sum <- read_csv("./output/exported_data/willow_cover_20200725.csv") %>% 
#   janitor::clean_names()

canopy.all.willow.sum <- read_csv("./output/exported_data/willow_macroplot_cover_BLto2018.csv") %>% 
  janitor::clean_names()

```

```{r, echo=FALSE}
# munge
canopy.all.willow.sum <- canopy.all.willow.sum %>% 
  mutate(burned = case_when(burned == "Y" ~ "Burned",
                            burned == "N" ~ "Unburned",
                            is.na(burned) ~ "Unburned",
                            TRUE ~ burned)) %>% 
  mutate(time_class = as_factor(time_class)) %>%
  mutate(fenced = as_factor(fenced)) %>%
  mutate(burned = as_factor(burned)) %>% 
  mutate(time_class = fct_rev(time_class)) %>% 
  mutate(fenced = fct_rev(fenced))

```

```{r}
### create subsets of data for modeling
# pull out WK, note different years of data
cov.wk <- canopy.all.willow.sum %>% 
  filter(site_type == "WK") %>%
  mutate(time_class = as.character(time_class)) %>% 
  filter(time_class == "2016" | time_class == "2017" | time_class == "2018") %>% 
  mutate(time_class = as.factor(time_class))

# pull out the core plus noncore winter range plots
cov.wc.wnc <- canopy.all.willow.sum %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  filter(site_type == "WNC" | site_type == "WC") %>% 
  mutate(cover_allwillow = cover_allwillow/100) %>% 
  filter(!is.na(cover_allwillow))

# pull out the core winter range plots
cov.wc <- canopy.all.willow.sum %>% 
  filter(site_type == "WC") %>%
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  mutate(cover_allwillow = cover_allwillow/100) %>%
  filter(!is.na(cover_allwillow))

# pull out the noncore winter range plots
cov.wnc <- canopy.all.willow.sum %>% 
  filter(site_type == "WNC") %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  mutate(cover_allwillow = cover_allwillow/100) %>% 
  filter(!is.na(cover_allwillow))

```

### Summary Tables

```{r}
#### summary tables: time class and burned
cov.wc.wnc %>% 
  group_by(time_class, fenced) %>% 
  summarytools::descr(cover_allwillow,stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "Combined WC and WNC macroplot data: willow cover - fenced + time_class")

## time class, fenced and burned
cov.wc.wnc %>% 
  group_by(time_class, fenced, burned) %>% 
  summarytools::descr(cover_allwillow, stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "Combined WC and WNC macroplot data: willow cover ~ burned + fenced + time_class")

```

### Histograms of Willow Cover

```{r, fig.width=7, fig.height=5}
cov.wc.wnc %>% 
  ggplot(aes(cover_allwillow)) +
  geom_histogram(color="grey50") +
  facet_grid(time_class~site_type) +
  theme_minimal()

ggsave("./output/figures_202107/willow_cover/hist_willowht_TC_wcwnc.png", dpi = 300, width = 6.75, height = 3.75)
```

### Modeling and Posterior Description


```{r, cache=TRUE}
# cover_allwillow \~ time_class \* fenced + (1 \| site_id)
## prep for modeling
## subtract from max to conform
#### Model
cov.wc.wnc <- cov.wc.wnc %>% 
  mutate(cover_allwillow = case_when(cover_allwillow == 1 ~ 0.999999,
                                     TRUE ~ cover_allwillow))

## model
stmod_cov.wc.wnc <- stan_glmer(cover_allwillow ~ time_class * fenced + (1 | site_id), 
                      data = cov.wc.wnc,
                      family = mgcv::betar,
                      prior_aux = exponential(1),
                      iter = 8000,
                      seed = 1234)

```

**Prior summary**: cover_allwillow ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_cov.wc.wnc)
```


```{r, echo=FALSE, eval=FALSE}
# alt model with burned as predictor
# stmod_cov.wc.wnc.b <- stan_glmer(cover_allwillow ~ time_class * fenced * burned + (1 | site_id), 
#                       data = cov.wc.wnc,
#                       family = mgcv::betar,
#                       #prior_aux = exponential(2),
#                       iter = 8000,
#                       seed = 12345)

# there are limits to the beta, but it still seems like the most sensible distribution. Unless want to go with NLR

# pp_check(stmod_cov.wc.wnc.b)

## loo - model comparison  
# cov.wc.wnc.loo1 <- loo(stmod_cov.wc.wnc)
# cov.wc.wnc.loo2 <- loo(stmod_cov.wc.wnc.b)
# loo_compare(cov.wc.wnc.loo1, cov.wc.wnc.loo2)
#                    elpd_diff se_diff
# stmod_cov.wc.wnc    0.0       0.0   
# stmod_cov.wc.wnc.b -2.2       2.5 
# original model better.
```

```{r}
#### PP check plot
# prior_summary(stmod_cov.wc.wnc)

pp_check(stmod_cov.wc.wnc) +
  labs(x = "Value", y = "Density") +
  theme_minimal() +
  labs(caption = "WC & WNC: cover_allwillow ~ time_class * fenced + (1 | site_id)")

ggsave("./output/figures_202107/willow_cover/ppc_willowcov_wcwnc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202107/willow_cover/ppc_willowcov_wcwnc.pdf", width = 4.75, height = 3.75)

```

```{r}
## extract posterior
posteriors.cov.wcwnc <- insight::get_parameters(stmod_cov.wc.wnc)
```


### Effect Description
```{r}
fun.sexit.gt(stmod_cov.wc.wnc$stanfit)

fun.sexit.gt(stmod_cov.wc.wnc$stanfit) %>%
  tab_header(title = "Combined Core and Noncore Winter Range", subtitle = "Willow Cover Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_cover/xposterior_willowht_wcwnc.rtf")
```

```{r, echo=FALSE, eval=FALSE}
#### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_cov.wc.wnc$stanfit)
```

```{r, echo=FALSE, eval=FALSE}
## save rtf
fun.desc.post1.gt.rope(stmod_cov.wc.wnc$stanfit) %>%
  tab_header(title = "Combined Core and Noncore Winter Range", subtitle = "Willow Cover Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_cover/posterior_willowht_wcwnc.rtf")
```

```{r}
color_scheme_set("teal")
# color_scheme_set("teal")

plot.mcmcareas_cov.wcwnc <- mcmc_areas(posteriors.cov.wcwnc,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans')) +
  labs(caption="mcmcarea_willowcov_TC_wcwnc.png")

plot.mcmcareas_cov.wcwnc

ggsave("./output/figures_202107/willow_cover/mcmcarea_willowcov_TC_wcwnc.png", dpi = 300, width = 6.75, height = 3.75)

```

#### Probability of Direction  
```{r}
# Visualize the pd
p_direction(stmod_cov.wc.wnc) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow cover, Core and noncore winter range") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202107/willow_cover/pd_willowht_wcwnc.png", width = 6.75, height =3.75, dpi = 300)
# ggsave("./output/figures_202107/willow_cover/pd_willowht_wcwnc.pdf", width = 6.75, height =3.75)

```

#### Region of Practical Equivalence (ROPE)  
```{r}
rope.cov.wcwnc.gt <- rope(stmod_cov.wc.wnc$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.cov.wcwnc.gt %>%
  gt::gtsave(filename = "./output/tables/willow_cover/rope_willowcov_wcwnc.rtf")
```

### Contrasts  
```{r}
# contrast - time class and fencing
emmeans(stmod_cov.wc.wnc, ~ time_class | fenced) %>% 
  pairs(reverse=TRUE) %>% 
  # plot() + # Results are given on the logit (not the response) scale.
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Cover")

ggsave("./output/figures_202107/willow_cover/emm_willowht_TCxF_wcwnc.png", width = 6.75, height =3.75, dpi = 300)
# ggsave("./output/figures_202107/willow_cover/emm_willowht_TCxF_wcwnc.pdf", width = 6.75, height =3.75)


# table of contrasts
emmeans(stmod_cov.wc.wnc, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log odds ratio, not the response scale")

emmeans(stmod_cov.wc.wnc, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale")

```


```{r}
# bayesplot::mcmc_areas(posteriors.cov.wcwnc,
#            pars = c("time_class2013", "time_class2018", "time_class2013:fencedFenced","time_class2018:fencedFenced"),
#            prob = 0.9) +
#   theme_minimal() +
#   labs(title = "Posterior distributions", subtitle = "with medians and 90% intervals", caption = "Willow height, WC & WNC")
# 
# ggsave("./output/figures_202107/willow_cover/mcmcarea_willowcov_TCxF_wcwnc.png", dpi = 300, width = 6.75, height = 3.75)
# ggsave("./output/figures_202107/willow_cover/mcmcarea_willowcov_TCxF_wcwnc.pdf", width = 6.75, height = 3.75)
```


### Effects of Burning - Combined Range

```{r, cache=TRUE, eval=TRUE}
#### Fenced and burned

stmod_cov.wc.wnc.TCxFxB <- stan_glmer(cover_allwillow ~ time_class * burned * fenced + (1 | site_id), 
                      data = cov.wc.wnc,
                      family = mgcv::betar,
                      prior_aux = exponential(1),
                      iter = 8000,
                      seed = 1234)

```

**Prior summary** cover_allwillow ~ time_class * burned * fenced + (1 | site_id) 
```{r}
prior_summary(stmod_cov.wc.wnc.TCxFxB)
```

```{r}
pp_check(stmod_cov.wc.wnc.TCxFxB) +
  labs(x = "Value", y = "Density") +
  theme_minimal()
# 
ggsave("./output/figures_202107/wc_wnc_willowcover_ppc_TCxFxB.png", dpi = 300, width = 4.75, height = 3.75)

```


```{r}
## extract posterior
posteriors.cov.wcwnc.TCxFxB <- insight::get_parameters(stmod_cov.wc.wnc.TCxFxB)
```
### Effect Description
```{r}

fun.sexit.gt(stmod_cov.wc.wnc.TCxFxB$stanfit)
```


```{r}
color_scheme_set("teal")
# color_scheme_set("teal")

plot.mcmcareas_cov.wcwnc.TCxFxB <- mcmc_areas(posteriors.cov.wcwnc.TCxFxB,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_cov.wcwnc.TCxFxB

ggsave("./output/figures_202107/willow_cover/mcmcarea_willowcov_wcwnc_TCxFxB.png", dpi = 300, width = 6.75, height = 3.75)

```


## Willow Cover - Core Winter Range Macroplot Data

### Summary Tables

```{r}
#### summary tables: time class and burned
cov.wc %>% 
  group_by(time_class) %>% 
  summarytools::descr(cover_allwillow,stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "WC macroplot data: willow cover ~ WC: all willow cover - time_class")

## time class, fenced and burned
cov.wc %>% 
  group_by(time_class, burned) %>% 
  summarytools::descr(cover_allwillow, stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "WC macroplot data: All willow cover - burned + time_class")

```

### Modeling and Posterior Description

```{r, cache=TRUE}
#### Model
## add to min and subtract from max to conform
cov.wc <- cov.wc %>% 
  mutate(cover_allwillow = case_when(cover_allwillow == 1 ~ 0.999999,
                                     TRUE ~ cover_allwillow))


stmod_cov.wc <- stan_glmer(cover_allwillow ~ time_class * fenced + (1 | site_id), 
                      data = cov.wc,
                      family = mgcv::betar,
                      prior_aux = exponential(2),
                      iter = 8000,
                      seed = 1234)

```

**Prior summary**: cover_allwillow ~ time_class * fenced + (1 | site_id)    
```{r}
prior_summary(stmod_cov.wc)
```

```{r}
#### PP check plot
pp_check(stmod_cov.wc) +
  labs(x = "Value", y = "Density") +
  theme_minimal() +
  labs(caption = "WC: cover_allwillow ~ time_class * fenced + (1 | site_id)")

ggsave("./output/figures_202107/willow_cover/ppc_willowcov_wc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202107/willow_cover/ppc_willowcov_wc.pdf", width = 4.75, height = 3.75)

```
### Effect Description
```{r}

fun.sexit.gt(stmod_cov.wc$stanfit)

fun.sexit.gt(stmod_cov.wc$stanfit) %>%
  tab_header(title = "Core Winter Range", subtitle = "Willow Cover Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_cover/posterior_willowht_wc.rtf")
```

```{r, echo=FALSE, eval=FALSE}
#### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_cov.wc$stanfit)
```

```{r, echo=FALSE, eval=FALSE}
## save rtf
fun.desc.post1.gt.rope(stmod_cov.wc$stanfit) %>%
  tab_header(title = "Core Winter Range", subtitle = "Willow Cover Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_cover/posterior_willowht_wc.rtf")

```

#### Probability of Direction
```{r}
# Visualize the pd
p_direction(stmod_cov.wc) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow cover, Core winter range") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202107/willow_cover/pd_willowht_wc.png", width = 6.75, height =3.75, dpi = 300)
# ggsave("./output/figures_202107/willow_cover/pd_willowht_wc.pdf", width = 6.75, height =3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.cov.wc.gt <- rope(stmod_cov.wc$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.cov.wcwnc.gt %>%
  gt::gtsave(filename = "./output/tables/willow_cover/rope_willowcov_wc.rtf")
```

### Contrasts

Results are given on the the response scale.

```{r}
# library(emmeans)
wc.cov.emm.TCxF <- emmeans(stmod_cov.wc, ~ time_class | fenced)

pairs(wc.cov.emm.TCxF, reverse = TRUE, type="response") %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Cover")

ggsave("./output/figures_202107/willow_cover/emm_willowht_TCxF_wc.png", width = 6.75, height =3.75, dpi = 300)
# ggsave("./output/figures_202107/willow_cover/emm_willowht_TCxF_wc.pdf", width = 6.75, height =3.75)

# table of contrasts
emmeans(stmod_cov.wc, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log odds ratio, not the response scale")

emmeans(stmod_cov.wc, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale")

```

## Willow Cover - Noncore Winter Range Macroplot Data


```{r}
#### summary tables: time class and fenced
cov.wnc %>% 
  group_by(time_class, fenced) %>% 
  summarytools::descr(cover_allwillow,stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "WNC macroplot data: willow cover")

```

### Modeling and Posterior Description

```{r, cache=TRUE}
#### Model
## add to min and subtract from max to conform
cov.wnc <- cov.wnc %>% 
  mutate(cover_allwillow = case_when(cover_allwillow == 1 ~ 0.999999,
                                     TRUE ~ cover_allwillow))

stmod_cov.wnc <- stan_glmer(cover_allwillow ~ time_class + (1 | site_id), 
                      data = cov.wnc,
                      family = mgcv::betar,
                      # prior_aux = exponential(2),
                      iter = 10000,
                      seed = 1234)



```

```{r, echo=FALSE, eval=FALSE}
shinystan::launch_shinystan(stmod_cov.wnc)
```

**Prior summary**: cover_allwillow ~ time_class + (1 | site_id)      
```{r}
prior_summary(stmod_cov.wnc)
```

```{r, echo=FALSE, eval=FALSE}
#### PP check plot
# summary(stmod_cov.wc)
# prior_summary(stmod_cov.wnc)

pp_check(stmod_cov.wnc) +
  labs(x = "Value", y = "Density") +
  theme_minimal() +
  labs(caption = "WNC: cover_allwillow ~ time_class * fenced + (1 | site_id)")

ggsave("./output/figures_202107/willow_cover/ppc_willowcov_wc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202107/willow_cover/ppc_willowcov_wc.pdf", width = 4.75, height = 3.75)

```

### Effect Description
```{r}
fun.sexit.gt(stmod_cov.wnc$stanfit)

fun.sexit.gt(stmod_cov.wnc$stanfit) %>% 
  tab_header(title = "Noncore Winter Range", subtitle = "Willow Cover Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_cover/xposterior_willowht_wnc.rtf")
```

```{r, echo=FALSE, eval=FALSE}
#### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_cov.wnc$stanfit)
```

```{r, echo=FALSE, eval=FALSE}
## save rtf
fun.desc.post1.gt.rope(stmod_cov.wnc$stanfit) %>%
  tab_header(title = "Noncore Winter Range", subtitle = "Willow Cover Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_cover/posterior_willowht_wnc.rtf")

```

#### Probability of Direction  
```{r}
# Visualize the pd
p_direction(stmod_cov.wnc) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow cover, Nnoncore winter range") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202107/willow_cover/pd_willowht_wnc.png", width = 6.75, height =3.75, dpi = 300)
# ggsave("./output/figures_202107/willow_cover/pd_willowht_wnc.pdf", width = 6.75, height =3.75)

```

#### Region of Practical Equivalence (ROPE) 
```{r}
rope.cov.wnc.gt <- rope(stmod_cov.wnc$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.cov.wnc.gt %>%
  gt::gtsave(filename = "./output/tables/willow_cover/rope_willowcov_wnc.rtf")
```

### Contrasts
```{r}
# library(emmeans)
wnc.cov.emm.TC <- emmeans(stmod_cov.wnc, ~ time_class)

pairs(wnc.cov.emm.TC, reverse = TRUE, type="response") %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Noncore Winter Range, Willow Cover. Results are given on the response scale.")

# ggsave("./output/figures_202107/willow_cover/emm_willowht_TCxF_wnc.png", width = 6.75, height =3.75, dpi = 300)

# table of contrasts
emmeans(stmod_cov.wnc, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log odds ratio, not the response scale")

emmeans(stmod_cov.wnc, ~ time_class) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale")

```

```{r, wbasin_ht, echo=FALSE, eval=FALSE}
## Wild basin
# Wild Basin willow data survey 2018.csv

wbasin <- read_csv("./data/wild_basin/Wild Basin willow data survey 2018.csv")

wbasin <- wbasin %>%
  janitor::clean_names()
  
wbasin.loc <- wbasin %>% 
  filter(!is.na(utm_e_nad83_end_point))

```

## Wild Basin Comparisons


```{r}
# read in data and preprocess for joining with EVMP data
wbasin <- read_csv("./data/wild_basin/Wild Basin willow data survey 2018.csv")

wbasin <- wbasin %>%
  janitor::clean_names()
  
wbasin.sel <- wbasin %>% 
  rename(plant_ht_cm = max_ht_cm) %>% 
  mutate(yr = 2018) %>% 
  mutate(fenced = "N") %>% 
  mutate(site_type = "WB") %>% 
  mutate(site_id = paste0("WB",point)) %>% 
  dplyr::select(c(yr, site_type, site_id, plant_ht_cm, species, fenced, location)) %>% 
  distinct()
  
```

```{r}
## process the evmp into a bindable format with wb data
willow.mcro.evmp <- willow.ht %>% 
  rename(species = species_code) %>% 
  dplyr::select(yr, site_type, species, site_id, plant_ht_cm, fenced, location) %>% 
  distinct() %>% 
  filter(yr == 2018)

#### bind wb with 2018 evmp
wb.evmp18 <- bind_rows(wbasin.sel, willow.mcro.evmp) %>% 
  distinct()

```


```{r}
### Willow height comparison among Wild Basin and EVMP plots
## compare WILLOW height

wb.evmp18 %>%
  filter(str_detect(species, "^S")) %>% 
  ggplot() +
  geom_density(aes(fill = site_type, color = site_type, lty = site_type, x = plant_ht_cm), size=1, alpha = .25) +
  theme_minimal() +
  scale_fill_manual(values = colfunc1(4)) +
  scale_color_grey() +
  # scale_fill_manual(values = colfunc3_RdBu(4)) +
  # scale_color_manual(values = colfunc3_RdBu(4)) +
  labs(x = "Willow height (cm)", y  = "Density", lty= "Site type", color = "Site type", fill = "Site type", caption = "willow height, WB + EVMP, Salix only")

ggsave("./output/figures_202107/WB_EVMP_willow_height.png", dpi = 300, width = 4.75, height = 3.75)

```

```{r}
wb.evmp18 <- wb.evmp18 %>%
  mutate(site_type.lbl = case_when(site_type == "WB" ~ "Wild Basin",
                               site_type == "WC" ~ "Core winter range",
                               site_type == "WNC" ~ "Noncore winter range",
                               site_type == "WK" ~ "Kawuneeche Valley",
                               TRUE ~ "other")) %>% 
  mutate(fenced = case_when(fenced == "N" ~ "Unfenced",
                            fenced == "Y" ~ "Fenced",
                            TRUE ~ fenced)) %>% 
  mutate(site.type.fenced = paste0(site_type.lbl,"\n",fenced))

# wb.evmp18 %>% distinct(site.type.fenced)
wb.evmp18.willows <- wb.evmp18 %>% 
  filter(str_detect(species, "^S"))

```

```{r}
wb.evmp18 %>%
  filter(str_detect(species, "^S")) %>% 
  ggplot(aes(x=reorder(site.type.fenced, plant_ht_cm), plant_ht_cm)) +
  geom_boxplot(aes(fill=site_type)) +
  # geom_density(aes(fill = site_type, color = site_type, lty = site_type, x = plant_ht_cm), alpha = 0.05) +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(4)) +
  scale_color_manual(values = colfunc2(4)) +
  theme(legend.position = "none") +
  # theme(axis.text.x = element_text(angle = 0, hjust = 1)) +
  labs(x = "", y  = "Height (cm)", lty= "Site type", color = "Site type", fill = "Site type", caption = "willow height, WB + EVMP, Salix only")

ggsave("./output/figures_202107/WB_EVMP_willow_height_boxplot.png", dpi = 300, width = 6.75, height = 4.75)

```

```{r}
wb.evmp18 %>%
  group_by(site.type.fenced) %>%
  descr(plant_ht_cm, stat="common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  arrange(-mean) %>%
  datatable(caption = "All willow species combined")
  
```


```{r}
wb.evmp18 %>%
  group_by(site.type.fenced, species) %>%
  descr(plant_ht_cm) %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  arrange(-mean) %>%
  datatable(caption = "By willow species")
```


```{r}
wb.evmp18.willows.loc <- wb.evmp18.willows %>% 
  select(-yr) %>% 
  group_by(site_id,location) %>% 
  summarytools::descr(stats = "common") %>% 
  tb() %>%
  select(c(location,mean)) %>% 
  group_by(location) %>% 
  descr(mean,stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  select(-pct.valid)

wb.evmp18.willows.loc %>%
  arrange(-mean) %>% 
  gt() 
# %>%
#   gt::gtsave(filename = "./output/tables/WB_vs_EVMP_willowHt_loc.rtf")

```

```{r}
#### range type
wb.evmp18.willows.rt <- wb.evmp18.willows %>% 
  select(-yr) %>% 
  group_by(site_id,site_type) %>% 
  summarytools::descr(stats = "common") %>% 
  tb() %>%
  select(c(site_type,mean)) %>% 
  group_by(site_type) %>% 
  descr(mean,stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  select(-pct.valid)

wb.evmp18.willows.rt %>%
  arrange(-mean) %>%
  select(-variable) %>%
  gt() #%>%
  # gt::gtsave(filename = "./output/tables/WB_vs_EVMP_willowHt_site_type.rtf")

```

```{r}
wb.evmp18 %>%
  filter(str_detect(species, "^S")) %>% 
  ggplot(aes(x=reorder(site.type.fenced, plant_ht_cm), plant_ht_cm)) +
  geom_boxplot(aes(fill=site_type)) +
  # geom_density(aes(fill = site_type, color = site_type, lty = site_type, x = plant_ht_cm), alpha = 0.05) +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(4)) +
  scale_color_manual(values = colfunc2(4)) +
  theme(legend.position = "none") +
  # theme(axis.text.x = element_text(angle = 35, hjust = 1)) +
  labs(x = "", y  = "Height (cm)", lty= "Site type", color = "Site type", fill = "Site type", caption = "willow height, WB + EVMP, Salix only")

ggsave("./output/figures_202107/WB_EVMP_willow_height_boxplot.png", dpi = 300, width = 5.75, height = 4.75)
```


```{r}
# 2 panel
pl.boxht.wc.f <- wb.evmp18 %>%
  filter(str_detect(species, "^S")) %>% 
  filter(site_type == "WC" & fenced == "Fenced") %>% 
  ggplot(aes(x=reorder(site.type.fenced, plant_ht_cm), plant_ht_cm)) +
  geom_boxplot(aes(fill=site_type)) +
  # geom_density(aes(fill = site_type, color = site_type, lty = site_type, x = plant_ht_cm), alpha = 0.05) +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(5)) +
  scale_color_manual(values = colfunc2(5)) +
  theme(legend.position = "none") +
  # theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y  = "Height (cm)", lty= "Site type", color = "Site type", fill = "Site type", caption = "willow height,  all willow spp") +
  ylim(0,600) +
  facet_wrap(~fenced, scales = "free_x")

pl.boxht.uf.all <- wb.evmp18 %>%
  filter(str_detect(species, "^S")) %>% 
  filter(fenced == "Unfenced") %>% 
  ggplot(aes(x=reorder(site.type.fenced, plant_ht_cm), plant_ht_cm)) +
  geom_boxplot(aes(fill=site_type)) +
  # geom_density(aes(fill = site_type, color = site_type, lty = site_type, x = plant_ht_cm), alpha = 0.05) +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(4)) +
  scale_color_manual(values = colfunc2(4)) +
  theme(legend.position = "none") +
  # theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y  = "", lty= "Site type", color = "Site type", fill = "Site type") +
  ylim(0,600) +
  facet_wrap(~fenced, scales = "free_x")


pl.boxht.wc.f + pl.boxht.uf.all + plot_layout(widths = c(.55,2))

ggsave("./output/figures_202107/WB_EVMP_willow_height_boxplot2.png", dpi = 300, width = 6.75, height = 4.75)

```

### Modeling and Posterior Description
```{r, cache=TRUE}
wb_rt2stan <- wb.evmp18.willows %>% 
  select(-yr) %>% 
  group_by(site_id,site_type) %>% 
  summarytools::descr(stats = "common") %>% 
  tb() %>%
  select(c(site_type,mean))

wb_stanaov <- stan_aov(mean ~ site_type, data = wb_rt2stan, 
                  prior = R2(location = 0.25), adapt_delta = 0.999,
                  iter = 8000,
                  seed = 12345)
wb_stanaov

# report::report(wb_stanaov)


```

```{r}
wb_stanglmer <- stan_lmer(mean ~ 1 + (1|site_type),
                   data = wb_rt2stan, prior_intercept = cauchy(),
                   iter=8000,
                   prior_covariance = decov(shape = 2, scale = 2),
                   adapt_delta = 0.999, seed = 12345)

summary(wb_stanglmer)#

describe_posterior(
  wb_stanglmer,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
  gt()


```

```{r, echo=FALSE, eval=FALSE}
## stan aov
describe_posterior(
  wb_stanaov,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
  gt()


pp_check(wb_stanaov)

wb.emm <- emmeans::emmeans(wb_stanaov, ~ site_type)
pairs.wb <- pairs(emmeans(wb_stanaov, ~ site_type))

gg.emm.wb.ht <- plot(pairs.wb) +
  geom_vline(aes(xintercept = 0), lty = "dashed", color = "red") +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "WB, WC WNC, Willow Height")

gg.emm.wb.ht

ggsave("./output/figures_202107/gg_emm_wildbasin_ht.png", width = 4.5, height = 3.55, dpi=300)

# report::report(wb_stanaov)
```


# Session info

R version 4.0.3 (2020-10-10)  
Platform: x86_64-w64-mingw32/x64 (64-bit)  
Running under: Windows 10 x64 (build 19041)  
Run date: `r format(Sys.time(), '%Y %B %d')`  

```{r, echo=FALSE}
# subset(data.frame(sessioninfo::package_info()), attached==TRUE, c(package, loadedversion)) %>% 
#   gt() %>% 
#   tab_header(title = "Attached packages and versions")

report::report_table(sessionInfo()) %>% 
  as_tibble() %>% 
  gt() %>% 
  tab_header(title="Package Information")

```

```{r, echo=FALSE, eval=FALSE}
iris %>% 
  rowid_to_column(var = "specimen") %>% 
#  gather(contains("."), key = "Measurement", value = "cm") %>% 
  group_by(Species) %>% 
  nest %>% 
  mutate(plot = map2(Species, data,  function (.x,.y){
    ggplot(data = .y, aes(x =  Sepal.Length, y = Sepal.Width)) +
      geom_smooth() +
      ggtitle(label = .x)
    
  })) -> iris.with.plots

iris.with.plots$plot[[1]] + iris.with.plots$plot[[2]]

iris.with.plots %>% 
  filter(Species %in% c("setosa", "versicolor")) %>% 
  pluck("plot") %>% reduce(`%+%`)  # pull(plot) %>% reduce(`%+%`) also works
```


# References
