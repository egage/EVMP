---
title: "EVMP covariate analysis"
author: ""
date: ""
output: 
  html_document: 
    theme: journal
    toc: yes
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(knitr)
opts_knit$set(root.dir=normalizePath('../')) # this is required if Rmd is nested below the project directory
opts_chunk$set(fig.path = "../output/figures/") # corrected path and added dev. Needed to specify a subdirectory for figs
```

_Code author:_ 
E. Gage  
mycologica@gmail.com  
https://github.com/egage/EVMP    
Updated: `r format(Sys.time(), '%Y %B %d')`  

```{r, echo=FALSE}
# package install
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(fs))
suppressPackageStartupMessages(library(sf))
suppressPackageStartupMessages(library(janitor))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(mapview))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(ggstance))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(skimr)) 
suppressPackageStartupMessages(library(dataMaid))
library(lubridate)
library(mapview)
library(visdat)
library(gt)
```

# Introduction  
This document contains code for running statistical analyses of of Elk
Vegetation Management Plan (EVMP) data collected through the 2018
sampling season. Analyses are limited to macroplot data from plots
established in riparian areas in areas of the elk winter range and
Kawuneeche Valley (i.e., "willow" plots, see Zeigenfuss et al. 2011) and
is provided as a supplement to the NPS NRR Report "Monitoring of
Vegetation Response to Elk Population and Habitat Management in Rocky
Mountain National Park - Analysis of Elk Vegetation Management Plan
monitoring Data: 2008--2018". For information on sampling and the
broader analysis and interpretation of the results, refer to this
report, past analyses [@zeigenfuss2015], and the original EVMP
monitoring plan [@zeigenfuss2011].

# Methods

## Covariates  
Weather and ungulate population data were used as covariates in analyses of willow offtake. Weather data were obtained from were obtained from the National Climate Data Center for Estes Park (Estes Park 3 SSE, CO US, #52761). Snow depth data were acquired from the Bear Lake Snotel Site (Site #322) located southwest of the core elk winter range. Climate data were used to examine the relationship of weather and elk population to patterns in annual offtake data. Elk population estimates produced by RMNP and outside collaborators, produced using a combination of aerial and ground surveys, were used to create annual estimates of the winter population size of elk developed using a Bayesian population model of trends in elk population size after correcting for sightability factors in aerial survey data (T. Hobbs and H. Abouelezz, unpublished data). 

The Probability of Direction (PD) was used to represent certainty associated with the most probable direction (positive or negative) of the effect (e.g., time class, fencing). The PD is correlated with the frequentist p-value, with a two-sided p-value of respectively .1, .05, and .01 approximated by a PD of 95%, 97.5%, and 99.5% [@makowski2019]. the “region of practical equivalence” (ROPE) to evaluate the probability of a parameter being outside a range that can be considered as “practically no effect”, i.e., a region enclosing values that are equivalent to the null value for practical purposes [@kruschke2018], with the proportion of the 95% HDI credible interval falling within the ROPE was used as an index for an analog to frequentist "null-hypothesis" testing.

# Results  

## Covariates
Modeled elk population estimates (T. Hobbs unpublished data) are negatively correlated with annual precipitation at both the Estes Park and Bear Lake climate stations (Figure 48). The model had moderate explanatory power (R2' median = 0.24, 89% CI [1.07e-05, 0.45], adj. R2 = 0.07). The model's intercept, corresponding to elk = 0 and precipitation = 0, is at 1291.28 (89% CI [788.17, 1818.43], 0.04% in ROPE). The effect of precipitation in the mode had a probability of 97.56% of being negative and can be considered as medium (median = -0.79, 100% in ROPE, std. median = -0.51). The algorithm successfully converged (R^ = 1.001) and estimates were stable (ESS = 1846). A similar trend but weaker correlation occurred with Bear Lake precipitation data (Figure 49). Additional results are presented in appendices.

 
Figure 51. Modeled RMNP elk population versus Estes Park annual precipitation and Bear Lake weather stations. Blue line represents a linear fit line.


## Climate

### Estes Park

Dataset	Daily Summaries
Order Start Date	1998-08-01 00:00
Order End Date	2020-08-22 23:59
Output Format	Custom GHCN-Daily CSV
Data Types	MDPR, DAPR, PRCP, SNWD, SNOW, TMAX, TMIN, TOBS
Custom Flag(s)	Station Name
Units	Metric
Stations/Locations	ESTES PARK 3 SSE, CO US (Station ID: GHCND:USC00052761)

```{r}

## import
ep.raw <- read_csv("./data/covariates/climate/NCDC_EstesPark/2257130.csv") ## METRIC UNITS

# The five core values are:
# PRCP = Precipitation (mm or inches as per user preference, inches to hundredths on Daily Form pdf file)
# SNOW = Snowfall (mm or inches as per user preference, inches to tenths on Daily Form pdf file)
# SNWD = Snow depth (mm or inches as per user preference, inches on Daily Form pdf file)
# TMAX = Maximum temperature (Fahrenheit or Celsius as per user preference, Fahrenheit to tenths on
# Daily Form pdf file
# TMIN = Minimum temperature (Fahrenheit or Celsius as per user preference, Fahrenheit to tenths on
# Daily Form pdf file

# Processing Completed	2020-08-24
# Stations	
# GHCND:USC00052761
# Begin Date	1998-08-01 00:00
# End Date	2020-08-22 23:59
# Data Types	
# MDPRDAPRPRCPSNWDSNOWTMAXTMINTOBS
# Units	
# Metric
# Custom Flag(s)	
# Station Name
# Eligible for Certification	No

```

```{r}
ep.cln <- ep.raw %>% 
  clean_names() %>% 
  mutate(month = month(date, label = TRUE, abbr = TRUE)) %>% 
  mutate(doy = lubridate::yday(date)) %>%
  mutate(year = lubridate::year(date))

```

```{r}

ep.annual.sum.prcp <- ep.cln %>% 
  group_by(year) %>% 
  summarise(ppt_mm_ann = sum(prcp)) %>% 
  ungroup()

ep.plt1 <- ep.annual.sum.prcp %>%
  filter(year > 2007 & year < 2019) %>% 
  mutate(year = as.integer(year)) %>% 
  ggplot(aes(year,ppt_mm_ann)) +
  # geom_line() +
  # geom_point() +
  geom_col(fill = 'grey40') +
  theme_minimal() +
  scale_x_continuous(breaks = seq(from = 2008, to = 2018, by = 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Year", y = "Annual precipitation (mm)", caption = "Estes Park Station GHCND:USC00052761")

ep.plt1
# ggsave("./output/figures_exported/EstesPark_AnnualPrcp.png", width = 3.85, height = 3.85)

```


### Bear Lake Snotel
```{r}
# data\covariates\climate\BearToothSnotel
snotel <- read_csv("./data/covariates/climate/BearLakeSnotel/snotel_2read.csv") %>% 
  janitor::clean_names()
```

```{r}
snotel <- snotel %>% 
  rename(swe = snow_water_equivalent_in_start_of_day_values) %>% 
  rename(ppt_accum_in = precipitation_accumulation_in_start_of_day_values) %>% 
  rename(temp_max_f = air_temperature_maximum_deg_f) %>%
  rename(temp_min_f = air_temperature_minimum_deg_f) %>%
  rename(temp_avg_f = air_temperature_average_deg_f) %>%
  rename(ppt_incr_in = precipitation_increment_in) 

snotel <- snotel %>%
  mutate(date = mdy(date)) %>% 
  mutate(month = month(date,label = TRUE),
         doy = yday(date),
         year = year(date))

```

```{r}

snotel <- snotel %>% 
  mutate(ppt_accum_mm = 25.4*ppt_accum_in) %>% 
  mutate(ppt_incr_mm = 25.4*ppt_incr_in)

snotel %>%
  visdat::vis_dat()
```

What day had the latest peak swe?


```{r}
top_ppt_accum <- snotel %>% 
  group_by(year) %>% 
  summarise(ppt_accum_mm_max = max(ppt_accum_mm)) %>% 
  ungroup()

ppt.pl <- top_ppt_accum %>% 
  filter(year >1980 & year < 2019) %>% 
  # mutate(year = as.character(year)) %>%
  ggplot(aes(year,ppt_accum_mm_max)) +
  geom_col(fill = "ivory4") +
  labs(x="", y = "Accumulated precipitation (mm)", caption = "Bear Lake Snotel Data") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_continuous(breaks = seq(from = 1980, to = 2018, by = 5))
  
# ppt.pl

```

```{r}
top_swe <- snotel %>% 
  mutate(year = as.character(year)) %>%
  group_by(year) %>% 
  summarise(sum_swe = sum(swe)) %>% 
  ungroup()


swe.pl <- top_swe %>%
  filter(year>1980 & year <2019) %>% 
  # mutate(year = as.character(year)) %>%
  mutate(year = as.integer(year)) %>%
  ggplot(aes(year,sum_swe)) +
  geom_col(fill = "grey60") +
  # geom_jitter() +
  labs(x="", y = "SWE") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_continuous(breaks = seq(from = 1980, to = 2018, by = 5))

swe.pl

# ggsave("./output/figures_exported/bearLk_SWE.png", width = 3.85, height = 3.85)

```

```{r}
cowplot::plot_grid(swe.pl,ppt.pl, labels = "AUTO")
# ggsave("./output/figures_exported/bear_lk_swe_ppt.png", width = 6.5, height = 3.8)
```


```{r}
top_swe %>% 
  select(year, sum_swe) %>% 
  datatable(rownames = FALSE, filter = "top")
```

## Physiographic
```{r}
# distance from stream



```

## Elk
```{r}

elk.raw <- read_csv("./data/covariates/elk/RMNP_Population_summary.csv") %>% 
  janitor::clean_names()

```

```{r}
elk.raw <- elk.raw %>% 
  mutate(year = as.integer(year))

## write to disk
# write_csv(elk.raw, "./data/covariates/elk/RMNP_elk_pop_summary_cln.csv")

elk.raw %>% 
  ggplot(aes(x = year, y = median)) +
  geom_point(color = "blue") +
  geom_line(color = "blue") +
  geom_line(aes(y = p025), color = "red", lty = "dashed") +
  geom_line(aes(y = p975), color = "red", lty = "dashed") +
  theme_minimal() +
  labs(x = "Year", y = "Median elk populatiop estimate", caption = "Modeled elk pop: RMNP_Population_summary.csv ")

# ggsave("./output/figures_exported/elk_population.png", width = 5, height = 4, dpi = 300)
```

```{r}
elk.raw %>% 
  gt::gt() %>% 
  gt::gtsave("./output/tables/elkpop.rtf")

elk.raw %>% 
  summarytools::descr(median) 

elk.raw %>% 
  arrange(desc(median))

elk.raw %>% 
  arrange((median))
```


## elk vs climate
```{r}
## Hobbs modeled elk vs Estes Park prcp

elk.raw %>% arrange(desc(year))
elk.ep_prcp <- left_join(ep.annual.sum.prcp,elk.raw, by = "year")

elk.ep_prcp %>% 
  ggplot(aes(x = year)) +
  geom_col(aes(y = ppt_mm_ann)) +
  geom_col(aes(y = median), color = "red")

pl.cov1 <- elk.ep_prcp %>% 
  ggplot() +
  geom_point(aes(x = ppt_mm_ann, y = median)) +
  # geom_smooth(aes(x = ppt_mm_ann, y = median)) +
  geom_smooth(aes(x = ppt_mm_ann, y = median), method = "glm") +
  theme_minimal() +
  labs(x= "Annual precipitation (mm)", y = "Number of elk", caption = "Hobbs modeled elk vs Estes Park prcp") 

pl.cov1
# ggsave("./output/figures_exported/covariates/elk_v_prcp.png", width = 3.75, height = 4)  

top_swe <- top_swe %>% 
  mutate(year = as.integer(year))

elk.ep_EPprcp_BLkppt <- left_join(elk.ep_prcp, top_ppt_accum, by = "year")
```

```{r}
pl.cov2 <- elk.ep_EPprcp_BLkppt %>% 
  ggplot() +
  geom_point(aes(x = ppt_accum_mm_max , y = median)) +
  # geom_smooth(aes(x = ppt_mm_ann, y = median)) +
  geom_smooth(aes(x = ppt_accum_mm_max , y = median), method = "glm") +
  theme_minimal() +
  labs(x= "Annual precipitation (mm)", y = "Number of elk", caption = "Hobbs modeled elk vs Bear Lake SWE")
pl.cov2

lm(median ~ ppt_mm_ann, data = elk.ep_EPprcp_BLkppt)

```


```{r}
library(moderndive)
mod.elkXepPrcp <- lm(median ~ ppt_mm_ann, data = elk.ep_EPprcp_BLkppt) 

mod.elkXepPrcp %>% 
  moderndive::get_regression_table() %>% 
  gt() %>% 
  tab_header(title = "lm: elk media ~ Estes Park annual prcp")


mod.elkXblkPrcp <- lm(median ~ ppt_accum_mm_max, data = elk.ep_EPprcp_BLkppt) 

## broom::
broom::tidy(mod.elkXblkPrcp)

## report::
# devtools::install_github("neuropsychology/report")

library(report)
mod.elkXblkPrcp
# report::report(mod.elkXepPrcp)
# report::report(mod.elkXblkPrcp)

broom::tidy(mod.elkXblkPrcp) %>% 
  gt() %>% 
  tab_header(title = "lm: elk media ~ Bear Lk annual prcp")

```

```{r}
# bayesian lm
library(rstanarm)

stanlm.elkXep <- stan_glm(median ~ ppt_accum_mm_max, data = elk.ep_EPprcp_BLkppt,
                         chains = 5, iter = 1000,
                         seed = 12345,
                         refresh = 0)

plot(stanlm.elkXep, "hist", pars = c("ppt_accum_mm_max", "sigma"), 
     transformations = list(sigma = "log"))
report::report(stanlm.elkXep )

```

```{r}
## plot grid
cowplot::plot_grid(pl.cov1, pl.cov2, labels = "AUTO")
# ggsave("./output/figures_exported/covariates/prcp_x_elk_2panel.png", width = 6.5, height = 3.75, dpi = 300)
```


## elk vs offtake upland


## climate vs elk

## Moose

# Results

