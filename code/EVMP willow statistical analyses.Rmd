---
title: "EVMP Willow Statistical Analyses"
author: ""
date: ""
output: 
  html_document: 
    theme: journal
    toc: yes
    toc_depth: 3
editor_options: 
  markdown: 
    wrap: 72
bibliography: references.bib
---

```{r setup, include=FALSE}
# Rmd setup
library(knitr)
opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.align = 'center')
opts_knit$set(root.dir=normalizePath('../')) # this is required if Rmd is nested below the project directory
opts_chunk$set(fig.path = "../output/figures/") 
# set seed
set.seed(1234)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}
# Read in libraries
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(fs))
suppressPackageStartupMessages(library(sf))
suppressPackageStartupMessages(library(janitor))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(mapview))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(ggstance))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(skimr)) 
suppressPackageStartupMessages(library(dataMaid))
library(lubridate)
library(mapview)
library(emmeans)
library(rstanarm)
# rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
library(bayestestR)
library(gt)
library(glue)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}
## Functions
### Table functions
## function to describe model out
fun.desc.post1 <- function(model){
  describe_posterior(
  model,
  effects = "fixed",
  component = "all",
  ci_method = "hdi",
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
    as_tibble() %>% 
    DT::datatable(caption = "Posterior description")
}

## Functions for summarizing posterior distributions, creating tables with the gt
fun.desc.post1.gt <- function(model){
  describe_posterior(
  model,
  effects = "fixed",
  component = "all",
  ci_method = "hdi",
  test = c("rope"),
  #rope_range(c(-0.1,0.1)),
  rope_range("default"),
  centrality = "median"
) %>% 
    as_tibble() %>% 
    gt() %>% 
    tab_header(title = "Posterior description") %>% 
    fmt_number(
    columns = 2:12,
    decimals = 1,
    suffixing = TRUE
  )
}

# describe posterior
fun.desc.post1.gt.rope <- function(model){
  describe_posterior(
  model,
  effects = "fixed",
  component = "all",
  ci_method = "hdi",
  test = c("p_direction", "p_significance","rope"),
  #rope_range(c(-0.1,0.1)),
  rope_range("default"),
  centrality = "median"
) %>% 
    as_tibble() %>% 
    gt() %>% 
    tab_header(title = "Posterior description") %>% 
    fmt_number(
    columns = 2:11,
    decimals = 1,
    suffixing = TRUE
  )
}

```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}

#### Plotting functions
fun.contrast.plot <- function(df){
  df %>% 
  ggplot(aes(x = contrast)) +
  geom_linerange(aes(ymin = lower.HPD, ymax = upper.HPD), color = "lightblue", size = 2) +
  geom_point(aes(y = estimate), size = 2.5) +
  theme_minimal() +
  labs(caption = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Estimate") +
  coord_flip()
}

## ppcheck.plot
ppc.plot <- function(model){
  pp_check(model) +
  labs(x = "Value", y = "Density") +
  theme_minimal()
}

```

# Introduction

This document contains code for running statistical analyses of of Elk
Vegetation Management Plan (EVMP) data collected through the 2018
sampling season. Analyses are limited to macroplot data from plots
established in riparian areas in areas of the elk winter range and
Kawuneeche Valley and is provided as a supplement to the NPS NRR Report
"Monitoring of Vegetation Response to Elk Population and Habitat
Management in Rocky Mountain National Park - Analysis of Elk Vegetation
Management Plan monitoring Data: 2008--2018". For information on
sampling and the broader analysis and interpretation of the results,
refer to this report, past analyses [@zeigenfuss2015], and the original
EVMP monitoring plan [@zeigenfuss2011].

# Methods

The code and results presented here start from and build upon derived
data produced in a separate code document focused on ingesting,
compiling, and cleaning raw data provided by RMNP staff. Extensive
"munging" of raw files was required, so the decision was made to
separate code used to pre-process raw data from code used for the
analyses presented here. Likewise, separate code documents were
developed for other distinct elements of the larger EVMP (e.g., aspen
and upland plots).

Bayesian repeated measures analyses were fit separately for combined
core and non-core winter range, core winter range (WC) and non-core
winter range plots (WNC). For willow height, models were fit using
weekly informative priors and a gamma distribution with the "stan_lmer"
function in the "rstanarm" package [@goodrich2020][@brilleman2018a].

For continuous proportions such as plant cover (i.e, those not derived
from count data), a common approach to modeling is to transform data
then use ordinary linear models, however this creates problems for
interpretation and inference [@douma2019]. Techniques relying on
transformations make estimates on the transformed scale, requiring
back‐transformation for reporting and interpretation. However, the
relationship between the original and transformed proportions is often
non‐linear, creating issues for interpretation [@douma2019]. Alternative
approaches using beta regression [@cribari-neto2009][@ferrari2004] have
been developed and are relied on here for modeling continuous
proportions (e.g., willow cover). After fitting appropriate models using
"rstanarm" functions, comparisons of estimated marginal means were made
between time classes and management classes (e.g., fencing) using
functions in the "emm" R package [@lenth2020].

```{r}
#### Data import and munging
# read in willow. These data are the output of extensive munging accomplished using code in "EVMP_munging_20210131.Rmd"

willow <- read_csv("./output/exported_data/willow_mcro.csv")

willow <- willow %>% 
  select(-c(contains("UTM"))) 

## create timeClass var
willow.ht <- willow %>% 
  filter(!is.na(PLANT_HT_CM)) %>% 
  mutate(timeClass = case_when(yr == 2008 ~ "BL",
                              yr == 2009 ~ "BL", 
                              TRUE ~ as.character(yr))) 

## filter to 5 yr sampling interval, chr to factor conversions
willow.ht <- willow.ht %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>%
  mutate(timeClass = as.factor(timeClass)) %>% 
  mutate(timeClass = fct_relevel(timeClass, "2018", "2013", "BL")) %>% 
  mutate(FENCED = as.factor(FENCED))

## clean names
willow.ht <- willow.ht %>% 
  janitor::clean_names()

## filter out just the willow species
willow.ht <- willow.ht %>%
  filter(str_detect(species_code, pattern = "SA"))

## filter out 0
willow.ht <- willow.ht %>% 
  filter(plant_ht_cm > 0)

## reorder the time class
willow.ht <- willow.ht %>% 
  mutate(time_class = fct_rev(time_class))

## factor reverse: fenced
willow.ht <- willow.ht %>%
  mutate(fenced = fct_rev(fenced))

```

```{r}
## create separate df for WC, WNC, combined WC & WNC, and KV
willow.ht.wc <- willow.ht %>% 
  filter(site_type == "WC") 

# non core
willow.ht.nc <- willow.ht %>% 
  # distinct(site_type)
  filter(site_type == "WNC") 

# combined WC and WNC
willow.ht.wc.wnc <- willow.ht %>% 
  # distinct(site_type)
  filter(site_type == "WNC" | site_type == "WC") 

# kw (note: different munging workflow needed b/c of different sampling yrs)
willow.ht.wk <- willow %>%
  clean_names() %>%
  filter(str_detect(species_code, pattern = "SA")) %>% 
  filter(site_type == "WK") %>% 
  mutate(fenced = as.factor(fenced)) %>% 
  filter(plant_ht_cm > 0) %>% 
  mutate(time_class = as.factor(time_class)) %>% 
  mutate(fenced = fct_rev(fenced))

```

# Results

## Willow Height - Combined Core and Noncore Winter Range Macroplot Data

```{r, cache=TRUE, include=FALSE, echo=FALSE}
#### main factors only
## run with gamma

wc.wnc.stmod_TCxF <- stan_glmer(plant_ht_cm ~ time_class*fenced +  (1 | site_id), data = willow.ht.wc.wnc,
                       family=Gamma(link="log"),
                      iter = 10000,
                      )
```

```{r, include=FALSE}
# Get the prior summary
# prior_summary(wc.wnc.stmod_TCxF)

# Extract posteriors
posteriors.wc.wnc.ht <- insight::get_parameters(wc.wnc.stmod_TCxF)

## tidy
posteriors.wc.wnc.ht.tidy <- posteriors.wc.wnc.ht %>%
  pivot_longer(cols = starts_with("time"), names_to = "variable", values_to = "values")

```

```{r}
#### PP check plot
ppc.plot(wc.wnc.stmod_TCxF) +
  labs(caption = "WC+WNC: willow_ht~TCxF")
# ggsave("./output/figures_exported/wc_wnc_willowht_ppc1.png", dpi = 300, width = 4.75, height = 3.75)
```

```{r, echo=FALSE}
#### Model posterior parameters to table
## View
fun.desc.post1.gt(wc.wnc.stmod_TCxF) %>% 
  tab_header(title = "Combined WC and WNC Willow Height", subtitle = "Willow Height Posterior Description")

## save as RTF
# fun.desc.post1.gt(wc.wnc.stmod_TCxF) %>% 
#   gt::gtsave(filename = "./output/tables/wc_wnc_stmod_TCxF_posteriors.rtf")
```

```{r, include=FALSE, echo=FALSE, eval = FALSE}
# Posterior: just the point estimates
point_estimate(wc.wnc.stmod_TCxF) %>% 
  gt()
# note: not run as redundant with above table
```

```{r, echo=FALSE, eval=FALSE}
## density plots
# library(ggridges)

# untransformed
posteriors.wc.wnc.ht.tidy %>%
  ggplot() +
  geom_density(aes(fill = variable, x = values, color = variable), alpha = .12) +
  theme_minimal()

```

#### PD

```{r}

pd.wc.wnc <- p_direction(wc.wnc.stmod_TCxF)
# Visualize the pd
wc.wnc.wilht.pd <- plot(pd.wc.wnc)
wc.wnc.wilht.pd +
  theme_minimal() +
  labs(caption = "Willow height, Combined Core and Non-core Winter Range")
# ggsave("./output/figures_exported/pd_wc_wnc_willowht.png", dpi = 300, width = 6.75, height =3.75)
# ggsave("./output/figures_exported/pd_wc_wnc_willowht.pdf", width = 6.75, height =3.75)



```

```{r}
p.in.rope.wc.wnc <- rope(wc.wnc.stmod_TCxF, ci=1)

pd.table.wc.wnc <- p.in.rope.wc.wnc %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 
pd.table.wc.wnc
# pd.table.wc.wnc %>%
#   gt::gtsave(filename = "./output/tables/wc_wnc_willowht_percent_in_ROPE.rtf")
```

### Contrasts

```{r, include=FALSE, echo=FALSE}
# library(emmeans)
# Note: EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs(pigs.emm.s, reverse = TRUE). Also, in multi-factor situations, you may specify by factor(s) to perform the comparisons separately at the levels of those factors.

# main effects
## main effect: time class
wc.wnc.emm.tc <- emmeans(wc.wnc.stmod_TCxF, ~ time_class)
wc.wnc.pairs.timeClass <- pairs(wc.wnc.emm.tc)

plot(wc.wnc.pairs.timeClass) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Height")
# ggsave("./output/figures_exported/gg_emm_wc_wnc_ht_TC.pdf", width = 4.5, height = 3.55) # save plot

## main effect: fencing
wc.wnc.emm.fenced <- emmeans(wc.wnc.stmod_TCxF, ~ fenced)
wc.wnc.pairs.fenced <- pairs(wc.wnc.emm.fenced)

plot(wc.wnc.pairs.fenced) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Height")

# ggsave("./output/figures_exported/gg_emm_wc_wnc_ht_fenced.pdf", width = 4.5, height = 3.55) # save plot

## the above is not run b/c interactions
```

```{r}
## Effect: TC x fencing
wc.wnc.emm.TCxF <- emmeans(wc.wnc.stmod_TCxF, ~ fenced | time_class)
wc.wnc.pairs.TCxF <- pairs(wc.wnc.emm.TCxF, reverse = TRUE)

plot(wc.wnc.pairs.TCxF) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Height")

# ggsave("./output/figures_exported/gg_emm_wc_wnc_ht_TCxF.pdf", width = 4.5, height = 3.55) # save plot
# ggsave("./output/figures_exported/gg_emm_wc_wnc_ht_TCxF.png", width = 4.5, height = 3.55) # save plot


## alternative ordering of main effects
emmeans(wc.wnc.stmod_TCxF, ~ time_class | fenced) %>% 
  pairs(reverse=TRUE) 

emmeans(wc.wnc.stmod_TCxF, ~ time_class | fenced) %>% 
  pairs(reverse=TRUE) %>% 
  plot() +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Height")

# ggsave("./output/figures_exported/gg_emm_wc_wnc_ht_FxTC.pdf", width = 4.5, height = 3.55) # save plot
# ggsave("./output/figures_exported/gg_emm_wc_wnc_ht_FxTC.png", width = 4.5, height = 3.55) # save plot

```

Compute Confidence/Credible/Compatibility Intervals (CI)

```{r}
# Compute HDI and ETI
ci(posteriors.wc.wnc.ht, method = "HDI", ci =0.95) %>% 
  gt()

```

## Willow Height - Core Winter Range Macroplot Data

```{r}
### histograms of height
willow.ht.wc %>% 
  ggplot() +
  geom_histogram(aes(plant_ht_cm), color = "black") +
  labs(x="Plant height (cm)", y = "Count") +
  theme_minimal() +
  facet_grid(fenced~time_class) +
  labs(caption = "WC: willow height")

# ggsave("./output/figures_exported/gg_wc_ht_histogram.png", dpi = 300, width = 4.75, height = 5.75)
# ggsave("./output/figures_exported/gg_wc_ht_histogram.pdf", width = 4.75, height = 5.75)

```

```{r, eval = TRUE, cache=TRUE}
#### null model
# run for comparisons but not otherwise reported
# stmod_ht.0 <- stan_glmer(plant_ht_cm ~ 1 + (1 | site_id), data = willow.ht.wc,
#                        family=Gamma(link="log"),
#                       iter = 10000,
#                       )

# prior_summary(stmod_ht.0)
# pp_check(stmod_ht.0)

#### main factors only
## Run, but not used for reporting after model comparisons
stmod_ht1 <- stan_glmer(plant_ht_cm ~ time_class + fenced + (1 | site_id), data = willow.ht.wc,
                      family=Gamma(link="log"),
                      iter = 10000,
                      )
# prior_summary(stmod_ht1)
# pp_check(stmod_ht1)

```

```{r, cache=TRUE}
#### main factors + interactions
# After model comparisons, this is the model reported
## run with gamma
stmod_ht2 <- stan_glmer(plant_ht_cm ~ time_class*fenced + (1 | site_id), data = willow.ht.wc,
                       family=Gamma(link="log"),
                      iter = 10000,
                      )

## extract posterior
posteriors.wc.ht <- insight::get_parameters(stmod_ht2)
```

```{r, echo=FALSE, eval=FALSE}
# summary(stmod_ht2)
prior_summary(stmod_ht2)
```

```{r, echo=FALSE, eval=FALSE}
## model comparison.
## Run originally and code retained
loo1 <- loo(stmod_ht1,
            k_threshold = 0.7) 
loo2 <- loo(stmod_ht2,
            k_threshold = 0.7) 
comp <- loo_compare(loo2, loo1)
print(comp, simplify = FALSE, digits = 2)

```

```{r}
### model checks
ppc.plot(stmod_ht2) +
  labs(x = "Value", y = "Density") +
  theme_minimal()
# ggsave("./output/figures_exported/wc_willowht_ppc1.png", dpi = 300, width = 4.75, height = 3.75)
```

```{r}
# Posterior: point estimates
# point_estimate(stmod_ht2) %>%
#   gt() %>% 
#   tab_header(title = "Indices of centrality",subtitle = "plant_ht_cm ~ time_class*fenced + (1 | site_id)")# Get indices of centrality

# full
describe_posterior(
  stmod_ht2,
  effects = "fixed",
  component = "all",
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
  gt() %>% 
  tab_header(title = "Model information", subtitle = "WC: plant_ht_cm ~ time_class*fenced + (1 | site_id)")

```

```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt(stmod_ht2) %>% 
  gt::gtsave(filename = "./output/tables/wc_wh_stmod2_posteriors.rtf")

```

### PD

```{r}
# Compute indices
pd <- p_direction(stmod_ht2)
percentage_in_rope <- rope(stmod_ht2, ci=1)

percentage_in_rope %>% 
  gt() %>% 
  tab_header(title = "Percent in ROPE")

# Visualise the pd
pdpd1 <- plot(pd)
pdpd1 +
  theme_minimal() +
  labs(caption = "Willow height, core winter range")

# ggsave("./output/figures_exported/pd_wc_willowht.png", dpi = 300, width = 6.75, height =3.75)

# pdplotfun1 <- function(model){
#   pdir = p_direction(model)
#   plpd = plot(pdir)
# }
# 
# pdplotfun1(stmod_ht2)
```

### Contrasts

```{r, echo=FALSE, eval=FALSE}
# main effects. Run, but interactions used below
### Contrasts - WC time class
wc.emm.tc <- emmeans(stmod_ht2, ~ time_class)
pairs.wc.tc <- pairs(emmeans(stmod_ht2, ~ time_class))

plot(pairs.wc.tc) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Height")

# ggsave("./output/figures_exported/gg_emm_wc_ht.png", width = 4.5, height = 3.55, dpi=300)

## main effect: fencing
wc.emm.fenced <- emmeans(stmod_ht2, ~ fenced)
wc.pairs.fenced <- pairs(wc.emm.fenced)

plot(wc.pairs.fenced) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Height")

```

```{r}
## Effect: TC x fencing
wc.emm.TCxF <- emmeans(stmod_ht2, ~ fenced | time_class)
wc.pairs.TCxF <- pairs(wc.emm.TCxF, reverse = TRUE)

plot(wc.pairs.TCxF) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Height")

# ggsave("./output/figures_exported/gg_emm_wc_wht_TCxF.pdf", width = 4.5, height = 3.55) # save plot
# ggsave("./output/figures_exported/gg_emm_wc_wht_TCxF.png", width = 4.5, height = 3.55) # save plot
```

```{r}
# Compute Confidence/Credible/Compatibility Intervals (CI) 
ci(posteriors.wc.ht, method = "HDI", ci =0.95)

```

```{r}
willow.ht.wc %>% 
  mutate(time_class = fct_rev(time_class)) %>% 
  ggplot() +
  # geom_density(aes(plant_ht_cm, fill = fenced), color = "black") +
  geom_histogram(aes(plant_ht_cm, fill = fenced), color = "black") +
  viridis::scale_fill_viridis(discrete=TRUE) +
  labs(x="Plant height (cm)", y = "Count", fill = "", caption = "Core winter range plots. Macroplot heights") +
  theme_minimal() +
  facet_wrap(~time_class) +
  coord_flip()

# ggsave("./output/figures_exported/gg_wc_ht_fenced_histogram.png", dpi = 300, width = 6.75, height = 3.75)
# ggsave("./output/figures_exported/gg_wc_ht_fenced_histogram.pdf", width = 6.75, height = 3.75)

```

## Willow Height - Noncore Winter Range Macroplot Data

```{r}
## histogram
willow.ht.nc %>% 
  ggplot() +
  # geom_density(aes(plant_ht_cm, fill = fenced), color = "black") +
  geom_histogram(aes(plant_ht_cm, fill = fenced), color = "black") +
  viridis::scale_fill_viridis(discrete=TRUE) +
  labs(x="Plant height (cm)", y = "Count", fill = "", caption = "Core winter range plots. Macroplot heights") +
  theme_minimal() +
  facet_wrap(~time_class) +
  coord_flip()

# ggsave("./output/figures_exported/gg_nc_ht_fenced_histogram.png", dpi = 300, width = 6.75, height = 3.75)

```

```{r}
## model
#### main factors only
## run with gamma
nc.stmod_ht1 <- stan_glmer(plant_ht_cm ~ time_class +  (1 | site_id), data = willow.ht.nc,
                       family=Gamma(link="log"),
                      iter = 10000,
                      )

# prior_summary(nc.stmod_ht1)
pp_check(nc.stmod_ht1)

```

```{r, eval = FALSE}
# Posterior: point estimates
# point_estimate(nc.stmod_ht1) %>% 
#   gt()

describe_posterior(
  nc.stmod_ht1,
  effects = "fixed",
  component = "all",
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
  gt() %>% 
  tab_header(title = "Posterior description", subtitle = "Noncore Winter Range, Willow Height")

```

```{r}

```

```{r}
posteriors.nc.ht <- insight::get_parameters(nc.stmod_ht1)

# tidy the posteriors
posteriors.nc.ht.tidy <- posteriors.nc.ht %>%
  # names()
  pivot_longer(cols = starts_with("time"), names_to = "variable", values_to = "values")

```

### PD

```{r}
pdnc <- p_direction(nc.stmod_ht1)
p.in.rope <- rope(nc.stmod_ht1, ci=1)

pd.tab.wnc <- p.in.rope %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 
pd.tab.wnc
# pd.tab.wnc %>% 
#   gt::gtsave(filename = "./output/tables/wnc_wh_percent_in_ROPE.rtf")

# Visualise the pd
wnc.wilht.pd <- plot(pdnc)
wnc.wilht.pd +
  theme_minimal() +
  labs(caption = "Willow height, Non-core winter range")
# ggsave("./output/figures_exported/pd_wc_willowht.png", dpi = 300, width = 6.75, height =3.75)
```

```{r}
# Compute HDI
ci(posteriors.nc.ht, method = "HDI", ci = 0.95) %>% 
  gt()

```

```{r}
# Compute prob direction
nc.pd <- p_direction(nc.stmod_ht1)
nc.ht.rope <- rope(nc.stmod_ht1, ci=1)

# Visualize the pd
plot(nc.pd) +
  theme_minimal() +
  labs(caption = "Willow height, WNC", subtitle = "plant_ht_cm ~ time_class +  (1 | site_id)")
# ggsave("./output/figures_exported/pd_WNC_willowht.png", dpi = 300, width = 6.75, height =3.75)
# ggsave("./output/figures_exported/pd_WNC_willowht.png", width = 6.75, height =3.75)

```

### Contrasts

```{r}
### Contrasts - WC time class
nc.emm <- emmeans(nc.stmod_ht1, ~ time_class,)

nc.pairs.timeClass <- pairs(nc.emm, reverse = TRUE)

gg.emm.nc.ht <- plot(nc.pairs.timeClass) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Non-core Winter Range, Willow Height")

# ggsave("./output/figures_exported/gg_emm_nc_ht.png", width = 4.5, height = 3.55, dpi=300)
# ggsave("./output/figures_exported/gg_emm_nc_ht.pdf", width = 4.5, height = 3.55)

```

## Willow Height - Kawuneeche Valley Macroplot Data

```{r}
willow.ht.wk %>% 
  ggplot() +
  geom_histogram(aes(plant_ht_cm, fill = fenced), color = "black") +
  viridis::scale_fill_viridis(discrete=TRUE) +
  labs(x="Plant height (cm)", y = "Count", fill = "", caption = "KV. Macroplot heights") +
  theme_minimal() +
  facet_wrap(~time_class) +
  coord_flip()
# ggsave("./output/figures_exported/gg_kw_ht_fenced_histogram.png", dpi = 300, width = 6.75, height = 3.75)
```

```{r, echo = FALSE, eval=FALSE}
### Model spec
kv.stmod_ht1 <- stan_glmer(plant_ht_cm ~ time_class + (1 | site_id), data = willow.ht.wk,
                       family=Gamma(link="log"),
                      iter = 10000,
                      )
prior_summary(kv.stmod_ht1)

#### PP check plot
ppc.plot(kv.stmod_ht1)
# ggsave("./output/figures_exported/wkv_willowht_ppc1.png", dpi = 300, width = 4.75, height = 3.75)

```

```{r, echo = FALSE, eval=FALSE}
#### Model posterior parameters to table
fun.desc.post1.gt(kv.stmod_ht1) %>% 
  gt::gtsave(filename = "./output/tables/wnc_kv_stmod_ht1_posteriors.rtf")

pdkv <- p_direction(kv.stmod_ht1)
p.in.rope.kv <- rope(kv.stmod_ht1, ci=1)

pd.tab.kv <- p.in.rope.kv %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 
pd.tab.kv
# pd.tab.wnc %>% 
#   gt::gtsave(filename = "./output/tables/wnc_wh_percent_in_ROPE.rtf")

# Visualise the pd
kv.wilht.pd <- plot(pdkv)
kv.wilht.pd +
  theme_minimal() +
  labs(caption = "Willow height, KV")
# ggsave("./output/figures_exported/pd_kv_willowht.png", dpi = 300, width = 6.75, height =3.75)

## contrasts
kv.emm <- emmeans(kv.stmod_ht1, ~ fenced)

kv.pairs.fenced <- pairs(kv.emm)

kv.pairs.fenced.exp <- kv.pairs.fenced %>% 
  as_tibble() %>% 
  mutate_if(.predicate = is.numeric,.funs = exp)
  
gg.emm.kv.ht <- plot(kv.pairs.fenced) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "KV, Willow Height")

gg.emm.kv.ht
# ggsave("./output/figures_exported/gg_emm_nc_ht.png", width = 4.5, height = 3.55, dpi=300)

# fun.contrast.plot(nc.pairs.timeClass.exp)

```

```{r, wbasin_ht}
## Wild basin
# Wild Basin willow data survey 2018.csv

wbasin <- read_csv("./data/wild_basin/Wild Basin willow data survey 2018.csv")

wbasin <- wbasin %>%
  janitor::clean_names()
  
wbasin.loc <- wbasin %>% 
  filter(!is.na(utm_e_nad83_end_point))

```

## Willow Cover - Combined Core and Noncore Winter Range Macroplot Data

```{r}
# read in data
canopy.all.willow.sum <- read_csv("./output/exported_data/willow_cover_20200725.csv") %>% 
  janitor::clean_names()

```

```{r, echo=FALSE}
# munge
canopy.all.willow.sum <- canopy.all.willow.sum %>% 
  mutate(burned = case_when(burned == "Y" ~ "Burned",
                            burned == "N" ~ "Unburned",
                            is.na(burned) ~ "Unburned",
                            TRUE ~ burned)) %>% 
  mutate(time_class = as_factor(time_class)) %>%
  mutate(fenced = as_factor(fenced)) %>%
  mutate(burned = as_factor(burned))

```

```{r}
### create subsets of data for modeling
# pull out WK, note different years of data
cov.wk <- canopy.all.willow.sum %>% 
  filter(site_type == "WK") %>%
  mutate(time_class = as.character(time_class)) %>% 
  filter(time_class == "2016" | time_class == "2017" | time_class == "2018") %>% 
  mutate(time_class = as.factor(time_class))

# pull out the core plus noncore winter range plots
cov.wc.wnc <- canopy.all.willow.sum %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  filter(site_type == "WNC" | site_type == "WC") %>% 
  mutate(cover_allwillow = cover_allwillow/100) %>% 
  filter(!is.na(cover_allwillow))

# pull out the core winter range plots
cov.wc <- canopy.all.willow.sum %>% 
  filter(site_type == "WC") %>%
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  mutate(cover_allwillow = cover_allwillow/100) %>%
  filter(!is.na(cover_allwillow))

# pull out the noncore winter range plots
cov.wnc <- canopy.all.willow.sum %>% 
  filter(site_type == "WNC") %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  mutate(cover_allwillow = cover_allwillow/100) %>% 
  filter(!is.na(cover_allwillow))

```

```{r, echo=FALSE, eval=FALSE, fig.width=7, fig.height=7}
canopy.all.willow.sum %>% 
  ggplot(aes(cover_allwillow)) +
  geom_histogram() +
  facet_grid(time_class~site_type) +
  theme_minimal()

```

```{r}
#### summary tables: time class and burned
cov.wc.wnc %>% 
  group_by(time_class, fenced) %>% 
  summarytools::descr(cover_allwillow,stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "Combined WC and WNC macroplot data: willow cover - fenced + time_class")

## time class, fenced and burned
cov.wc.wnc %>% 
  group_by(time_class, fenced, burned) %>% 
  summarytools::descr(cover_allwillow, stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "Combined WC and WNC macroplot data: willow cover ~ burned + fenced + time_class")

```

```{r, echo=FALSE, eval=FALSE, fig.width=7, fig.height=5}
cov.wc.wnc %>% 
  ggplot(aes(cover_allwillow)) +
  geom_histogram() +
  facet_grid(time_class~site_type) +
  theme_minimal()

```

```{r}
## prep for modeling

## add to min and subtract from max to conform
#### Model
cov.wc.wnc <- cov.wc.wnc %>% 
  mutate(cover_allwillow = case_when(cover_allwillow == 1 ~ 0.999999,
                                     TRUE ~ cover_allwillow))

```

```{r, cache=TRUE}
## model
stmod_cov.wc.wnc <- stan_glmer(cover_allwillow ~ time_class * fenced + (1 | site_id), 
                      data = cov.wc.wnc,
                      family = mgcv::betar,
                      prior_aux = exponential(1),
                      iter = 10000,
                      seed = 12345)

# alt model with burned as predictor
# stmod_cov.wc.wnc.b <- stan_glmer(cover_allwillow ~ time_class * fenced * burned + (1 | site_id), 
#                       data = cov.wc.wnc,
#                       family = mgcv::betar,
#                       #prior_aux = exponential(2),
#                       iter = 10000,
#                       seed = 12345)

# there are limits to the beta, but it still seems like the most sensible distribution. Unless want to go with NLR

# pp_check(stmod_cov.wc.wnc.b)

## loo - model comparison  
# cov.wc.wnc.loo1 <- loo(stmod_cov.wc.wnc)
# cov.wc.wnc.loo2 <- loo(stmod_cov.wc.wnc.b)
# loo_compare(cov.wc.wnc.loo1, cov.wc.wnc.loo2)
#                    elpd_diff se_diff
# stmod_cov.wc.wnc    0.0       0.0   
# stmod_cov.wc.wnc.b -2.2       2.5 
# original model better.
```

```{r}
#### PP check plot
# prior_summary(stmod_cov.wc.wnc)

pp_check(stmod_cov.wc.wnc) +
  labs(x = "Value", y = "Density") +
  theme_minimal() +
  labs(caption = "WC & WNC: cover_allwillow ~ time_class * fenced + (1 | site_id)")

# ggsave("./output/figures_exported/wc_wnc_willowcover_ppc1.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_exported/wc_wnc_willowcover_ppc1.pdf", width = 4.75, height = 3.75)

```

```{r, eval = TRUE}
#### Model posterior parameters to table
fun.desc.post1.gt(stmod_cov.wc.wnc$stanfit)

## save
# fun.desc.post1.gt(stmod_cov.wc.wnc$stanfit) %>% 
#   gt::gtsave(filename = "./output/tables/wc_wnc_stmod_cover1_posteriors.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# main effect - fencing
wc.wnc.cov.emm <- emmeans(stmod_cov.wc.wnc, ~ time_class)

pairs(wc.wnc.cov.emm) %>% 
  plot() +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Cover")

# ggsave("./output/figures_exported/gg_emm_wc_wnc_cov_TC.png", width = 4.5, height = 3.55, dpi=300)
# ggsave("./output/figures_exported/gg_emm_wc_wnc_cov_TC.pdf", width = 4.5, height = 3.55)

```

```{r}
# contrast - time class and fencing
wc.wnc.cov.emm.TCxF <- emmeans(stmod_cov.wc.wnc, ~ time_class | fenced)

pairs(wc.wnc.cov.emm.TCxF) %>% 
  plot() +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Cover")

# ggsave("./output/figures_exported/gg_emm_wc_wnc_cov_TCxF.png", width = 4.5, height = 3.55, dpi=300)
# ggsave("./output/figures_exported/gg_emm_wc_wnc_cov_TCxF.pdf", width = 4.5, height = 3.55)

```

```{r, cache=TRUE, eval=TRUE}
#### Fenced and burned

stmod_cov.wc.wnc.TCxFxB <- stan_glmer(cover_allwillow ~ time_class * burned * fenced + (1 | site_id), 
                      data = cov.wc.wnc,
                      family = mgcv::betar,
                      prior_aux = exponential(1),
                      iter = 10000,
                      seed = 12345)

```

```{r}
# prior_summary(stmod_cov.wc.wnc.TCxFxB)

pp_check(stmod_cov.wc.wnc.TCxFxB) +
  labs(x = "Value", y = "Density") +
  theme_minimal()
# 
# ggsave("./output/figures_exported/wc__wnc_willowcover_ppc_TCxFxB.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_exported/wc__wnc_willowcover_ppc_TCxFxB.pdf", width = 4.75, height = 3.75)

```

```{r}
# contrast - time class and fencing
wc.wnc.cov.emm.TCxFxB <- emmeans(stmod_cov.wc.wnc.TCxFxB, ~ time_class | fenced | burned)

pairs(wc.wnc.cov.emm.TCxFxB) %>% 
  plot() +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Cover")

# ggsave("./output/figures_exported/gg_emm_wc_wnc_cov_TCxFxB.png", width = 4.5, height = 6.75, dpi=300)
# ggsave("./output/figures_exported/gg_emm_wc_wnc_cov_TCxFxB.pdf", width = 4.5, height = 6.75)

```

## Willow Cover - Core Winter Range Macroplot Data

```{r}
#### summary tables: time class and burned
cov.wc %>% 
  group_by(time_class) %>% 
  summarytools::descr(cover_allwillow,stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "WC macroplot data: willow cover ~ WC: all willow cover - time_class")

## time class, fenced and burned
cov.wc %>% 
  group_by(time_class, burned) %>% 
  summarytools::descr(cover_allwillow, stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "WC macroplot data: All willow cover - burned + time_class")

```

```{r, echo=FALSE, eval=FALSE, fig.width=7, fig.height=5}
cov.wc %>% 
  ggplot(aes(cover_allwillow)) +
  geom_histogram() +
  facet_grid(time_class~site_type) +
  theme_minimal()

```

```{r, cache=TRUE}
#### Model
## add to min and subtract from max to conform
cov.wc <- cov.wc %>% 
  mutate(cover_allwillow = case_when(cover_allwillow == 1 ~ 0.999999,
                                     TRUE ~ cover_allwillow))


stmod_cov.wc <- stan_glmer(cover_allwillow ~ time_class * fenced + (1 | site_id), 
                      data = cov.wc,
                      family = mgcv::betar,
                      prior_aux = exponential(2),
                      iter = 10000,
                      seed = 12345)

```

```{r}
#### PP check plot
# summary(stmod_cov.wc)
prior_summary(stmod_cov.wc)

pp_check(stmod_cov.wc) +
  labs(x = "Value", y = "Density") +
  theme_minimal() +
  labs(caption = "WC: cover_allwillow ~ time_class * fenced + (1 | site_id)")

# ggsave("./output/figures_exported/wc_willowcover_ppc1.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_exported/wc_willowcover_ppc1.pdf", width = 4.75, height = 3.75)

```

```{r, eval = TRUE}
#### Model posterior parameters to table
fun.desc.post1.gt(stmod_cov.wc$stanfit)

## save
# fun.desc.post1.gt(stmod_cov.wc$stanfit) %>% 
#   gt::gtsave(filename = "./output/tables/wc_stmod_cover1_posteriors.rtf")

```

```{r}
# library(emmeans)
wc.cov.emm.TCxF <- emmeans(stmod_cov.wc, ~ time_class | fenced)

pairs(wc.cov.emm.TCxF) %>% 
  plot() +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Cover")

# ggsave("./output/figures_exported/gg_emm_wc_cov.png", width = 4.5, height = 3.55, dpi=300)

```

```{r}
# p direction core winter range
pd.wc.cov.fenced <- p_direction(stmod_cov.wc)

# Visualize the pd
plot(pd.wc.cov.fenced) +
  theme_minimal() +
  labs(caption = "Willow cover, core winter range")

# ggsave("./output/figures_exported/pd_wc_cov_fenced.png", dpi = 300, width = 6.75, height =5.75)

```

## Willow Cover - Noncore Winter Range Macroplot Data

```{r, cache=TRUE}
#### Model
## add to min and subtract from max to conform
cov.wnc <- cov.wnc %>% 
  mutate(cover_allwillow = case_when(cover_allwillow == 1 ~ 0.999999,
                                     TRUE ~ cover_allwillow))

stmod_cov.wnc <- stan_glmer(cover_allwillow ~ time_class + (1 | site_id), 
                      data = cov.wnc,
                      family = mgcv::betar,
                      prior_aux = exponential(1),
                      iter = 10000,
                      seed = 12345)
```

```{r}
# library(emmeans)
wnc.cov.emm.TC <- emmeans(stmod_cov.wnc, ~ time_class)

pairs(wnc.cov.emm.TC) %>% 
  plot() +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Noncore Winter Range, Willow Cover")

# ggsave("./output/figures_exported/gg_emm_wc_cov.png", width = 4.5, height = 3.55, dpi=300)

```

# References
