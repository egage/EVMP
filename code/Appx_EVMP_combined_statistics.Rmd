---
title: "Supplemental materials - Combined statistical analyses"
author: ''
date: ''
output:
  word_document:
    toc: yes
    toc_depth: '2'
  html_document:
    theme: journal
    toc: yes
    toc_depth: 2
    code_folding: hide
editor_options:
  markdown:
    wrap: 72
bibliography: references.bib
---

*Repository:*\
<https://github.com/egage/EVMP>   

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center')
opts_knit$set(root.dir=normalizePath('../')) # this is required if Rmd is nested below the project directory
opts_chunk$set(fig.path = "../output/figures/") # corrected path and added dev. Needed to specify a subdirectory for figs

set.seed(1234)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(janitor))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(lubridate))
library(emmeans)
library(rstanarm)
options(mc.cores = parallel::detectCores())
library(bayestestR)
library(gt)
library(glue)
library(ggridges)
library(shinystan)
library(patchwork)
library(bayesplot)
library(summarytools)
library(flextable)

```


# asp funcs
```{r, functions, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}
### Table functions

fun.sexit.2plot <- function(model){
  bayestestR::sexit(model, ci=0.9) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric), round, 2))
  }


fun.sexit.gt <- function(model){
  bayestestR::sexit(model, ci=0.9) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric), round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Effect Existence and Significance Testing") 
  }

## model summary to gt
fun.model.summary <- function(model){
  summary(model,
          probs = c(0.1, 0.5, 0.9),
          digits = 1) %>%
  as_tibble(rownames = "Parameter") %>%
  dplyr::filter(!grepl('site_id', Parameter)) %>% 
  mutate(across(where(is.numeric),round,3)) %>%
  gt()
}

## model summary to kable
fun.model.summary.kable <- function(model){
  summary(model,
          probs = c(0.1, 0.5, 0.9),
          digits = 1) %>%
  as_tibble(rownames = "Parameter") %>%
  dplyr::filter(!grepl('site_id', Parameter)) %>% 
  mutate(across(where(is.numeric),round,2)) %>%
  kable(caption = "Model summary")
}

## function to describe model output
fun.desc.post1 <- function(model){
  describe_posterior(
  model,
  effects = "fixed",
  component = "all",
  ci_method = "hdi",
  # priors = TRUE,
  ci=0.9,
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
    as_tibble() %>% 
    mutate(across(where(is.numeric),round,2)) %>%
    kable()
    # DT::datatable(caption = "Posterior description")
}

fun.desc.post1.flextable <- function(model){
  describe_posterior(
  model,
  effects = "fixed",
  component = "all",
  ci_method = "hdi",
  # priors = TRUE,
  ci=0.9,
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
    as_tibble() %>% 
    mutate(across(where(is.numeric),round,2)) %>%
    flextable()
    # DT::datatable(caption = "Posterior description")
}

## gt
# describe posterior
# fun.desc.post1.gt.rope <- function(model){
#   describe_posterior(
#   model,
#   effects = "fixed",
#   component = "all",
#   ci_method = "hdi",
#   ci=0.9,
#   test = c("p_direction", "p_significance","rope"),
#   #rope_range(c(-0.1,0.1)),
#   rope_range("default"),
#   rope_ci = 0.95,
#   centrality = "median"
# ) %>% 
#     as_tibble() %>% 
#     gt() %>% 
#     tab_header(title = "Posterior description") %>% 
#     fmt_number(
#     columns = 2:14,
#     decimals = 2,
#     suffixing = TRUE
#   )
# }

#### Plotting functions
fun.contrast.plot <- function(df){
  df %>% 
  ggplot(aes(x = contrast)) +
  geom_linerange(aes(ymin = lower.HPD, ymax = upper.HPD), color = "lightblue", size = 2) +
  geom_point(aes(y = estimate), size = 2.5) +
  theme_minimal() +
  labs(caption = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Estimate") +
  coord_flip()
}

## ppcheck.plot
ppc.plot <- function(model){
  pp_check(model) +
  labs(x = "Value", y = "Density") +
  theme_minimal()
}

## emmip fence x tc
plotF.emmip_FxTC_response <- function(model){
  emmip(model, fenced ~ time_class, type = "response") +
  theme_minimal() +
  scale_color_manual(values = colfunc3(2)) +
  labs(color="") +
  theme(legend.position = "top")
  # theme(legend.position = c(.15, .15))
}

plotF.emmip_TC_response <- function(model){
  emmip(model, time_class, type = "response") +
  theme_minimal() +
  scale_color_manual(values = colfunc3(2)) +
  labs(color="") +
  theme(legend.position = "top")
  # theme(legend.position = c(.15, .15))
}

## describe posterior to DT
desc.post1 <- function(model){
  describe_posterior(
  model,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
    as_tibble() %>% 
    DT::datatable(caption = "Posterior description")
}

```

```{r}
# custom gradients and palettes
dbhclass.gradient5 <- c("#26185F", "#0095AF", "#9ADCBB", "#FCFFDD", "grey50")

colfunc1<-colorRampPalette(c("#26185F","#0095AF","#9ADCBB", "#FCFFDD"))
colfunc2<-colorRampPalette(c("#0095AF","#9ADCBB", "#FCFFDD"))
colfunc3<-colorRampPalette(c("#0095AF","#9ADCBB"))
colfunc3_RdBu <- colorRampPalette(c("#EF8A62", "#FDDBC7", "#D1E5F0", "#67A9CF"))

# plot(rep(1,50),col=(colfunc1(50)), pch=19,cex=2)
# plot(rep(1,5),col=(colfunc1(5)), pch=19,cex=2)
pal.5a <- colfunc1(5)
pal.7a <- colfunc1(7)

# palette3 <- RColorBrewer::brewer.pal(6,"RdBu")
# RColorBrewer::display.brewer.pal(6,"RdBu")

```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}
### Table functions


# flextable as option??
set_flextable_defaults(
  font.size = 10, theme_fun = theme_vanilla,
  padding = 6,
  background.color = "#EFEFEF")
# flextable(world_phones)

## Functions for summarizing posterior distributions, creating tables with the gt
fun.sexit.gt <- function(model){
  bayestestR::sexit(model, ci=0.9) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric), round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Effect Existence and Significance Testing") }

fun.sexit.kable <- function(model){
  bayestestR::sexit(model, ci=0.9) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric), round, 2)) %>% 
  kable() }

fun.sexit.flextable <- function(model){
  bayestestR::sexit(model, ci=0.9) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric), round, 2)) %>% 
  flextable() }

## original optimized for html
fun.desc.post1.gt.rope <- function(model){
  describe_posterior(
  model,
  effects = "fixed",
  component = "all",
  ci_method = "hdi",
  ci=0.9,
  test = c("p_direction", "p_significance","rope"),
  #rope_range(c(-0.1,0.1)),
  rope_range("default"),
  rope_ci = 0.9,
  centrality = "median") %>%
  as_tibble() %>%
  mutate(across(where(is.numeric), round, 1)) %>%
  gt() %>%
  tab_header(title = "Posterior description")
}

## b/c word desired
fun.desc.post1.kable.rope <- function(model){
  describe_posterior(
  model,
  effects = "fixed",
  component = "all",
  ci_method = "hdi",
  ci=0.9,
  test = c("p_direction", "p_significance","rope"),
  #rope_range(c(-0.1,0.1)),
  rope_range("default"),
  rope_ci = 0.9,
  centrality = "median") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  kable()
}


```

```{r}
## custom ggplot emm

emm.func.tc.x.fenced <- function(model){
  emmeans(model, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  ggplot() +
  geom_linerange(aes(y=contrast, xmin=lower.HPD, xmax=upper.HPD), color="#babefa", size=2.5) +
  geom_point(aes(x=estimate, y=contrast)) +
  theme_minimal() +
  geom_vline(xintercept = 0, lty="dashed", size=1) +
  facet_wrap(~fenced, ncol=1)
}

```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}

#### Plotting functions
fun.contrast.plot <- function(df){
  df %>% 
  ggplot(aes(x = contrast)) +
  geom_linerange(aes(ymin = lower.HPD, ymax = upper.HPD), color = "lightblue", size = 2) +
  geom_point(aes(y = estimate), size = 2.5) +
  theme_minimal() +
  labs(caption = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Estimate") +
  coord_flip()
}

## ppcheck.plot
ppc.plot <- function(model){
  pp_check(model) +
  labs(x = "Value", y = "Density") +
  theme_minimal()
}

# session info: verbose
package_versions <- function(packages=NULL, base=FALSE, sort=FALSE) {
    #' Determine package versions.
    #' 
    #' @param packages Packages to query; if not specified (or \code{NULL}),
    #' all currently attached packages are queried.
    #' @param base If \code{TRUE}, include the base package (R version).
    #' @param sort If \code{TRUE}, sort package names alphabetically. 
    #' @return Data frame with package names and corresponding versions.
    if (is.null(packages))
        packages <- names(sessionInfo()$otherPkgs)
    if (base)
        packages <- c("base", packages)
    if (sort)
        packages <- sort(packages)
    if (!is.null(packages)) {
        tmp <- data.frame(sapply(sapply(packages, packageVersion, simplify=FALSE), as.character))
        colnames(tmp) <- "version"
        data.frame(package=rownames(tmp), version=tmp[1], row.names=NULL)
    }
}

```

# Introduction

This document provides supporting information on statistical analyses of Elk
Vegetation Management Plan (EVMP) data collected through the 2018
sampling season in the NPS NRR Report
"Monitoring of Vegetation Response to Elk Population and Habitat
Management in Rocky Mountain National Park - Analysis of Elk Vegetation
Management Plan monitoring Data: 2008--2018". Separate analyses were run for plots established in
aspen, willow and upland communities and for the elk winter range (core and noncore
areas) and the Kawuneeche Valley. For information on
sampling and the broader analysis and interpretation of the results,
refer to the body of the report, past analyses [@zeigenfuss2015], and the original
EVMP monitoring plan [@zeigenfuss2011].

# Methods

The code and results presented here start from and build upon derived
data produced in a separate code document focused on ingesting,
compiling, and cleaning raw data provided by RMNP staff. In general, packages included 
in the "Tidyverse" ecosystem of R packages were used for data transformation and
visualization [@wickham2019]. Specialized packages particular
to specific tasks (e.g., the "bayesplot" plot for visualization of
Bayesian posterior distributions) were also used [@gabry2019].


Bayesian repeated measures analyses were fit separately for combined
core and noncore winter range, core winter range, and noncore
winter range plots with plots treated as random factors using the
'stan_glmer' function in the rstanrm package
[@goodrich2020][@brilleman2018]. In addition, models were fit to particular subgroups of data (e.g., short saplings vs tall saplings).

Bayesian estimation was performed via
MCMC adding independent weakly informed priors specific to the data type
being modeled. Count data like aspen stem counts were modeled as poisson processes, while
proportion data (e.g., cover) were modeled using a beta distribution
(Ferrari and Cribari-Neto 2004), which constrains values from 0 to 1.

Bayesian models view a model parameter $\theta$ as a [*random variable*]. In contrast, frequentist models treat model parameters as unknown *constant*. Rather than estimating an unknown constant, Bayesian modeling focuses on an unknown distribution of parameter values.

Using *Bayes' Law*, model parameters are estimated:

$$
\begin{equation} \label{eq:bayeslaw}
P(\theta | y, X) = \frac{P(y|\theta,X) \cdot P(\theta)}{P(y)} \propto P(y|\theta,X) \cdot P(\theta).
\end{equation}
$$

Where:

+ $X$: The observed data
+ $y$: The outcomes
+ $P(\theta|y,X)$: Our view of the possible value of our model parameters after seeing the data
+ $P(y|\theta,X)$: The likelihood of seeing the current outcome conditioned on the data in hand and a specific parameter value
+ $P(\theta)$: Our view of the possible values of our model parameters before observing any actual data, i.e. the *prior*
+ $P(y)$: The unconditional probability of the outcome, i.e. the probability after considering all possible parameter.

The objective is to estimate the posterior density of parameter $P(\theta|y,X)$, typically described in terms of a point estimate of the expected value of posterior density (e.g., the median of the distribution) and a measure of the variance. To solve for $P(\theta|y,X)$ analytically, the data likelihood $P(y|\theta,X)$, prior $P(\theta)$, and marginal likelihood of outcome $P(y)$ are needed, but because there is usually no closed-form analytic solution, Markov chain Monte Carlo (MCMC) methods are used to numerically solve the posterior density by directly generating random draws of parameters.  
General steps in a Bayesian analysis include:

*Specify a joint distribution for the outcome(s) and unknowns, which is proportional to a posterior distribution of the unknowns conditional on the observed data.  
*Use Markov Chain Monte Carlo (MCMC) to draw from posterior distribution.  
*Evaluation of model fit and revise the model as appropriate.   

## Aspen data

For an observation $y$ that is assumed to follow a Poisson
distribution (e.g., aspen stem count data), the likelihood for one observation can be written as:

$$\tfrac{1}{y!} \lambda^y e^{-\lambda},$$

where $\lambda = E(y | \mathbf{x}) = g^{-1}(\eta)$ and $\eta = \alpha +
\mathbf{x}^\top \boldsymbol{\beta}$ is a linear predictor. For the Poisson 
distribution it is also true that $\lambda = Var(y | \mathbf{x})$, i.e. the 
mean and variance are both $\lambda$. The rate parameter $\lambda$ must be positive, so with a Poisson GLM, the _link_ function $g$ maps between the positive real numbers $\mathbb{R}^+$ (thesupport of $\lambda$) and the set of all real numbers $\mathbb{R}$. When applied to a linear predictor $\eta$ with values in $\mathbb{R}$, the inverse link
function $g^{-1}(\eta)$ returns a positive real number.

The standard link function for a Poisson GLM is the log link $g(x) = \ln{(x)}$. With the log link, the inverse link function is the exponential function and the likelihood for a single observation is:

$$\frac{g^{-1}(\eta)^y}{y!} e^{-g^{-1}(\eta)} = 
\frac{e^{\eta y}}{y!} e^{-e^\eta}.$$

With independent prior distributions, the joint posterior distribution for 
$\alpha$ and $\boldsymbol{\beta}$ in the Poisson model is proportional to the
product of the priors and the $N$ likelihood contributions:

$$f\left(\alpha,\boldsymbol{\beta} | \mathbf{y},\mathbf{X}\right) \propto
  f\left(\alpha\right) \times \prod_{k=1}^K f\left(\beta_k\right) \times
  \prod_{i=1}^N {
  \frac{g^{-1}(\eta_i)^{y_i}}{y_i!} e^{-g^{-1}(\eta_i)}}.$$
  
This is the posterior distribution drawn from when using MCMC.  
The Probability of Direction (PD) was used to represent certainty
associated with the most probable direction (positive or negative) of
the effect (e.g., time class, fencing). The PD is correlated with the
frequentist p-value, with a two-sided p-value of respectively .1, .05,
and .01 approximated by a PD of 95%, 97.5%, and 99.5% [@makowski2019].
The "region of practical equivalence" (ROPE) was used to evaluate the probability
of a parameter being outside a range that can be considered as
"practically no effect", i.e., a region enclosing values that are
equivalent to the null value for practical purposes [@kruschke2018].
The proportion of the 95% HDI credible interval falling within the
ROPE was used as an index for an analog to frequentist "null-hypothesis"
testing.


# update below

For analyses of aspen count data, entailing separate models for combined winter range, core and noncore winter range subsets of plots, a random effects model was used for inference:

\mu_i\ =\ \exp\left(\alpha+\beta_1x_{1,i}\ +\beta_2x_{2,i}\ +\ \beta_3x_{3,i}\ +\ \beta_4x_{4,i}\ +\ \beta_5x_{5,i}\ +\ \gamma_i\right)

\gamma_i\ \sim\ Normal\ \left(0\ ,\ \sigma^2\right)

y_i\ \sim\ Poisson\left(\mu_i\right)

where yi is the count of aspen stems in the ith plot; x1,i is a indicator variable that equals one if the observation in plot i was from 2013 and zero otherwise; x2,i is an indicator variable that equals one if the observation in plot i was from 2018 and zero otherwise; x3 is an indicator variable that equals one if the fenced and zero otherwise. Separate models were developed with inclusion of burning as a factor. Otherwise, analyses included both burned and unburned plots.

Interpretation of model coefficients: The intercept (exp(α)) represents the mean count of aspen in unfenced plots during the baseline year; exp(β1) is the multiplicative change in mean counts that occurred during the time interval between the baseline year and 2013; exp(β2) is the multiplicative change in mean counts that occurred during the time interval between the baseline year and 2018; and exp(β2) is the multiplicative change in mean counts that was caused by fencing. 

Inferences were made on the difference between means. 

So, for example, the mean of counts in year 2013 in the fenced plots could be computed as µˆfence, 2013  = exp(α + β1 + β3) and in unfenced plots as µˆopen, 2013  = exp(α + β1),  and a contrast showing the difference between the means is then µˆfence, 2013 − µˆopen, 2013.  Differences between year classes were computed similarly.


## Willow plot and Upland plot data  

### Height

Bayesian repeated measures analyses of shrub height were fit separately for combined
core and non-core winter range, core winter range, and non-core
winter range plots. Separate models were also fit to different groups of species. 
Shrub height models were fit using weekly informative priors and a gamma distribution with the "stan_glmer"
function in the "rstanarm" package [@goodrich2020][@brilleman2018]. Gamma regression is commonly used when the response variable is continuous and positive.

For the simplest case a GLM for a continuous outcome is simply a linear model 
and the likelihood for one observation is a conditionally normal probability density function.  
$$\frac{1}{\sigma \sqrt{2 \pi}} e^{-\frac{1}{2} 
\left(\frac{y - \mu}{\sigma}\right)^2},$$
where $\mu = \alpha + \mathbf{x}^\top \boldsymbol{\beta}$ is a linear predictor
and $\sigma$ is the standard deviation of the error in predicting
the outcome, $y$. A linear predictor $\eta = \alpha + \mathbf{x}^\top 
\boldsymbol{\beta}$ can more generally be related to the conditional mean of the outcome via a 
link function $g$. This maps the range of values on which the 
outcome is defined. For the gamma distribution used in the modeling of willow height, 
the log link function was used. The likelihood is the product of the likelihood contributions of individual observations.

Bayesian analysis requires specifying prior distributions $f(\alpha)$ and
$f(\boldsymbol{\beta})$ for the intercept and vector of regression coefficients.
Prior distributions were represented by normal distributions with a mean zero and a small standard deviation (scale)). The joint posterior distribution for
$\alpha$ and $\boldsymbol{\beta}$ is proportional to the product of the priors 
and the $N$ likelihood contributions:

$$f\left(\boldsymbol{\beta} | \mathbf{y},\mathbf{X}\right) \propto
  f\left(\alpha\right) \times \prod_{k=1}^K f\left(\beta_k\right) \times
  \prod_{i=1}^N {f(y_i|\eta_i)},$$
  
where $\mathbf{X}$ is the matrix of predictors and $\eta$ the linear predictor, i.e., the posterior distribution that `stan_glmer` draws from using MCMC.

### Cover

Willow and upland shrub cover data were modeled using the beta distribution with the likelihood:
$$
f(y_i | a, b) = \frac{y_i^{(a-1)}(1-y_i)^{(b-1)}}{B(a,b)}
$$
where $B(\cdot)$ is the beta function. The shape parameters for the distribution
are $a$ and $b$ and enter into the model according to the following transformations,
$$
a = \mu\cdot\phi \\
b = (1-\mu)\cdot\phi
$$

If $g_1(\cdot)$ is some link function, the specification of the shape
parameters, $\mu = g_1^{-1}(\mathbf{X}\boldsymbol{\beta})$, where $\boldsymbol{X}$
is a $N\times K$ dimensional matrix of predictors, and $\boldsymbol{\beta}$, is a $K$
dimensional vector of parameters associated with each predictor. $\phi$ is a scalar parameter. With the shape parameter values included, the likelihood takes the
form:
$$
f(y_i | \mu, \phi) = \frac{y_i^{(\mu\phi-1)}(1-y_i)^{((1-\mu)\phi-1)}}{B(\mu\phi,(1-\mu)\phi)}
$$

Bayesian analysis requires specifying prior distributions $f(\boldsymbol{\beta})$ and $f(\phi)$ for the vector of regression coefficients and $\phi$. 
When modeling $\phi$ with a linear predictor a full Bayesian analysis requires
specifying the prior distributions $f(\boldsymbol{\beta})$ and $f(\boldsymbol{\gamma})$.

With a single set of explanatory variables, the posterior distribution of
$\boldsymbol{\beta}$ and $\phi$ is proportional to the product of the likelihood
contributions, the $K$ priors on the $\beta_k$ parameters, and $\phi$,
$$
f(\boldsymbol{\beta},\phi|\mathbf{y},\mathbf{X}) \propto 
\prod_{i=1}^N f(y_i | a, b) \times 
\prod_{k=1}^K f(\beta_k) \times
f(\phi)
$$

With two sets of explanatory variables, the posterior distribution of $\boldsymbol{\beta}$ and
$\boldsymbol{\gamma}$ is proportional to the product of the likelihood contribution, the $K$
priors on the $\beta_k$ parameters, and the $J$ priors on the $\gamma_j$ parameters,

$$
f(\boldsymbol{\beta},\boldsymbol{\gamma}|\mathbf{y},\mathbf{X}) \propto 
\prod_{i=1}^N f(y_i | a, b) \times 
\prod_{k=1}^K f(\beta_k) \times
\prod_{j=1}^J f(\gamma_j)
$$

```{r}
## read in data
# !!! check the read in below - a major change

# Aspen dbh
# ht_perc1 <- read_csv("./output/exported_data/asp_ht_perc1_20200309.csv")
dbh_perc1 <- read_csv("./output/exported_data/asp_dbh_perc1_20210601.csv")

ht_perc1 <- read_csv("./output/exported_data/asp_ht_perc1_20200309.csv")


# Data munging

## filter out in-between years
ht_perc1 <- ht_perc1 %>%
  filter(timeClass %in% c("BL","2013", "2018")) 

### factor relevel
ht_perc1 <- ht_perc1 %>% 
  mutate(timeClass = as.factor(timeClass)) %>% 
  mutate(timeClass = fct_relevel(timeClass, "BL", "2013", "2018")) %>% 
  mutate(RANGE_TYPE = as.factor(RANGE_TYPE)) %>% 
  mutate(RANGE_TYPE = fct_relevel(RANGE_TYPE, "core winter range","non-core winter range","Kawuneeche Valley"))   

dbh_perc1 <- dbh_perc1 %>% 
  filter(timeClass %in% c("BL","2013", "2018")) %>% 
  mutate(timeClass = as.factor(timeClass)) %>% 
  mutate(timeClass = fct_relevel(timeClass, "BL", "2013", "2018")) %>% 
  mutate(RANGE_TYPE = as.factor(RANGE_TYPE)) %>% 
  mutate(RANGE_TYPE = fct_relevel(RANGE_TYPE, "core winter range","non-core winter range","Kawuneeche Valley"))  

```

```{r}
# factor conversions...

ht_perc1 <- ht_perc1 %>% 
  clean_names() %>% 
  rename(htclass2 = h_tclass2) %>% 
  rename(htclass = h_tclass)

## set factor levels for burned and fenced
ht_perc1 <- ht_perc1 %>%
  mutate(fenced.long = case_when(fenced == "N" ~ "Unfenced",
                                 fenced == "Y" ~ "Fenced",
                                 TRUE ~ fenced)) %>% 
  mutate(burned = case_when(burned == "Not burned" ~ "Unburned",
                            TRUE ~ burned)) %>%
  mutate(fenced.long = as_factor(fenced.long)) %>%
  mutate(burned = as_factor(burned))

# convert 'fenced' to factor
ht_perc1 <- ht_perc1 %>%
  mutate(fenced = as_factor(fenced)) %>% 
  mutate(burned = as_factor(burned))

# levels(ht_perc1$fenced)
# levels(ht_perc1$burned)

## subset height data to all LIVE stems
asp.acanc <- ht_perc1 %>% 
  filter(site_type == "AC" | site_type == "ANC") %>% 
  filter(live_dead == "LIVE")
  
asp.ac <- ht_perc1 %>% 
  filter(site_type == "AC") %>% 
  filter(live_dead == "LIVE")

# non core
asp.anc <- ht_perc1 %>% 
  filter(site_type == "ANC") %>% 
  filter(live_dead == "LIVE")

# KV
asp.ak <- ht_perc1 %>% 
  filter(site_type == "AK") %>% 
  filter(live_dead == "LIVE")

### subset to small saplings <1.5m
## subset to all LIVE stems
ht_perc1 <- ht_perc1 %>% 
  mutate(sap_size = case_when(htclass2 == "0-50cm" | htclass2 == "51-100cm" | htclass2 == "101-150cm" ~ "small saplings",
                              htclass2 == "151-200cm" | htclass2 == "201-250cm" ~ "tall saplings")) 

asp.sm.acanc <- ht_perc1 %>%
  filter(sap_size == "small saplings") %>% 
  filter(site_type == "AC" | site_type == "ANC") %>% 
  filter(live_dead == "LIVE")
  
asp.sm.ac <- ht_perc1 %>% 
  filter(sap_size == "small saplings") %>%
  filter(site_type == "AC") %>% 
  filter(live_dead == "LIVE")

# non core
asp.sm.anc <- ht_perc1 %>% 
  filter(sap_size == "small saplings") %>%
  filter(site_type == "ANC") %>% 
  filter(live_dead == "LIVE")

# KV
asp.sm.ak <- ht_perc1 %>% 
  filter(sap_size == "small saplings") %>%
  filter(site_type == "AK") %>% 
  filter(live_dead == "LIVE")

### subset to large saplings 1.5m-2.5
## subset to all LIVE stems
asp.lg.acanc <- ht_perc1 %>% 
  filter(sap_size == "tall saplings") %>% 
  filter(site_type == "AC" | site_type == "ANC") %>% 
  filter(live_dead == "LIVE")
  
asp.lg.ac <- ht_perc1 %>% 
  filter(sap_size == "tall saplings") %>%
  filter(site_type == "AC") %>% 
  filter(live_dead == "LIVE")

# non core
asp.lg.anc <- ht_perc1 %>% 
  filter(sap_size == "tall saplings") %>%
  filter(site_type == "ANC") %>% 
  filter(live_dead == "LIVE")

# KV
asp.lg.ak <- ht_perc1 %>% 
  filter(sap_size == "tall saplings") %>%
  filter(site_type == "AK") %>% 
  filter(live_dead == "LIVE")

```

```{r}
### dbh
dbh_perc1 <- dbh_perc1 %>% 
  clean_names()

dbh_perc1 <- dbh_perc1 %>%
  mutate(fenced.long = case_when(fenced == "N" ~ "Unfenced",
                                 fenced == "Y" ~ "Fenced",
                                 TRUE ~ fenced)) %>% 
  mutate(burned = case_when(burned == "Not burned" ~ "Unburned",
                            TRUE ~ burned)) %>%
  mutate(fenced.long = as_factor(fenced.long)) %>%
  mutate(burned = as_factor(burned))

```



# Results  

## Aspen  
### Comparison of Sapling Classes
```{r, ech=FALSE, eval=FALSE}

ht_perc1 %>%
  filter(live_dead == "LIVE") %>%
  group_by(sap_size, site_id, time_class, fenced, burned) %>% 
  summarise(sum.st = sum(stem_tally)) %>% 
  ungroup() %>% 
  ggplot() +
  geom_col(aes(x=site_id, y=sum.st, fill=sap_size)) +
  facet_grid(time_class ~ fenced)

```


```{r}
tally.sapsize <- ht_perc1 %>%
  filter(live_dead == "LIVE") %>%
  group_by(sap_size, site_id, site_type, time_class, fenced, burned) %>% 
  summarise(sum.st = sum(stem_tally)) %>% 
  ungroup() 


sapsize_summaryTCxSiteType <- tally.sapsize %>%
  group_by(time_class, site_type, sap_size) %>%  
  summarytools::descr(var = sum.st, round.digits = 1) %>% 
  summarytools::tb() %>%
  mutate(across(where(is.numeric), round, 1)) %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness))
  
sapsize_summaryTCxSiteType %>% 
  rename(n = n.valid, 'Time class' = time_class) %>% 
  arrange(sap_size,site_type,'time_class') %>% 
  gt() %>% 
  tab_header(title = "Aspen Saplings")# 

## barchart
sapsize_summaryTCxSiteType %>% 
  mutate(site_type = as_factor(site_type)) %>% 
  mutate(site_type = fct_relevel(site_type, "AK", after = 2)) %>% 
  ggplot(aes(x=time_class, y=mean)) +
  geom_col(aes(fill = sap_size), position = 'dodge') +
  scale_fill_manual(values=colfunc3(2)) +
  facet_wrap(~site_type) +
  theme_minimal() +
  labs(x = "Time class", y = "Mean stem tally", fill = "")

ggsave("./output/figures_exported/aspen_stem_count/asp_saplingmean_3panel.png", dpi = 300, width = 8.75, height = 4.75)

```


```{r, eval=FALSE}
## separate panels
pl.sapmean.ac <- tally.sapsize %>%
  filter(site_type == "AC") %>% 
  group_by(time_class, sap_size, fenced) %>%  
  summarytools::descr(var = sum.st, round.digits = 1) %>% 
  summarytools::tb() %>%
  mutate(across(where(is.numeric), round, 1)) %>% 
  ggplot(aes(x=time_class, y=mean)) +
  geom_col(aes(fill = fenced), position = 'dodge') +
  scale_fill_manual(values=colfunc3(2)) +
  facet_wrap(~sap_size) +
  theme_minimal() +
  theme(legend.position = "top") +
  labs(title = "Core Winter Range", x = "Time class", y = "Mean stem tally", fill = "")

## anc
pl.sapmean.anc <- tally.sapsize %>%
  filter(site_type == "ANC") %>% 
  group_by(time_class, sap_size, fenced) %>%  
  summarytools::descr(var = sum.st, round.digits = 1) %>% 
  summarytools::tb() %>%
  mutate(across(where(is.numeric), round, 1)) %>% 
  ggplot(aes(x=time_class, y=mean)) +
  geom_col(aes(fill = fenced), position = 'dodge') +
  scale_fill_manual(values=colfunc3(2)) +
  facet_wrap(~sap_size) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Noncore Winter Range", x = "Time class", y = "Mean stem tally", fill = "")

## ak
pl.sapmean.ak <- tally.sapsize %>%
  filter(site_type == "AK") %>% 
  group_by(time_class, sap_size, fenced) %>%  
  summarytools::descr(var = sum.st, round.digits = 1) %>% 
  summarytools::tb() %>%
  mutate(across(where(is.numeric), round, 1)) %>% 
  ggplot(aes(x=time_class, y=mean)) +
  geom_col(aes(fill = fenced), position = 'dodge') +
  scale_fill_manual(values=colfunc3(2)) +
  facet_wrap(~sap_size) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Kawuneeche Valley", x = "Time class", y = "Mean stem tally", fill = "")

pl.sapmean.ac + pl.sapmean.anc + pl.sapmean.ak + patchwork::plot_layout(ncol=3)

# save plots
ggsave("./output/figures_exported/aspen_stem_count/asp_saplingmean_3panelalt.png", dpi = 300, width = 5.75, height = 6.75)

```

```{r, eval=FALSE}
asp.sm.acanc %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, SITE_TYPE) %>% 
  summarytools::descr(var = stemDen.ha,
                      stats = "common")
```


### Short Saplings (<=1.5m Tall)) - Combined Winter Range (AC+ANC)
```{r}
asp.sm.acanc <- asp.sm.acanc %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 

# reverse factor levels
# asp.sm.acanc <- asp.sm.acanc %>% 
#   mutate(fenced = fct_rev(fenced))
  # mutate(time_class = fct_rev(time_class))
```

#### Modeling and Posterior Description  
```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.acanc.sm <- stan_glmer(stem_tally ~ time_class * fenced + (1 | site_id), data = asp.sm.acanc,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

```{r, eval=FALSE}
# additive model, main factors only
stmod_stally0.acanc.sm <- stan_glmer(stem_tally ~ time_class + fenced + (1 | site_id), data = asp.sm.acanc,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
)

# loo
loo1 <- loo(stmod_stally2.acanc.sm,
            k_threshold = 0.7) 
loo2 <- loo(stmod_stally0.acanc.sm,
            k_threshold = 0.7) 
comp <- loo_compare(loo2, loo1)

## create table of comparisons
modcomp_ac <- print(comp, simplify = TRUE, digits = 2)

modcomp_ac %>% 
  gt()

```


# up


**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.acanc.sm)
```

```{r}
## model summary
# fun.model.summary(stmod_stally2.acanc.sm)
# fun.model.summary.kable(stmod_stally2.acanc.sm)
# fun.desc.post1(stmod_stally2.acanc.sm)
fun.desc.post1.flextable(stmod_stally2.acanc.sm)
```

```{r}
#posterior interval

```

# kable
```{r}
fun.desc.post1(stmod_stally2.acanc.sm)
```

# flex table
```{r}
fun.desc.post1.flextable(stmod_stally2.acanc.sm)
```

```{r}
# extract posteriors
posteriors.acanc.stcnt.sm <- insight::get_parameters(stmod_stally2.acanc.sm) %>% 
  rename('2013' = time_class2013) %>%
  rename('2018' = time_class2018) %>%
  rename(Fenced = fencedFenced) %>%
  rename('2013:Fenced' = `time_class2013:fencedFenced`) %>%
  rename('2018:Fenced' = `time_class2018:fencedFenced`)

# names(posteriors.acanc.stcnt.sm)

# tidy
posteriors.acanc.stcnt.sm.tidy <- posteriors.acanc.stcnt.sm %>%
  pivot_longer(cols = c(`(Intercept)`,"2013","2018","Fenced","2013:Fenced", "2018:Fenced"),names_to = "parameter", values_to = "values")
  # pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
color_scheme_set("teal")
plot.mcmcareas_acanc.stcnt.sm <- mcmc_areas(posteriors.acanc.stcnt.sm,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_acanc.stcnt.sm
```

#### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.acanc.sm)

# names(stmod_stally2.acanc.sm)
# stmod_stally2.acanc.sm$family 
# stmod_stally2.acanc.sm$linear.predictors

fun.sexit.gt(stmod_stally2.acanc.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Combined Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_acanc_smsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.acanc.sm) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Combined Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.acanc.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Combined Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_acanc_smsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.acanc.stcnt.sm.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values), alpha = .12, color="grey50") +
  scale_fill_viridis(discrete = TRUE) +
  # scale_fill_brewer(palette = "Set1") +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_acanc_smsap.png", dpi = 300, width = 4.75, height = 3.75)

```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
plot.pdif.acanc.sm <- p_direction(stmod_stally2.acanc.sm) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Small Saplings, Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

plot.pdif.acanc.sm
# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_acanc_smsap.png", dpi = 300, width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.acanc.sm <- rope(stmod_stally2.acanc.sm, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.acanc.sm %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_acanc_smap.rtf")

```

#### Contrasts

# see contrast below
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.acanc.sm, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() 

emmeans(stmod_stally2.acanc.sm, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>%
  plot(type = "response") +
  # plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, Aspen Stem Count, Small Saplings. Results are given on the response scale") 

ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_acanc_smsap.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_acanc_smsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.acanc.sm, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.acanc.sm, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.



```

```{r, eval=FALSE}
emmeans(stmod_stally2.acanc.sm, ~ time_class + fenced) %>%
  # pairs(reverse = FALSE, type="response") %>%
  pairs(reverse = FALSE) %>%
  as_tibble() %>%
  #mutate(across(where(is.numeric),round, 2)) %>%
  mutate(across(where(is.numeric),exp)) %>%
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>%
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale.")
```

# emmip
```{r}
plot.emmip.smsap.acanc <- emmip(stmod_stally2.acanc.sm, fenced ~ time_class, type = "reponse",
  breaks = seq(0.50, 1, by = 0.10)) +
  theme_minimal() +
  scale_color_manual(values = colfunc3(2)) +
  labs(color="") +
  theme(legend.position = c(.15, .15))

plot.emmip.smsap.acanc

```

#### Mean plots
```{r}

# So, for example, the mean of counts in year 2013 in the fenced plots could be computed as µˆfence, 2013  = exp(α + β1 + β3) and in unfenced plots as µˆopen, 2013  = exp(α + β1),  and a contrast showing the difference between the means is then µˆfence, 2013 − µˆopen, 2013.  Differences between year classes were computed similarly.

# stmod_stally2.acanc.sm
# posteriors.acanc.stcnt.sm
fun.sexit.2plot(stmod_stally2.acanc.sm) %>%
  mutate(across(.cols = 2:5, exp)) %>% 
  gt()

mean.wide <- fun.sexit.2plot(stmod_stally2.acanc.sm) %>%
  select(c(Parameter, Median)) %>% 
  pivot_wider(names_from = Parameter, names_sep = ".", values_from = Median) %>% 
  # mutate(across(.cols = where(is.numeric), exp)) %>%
  clean_names()

fun.sexit.2plot(stmod_stally2.acanc.sm) %>%
  select(c(Parameter, Median, CI, CI_low, CI_high)) %>% 
  pivot_wider(names_from = Parameter, names_sep = ".", values_from = c(Median, CI, CI_low, CI_high)) %>% 
  # mutate(across(.cols = where(is.numeric), exp)) %>%
  clean_names() %>% 
  pivot_longer(cols = !contains('intercept'), names_to = "parameter", values_to = "beta_transformed") %>% 
  mutate(int_plus_beta_transformed = median_intercept + beta_transformed) %>%
  mutate(int_plus_beta_backtransformed = exp(int_plus_beta_transformed)) %>%
  mutate(int_backtransformed = exp(median_intercept)) %>% 
  gt()

#
mean.wide %>% #glimpse()
  pivot_longer(cols = 2:6, names_to = "parameter", values_to = "mean_transformed") %>% 
  mutate(int_plus_beta_transformed = intercept + mean_transformed) %>%
  mutate(Int_plus_beta = exp(int_plus_beta_transformed)) %>%
  mutate(int_backtransformed = exp(intercept)) %>% 
  gt()

# Example, the mean of counts in year 2013 in the fenced plots could be computed as µˆfence, 2013  = exp(α + β1 + β3) and in unfenced plots as µˆopen, 2013  = exp(α + β1),  and a contrast showing the difference between the means is then µˆfence, 2013 − µˆopen, 2013.  Differences between year classes were computed similarly.

```

**Calculation of means**



### Short Saplings (<=1.5m Tall) - Core Winter Range (AC)
```{r}
asp.sm.ac <- asp.sm.ac %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 
```

#### Modeling and Posterior Description  
```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.ac.sm <- stan_glmer(stem_tally ~ time_class * fenced + (1 | site_id), data = asp.sm.ac,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.ac.sm)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.ac.sm)
```

```{r}
# extract posteriors
posteriors.ac.stcnt.sm <- insight::get_parameters(stmod_stally2.ac.sm) %>% 
  rename('2013' = time_class2013) %>%
  rename('2018' = time_class2018) %>%
  rename(Fenced = fencedFenced) %>%
  rename('2013:Fenced' = `time_class2013:fencedFenced`) %>%
  rename('2018:Fenced' = `time_class2018:fencedFenced`)

names(posteriors.ac.stcnt.sm)

# tidy
posteriors.ac.stcnt.sm.tidy <- posteriors.ac.stcnt.sm %>%
  pivot_longer(cols = c(`(Intercept)`,"2013","2018","Fenced","2013:Fenced", "2018:Fenced"),names_to = "parameter", values_to = "values")

# tidy
# posteriors.ac.stcnt.sm.tidy <- posteriors.ac.stcnt.sm %>%
#   pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
color_scheme_set("teal")
plot.mcmcareas_ac.stcnt.sm <- mcmc_areas(posteriors.ac.stcnt.sm,
           prob = 0.9) +
  ggtitle("Core Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ac.stcnt.sm
```

#### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.ac.sm)

fun.sexit.gt(stmod_stally2.ac.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_ac_smsap.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.ac.sm) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Core Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.ac.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_ac_smsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.ac.stcnt.sm.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values), alpha = .12, color="grey50") +
  # geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  # scale_fill_manual(values = colfunc2(ncol(posteriors.ac.stcnt.sm.tidy))) +
  # scale_fill_brewer(palette = "Set1") +
  scale_fill_viridis(discrete = TRUE) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ac_smsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ac_smsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_stally2.ac.sm) %>% #distinct(Parameter)
  # mutate(Parameter = case_when(Parameter == "time_class2013"~'2013',
  # Parameter == "time_class2018"~'2018',
  # Parameter == "time_class2013:fencedFenced"~'2013:Fenced',
  # Parameter == "time_class2018:fencedFenced"~'2018:Fenced',
  # Parameter == "fencedFenced"~'Fenced')) %>%
  plot() +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Small Saplings, Core Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# p_direction(stmod_stally2.ac.sm) %>%
#   tabyl(Parameter)

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ac_smsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ac_smsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.ac.sm <- rope(stmod_stally2.ac.sm, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ac.sm %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_ac_smap.rtf")

```

#### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.ac.sm, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Aspen Stem Count, Small Saplings. Results are given on the log scale")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ac_smsap.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ac_smsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.ac.sm, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.ac.sm, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.

```

### Short Saplings (<=1.5m Tall) - Noncore Winter Range (ANC)

```{r}
asp.sm.anc <- asp.sm.anc %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 
```

#### Modeling and Posterior Description  
```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.anc.sm <- stan_glmer(stem_tally ~ time_class + (1 | site_id), data = asp.sm.anc,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.anc.sm)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.anc.sm)
```

```{r}
# extract posteriors
posteriors.anc.stcnt.sm <- insight::get_parameters(stmod_stally2.anc.sm)

# tidy
posteriors.anc.stcnt.sm.tidy <- posteriors.anc.stcnt.sm %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")


posteriors.anc.stcnt.sm <- insight::get_parameters(stmod_stally2.anc.sm) %>% 
  rename('2013' = time_class2013) %>%
  rename('2018' = time_class2018) 

# names(posteriors.anc.stcnt.sm)

# tidy
# posteriors.ac.stcnt.sm.tidy <- posteriors.ac.stcnt.sm %>%
#   pivot_longer(cols = c(`(Intercept)`,"2013","2018","Unfenced","2013:Fenced", "2018:Fenced"),names_to = "parameter", values_to = "values")
```

```{r}
color_scheme_set("teal")
plot.mcmcareas_anc.stcnt.sm <- mcmc_areas(posteriors.anc.stcnt.sm,
           prob = 0.9) +
  ggtitle("Noncore Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_anc.stcnt.sm
```

#### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.anc.sm)

fun.sexit.gt(stmod_stally2.anc.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Noncore Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_anc_smsap.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.anc.sm) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Noncore Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.anc.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Noncore Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_anc_smsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.anc.stcnt.sm.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.anc.stcnt.sm.tidy))) +
  scale_color_manual(values = colfunc2(ncol(posteriors.anc.stcnt.sm.tidy))) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_anc_smsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_anc_smsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - anc
p_direction(stmod_stally2.anc.sm) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Small Saplings, Noncore Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_anc_smsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_anc_smsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.anc.sm <- rope(stmod_stally2.anc.sm, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.anc.sm %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_anc_smap.rtf")

```

#### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.anc.sm, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Noncore Winter Range, Aspen Stem Count, Small Saplings. Results are given on the log scale")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_anc_smsap.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_anc_smsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.anc.sm, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.anc.sm, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

### Short Saplings (<=1.5m Tall)) - Kawuneeche Valley (AK)

#### Modeling and Posterior Description
```{r}
asp.sm.ak <- asp.sm.ak %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 
```


```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.ak.sm <- stan_glmer(stem_tally ~ time_class + (1 | site_id), data = asp.sm.ak,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.ak.sm)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.ak.sm)
```

```{r}
# extract posteriors
posteriors.ak.stcnt.sm <- insight::get_parameters(stmod_stally2.ak.sm) %>% 
  rename('2013' = time_class2013) %>%
  rename('2018' = time_class2018) 

# tidy
posteriors.ak.stcnt.sm.tidy <- posteriors.ak.stcnt.sm %>%
  pivot_longer(cols = c('2013','2018'), names_to = "parameter", values_to = "values")
  # pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
color_scheme_set("teal")
# color_scheme_set("teal")

plot.mcmcareas_ak.stcnt.sm <- mcmc_areas(posteriors.ak.stcnt.sm,
           prob = 0.9) +
  ggtitle("Kawuneeche Valley") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ak.stcnt.sm
```

**Panel plot of above MCMC area plots**
```{r}
## rendered for print doc
## turned off for Rmd appx
# panel of ACNC AC ANC AK - small saplings

smsap.plot1 <- mcmc_areas(posteriors.acanc.stcnt.sm,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  geom_vline(aes(xintercept=0), lty="dashed") +
  theme(text = element_text(family = 'sans'))

smsap.plot2 <- mcmc_areas(posteriors.ac.stcnt.sm,
           prob = 0.9) +
  ggtitle("Core Winter Range") +
  theme_minimal() +
  geom_vline(aes(xintercept=0), lty="dashed") +
  theme(text = element_text(family = 'sans'))

smsap.plot3 <- mcmc_areas(posteriors.anc.stcnt.sm,
           prob = 0.9) +
  ggtitle("Noncore Winter Range") +
  theme_minimal() +
  geom_vline(aes(xintercept=0), lty="dashed") +
  theme(text = element_text(family = 'sans'))

smsap.plot4 <- mcmc_areas(posteriors.ak.stcnt.sm,
           prob = 0.9) +
  ggtitle("Kawuneeche Valley") +
  theme_minimal() +
  geom_vline(aes(xintercept=0), lty="dashed") +
  theme(text = element_text(family = 'sans'))

# combine
smsap.plot1 + smsap.plot2 + smsap.plot3 + smsap.plot4 + plot_annotation(
  title = 'Posterior Distributions: Small Aspen Stems')

# save plots
ggsave("./output/figures_exported/asp_small_sapling_panel_plot.png", dpi = 300, width = 8.75, height = 4.75)
ggsave("./output/figures_exported/asp_small_sapling_panel_plot.pdf", width = 8.75, height = 4.75)
```


#### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.ak.sm)

fun.sexit.gt(stmod_stally2.ak.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Kawuneeche Valley") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_ak_smsap.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.ak.sm) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Kawuneeche Valley")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.ak.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Kawuneeche Valley") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_ak_smsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.ak.stcnt.sm.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.ak.stcnt.sm.tidy))) +
  scale_color_manual(values = colfunc2(ncol(posteriors.ak.stcnt.sm.tidy))) +
  # scale_fill_brewer(palette = "Set1") +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ak_smsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ak_smsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - ak
p_direction(stmod_stally2.ak.sm) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Small Saplings, Kawuneeche Valley") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ak_smsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ak_smsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.ak.sm <- rope(stmod_stally2.ak.sm, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ak.sm %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_ak_smap.rtf")

```

#### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.ak.sm, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Kawuneeche Valley, Aspen Stem Count, Small Saplings. Results are given on the log scale")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ak_smsap.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ak_smsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.ak.sm, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.ak.sm, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

###  Effects of Burning on Short Saplings (<1.5m Tall) - Combined Winter Range (AC+ANC) 
```{r}
asp.sm.acanc %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  group_by(time_class, range_type, burned, fenced) %>% 
  summarytools::descr(var = stem_den_ac, stats = "fivenum") %>%
  summarytools::tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  gt() %>% 
  tab_header(title="Summary statistics")

```

```{r, cache=TRUE}
### STAN model
stmod_smsap_TCxFxB_acanc <- stan_glmer(stem_tally ~ fenced * time_class * burned + (1 | site_id), data = asp.sm.acanc,
                      family=poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

```{r}
fun.sexit.gt(stmod_smsap_TCxFxB_acanc)

fun.sexit.gt(stmod_smsap_TCxFxB_acanc) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Combined Winter Range, Small Saplings") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_smsap_TCxFxB_acanc.rtf")

```


```{r, eval=FALSE}
prior_summary(stmod_smsap_TCxFxB_acanc)
pp_check(stmod_smsap_TCxFxB_acanc)
```

#### Probability of Direction
```{r}
# Visualize the pd
p_direction(stmod_smsap_TCxFxB_acanc) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, combined winter range, TCxFxB") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_smsap_TCxFxB_acanc.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_smsap_TCxFxB_acanc.pdf", width = 4.75, height = 3.75)

```

```{r}
#### Contrasts
# linear predictors
# emmeans(stmod_smsap_TCxFxB_acanc, ~ time_class | burned | fenced) %>% 
#   pairs(reverse = TRUE) %>% 
#   plot() +
#   theme_minimal() +
#   geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
#   labs(subtitle = "Point estimate displayed: median 
# HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Aspen Stem Count, TCxFxB")

## response scale
emmeans(stmod_smsap_TCxFxB_acanc, ~ time_class | burned | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, Aspen Stem Count, TCxFxB")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxFxB_smsap_ac.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxFxB_smsap_ac.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_smsap_TCxFxB_acanc, ~ time_class | burned | fenced) %>% 
  pairs(reverse = TRUE) %>%  
  as_tibble() %>% 
  mutate(across(where(is.numeric),exp)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale")

```

#### Tall Saplings (1.5-2.5m Tall) - Combined Winter Range (AC+ANC)
```{r}
asp.lg.acanc <- asp.lg.acanc %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 

# reverse factor levels
# asp.lg.acanc <- asp.lg.acanc %>% 
#   mutate(fenced = fct_rev(fenced))
  # mutate(time_class = fct_rev(time_class))
```

#### Modeling and Posterior Description  
```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.acanc.lg <- stan_glmer(stem_tally ~ time_class * fenced + (1 | site_id), data = asp.lg.acanc,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.acanc.lg)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.acanc.lg)
```

```{r}
# extract posteriors
posteriors.acanc.stcnt.lg <- insight::get_parameters(stmod_stally2.acanc.lg)

# tidy
posteriors.acanc.stcnt.lg.tidy <- posteriors.acanc.stcnt.lg %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
color_scheme_set("teal")
plot.mcmcareas_acanc.stcnt.lg <- mcmc_areas(posteriors.acanc.stcnt.lg,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_acanc.stcnt.lg
```

#### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.acanc.lg)

fun.sexit.gt(stmod_stally2.acanc.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Large Saplings, Combined Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_acanc_lgsap.rtf")
```

```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.acanc.lg) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Large Saplings, Combined Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.acanc.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Large Saplings, Combined Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_acanc_lgsap.rtf")

```

```{r, eval=FALSE, echo=FALSE}
# library(ggridges)
posteriors.acanc.stcnt.lg.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_acanc_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_acanc_lgsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_stally2.acanc.lg) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Large Saplings, Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_acanc_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_acanc_lgsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.acanc.lg <- rope(stmod_stally2.acanc.lg, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.acanc.lg %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_acanc_lgap.rtf")

```

#### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.acanc.lg, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, Aspen Stem Count, Large Saplings. Results are given on the log scale")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_acanc_lgsap.pdf", width = 4.5, height = 3.55) # save plot

ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_acanc_lgsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.acanc.lg, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.acanc.lg, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.

```

```{r}

```

# emmip
```{r, echo=TRUE, eval=TRUE}

pl.emmip.sm <- plotF.emmip_FxTC_response(stmod_stally2.acanc.sm) +
  labs(title="Short saplings") +
  theme(legend.position = "none")

pl.emmip.lg <- plotF.emmip_FxTC_response(stmod_stally2.acanc.lg) +
  labs(title="Tall saplings") +
  theme(legend.position = c(.15, .85))
pl.emmip.sm + pl.emmip.lg +
  plot_annotation(tag_levels = 'A', title = "Combined winter range", caption = "Panel A: large saplings; panel B: small saplings")

ggsave("./output/figures_exported/emmip_TCxF_acanc_lg_sm_sap.png", width = 6.5, height = 3.55) # save plot
```


### Tall Saplings (1.5-2.5m Tall) - Core Winter Range (AC)
```{r}
asp.lg.ac <- asp.lg.ac %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 
```

#### Modeling and Posterior Description  
```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.ac.lg <- stan_glmer(stem_tally ~ time_class * fenced + (1 | site_id), data = asp.lg.ac,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.ac.lg) 

```

```{r}
## model summary
fun.model.summary(stmod_stally2.ac.lg)
fun.desc.post1.flextable(stmod_stally2.ac.lg)
```

```{r}
# extract posteriors
posteriors.ac.stcnt.lg <- insight::get_parameters(stmod_stally2.ac.lg) %>% 
  rename('2013' = time_class2013) %>%
  rename('2018' = time_class2018) %>%
  rename(Fenced = fencedFenced) %>%
  rename('2013:Fenced' = `time_class2013:fencedFenced`) %>%
  rename('2018:Fenced' = `time_class2018:fencedFenced`)

names(posteriors.ac.stcnt.lg)

# tidy
posteriors.ac.stcnt.lg.tidy <- posteriors.ac.stcnt.lg %>%
  pivot_longer(cols = c(`(Intercept)`,"2013","2018","Fenced","2013:Fenced", "2018:Fenced"),names_to = "parameter", values_to = "values")

# tidy
# posteriors.ac.stcnt.lg.tidy <- posteriors.ac.stcnt.lg %>%
#   pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
color_scheme_set("teal")
plot.mcmcareas_ac.stcnt.lg <- mcmc_areas(posteriors.ac.stcnt.lg,
           prob = 0.9) +
  ggtitle("Core Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ac.stcnt.lg
```

#### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.ac.lg)

fun.sexit.gt(stmod_stally2.ac.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Large Saplings, Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_ac_lgsap.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.ac.lg) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Large Saplings, Core Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.ac.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Large Saplings, Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_ac_lgsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.ac.stcnt.lg.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values), alpha = .12, color="grey50") +
  # geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  # scale_fill_manual(values = colfunc2(ncol(posteriors.ac.stcnt.lg.tidy))) +
  # scale_fill_brewer(palette = "Set1") +
  scale_fill_viridis(discrete = TRUE) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ac_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ac_lgsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_stally2.ac.lg) %>% #distinct(Parameter)
  # mutate(Parameter = case_when(Parameter == "time_class2013"~'2013',
  # Parameter == "time_class2018"~'2018',
  # Parameter == "time_class2013:fencedFenced"~'2013:Fenced',
  # Parameter == "time_class2018:fencedFenced"~'2018:Fenced',
  # Parameter == "fencedFenced"~'Fenced')) %>%
  plot() +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Tall Saplings, Core Winter Range") +
  scale_fill_manual(values = colfunc3(2))

p_direction(stmod_stally2.ac.lg) %>%
  tabyl(Parameter)

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ac_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ac_lgsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.ac.lg <- rope(stmod_stally2.ac.lg, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ac.lg %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_ac_lgap.rtf")

```

#### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.ac.lg, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Aspen Stem Count, Tall Saplings. Results are given on the log scale")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ac_lgsap.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ac_lgsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.ac.lg, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.ac.lg, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.

```

# emmip
```{r, echo=TRUE, eval=TRUE}
# pl.emmip.ac.lg <- plotF.emmip_FxTC_response(stmod_stally2.ac.lg) 
# pl.emmip.ac.sm <- plotF.emmip_FxTC_response(stmod_stally2.ac.sm)
# pl.emmip.ac.sm + pl.emmip.ac.lg +
#   plot_annotation(tag_levels = 'A', title = "Core winter range", caption = "Panel A: large saplings; panel B: small saplings")


pl.emmip.ac.sm <- plotF.emmip_FxTC_response(stmod_stally2.ac.sm) +
  labs(title="Short saplings") +
  theme(legend.position = "none")

pl.emmip.ac.lg <- plotF.emmip_FxTC_response(stmod_stally2.ac.lg) +
  labs(title="Tall saplings") +
  theme(legend.position = c(.15, .85))

pl.emmip.ac.sm + pl.emmip.ac.lg +
  plot_annotation(tag_levels = 'A', title = "Core winter range", caption = "Panel A: large saplings; panel B: small saplings")

ggsave("./output/figures_exported/emmip_TCxF_ac_lg_sm_sap.png", width = 6.5, height = 3.55) # save plot
```

### Tall Saplings (1.5-2.5m Tall) - Noncore Winter Range (ANC)

```{r}
asp.lg.anc <- asp.lg.anc %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 
```

#### Modeling and Posterior Description  
```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.anc.lg <- stan_glmer(stem_tally ~ time_class + (1 | site_id), data = asp.lg.anc,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.anc.lg)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.anc.lg)
```

```{r}
# extract posteriors
posteriors.anc.stcnt.lg <- insight::get_parameters(stmod_stally2.anc.lg)

# tidy
posteriors.anc.stcnt.lg.tidy <- posteriors.anc.stcnt.lg %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")


posteriors.anc.stcnt.lg <- insight::get_parameters(stmod_stally2.anc.lg) %>% 
  rename('2013' = time_class2013) %>%
  rename('2018' = time_class2018) 

# names(posteriors.anc.stcnt.lg)

# tidy
# posteriors.ac.stcnt.lg.tidy <- posteriors.ac.stcnt.lg %>%
#   pivot_longer(cols = c(`(Intercept)`,"2013","2018","Unfenced","2013:Fenced", "2018:Fenced"),names_to = "parameter", values_to = "values")
```

```{r}
color_scheme_set("teal")
plot.mcmcareas_anc.stcnt.lg <- mcmc_areas(posteriors.anc.stcnt.lg,
           prob = 0.9) +
  ggtitle("Noncore Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_acanc.stcnt.lg
```

#### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.anc.lg)

fun.sexit.gt(stmod_stally2.anc.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Tall Saplings, Noncore Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_anc_lgsap.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.anc.lg) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Tall Saplings, Noncore Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.anc.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Tall Saplings, Noncore Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_anc_lgsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.anc.stcnt.lg.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.anc.stcnt.lg.tidy))) +
  scale_color_manual(values = colfunc2(ncol(posteriors.anc.stcnt.lg.tidy))) +
  # scale_fill_brewer(palette = "Set1") +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_anc_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_anc_lgsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - anc
p_direction(stmod_stally2.anc.lg) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Tall Saplings, Noncore Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_anc_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_anc_lgsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.anc.lg <- rope(stmod_stally2.anc.lg, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.anc.lg %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_anc_lgsap.rtf")

```

#### Contrasts
```{r}
#### Contrasts
# EMMs for later fanctor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.anc.lg, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  plot(type = "response") +
  # plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Noncore Winter Range, Aspen Stem Count, Tall Saplings. Results are given on the log scale")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_anc_lgsap.pdf", width = 4.5, height = 3.55) # save plot

ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_anc_lgsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.anc.lg, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.anc.lg, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```


```{r, echo=TRUE, eval=FALSE}
## emmip
## fails b/c no groups to contrast
pl.emmip.anc.sm <- plotF.emmip_TC_response(stmod_stally2.anc.sm) +
  labs(title="Short saplings") +
  theme(legend.position = "none")

pl.emmip.anc.lg <- plotF.emmip_TC_response(stmod_stally2.anc.lg) +
  labs(title="Tall saplings") +
  theme(legend.position = c(.15, .85))

pl.emmip.anc.sm + pl.emmip.ac.lg +
  plot_annotation(tag_levels = 'A', title = "Core winter range", caption = "Panel A: large saplings; panel B: small saplings")

# emmip XXXX

# emmip(stmod_stally2.anc.lg)
# plotF.emmip_TC_response <- function(model){
#   emmip(model, time_class, type = "response") +
#   theme_minimal() +
#   scale_color_manual(values = colfunc3(2)) +
#   labs(color="") +
#   theme(legend.position = "top")
#   # theme(legend.position = c(.15, .15))
# }

```


### Tall Saplings (1.5-2.5m Tall) - Kawuneeche Valley (AK)

#### Modeling and Posterior Description
```{r}
asp.lg.ak <- asp.lg.ak %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 
```


```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.ak.lg <- stan_glmer(stem_tally ~ time_class + (1 | site_id), data = asp.lg.ak,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.ak.lg)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.ak.lg)
```

```{r}
# extract posteriors
posteriors.ak.stcnt.lg <- insight::get_parameters(stmod_stally2.ak.lg) %>% 
  rename('2013' = time_class2013) %>%
  rename('2018' = time_class2018) 

# tidy
posteriors.ak.stcnt.lg.tidy <- posteriors.ak.stcnt.lg %>%
  pivot_longer(cols = c('2013','2018'), names_to = "parameter", values_to = "values")
  # pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
color_scheme_set("teal")

plot.mcmcareas_ak.stcnt.lg <- mcmc_areas(posteriors.ak.stcnt.lg,
           prob = 0.9) +
  ggtitle("Kawuneeche Valley") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ak.stcnt.lg
```

**Panel plot of above MCMC area plots**
```{r}
## rendered for print doc
## turned off for Rmd appx
# panel of ACNC AC ANC AK - tall saplings
# glimpse(posteriors.acanc.stcnt.lg)

lgsap.plot1 <- mcmc_areas(posteriors.acanc.stcnt.lg,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans')) +
  geom_vline(aes(xintercept=0), lty="dashed")

lgsap.plot2 <- mcmc_areas(posteriors.ac.stcnt.lg,
           prob = 0.9) +
  ggtitle("Core Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans')) +
  geom_vline(aes(xintercept=0), lty="dashed")

lgsap.plot3 <- mcmc_areas(posteriors.anc.stcnt.lg,
           prob = 0.9) +
  ggtitle("Noncore Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans')) +
  geom_vline(aes(xintercept=0), lty="dashed")

lgsap.plot4 <- mcmc_areas(posteriors.ak.stcnt.lg,
           prob = 0.9) +
  ggtitle("Kawuneeche Valley") +
  theme_minimal() +
  theme(text = element_text(family = 'sans')) +
  geom_vline(aes(xintercept=0), lty="dashed")

# combine
lgsap.plot1 + lgsap.plot2 + lgsap.plot3 + lgsap.plot4 + plot_annotation(
  title = 'Posterior Distributions: Tall Aspen Stems')

# save plots
ggsave("./output/figures_exported/asp_tall_sapling_panel_plot.png", dpi = 300, width = 8.75, height = 4.75)
ggsave("./output/figures_exported/asp_tall_sapling_panel_plot.pdf", width = 8.75, height = 4.75)
```


#### Effect Description
```{r}
# fun.sexit.gt(stmod_stally2.ak.lg)
fun.sexit.flextable(stmod_stally2.ak.lg)

fun.sexit.gt(stmod_stally2.ak.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Tall Saplings, Kawuneeche Valley") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_ak_lgsap.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.ak.lg) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Tall Saplings, Kawuneeche Valley")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.ak.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Tall Saplings, Kawuneeche Valley") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_ak_lgsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.ak.stcnt.lg.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.ak.stcnt.lg.tidy))) +
  scale_color_manual(values = colfunc2(ncol(posteriors.ak.stcnt.lg.tidy))) +
  # scale_fill_brewer(palette = "Set1") +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ak_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ak_lgsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - ak
p_direction(stmod_stally2.ak.lg) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Tall Saplings, Kawuneeche Valley") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ak_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ak_lgsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.ak.lg <- rope(stmod_stally2.ak.lg, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ak.lg %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_ak_lgsap.rtf")

```

#### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.ak.lg, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Kawuneeche Valley, Aspen Stem Count, Tall Saplings. Results are given on the log scale")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ak_lgsap.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ak_lgsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.ak.lg, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.ak.lg, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  # mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```


#### Effects of Burning on Tall Saplings (1.5-2.5m Tall) - Combined Winter Range (AC+ANC) 
```{r}
asp.lg.acanc %>% #names() 
  filter(range_type == "core winter range") %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  dplyr::select(-c(live_dead, utm_e_nad83, utm_n_nad83, site_number)) %>% 
  group_by(time_class, range_type, burned, fenced) %>% 
  summarytools::descr(stats = "fivenum") %>%
  summarytools::tb() %>% 
  gt() %>% 
  tab_header(title="Summary statistics")

```

```{r, cache=TRUE}
### STAN model
stmod_lgsap_TCxFxB_acanc <- stan_glmer(stem_tally ~ fenced * time_class * burned + (1 | site_id), data = asp.lg.acanc,
                      family=poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

```{r}
fun.sexit.flextable(stmod_lgsap_TCxFxB_acanc)

fun.sexit.gt(stmod_lgsap_TCxFxB_acanc) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Combined Winter Range, Tall Saplings") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_lgsap_TCxFxB_acanc.rtf")

```

```{r, eval=FALSE}
prior_summary(stmod_lgsap_TCxFxB_acanc)
pp_check(stmod_lgsap_TCxFxB_acanc)
```


```{r}
#### Probability of Direction
# Visualize the pd
p_direction(stmod_lgsap_TCxFxB_acanc) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, combined winter range, TCxFxB") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_lgsap_TCxFxB_acanc.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_lgsap_TCxFxB_acanc.pdf", width = 4.75, height = 3.75)

```

```{r}
#### Contrasts
# linear predictors
# emmeans(stmod_lgsap_TCxFxB_acanc, ~ time_class | burned | fenced) %>% 
#   pairs(reverse = TRUE) %>% 
#   plot() +
#   theme_minimal() +
#   geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
#   labs(subtitle = "Point estimate displayed: median 
# HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Aspen Stem Count, TCxFxB")

## response scale
emmeans(stmod_lgsap_TCxFxB_acanc, ~ time_class | burned | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, Large Saplings, TCxFxB")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxFxB_lgsap_ac.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxFxB_lgsap_ac.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_lgsap_TCxFxB_acanc, ~ time_class | burned | fenced) %>% 
  pairs(reverse = TRUE) %>%  
  as_tibble() %>% 
  mutate(across(where(is.numeric),exp)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale")

```

### All Stem Diameters - Combined Winter Range (AC+ANC)
```{r}
# purrr plots
asp.acanc  %>% 
  group_nest(range_type) %>%
  mutate(plots = map2(.y = range_type, .x = data, ~{ggplot(data = .x) +
      geom_boxplot(aes(y = stem_den_ac, x = time_class), fill="Gray80") +
      geom_jitter(aes(y = stem_den_ac, x = time_class), fill="blue", alpha=0.25) +
      labs(title = paste0("Range type: ", .y), x = "", y = "Stem density (stems/acre)") +
      theme_minimal()})) %>% 
  pull(plots)

```

#### Modeling and Posterior Description
```{r, cache=TRUE,eval=FALSE}
#### Main Factors Only
## Not run. Used in model comparisons, but model w/ interaction selected
asp.acanc <- asp.acanc %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001)

## poisson
stmod_stally1.acanc <- stan_glmer(stem_tally ~ time_class + fenced + (1 | site_id), data = asp.acanc,
                      family=poisson,
                      iter = 8000,
                      seed = 1234
                      )
prior_summary(stmod_stally1.acanc)
pp_check(stmod_stally1.acanc)
```

```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.acanc <- stan_glmer(stem_tally ~ time_class * fenced + (1 | site_id), data = asp.acanc,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.acanc)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.acanc)
```

```{r}
# extract posteriors
posteriors.acanc.stcnt <- insight::get_parameters(stmod_stally2.acanc)

# tidy
posteriors.acanc.stcnt.tidy <- posteriors.acanc.stcnt %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
library("bayesplot")
color_scheme_set("teal")
mcmc_areas(posteriors.acanc.stcnt,
           prob = 0.8) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))
```

#### Effect Description
```{r}
fun.sexit.flextable(stmod_stally2.acanc)

fun.sexit.gt(stmod_stally2.acanc) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_ac.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.acanc) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Core Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.acanc) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_ac.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.acanc.stcnt.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  # scale_fill_manual(values = colfunc3_RdBu(4)) +
  # scale_color_manual(values = colfunc3_RdBu(4)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal() +
  labs(caption = "ACANC")

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_acanc.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_acanc.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_stally2.acanc) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_acanc.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_acanc.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.ac <- rope(stmod_stally2.acanc, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ac %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_acanc.rtf")

```

#### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.acanc, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, Aspen Stem Count, Results are given on the log scale")


# ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_acanc.pdf", width = 4.5, height = 3.55) # save plot
# ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_acanc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.acanc, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.acanc, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.

```

### All Stem Diameters - Core Winter Range (AC)

#### Modeling and Posterior Description

```{r, eval=FALSE}
#### Main Factors Only
## Not run. Used in model comparisons, but model w/ interaction selected
asp.ac <- asp.ac %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001)

## poisson
stmod_stally1 <- stan_glmer(stem_tally ~ time_class + fenced + (1 | site_id), data = asp.ac,
                      family=poisson,
                      iter = 8000,
                      seed = 1234
                      )
prior_summary(stmod_stally1)
pp_check(stmod_stally1)
```

```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2 <- stan_glmer(stem_tally ~ time_class * fenced + (1 | site_id), data = asp.ac,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2)
```

```{r}
## model summary
fun.model.summary(stmod_stally2)
```

```{r}
# extract posteriors
posteriors.ac.stcnt <- insight::get_parameters(stmod_stally2)

# tidy
posteriors.ac.stcnt.tidy <- posteriors.ac.stcnt %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
### ppc plot
ppc.plot(stmod_stally2) +
  labs(caption = "AC: stem_cnt~TCxF")

# save plots
ggsave("./output/figures_exported/aspen_stem_count/ppc_stemcnt_ac.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/ppc_stemcnt_ac.pdf", width = 4.75, height = 3.75)
```

```{r, eval = FALSE}
## model comparison. Run previously for model comparison;
# not currently set to run to minimize computational overhead

loo1 <- loo(stmod_stally1,
            k_threshold = 0.7) 
loo2 <- loo(stmod_stally2,
            k_threshold = 0.7) 
comp <- loo_compare(loo2, loo1)

## create table of comparisons
modcomp_ac <- print(comp, simplify = TRUE, digits = 2)

modcomp_ac %>% 
  gt()
# citation(package = "loo")

# show more details with simplify=FALSE
print(modcomp_ac, simplify = FALSE, digits = 3)

# model with interactions selected
```

```{r}
# library("bayesplot")
color_scheme_set("teal")
mcmc_areas(stmod_stally2,
           prob = 0.8) +
  ggtitle("Posterior distributions",
                      "with medians and 80% credible intervals")
```

#### Effect Description
```{r}
fun.sexit.flextable(stmod_stally2)

fun.sexit.gt(stmod_stally2) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_ac.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Core Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_ac.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.ac.stcnt.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ac.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ac.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_stally2) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, core winter range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ac.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ac.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.ac <- rope(stmod_stally2, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ac %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_ac.rtf")

```

#### Contrasts
```{r}
##### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Aspen Stem Count, Results are given on the log scale")


# ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ac.pdf", width = 4.5, height = 3.55) # save plot
# ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ac.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

### Effects of Burning on All Stems - Core Winter Range (AC)
```{r}
ht_perc1 %>% 
  filter(range_type == "core winter range") %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  group_by(time_class, range_type, burned, fenced) %>% 
  summarytools::descr(stats = "fivenum") %>%
  summarytools::tb() %>% 
  gt() %>% 
  tab_header(title="Summary statistics")

```

```{r, cache=TRUE}
### STAN model
stmod_stally_TCxFxB_ac <- stan_glmer(stem_tally ~ fenced * time_class * burned + (1 | site_id), data = asp.ac,
                      family=poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

```{r}
fun.sexit.flextable(stmod_stally_TCxFxB_ac)

fun.sexit.gt(stmod_stally_TCxFxB_ac) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxFxB_ac.rtf")

```


```{r, eval=FALSE}
prior_summary(stmod_stally_TCxFxB_ac)

```

```{r}
pp_check(stmod_stally_TCxFxB_ac)
```


```{r}
# Visualize the pd
p_direction(stmod_stally_TCxFxB_ac) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, core winter range, TCxFxB")

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_TCxFxB_ac.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_TCxFxB_ac.pdf", width = 4.75, height = 3.75)

```

```{r}
##### Contrasts
# linear predictors
# emmeans(stmod_stally_TCxFxB_ac, ~ time_class | burned | fenced) %>% 
#   pairs(reverse = TRUE) %>% 
#   plot() +
#   theme_minimal() +
#   geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
#   labs(subtitle = "Point estimate displayed: median 
# HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Aspen Stem Count, TCxFxB")

## response scale
emmeans(stmod_stally_TCxFxB_ac, ~ time_class | burned | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Aspen Stem Count, TCxFxB")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxFxB_ac.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxFxB_ac.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_stally_TCxFxB_ac, ~ time_class | burned | fenced) %>% 
  pairs(reverse = TRUE) %>%  
  as_tibble() %>% 
  mutate(across(where(is.numeric),exp)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale")

```

### All Stem Diameters - Noncore Winter Range (ANC)

#### Modeling and Posterior Description

```{r,, cache=TRUE}
stmod_anc_stally1 <- stan_glmer(stem_tally ~ time_class + (1 | site_id), data = asp.anc,
                      family=poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

```{r}
# get posteriors
posteriors.anc.stmcnt <- insight::get_parameters(stmod_anc_stally1)
# tidy
posteriors.anc.stcnt.tidy <- posteriors.anc.stmcnt %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")
```

**Prior summary**: stem_tally ~ time_class + (1 | site_id)  
```{r}
prior_summary(stmod_anc_stally1)
```

```{r}
## model summary
fun.model.summary(stmod_anc_stally1)
```

```{r, echo=FALSE, eval = FALSE}
## shiny eval
launch_shinystan(stmod_anc_stally1)
```

```{r}
#### PP check plot
ppc.plot(stmod_anc_stally1) +
  labs(caption = "ANC: stem_tally~TC")
ggsave("./output/figures_exported/aspen_stem_count/ppc_willowht_anc.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/ppc_willowht_anc.pdf", width = 4.75, height = 3.75)
```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)

posteriors.anc.stcnt.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_anc.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_anc.pdf", width = 4.75, height = 3.75)
```

```{r}
# library("bayesplot")
color_scheme_set("teal")
mcmc_areas(stmod_anc_stally1,
           prob = 0.8) +
  ggtitle("Posterior distributions",
                      "with medians and 80% credible intervals")
```

#### Effect Description
```{r}
fun.sexit.flextable(stmod_anc_stally1)

fun.sexit.gt(stmod_anc_stally1) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Noncore Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_anc.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_anc_stally1) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Noncore Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_anc_stally1) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Noncore Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_anc.rtf")

```

#### Probability of Direction

```{r}
# Visualize the pd
#### PD - ANC
p_direction(stmod_anc_stally1) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Noncore winter range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_anc.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_anc.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)

```{r}
rope.stemcnt.ac <- rope(stmod_anc_stally1, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ac %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_anc.rtf")

```

#### Contrasts

```{r}
##### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

emmeans(stmod_anc_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Noncore Winter Range, Aspen Stem Count")

ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_anc.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_anc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_anc_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_anc_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# For EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.

```


```{r, echo=TRUE, eval=TRUE}
# comment 2.2 "provide analyses on single graphic...
## Plot combinations
contr.plot.ac <- emmeans(stmod_stally2, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(title= "Core winter range", caption = "", x = "Estimate", y = "Contrast")

contr.plot.anc <- emmeans(stmod_anc_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(title= "Noncore winter range", caption = "Point estimate displayed: median 
HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "")

# patchwork
contr.plot.ac + contr.plot.anc 

ggsave("./output/figures_exported/revised_figs_aspen/emm_stemcnt_AC_ANC.png", width = 8, height = 3.75, dpi=300)
ggsave("./output/figures_exported/revised_figs_aspen/emm_stemcnt_AC_ANC.pdf", width = 8, height = 3.75)

```

### All Stem Diameters - Kawuneeche Valley (AK)

#### Modeling and Posterior Description

```{r, cache=TRUE}
stmod_ak_stally1 <- stan_glmer(stem_tally ~ time_class + (1 | site_id), data = asp.ak,
                       family=poisson,
                      iter = 8000,
                      seed = 1234
                      )
```

**Prior summary**: stem_tally ~ time_class + (1 | site_id)  
```{r}
prior_summary(stmod_ak_stally1)
```

```{r}
## model summary
fun.model.summary(stmod_ak_stally1)
```


```{r}
# extract posteriors
posteriors.ak.stcnt <- insight::get_parameters(stmod_ak_stally1)

# tidy
posteriors.ak.stcnt.tidy <- posteriors.ak.stcnt %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")
```

```{r}
prior_summary(stmod_ak_stally1)
```

```{r}
#### PP check plot
ppc.plot(stmod_ak_stally1) +
  labs(caption = "AK: stem_tally~TC")
ggsave("./output/figures_exported/aspen_stem_count/ppc_willowht_ak.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/ppc_willowht_ak.pdf", width = 4.75, height = 3.75)
```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)

posteriors.ak.stcnt.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ak.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ak.pdf", width = 4.75, height = 3.75)
```

```{r}
# library("bayesplot")
color_scheme_set("teal")
mcmc_areas(stmod_ak_stally1,
           prob = 0.8) +
  ggtitle("Posterior distributions",
                      "with medians and 80% credible intervals")
```


#### Effect Description  
```{r}
fun.sexit.flextable(stmod_ak_stally1)

fun.sexit.gt(stmod_ak_stally1) %>%
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Kawuneeche Valley") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_anc.rtf")

```

```{r, ech=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_ak_stally1) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Kawuneeche Valley")

## save as RTF
fun.desc.post1.gt.rope(stmod_anc_stally1) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Kawuneeche Valley") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_anc.rtf")

```

#### Probability of Direction  
```{r}
# Visualize the pd
#### PD - ANC
p_direction(stmod_ak_stally1) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Noncore winter range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ak.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ak.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)

```{r}
rope.stemcnt.ak <- rope(stmod_ak_stally1, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ak %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_ak.rtf")

```

#### Contrasts

```{r}
##### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

emmeans(stmod_ak_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Noncore Winter Range, Aspen Stem Count")

ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TC_anc.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TC_anc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_ak_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_ak_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# For EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.

```

```{r}
## version for plot combination
# ANC 
emmeans(stmod_ak_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Noncore Winter Range, Aspen Stem Count")
```

## Willow Macroplot Data

```{r}
#### Data import and munging
# read in willow. These data are the output of extensive munging accomplished using code in "EVMP_munging_20210131.Rmd"

willow <- read_csv("./output/exported_data/willow_mcro.csv")

## create timeClass var
willow.ht <- willow %>% 
  filter(!is.na(PLANT_HT_CM)) %>% 
  mutate(timeClass = case_when(yr == 2008 ~ "BL",
                              yr == 2009 ~ "BL", 
                              TRUE ~ as.character(yr))) 

## chr to factor conversions
willow.ht <- willow.ht %>% 
  mutate(timeClass = as.factor(timeClass)) %>% 
  mutate(timeClass = fct_relevel(timeClass, "2018", "2013", "BL")) %>% 
  mutate(FENCED = as.factor(FENCED))


## clean names
willow.ht <- willow.ht %>% 
  janitor::clean_names()

## filter out just the willow species
willow.ht <- willow.ht %>%
  filter(str_detect(species_code, pattern = "SA"))

## filter out 0
willow.ht <- willow.ht %>% 
  filter(plant_ht_cm > 0)

## reorder the time class
willow.ht <- willow.ht %>% 
  mutate(time_class = fct_rev(time_class))

## factor reverse: fenced
willow.ht <- willow.ht %>%
  mutate(fenced = fct_rev(fenced))

```

```{r}
## create separate df for WC, WNC, combined WC & WNC, and KV
willow.ht.wc <- willow.ht %>% 
  filter(site_type == "WC") %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class))


# non core
willow.ht.nc <- willow.ht %>% 
  # distinct(site_type)
  filter(site_type == "WNC") %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class))

# combined WC and WNC
willow.ht.wc.wnc <- willow.ht %>% 
  # distinct(site_type)
  filter(site_type == "WNC" | site_type == "WC") %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>% 
  mutate(time_class = fct_drop(time_class))

# kw (note: different munging workflow needed b/c of different sampling yrs)
# willow.ht.wk <- willow %>%
#   clean_names() %>%
#   filter(str_detect(species_code, pattern = "SA")) %>% 
#   filter(site_type == "WK") %>% 
#   mutate(fenced = as.factor(fenced)) %>% 
#   filter(plant_ht_cm > 0) %>% 
#   mutate(time_class = as.factor(time_class)) %>% 
#   mutate(fenced = fct_rev(fenced)) %>% 
#   mutate(time_class = fct_drop(time_class))

#   Making time class == year
willow.ht.wk <- willow %>%
  clean_names() %>%
  filter(str_detect(species_code, pattern = "SA")) %>% 
  filter(site_type == "WK") %>% 
  mutate(fenced = as.factor(fenced)) %>% 
  filter(plant_ht_cm > 0) %>% 
  mutate(time_class = as.factor(yr)) %>% 
  mutate(fenced = fct_rev(fenced)) %>% 
  mutate(time_class = fct_drop(time_class))

```



### Willow Height - Combined Winter Range Macroplot Data

**Histograms of Willow Height**

```{r}
## histogram
willow.ht.wc.wnc %>% 
  ggplot() +
  geom_histogram(aes(plant_ht_cm, fill = fenced), color = "grey50") +
  # viridis::scale_fill_viridis(discrete=TRUE) +
  scale_fill_manual(values = colfunc3(2)) +
  labs(x="Plant height (cm)", y = "Count", fill = "", caption = "Core and noncore winter range plots. Macroplot heights") +
  theme_minimal() +
  facet_wrap(~time_class) +
  coord_flip()

ggsave("./output/figures_202108/willow_height_stats/hist_willowht_TC_wcwnc.png", dpi = 300, width = 6.75, height = 3.75)
# ggsave("./output/figures_202108/willow_height_stats/hist_willowht_TC_wcwnc.pdf", width = 6.75, height = 3.75)

```

# ----- height
#### Modeling and Posterior Description
```{r, cache=TRUE}
## run with gamma
wc.wnc.stmod_TCxF <- stan_glmer(plant_ht_cm ~ time_class*fenced +  (1 | site_id), data = willow.ht.wc.wnc,
                      family=Gamma(link="log"),
                      iter = 8000,
                      )
```

**Prior summary**: plant_ht_cm ~ time_class*fenced +  (1 | site_id)
```{r, echo=TRUE}
# Get the prior summary
prior_summary(wc.wnc.stmod_TCxF)
```

```{r}
#### PP check plot
ppc.plot(wc.wnc.stmod_TCxF) +
  labs(caption = "WC+WNC: willow_ht~TCxF")

ggsave("./output/figures_202108/willow_height_stats/ppc_willowht_wcwnc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202108/willow_height_stats/ppc_willowht_wcwnc.pdf", width = 4.75, height = 3.75)
```

```{r}
# Extract posteriors
posteriors.wc.wnc.ht <- insight::get_parameters(wc.wnc.stmod_TCxF)

## tidy
posteriors.wc.wnc.ht.tidy <- posteriors.wc.wnc.ht %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

# posteriors.wc.wnc.ht.tidy %>%
#   ggplot() +
#   geom_density(aes(fill = parameter, x = values),color="grey50", alpha = .25) +
#   # scale_fill_viridis(discrete = TRUE) +
#   scale_fill_manual(values = colfunc2(10)) +
#   # scale_color_manual(values = colfunc2(ncol(posteriors.wc.wnc.ht.tidy))) +
#   theme_minimal()

```

#### Effect Description
```{r}
# use function defined above
fun.sexit.flextable(wc.wnc.stmod_TCxF)

## save as RTF
fun.sexit.gt(wc.wnc.stmod_TCxF) %>%
 tab_header(title = "Combined WC and WNC", subtitle = "Willow Height Posterior Description") %>%
 gt::gtsave(filename = "./output/tables/willow_height/postdesc_willowht_TCxF_wcwnc.rtf")

```

```{r, echo=FALSE, eval=FALSE}
#### Describe posterior distributions
fun.desc.post1.gt.rope(wc.wnc.stmod_TCxF) %>% 
  tab_header(title = "Combined WC and WNC", subtitle = "Willow Height Posterior Description")

## save as RTF
fun.desc.post1.gt.rope(wc.wnc.stmod_TCxF) %>%
 tab_header(title = "Combined WC and WNC", subtitle = "Willow Height Posterior Description") %>%
  gt::gtsave(filename = "./output/tables/willow_height/postdesc_willowht_TCxF_wcwnc.rtf")
```

#### Probability of Direction
```{r}
pd.wc.wnc <- p_direction(wc.wnc.stmod_TCxF)
# Visualize the pd
plot(pd.wc.wnc) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow height, Combined Core and Non-core Winter Range") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202108/willow_height_stats/pd_willowht_wcwnc.png", width = 6.75, height =3.75, dpi = 300)
ggsave("./output/figures_202108/willow_height_stats/pd_willowht_wcwnc.png", width = 6.75, height =3.75)

```

#### Region of Practical Equivalence (ROPE)

```{r}
rope.wcwnc <- rope(wc.wnc.stmod_TCxF, ci=0.9)

rope.wcwnc.gt <- rope.wcwnc %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 
rope.wcwnc.gt
# rope.wcwnc.gt %>%
#   gt::gtsave(filename = "./output/tables/willow_height/rope_willowht_wcwnc.rtf")
```

#### Contrasts

```{r, eval=TRUE}
# Results are given on the log (not the response) scale.
# main effects
## main effect: time class
wc.wnc.emm.tc <- emmeans(wc.wnc.stmod_TCxF, ~ time_class)
wc.wnc.pairs.timeClass <- pairs(wc.wnc.emm.tc)

plot(wc.wnc.pairs.timeClass) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Height")

## main effect: fencing
wc.wnc.emm.fenced <- emmeans(wc.wnc.stmod_TCxF, ~ fenced)
wc.wnc.pairs.fenced <- pairs(wc.wnc.emm.fenced)

# plot(wc.wnc.pairs.fenced) +
#   theme_minimal() +
#   labs(subtitle = "Point estimate displayed: median 
# HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Height")

## the above is not used b/c sig of interactions
```

```{r}
## Effect: TC x fencing
emmeans(wc.wnc.stmod_TCxF, ~ time_class | fenced) %>% 
  pairs(reverse=TRUE) 

# emmeans(wc.wnc.stmod_TCxF, ~ time_class | fenced) %>% 
#   pairs(reverse=TRUE) %>% 
#   plot(type = "response") +
#   theme_minimal() +
#   geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
#   labs(subtitle = "Point estimate displayed: median 
# HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Height")
# 
# # ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TCxF_wcwnc.pdf", width = 4.5, height = 3.55) # save plot
# ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TCxF_wcwnc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(wc.wnc.stmod_TCxF, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(wc.wnc.stmod_TCxF, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

```{r}
emm.func.tc.x.fenced(wc.wnc.stmod_TCxF) +
  xlim(-0.5, 1.25) +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Height \n emm_willowht_TCxF_wcwnc.png")

ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TCxF_wcwnc.png", width = 6.5, height = 3.55, dpi=300)
  
```


```{r}
color_scheme_set("teal")

plot.mcmcareas_ht.wcwnc <- mcmc_areas(posteriors.wc.wnc.ht,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ht.wcwnc

ggsave("./output/figures_202108/willow_height_stats/mcmcarea_willowht_TCxF_wcwnc.png", dpi = 300, width = 6.75, height = 3.75)
# ggsave("./output/figures_202108/willow_height_stats/mcmcarea_willowht_TCxF_wcnc.pdf", width = 6.75, height = 3.75)
```

### Effects of Burning

```{r, cache=TRUE, eval=TRUE}
#### Fenced and burned

stmod_ht.wc.wnc.TCxFxB <- stan_glmer(plant_ht_cm ~ time_class*fenced*burned + (1 | site_id), 
                      data = willow.ht.wc.wnc,
                      family=Gamma(link="log"),
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary** height ~ time_class * burned * fenced + (1 | site_id) 
```{r}
prior_summary(stmod_ht.wc.wnc.TCxFxB)
```

```{r}
pp_check(stmod_ht.wc.wnc.TCxFxB) +
  labs(x = "Value", y = "Density") +
  theme_minimal()
# 
ggsave("./output/figures_202108/willow_cover_stats/wc_wnc_willowcover_ppc_TCxFxB.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202108/willow_cover_stats/wc_wnc_willowcover_ppc_TCxFxB.pdf", width = 4.75, height = 3.75)

```

```{r}
# Extract posteriors
posteriors.wc.wnc.ht <- insight::get_parameters(stmod_ht.wc.wnc.TCxFxB)
```


```{r}
##
color_scheme_set("teal")
# color_scheme_set("teal")

plot.mcmcareas_cov.wcwnc <- mcmc_areas(stmod_ht.wc.wnc.TCxFxB,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans')) +
  labs(caption="mcmcarea_willowcov_TC_wcwnc.png")

plot.mcmcareas_cov.wcwnc

ggsave("./output/figures_202108/willow_cover_stats/mcmcarea_wilwht_TCxFxB_wcwnc.png", dpi = 300, width = 6.75, height = 11.75)

```



```{r}
#### Effect Description
fun.sexit.flextable(stmod_ht.wc.wnc.TCxFxB$stanfit)
```

```{r}
## Effect: TC x fencing
wcwnc.emm.TCxFxB <- emmeans(stmod_ht.wc.wnc.TCxFxB, ~ time_class | fenced | burned)
# wcwnc.emm.TCxFxB <- pairs(wcwnc.emm.TCxFxB, reverse = TRUE)

wcwnc.emm.TCxFxB

emmeans(stmod_ht.wc.wnc.TCxFxB, ~ time_class | fenced | burned) %>% 
  pairs(reverse = TRUE,type='response') %>% 
  as_tibble() %>% 
  flextable()


emmeans(stmod_ht.wc.wnc.TCxFxB, ~ time_class | fenced | burned) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type="response") + 
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, Willow Height")

ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TCxFxB_wcwnc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(wcwnc.emm.TCxFxB, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(wcwnc.emm.TCxFxB, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")
```



### Willow Height - Core Winter Range Macroplot Data

**Histograms of Willow Height**

```{r}
willow.ht.wc %>% 
  mutate(time_class = fct_rev(time_class)) %>% 
  ggplot() +
  # geom_density(aes(plant_ht_cm, fill = fenced), color = "black") +
  geom_histogram(aes(plant_ht_cm, fill = fenced), color = "grey50") +
  # viridis::scale_fill_viridis(discrete=TRUE) +
  scale_fill_manual(values = colfunc3(2)) +
  labs(x="Plant height (cm)", y = "Count", fill = "", caption = "Core winter range plots. Macroplot heights") +
  theme_minimal() +
  facet_wrap(~time_class) +
  coord_flip()

ggsave("./output/figures_202108/willow_height_stats/hist_willowht_TCxF_wc.png", dpi = 300, width = 6.75, height = 3.75)
# ggsave("./output/figures_202108/willow_height_stats/hist_willowht_TCxF_wc.pdf", width = 6.75, height = 3.75)

```

#### Modeling and Posterior Description

```{r, eval = FALSE, cache=TRUE}
#### null model
# Not currently run; run in past as model comparison  
# Previously run for comparisons but not otherwise reported
stmod_ht.0 <- stan_glmer(plant_ht_cm ~ 1 + (1 | site_id), data = willow.ht.wc,
                      family=Gamma(link="log"),
                      iter = 8000,
                      seed = 1234
                      )

prior_summary(stmod_ht.0)
pp_check(stmod_ht.0)

#### main factors only
## Run, but not used for reporting after model comparisons
stmod_ht1 <- stan_glmer(plant_ht_cm ~ time_class + fenced + (1 | site_id), data = willow.ht.wc,
                      family=Gamma(link="log"),
                      iter = 8000,
                      seed = 1234
                      )

prior_summary(stmod_ht1)
pp_check(stmod_ht1)

```

```{r, cache=TRUE}
#### main factors + interactions
# After model comparisons, this is the selected model reported
stmod_ht2 <- stan_glmer(plant_ht_cm ~ time_class*fenced + (1 | site_id), data = willow.ht.wc,
                      family=Gamma(link="log"),
                      iter = 8000,
                      seed = 1234
                      )

## extract posterior
posteriors.wc.ht <- insight::get_parameters(stmod_ht2)
```

**Prior summary**: plant_ht_cm ~ time_class*fenced + (1 | site_id)  
```{r}
# summary(stmod_ht2)
prior_summary(stmod_ht2)
```

```{r, echo=TRUE, eval=FALSE}
## model comparison.
## Run originally and code retained. stmod_ht2 selected
loo1 <- loo(stmod_ht1,
            k_threshold = 0.7) 
loo2 <- loo(stmod_ht2,
            k_threshold = 0.7) 
comp <- loo_compare(loo2, loo1)
print(comp, simplify = FALSE, digits = 2)
```

```{r}
### model checks
ppc.plot(stmod_ht2) +
  labs(x = "Value", y = "Density") +
  theme_minimal()
ggsave("./output/figures_202108/willow_height_stats/ppc_willowht_wc.png", width = 4.75, height = 3.75, dpi = 300)
ggsave("./output/figures_202108/willow_height_stats/ppc_willowht_wc.pdf", width = 4.75, height = 3.75)

```

```{r}
# full posterior description
fun.desc.post1.gt.rope(stmod_ht2) %>% 
  tab_header(title = "Core Winter Range", subtitle = "Willow Height Posterior Description")

```

```{r}
#### PP check plot
ppc.plot(stmod_ht2) +
  labs(caption = "WC: willow_ht~TCxF")
# ggsave("./output/figures_202108/willow_height_stats/ppc_willowht_wc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202108/willow_height_stats/ppc_willowht_wc.pdf", width = 4.75, height = 3.75)
```

#### Effect Description
```{r}
fun.sexit.flextable(stmod_ht2)

## save as RTF
fun.sexit.gt(stmod_ht2) %>% 
  tab_header(title = "Core Winter Range", subtitle = "Willow Height Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_height/xpostdesc_willowht_TCxF_wc.rtf")
  
```

```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_ht2) %>% 
  tab_header(title = "Core Winter Range", subtitle = "Willow Height Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_height/postdesc_willowht_TCxF_wc.rtf")

```

#### Probability of Direction
```{r}
pd.wc <- p_direction(stmod_ht2)

# Visualize the pd
plot(pd.wc) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow height, core winter range") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202108/willow_height_stats/pd_willowht_wc.png", width = 6.75, height =3.75, dpi = 300)
# ggsave("./output/figures_202108/willow_height_stats/pd_willowht_wc.pdf", width = 6.75, height =3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
# Region Of Practical Equivalence (ROPE)
rope.wc <- rope(stmod_ht2, ci=0.9)

rope.wc.gt <- rope.wc %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 
rope.wc.gt
# rope.wc.gt %>%
#   gt::gtsave(filename = "./output/tables/willow_height/rope_willowht_wc.rtf")
```

#### Contrasts

Results are given on the response scale.

```{r, echo=FALSE, eval=FALSE}
# main effects. Run, but interactions used below
#### Contrasts - WC time class
wc.emm.tc <- emmeans(stmod_ht2, ~ time_class)
pairs.wc.tc <- pairs(emmeans(stmod_ht2, ~ time_class))

plot(pairs.wc.tc) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Height")

## main effect: fencing
wc.emm.fenced <- emmeans(stmod_ht2, ~ fenced)
wc.pairs.fenced <- pairs(wc.emm.fenced)

plot(wc.pairs.fenced) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Height")

```

```{r}
## Effect: TC x fencing
wc.emm.TCxF <- emmeans(stmod_ht2, ~ time_class | fenced)
wc.pairs.TCxF <- pairs(wc.emm.TCxF, reverse = TRUE)

emmeans(stmod_ht2, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type="response") + 
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Height")

ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TCxF_wc.pdf", width = 4.5, height = 3.55) # save plot
# ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TCxF_wc.png", width = 4.5, height = 3.55) # save plot

## alt per hanem
emm.wc.ht <- emmeans(stmod_ht2, ~ fenced | time_class) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type="response") + 
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Height")

# emm.wc.ht
# ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TCxF_wc_new.pdf", width = 4.5, height = 3.55) # save plot
# ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TCxF_wc_new.png", width = 4.5, height = 3.55) # save plot


```

```{r}
# table of contrasts
emmeans(stmod_ht2, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_ht2, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```


```{r}
color_scheme_set("teal")

plot.mcmcareas_ht.wc <- mcmc_areas(posteriors.wc.ht,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ht.wc

ggsave("./output/figures_202108/willow_height_stats/mcmcarea_willowht_TCxF_wc.png", dpi = 300, width = 6.75, height = 3.75)
ggsave("./output/figures_202108/willow_height_stats/mcmcarea_willowht_TCxF_wc.pdf", width = 6.75, height = 3.75)
```


```{r}

bayesplot::mcmc_areas(posteriors.wc.ht,
           pars = c("time_class2013", "time_class2018", "time_class2013:fencedFenced","time_class2018:fencedFenced"),
           prob = 0.9) +
  theme_minimal() +
  labs(title = "Posterior distributions", subtitle = "with medians and 90% intervals", caption = "Willow height, WC")

ggsave("./output/figures_202108/willow_height_stats/mcmcarea_willowht_TCxF_wc.png", dpi = 300, width = 6.75, height = 3.75)
ggsave("./output/figures_202108/willow_height_stats/mcmcarea_willowht_TCxF_wc.pdf", width = 6.75, height = 3.75)

```

### Willow Height - Noncore Winter Range Macroplot Data

**Histograms of Willow Height**

```{r}
## histogram
willow.ht.nc %>% 
  ggplot() +
  geom_histogram(aes(plant_ht_cm, fill = fenced), color = "grey50") +
  # viridis::scale_fill_viridis(discrete=TRUE) +
  scale_fill_manual(values = colfunc3(1)) +
  labs(x="Plant height (cm)", y = "Count", fill = "", caption = "Core winter range plots. Macroplot heights") +
  theme_minimal() +
  facet_wrap(~time_class) +
  coord_flip()

ggsave("./output/figures_202108/willow_height_stats/hist_willowht_TC_wnc.png", dpi = 300, width = 6.75, height = 3.75)
ggsave("./output/figures_202108/willow_height_stats/hist_willowht_TC_wnc.pdf", width = 6.75, height = 3.75)

```

#### Modeling and Posterior Description  
```{r, cache=TRUE}
## model
#### main factors only
## run with gamma
nc.stmod_ht1 <- stan_glmer(plant_ht_cm ~ time_class +  (1 | site_id), data = willow.ht.nc,
                       family=Gamma(link="log"),
                      iter = 8000,
                      )
posteriors.nc.ht <- insight::get_parameters(nc.stmod_ht1)
```



**Prior summary**: plant_ht_cm ~ time_class +  (1 | site_id)    
```{r}
prior_summary(nc.stmod_ht1)
```

```{r}
#### PP check plot
ppc.plot(nc.stmod_ht1) +
  labs(caption = "WNC: willow_ht~TC")
ggsave("./output/figures_202108/willow_height_stats/ppc_willowht_wnc.png", dpi = 300, width = 4.75, height = 3.75)

```

#### Effect Description  
```{r}
# use function defined above
fun.sexit.flextable(nc.stmod_ht1)

## save as RTF
fun.sexit.gt(nc.stmod_ht1) %>% 
  tab_header(title = "Noncore Winter Range", subtitle = "Willow Height Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_height/xposterior_willowht_wnc.rtf")
```

```{r, echo=FALSE, eval = FALSE}
# describe posterior
fun.desc.post1.gt.rope(nc.stmod_ht1)%>% 
  tab_header(title = "Noncore Winter Range", subtitle = "Willow Height Posterior Description")

```

```{r, echo=FALSE, eval=FALSE}
# write to rtf
fun.desc.post1.gt.rope(nc.stmod_ht1) %>% 
  tab_header(title = "Noncore Winter Range", subtitle = "Willow Height Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_height/posterior_willowht_wnc.rtf")
```

```{r}
# tidy the posteriors
posteriors.nc.ht.tidy <- posteriors.nc.ht %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

#### Probability of Direction 
```{r}
# Visualize the pd
p_direction(nc.stmod_ht1) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow height, Noncore winter range") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202108/willow_height_stats/pd_willowht_wnc.png", width = 6.75, height =3.75, dpi = 300)

```

#### Region of Practical Equivalence (ROPE)

```{r}
rope.wnc <- rope(nc.stmod_ht1, ci=0.9)

rope.wnc.gt <- rope.wnc %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.wnc.gt

rope.wnc.gt %>%
  gt::gtsave(filename = "./output/tables/willow_height/rope_willowht_wnc.rtf")

```

#### Contrasts

Results are given on the the response scale.

```{r}
#### Contrasts - WC time class
nc.emm <- emmeans(nc.stmod_ht1, ~ time_class)

nc.emm %>% 
  pairs(reverse = TRUE) %>% 
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Non-core Winter Range, Willow Height")

ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TC_wnc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(nc.stmod_ht1, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(nc.stmod_ht1, ~ time_class) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

```{r}
color_scheme_set("teal")
# color_scheme_set("teal")

plot.mcmcareas_ht.wnc <- mcmc_areas(posteriors.nc.ht,
           prob = 0.9) +
  ggtitle("Noncore Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ht.wnc

ggsave("./output/figures_202108/willow_height_stats/mcmcarea_willowht_TCxF_wnc.png", dpi = 300, width = 6.75, height = 3.75)

```


```{r}
# bayesplot::mcmc_areas(posteriors.nc.ht,
#            pars = c("time_class2013","time_class2018"),
#            prob = 0.9) +
#   theme_minimal() +
#   labs(title = "Posterior distributions", subtitle = "with medians and 90% intervals", caption = "Willow height, WNC")
# 
# ggsave("./output/figures_202108/willow_height_stats/mcmcarea_willowht_TC_wnc.png", dpi = 300, width = 6.75, height = 3.75)
# ggsave("./output/figures_202108/willow_height_stats/mcmcarea_willowht_TC_wnc.pdf", width = 6.75, height = 3.75)

```


```{r}
# Revised plot 2/15/21
# willow height combined plot per revisions
## main effect: fencing
wc.emm.fenced <- emmeans(stmod_ht2, ~ fenced)
wc.pairs.fenced <- pairs(wc.emm.fenced)

plot(wc.pairs.fenced) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Height")


nc.emm %>% 
  pairs(reverse = TRUE) %>% 
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Non-core Winter Range, Willow Height")

ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TC_wnc.png", width = 4.5, height = 3.55) # save plot


```


```{r}
emm.wc <- plot(wc.pairs.fenced) +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Height")

# emm.wnc.ht
emm.wnc <- nc.emm %>% 
  pairs(reverse = TRUE) %>% 
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Non-core Winter Range, Willow Height") +
  xlim(-0.5, 1.5)
emm.wnc
ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TC_wnc.png", width = 7.5, height = 3.55) # save plot


# emm.wc.ht + emm.wnc +
#   plot_layout(ncol = 2) +
#   plot_annotation(caption = "emm_willowht_TC_wcwnc.png")


```

```{r}
## two panel
xxx.wc <- emm.func.tc.x.fenced(stmod_ht2) +
  labs(x = "Estimate", y = "Contrast", Title = "Core Range")


xxx.wnc <- nc.emm %>% 
  pairs(reverse = TRUE) %>% 
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Noncore Range", x = "Estimate", y = "Contrast") +
  xlim(-0.5, 1.5)

xxx.wc + xxx.wnc +
  plot_layout(ncol = 1, heights = c(2,1)) +
  plot_annotation(caption = "Willow height \n emm_willowht_wcwnc_2panel.png")

ggsave("./output/figures_202108/willow_height_stats/emm_willowht_wcwnc_2panel.png", width = 4.5, height = 6.55) # save plot


```

### Willow Height - Kawuneeche Valley Macroplot Data

**Histograms of Willow Height**

```{r}

willow.ht.wk <- willow.ht.wk %>% 
  mutate(time_class = fct_relevel(time_class, "BL"))

willow.ht.wk %>% 
  ggplot() +
  geom_histogram(aes(plant_ht_cm, fill = fenced), color = "grey50") +
  # viridis::scale_fill_viridis(discrete=TRUE) +
  scale_fill_manual(values = colfunc3(2)) +
  labs(x="Plant height (cm)", y = "Count", fill = "", caption = "KV. Macroplot heights") +
  theme_minimal() +
  facet_wrap(~time_class) +
  coord_flip() +
  theme(legend.position = "none")

ggsave("./output/figures_202108/willow_height_stats/hist_willowht_TC_WK.png", dpi = 300, width = 6.75, height = 4.75)

willow.ht.wk %>% 
  ggplot() +
  geom_histogram(aes(plant_ht_cm, fill = fenced), color = "grey50") +
  # viridis::scale_fill_viridis(discrete=TRUE) +
  # scale_fill_manual(values = colfunc3(2)) +
  scale_fill_manual(values=c("grey80", "grey40")) +
  labs(x="Plant height (cm)", y = "Count", fill = "", caption = "KV. Macroplot heights") +
  theme_minimal() +
  facet_grid(time_class ~ fenced) +
  # facet_wrap(~time_class) +
  coord_flip() +
  theme(legend.position = "none")

ggsave("./output/figures_202108/willow_height_stats/hist_willowht_TC_WK_bw.png", dpi = 300, width = 6.75, height = 6.75)
```

#### Modeling and Posterior Description

```{r, echo=FALSE, eval=FALSE}
willow.ht.wk %>%
  # tabyl(time_class)
  tabyl(yr)
  # glimpse()


willow.ht.wk %>%
  # tabyl(time_class)
  tabyl(fenced)
```


```{r, cache=TRUE}
#### TC only (no fenced)
# stmod_ht_wk_TC <- stan_glmer(plant_ht_cm ~ time_class + (1 | site_id), data = willow.ht.wk,
#                       family=Gamma(link="log"),
#                       iter = 8000,
#                       seed = 1234
#                       )
# TCxF need the full data for fencing
stmod_ht_wk_TCxF <- stan_glmer(plant_ht_cm ~ time_class * fenced + (1 | site_id), data = willow.ht.wk,
                      family=Gamma(link="log"),
                      iter = 8000,
                      seed = 1234
                      )

## extract posterior
posteriors.wk.ht <- insight::get_parameters(stmod_ht_wk_TCxF)
# posteriors.wk.ht.tc.f <- insight::get_parameters(stmod_ht_wk_TCxF)

```

**Prior summary**: plant_ht_cm ~ time_class * fenced + (1 | site_id)  
```{r}
## prior summary
prior_summary(stmod_ht_wk_TCxF)
```

```{r, echo = TRUE, eval=TRUE}
#### PP check plot
ppc.plot(stmod_ht_wk_TCxF) +
  labs(caption = "WK: willow_ht~TCxF")

ggsave("./output/figures_202108/willow_height_stats/ppc_willowht_wk.png", dpi = 300, width = 4.75, height = 3.75)

```

#### Effect Description
```{r}
# use function defined above
fun.sexit.flextable(stmod_ht_wk_TCxF) 

fun.sexit.gt(stmod_ht_wk_TCxF) %>% 
  tab_header(title = "Kawuneeche Valley", subtitle = "Willow Height Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_height/xpostdesc_willowht_TC_wk.rtf") 

```

```{r, echo=FALSE, eval=FALSE}
# full posterior description
fun.desc.post1.gt.rope(stmod_ht_wk_TCxF) %>% 
  tab_header(title = "Kawuneeche Valley", subtitle = "Willow Height Posterior Description")

```

```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_ht_wk_TCxF) %>% 
  tab_header(title = "Kawuneeche Valley", subtitle = "Willow Height Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_height/postdesc_willowht_TCxF_wk.rtf")
```

#### Probability of Direction
```{r}
pdkv <- p_direction(stmod_ht_wk_TCxF)
# Visualise the pd
plot(pdkv) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow height, KV \n pd_willowht_wk.png") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202108/willow_height_stats/pd_willowht_wk.png", width = 6.75, height =3.75, dpi = 300)

```

#### Region of Practical Equivalence (ROPE)

```{r}
p.in.rope.kv <- rope(stmod_ht_wk_TCxF, ci=0.9)

pd.tab.kv <- p.in.rope.kv %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 
pd.tab.kv

pd.tab.kv %>%
  gt::gtsave(filename = "./output/tables/willow_height/rope_willowht_wk.rtf")

```

#### Contrasts

```{r}
## contrasts
# emmeans(stmod_ht_wk_TCxF, ~ time_class) %>% 
#   pairs() %>% 
#   # plot() + # on the lm predict scale
#   plot(type = "response") +
#   theme_minimal() +
#   geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
#   labs(subtitle = "Point estimate displayed: median 
# HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "KV, Willow Height")
# 
# ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TC_wk.png", width = 4.5, height = 3.55) # save plot

emmeans(stmod_ht_wk_TCxF, ~ fenced | time_class)

emmeans(stmod_ht_wk_TCxF, ~ fenced | time_class) %>% 
  pairs(reverse=TRUE) %>% 
  # plot() + # on the lm predict scale
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  xlim(-1, 5) +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "KV, Willow Height")

ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TC_wk.png", width = 4.5, height = 3.55) # save plot
# ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TC_wk.pdf", width = 6.5, height = 4.55) # save plot

emmeans(stmod_ht_wk_TCxF, ~ time_class | fenced) %>% 
  pairs(reverse=TRUE) %>% 
  # plot() + # on the lm predict scale
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  xlim(-2, 5) +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "KV, Willow Height")

ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TC_wk_alt.png", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TC_wk_alt.pdf", width = 6.5, height = 4.55) # save plot


```

```{r}
## custom
emmeans(stmod_ht_wk_TCxF, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  ggplot() +
  geom_linerange(aes(y=contrast, xmin=lower.HPD, xmax=upper.HPD), color="#babefa", size=2.5) +
  geom_point(aes(x=estimate, y=contrast)) +
  theme_minimal() +
  geom_vline(xintercept = 0, lty="dashed", size=1) +
  facet_wrap(~fenced, ncol=1) +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "KV, Willow Height")
  # labs(x= "Estimate", y="Contrast", caption = "KV")

ggsave("./output/figures_202108/willow_height_stats/emm_willowht_TC_wk_revised.png", width = 4.5, height = 3.75) # save plot
```


```{r}
# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_ht_wk_TCxF, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_ht_wk_TCxF, ~ time_class) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.
```


```{r}
color_scheme_set("teal")
# color_scheme_set("teal")

plot.mcmcareas_ht.wk <- mcmc_areas(posteriors.wk.ht,
           prob = 0.9) +
  ggtitle("Kawuneeche Valley") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ht.wk

ggsave("./output/figures_202108/willow_height_stats/mcmcarea_willowht_TC_wk.png", dpi = 300, width = 6.75, height = 3.75)
```

# ---- COVER
### Willow Cover - Combined Winter Range Macroplot Data
```{r}
# read in data
# canopy.all.willow.sum <- read_csv("./output/exported_data/willow_cover_20200725.csv") %>% 
#   janitor::clean_names()

canopy.all.willow.sum <- read_csv("./output/exported_data/willow_macroplot_cover_BLto2018b.csv") %>% 
  janitor::clean_names()

```

```{r, echo=TRUE}
# munge
canopy.all.willow.sum <- canopy.all.willow.sum %>% 
  mutate(burned = case_when(burned == "Y" ~ "Burned",
                            burned == "N" ~ "Unburned",
                            is.na(burned) ~ "Unburned",
                            TRUE ~ burned)) %>% 
  mutate(fenced = case_when(site_id == "WK01" ~ "Fenced",
                            site_id == "WK02" ~ "Fenced",
                            site_id == "WK03" ~ "Unfenced",
                            site_id == "WK04" ~ "Unfenced",
                            site_id == "WK05" ~ "Fenced",
                            site_id == "WK06" ~ "Unfenced",
                            site_id == "WK07" ~ "Unfenced",
                            site_id == "WK08" ~ "Unfenced",
                            site_id == "WK09" ~ "Unfenced",
                            site_id == "WK10" ~ "Fenced",
                            TRUE ~ fenced)) %>% 
  mutate(time_class = as_factor(time_class)) %>%
  mutate(fenced = as_factor(fenced)) %>%
  mutate(burned = as_factor(burned)) %>% 
  mutate(time_class = fct_rev(time_class))

# canopy.all.willow.sum %>% 
#   tabyl(site_type,time_class)

```

```{r}
## check factor levels
# levels(canopy.all.willow.sum$fenced)
# levels(canopy.all.willow.sum$burned)
levels(canopy.all.willow.sum$time_class)

# relevel
canopy.all.willow.sum <- canopy.all.willow.sum %>% 
  mutate(fenced = fct_relevel(fenced, "Fenced", after = 1))

canopy.all.willow.sum %>% 
  mutate(fenced = fct_relevel(fenced, "Fenced", after = 1))

### create subsets of data for modeling
# pull out WK, note different years of data
cov.wk <- canopy.all.willow.sum %>% 
  filter(site_type == "WK") %>% 
  filter(!is.na(cover_allwillow)) %>% 
  mutate(cover_allwillow = cover_allwillow/100)

# pull out the core plus noncore winter range plots
cov.wc.wnc <- canopy.all.willow.sum %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  filter(site_type == "WNC" | site_type == "WC") %>% 
  mutate(cover_allwillow = cover_allwillow/100) %>% 
  filter(!is.na(cover_allwillow))

# pull out the core winter range plots
cov.wc <- canopy.all.willow.sum %>% 
  filter(site_type == "WC") %>%
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  mutate(cover_allwillow = cover_allwillow/100) %>%
  filter(!is.na(cover_allwillow))

# pull out the noncore winter range plots
cov.wnc <- canopy.all.willow.sum %>% 
  filter(site_type == "WNC") %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  mutate(cover_allwillow = cover_allwillow/100) %>% 
  filter(!is.na(cover_allwillow))

```



```{r}
### Summary Tables
#### summary tables: time class and burned
cov.wc.wnc %>% 
  group_by(time_class, fenced) %>% 
  summarytools::descr(cover_allwillow,stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "Combined WC and WNC macroplot data: willow cover - fenced + time_class")

## time class, fenced and burned
cov.wc.wnc %>% 
  group_by(time_class, fenced, burned) %>% 
  summarytools::descr(cover_allwillow, stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "Combined WC and WNC macroplot data: willow cover ~ burned + fenced + time_class")

cov.wk %>% 
  group_by(time_class, fenced) %>% 
  summarytools::descr(cover_allwillow, stats = "common", na.rm=TRUE) %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "WK macroplot data: willow cover ~ fenced * time_class")

```



```{r, fig.width=7, fig.height=5}
### Histograms of Willow Cover
cov.wc.wnc %>% 
  ggplot(aes(cover_allwillow)) +
  geom_histogram(color="grey50") +
  facet_grid(time_class~site_type) +
  theme_minimal() +
  labs(x="Cover", y = "Count")

ggsave("./output/figures_202108/willow_cover_stats/hist_willowht_TC_wcwnc.png", dpi = 300, width = 6.75, height = 3.75)

```

#### Modeling and Posterior Description

```{r, cache=TRUE}
# cover_allwillow \~ time_class \* fenced + (1 \| site_id)
## prep for modeling
## subtract from max to conform
#### Model
cov.wc.wnc <- cov.wc.wnc %>% 
  mutate(cover_allwillow = case_when(cover_allwillow == 1 ~ 0.999999,
                                     TRUE ~ cover_allwillow))

## model
stmod_cov.wc.wnc <- stan_glmer(cover_allwillow ~ time_class * fenced + (1 | site_id), 
                      data = cov.wc.wnc,
                      family = mgcv::betar,
                      prior_aux = exponential(1),
                      iter = 8000,
                      seed = 1234)

```

**Prior summary**: cover_allwillow ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_cov.wc.wnc)
```


```{r, echo=FALSE, eval=FALSE}
# alt model with burned as predictor
# stmod_cov.wc.wnc.b <- stan_glmer(cover_allwillow ~ time_class * fenced * burned + (1 | site_id), 
#                       data = cov.wc.wnc,
#                       family = mgcv::betar,
#                       #prior_aux = exponential(2),
#                       iter = 8000,
#                       seed = 12345)

# there are limits to the beta, but it still seems like the most sensible distribution. Unless want to go with NLR

# pp_check(stmod_cov.wc.wnc.b)

## loo - model comparison  
# cov.wc.wnc.loo1 <- loo(stmod_cov.wc.wnc)
# cov.wc.wnc.loo2 <- loo(stmod_cov.wc.wnc.b)
# loo_compare(cov.wc.wnc.loo1, cov.wc.wnc.loo2)
#                    elpd_diff se_diff
# stmod_cov.wc.wnc    0.0       0.0   
# stmod_cov.wc.wnc.b -2.2       2.5 
# original model better.
```

```{r}
#### PP check plot
# prior_summary(stmod_cov.wc.wnc)

pp_check(stmod_cov.wc.wnc) +
  labs(x = "Value", y = "Density") +
  theme_minimal() +
  labs(caption = "WC & WNC: cover_allwillow ~ time_class * fenced + (1 | site_id)")

ggsave("./output/figures_202108/willow_cover_stats/ppc_willowcov_wcwnc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202108/willow_cover_stats/ppc_willowcov_wcwnc.pdf", width = 4.75, height = 3.75)

```

```{r}
## extract posterior
posteriors.cov.wcwnc <- insight::get_parameters(stmod_cov.wc.wnc)
```


#### Effect Description
```{r}
fun.sexit.flextable(stmod_cov.wc.wnc$stanfit)

fun.sexit.gt(stmod_cov.wc.wnc$stanfit) %>%
  tab_header(title = "Combined Core and Noncore Winter Range", subtitle = "Willow Cover Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_cover/xposterior_willowht_wcwnc.rtf")
```

```{r, echo=FALSE, eval=FALSE}
#### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_cov.wc.wnc$stanfit)
```

```{r, echo=FALSE, eval=FALSE}
## save rtf
fun.desc.post1.gt.rope(stmod_cov.wc.wnc$stanfit) %>%
  tab_header(title = "Combined Core and Noncore Winter Range", subtitle = "Willow Cover Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_cover/posterior_willowht_wcwnc.rtf")
```

```{r}
color_scheme_set("teal")
# color_scheme_set("teal")

plot.mcmcareas_cov.wcwnc <- mcmc_areas(posteriors.cov.wcwnc,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans')) +
  labs(caption="mcmcarea_willowcov_TC_wcwnc.png")

plot.mcmcareas_cov.wcwnc

ggsave("./output/figures_202108/willow_cover_stats/mcmcarea_willowcov_TC_wcwnc.png", dpi = 300, width = 6.75, height = 3.75)

```

#### Probability of Direction  
```{r}
# Visualize the pd
p_direction(stmod_cov.wc.wnc) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow cover, Core and noncore winter range") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202108/willow_cover_stats/pd_willowht_wcwnc.png", width = 6.75, height =3.75, dpi = 300)
# ggsave("./output/figures_202108/willow_cover_stats/pd_willowht_wcwnc.pdf", width = 6.75, height =3.75)

```

#### Region of Practical Equivalence (ROPE)  
```{r}
rope.cov.wcwnc.gt <- rope(stmod_cov.wc.wnc$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.cov.wcwnc.gt %>%
  gt::gtsave(filename = "./output/tables/willow_cover/rope_willowcov_wcwnc.rtf")
```

#### Contrasts  
```{r}
# contrast - time class and fencing
emmeans(stmod_cov.wc.wnc, ~ time_class | fenced) %>% 
  pairs(reverse=TRUE) %>% 
  # plot() + # Results are given on the logit (not the response) scale.
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Core and Noncore Winter Range, Willow Cover")

ggsave("./output/figures_202108/willow_cover_stats/emm_willowht_TCxF_wcwnc.png", width = 6.75, height =3.75, dpi = 300)
# ggsave("./output/figures_202108/willow_cover_stats/emm_willowht_TCxF_wcwnc.pdf", width = 6.75, height =3.75)


# table of contrasts
emmeans(stmod_cov.wc.wnc, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log odds ratio, not the response scale")

emmeans(stmod_cov.wc.wnc, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale")

```


```{r}
# bayesplot::mcmc_areas(posteriors.cov.wcwnc,
#            pars = c("time_class2013", "time_class2018", "time_class2013:fencedFenced","time_class2018:fencedFenced"),
#            prob = 0.9) +
#   theme_minimal() +
#   labs(title = "Posterior distributions", subtitle = "with medians and 90% intervals", caption = "Willow height, WC & WNC")
# 
# ggsave("./output/figures_202108/willow_cover_stats/mcmcarea_willowcov_TCxF_wcwnc.png", dpi = 300, width = 6.75, height = 3.75)
# ggsave("./output/figures_202108/willow_cover_stats/mcmcarea_willowcov_TCxF_wcwnc.pdf", width = 6.75, height = 3.75)
```


#### Effects of Burning - Combined Range
```{r, eval=FALSE}
levels(cov.wc.wnc$time_class)
levels(cov.wc.wnc$burned)
levels(cov.wc.wnc$fenced)
```

```{r, cache=TRUE, eval=TRUE}
#### Fenced and burned

stmod_cov.wc.wnc.TCxFxB <- stan_glmer(cover_allwillow ~ time_class * burned * fenced + (1 | site_id), 
                      data = cov.wc.wnc,
                      family = mgcv::betar,
                      prior_aux = exponential(1),
                      iter = 8000,
                      seed = 1234)

```

**Prior summary** cover_allwillow ~ time_class * burned * fenced + (1 | site_id) 
```{r}
prior_summary(stmod_cov.wc.wnc.TCxFxB)
```

```{r}
pp_check(stmod_cov.wc.wnc.TCxFxB) +
  labs(x = "Value", y = "Density") +
  theme_minimal()
# 
ggsave("./output/figures_202107/wc_wnc_willowcover_ppc_TCxFxB.png", dpi = 300, width = 4.75, height = 3.75)

```


```{r}
## extract posterior
posteriors.cov.wcwnc.TCxFxB <- insight::get_parameters(stmod_cov.wc.wnc.TCxFxB)
```

```{r}
#### Effect Description
fun.sexit.flextable(stmod_cov.wc.wnc.TCxFxB$stanfit)
```


```{r}
color_scheme_set("teal")
# color_scheme_set("teal")

plot.mcmcareas_cov.wcwnc.TCxFxB <- mcmc_areas(posteriors.cov.wcwnc.TCxFxB,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_cov.wcwnc.TCxFxB

ggsave("./output/figures_202108/willow_cover_stats/mcmcarea_willowcov_wcwnc_TCxFxB.png", dpi = 300, width = 6.75, height = 3.75)

```


### Willow Cover - Core Winter Range Macroplot Data

```{r}
### Summary Tables
#### summary tables: time class and burned
cov.wc %>% 
  group_by(time_class) %>% 
  summarytools::descr(cover_allwillow,stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "WC macroplot data: willow cover ~ WC: all willow cover - time_class")

## time class, fenced and burned
cov.wc %>% 
  group_by(time_class, burned) %>% 
  summarytools::descr(cover_allwillow, stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "WC macroplot data: All willow cover - burned + time_class")

```

#### Modeling and Posterior Description

```{r, cache=TRUE}
#### Model
## add to min and subtract from max to conform
cov.wc <- cov.wc %>% 
  mutate(cover_allwillow = case_when(cover_allwillow == 1 ~ 0.999999,
                                     TRUE ~ cover_allwillow))


stmod_cov.wc <- stan_glmer(cover_allwillow ~ time_class * fenced + (1 | site_id), 
                      data = cov.wc,
                      family = mgcv::betar,
                      prior_aux = exponential(2),
                      iter = 8000,
                      seed = 1234)

```

**Prior summary**: cover_allwillow ~ time_class * fenced + (1 | site_id)    
```{r}
prior_summary(stmod_cov.wc)
```

```{r}
#### PP check plot
pp_check(stmod_cov.wc) +
  labs(x = "Value", y = "Density") +
  theme_minimal() +
  labs(caption = "WC: cover_allwillow ~ time_class * fenced + (1 | site_id)")

ggsave("./output/figures_202108/willow_cover_stats/ppc_willowcov_wc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202108/willow_cover_stats/ppc_willowcov_wc.pdf", width = 4.75, height = 3.75)

```
#### Effect Description
```{r}

fun.sexit.flextable(stmod_cov.wc$stanfit)

fun.sexit.gt(stmod_cov.wc$stanfit) %>%
  tab_header(title = "Core Winter Range", subtitle = "Willow Cover Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_cover/posterior_willowht_wc.rtf")
```

```{r, echo=FALSE, eval=FALSE}
#### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_cov.wc$stanfit)
```

```{r, echo=FALSE, eval=FALSE}
## save rtf
fun.desc.post1.gt.rope(stmod_cov.wc$stanfit) %>%
  tab_header(title = "Core Winter Range", subtitle = "Willow Cover Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_cover/posterior_willowht_wc.rtf")

```

#### Probability of Direction
```{r}
# Visualize the pd
p_direction(stmod_cov.wc) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow cover, Core winter range") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202108/willow_cover_stats/pd_willowht_wc.png", width = 6.75, height =3.75, dpi = 300)
# ggsave("./output/figures_202108/willow_cover_stats/pd_willowht_wc.pdf", width = 6.75, height =3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.cov.wc.gt <- rope(stmod_cov.wc$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.cov.wcwnc.gt %>%
  gt::gtsave(filename = "./output/tables/willow_cover/rope_willowcov_wc.rtf")
```

#### Contrasts

Results are given on the the response scale.

```{r}
# library(emmeans)
wc.cov.emm.TCxF <- emmeans(stmod_cov.wc, ~ time_class | fenced)

# pairs(wc.cov.emm.TCxF, reverse = TRUE, type="response") %>% 
#   plot() +
#   theme_minimal() +
#   geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
#   labs(subtitle = "Point estimate displayed: median 
# HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Cover")

emm.func.tc.x.fenced(stmod_cov.wc) +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Willow Cover")

ggsave("./output/figures_202108/willow_cover_stats/emm_willowht_TCxF_wc.png", width = 6.75, height =3.75, dpi = 300)
# ggsave("./output/figures_202108/willow_cover_stats/emm_willowht_TCxF_wc.pdf", width = 6.75, height =3.75)

# table of contrasts
emmeans(stmod_cov.wc, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log odds ratio, not the response scale")

emmeans(stmod_cov.wc, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale")

```

### Willow Cover - Noncore Winter Range Macroplot Data
```{r}
#### summary tables: time class and fenced
cov.wnc %>% 
  group_by(time_class, fenced) %>% 
  summarytools::descr(cover_allwillow,stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "WNC macroplot data: willow cover")

```

#### Modeling and Posterior Description

```{r, cache=TRUE}
#### Model
## add to min and subtract from max to conform
cov.wnc <- cov.wnc %>% 
  mutate(cover_allwillow = case_when(cover_allwillow == 1 ~ 0.999999,
                                     TRUE ~ cover_allwillow))

stmod_cov.wnc <- stan_glmer(cover_allwillow ~ time_class + (1 | site_id), 
                      data = cov.wnc,
                      family = mgcv::betar,
                      # prior_aux = exponential(2),
                      iter = 10000,
                      seed = 1234)



```

```{r, echo=FALSE, eval=FALSE}
shinystan::launch_shinystan(stmod_cov.wnc)
```

**Prior summary**: cover_allwillow ~ time_class + (1 | site_id)      
```{r}
prior_summary(stmod_cov.wnc)
```

```{r, echo=FALSE, eval=FALSE}
#### PP check plot
# summary(stmod_cov.wc)
# prior_summary(stmod_cov.wnc)

pp_check(stmod_cov.wnc) +
  labs(x = "Value", y = "Density") +
  theme_minimal() +
  labs(caption = "WNC: cover_allwillow ~ time_class * fenced + (1 | site_id)")

ggsave("./output/figures_202108/willow_cover_stats/ppc_willowcov_wc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202108/willow_cover_stats/ppc_willowcov_wc.pdf", width = 4.75, height = 3.75)

```

#### Effect Description
```{r}
fun.sexit.flextable(stmod_cov.wnc$stanfit)

fun.sexit.gt(stmod_cov.wnc$stanfit) %>% 
  tab_header(title = "Noncore Winter Range", subtitle = "Willow Cover Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_cover/xposterior_willowht_wnc.rtf")
```

```{r, echo=FALSE, eval=FALSE}
#### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_cov.wnc$stanfit)
```

```{r, echo=FALSE, eval=FALSE}
## save rtf
fun.desc.post1.gt.rope(stmod_cov.wnc$stanfit) %>%
  tab_header(title = "Noncore Winter Range", subtitle = "Willow Cover Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_cover/posterior_willowht_wnc.rtf")

```

#### Probability of Direction  
```{r}
# Visualize the pd
p_direction(stmod_cov.wnc) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow cover, Nnoncore winter range") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202108/willow_cover_stats/pd_willowht_wnc.png", width = 6.75, height =3.75, dpi = 300)
# ggsave("./output/figures_202108/willow_cover_stats/pd_willowht_wnc.pdf", width = 6.75, height =3.75)

```

#### Region of Practical Equivalence (ROPE) 
```{r}
rope.cov.wnc.gt <- rope(stmod_cov.wnc$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.cov.wnc.gt %>%
  gt::gtsave(filename = "./output/tables/willow_cover/rope_willowcov_wnc.rtf")
```

#### Contrasts
```{r}
# library(emmeans)
wnc.cov.emm.TC <- emmeans(stmod_cov.wnc, ~ time_class)

pairs(wnc.cov.emm.TC, reverse = TRUE, type="response") %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Noncore Winter Range, Willow Cover. Results are given on the response scale.")

# ggsave("./output/figures_202108/willow_cover_stats/emm_willowht_TCxF_wnc.png", width = 6.75, height =3.75, dpi = 300)

# table of contrasts
emmeans(stmod_cov.wnc, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log odds ratio, not the response scale")

emmeans(stmod_cov.wnc, ~ time_class) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale")

```

### Willow Cover - Kawuneeche Valley Macroplot Data

```{r}
#### summary tables: time class and fenced
cov.wk %>% 
  group_by(time_class, fenced) %>% 
  summarytools::descr(cover_allwillow,stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "WNC macroplot data: willow cover")

```

#### Modeling and Posterior Description

```{r, cache=TRUE}
#### Model
## add to min and subtract from max to conform
cov.wk <- cov.wk %>% 
  mutate(cover_allwillow = cover_allwillow/100) %>% 
  mutate(cover_allwillow = case_when(cover_allwillow == 1 ~ 0.999999,
                                     cover_allwillow == 0 ~ 0.000001,
                                     TRUE ~ cover_allwillow)) 
  

stmod_cov.wk <- stan_glmer(cover_allwillow ~ time_class*fenced + (1 | site_id), 
                      data = cov.wk,
                      family = mgcv::betar,
                      # prior_aux = exponential(2),
                      iter = 8000,
                      seed = 1234)

```

**Prior summary**      
```{r}
prior_summary(stmod_cov.wk)
```

```{r, echo=FALSE, eval=FALSE}
#### PP check plot
# summary(stmod_cov.wc)
# prior_summary(stmod_cov.wnc)

pp_check(stmod_cov.wk) +
  labs(x = "Value", y = "Density") +
  theme_minimal() +
  labs(caption = "WK: cover_allwillow ~ time_class * fenced + (1 | site_id)")

ggsave("./output/figures_202108/willow_cover_stats/ppc_willowcov_wk.png", dpi = 300, width = 4.75, height = 3.75)

```

#### Effect Description
```{r}
fun.sexit.flextable(stmod_cov.wk$stanfit)

fun.sexit.gt(stmod_cov.wk$stanfit) %>% 
  tab_header(title = "Kawuneeche Valley", subtitle = "Willow Cover Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_cover/xposterior_willowht_wk.rtf")
```

```{r, echo=FALSE, eval=FALSE}
#### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_cov.wk$stanfit)
```

```{r, echo=FALSE, eval=FALSE}
## save rtf
fun.desc.post1.gt.rope(stmod_cov.wk$stanfit) %>%
  tab_header(title = "KV", subtitle = "Willow Cover Posterior Description") %>% 
  gt::gtsave(filename = "./output/tables/willow_cover/posterior_willowht_wk.rtf")

```

#### Probability of Direction  
```{r}
# Visualize the pd
p_direction(stmod_cov.wk) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Willow cover, KV") +
  scale_fill_manual(values = colfunc3(2))

ggsave("./output/figures_202108/willow_cover_stats/pd_willowht_wk.png", width = 6.75, height =3.75, dpi = 300)

```

#### Region of Practical Equivalence (ROPE) 
```{r}
rope.cov.wk.gt <- rope(stmod_cov.wk$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.cov.wk.gt %>%
  gt::gtsave(filename = "./output/tables/willow_cover/rope_willowcov_wk.rtf")
```

#### Contrasts
```{r}
# library(emmeans)

emm.func.tc.x.fenced(stmod_cov.wk) +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Kawuneeche Valley, Willow Cover. Results are given on the response scale.")

ggsave("./output/figures_202108/willow_cover_stats/emm_willowht_TCxF_wk.png", width = 6.75, height =3.75, dpi = 300)

emm.func.tc.x.fenced(stmod_cov.wk) +
  labs(caption = "Point estimate displayed: median 
HPD interval probability: 0.95 \n Willow Cover. Results are given on the response scale.", title = "Kawuneeche Valley", x = "Estimate", y = "Contrast")

ggsave("./output/figures_202108/willow_cover_stats/emm_willowht_TCxF_wk_alt.png", width = 5.75, height =5.75, dpi = 300)

```

### Wild Basin Comparisons
```{r, wbasin_ht, echo=FALSE, eval=FALSE}
## Wild basin
# Wild Basin willow data survey 2018.csv

wbasin <- read_csv("./data/wild_basin/Wild Basin willow data survey 2018.csv")

wbasin <- wbasin %>%
  janitor::clean_names()
  
wbasin.loc <- wbasin %>% 
  filter(!is.na(utm_e_nad83_end_point))

```

```{r}
# read in data and preprocess for joining with EVMP data
wbasin <- read_csv("./data/wild_basin/Wild Basin willow data survey 2018.csv")

wbasin <- wbasin %>%
  janitor::clean_names()
  
wbasin.sel <- wbasin %>% 
  rename(plant_ht_cm = max_ht_cm) %>% 
  mutate(yr = 2018) %>% 
  mutate(fenced = "N") %>% 
  mutate(site_type = "WB") %>% 
  mutate(site_id = paste0("WB",point)) %>% 
  dplyr::select(c(yr, site_type, site_id, plant_ht_cm, species, fenced, location)) %>% 
  distinct()
  
```

```{r}
## process the evmp into a bindable format with wb data
willow.mcro.evmp <- willow.ht %>% 
  rename(species = species_code) %>% 
  dplyr::select(yr, site_type, species, site_id, plant_ht_cm, fenced, location) %>% 
  distinct() %>% 
  filter(yr == 2018)

#### bind wb with 2018 evmp
wb.evmp18 <- bind_rows(wbasin.sel, willow.mcro.evmp) %>% 
  distinct()

```


```{r}
### Willow height comparison among Wild Basin and EVMP plots
## compare WILLOW height

wb.evmp18 %>%
  filter(str_detect(species, "^S")) %>% 
  ggplot() +
  geom_density(aes(fill = site_type, color = site_type, lty = site_type, x = plant_ht_cm), size=1, alpha = .25) +
  theme_minimal() +
  scale_fill_manual(values = colfunc1(4)) +
  scale_color_grey() +
  # scale_fill_manual(values = colfunc3_RdBu(4)) +
  # scale_color_manual(values = colfunc3_RdBu(4)) +
  labs(x = "Willow height (cm)", y  = "Density", lty= "Site type", color = "Site type", fill = "Site type", caption = "willow height, WB + EVMP, Salix only")

ggsave("./output/figures_202107/WB_EVMP_willow_height.png", dpi = 300, width = 4.75, height = 3.75)

```

```{r}
wb.evmp18 <- wb.evmp18 %>%
  mutate(site_type.lbl = case_when(site_type == "WB" ~ "Wild Basin",
                               site_type == "WC" ~ "Core winter range",
                               site_type == "WNC" ~ "Noncore winter range",
                               site_type == "WK" ~ "Kawuneeche Valley",
                               TRUE ~ "other")) %>% 
  mutate(fenced = case_when(fenced == "N" ~ "Unfenced",
                            fenced == "Y" ~ "Fenced",
                            TRUE ~ fenced)) %>% 
  mutate(site.type.fenced = paste0(site_type.lbl,"\n",fenced))

# wb.evmp18 %>% distinct(site.type.fenced)
wb.evmp18.willows <- wb.evmp18 %>% 
  filter(str_detect(species, "^S"))

```

```{r}
wb.evmp18 %>%
  filter(str_detect(species, "^S")) %>% 
  ggplot(aes(x=reorder(site.type.fenced, plant_ht_cm), plant_ht_cm)) +
  geom_boxplot(aes(fill=site_type)) +
  # geom_density(aes(fill = site_type, color = site_type, lty = site_type, x = plant_ht_cm), alpha = 0.05) +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(4)) +
  scale_color_manual(values = colfunc2(4)) +
  theme(legend.position = "none") +
  # theme(axis.text.x = element_text(angle = 0, hjust = 1)) +
  labs(x = "", y  = "Height (cm)", lty= "Site type", color = "Site type", fill = "Site type", caption = "willow height, WB + EVMP, Salix only")

ggsave("./output/figures_202107/WB_EVMP_willow_height_boxplot.png", dpi = 300, width = 6.75, height = 4.75)

```

```{r}
wb.evmp18 %>%
  group_by(site.type.fenced) %>%
  descr(plant_ht_cm, stat="common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  arrange(-mean) %>%
  datatable(caption = "All willow species combined")
  
```


```{r}
wb.evmp18 %>%
  group_by(site.type.fenced, species) %>%
  descr(plant_ht_cm) %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  arrange(-mean) %>%
  datatable(caption = "By willow species")
```


```{r}
wb.evmp18.willows.loc <- wb.evmp18.willows %>% 
  select(-yr) %>% 
  group_by(site_id,location) %>% 
  summarytools::descr(stats = "common") %>% 
  tb() %>%
  select(c(location,mean)) %>% 
  group_by(location) %>% 
  descr(mean,stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  select(-pct.valid)

wb.evmp18.willows.loc %>%
  arrange(-mean) %>% 
  gt() 
# %>%
#   gt::gtsave(filename = "./output/tables/WB_vs_EVMP_willowHt_loc.rtf")

```

```{r}
#### range type
wb.evmp18.willows.rt <- wb.evmp18.willows %>% 
  select(-yr) %>% 
  group_by(site_id,site_type) %>% 
  summarytools::descr(stats = "common") %>% 
  tb() %>%
  select(c(site_type,mean)) %>% 
  group_by(site_type) %>% 
  descr(mean,stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  select(-pct.valid)

wb.evmp18.willows.rt %>%
  arrange(-mean) %>%
  select(-variable) %>%
  gt() #%>%
  # gt::gtsave(filename = "./output/tables/WB_vs_EVMP_willowHt_site_type.rtf")

```

```{r}
wb.evmp18 %>%
  filter(str_detect(species, "^S")) %>% 
  ggplot(aes(x=reorder(site.type.fenced, plant_ht_cm), plant_ht_cm)) +
  geom_boxplot(aes(fill=site_type)) +
  # geom_density(aes(fill = site_type, color = site_type, lty = site_type, x = plant_ht_cm), alpha = 0.05) +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(4)) +
  scale_color_manual(values = colfunc2(4)) +
  theme(legend.position = "none") +
  # theme(axis.text.x = element_text(angle = 35, hjust = 1)) +
  labs(x = "", y  = "Height (cm)", lty= "Site type", color = "Site type", fill = "Site type", caption = "willow height, WB + EVMP, Salix only")

ggsave("./output/figures_202107/WB_EVMP_willow_height_boxplot.png", dpi = 300, width = 5.75, height = 4.75)
```


```{r}
# 2 panel
pl.boxht.wc.f <- wb.evmp18 %>%
  filter(str_detect(species, "^S")) %>% 
  filter(site_type == "WC" & fenced == "Fenced") %>% 
  ggplot(aes(x=reorder(site.type.fenced, plant_ht_cm), plant_ht_cm)) +
  geom_boxplot(aes(fill=site_type)) +
  # geom_density(aes(fill = site_type, color = site_type, lty = site_type, x = plant_ht_cm), alpha = 0.05) +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(5)) +
  scale_color_manual(values = colfunc2(5)) +
  theme(legend.position = "none") +
  # theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y  = "Height (cm)", lty= "Site type", color = "Site type", fill = "Site type", caption = "willow height,  all willow spp") +
  ylim(0,600) +
  facet_wrap(~fenced, scales = "free_x")

pl.boxht.uf.all <- wb.evmp18 %>%
  filter(str_detect(species, "^S")) %>% 
  filter(fenced == "Unfenced") %>% 
  ggplot(aes(x=reorder(site.type.fenced, plant_ht_cm), plant_ht_cm)) +
  geom_boxplot(aes(fill=site_type)) +
  # geom_density(aes(fill = site_type, color = site_type, lty = site_type, x = plant_ht_cm), alpha = 0.05) +
  theme_minimal() +
  scale_fill_manual(values = colfunc2(4)) +
  scale_color_manual(values = colfunc2(4)) +
  theme(legend.position = "none") +
  # theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y  = "", lty= "Site type", color = "Site type", fill = "Site type") +
  ylim(0,600) +
  facet_wrap(~fenced, scales = "free_x")


pl.boxht.wc.f + pl.boxht.uf.all + plot_layout(widths = c(.55,2))

ggsave("./output/figures_202107/WB_EVMP_willow_height_boxplot2.png", dpi = 300, width = 6.75, height = 4.75)

```

#### Modeling and Posterior Description
```{r, cache=TRUE}
wb_rt2stan <- wb.evmp18.willows %>% 
  select(-yr) %>% 
  group_by(site_id,site_type) %>% 
  summarytools::descr(stats = "common") %>% 
  tb() %>%
  select(c(site_type,mean))

wb_stanaov <- stan_aov(mean ~ site_type, data = wb_rt2stan, 
                  prior = R2(location = 0.25), adapt_delta = 0.999,
                  iter = 8000,
                  seed = 12345)
wb_stanaov

# report::report(wb_stanaov)


```

```{r}
wb_stanglmer <- stan_lmer(mean ~ 1 + (1|site_type),
                   data = wb_rt2stan, prior_intercept = cauchy(),
                   iter=8000,
                   prior_covariance = decov(shape = 2, scale = 2),
                   adapt_delta = 0.999, seed = 12345)

summary(wb_stanglmer)#

describe_posterior(
  wb_stanglmer,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
  gt()


```

```{r, echo=FALSE, eval=FALSE}
## stan aov
describe_posterior(
  wb_stanaov,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
  gt()


pp_check(wb_stanaov)

wb.emm <- emmeans::emmeans(wb_stanaov, ~ site_type)
pairs.wb <- pairs(emmeans(wb_stanaov, ~ site_type))

gg.emm.wb.ht <- plot(pairs.wb) +
  geom_vline(aes(xintercept = 0), lty = "dashed", color = "red") +
  theme_minimal() +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "WB, WC WNC, Willow Height")

gg.emm.wb.ht

ggsave("./output/figures_202107/gg_emm_wildbasin_ht.png", width = 4.5, height = 3.55, dpi=300)

# report::report(wb_stanaov)
```

## Upland Data


```{r, palletes}
# custom gradients and palettes
dbhclass.gradient5 <- c("#26185F", "#0095AF", "#9ADCBB", "#FCFFDD", "grey50")

colfunc1<-colorRampPalette(c("#26185F","#0095AF","#9ADCBB", "#FCFFDD"))
colfunc2<-colorRampPalette(c("#0095AF","#9ADCBB", "#FCFFDD"))
colfunc3<-colorRampPalette(c("#0095AF","#9ADCBB"))
colfunc3_RdBu <- colorRampPalette(c("#EF8A62", "#FDDBC7", "#D1E5F0", "#67A9CF"))

# plot(rep(1,50),col=(colfunc1(50)), pch=19,cex=2)
# plot(rep(1,5),col=(colfunc1(5)), pch=19,cex=2)
pal.5a <- colfunc1(5)
pal.7a <- colfunc1(7)

# palette3 <- RColorBrewer::brewer.pal(6,"RdBu")
# RColorBrewer::display.brewer.pal(6,"RdBu")
```


```{r, funcs, echo=FALSE, eval = TRUE}

## Functions
### Table functions

# SEXIT summary
fun.sexit.gt <- function(model){
  bayestestR::sexit(model, ci=0.9) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric), round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Effect Existence and Significance Testing") 
  }

## model summary to DT
fun.model.summary <- function(model){
  summary(model,
          probs = c(0.1, 0.5, 0.9),
        digits = 1) %>%
  as_tibble(rownames = "Parameter") %>%
  mutate(across(where(is.numeric),round,2)) %>%
  datatable(caption = "Model summary")
}

## function to describe model out
fun.desc.post1 <- function(model){
  describe_posterior(
  model,
  effects = "fixed",
  component = "all",
  ci_method = "hdi",
  ci=0.9,
  rope_ci=0.9,
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
    as_tibble() %>% 
    DT::datatable(caption = "Posterior description")
}


## gt
fun.desc.post1.gt <- function(model){
  describe_posterior(
  model,
  effects = "fixed",
  component = "all",
  ci_method = "hdi",
  test = c("rope"),
  #rope_range(c(-0.1,0.1)),
  rope_range("default"),
  centrality = "median"
) %>% 
    as_tibble() %>% 
    gt() %>% 
    tab_header(title = "Posterior description") %>% 
    fmt_number(
    columns = 2:12,
    decimals = 1,
    suffixing = TRUE
  )
}

## adds 
fun.desc.post1.gt.rope <- function(model){
  describe_posterior(
  model,
  effects = "fixed",
  component = "all",
  ci_method = "hdi",
  test = c("p_direction", "p_significance","rope"),
  rope_range("default"),
  centrality = "median"
) %>% 
    as_tibble() %>% 
    gt() %>% 
    tab_header(title = "Posterior description") %>% 
    fmt_number(
    columns = 2:11,
    decimals = 1,
    suffixing = TRUE
  )
}

```
 
```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}
#### Plotting functions

fun.contrast.plot <- function(df){
  df %>% 
  ggplot(aes(x = contrast)) +
  geom_linerange(aes(ymin = lower.HPD, ymax = upper.HPD), color = "#0095AF", size = 2) +
  geom_point(aes(y = estimate), size = 2.5) +
  theme_minimal() +
  labs(caption = "Point estimate displayed: median 
HPD interval probability", x = "Estimate", y = "Estimate") +
  coord_flip()
}


library(rlang)
fun.barplot1 <- function(mydf, myxcol, myycol, myfill, mytitle) {
   ggplot2::ggplot(data = mydf, aes(x=reorder({{ myxcol }}, 
      {{ myycol }}), y= {{ myycol }})) +
    geom_col(color = "black", fill="#0072B2") +
    xlab("") +
    ylab("") +
    coord_flip() +
    ggtitle(mytitle) +
    theme_minimal() +
    theme(legend.position = "bottom")
}

# geom tile in progress
# 
fun.gp3.ggtile <- function(df, gp1, gp2, gp3, var){
  df %>%
  group_by({{gp1}}, {{gp2}}, {{gp3}}) %>%
  summarytools::descr(perc_cover, stats = "common") %>%
  summarytools::tb() %>%
  mutate(across(where(is.numeric), round, 1)) %>%
  mutate(label = glue("{mean} ({sd})")) %>%
  ggplot(aes({{gp1}}, {{gp2}})) +
  geom_tile(aes(fill = mean)) +
  geom_text(aes(label = label)) +
  theme_minimal() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~{{gp3}}) +
  theme(legend.position = "bottom") #+
  # labs(x=glue::glue("{gp1}"), y=glue::glue("{gp2}"), fill="Mean cover")
}

```


```{r, eval=FALSE}
# purrr plots
tmp1 <- function(df){
  dcanopy.all.willow.sum  %>% 
  group_nest(SITE_TYPE) %>% 
  mutate(plots = map2(.y = SITE_TYPE, .x = data, ~{ggplot(data = .x) +
                              geom_boxplot(aes(y = cover.allwillow, x = timeClass), fill="Gray80") +
                              geom_hline(aes(xintercept=0.31)) +
                              # ggtitle(paste0("Shrub cover, site: ", .y)) +
                              labs(title = paste0("Site type: ", .y), x = "", y = "Willow cover (%)") +
                              theme_minimal()}))

tmp1 %>% 
  pull(plots)

```


```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}
## ppcheck.plot
ppc.plot <- function(model){
  pp_check(model) +
  labs(x = "Value", y = "Density") +
  theme_minimal()
}


```

```{r}
### Data import and munging
## read in derived data
upl.allshrubs <- read_csv("./output/exported_data/upland_LI_allShrubsPooled_20200814.csv")
upl.byspp <- read_csv("./output/exported_data/upland_LI_byShrubSpp_20200814.csv")

### upland pooled species
cov.allshrubs <- upl.allshrubs %>% 
  filter(!is.na(perc_cover)) %>%  
  mutate(time_class = case_when(yr == 2007 ~ "BL",
                              TRUE ~ as.character(yr))) %>% 
  mutate(timeClass = as.factor(time_class)) %>%
  mutate(site_type = as.factor(site_type)) %>%
  mutate(time_class = fct_relevel(timeClass, "2018", "2013", "BL")) 

## reorder the time class
cov.allshrubs <- cov.allshrubs %>% 
  mutate(time_class = fct_rev(time_class))

### upland by species
cov.byspp <- upl.byspp %>% 
  filter(!is.na(perc_cover)) %>%  
  mutate(time_class = case_when(yr == 2007 ~ "BL",
                              TRUE ~ as.character(yr))) %>% 
  mutate(time_class = as.factor(time_class)) %>%
  mutate(site_type = as.factor(site_type)) %>%
  mutate(time_class = fct_relevel(time_class, "2018", "2013", "BL")) 

## reorder the time class
cov.byspp <- cov.byspp %>% 
  mutate(time_class = fct_rev(time_class))
# %>% 
#   mutate(timeClass = case_when(yr == 2008 ~ "BL",
#                               yr == 2009 ~ "BL", 
#                               TRUE ~ as.character(yr))) %>% 
#   mutate(timeClass = as.factor(timeClass)) %>% 
#   mutate(timeClass = fct_relevel(timeClass, "2018", "2013", "BL"))
```

```{r, echoFALSE, eval=FALSE}
## create seperate subsets of ac and anc
cov.allshrubs %>% 
  glimpse()

cov.allshrubs %>% 
  names()

# cov.allshrubs %>% 
#   tabyl()

```

```{r}
# join in site info
## join in the site info

site.info.clean <- read_csv("./data/EVMP_derived/site_info_clean.csv")
site.info.cleannames <- site.info.clean %>% 
  clean_names() %>% 
  select(-starts_with('utm')) %>% 
  select(-c(wilderness,east_west)) %>% 
  distinct() %>% 
  mutate(burned = case_when(burned == "Not burned" ~ "Unburned",
                            is.na(burned) ~ "Unburned",
                            TRUE ~ burned)) 

cov.allshrubs <- left_join(cov.allshrubs, site.info.cleannames, by = "site_id")
cov.byspp <- left_join(cov.byspp, site.info.cleannames, by = "site_id")
```


```{r}
# purrr plots
list.pl.allshrub.wcwnc <- cov.allshrubs %>% 
  group_nest(site_type) %>% 
  mutate(plots = map2(.y = site_type, .x = data, ~{ggplot(data = .x) +
                              geom_boxplot(aes(y = perc_cover, x = time_class), fill="Gray80") +
                              # geom_hline(aes(xintercept=0.31)) +
                              # ggtitle(paste0("Shrub cover, site: ", .y)) +
                              labs(title = paste0("Site type: ", .y), x = "", y = "All shrub cover (%)") +
                              theme_minimal()}))

list.pl.allshrub.wcwnc %>% 
  pull(plots)

```

```{r, eval=FALSE}
# purrr plots
list.pl.allshrub.wc.f <- cov.allshrubs %>%
  filter(site_type == "core range") %>% 
  group_nest(fenced) %>% 
  mutate(plots = map2(.y = fenced, .x = data, ~{ggplot(data = .x) +
                              geom_boxplot(aes(y = perc_cover, x = time_class), fill="Gray80") +
                              # geom_hline(aes(xintercept=0.31)) +
                              # ggtitle(paste0("Shrub cover, site: ", .y)) +
                              labs(title = paste0("Site type: ", .y), x = "", y = "All shrub cover (%)") +
                              theme_minimal()}))

list.pl.allshrub.wc.f %>% 
  pull(plots)

```


```{r}

```


### Upland Shrub Cover, Pooled Shrub Species - Combined Winter Range
```{r}
#### summary tables
cov.allshrubs %>% 
  group_by(time_class, site_type) %>% 
  summarytools::descr(perc_cover, stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "Upland cover - site type + time_class")
  
```

```{r, fig.width=7.5, fig.height=7.5}
cov.allshrubs %>% 
  filter(!is.na(range_type)) %>%
  ggplot(aes(time_class, perc_cover)) +
  geom_boxplot(fill="grey80") +
  geom_point(color="#0095AF") +
  theme_minimal() +
  labs(x="Time class", y="% cover") +
  facet_grid(burned~range_type)
  

# save plots
ggsave("./output/figures_202107_stats_upland/cover_range_type_boxplot.png", dpi = 300, width = 5.75, height = 3.75)
```


```{r, fig.width=7.5, fig.height=7.5}
cov.allshrubs %>% 
  filter(!is.na(valley_full)) %>% 
  ggplot(aes(time_class, perc_cover)) +
  geom_boxplot(fill="grey80") +
  geom_point(color="#0095AF") +
  theme_minimal() +
  labs(x="Time class", y="% cover") +
  facet_wrap(~valley_full, ncol=3)

# save plots
ggsave("./output/figures_202107_stats_upland/cover_valley_boxplot.png", dpi = 300, width = 6.75, height = 6.25)
```

**Summary by Range Type**
```{r}
cov.allshrubs %>%
  group_by(site_type, time_class, burned) %>% 
  descr(perc_cover, stats = "common") %>% 
  tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  datatable(caption = "Upland percent cover -- all shrub species pooled", filter = "bottom")

```


#### Modeling and Posterior Description
```{r, cache=FALSE}
## add cover in 0-1 range
cov.allshrubs <- cov.allshrubs %>%
  mutate(cover = perc_cover/100)
  
stmod_cov.allshr <- stan_glmer(cover ~ time_class + (1 | site_id), 
                      data = cov.allshrubs,
                      family = mgcv::betar,
                      prior_aux = exponential(2),
                      iter = 8000,
                      seed = 1234)

```

```{r}
# extract posteriors
posteriors.upl.allshrubcov <- insight::get_parameters(stmod_cov.allshr)

# tidy
posteriors.upl.allshrubcov.tidy <- posteriors.upl.allshrubcov %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

**Prior summary**: cover ~ time_class + (1 | site_id)    
```{r}
prior_summary(stmod_cov.allshr)
```

```{r}
fun.model.summary(stmod_cov.allshr)
```

```{r}
posteriors.upl.allshrubcov.tidy %>%
  ggplot() +
  geom_density(aes(fill = parameter, x = values),color="grey", alpha = .25) +
  # scale_fill_viridis(discrete = TRUE) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.upl.allshrubcov.tidy))) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland, all shrub cover - Combined Winter Range")
```

```{r}
#### PP check plot
pp_check(stmod_cov.allshr) +
  labs(x = "Value", y = "Density", caption = "upland cover ppc plot. all shrubs pooled") +
  theme_minimal()

# save plots
ggsave("./output/figures_202107_stats_upland/ppc_stemcnt_upl_allshrubs_ucunc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202107_stats_upland/ppc_stemcnt_upl_allshrubs.pdf", width = 4.75, height = 3.75)
```

```{r}
fun.sexit.flextable(stmod_cov.allshr$stanfit)

fun.sexit.gt(stmod_cov.allshr$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/xPUTR_allshrubs_stmod_cover1_posteriors.rtf")
```


```{r, echo=FALSE, eval=FALSE}
fun.desc.post1.gt.rope(stmod_cov.allshr$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range")

```

```{r, eval = FALSE}
## save
fun.desc.post1.gt(stmod_cov.allshr$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/PUTR_allshrubs_stmod_cover1_posteriors.rtf")

```
#### Effect Description  
#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_cov.allshr) %>% plot() +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland Shrub Cover Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_202107_stats_upland/pd_uplcov_ucunc.png", dpi = 300, width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.uplcov.wcwnc.gt <- rope(stmod_cov.allshr$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.uplcov.wcwnc.gt
# rope.uplcov.wcwnc.gt %>%
#   gt::gtsave(filename = "./output/tables/upland_cover/rope_uplcov_wcwnc.rtf")
```

#### Contrasts

EMM summaries with type = "response", the tests and confidence intervals
are done before back-transforming. The ratios estimated are ratios of
geometric means. A model with a log response is in fact a model for
relative effects of any of its linear predictors, and this
back-transformation to ratios goes hand-in-hand with that.

```{r, include=FALSE, echo=FALSE}
# library(emmeans)
# Note: EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs(pigs.emm.s, reverse = TRUE). Also, in multi-factor situations, you may specify by factor(s) to perform the comparisons separately at the levels of those factors.

# Results are given on the log (not the response) scale.
emmeans(stmod_cov.allshr, ~ time_class) %>% 
  pairs() %>% 
  # plot() +
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, All Shrub Cover.Results are given on the log scale.")

ggsave("./output/figures_202107_stats_upland/emm_shrubcov_wcwnc_unc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_cov.allshr, ~ time_class) %>% 
  pairs() %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_cov.allshr, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

### Upland Shrub Cover, Pooled Shrub Species - Core Winter Range
```{r}
#### summary tables
cov.allshrubs %>% 
  group_by(time_class, site_type) %>% 
  summarytools::descr(perc_cover, stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "Upland cover - site type + time_class")

```

#### Modeling and Posterior Description
```{r, cache=FALSE}
cov.allshrubs.uc <- cov.allshrubs %>% 
  filter(site_type == "core range") # add 

## add cover in 0-1 range
cov.allshrubs.uc <- cov.allshrubs.uc %>%
  mutate(cover = perc_cover/100)
  
stmod_cov.allshr.uc <- stan_glmer(cover ~ time_class + (1 | site_id), 
                      data = cov.allshrubs,
                      family = mgcv::betar,
                      prior_aux = exponential(2),
                      iter = 8000,
                      seed = 1234)

```

```{r}
# extract posteriors
posteriors.upl.allshrubcov.uc <- insight::get_parameters(stmod_cov.allshr.uc)

# tidy
posteriors.upl.allshrubcov.tidy <- posteriors.upl.allshrubcov %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

**Prior summary**: cover ~ time_class + (1 | site_id)    
```{r}
prior_summary(stmod_cov.allshr.uc)
```

```{r}
fun.model.summary(stmod_cov.allshr.uc)
```

```{r}
posteriors.upl.allshrubcov.tidy %>%
  ggplot() +
  geom_density(aes(fill = parameter, x = values),color="grey", alpha = .25) +
  # scale_fill_viridis(discrete = TRUE) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.upl.allshrubcov.tidy))) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland, all shrub cover - Combined Winter Range")
```

```{r}
#### PP check plot
pp_check(stmod_cov.allshr.uc) +
  labs(x = "Value", y = "Density", caption = "upland cover ppc plot. all shrubs pooled") +
  theme_minimal()

# save plots
ggsave("./output/figures_202107_stats_upland/ppc_stemcnt_upl_allshrubs_uc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202107_stats_upland/ppc_stemcnt_upl_allshrubs.pdf", width = 4.75, height = 3.75)
```

```{r}
fun.sexit.flextable(stmod_cov.allshr.uc$stanfit)

fun.sexit.gt(stmod_cov.allshr.uc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/xPUTR_allshrubs_stmod_cover1_posteriors.rtf")
```


```{r, echo=FALSE, eval=FALSE}
fun.desc.post1.gt.rope(stmod_cov.allshr.uc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range")

```

```{r, eval = FALSE}
## save
fun.desc.post1.gt(stmod_cov.allshr.uc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/PUTR_allshrubs_stmod_cover1_posteriors.rtf")

```
#### Effect Description  
#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_cov.allshr.uc) %>% plot() +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland Shrub Cover Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_202107_stats_upland/pd_upl_uc.png", dpi = 300, width = 4.75, height = 3.75)

```


#### Region of Practical Equivalence (ROPE)
```{r}
rope.uplcov.wcwnc.gt <- rope(stmod_cov.allshr.uc$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.uplcov.wcwnc.gt
# rope.uplcov.wcwnc.gt %>%
#   gt::gtsave(filename = "./output/tables/upland_cover/rope_uplcov_wcwnc.rtf")
```

#### Contrasts

EMM summaries with type = "response", the tests and confidence intervals
are done before back-transforming. The ratios estimated are ratios of
geometric means. A model with a log response is in fact a model for
relative effects of any of its linear predictors, and this
back-transformation to ratios goes hand-in-hand with that.

```{r, include=FALSE, echo=FALSE}
# library(emmeans)
# Note: EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs(pigs.emm.s, reverse = TRUE). Also, in multi-factor situations, you may specify by factor(s) to perform the comparisons separately at the levels of those factors.

# Results are given on the log (not the response) scale.
emmeans(stmod_cov.allshr.uc, ~ time_class) %>% 
  pairs() %>% 
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, All Shrub Cover")

# ggsave("./output/figures_202107_stats_upland/emm_shrubcov_wcwnc.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_202107_stats_upland/emm_shrubcov_uc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_cov.allshr.uc, ~ time_class) %>% 
  pairs() %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_cov.allshr.uc, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```
### Upland Shrub Cover, Pooled Shrub Species - Noncore Winter Range
#### Modeling and Posterior Description
```{r, cache=FALSE}
cov.allshrubs.unc <- cov.allshrubs %>% 
  filter(site_type == "non-core range") # add 

## add cover in 0-1 range
cov.allshrubs.unc <- cov.allshrubs.unc %>%
  mutate(cover = perc_cover/100)
  
stmod_cov.allshr.unc <- stan_glmer(cover ~ time_class + (1 | site_id), 
                      data = cov.allshrubs,
                      family = mgcv::betar,
                      prior_aux = exponential(2),
                      iter = 8000,
                      seed = 1234)

```

```{r}
# extract posteriors
posteriors.upl.allshrubcov.unc <- insight::get_parameters(stmod_cov.allshr.unc)

# tidy
posteriors.upl.allshrubcov.tidy <- posteriors.upl.allshrubcov %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

**Prior summary**: cover ~ time_class + (1 | site_id)    
```{r}
prior_summary(stmod_cov.allshr.unc)
```

```{r}
fun.model.summary(stmod_cov.allshr.unc)
```

```{r}
posteriors.upl.allshrubcov.tidy %>%
  ggplot() +
  geom_density(aes(fill = parameter, x = values),color="grey", alpha = .25) +
  # scale_fill_viridis(discrete = TRUE) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.upl.allshrubcov.tidy))) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland, all shrub cover - Combined Winter Range")
```

```{r}
#### PP check plot
pp_check(stmod_cov.allshr.unc) +
  labs(x = "Value", y = "Density", caption = "upland cover ppc plot. all shrubs pooled") +
  theme_minimal()

# save plots
ggsave("./output/figures_202107_stats_upland/ppc_stemcnt_upl_allshrubs_unc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202107_stats_upland/ppc_stemcnt_upl_allshrubs.pdf", width = 4.75, height = 3.75)
```

```{r}
fun.sexit.flextable(stmod_cov.allshr.unc$stanfit)

fun.sexit.gt(stmod_cov.allshr.unc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/xPUTR_allshrubs_stmod_cover1_posteriors.rtf")
```


```{r, echo=FALSE, eval=FALSE}
fun.desc.post1.gt.rope(stmod_cov.allshr.unc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range")

```

```{r, eval = FALSE}
## save
fun.desc.post1.gt(stmod_cov.allshr.unc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/PUTR_allshrubs_stmod_cover1_posteriors.rtf")

```
#### Effect Description  
#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_cov.allshr.unc) %>% plot() +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland Shrub Cover Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_202107_stats_upland/pd_uplcov_unc.png", dpi = 300, width = 4.75, height = 3.75)

```


#### Region of Practical Equivalence (ROPE)
```{r}
rope.uplcov.wcwnc.gt <- rope(stmod_cov.allshr.unc$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.uplcov.wcwnc.gt
# rope.uplcov.wcwnc.gt %>%
#   gt::gtsave(filename = "./output/tables/upland_cover/rope_uplcov_wcwnc.rtf")
```

#### Contrasts

EMM summaries with type = "response", the tests and confidence intervals
are done before back-transforming. The ratios estimated are ratios of
geometric means. A model with a log response is in fact a model for
relative effects of any of its linear predictors, and this
back-transformation to ratios goes hand-in-hand with that.

```{r, include=FALSE, echo=FALSE}
# library(emmeans)
# Note: EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs(pigs.emm.s, reverse = TRUE). Also, in multi-factor situations, you may specify by factor(s) to perform the comparisons separately at the levels of those factors.

# Results are given on the log (not the response) scale.
emmeans(stmod_cov.allshr.unc, ~ time_class) %>% 
  pairs() %>% 
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, All Shrub Cover")

# ggsave("./output/figures_202107_stats_upland/emm_shrubcov_unc.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_202107_stats_upland/emm_shrubcov_unc.png", width = 4.5, height = 3.55) # save plot

# plot
emmeans(stmod_cov.allshr.unc, ~ time_class) %>% 
  pairs() %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_cov.allshr.unc, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```



```{r}
# Point estimate displayed: median 
# HPD interval probability: 0.95

pl.emm.upl.allshr.ucunc <- emmeans(stmod_cov.allshr, ~ time_class) %>% 
  pairs() %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Combined Range", x = "Estimate", y = "Contrast")

pl.emm.upl.allshr.uc <- emmeans(stmod_cov.allshr.uc, ~ time_class) %>% 
  pairs() %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Core Range", x = "Estimate", y = "Contrast")

pl.emm.upl.allshr.unc <- emmeans(stmod_cov.allshr.unc, ~ time_class) %>% 
  pairs() %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Noncore Range", x = "Estimate", y = "Contrast")


pl.emm.upl.allshr.ucunc + pl.emm.upl.allshr.uc + pl.emm.upl.allshr.unc + 
  patchwork::plot_layout(ncol=3) +
  plot_annotation('Upland Shrub Cover', caption = 'All Shrub Species Pooled')

```

### Individual Species  
```{r}
cov.byspp %>% 
  tabyl(shrub_species) %>% 
  arrange(-n) %>% 
  gt()

```

```{r}
#### summary
cov.byspp.summary <- cov.byspp %>% 
  group_by(time_class, site_type, shrub_species) %>% 
  summarytools::descr(perc_cover, stats = "common") %>% 
  summarytools::tb() %>%
  mutate(across(where(is.numeric), round, 1)) %>% 
  mutate(label = glue("{mean} ({sd})"))


# library(ggtext)
## ggtext for ggrich text
cov.byspp.summary %>% 
  # filter(site_type == "")
  filter(n.valid>=3) %>%
  filter(shrub_species != "SYRO" & shrub_species != "CEFE"& shrub_species != "PRVI"& shrub_species != "") %>% 
  ggplot(aes(time_class, shrub_species)) +
  geom_tile(aes(fill = mean), color="grey80") +
  geom_text(aes(label = label), size=.8) +
  theme_minimal() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~site_type) +
  theme(legend.position = "bottom") +
  labs(x="", y="Species", title = "Winter Range", fill="Mean cover")

ggsave("./output/figures_202107_stats_upland/ucunc_tile_mean_sd_cov.png", dpi = 300, width = 6.75, height = 4.75)

cov.byspp.summary %>% 
  # filter(site_type == "")
  filter(n.valid>=3) %>%
  filter(shrub_species != "SYRO" & shrub_species != "CEFE"& shrub_species != "PRVI"& shrub_species != "") %>% 
  ggplot(aes(time_class, shrub_species)) +
  geom_tile(aes(fill = mean), color="grey80") +
  # geom_text(aes(label = label)) +
  theme_minimal() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~site_type) +
  theme(legend.position = "bottom") +
  labs(x="", y="Species", title = "Winter Range", fill="Mean cover")

ggsave("./output/figures_202107_stats_upland/ucunc_tile_mean_sd_cov_nolbl.png", dpi = 300, width = 6.75, height = 4.75)

```

```{r}
cov.byspp.summary %>% 
  # filter(site_type == "")
  filter(n.valid>=3) %>%
  filter(shrub_species != "SYRO" & shrub_species != "CEFE"& shrub_species != "PRVI"& shrub_species != "") %>% 
  ggplot(aes(time_class, shrub_species)) +
  geom_col(aes(fill = mean), color="grey80") +
  # geom_text(aes(label = label)) +
  theme_minimal() +
  scale_fill_gradientn(colors = c("#0095AF","#9ADCBB", "#FCFFDD")) +
  facet_wrap(~site_type) +
  theme(legend.position = "bottom") +
  labs(x="", y="Species", title = "Winter Range", fill="Mean cover")

ggsave("./output/figures_202107_stats_upland/ucunc_bar_mean_sd_cov_nolbl.png", dpi = 300, width = 6.75, height = 4.75)
```


```{r}

```


### Upland Shrub Cover, _Purshia tridentata_ - Combined Winter Range
```{r}
# PUTR
cov.putr <- cov.byspp %>%
  filter(shrub_species == "PUTR")

#### summary tables
cov.putr %>% 
  group_by(time_class, site_type) %>% 
  summarytools::descr(perc_cover, stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "PUTR cover ~ site type + time_class")

```

#### Modeling and Posterior Description
```{r, cache=FALSE}
## add cover in 0-1 range
cov.putr <- cov.putr %>%
  mutate(cover = perc_cover/100)
  
stmod_cov.putr <- stan_glmer(cover ~ time_class + (1 | site_id), 
                      data = cov.putr,
                      family = mgcv::betar,
                      prior_aux = exponential(2),
                      iter = 8000,
                      seed = 1234)

```

```{r}
# extract posteriors
posteriors.cov.putrubcov <- insight::get_parameters(stmod_cov.putr)

# tidy
posteriors.cov.putrubcov.tidy <- posteriors.cov.putrubcov %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

**Prior summary**: cover ~ time_class + (1 | site_id)    
```{r}
prior_summary(stmod_cov.putr)
```

```{r}
fun.model.summary(stmod_cov.putr)
```

```{r}
posteriors.cov.putrubcov.tidy %>%
  ggplot() +
  geom_density(aes(fill = parameter, x = values),color="grey", alpha = .25) +
  # scale_fill_viridis(discrete = TRUE) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.cov.putrubcov.tidy))) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland, PUTR cover - Combined Winter Range")
```

```{r}
#### PP check plot
pp_check(stmod_cov.putr) +
  labs(x = "Value", y = "Density", caption = "upland cover ppc plot. PUTR") +
  theme_minimal()

# save plots
ggsave("./output/figures_202107_stats_upland/ppc_PUTR_putrubs_unc.png", dpi = 300, width = 4.75, height = 3.75)

```

```{r}
fun.sexit.flextable(stmod_cov.putr$stanfit)

fun.sexit.gt(stmod_cov.putr$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/xPUTR_putr_stmod_cover1_posteriors.rtf")
```


```{r, echo=FALSE, eval=FALSE}
fun.desc.post1.gt.rope(stmod_cov.putr$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description - PUTR", subtitle = "Combined Core & Noncore Winter Range")

```

```{r, eval = FALSE}
## save
fun.desc.post1.gt(stmod_cov.putr$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description - PUTR", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/PUTR_stmod_cover1_posteriors.rtf")

```
#### Effect Description  
#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_cov.putr) %>% plot() +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland Shrub Cover Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_202107_stats_upland/pd_putr_cov_unc.png", dpi = 300, width = 4.75, height = 3.75)

```


#### Region of Practical Equivalence (ROPE)
```{r}
rope.PUTRcov.wcwnc.gt <- rope(stmod_cov.putr$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.PUTRcov.wcwnc.gt
# rope.PUTRcov.wcwnc.gt %>%
#   gt::gtsave(filename = "./output/tables/upland_cover/rope_putr_cov_wcwnc.rtf")
```

#### Contrasts

EMM summaries with type = "response", the tests and confidence intervals
are done before back-transforming. The ratios estimated are ratios of
geometric means. A model with a log response is in fact a model for
relative effects of any of its linear predictors, and this
back-transformation to ratios goes hand-in-hand with that.

```{r, include=FALSE, echo=FALSE}
# library(emmeans)
# Note: EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs(pigs.emm.s, reverse = TRUE). Also, in multi-factor situations, you may specify by factor(s) to perform the comparisons separately at the levels of those factors.

# Results are given on the log (not the response) scale.
emmeans(stmod_cov.putr, ~ time_class) %>% 
  pairs() %>% 
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, PUTR")

ggsave("./output/figures_202107_stats_upland/emm_putr_cov_ucunc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_cov.putr, ~ time_class) %>% 
  pairs() %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_cov.putr, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

## Upland Shrub Cover, _Purshia tridentata_ - Core Winter Range
```{r}
#### summary tables
cov.putr %>% 
  group_by(time_class, site_type) %>% 
  summarytools::descr(perc_cover, stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "Upland cover - site type + time_class")

```

#### Modeling and Posterior Description
```{r, cache=FALSE}
cov.putr.uc <- cov.putr %>% 
  filter(site_type == "core range") # add 

## add cover in 0-1 range
cov.putr.uc <- cov.putr.uc %>%
  mutate(cover = perc_cover/100)
  
stmod_cov.putr.uc <- stan_glmer(cover ~ time_class + (1 | site_id), 
                      data = cov.putr,
                      family = mgcv::betar,
                      prior_aux = exponential(2),
                      iter = 8000,
                      seed = 1234)

```

```{r}
# extract posteriors
posteriors.cov.putrubcov.uc <- insight::get_parameters(stmod_cov.putr.uc)

# tidy
posteriors.cov.putrubcov.tidy <- posteriors.cov.putrubcov %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

**Prior summary**: cover ~ time_class + (1 | site_id)    
```{r}
prior_summary(stmod_cov.putr.uc)
```

```{r}
fun.model.summary(stmod_cov.putr.uc)
```

```{r}
posteriors.cov.putrubcov.tidy %>%
  ggplot() +
  geom_density(aes(fill = parameter, x = values),color="grey", alpha = .25) +
  # scale_fill_viridis(discrete = TRUE) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.cov.putrubcov.tidy))) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland,PUTR - Combined Winter Range")
```

```{r}
#### PP check plot
pp_check(stmod_cov.putr.uc) +
  labs(x = "Value", y = "Density", caption = "upland cover ppc plot. PUTR") +
  theme_minimal()

# save plots
ggsave("./output/figures_202107_stats_upland/ppc_PUTR_putrubs_uc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202107_stats_upland/ppc_PUTR_putrubs.pdf", width = 4.75, height = 3.75)
```

```{r}
fun.sexit.flextable(stmod_cov.putr.uc$stanfit)

fun.sexit.gt(stmod_cov.putr.uc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/xPUTR_stmod_cover1_posteriors.rtf")
```


```{r, echo=FALSE, eval=FALSE}
fun.desc.post1.gt.rope(stmod_cov.putr.uc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range")

```

```{r, eval = FALSE}
## save
fun.desc.post1.gt(stmod_cov.putr.uc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/RICE_stmod_cover1_posteriors.rtf")

```
#### Effect Description  
#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_cov.putr.uc) %>% plot() +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland Shrub Cover Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_202107_stats_upland/pd_upl_uc.png", dpi = 300, width = 4.75, height = 3.75)

```


#### Region of Practical Equivalence (ROPE)
```{r}
rope.PUTRcov.wcwnc.gt <- rope(stmod_cov.putr.uc$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.PUTRcov.wcwnc.gt
# rope.PUTRcov.wcwnc.gt %>%
#   gt::gtsave(filename = "./output/tables/upland_cover/rope_PUTRcov_wcwnc.rtf")
```

#### Contrasts

EMM summaries with type = "response", the tests and confidence intervals
are done before back-transforming. The ratios estimated are ratios of
geometric means. A model with a log response is in fact a model for
relative effects of any of its linear predictors, and this
back-transformation to ratios goes hand-in-hand with that.

```{r, include=FALSE, echo=FALSE}
# library(emmeans)
# Note: EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs(pigs.emm.s, reverse = TRUE). Also, in multi-factor situations, you may specify by factor(s) to perform the comparisons separately at the levels of those factors.

# Results are given on the log (not the response) scale.
emmeans(stmod_cov.putr.uc, ~ time_class) %>% 
  pairs() %>% 
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range,PUTR")

# ggsave("./output/figures_202107_stats_upland/emm_PUTRcov_wcwnc.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_202107_stats_upland/emm_PUTRcov_uc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_cov.putr.uc, ~ time_class) %>% 
  pairs() %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_cov.putr.uc, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```
## Upland Shrub Cover, _Purshia tridentata_ - Noncore Winter Range
#### Modeling and Posterior Description
```{r, cache=FALSE}
cov.putr.unc <- cov.putr %>% 
  filter(site_type == "non-core range") # add 

## add cover in 0-1 range
cov.putr.unc <- cov.putr.unc %>%
  mutate(cover = perc_cover/100)
  
stmod_cov.putr.unc <- stan_glmer(cover ~ time_class + (1 | site_id), 
                      data = cov.putr,
                      family = mgcv::betar,
                      prior_aux = exponential(2),
                      iter = 8000,
                      seed = 1234)

```

```{r}
# extract posteriors
posteriors.cov.putrubcov.unc <- insight::get_parameters(stmod_cov.putr.unc)

# tidy
posteriors.cov.putrubcov.tidy <- posteriors.cov.putrubcov %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

**Prior summary**: cover ~ time_class + (1 | site_id)    
```{r}
prior_summary(stmod_cov.putr.unc)
```

```{r}
fun.model.summary(stmod_cov.putr.unc)
```

```{r}
posteriors.cov.putrubcov.tidy %>%
  ggplot() +
  geom_density(aes(fill = parameter, x = values),color="grey", alpha = .25) +
  # scale_fill_viridis(discrete = TRUE) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.cov.putrubcov.tidy))) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland,PUTR - Combined Winter Range")
```

```{r}
#### PP check plot
pp_check(stmod_cov.putr.unc) +
  labs(x = "Value", y = "Density", caption = "upland cover ppc plot. PUTR") +
  theme_minimal()

# save plots
ggsave("./output/figures_202107_stats_upland/ppc_PUTR_putrubs_unc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202107_stats_upland/ppc_PUTR_putrubs.pdf", width = 4.75, height = 3.75)
```

```{r}
fun.sexit.flextable(stmod_cov.putr.unc$stanfit)

fun.sexit.gt(stmod_cov.putr.unc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/xRICE_stmod_cover1_posteriors.rtf")
```


```{r, echo=FALSE, eval=FALSE}
fun.desc.post1.gt.rope(stmod_cov.putr.unc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range")

```

```{r, eval = FALSE}
## save
fun.desc.post1.gt(stmod_cov.putr.unc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/RICE_stmod_cover1_posteriors.rtf")

```
#### Effect Description  
#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_cov.putr.unc) %>% plot() +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland Shrub Cover Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_202107_stats_upland/pd_PUTRcov_unc.png", dpi = 300, width = 4.75, height = 3.75)

```


#### Region of Practical Equivalence (ROPE)
```{r}
rope.PUTRcov.wcwnc.gt <- rope(stmod_cov.putr.unc$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.PUTRcov.wcwnc.gt
# rope.PUTRcov.wcwnc.gt %>%
#   gt::gtsave(filename = "./output/tables/upland_cover/rope_RICEcov_wcwnc.rtf")
```

#### Contrasts

EMM summaries with type = "response", the tests and confidence intervals
are done before back-transforming. The ratios estimated are ratios of
geometric means. A model with a log response is in fact a model for
relative effects of any of its linear predictors, and this
back-transformation to ratios goes hand-in-hand with that.

```{r, include=FALSE, echo=FALSE}
# library(emmeans)
# Note: EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs(pigs.emm.s, reverse = TRUE). Also, in multi-factor situations, you may specify by factor(s) to perform the comparisons separately at the levels of those factors.

# Results are given on the log (not the response) scale.
emmeans(stmod_cov.putr.unc, ~ time_class) %>% 
  pairs() %>% 
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range,PUTR")

# ggsave("./output/figures_202107_stats_upland/emm_PUTRcov_unc.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_202107_stats_upland/emm_PUTRcov_unc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_cov.putr.unc, ~ time_class) %>% 
  pairs() %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_cov.putr.unc, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

## Upland Shrub Cover, _Ribes cereum_ - Combined Winter Range
```{r}
# PUTR
cov.rice <- cov.byspp %>%
  filter(shrub_species == "RICE")

#### summary tables
cov.rice %>% 
  group_by(time_class, site_type) %>% 
  summarytools::descr(perc_cover, stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "Upland cover ~ site type + time_class")

```

#### Modeling and Posterior Description
```{r, cache=FALSE}
## add cover in 0-1 range
cov.rice <- cov.rice %>%
  mutate(cover = perc_cover/100)
  
stmod_cov.rice <- stan_glmer(cover ~ time_class + (1 | site_id), 
                      data = cov.rice,
                      family = mgcv::betar,
                      prior_aux = exponential(2),
                      iter = 8000,
                      seed = 1234)

```

```{r}
# extract posteriors
posteriors.cov.riceubcov <- insight::get_parameters(stmod_cov.rice)

# tidy
posteriors.cov.riceubcov.tidy <- posteriors.cov.riceubcov %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

**Prior summary**: cover ~ time_class + (1 | site_id)    
```{r}
prior_summary(stmod_cov.rice)
```

```{r}
fun.model.summary(stmod_cov.rice)
```

```{r}
posteriors.cov.riceubcov.tidy %>%
  ggplot() +
  geom_density(aes(fill = parameter, x = values),color="grey", alpha = .25) +
  # scale_fill_viridis(discrete = TRUE) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.cov.riceubcov.tidy))) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland,RICE - Combined Winter Range")
```

```{r}
#### PP check plot
pp_check(stmod_cov.rice) +
  labs(x = "Value", y = "Density", caption = "upland cover ppc plot. RICE") +
  theme_minimal()

# save plots
ggsave("./output/figures_202107_stats_upland/ppc_PUTR_riceubs_unc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202107_stats_upland/ppc_PUTR_riceubs.pdf", width = 4.75, height = 3.75)
```

```{r}
fun.sexit.flextable(stmod_cov.rice$stanfit)

fun.sexit.gt(stmod_cov.rice$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/xPUTR_riceubs_stmod_cover1_posteriors.rtf")
```


```{r, echo=FALSE, eval=FALSE}
fun.desc.post1.gt.rope(stmod_cov.rice$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range")

```

```{r, eval = FALSE}
## save
fun.desc.post1.gt(stmod_cov.rice$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/rice_cov_stmod_cover1_posteriors.rtf")

```
#### Effect Description  
#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_cov.rice) %>% plot() +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland Shrub Cover Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_202107_stats_upland/pd_RICEcov_ucunc.png", dpi = 300, width = 4.75, height = 3.75)

```


#### Region of Practical Equivalence (ROPE)
```{r}
rope.RICEcov.wcwnc.gt <- rope(stmod_cov.rice$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.RICEcov.wcwnc.gt
# rope.RICEcov.wcwnc.gt %>%
#   gt::gtsave(filename = "./output/tables/upland_cover/rope_RICEcov_wcwnc.rtf")
```

#### Contrasts

EMM summaries with type = "response", the tests and confidence intervals
are done before back-transforming. The ratios estimated are ratios of
geometric means. A model with a log response is in fact a model for
relative effects of any of its linear predictors, and this
back-transformation to ratios goes hand-in-hand with that.

```{r, include=FALSE, echo=FALSE}
# library(emmeans)
# Note: EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs(pigs.emm.s, reverse = TRUE). Also, in multi-factor situations, you may specify by factor(s) to perform the comparisons separately at the levels of those factors.

# Results are given on the log (not the response) scale.
emmeans(stmod_cov.rice, ~ time_class) %>% 
  pairs() %>% 
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range,RICE")

# ggsave("./output/figures_202107_stats_upland/emm_RICEcov_wcwnc.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_202107_stats_upland/emm_RICEcov_wcwnc_unc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_cov.rice, ~ time_class) %>% 
  pairs() %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_cov.rice, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

## Upland Shrub Cover, _Ribes cereum_ - Core Winter Range
```{r}
#### summary tables
cov.rice %>% 
  group_by(time_class, site_type) %>% 
  summarytools::descr(perc_cover, stats = "common") %>% 
  summarytools::tb() %>%
  mutate_if(.predicate = is.numeric,.funs = round, digits = 2) %>% 
  gt() %>% 
  tab_header(title = "Upland cover - site type + time_class")

```

#### Modeling and Posterior Description
```{r, cache=FALSE}
cov.rice.uc <- cov.rice %>% 
  filter(site_type == "core range") # add 

## add cover in 0-1 range
cov.rice.uc <- cov.rice.uc %>%
  mutate(cover = perc_cover/100)
  
stmod_cov.rice.uc <- stan_glmer(cover ~ time_class + (1 | site_id), 
                      data = cov.rice,
                      family = mgcv::betar,
                      prior_aux = exponential(2),
                      iter = 8000,
                      seed = 1234)

```

```{r}
# extract posteriors
posteriors.cov.riceubcov.uc <- insight::get_parameters(stmod_cov.rice.uc)

# tidy
posteriors.cov.riceubcov.tidy <- posteriors.cov.riceubcov %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

**Prior summary**: cover ~ time_class + (1 | site_id)    
```{r}
prior_summary(stmod_cov.rice.uc)
```

```{r}
fun.model.summary(stmod_cov.rice.uc)
```

```{r}
posteriors.cov.riceubcov.tidy %>%
  ggplot() +
  geom_density(aes(fill = parameter, x = values),color="grey", alpha = .25) +
  # scale_fill_viridis(discrete = TRUE) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.cov.riceubcov.tidy))) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland,RICE - Combined Winter Range")
```

```{r}
#### PP check plot
pp_check(stmod_cov.rice.uc) +
  labs(x = "Value", y = "Density", caption = "upland cover ppc plot. RICE") +
  theme_minimal()

# save plots
ggsave("./output/figures_202107_stats_upland/ppc_RICE_riceubs_uc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202107_stats_upland/ppc_RICE_riceubs.pdf", width = 4.75, height = 3.75)
```

```{r}
fun.sexit.flextable(stmod_cov.rice.uc$stanfit)

fun.sexit.gt(stmod_cov.rice.uc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/RICE_riceubs_stmod_cover1_posteriors.rtf")
```


```{r, echo=FALSE, eval=FALSE}
fun.desc.post1.gt.rope(stmod_cov.rice.uc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range")

```

```{r, eval = FALSE}
## save
fun.desc.post1.gt(stmod_cov.rice.uc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/RICE_riceubs_stmod_cover1_posteriors.rtf")

```
#### Effect Description  
#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_cov.rice.uc) %>% plot() +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland Shrub Cover Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_202107_stats_upland/pd_upl_uc.png", dpi = 300, width = 4.75, height = 3.75)

```


#### Region of Practical Equivalence (ROPE)
```{r}
rope.RICEcov.wcwnc.gt <- rope(stmod_cov.rice.uc$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.RICEcov.wcwnc.gt
# rope.RICEcov.wcwnc.gt %>%
#   gt::gtsave(filename = "./output/tables/upland_cover/rope_RICEcov_wcwnc.rtf")
```

#### Contrasts

EMM summaries with type = "response", the tests and confidence intervals
are done before back-transforming. The ratios estimated are ratios of
geometric means. A model with a log response is in fact a model for
relative effects of any of its linear predictors, and this
back-transformation to ratios goes hand-in-hand with that.

```{r, include=FALSE, echo=FALSE}
# library(emmeans)
# Note: EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs(pigs.emm.s, reverse = TRUE). Also, in multi-factor situations, you may specify by factor(s) to perform the comparisons separately at the levels of those factors.

# Results are given on the log (not the response) scale.
emmeans(stmod_cov.rice.uc, ~ time_class) %>% 
  pairs() %>% 
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range,RICE")

# ggsave("./output/figures_202107_stats_upland/emm_RICEcov_wcwnc.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_202107_stats_upland/emm_RICEcov_uc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_cov.rice.uc, ~ time_class) %>% 
  pairs() %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_cov.rice.uc, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```
## Upland Shrub Cover, _Ribes cereum_ - Noncore Winter Range
#### Modeling and Posterior Description
```{r, cache=FALSE}
cov.rice.unc <- cov.rice %>% 
  filter(site_type == "non-core range") # add 

## add cover in 0-1 range
cov.rice.unc <- cov.rice.unc %>%
  mutate(cover = perc_cover/100)
  
stmod_cov.rice.unc <- stan_glmer(cover ~ time_class + (1 | site_id), 
                      data = cov.rice.unc,
                      family = mgcv::betar,
                      prior_aux = exponential(2),
                      iter = 8000,
                      seed = 1234)

```

```{r}
# extract posteriors
posteriors.cov.riceubcov.unc <- insight::get_parameters(stmod_cov.rice.unc)

# tidy
posteriors.cov.riceubcov.tidy <- posteriors.cov.riceubcov %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

**Prior summary**: cover ~ time_class + (1 | site_id)    
```{r}
prior_summary(stmod_cov.rice.unc)
```

```{r}
fun.model.summary(stmod_cov.rice.unc)
```

```{r}
posteriors.cov.riceubcov.tidy %>%
  ggplot() +
  geom_density(aes(fill = parameter, x = values),color="grey", alpha = .25) +
  # scale_fill_viridis(discrete = TRUE) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.cov.riceubcov.tidy))) +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland,RICE - Combined Winter Range")
```

```{r}
#### PP check plot
pp_check(stmod_cov.rice.unc) +
  labs(x = "Value", y = "Density", caption = "upland cover ppc plot. RICE") +
  theme_minimal()

# save plots
ggsave("./output/figures_202107_stats_upland/ppc_RICE_riceubs_unc.png", dpi = 300, width = 4.75, height = 3.75)
# ggsave("./output/figures_202107_stats_upland/ppc_RICE_riceubs.pdf", width = 4.75, height = 3.75)
```

```{r}
fun.sexit.flextable(stmod_cov.rice.unc$stanfit)

fun.sexit.gt(stmod_cov.rice.unc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/xRICE_riceubs_stmod_cover1_posteriors.rtf")
```


```{r, echo=FALSE, eval=FALSE}
fun.desc.post1.gt.rope(stmod_cov.rice.unc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range")

```

```{r, eval = FALSE}
## save
fun.desc.post1.gt(stmod_cov.rice.unc$stanfit) %>%
  tab_header(title = "Upland Shrub Cover Posterior Description", subtitle = "Combined Core & Noncore Winter Range") %>% 
  gt::gtsave(filename = "./output/tables/upland_cover/RICE_riceubs_stmod_cover1_posteriors.rtf")

```
#### Effect Description  
#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_cov.rice.unc) %>% plot() +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Upland Shrub Cover Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_202107_stats_upland/pd_RICEcov_unc.png", dpi = 300, width = 4.75, height = 3.75)

```


#### Region of Practical Equivalence (ROPE)
```{r}
rope.RICEcov.wcwnc.gt <- rope(stmod_cov.rice.unc$stanfit, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 2,
    suffixing = TRUE
  ) 

rope.RICEcov.wcwnc.gt
# rope.RICEcov.wcwnc.gt %>%
#   gt::gtsave(filename = "./output/tables/upland_cover/rope_RICEcov_wcwnc.rtf")
```

#### Contrasts

EMM summaries with type = "response", the tests and confidence intervals
are done before back-transforming. The ratios estimated are ratios of
geometric means. A model with a log response is in fact a model for
relative effects of any of its linear predictors, and this
back-transformation to ratios goes hand-in-hand with that.

```{r, include=FALSE, echo=FALSE}
# library(emmeans)
# Note: EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs(pigs.emm.s, reverse = TRUE). Also, in multi-factor situations, you may specify by factor(s) to perform the comparisons separately at the levels of those factors.

# Results are given on the log (not the response) scale.
emmeans(stmod_cov.rice.unc, ~ time_class) %>% 
  pairs() %>% 
  plot(type="response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range,RICE")

# ggsave("./output/figures_202107_stats_upland/emm_RICEcov_unc.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_202107_stats_upland/emm_RICEcov_unc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_cov.rice.unc, ~ time_class) %>% 
  pairs() %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>%
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log scale")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_cov.rice.unc, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

### _Purshia tridenta_
```{r, eval=TRUE}
# putr

pl.emm.cov.putr.ucunc <- emmeans(stmod_cov.putr, ~ time_class) %>% 
  pairs() %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Combined Range", x = "", y = "Contrast")

pl.emm.cov.putr.uc <- emmeans(stmod_cov.putr.uc, ~ time_class) %>% 
  pairs() %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Core Range", x = "Estimate", y = "")

pl.emm.cov.putr.unc <- emmeans(stmod_cov.putr.unc, ~ time_class) %>% 
  pairs() %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Noncore Range", x = "", y = "")


pl.patch.putr <- pl.emm.cov.putr.ucunc + pl.emm.cov.putr.uc + pl.emm.cov.putr.unc + 
  patchwork::plot_layout(ncol=3) +
  plot_annotation(title = expression(paste(italic("Pushia tridentata"))))

pl.patch.putr
ggsave("./output/figures_202107_stats_upland/uplcov_3panel_putr.png", dpi = 300, width = 7.75, height = 2.75)
```

### _Ribes cereum_

```{r}
# Point estimate displayed: median 
# HPD interval probability: 0.95

pl.emm.cov.rice.ucunc <- emmeans(stmod_cov.rice, ~ time_class) %>% 
  pairs() %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Combined Range", x = "", y = "Contrast")

pl.emm.cov.rice.uc <- emmeans(stmod_cov.rice.uc, ~ time_class) %>% 
  pairs() %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Core Range", x = "Estimate", y = "")

pl.emm.cov.rice.unc <- emmeans(stmod_cov.rice.unc, ~ time_class) %>% 
  pairs() %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Noncore Range", x = "", y = "")


pl.patch.rice <- pl.emm.cov.rice.ucunc + pl.emm.cov.rice.uc + pl.emm.cov.rice.unc + 
  patchwork::plot_layout(ncol=3) +
  plot_annotation(title = expression(paste(italic("Ribes cereum"))))

pl.patch.rice
# pl.patch.putr + pl.patch.rice + plot_layout(ncol=1)

ggsave("./output/figures_202107_stats_upland/uplcov_3panel_rice.png", dpi = 300, width = 7.75, height = 3.75)
```



```{r, eval=FALSE}
# rice
# pl.emm.cov.rice.ucunc <- emmeans(stmod_cov.rice, ~ time_class) %>% 
#   pairs() %>% 
#   plot() +
#   theme_minimal() +
#   geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
#   labs(title= "Combined Range", subtitle = expression(paste(italic("Ribes cereum"))), x = "", y = "Contrast")
# 
# pl.emm.cov.rice.uc <- emmeans(stmod_cov.rice.uc, ~ time_class) %>% 
#   pairs() %>% 
#   plot() +
#   theme_minimal() +
#   geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
#   labs(title= "Core Range", subtitle = expression(paste(italic("Ribes cereum"))), x = "Estimate", y = "")
# 
# pl.emm.cov.rice.unc <- emmeans(stmod_cov.rice.unc, ~ time_class) %>% 
#   pairs() %>% 
#   plot() +
#   theme_minimal() +
#   geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
#   labs(title= "Noncore Range", subtitle = expression(paste(italic("Ribes cereum"))), x = "", y = "")
# 
# 
# pl.emm.cov.rice.ucunc + pl.emm.cov.rice.uc + pl.emm.cov.rice.unc + 
#   patchwork::plot_layout(ncol=3) +
#   plot_annotation(title = 'Upland Shrub Cover', subtitle = expression(paste(italic("RICE"))))
# 
# ggsave("./output/figures_202107_stats_upland/uplcov_3panel_rice.png", dpi = 300, width = 7.75, height = 3.75)
```
 
**Combined range**
```{r}
(pl.emm.upl.allshr.ucunc + labs(x="", subtitle="All shrubs")) + (pl.emm.cov.putr.ucunc + labs(x="Estimate",subtitle="PUTR")) + (pl.emm.cov.rice.ucunc + labs(subtitle="RICE")) + 
  patchwork::plot_layout(ncol=3) +
  plot_annotation(title = 'Combined Range')

ggsave("./output/figures_202107_stats_upland/uplcov_3panel_ucunc_allshr_putr_rice.png", dpi = 300, width = 7.75, height = 3.75)
```

**Core range**
```{r}
(pl.emm.upl.allshr.uc + labs(subtitle="All shrubs")) + (pl.emm.cov.putr.uc + labs(subtitle="PUTR"))+ (pl.emm.cov.rice.uc + labs(subtitle="RICE")) + 
  patchwork::plot_layout(ncol=3) +
  plot_annotation(title = 'Core Range')

ggsave("./output/figures_202107_stats_upland/uplcov_3panel_uc_allshr_putr_rice.png", dpi = 300, width = 7.75, height = 1.75)
```

**Noncore range**
```{r}
(pl.emm.upl.allshr.unc + labs(subtitle="All shrubs")) + (pl.emm.cov.putr.unc + labs(subtitle="PUTR")) + (pl.emm.cov.rice.unc + labs(subtitle="RICE")) + 
  patchwork::plot_layout(ncol=3) +
  plot_annotation(title = 'Noncore Range')

ggsave("./output/figures_202107_stats_upland/uplcov_3panel_unc_allshr_putr_rice.png", dpi = 300, width = 7.75, height = 3.75)
```


```{r, echo=FALSE, eval=FALSE}
# Session info

# R version 4.0.3 (2020-10-10)  
# Platform: x86_64-w64-mingw32/x64 (64-bit)  
# Running under: Windows 10 x64 (build 19041)  
# Last updated: `r format(Sys.time(), '%Y %B %d')` 
```


```{r, echo=FALSE, eval=FALSE}
subset(data.frame(sessioninfo::package_info()), attached==TRUE, c(package, loadedversion)) %>% 
  gt() %>% 
  tab_header(title = "Attached packages and versions")

```

```{r, echo=FALSE, eval=FALSE}
citation(package = "emmeans")
citation(package = "rstanarm")
citation(package = "bayestestR")
citation(package = "Tidyverse")
# library(bayesplot)
citation(package = "bayesplot")
```


# References

Gabry J., Mahr T. 2021. “bayesplot: Plotting for Bayesian Models.” R package version 1.8.1, <URL:
https://mc-stan.org/bayesplot/>.

Gabry J., Simpson D., Vehtari A., Betancourt M., Gelman A. 2019. “Visualization in Bayesian workflow.” _J.R. Stat. Soc. A_, *182*, 389-402. doi: 10.1111/rssa.12378 (URL: https://doi.org/10.1111/rssa.12378).

Gelman, A., Hill, J., Vehtari, A. 2020. Regression and other stories. Cambridge University Press.

Goodrich B, Gabry J, Ali I & Brilleman S. 2020. rstanarm: Bayesian applied regression modeling via
  Stan. R package version 2.21.1 https://mc-stan.org/rstanarm

Lenth, R.V. 2021. emmeans: Estimated Marginal Means, aka Least-Squares Means. R package version
  1.6.3. https://CRAN.R-project.org/package=emmeans  

  





