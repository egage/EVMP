---
title: "Appendix C. EVMP Aspen Statistical Analyses"
author: ""
date: ""
output: 
  html_document: 
    theme: journal
    toc: yes
    toc_depth: 2
    code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
bibliography: references.bib
---

*Repository:*\
<https://github.com/egage/EVMP>   

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.align = 'center')
opts_knit$set(root.dir=normalizePath('../')) # this is required if Rmd is nested below the project directory
opts_chunk$set(fig.path = "../output/figures/") # corrected path and added dev. Needed to specify a subdirectory for figs

set.seed(1234)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(janitor))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(lubridate))
library(emmeans)
library(rstanarm)
options(mc.cores = parallel::detectCores())
library(bayestestR)
library(gt)
library(ggridges)
library(shinystan)
library(patchwork)
library(bayesplot)
```

```{r, functions, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, eval=TRUE}
### Table functions

fun.sexit.gt <- function(model){
  bayestestR::sexit(model, ci=0.9) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric), round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Effect Existence and Significance Testing") 
  }

## model summary to DT
fun.model.summary <- function(model){
  summary(model,
          probs = c(0.1, 0.5, 0.9),
          digits = 1) %>%
  as_tibble(rownames = "Parameter") %>%
  mutate(across(where(is.numeric),round,2)) %>%
  datatable(caption = "Model summary")
}

## function to describe model output
fun.desc.post1 <- function(model){
  describe_posterior(
  model,
  effects = "fixed",
  component = "all",
  ci_method = "hdi",
  ci=0.9,
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
    as_tibble() %>% 
    DT::datatable(caption = "Posterior description")
}

## gt
# describe posterior
fun.desc.post1.gt.rope <- function(model){
  describe_posterior(
  model,
  effects = "fixed",
  component = "all",
  ci_method = "hdi",
  ci=0.9,
  test = c("p_direction", "p_significance","rope"),
  #rope_range(c(-0.1,0.1)),
  rope_range("default"),
  rope_ci = 0.95,
  centrality = "median"
) %>% 
    as_tibble() %>% 
    gt() %>% 
    tab_header(title = "Posterior description") %>% 
    fmt_number(
    columns = 2:14,
    decimals = 2,
    suffixing = TRUE
  )
}

#### Plotting functions
fun.contrast.plot <- function(df){
  df %>% 
  ggplot(aes(x = contrast)) +
  geom_linerange(aes(ymin = lower.HPD, ymax = upper.HPD), color = "lightblue", size = 2) +
  geom_point(aes(y = estimate), size = 2.5) +
  theme_minimal() +
  labs(caption = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Estimate") +
  coord_flip()
}

## ppcheck.plot
ppc.plot <- function(model){
  pp_check(model) +
  labs(x = "Value", y = "Density") +
  theme_minimal()
}

## emmip fence x tc
plotF.emmip_FxTC_response <- function(model){
  emmip(model, fenced ~ time_class, type = "response") +
  theme_minimal() +
  scale_color_manual(values = colfunc3(2)) +
  labs(color="") +
  theme(legend.position = "top")
  # theme(legend.position = c(.15, .15))
}



# plot.emmip.smsap.acanc <- emmip(stmod_stally2.acanc.sm, fenced ~ time_class, type = "reponse",
#   breaks = seq(0.50, 1, by = 0.10)) +
#   theme_minimal() +
#   scale_color_manual(values = colfunc3(2)) +
#   labs(color="") +
#   theme(legend.position = c(.15, .15))
# 
# plot.emmip.smsap.acanc

## describe posterior to DT
desc.post1 <- function(model){
  describe_posterior(
  model,
  effects = "all",
  component = "all",
  test = c("p_direction", "p_significance"),
  centrality = "all"
) %>% 
    as_tibble() %>% 
    DT::datatable(caption = "Posterior description")
}

```

```{r}
# custom gradients and palettes
dbhclass.gradient5 <- c("#26185F", "#0095AF", "#9ADCBB", "#FCFFDD", "grey50")

colfunc1<-colorRampPalette(c("#26185F","#0095AF","#9ADCBB", "#FCFFDD"))
colfunc2<-colorRampPalette(c("#0095AF","#9ADCBB", "#FCFFDD"))
colfunc3<-colorRampPalette(c("#0095AF","#9ADCBB"))
colfunc3_RdBu <- colorRampPalette(c("#EF8A62", "#FDDBC7", "#D1E5F0", "#67A9CF"))

# plot(rep(1,50),col=(colfunc1(50)), pch=19,cex=2)
# plot(rep(1,5),col=(colfunc1(5)), pch=19,cex=2)
pal.5a <- colfunc1(5)
pal.7a <- colfunc1(7)

# palette3 <- RColorBrewer::brewer.pal(6,"RdBu")
# RColorBrewer::display.brewer.pal(6,"RdBu")
```

# Introduction

This document contains code for running statistical analyses of Elk
Vegetation Management Plan (EVMP) data collected through the 2018
sampling season. Analyses are limited to data from plots established in
aspen communities in areas of the elk winter range (core and noncore
areas) and the Kawuneeche Valley (i.e., "aspen" plots, see Zeigenfuss et
al. 2011) and is provided as a supplement to the NPS NRR Report
"Monitoring of Vegetation Response to Elk Population and Habitat
Management in Rocky Mountain National Park - Analysis of Elk Vegetation
Management Plan monitoring Data: 2008--2018". For information on
sampling and the broader analysis and interpretation of the results,
refer to this report, past analyses [@zeigenfuss2015], and the original
EVMP monitoring plan [@zeigenfuss2011].

# Methods

The code and results presented here start from and build upon derived
data produced in a separate code document focused on ingesting,
compiling, and cleaning raw data provided by RMNP staff. Extensive
"munging" of raw files was required, so the decision was made to
separate code used to pre-process raw data from code used for the
analyses presented here. Likewise, separate code documents were
developed for other distinct elements of the larger EVMP (e.g., willow
and upland plots). In general, packages included in the "Tidyverse"
ecosystem of R packages were used for data transformation and
visualization [@wickham2019], although specialized packages particular
to specific tasks (e.g., the "bayesplot" plot for visualization of
Bayesian posterior distributions) were also used [@gabry2019].

Bayesian repeated measures analyses were fit separately for combined
core and noncore winter range, core winter range, and noncore
winter range plots with plots treated as random factors using the
'stan_glmer' function in the rstanrm package
[@goodrich2020][@brilleman2018]. Bayesian estimation was performed via
MCMC adding independent weakly informed priors specific to the data type
being modeled. Count data like aspen stem counts were modeled as poisson processes, while
proportion data (e.g., cover) were modeled using a beta distribution
(Ferrari and Cribari-Neto 2004), which constrains values from 0 to 1.

The Probability of Direction (PD) was used to represent certainty
associated with the most probable direction (positive or negative) of
the effect (e.g., time class, fencing). The PD is correlated with the
frequentist p-value, with a two-sided p-value of respectively .1, .05,
and .01 approximated by a PD of 95%, 97.5%, and 99.5% [@makowski2019].
The "region of practical equivalence" (ROPE) was used to evaluate the probability
of a parameter being outside a range that can be considered as
"practically no effect", i.e., a region enclosing values that are
equivalent to the null value for practical purposes [@kruschke2018].
The proportion of the 95% HDI credible interval falling within the
ROPE was used as an index for an analog to frequentist "null-hypothesis"
testing.




```{r}
## read in data
# !!! check the read in below - a major change

# Aspen dbh
# ht_perc1 <- read_csv("./output/exported_data/asp_ht_perc1_20200309.csv")
dbh_perc1 <- read_csv("./output/exported_data/asp_dbh_perc1_20210601.csv")

ht_perc1 <- read_csv("./output/exported_data/asp_ht_perc1_20200309.csv")


# Data munging

## filter out in-between years
ht_perc1 <- ht_perc1 %>%
  filter(timeClass %in% c("BL","2013", "2018")) 

### factor relevel
ht_perc1 <- ht_perc1 %>% 
  mutate(timeClass = as.factor(timeClass)) %>% 
  mutate(timeClass = fct_relevel(timeClass, "BL", "2013", "2018")) %>% 
  mutate(RANGE_TYPE = as.factor(RANGE_TYPE)) %>% 
  mutate(RANGE_TYPE = fct_relevel(RANGE_TYPE, "core winter range","non-core winter range","Kawuneeche Valley"))   

dbh_perc1 <- dbh_perc1 %>% 
  filter(timeClass %in% c("BL","2013", "2018")) %>% 
  mutate(timeClass = as.factor(timeClass)) %>% 
  mutate(timeClass = fct_relevel(timeClass, "BL", "2013", "2018")) %>% 
  mutate(RANGE_TYPE = as.factor(RANGE_TYPE)) %>% 
  mutate(RANGE_TYPE = fct_relevel(RANGE_TYPE, "core winter range","non-core winter range","Kawuneeche Valley"))  

```

```{r}
# factor conversions...

ht_perc1 <- ht_perc1 %>% 
  clean_names() %>% 
  rename(htclass2 = h_tclass2) %>% 
  rename(htclass = h_tclass)

## set factor levels for burned and fenced
ht_perc1 <- ht_perc1 %>%
  mutate(fenced.long = case_when(fenced == "N" ~ "Unfenced",
                                 fenced == "Y" ~ "Fenced",
                                 TRUE ~ fenced)) %>% 
  mutate(burned = case_when(burned == "Not burned" ~ "Unburned",
                            TRUE ~ burned)) %>%
  mutate(fenced.long = as_factor(fenced.long)) %>%
  mutate(burned = as_factor(burned))

# convert 'fenced' to factor
ht_perc1 <- ht_perc1 %>%
  mutate(fenced = as_factor(fenced)) %>% 
  mutate(burned = as_factor(burned))

# levels(ht_perc1$fenced)
# levels(ht_perc1$burned)

## subset height data to all LIVE stems
asp.acanc <- ht_perc1 %>% 
  filter(site_type == "AC" | site_type == "ANC") %>% 
  filter(live_dead == "LIVE")
  
asp.ac <- ht_perc1 %>% 
  filter(site_type == "AC") %>% 
  filter(live_dead == "LIVE")

# non core
asp.anc <- ht_perc1 %>% 
  filter(site_type == "ANC") %>% 
  filter(live_dead == "LIVE")

# KV
asp.ak <- ht_perc1 %>% 
  filter(site_type == "AK") %>% 
  filter(live_dead == "LIVE")

### subset to small saplings <1.5m
## subset to all LIVE stems
ht_perc1 <- ht_perc1 %>% 
  mutate(sap_size = case_when(htclass2 == "0-50cm" | htclass2 == "51-100cm" | htclass2 == "101-150cm" ~ "small saplings",
                              htclass2 == "151-200cm" | htclass2 == "201-250cm" ~ "tall saplings")) 

asp.sm.acanc <- ht_perc1 %>%
  filter(sap_size == "small saplings") %>% 
  filter(site_type == "AC" | site_type == "ANC") %>% 
  filter(live_dead == "LIVE")
  
asp.sm.ac <- ht_perc1 %>% 
  filter(sap_size == "small saplings") %>%
  filter(site_type == "AC") %>% 
  filter(live_dead == "LIVE")

# non core
asp.sm.anc <- ht_perc1 %>% 
  filter(sap_size == "small saplings") %>%
  filter(site_type == "ANC") %>% 
  filter(live_dead == "LIVE")

# KV
asp.sm.ak <- ht_perc1 %>% 
  filter(sap_size == "small saplings") %>%
  filter(site_type == "AK") %>% 
  filter(live_dead == "LIVE")

### subset to large saplings 1.5m-2.5
## subset to all LIVE stems
asp.lg.acanc <- ht_perc1 %>% 
  filter(sap_size == "tall saplings") %>% 
  filter(site_type == "AC" | site_type == "ANC") %>% 
  filter(live_dead == "LIVE")
  
asp.lg.ac <- ht_perc1 %>% 
  filter(sap_size == "tall saplings") %>%
  filter(site_type == "AC") %>% 
  filter(live_dead == "LIVE")

# non core
asp.lg.anc <- ht_perc1 %>% 
  filter(sap_size == "tall saplings") %>%
  filter(site_type == "ANC") %>% 
  filter(live_dead == "LIVE")

# KV
asp.lg.ak <- ht_perc1 %>% 
  filter(sap_size == "tall saplings") %>%
  filter(site_type == "AK") %>% 
  filter(live_dead == "LIVE")

```

```{r}
### dbh
dbh_perc1 <- dbh_perc1 %>% 
  clean_names()

dbh_perc1 <- dbh_perc1 %>%
  mutate(fenced.long = case_when(fenced == "N" ~ "Unfenced",
                                 fenced == "Y" ~ "Fenced",
                                 TRUE ~ fenced)) %>% 
  mutate(burned = case_when(burned == "Not burned" ~ "Unburned",
                            TRUE ~ burned)) %>%
  mutate(fenced.long = as_factor(fenced.long)) %>%
  mutate(burned = as_factor(burned))

```

# Results  
## Comparison of Sapling Classes
```{r, ech=FALSE, eval=FALSE}

ht_perc1 %>%
  filter(live_dead == "LIVE") %>%
  group_by(sap_size, site_id, time_class, fenced, burned) %>% 
  summarise(sum.st = sum(stem_tally)) %>% 
  ungroup() %>% 
  ggplot() +
  geom_col(aes(x=site_id, y=sum.st, fill=sap_size)) +
  facet_grid(time_class ~ fenced)

```


```{r}
tally.sapsize <- ht_perc1 %>%
  filter(live_dead == "LIVE") %>%
  group_by(sap_size, site_id, site_type, time_class, fenced, burned) %>% 
  summarise(sum.st = sum(stem_tally)) %>% 
  ungroup() 


sapsize_summaryTCxSiteType <- tally.sapsize %>%
  group_by(time_class, site_type, sap_size) %>%  
  summarytools::descr(var = sum.st, round.digits = 1) %>% 
  summarytools::tb() %>%
  mutate(across(where(is.numeric), round, 1)) %>% 
  select(-c(variable, se.skewness, kurtosis, pct.valid,cv, skewness))
  
sapsize_summaryTCxSiteType %>% 
  rename(n = n.valid, 'Time class' = time_class) %>% 
  arrange(sap_size,site_type,'time_class') %>% 
  gt() %>% 
  tab_header(title = "Aspen Saplings")# 

## barchart
sapsize_summaryTCxSiteType %>% 
  mutate(site_type = as_factor(site_type)) %>% 
  mutate(site_type = fct_relevel(site_type, "AK", after = 2)) %>% 
  ggplot(aes(x=time_class, y=mean)) +
  geom_col(aes(fill = sap_size), position = 'dodge') +
  scale_fill_manual(values=colfunc3(2)) +
  facet_wrap(~site_type) +
  theme_minimal() +
  labs(x = "Time class", y = "Mean stem tally", fill = "")

ggsave("./output/figures_exported/aspen_stem_count/asp_saplingmean_3panel.png", dpi = 300, width = 8.75, height = 4.75)

```


```{r, eval=FALSE}
## separate panels
pl.sapmean.ac <- tally.sapsize %>%
  filter(site_type == "AC") %>% 
  group_by(time_class, sap_size, fenced) %>%  
  summarytools::descr(var = sum.st, round.digits = 1) %>% 
  summarytools::tb() %>%
  mutate(across(where(is.numeric), round, 1)) %>% 
  ggplot(aes(x=time_class, y=mean)) +
  geom_col(aes(fill = fenced), position = 'dodge') +
  scale_fill_manual(values=colfunc3(2)) +
  facet_wrap(~sap_size) +
  theme_minimal() +
  theme(legend.position = "top") +
  labs(title = "Core Winter Range", x = "Time class", y = "Mean stem tally", fill = "")

## anc
pl.sapmean.anc <- tally.sapsize %>%
  filter(site_type == "ANC") %>% 
  group_by(time_class, sap_size, fenced) %>%  
  summarytools::descr(var = sum.st, round.digits = 1) %>% 
  summarytools::tb() %>%
  mutate(across(where(is.numeric), round, 1)) %>% 
  ggplot(aes(x=time_class, y=mean)) +
  geom_col(aes(fill = fenced), position = 'dodge') +
  scale_fill_manual(values=colfunc3(2)) +
  facet_wrap(~sap_size) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Noncore Winter Range", x = "Time class", y = "Mean stem tally", fill = "")

## ak
pl.sapmean.ak <- tally.sapsize %>%
  filter(site_type == "AK") %>% 
  group_by(time_class, sap_size, fenced) %>%  
  summarytools::descr(var = sum.st, round.digits = 1) %>% 
  summarytools::tb() %>%
  mutate(across(where(is.numeric), round, 1)) %>% 
  ggplot(aes(x=time_class, y=mean)) +
  geom_col(aes(fill = fenced), position = 'dodge') +
  scale_fill_manual(values=colfunc3(2)) +
  facet_wrap(~sap_size) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Kawuneeche Valley", x = "Time class", y = "Mean stem tally", fill = "")

pl.sapmean.ac + pl.sapmean.anc + pl.sapmean.ak + patchwork::plot_layout(ncol=3)

# save plots
# ggsave("./output/figures_exported/aspen_stem_count/asp_saplingmean_3panelalt.png", dpi = 300, width = 5.75, height = 6.75)

```

```{r, eval=FALSE}
asp.sm.acanc %>%
  filter(LIVE_DEAD == 'LIVE') %>% 
  filter(timeClass == "BL" | timeClass == "2013" | timeClass == "2018") %>% 
  mutate(timeClass = fct_drop(timeClass)) %>% 
  mutate(timeClass = fct_rev(timeClass)) %>%
  group_by(timeClass, SITE_TYPE) %>% 
  summarytools::descr(var = stemDen.ha,
                      stats = "common")
```


## Short Saplings (<=1.5m Tall)) - Combined Winter Range (AC+ANC)
```{r}
asp.sm.acanc <- asp.sm.acanc %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 

# reverse factor levels
# asp.sm.acanc <- asp.sm.acanc %>% 
#   mutate(fenced = fct_rev(fenced))
  # mutate(time_class = fct_rev(time_class))
```

### Modeling and Posterior Description  
```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.acanc.sm <- stan_glmer(stem_tally ~ time_class * fenced + (1 | site_id), data = asp.sm.acanc,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.acanc.sm)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.acanc.sm)
```

```{r}
# extract posteriors
posteriors.acanc.stcnt.sm <- insight::get_parameters(stmod_stally2.acanc.sm) %>% 
  rename('2013' = time_class2013) %>%
  rename('2018' = time_class2018) %>%
  rename(Fenced = fencedFenced) %>%
  rename('2013:Fenced' = `time_class2013:fencedFenced`) %>%
  rename('2018:Fenced' = `time_class2018:fencedFenced`)

# names(posteriors.acanc.stcnt.sm)

# tidy
posteriors.acanc.stcnt.sm.tidy <- posteriors.acanc.stcnt.sm %>%
  pivot_longer(cols = c(`(Intercept)`,"2013","2018","Fenced","2013:Fenced", "2018:Fenced"),names_to = "parameter", values_to = "values")
  # pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
color_scheme_set("teal")
plot.mcmcareas_acanc.stcnt.sm <- mcmc_areas(posteriors.acanc.stcnt.sm,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_acanc.stcnt.sm
```

### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.acanc.sm)

# names(stmod_stally2.acanc.sm)
# stmod_stally2.acanc.sm$family 
# stmod_stally2.acanc.sm$linear.predictors

fun.sexit.gt(stmod_stally2.acanc.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Combined Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_acanc_smsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.acanc.sm) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Combined Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.acanc.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Combined Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_acanc_smsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.acanc.stcnt.sm.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values), alpha = .12, color="grey50") +
  scale_fill_viridis(discrete = TRUE) +
  # scale_fill_brewer(palette = "Set1") +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_acanc_smsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_acanc_smsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
plot.pdif.acanc.sm <- p_direction(stmod_stally2.acanc.sm) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Small Saplings, Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

plot.pdif.acanc.sm
# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_acanc_smsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_acanc_smsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.acanc.sm <- rope(stmod_stally2.acanc.sm, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.acanc.sm %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_acanc_smap.rtf")

```

### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.acanc.sm, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, Aspen Stem Count, Small Saplings. Results are given on the log scale") 

ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_acanc_smsap.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_acanc_smsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.acanc.sm, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.acanc.sm, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.

```

```{r}
plot.emmip.smsap.acanc <- emmip(stmod_stally2.acanc.sm, fenced ~ time_class, type = "reponse",
  breaks = seq(0.50, 1, by = 0.10)) +
  theme_minimal() +
  scale_color_manual(values = colfunc3(2)) +
  labs(color="") +
  theme(legend.position = c(.15, .15))

plot.emmip.smsap.acanc

```


## Short Saplings (<=1.5m Tall) - Core Winter Range (AC)
```{r}
asp.sm.ac <- asp.sm.ac %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 
```

### Modeling and Posterior Description  
```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.ac.sm <- stan_glmer(stem_tally ~ time_class * fenced + (1 | site_id), data = asp.sm.ac,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.ac.sm)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.ac.sm)
```

```{r}
# extract posteriors
posteriors.ac.stcnt.sm <- insight::get_parameters(stmod_stally2.ac.sm) %>% 
  rename('2013' = time_class2013) %>%
  rename('2018' = time_class2018) %>%
  rename(Fenced = fencedFenced) %>%
  rename('2013:Fenced' = `time_class2013:fencedFenced`) %>%
  rename('2018:Fenced' = `time_class2018:fencedFenced`)

# names(posteriors.ac.stcnt.sm)

# tidy
posteriors.ac.stcnt.sm.tidy <- posteriors.ac.stcnt.sm %>%
  pivot_longer(cols = c(`(Intercept)`,"2013","2018","Fenced","2013:Fenced", "2018:Fenced"),names_to = "parameter", values_to = "values")

# tidy
# posteriors.ac.stcnt.sm.tidy <- posteriors.ac.stcnt.sm %>%
#   pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
color_scheme_set("teal")
plot.mcmcareas_ac.stcnt.sm <- mcmc_areas(posteriors.ac.stcnt.sm,
           prob = 0.9) +
  ggtitle("Core Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ac.stcnt.sm
```

### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.ac.sm)

fun.sexit.gt(stmod_stally2.ac.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_ac_smsap.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.ac.sm) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Core Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.ac.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_ac_smsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.ac.stcnt.sm.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values), alpha = .12, color="grey50") +
  # geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  # scale_fill_manual(values = colfunc2(ncol(posteriors.ac.stcnt.sm.tidy))) +
  # scale_fill_brewer(palette = "Set1") +
  scale_fill_viridis(discrete = TRUE) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ac_smsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ac_smsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_stally2.ac.sm) %>% #distinct(Parameter)
  # mutate(Parameter = case_when(Parameter == "time_class2013"~'2013',
  # Parameter == "time_class2018"~'2018',
  # Parameter == "time_class2013:fencedFenced"~'2013:Fenced',
  # Parameter == "time_class2018:fencedFenced"~'2018:Fenced',
  # Parameter == "fencedFenced"~'Fenced')) %>%
  plot() +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Small Saplings, Core Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# p_direction(stmod_stally2.ac.sm) %>%
#   tabyl(Parameter)

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ac_smsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ac_smsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.ac.sm <- rope(stmod_stally2.ac.sm, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ac.sm %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_ac_smap.rtf")

```

### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.ac.sm, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Aspen Stem Count, Small Saplings. Results are given on the log scale")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ac_smsap.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ac_smsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.ac.sm, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.ac.sm, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.

```

## Short Saplings (<=1.5m Tall) - Noncore Winter Range (ANC)

```{r}
asp.sm.anc <- asp.sm.anc %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 
```

### Modeling and Posterior Description  
```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.anc.sm <- stan_glmer(stem_tally ~ time_class + (1 | site_id), data = asp.sm.anc,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.anc.sm)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.anc.sm)
```

```{r}
# extract posteriors
posteriors.anc.stcnt.sm <- insight::get_parameters(stmod_stally2.anc.sm)

# tidy
posteriors.anc.stcnt.sm.tidy <- posteriors.anc.stcnt.sm %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")


posteriors.anc.stcnt.sm <- insight::get_parameters(stmod_stally2.anc.sm) %>% 
  rename('2013' = time_class2013) %>%
  rename('2018' = time_class2018) 

# names(posteriors.anc.stcnt.sm)

# tidy
# posteriors.ac.stcnt.sm.tidy <- posteriors.ac.stcnt.sm %>%
#   pivot_longer(cols = c(`(Intercept)`,"2013","2018","Unfenced","2013:Fenced", "2018:Fenced"),names_to = "parameter", values_to = "values")
```

```{r}
color_scheme_set("teal")
plot.mcmcareas_anc.stcnt.sm <- mcmc_areas(posteriors.anc.stcnt.sm,
           prob = 0.9) +
  ggtitle("Noncore Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_anc.stcnt.sm
```

### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.anc.sm)

fun.sexit.gt(stmod_stally2.anc.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Noncore Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_anc_smsap.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.anc.sm) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Noncore Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.anc.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Noncore Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_anc_smsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.anc.stcnt.sm.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.anc.stcnt.sm.tidy))) +
  scale_color_manual(values = colfunc2(ncol(posteriors.anc.stcnt.sm.tidy))) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_anc_smsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_anc_smsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - anc
p_direction(stmod_stally2.anc.sm) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Small Saplings, Noncore Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_anc_smsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_anc_smsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.anc.sm <- rope(stmod_stally2.anc.sm, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.anc.sm %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_anc_smap.rtf")

```

### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.anc.sm, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Noncore Winter Range, Aspen Stem Count, Small Saplings. Results are given on the log scale")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_anc_smsap.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_anc_smsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.anc.sm, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.anc.sm, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

## Short Saplings (<=1.5m Tall)) - Kawuneeche Valley (AK)

### Modeling and Posterior Description
```{r}
asp.sm.ak <- asp.sm.ak %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 
```


```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.ak.sm <- stan_glmer(stem_tally ~ time_class + (1 | site_id), data = asp.sm.ak,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.ak.sm)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.ak.sm)
```

```{r}
# extract posteriors
posteriors.ak.stcnt.sm <- insight::get_parameters(stmod_stally2.ak.sm) %>% 
  rename('2013' = time_class2013) %>%
  rename('2018' = time_class2018) 

# tidy
posteriors.ak.stcnt.sm.tidy <- posteriors.ak.stcnt.sm %>%
  pivot_longer(cols = c('2013','2018'), names_to = "parameter", values_to = "values")
  # pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
color_scheme_set("teal")
# color_scheme_set("teal")

plot.mcmcareas_ak.stcnt.sm <- mcmc_areas(posteriors.ak.stcnt.sm,
           prob = 0.9) +
  ggtitle("Kawuneeche Valley") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ak.stcnt.sm
```

**Panel plot of above MCMC area plots**
```{r}
## rendered for print doc
## turned off for Rmd appx
# panel of ACNC AC ANC AK - small saplings

smsap.plot1 <- mcmc_areas(posteriors.acanc.stcnt.sm,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  geom_vline(aes(xintercept=0), lty="dashed") +
  theme(text = element_text(family = 'sans'))

smsap.plot2 <- mcmc_areas(posteriors.ac.stcnt.sm,
           prob = 0.9) +
  ggtitle("Core Winter Range") +
  theme_minimal() +
  geom_vline(aes(xintercept=0), lty="dashed") +
  theme(text = element_text(family = 'sans'))

smsap.plot3 <- mcmc_areas(posteriors.anc.stcnt.sm,
           prob = 0.9) +
  ggtitle("Noncore Winter Range") +
  theme_minimal() +
  geom_vline(aes(xintercept=0), lty="dashed") +
  theme(text = element_text(family = 'sans'))

smsap.plot4 <- mcmc_areas(posteriors.ak.stcnt.sm,
           prob = 0.9) +
  ggtitle("Kawuneeche Valley") +
  theme_minimal() +
  geom_vline(aes(xintercept=0), lty="dashed") +
  theme(text = element_text(family = 'sans'))

# combine
smsap.plot1 + smsap.plot2 + smsap.plot3 + smsap.plot4 + plot_annotation(
  title = 'Posterior Distributions: Small Aspen Stems')

# save plots
ggsave("./output/figures_exported/asp_small_sapling_panel_plot.png", dpi = 300, width = 8.75, height = 4.75)
ggsave("./output/figures_exported/asp_small_sapling_panel_plot.pdf", width = 8.75, height = 4.75)
```


### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.ak.sm)

fun.sexit.gt(stmod_stally2.ak.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Kawuneeche Valley") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_ak_smsap.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.ak.sm) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Kawuneeche Valley")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.ak.sm) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Small Saplings, Kawuneeche Valley") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_ak_smsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.ak.stcnt.sm.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.ak.stcnt.sm.tidy))) +
  scale_color_manual(values = colfunc2(ncol(posteriors.ak.stcnt.sm.tidy))) +
  # scale_fill_brewer(palette = "Set1") +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ak_smsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ak_smsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - ak
p_direction(stmod_stally2.ak.sm) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Small Saplings, Kawuneeche Valley") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ak_smsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ak_smsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.ak.sm <- rope(stmod_stally2.ak.sm, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ak.sm %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_ak_smap.rtf")

```

### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.ak.sm, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Kawuneeche Valley, Aspen Stem Count, Small Saplings. Results are given on the log scale")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ak_smsap.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ak_smsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.ak.sm, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.ak.sm, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

###  Effects of Burning on Short Saplings (<1.5m Tall) - Combined Winter Range (AC+ANC) 
```{r}
asp.sm.acanc %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  group_by(time_class, range_type, burned, fenced) %>% 
  summarytools::descr(var = stem_den_ac, stats = "fivenum") %>%
  summarytools::tb() %>% 
  mutate(across(where(is.numeric), round, 1)) %>% 
  gt() %>% 
  tab_header(title="Summary statistics")

```

```{r, cache=TRUE}
### STAN model
stmod_smsap_TCxFxB_acanc <- stan_glmer(stem_tally ~ fenced * time_class * burned + (1 | site_id), data = asp.sm.acanc,
                      family=poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

```{r}
fun.sexit.gt(stmod_smsap_TCxFxB_acanc)

fun.sexit.gt(stmod_smsap_TCxFxB_acanc) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Combined Winter Range, Small Saplings") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_smsap_TCxFxB_acanc.rtf")

```


```{r, eval=FALSE}
prior_summary(stmod_smsap_TCxFxB_acanc)
pp_check(stmod_smsap_TCxFxB_acanc)
```

#### Probability of Direction
```{r}
# Visualize the pd
p_direction(stmod_smsap_TCxFxB_acanc) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, combined winter range, TCxFxB") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_smsap_TCxFxB_acanc.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_smsap_TCxFxB_acanc.pdf", width = 4.75, height = 3.75)

```

```{r}
#### Contrasts
# linear predictors
# emmeans(stmod_smsap_TCxFxB_acanc, ~ time_class | burned | fenced) %>% 
#   pairs(reverse = TRUE) %>% 
#   plot() +
#   theme_minimal() +
#   geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
#   labs(subtitle = "Point estimate displayed: median 
# HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Aspen Stem Count, TCxFxB")

## response scale
emmeans(stmod_smsap_TCxFxB_acanc, ~ time_class | burned | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, Aspen Stem Count, TCxFxB")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxFxB_smsap_ac.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxFxB_smsap_ac.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_smsap_TCxFxB_acanc, ~ time_class | burned | fenced) %>% 
  pairs(reverse = TRUE) %>%  
  as_tibble() %>% 
  mutate(across(where(is.numeric),exp)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale")

```

## Tall Saplings (1.5-2.5m Tall) - Combined Winter Range (AC+ANC)
```{r}
asp.lg.acanc <- asp.lg.acanc %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 

# reverse factor levels
# asp.lg.acanc <- asp.lg.acanc %>% 
#   mutate(fenced = fct_rev(fenced))
  # mutate(time_class = fct_rev(time_class))
```

### Modeling and Posterior Description  
```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.acanc.lg <- stan_glmer(stem_tally ~ time_class * fenced + (1 | site_id), data = asp.lg.acanc,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.acanc.lg)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.acanc.lg)
```

```{r}
# extract posteriors
posteriors.acanc.stcnt.lg <- insight::get_parameters(stmod_stally2.acanc.lg)

# tidy
posteriors.acanc.stcnt.lg.tidy <- posteriors.acanc.stcnt.lg %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
color_scheme_set("teal")
plot.mcmcareas_acanc.stcnt.lg <- mcmc_areas(posteriors.acanc.stcnt.lg,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_acanc.stcnt.lg
```

### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.acanc.lg)

fun.sexit.gt(stmod_stally2.acanc.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Large Saplings, Combined Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_acanc_lgsap.rtf")
```

```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.acanc.lg) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Large Saplings, Combined Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.acanc.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Large Saplings, Combined Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_acanc_lgsap.rtf")

```

```{r, eval=FALSE, echo=FALSE}
# library(ggridges)
posteriors.acanc.stcnt.lg.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_acanc_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_acanc_lgsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_stally2.acanc.lg) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Large Saplings, Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_acanc_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_acanc_lgsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.acanc.lg <- rope(stmod_stally2.acanc.lg, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.acanc.lg %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_acanc_lgap.rtf")

```

### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.acanc.lg, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, Aspen Stem Count, Large Saplings. Results are given on the log scale")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_acanc_lgsap.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_acanc_lgsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.acanc.lg, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.acanc.lg, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.

```

```{r}

```

```{r, echo=FALSE, eval=FALSE}
pl.emmip.lg <- plotF.emmip_FxTC_response(stmod_stally2.acanc.lg)
pl.emmip.sm <- plotF.emmip_FxTC_response(stmod_stally2.acanc.sm)
pl.emmip.sm + pl.emmip.lg

```


## Tall Saplings (1.5-2.5m Tall) - Core Winter Range (AC)
```{r}
asp.lg.ac <- asp.lg.ac %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 
```

### Modeling and Posterior Description  
```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.ac.lg <- stan_glmer(stem_tally ~ time_class * fenced + (1 | site_id), data = asp.lg.ac,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.ac.lg)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.ac.lg)
```

```{r}
# extract posteriors
posteriors.ac.stcnt.lg <- insight::get_parameters(stmod_stally2.ac.lg) %>% 
  rename('2013' = time_class2013) %>%
  rename('2018' = time_class2018) %>%
  rename(Fenced = fencedFenced) %>%
  rename('2013:Fenced' = `time_class2013:fencedFenced`) %>%
  rename('2018:Fenced' = `time_class2018:fencedFenced`)

names(posteriors.ac.stcnt.lg)

# tidy
posteriors.ac.stcnt.lg.tidy <- posteriors.ac.stcnt.lg %>%
  pivot_longer(cols = c(`(Intercept)`,"2013","2018","Fenced","2013:Fenced", "2018:Fenced"),names_to = "parameter", values_to = "values")

# tidy
# posteriors.ac.stcnt.lg.tidy <- posteriors.ac.stcnt.lg %>%
#   pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
color_scheme_set("teal")
plot.mcmcareas_ac.stcnt.lg <- mcmc_areas(posteriors.ac.stcnt.lg,
           prob = 0.9) +
  ggtitle("Core Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ac.stcnt.lg
```

### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.ac.lg)

fun.sexit.gt(stmod_stally2.ac.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Large Saplings, Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_ac_lgsap.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.ac.lg) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Large Saplings, Core Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.ac.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Large Saplings, Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_ac_lgsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.ac.stcnt.lg.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values), alpha = .12, color="grey50") +
  # geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  # scale_fill_manual(values = colfunc2(ncol(posteriors.ac.stcnt.lg.tidy))) +
  # scale_fill_brewer(palette = "Set1") +
  scale_fill_viridis(discrete = TRUE) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ac_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ac_lgsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_stally2.ac.lg) %>% #distinct(Parameter)
  # mutate(Parameter = case_when(Parameter == "time_class2013"~'2013',
  # Parameter == "time_class2018"~'2018',
  # Parameter == "time_class2013:fencedFenced"~'2013:Fenced',
  # Parameter == "time_class2018:fencedFenced"~'2018:Fenced',
  # Parameter == "fencedFenced"~'Fenced')) %>%
  plot() +
  theme_minimal() +
  scale_fill_manual(values = colfunc3(2)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Tall Saplings, Core Winter Range") +
  scale_fill_manual(values = colfunc3(2))

p_direction(stmod_stally2.ac.lg) %>%
  tabyl(Parameter)

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ac_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ac_lgsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.ac.lg <- rope(stmod_stally2.ac.lg, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ac.lg %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_ac_lgap.rtf")

```

### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.ac.lg, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Aspen Stem Count, Tall Saplings. Results are given on the log scale")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ac_lgsap.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ac_lgsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.ac.lg, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.ac.lg, ~ time_class | fenced) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.

```

## Tall Saplings (1.5-2.5m Tall) - Noncore Winter Range (ANC)

```{r}
asp.lg.anc <- asp.lg.anc %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 
```

### Modeling and Posterior Description  
```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.anc.lg <- stan_glmer(stem_tally ~ time_class + (1 | site_id), data = asp.lg.anc,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.anc.lg)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.anc.lg)
```

```{r}
# extract posteriors
posteriors.anc.stcnt.lg <- insight::get_parameters(stmod_stally2.anc.lg)

# tidy
posteriors.anc.stcnt.lg.tidy <- posteriors.anc.stcnt.lg %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")


posteriors.anc.stcnt.lg <- insight::get_parameters(stmod_stally2.anc.lg) %>% 
  rename('2013' = time_class2013) %>%
  rename('2018' = time_class2018) 

# names(posteriors.anc.stcnt.lg)

# tidy
# posteriors.ac.stcnt.lg.tidy <- posteriors.ac.stcnt.lg %>%
#   pivot_longer(cols = c(`(Intercept)`,"2013","2018","Unfenced","2013:Fenced", "2018:Fenced"),names_to = "parameter", values_to = "values")
```

```{r}
color_scheme_set("teal")
plot.mcmcareas_anc.stcnt.lg <- mcmc_areas(posteriors.anc.stcnt.lg,
           prob = 0.9) +
  ggtitle("Noncore Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_acanc.stcnt.lg
```

### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.anc.lg)

fun.sexit.gt(stmod_stally2.anc.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Tall Saplings, Noncore Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_anc_lgsap.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.anc.lg) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Tall Saplings, Noncore Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.anc.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Tall Saplings, Noncore Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_anc_lgsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.anc.stcnt.lg.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.anc.stcnt.lg.tidy))) +
  scale_color_manual(values = colfunc2(ncol(posteriors.anc.stcnt.lg.tidy))) +
  # scale_fill_brewer(palette = "Set1") +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_anc_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_anc_lgsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - anc
p_direction(stmod_stally2.anc.lg) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Tall Saplings, Noncore Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_anc_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_anc_lgsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.anc.lg <- rope(stmod_stally2.anc.lg, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.anc.lg %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_anc_lgsap.rtf")

```

### Contrasts
```{r}
#### Contrasts
# EMMs for later fanctor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.anc.lg, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Noncore Winter Range, Aspen Stem Count, Tall Saplings. Results are given on the log scale")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_anc_lgsap.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_anc_lgsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.anc.lg, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.anc.lg, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

## Tall Saplings (1.5-2.5m Tall) - Kawuneeche Valley (AK)

### Modeling and Posterior Description
```{r}
asp.lg.ak <- asp.lg.ak %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001) 
```


```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.ak.lg <- stan_glmer(stem_tally ~ time_class + (1 | site_id), data = asp.lg.ak,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.ak.lg)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.ak.lg)
```

```{r}
# extract posteriors
posteriors.ak.stcnt.lg <- insight::get_parameters(stmod_stally2.ak.lg) %>% 
  rename('2013' = time_class2013) %>%
  rename('2018' = time_class2018) 

# tidy
posteriors.ak.stcnt.lg.tidy <- posteriors.ak.stcnt.lg %>%
  pivot_longer(cols = c('2013','2018'), names_to = "parameter", values_to = "values")
  # pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
color_scheme_set("teal")

plot.mcmcareas_ak.stcnt.lg <- mcmc_areas(posteriors.ak.stcnt.lg,
           prob = 0.9) +
  ggtitle("Kawuneeche Valley") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))

plot.mcmcareas_ak.stcnt.lg
```

**Panel plot of above MCMC area plots**
```{r}
## rendered for print doc
## turned off for Rmd appx
# panel of ACNC AC ANC AK - tall saplings
# glimpse(posteriors.acanc.stcnt.lg)

lgsap.plot1 <- mcmc_areas(posteriors.acanc.stcnt.lg,
           prob = 0.9) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans')) +
  geom_vline(aes(xintercept=0), lty="dashed")

lgsap.plot2 <- mcmc_areas(posteriors.ac.stcnt.lg,
           prob = 0.9) +
  ggtitle("Core Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans')) +
  geom_vline(aes(xintercept=0), lty="dashed")

lgsap.plot3 <- mcmc_areas(posteriors.anc.stcnt.lg,
           prob = 0.9) +
  ggtitle("Noncore Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans')) +
  geom_vline(aes(xintercept=0), lty="dashed")

lgsap.plot4 <- mcmc_areas(posteriors.ak.stcnt.lg,
           prob = 0.9) +
  ggtitle("Kawuneeche Valley") +
  theme_minimal() +
  theme(text = element_text(family = 'sans')) +
  geom_vline(aes(xintercept=0), lty="dashed")

# combine
lgsap.plot1 + lgsap.plot2 + lgsap.plot3 + lgsap.plot4 + plot_annotation(
  title = 'Posterior Distributions: Tall Aspen Stems')

# save plots
ggsave("./output/figures_exported/asp_tall_sapling_panel_plot.png", dpi = 300, width = 8.75, height = 4.75)
ggsave("./output/figures_exported/asp_tall_sapling_panel_plot.pdf", width = 8.75, height = 4.75)
```


### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.ak.lg)

fun.sexit.gt(stmod_stally2.ak.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Tall Saplings, Kawuneeche Valley") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_ak_lgsap.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.ak.lg) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Tall Saplings, Kawuneeche Valley")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.ak.lg) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Tall Saplings, Kawuneeche Valley") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_ak_lgsap.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.ak.stcnt.lg.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  scale_fill_manual(values = colfunc2(ncol(posteriors.ak.stcnt.lg.tidy))) +
  scale_color_manual(values = colfunc2(ncol(posteriors.ak.stcnt.lg.tidy))) +
  # scale_fill_brewer(palette = "Set1") +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ak_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ak_lgsap.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - ak
p_direction(stmod_stally2.ak.lg) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Tall Saplings, Kawuneeche Valley") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ak_lgsap.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ak_lgsap.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.ak.lg <- rope(stmod_stally2.ak.lg, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ak.lg %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_ak_lgsap.rtf")

```

### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.ak.lg, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Kawuneeche Valley, Aspen Stem Count, Tall Saplings. Results are given on the log scale")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ak_lgsap.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ak_lgsap.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.ak.lg, ~ time_class) %>% 
  pairs(reverse = FALSE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.ak.lg, ~ time_class) %>% 
  pairs(reverse = FALSE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

### Effects of Burning on Tall Saplings (1.5-2.5m Tall) - Combined Winter Range (AC+ANC) 
```{r}
asp.lg.acanc %>% 
  filter(range_type == "core winter range") %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  group_by(time_class, range_type, burned, fenced) %>% 
  summarytools::descr(stats = "fivenum") %>%
  summarytools::tb() %>% 
  gt() %>% 
  tab_header(title="Summary statistics")

```

```{r, cache=TRUE}
### STAN model
stmod_lgsap_TCxFxB_acanc <- stan_glmer(stem_tally ~ fenced * time_class * burned + (1 | site_id), data = asp.lg.acanc,
                      family=poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

```{r}
fun.sexit.gt(stmod_lgsap_TCxFxB_acanc)

fun.sexit.gt(stmod_lgsap_TCxFxB_acanc) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Combined Winter Range, Tall Saplings") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_lgsap_TCxFxB_acanc.rtf")

```

```{r, eval=FALSE}
prior_summary(stmod_lgsap_TCxFxB_acanc)
pp_check(stmod_lgsap_TCxFxB_acanc)
```

#### Probability of Direction
```{r}
# Visualize the pd
p_direction(stmod_lgsap_TCxFxB_acanc) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, combined winter range, TCxFxB") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_lgsap_TCxFxB_acanc.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_lgsap_TCxFxB_acanc.pdf", width = 4.75, height = 3.75)

```

```{r}
#### Contrasts
# linear predictors
# emmeans(stmod_lgsap_TCxFxB_acanc, ~ time_class | burned | fenced) %>% 
#   pairs(reverse = TRUE) %>% 
#   plot() +
#   theme_minimal() +
#   geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
#   labs(subtitle = "Point estimate displayed: median 
# HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Aspen Stem Count, TCxFxB")

## response scale
emmeans(stmod_lgsap_TCxFxB_acanc, ~ time_class | burned | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, Large Saplings, TCxFxB")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxFxB_lgsap_ac.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxFxB_lgsap_ac.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_lgsap_TCxFxB_acanc, ~ time_class | burned | fenced) %>% 
  pairs(reverse = TRUE) %>%  
  as_tibble() %>% 
  mutate(across(where(is.numeric),exp)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale")

```

## All Stem Diameters - Combined Winter Range (AC+ANC)
```{r}
# purrr plots
asp.acanc  %>% 
  group_nest(range_type) %>%
  mutate(plots = map2(.y = range_type, .x = data, ~{ggplot(data = .x) +
      geom_boxplot(aes(y = stem_den_ac, x = time_class), fill="Gray80") +
      geom_jitter(aes(y = stem_den_ac, x = time_class), fill="blue", alpha=0.25) +
      labs(title = paste0("Range type: ", .y), x = "", y = "Stem density (stems/acre)") +
      theme_minimal()})) %>% 
  pull(plots)

```

### Modeling and Posterior Description
```{r, cache=TRUE,eval=FALSE}
#### Main Factors Only
## Not run. Used in model comparisons, but model w/ interaction selected
asp.acanc <- asp.acanc %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001)

## poisson
stmod_stally1.acanc <- stan_glmer(stem_tally ~ time_class + fenced + (1 | site_id), data = asp.acanc,
                      family=poisson,
                      iter = 8000,
                      seed = 1234
                      )
prior_summary(stmod_stally1.acanc)
pp_check(stmod_stally1.acanc)
```

```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2.acanc <- stan_glmer(stem_tally ~ time_class * fenced + (1 | site_id), data = asp.acanc,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2.acanc)
```

```{r}
## model summary
fun.model.summary(stmod_stally2.acanc)
```

```{r}
# extract posteriors
posteriors.acanc.stcnt <- insight::get_parameters(stmod_stally2.acanc)

# tidy
posteriors.acanc.stcnt.tidy <- posteriors.acanc.stcnt %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
library("bayesplot")
color_scheme_set("teal")
mcmc_areas(posteriors.acanc.stcnt,
           prob = 0.8) +
  ggtitle("Combined Winter Range") +
  theme_minimal() +
  theme(text = element_text(family = 'sans'))
```

### Effect Description
```{r}
fun.sexit.gt(stmod_stally2.acanc)

fun.sexit.gt(stmod_stally2.acanc) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_ac.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2.acanc) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Core Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2.acanc) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_ac.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.acanc.stcnt.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  # scale_fill_manual(values = colfunc3_RdBu(4)) +
  # scale_color_manual(values = colfunc3_RdBu(4)) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal() +
  labs(caption = "ACANC")

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_acanc.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_acanc.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_stally2.acanc) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Combined Winter Range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_acanc.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_acanc.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.ac <- rope(stmod_stally2.acanc, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ac %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_acanc.rtf")

```

### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2.acanc, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Combined Winter Range, Aspen Stem Count, Results are given on the log scale")


# ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_acanc.pdf", width = 4.5, height = 3.55) # save plot
# ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_acanc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2.acanc, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2.acanc, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.

```

## All Stem Diameters - Core Winter Range (AC)

### Modeling and Posterior Description

```{r, eval=FALSE}
#### Main Factors Only
## Not run. Used in model comparisons, but model w/ interaction selected
asp.ac <- asp.ac %>%
  mutate(stem_den_ha = stem_den_ha + 0.0000001)

## poisson
stmod_stally1 <- stan_glmer(stem_tally ~ time_class + fenced + (1 | site_id), data = asp.ac,
                      family=poisson,
                      iter = 8000,
                      seed = 1234
                      )
prior_summary(stmod_stally1)
pp_check(stmod_stally1)
```

```{r, cache=TRUE}
#### main factors + interactions:
stmod_stally2 <- stan_glmer(stem_tally ~ time_class * fenced + (1 | site_id), data = asp.ac,
                      family= poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

**Prior summary**: stem_tally ~ time_class * fenced + (1 | site_id)  
```{r}
prior_summary(stmod_stally2)
```

```{r}
## model summary
fun.model.summary(stmod_stally2)
```

```{r}
# extract posteriors
posteriors.ac.stcnt <- insight::get_parameters(stmod_stally2)

# tidy
posteriors.ac.stcnt.tidy <- posteriors.ac.stcnt %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")

```

```{r}
### ppc plot
ppc.plot(stmod_stally2) +
  labs(caption = "AC: stem_cnt~TCxF")

# save plots
ggsave("./output/figures_exported/aspen_stem_count/ppc_stemcnt_ac.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/ppc_stemcnt_ac.pdf", width = 4.75, height = 3.75)
```

```{r, eval = FALSE}
## model comparison. Run previously for model comparison;
# not currently set to run to minimize computational overhead

loo1 <- loo(stmod_stally1,
            k_threshold = 0.7) 
loo2 <- loo(stmod_stally2,
            k_threshold = 0.7) 
comp <- loo_compare(loo2, loo1)

## create table of comparisons
modcomp_ac <- print(comp, simplify = TRUE, digits = 2)

modcomp_ac %>% 
  gt()
# citation(package = "loo")

# show more details with simplify=FALSE
print(modcomp_ac, simplify = FALSE, digits = 3)

# model with interactions selected
```

```{r}
# library("bayesplot")
color_scheme_set("teal")
mcmc_areas(stmod_stally2,
           prob = 0.8) +
  ggtitle("Posterior distributions",
                      "with medians and 80% credible intervals")
```

### Effect Description
```{r}
fun.sexit.gt(stmod_stally2)

fun.sexit.gt(stmod_stally2) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_ac.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_stally2) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Core Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_stally2) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_ac.rtf")

```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)
posteriors.ac.stcnt.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ac.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ac.pdf", width = 4.75, height = 3.75)
```

#### Probability of Direction
```{r}
# Visualize the pd
#### PD - AC
p_direction(stmod_stally2) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, core winter range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ac.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ac.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)
```{r}
rope.stemcnt.ac <- rope(stmod_stally2, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ac %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_ac.rtf")

```

### Contrasts
```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

# library(emmeans)
emmeans(stmod_stally2, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  # labs(title= "Core winter range", caption = "Point estimate displayed: median 
# HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "Contrast")
  labs(subtitle = "Point estimate displayed: median HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Aspen Stem Count, Results are given on the log scale")


# ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ac.pdf", width = 4.5, height = 3.55) # save plot
# ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_ac.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_stally2, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_stally2, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

```

### Effects of Burning on All Stems - Core Winter Range (AC)
```{r}
ht_perc1 %>% 
  filter(range_type == "core winter range") %>% 
  filter(time_class == "BL" | time_class == "2013" | time_class == "2018") %>%
  group_by(time_class, range_type, burned, fenced) %>% 
  summarytools::descr(stats = "fivenum") %>%
  summarytools::tb() %>% 
  gt() %>% 
  tab_header(title="Summary statistics")

```

```{r, cache=TRUE}
### STAN model
stmod_stally_TCxFxB_ac <- stan_glmer(stem_tally ~ fenced * time_class * burned + (1 | site_id), data = asp.ac,
                      family=poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

```{r}
fun.sexit.gt(stmod_stally_TCxFxB_ac)

fun.sexit.gt(stmod_stally_TCxFxB_ac) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Core Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxFxB_ac.rtf")

```


```{r, eval=FALSE}
prior_summary(stmod_stally_TCxFxB_ac)
pp_check(stmod_stally_TCxFxB_ac)
```

```{r}
# Visualize the pd
p_direction(stmod_stally_TCxFxB_ac) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, core winter range, TCxFxB")

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_TCxFxB_ac.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_TCxFxB_ac.pdf", width = 4.75, height = 3.75)

```

```{r}
#### Contrasts
# linear predictors
# emmeans(stmod_stally_TCxFxB_ac, ~ time_class | burned | fenced) %>% 
#   pairs(reverse = TRUE) %>% 
#   plot() +
#   theme_minimal() +
#   geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
#   labs(subtitle = "Point estimate displayed: median 
# HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Aspen Stem Count, TCxFxB")

## response scale
emmeans(stmod_stally_TCxFxB_ac, ~ time_class | burned | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Core Winter Range, Aspen Stem Count, TCxFxB")


ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxFxB_ac.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxFxB_ac.png", width = 4.5, height = 3.55) # save plot

# table of contrasts
emmeans(stmod_stally_TCxFxB_ac, ~ time_class | burned | fenced) %>% 
  pairs(reverse = TRUE) %>%  
  as_tibble() %>% 
  mutate(across(where(is.numeric),exp)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale")

```

## All Stem Diameters - Noncore Winter Range (ANC)

### Modeling and Posterior Description

```{r,, cache=TRUE}
stmod_anc_stally1 <- stan_glmer(stem_tally ~ time_class + (1 | site_id), data = asp.anc,
                      family=poisson,
                      iter = 8000,
                      seed = 1234
                      )

```

```{r}
# get posteriors
posteriors.anc.stmcnt <- insight::get_parameters(stmod_anc_stally1)
# tidy
posteriors.anc.stcnt.tidy <- posteriors.anc.stmcnt %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")
```

**Prior summary**: stem_tally ~ time_class + (1 | site_id)  
```{r}
prior_summary(stmod_anc_stally1)
```

```{r}
## model summary
fun.model.summary(stmod_anc_stally1)
```

```{r, echo=FALSE, eval = FALSE}
## shiny eval
launch_shinystan(stmod_anc_stally1)
```

```{r}
#### PP check plot
ppc.plot(stmod_anc_stally1) +
  labs(caption = "ANC: stem_tally~TC")
ggsave("./output/figures_exported/aspen_stem_count/ppc_willowht_anc.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/ppc_willowht_anc.pdf", width = 4.75, height = 3.75)
```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)

posteriors.anc.stcnt.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_anc.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_anc.pdf", width = 4.75, height = 3.75)
```

```{r}
# library("bayesplot")
color_scheme_set("teal")
mcmc_areas(stmod_anc_stally1,
           prob = 0.8) +
  ggtitle("Posterior distributions",
                      "with medians and 80% credible intervals")
```

### Effect Description
```{r}
fun.sexit.gt(stmod_anc_stally1)

fun.sexit.gt(stmod_anc_stally1) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Noncore Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_anc.rtf")

```


```{r, echo=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_anc_stally1) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Noncore Winter Range")

## save as RTF
fun.desc.post1.gt.rope(stmod_anc_stally1) %>%
 tab_header(title = "Aspen Count Posterior Description", subtitle = "Noncore Winter Range") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_anc.rtf")

```

#### Probability of Direction

```{r}
# Visualize the pd
#### PD - ANC
p_direction(stmod_anc_stally1) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Noncore winter range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_anc.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_anc.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)

```{r}
rope.stemcnt.ac <- rope(stmod_anc_stally1, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ac %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_anc.rtf")

```

### Contrasts

```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

emmeans(stmod_anc_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Noncore Winter Range, Aspen Stem Count")

ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_anc.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TCxF_anc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_anc_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_anc_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# For EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.

```


```{r, echo=TRUE, eval=TRUE}
# comment 2.2 "provide analyses on single graphic...
## Plot combinations
contr.plot.ac <- emmeans(stmod_stally2, ~ time_class | fenced) %>% 
  pairs(reverse = TRUE) %>% 
  # plot(type = "response") +
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(title= "Core winter range", caption = "", x = "Estimate", y = "Contrast")

contr.plot.anc <- emmeans(stmod_anc_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(title= "Noncore winter range", caption = "Point estimate displayed: median 
HPD interval probability: 0.95, Results on log scale", x = "Estimate", y = "")

# patchwork
contr.plot.ac + contr.plot.anc 

ggsave("./output/figures_exported/revised_figs_aspen/emm_stemcnt_AC_ANC.png", width = 8, height = 3.75, dpi=300)
ggsave("./output/figures_exported/revised_figs_aspen/emm_stemcnt_AC_ANC.pdf", width = 8, height = 3.75)

```

## All Stem Diameters - Kawuneeche Valley (AK)

### Modeling and Posterior Description

```{r, cache=TRUE}
stmod_ak_stally1 <- stan_glmer(stem_tally ~ time_class + (1 | site_id), data = asp.ak,
                       family=poisson,
                      iter = 8000,
                      seed = 1234
                      )
```

**Prior summary**: stem_tally ~ time_class + (1 | site_id)  
```{r}
prior_summary(stmod_ak_stally1)
```

```{r}
## model summary
fun.model.summary(stmod_ak_stally1)
```


```{r}
# extract posteriors
posteriors.ak.stcnt <- insight::get_parameters(stmod_ak_stally1)

# tidy
posteriors.ak.stcnt.tidy <- posteriors.ak.stcnt %>%
  pivot_longer(cols = starts_with("time"), names_to = "parameter", values_to = "values")
```

```{r}
prior_summary(stmod_ak_stally1)
```

```{r}
#### PP check plot
ppc.plot(stmod_ak_stally1) +
  labs(caption = "AK: stem_tally~TC")
ggsave("./output/figures_exported/aspen_stem_count/ppc_willowht_ak.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/ppc_willowht_ak.pdf", width = 4.75, height = 3.75)
```

```{r, echo=FALSE, eval=FALSE}
# library(ggridges)

posteriors.ak.stcnt.tidy %>% 
  ggplot() +
  geom_density(aes(fill = parameter, x = values, color = parameter), alpha = .12) +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  theme_minimal()

# save plots
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ak.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/postden_stemcnt_ak.pdf", width = 4.75, height = 3.75)
```

```{r}
# library("bayesplot")
color_scheme_set("teal")
mcmc_areas(stmod_ak_stally1,
           prob = 0.8) +
  ggtitle("Posterior distributions",
                      "with medians and 80% credible intervals")
```


### Effect Description  
```{r}
fun.sexit.gt(stmod_ak_stally1)

fun.sexit.gt(stmod_ak_stally1) %>%
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Kawuneeche Valley") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/xpostdesc_stemcnt_TCxF_anc.rtf")

```

```{r, ech=FALSE, eval=FALSE}
### Model posterior parameters to table
fun.desc.post1.gt.rope(stmod_ak_stally1) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Kawuneeche Valley")

## save as RTF
fun.desc.post1.gt.rope(stmod_anc_stally1) %>% 
  tab_header(title = "Aspen Count Posterior Description", subtitle = "Kawuneeche Valley") %>%
  gt::gtsave(filename = "./output/tables/aspen_stem_count/postdesc_stemcnt_TCxF_anc.rtf")

```

#### Probability of Direction  
```{r}
# Visualize the pd
#### PD - ANC
p_direction(stmod_ak_stally1) %>% 
  plot() +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(caption = "Aspen stem count, Noncore winter range") +
  scale_fill_manual(values = colfunc3(2))

# save plots
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ak.png", dpi = 300, width = 4.75, height = 3.75)
ggsave("./output/figures_exported/aspen_stem_count/pd_stemcnt_ak.pdf", width = 4.75, height = 3.75)

```

#### Region of Practical Equivalence (ROPE)

```{r}
rope.stemcnt.ak <- rope(stmod_ak_stally1, ci=0.9) %>% 
  gt() %>%
  tab_header(title = "Percent in ROPE") %>% 
  fmt_number(
    columns = 5,
    decimals = 1,
    suffixing = TRUE
  ) 

rope.stemcnt.ak %>% 
  gt::gtsave(filename = "./output/tables/aspen_stem_count/rope_stemcnt_ak.rtf")

```

### Contrasts

```{r}
#### Contrasts
# EMMs for later factor levels are subtracted from those for earlier levels; if you want the comparisons to go in the other direction, use pairs.

emmeans(stmod_ak_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Noncore Winter Range, Aspen Stem Count")

ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TC_anc.pdf", width = 4.5, height = 3.55) # save plot
ggsave("./output/figures_exported/aspen_stem_count/emm_stemcnt_TC_anc.png", width = 4.5, height = 3.55) # save plot

# table of contrasts. Results are given on the log (not the response) scale.
emmeans(stmod_ak_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the log (not the response) scale.")

# table of contrasts. Results are given on the response scale.
emmeans(stmod_ak_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE, type="response") %>% 
  as_tibble() %>% 
  mutate(across(where(is.numeric),round, 2)) %>% 
  gt() %>% 
  tab_header(title = "Pairwise contrasts", subtitle = "Results are given on the response scale.")

# For EMM summaries with type = "response", the tests and confidence intervals are done before back-transforming. The ratios estimated here are actually ratios of geometric means. In general, a model with a log response is in fact a model for relative effects of any of its linear predictors, and this back-transformation to ratios goes hand-in-hand with that.

```

```{r}
## version for plot combination
# ANC 
emmeans(stmod_ak_stally1, ~ time_class) %>% 
  pairs(reverse = TRUE) %>% 
  plot(type = "response") +
  theme_minimal() +
  geom_vline(aes(xintercept = 0), color= "black", size=1, lty="dashed") +
  labs(subtitle = "Point estimate displayed: median 
HPD interval probability: 0.95", x = "Estimate", y = "Contrast", caption = "Noncore Winter Range, Aspen Stem Count")
```



# Session info

R version 4.0.3 (2020-10-10)\
Platform: x86_64-w64-mingw32/x64 (64-bit)\
Running under: Windows 10 x64 (build 19041)  
Run date: `r format(Sys.time(), '%Y %B %d')`  

```{r, echo=FALSE}
# subset(data.frame(sessioninfo::package_info()), attached==TRUE, c(package, loadedversion)) %>% 
#   gt() %>% 
#   tab_header(title = "Attached packages and versions")

report::report_table(sessionInfo()) %>% 
  as_tibble() %>% 
  gt() %>% 
  tab_header(title="Package Information")

```

# References